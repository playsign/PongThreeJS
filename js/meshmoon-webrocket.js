/*
 * Meshmoon WebRocket v1.5.7
 * www.adminotech.com / www.meshmoon.com
 *
 * Copyright Adminotech Ltd. 2013-2015 - All Rights Reserved.
 * No part of this script or any of its contents
 * may be used, reproduced, copied, modified or adapted,
 * without the prior written consent of the author.
 *
 * See included 3rd party libraries for their licenses.
 *
 * Commit   1.5.7-0-32ba53b
 * Date     5.6.2015 14:40:51 UTC
 * Meta     @preserve
 */
function BitArray(a,b){void 0===b&&(b=0),this.size=a,this.field=new Array(~~((a-1)/BitArray.ELEMENT_WIDTH)+1);for(var c=0;c<this.field.length;c++)this.field[c]=0==b?0:(b<<BitArray.ELEMENT_WIDTH)-1}function LoadCrunchDecoder(){function e(a){throw a}function q(){return function(){}}function ga(a){eval.call(m,a)}function ha(){return x}function ia(a){x=a}function ja(a){switch(a){case"i1":case"i8":return 1;case"i16":return 2;case"i32":return 4;case"i64":return 8;case"float":return 4;case"double":return 8;default:if("*"===a[a.length-1])return ka;if("i"===a[0])return a=parseInt(a.substr(1)),A(0===a%8),a/8}}function la(a,b,c){c&&c.length?(c.splice||(c=Array.prototype.slice.call(c)),c.splice(0,0,b),s["dynCall_"+a].apply(m,c)):s["dynCall_"+a].call(m,b)}function na(){var a=[],b=0;this.za=function(c){if(c&=255,0==a.length)return 0==(128&c)?String.fromCharCode(c):(a.push(c),b=192==(224&c)?1:224==(240&c)?2:3,"");if(b&&(a.push(c),b--,b>0))return"";var c=a[0],d=a[1],e=a[2],f=a[3];return 2==a.length?c=String.fromCharCode((31&c)<<6|63&d):3==a.length?c=String.fromCharCode((15&c)<<12|(63&d)<<6|63&e):(c=(7&c)<<18|(63&d)<<12|(63&e)<<6|63&f,c=String.fromCharCode(Math.floor((c-65536)/1024)+55296,(c-65536)%1024+56320)),a.length=0,c},this.Cb=function(a){for(var a=unescape(encodeURIComponent(a)),b=[],c=0;c<a.length;c++)b.push(a.charCodeAt(c));return b}}function oa(a){var b=x;return x=x+a|0,x=x+7&-8,b}function pa(a){var b=B;return B=B+a|0,B=B+7&-8,b}function qa(a){var b=D;return D=D+a|0,D=D+7&-8,D>=ra&&E("Cannot enlarge memory arrays in asm.js. Either (1) compile with -s TOTAL_MEMORY=X with X higher than the current value "+ra+", or (2) set Module.TOTAL_MEMORY before the program runs."),b}function sa(a,b){return Math.ceil(a/(b?b:8))*(b?b:8)}function A(a,b){a||E("Assertion failed: "+b)}function xa(a){try{var b=s["_"+a];b||(b=eval("_"+a))}catch(c){}return A(b,"Cannot call unknown function "+a+" (perhaps LLVM optimizations or closure removed it?)"),b}function wa(a,b,c,d){function e(a,b){if("string"==b){if(a===m||a===j||0===a)return 0;a=H(a),b="array"}if("array"==b){f||(f=ha());var c=oa(a.length);return ya(a,c),c}return a}var f=0,g=0,d=d?d.map(function(a){return e(a,c[g++])}):[];return a=a.apply(m,d),"string"==b?b=za(a):(A("array"!=b),b=a),f&&ia(f),b}function Aa(a,b,c){switch(c=c||"i8","*"===c.charAt(c.length-1)&&(c="i32"),c){case"i1":I[a]=b;break;case"i8":I[a]=b;break;case"i16":J[a>>1]=b;break;case"i32":K[a>>2]=b;break;case"i64":va=[b>>>0,(tempDouble=b,1<=+Ba(tempDouble)?0<tempDouble?(0|Ca(+Da(tempDouble/4294967296),4294967295))>>>0:~~+Ea((tempDouble-+(~~tempDouble>>>0))/4294967296)>>>0:0)],K[a>>2]=va[0],K[a+4>>2]=va[1];break;case"float":Fa[a>>2]=b;break;case"double":Ga[a>>3]=b;break;default:E("invalid type for setValue: "+c)}}function L(a,b,c,d){var e,f;"number"==typeof a?(e=l,f=a):(e=p,f=a.length);var g="string"==typeof b?b:m,c=c==Ja?d:[Ka,oa,pa,qa][c===j?Ia:c](Math.max(f,g?1:b.length));if(e){for(d=c,A(0==(3&c)),a=c+(-4&f);a>d;d+=4)K[d>>2]=0;for(a=c+f;a>d;)I[0|d++]=0;return c}if("i8"===g)return a.subarray||a.slice?M.set(a,c):M.set(new Uint8Array(a),c),c;for(var h,i,d=0;f>d;){var k=a[d];"function"==typeof k&&(k=ta.Sd(k)),e=g||b[d],0===e?d++:("i64"==e&&(e="i32"),Aa(c+d,k,e),i!==e&&(h=ja(e),i=e),d+=h)}return c}function za(a,b){for(var c,d=p,e=0;;){if(c=M[a+e|0],c>=128)d=l;else if(0==c&&!b)break;if(e++,b&&e==b)break}b||(b=e);var f="";if(!d){for(;b>0;)c=String.fromCharCode.apply(String,M.subarray(a,a+Math.min(b,1024))),f=f?f+c:c,a+=1024,b-=1024;return f}for(d=new na,e=0;b>e;e++)c=M[a+e|0],f+=d.za(c);return f}function La(a){try{if("number"==typeof a&&(a=za(a)),"_"!==a[0]||"_"!==a[1]||"Z"!==a[2])return a;var b=3,c={v:"void",b:"bool",c:"char",s:"short",i:"int",l:"long",f:"float",d:"double",w:"wchar_t",a:"signed char",h:"unsigned char",t:"unsigned short",j:"unsigned int",m:"unsigned long",x:"long long",y:"unsigned long long",z:"..."},d=[],f=function(g,h,i){var j,h=h||1/0,k="",m=[];if("N"!==a[b]){"K"===a[b]&&b++;var n=parseInt(a.substr(b));if(n){var o=n.toString().length;j=a.substr(b+o,n),b+=o+n}}else{for(b++,"K"===a[b]&&b++,j=[];"E"!==a[b];)if("S"===a[b])b++,n=a.indexOf("_",b),j.push(d[a.substring(b,n)||0]||"?"),b=n+1;else{if(n=parseInt(a.substr(b)),o=n.toString().length,!n||!o){b--;break}var p=a.substr(b+o,n);j.push(p),d.push(p),b+=o+n}if(b++,j=j.join("::"),h--,0===h)return g?[j]:j}"I"===a[b]?(b++,n=f(l),o=f(l,1,l),k+=o[0]+" "+j+"<"+n.join(", ")+">"):k=j;a:for(;b<a.length&&0<h--;)if(j=a[b++],j in c)m.push(c[j]);else switch(j){case"P":m.push(f(l,1,l)[0]+"*");break;case"R":m.push(f(l,1,l)[0]+"&");break;case"L":b++,n=a.indexOf("E",b)-b,m.push(a.substr(b,n)),b+=n+2;break;case"A":n=parseInt(a.substr(b)),b+=n.toString().length,"_"!==a[b]&&e("?"),b++,m.push(f(l,1,l)[0]+" ["+n+"]");break;case"E":break a;default:k+="?"+j;break a}return!i&&1===m.length&&"void"===m[0]&&(m=[]),g?m:k+("("+m.join(", ")+")")};return f()}catch(g){return a}}function Ma(){var a=Error().stack;return a?a.replace(/__Z[\w\d_]+/g,function(a){var b=La(a);return a===b?a:a+" ["+b+"]"}):"(no stack trace available)"}function Ua(a){for(;0<a.length;){var b=a.shift();if("function"==typeof b)b();else{var c=b.M;"number"==typeof c?b.ta===j?la("v",c):la("vi",c,[b.ta]):c(b.ta===j?m:b.ta)}}}function $a(a){Va.unshift(a)}function ab(a){Ya.unshift(a)}function H(a,b,c){return a=(new na).Cb(a),c&&(a.length=c),b||a.push(0),a}function ya(a,b){for(var c=0;c<a.length;c++)I[b+c|0]=a[c]}function bb(a,b){return a>=0?a:32>=b?2*Math.abs(1<<b-1)+a:Math.pow(2,b)+a}function cb(a,b){if(0>=a)return a;var c=32>=b?Math.abs(1<<b-1):Math.pow(2,b-1);return a>=c&&(32>=b||a>c)&&(a=-2*c+a),a}function gb(a){Q++,s.monitorRunDependencies&&s.monitorRunDependencies(Q),a?(A(!db[a]),db[a]=1):s.P("warning: run dependency added without ID")}function hb(a){Q--,s.monitorRunDependencies&&s.monitorRunDependencies(Q),a?(A(db[a]),delete db[a]):s.P("warning: run dependency removed without ID"),0==Q&&(eb!==m&&(clearInterval(eb),eb=m),fb&&(a=fb,fb=m,a()))}function lb(a){return 0>a||0===a&&-(1/0)===1/a}function mb(a,b){function c(a){var c;return"double"===a?c=Ga[b+g>>3]:"i64"==a?(c=[K[b+g>>2],K[b+(g+8)>>2]],g+=8):(a="i32",c=K[b+g>>2]),g+=Math.max(Math.max(ja(a),ka),8),c}for(var d,e,f=a,g=0,h=[];;){var i=f;if(d=I[f],0===d)break;if(e=I[f+1|0],37==d){var j=p,k=p,n=p,o=p,q=p;a:for(;;){switch(e){case 43:j=l;break;case 45:k=l;break;case 35:n=l;break;case 48:if(o)break a;o=l;break;case 32:q=l;break;default:break a}f++,e=I[f+1|0]}var r=0;if(42==e)r=c("i32"),f++,e=I[f+1|0];else for(;e>=48&&57>=e;)r=10*r+(e-48),f++,e=I[f+1|0];var s=p;if(46==e){var t=0,s=l;if(f++,e=I[f+1|0],42==e)t=c("i32"),f++;else for(;e=I[f+1|0],!(48>e||e>57);)t=10*t+(e-48),f++;e=I[f+1|0]}else t=6;var u;switch(String.fromCharCode(e)){case"h":e=I[f+2|0],104==e?(f++,u=1):u=2;break;case"l":e=I[f+2|0],108==e?(f++,u=8):u=4;break;case"L":case"q":case"j":u=8;break;case"z":case"t":case"I":u=4;break;default:u=m}switch(u&&f++,e=I[f+1|0],String.fromCharCode(e)){case"d":case"i":case"u":case"o":case"x":case"X":case"p":i=100==e||105==e,u=u||4,d=c("i"+8*u);var v;8==u&&(d=117==e?+(d[0]>>>0)+4294967296*+(d[1]>>>0):+(d[0]>>>0)+4294967296*+(0|d[1])),4>=u&&(d=(i?cb:bb)(d&Math.pow(256,u)-1,8*u));var w=Math.abs(d),i="";if(100==e||105==e)v=cb(d,8*u).toString(10);else if(117==e)v=bb(d,8*u).toString(10),d=Math.abs(d);else if(111==e)v=(n?"0":"")+w.toString(8);else if(120==e||88==e){if(i=n&&0!=d?"0x":"",0>d){for(d=-d,v=(w-1).toString(16),w=[],n=0;n<v.length;n++)w.push((15-parseInt(v[n],16)).toString(16));for(v=w.join("");v.length<2*u;)v="f"+v}else v=w.toString(16);88==e&&(i=i.toUpperCase(),v=v.toUpperCase())}else 112==e&&(0===w?v="(nil)":(i="0x",v=w.toString(16)));if(s)for(;v.length<t;)v="0"+v;for(d>=0&&(j?i="+"+i:q&&(i=" "+i)),"-"==v.charAt(0)&&(i="-"+i,v=v.substr(1));i.length+v.length<r;)k?v+=" ":o?v="0"+v:i=" "+i;v=i+v,v.split("").forEach(function(a){h.push(a.charCodeAt(0))});break;case"f":case"F":case"e":case"E":case"g":case"G":if(d=c("double"),isNaN(d))v="nan",o=p;else if(isFinite(d)){if(s=p,u=Math.min(t,20),(103==e||71==e)&&(s=l,t=t||1,u=parseInt(d.toExponential(u).split("e")[1],10),t>u&&u>=-4?(e=(103==e?"f":"F").charCodeAt(0),t-=u+1):(e=(103==e?"e":"E").charCodeAt(0),t--),u=Math.min(t,20)),101==e||69==e?(v=d.toExponential(u),/[eE][-+]\d$/.test(v)&&(v=v.slice(0,-1)+"0"+v.slice(-1))):(102==e||70==e)&&(v=d.toFixed(u),0===d&&lb(d)&&(v="-"+v)),i=v.split("e"),s&&!n)for(;1<i[0].length&&-1!=i[0].indexOf(".")&&("0"==i[0].slice(-1)||"."==i[0].slice(-1));)i[0]=i[0].slice(0,-1);else for(n&&-1==v.indexOf(".")&&(i[0]+=".");t>u++;)i[0]+="0";v=i[0]+(1<i.length?"e"+i[1]:""),69==e&&(v=v.toUpperCase()),d>=0&&(j?v="+"+v:q&&(v=" "+v))}else v=(0>d?"-":"")+"inf",o=p;for(;v.length<r;)v=k?v+" ":!o||"-"!=v[0]&&"+"!=v[0]?(o?"0":" ")+v:v[0]+"0"+v.slice(1);97>e&&(v=v.toUpperCase()),v.split("").forEach(function(a){h.push(a.charCodeAt(0))});break;case"s":if(o=(j=c("i8*"))?kb(j):6,s&&(o=Math.min(o,t)),!k)for(;o<r--;)h.push(32);if(j)for(n=0;o>n;n++)h.push(M[0|j++]);else h=h.concat(H("(null)".substr(0,o),l));if(k)for(;o<r--;)h.push(32);break;case"c":for(k&&h.push(c("i8"));0<--r;)h.push(32);k||h.push(c("i8"));break;case"n":k=c("i32*"),K[k>>2]=h.length;break;case"%":h.push(d);break;default:for(n=i;f+2>n;n++)h.push(I[n])}f+=2}else h.push(d),f+=1}return h}function nb(a,b,c,d){if(c=mb(c,d),d=b===j?c.length:Math.min(c.length,Math.max(b-1,0)),0>a)var a=-a,e=Ka(d+1),a=K[a>>2]=e;for(e=0;d>e;e++)I[a+e|0]=c[e];return(b>d||b===j)&&(I[a+e|0]=0),c.length}function S(a){return K[pb>>2]=a}function qb(a){return/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/.exec(a).slice(1)}function rb(a,b){for(var c=0,d=a.length-1;d>=0;d--){var e=a[d];"."===e?a.splice(d,1):".."===e?(a.splice(d,1),c++):c&&(a.splice(d,1),c--)}if(b)for(;c--;c)a.unshift("..");return a}function sb(a){var b="/"===a.charAt(0),c="/"===a.substr(-1),a=rb(a.split("/").filter(function(a){return!!a}),!b).join("/");return!a&&!b&&(a="."),a&&c&&(a+="/"),(b?"/":"")+a}function U(){var a=Array.prototype.slice.call(arguments,0);return sb(a.filter(function(a){return"string"!=typeof a&&e(new TypeError("Arguments to path.join must be strings")),a}).join("/"))}function tb(){for(var a="",b=p,c=arguments.length-1;c>=-1&&!b;c--){var d=c>=0?arguments[c]:"/";"string"!=typeof d&&e(new TypeError("Arguments to path.resolve must be strings")),d&&(a=d+"/"+a,b="/"===d.charAt(0))}return a=rb(a.split("/").filter(function(a){return!!a}),!b).join("/"),(b?"/":"")+a||"."}function vb(a,b){ub[a]={input:[],O:[],Z:b},wb[a]={k:xb}}function Jb(a){a instanceof V||e(a+" : "+Ma()),S(a.Na)}function Y(a,b){a=tb("/",a),b=b||{Aa:0},8<b.Aa&&e(new V(R.pa));for(var c=rb(a.split("/").filter(function(a){return!!a}),p),d=Eb,f="/",g=0;g<c.length;g++){var h=g===c.length-1;if(h&&b.parent)break;if(d=Ab(d,c[g]),f=U(f,c[g]),d.Ab&&(d=d.D.root),!h||b.X)for(h=0;40960===(61440&d.mode);){d=Y(f,{X:p}).g,d.n.la||e(new V(R.u));var d=d.n.la(d),i=tb,j=qb(f),f=j[0],j=j[1];f||j?(j&&(j=j.substr(0,j.length-1)),f+=j):f=".",f=i(f,d),d=Y(f,{Aa:b.Aa}).g,40<h++&&e(new V(R.pa))}}return{path:f,g:d}}function Kb(a){for(var b;;){if(a===a.parent)return b?U(a.D.Ua,b):a.D.Ua;b=b?U(a.name,b):a.name,a=a.parent}}function Lb(a,b){for(var c=0,d=0;d<b.length;d++)c=(c<<5)-c+b.charCodeAt(d)|0;return(a+c>>>0)%Hb.length}function Ab(a,b){var c=Mb(a,"x");for(c&&e(new V(c)),c=Hb[Lb(a.id,b)];c;c=c.Bb){var d=c.name;if(c.parent.id===a.id&&d===b)return c}return a.n.wa(a,b)}function yb(a,b,c,d){var e={id:Gb++,name:b,mode:c,n:{},k:{},ka:d,parent:m,D:m};return a||(a=e),e.parent=a,e.D=a.D,Object.defineProperties(e,{K:{get:function(){return 365===(365&e.mode)},set:function(a){a?e.mode|=365:e.mode&=-366}},write:{get:function(){return 146===(146&e.mode)},set:function(a){a?e.mode|=146:e.mode&=-147}},yb:{get:function(){return 16384===(61440&e.mode)}},xb:{get:function(){return 8192===(61440&e.mode)}}}),a=Lb(e.parent.id,e.name),e.Bb=Hb[a],Hb[a]=e}function Ob(a){var b=Nb[a];return"undefined"==typeof b&&e(Error("Unknown file open mode: "+a)),b}function Mb(a,b){return Ib?0:(-1===b.indexOf("r")||292&a.mode)&&(-1===b.indexOf("w")||146&a.mode)&&(-1===b.indexOf("x")||73&a.mode)?0:R.eb}function Pb(a,b){try{return Ab(a,b),R.Da}catch(c){}return Mb(a,"wx")}function Qb(a,b,c){var d;a:{for(b=b||1,c=c||4096;c>=b;b++)if(!X[b]){d=b;break a}e(new V(R.kb))}return a.C=d,Object.defineProperties(a,{object:{get:function(){return a.g},set:function(b){a.g=b}},Yd:{get:function(){return 1!==(2097155&a.I)}},Zd:{get:function(){return 0!==(2097155&a.I)}},Xd:{get:function(){return 1024&a.I}}}),X[d]=a}function Rb(a,b){var c;b&&(c=Y(b,{X:p}),b=c.path);var d={type:a,ce:{},Ua:b,root:m},e=a.D(d);return e.D=d,d.root=e,c&&(c.g.D=d,c.g.Ab=l,"/"===b&&(Eb=d.root)),Fb.push(d),e}function Sb(a,b,c){var d=Y(a,{parent:l}).g,a="/"===a?"/":qb(a)[2],f=Pb(d,a);return f&&e(new V(f)),d.n.Q||e(new V(R.W)),d.n.Q(d,a,b,c)}function Tb(a,b){return b=4095&(b!==j?b:438),b|=32768,Sb(a,b,0)}function Ub(a,b){return b=1023&(b!==j?b:511),b|=16384,Sb(a,b,0)}function Vb(a,b,c){return"undefined"==typeof c&&(c=b,b=438),Sb(a,8192|b,c)}function Wb(a,b){var c=Y(b,{parent:l}).g,d="/"===b?"/":qb(b)[2],f=Pb(c,d);return f&&e(new V(f)),c.n.ma||e(new V(R.W)),c.n.ma(c,d,a)}function Xb(a,b){var c;c="string"==typeof a?Y(a,{X:l}).g:a,c.n.A||e(new V(R.W)),c.n.A(c,{mode:4095&b|-4096&c.mode,timestamp:Date.now()})}function Yb(a,b){var c,a=sb(a),b="string"==typeof b?Ob(b):b;c=64&b?4095&("undefined"==typeof c?438:c)|32768:0;var d;try{d=Y(a,{X:!(131072&b)}).g}catch(f){}if(64&b&&(d?128&b&&e(new V(R.Da)):d=Sb(a,c,0)),d||e(new V(R.qa)),8192===(61440&d.mode)&&(b&=-513),d?40960===(61440&d.mode)?c=R.pa:16384===(61440&d.mode)&&(0!==(2097155&b)||512&b)?c=R.oa:(c=["r","w","rw"][2097155&b],512&b&&(c+="w"),c=Mb(d,c)):c=R.qa,c&&e(new V(c)),512&b){c=d,c="string"==typeof c?Y(c,{X:l}).g:c,c.n.A||e(new V(R.W)),16384===(61440&c.mode)&&e(new V(R.oa)),32768!==(61440&c.mode)&&e(new V(R.u));var g=Mb(c,"w");g&&e(new V(g)),c.n.A(c,{size:0,timestamp:Date.now()})}return b&=-641,d=Qb({g:d,path:Kb(d),I:b,seekable:l,position:0,k:d.k,Hb:[],error:p},j,j),d.k.open&&d.k.open(d),s.logReadFiles&&!(1&b)&&(Zb||(Zb={}),a in Zb||(Zb[a]=1,s.printErr("read file: "+a))),d}function $b(a){try{a.k.close&&a.k.close(a)}catch(b){e(b)}finally{X[a.C]=m}}function ac(a,b,c,d,f,g){(0>d||0>f)&&e(new V(R.u)),0===(2097155&a.I)&&e(new V(R.ba)),16384===(61440&a.g.mode)&&e(new V(R.oa)),a.k.write||e(new V(R.u));var h=l;return"undefined"==typeof f?(f=a.position,h=p):a.seekable||e(new V(R.sa)),1024&a.I&&((!a.seekable||!a.k.N)&&e(new V(R.sa)),a.k.N(a,0,2)),b=a.k.write(a,b,c,d,f,g),h||(a.position+=b),b}function bc(){V||(V=function(a){this.Na=a;for(var b in R)if(R[b]===a){this.code=b;break}this.message=ob[a],this.stack=Ma()},V.prototype=Error())}function dc(a,b){var c=0;return a&&(c|=365),b&&(c|=146),c}function ec(a,b,c,d,e,f){if(a=b?U("string"==typeof a?a:Kb(a),b):a,d=dc(d,e),e=Tb(a,d),c){if("string"==typeof c){for(var b=Array(c.length),g=0,h=c.length;h>g;++g)b[g]=c.charCodeAt(g);c=b}Xb(a,146|d),b=Yb(a,"w"),ac(b,c,0,c.length,0,f),$b(b),Xb(a,d)}return e}function fc(a,b,c,d){a=U("string"==typeof a?a:Kb(a),b),b=dc(!!c,!!d),fc.Sa||(fc.Sa=64);var f;return f=fc.Sa++<<8|0,wb[f]={k:{open:function(a){a.seekable=p},close:function(){d&&d.buffer&&d.buffer.length&&d(10)},K:function(a,b,d,f){for(var g=0,h=0;f>h;h++){var i;try{i=c()}catch(k){e(new V(R.L))}if(i===j&&0===g&&e(new V(R.V)),i===m||i===j)break;g++,b[d+h]=i}return g&&(a.g.timestamp=Date.now()),g},write:function(a,b,c,f){for(var g=0;f>g;g++)try{d(b[c+g])}catch(h){e(new V(R.L))}return f&&(a.g.timestamp=Date.now()),g}}},Vb(a,b,f)}function gc(a){if(a.xb||a.yb||a.link||a.o)return l;var b=l;if("undefined"!=typeof XMLHttpRequest&&e(Error("Lazy loading should have been performed (contents set) in createLazyFile, but it was not. Lazy loading only works in web workers. Use --embed-file or --preload-file in emcc on the main thread.")),s.read)try{a.o=H(s.read(a.url),l)}catch(c){b=p}else e(Error("Cannot load without read() or XMLHttpRequest."));return b||S(R.L),b}function hc(a,b,c){if(a=X[a],!a)return S(R.ba),-1;try{return ac(a,I,b,c)}catch(d){return Jb(d),-1}}function ic(a,b,c,d){return c*=b,0==c?0:(a=hc(d,a,c),-1==a?((b=X[d])&&(b.error=l),0):Math.floor(a/b))}function jc(a,b,c){return c=mb(b,c),b=ha(),a=ic(L(c,"i8",Ha),1,c.length,a),ia(b),a}function mc(a){s.print("exit("+a+") called"),s.exit(a)}function nc(a){nc.qb||(D=D+4095&-4096,nc.qb=l,A(qa),nc.ob=qa,qa=function(){E("cannot dynamically allocate, sbrk now has control")});var b=D;return 0!=a&&nc.ob(a),b}function uc(a){return{jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",bmp:"image/bmp",ogg:"audio/ogg",wav:"audio/wav",mp3:"audio/mpeg"}[a.substr(a.lastIndexOf(".")+1)]}function wc(){var a=s.canvas;vc.forEach(function(b){b(a.width,a.height)})}function xc(){var a=s.canvas;this.Jb=a.width,this.Ib=a.height,a.width=screen.width,a.height=screen.height,"undefined"!=typeof SDL&&(a=Oa[SDL.screen+0*ka>>2],K[SDL.screen+0*ka>>2]=8388608|a),wc()}function yc(){var a=s.canvas;a.width=this.Jb,a.height=this.Ib,"undefined"!=typeof SDL&&(a=Oa[SDL.screen+0*ka>>2],K[SDL.screen+0*ka>>2]=-8388609&a),wc()}function Ec(a){this.name="ExitStatus",this.message="Program terminated with exit("+a+")",this.status=a}function Jc(a){function b(){if(Za||(Za=l,Ua(O)),Ua(Wa),s.calledRun=l,s._main&&Ic&&s.callMain(a),s.postRun)for("function"==typeof s.postRun&&(s.postRun=[s.postRun]);s.postRun.length;)ab(s.postRun.shift());Ua(Ya)}if(a=a||s.arguments,Gc===m&&(Gc=Date.now()),Q>0)s.P("run() called, but dependencies remain, so not running");else{if(s.preRun)for("function"==typeof s.preRun&&(s.preRun=[s.preRun]);s.preRun.length;)$a(s.preRun.shift());Ua(Va),Q>0||(s.setStatus?(s.setStatus("Running..."),setTimeout(function(){setTimeout(function(){s.setStatus("")},1),ua||b()},1)):b())}}function Kc(a){ua=l,x=Fc,Ua(Xa),e(new Ec(a))}function E(a){a&&(s.print(a),s.P(a)),ua=l,e("abort() at "+Ma())}var j=void 0,l=!0,m=null,p=!1,s;s||(s=eval("(function() { try { return Module || {} } catch(e) { return {} } })()"));var aa={},v;for(v in s)s.hasOwnProperty(v)&&(aa[v]=s[v]);var w="object"==typeof process&&"function"==typeof require,ba="object"==typeof window,ca="function"==typeof importScripts,da=!ba&&!w&&!ca;if(w){s.print=function(a){process.stdout.write(a+"\n")},s.printErr=function(a){process.stderr.write(a+"\n")};var ea=require("fs"),fa=require("path");s.read=function(a,b){var a=fa.normalize(a),c=ea.readFileSync(a);return!c&&a!=fa.resolve(a)&&(a=path.join(__dirname,"..","src",a),c=ea.readFileSync(a)),c&&!b&&(c=c.toString()),c},s.readBinary=function(a){return s.read(a,l)},s.load=function(a){ga(read(a))},s.arguments=process.argv.slice(2),module.exports=s}else da?(s.print=print,"undefined"!=typeof printErr&&(s.printErr=printErr),s.read="undefined"!=typeof read?read:function(){e("no read() available (jsc?)")},s.readBinary=function(a){return read(a,"binary")},"undefined"!=typeof scriptArgs?s.arguments=scriptArgs:"undefined"!=typeof arguments&&(s.arguments=arguments),this.Module=s):ba||ca?(s.read=function(a){var b=new XMLHttpRequest;return b.open("GET",a,p),b.send(m),b.responseText},"undefined"!=typeof arguments&&(s.arguments=arguments),"undefined"!=typeof console?(s.print=function(a){console.log(a)},s.printErr=function(a){console.log(a)}):s.print=q(),ba?this.Module=s:s.load=importScripts):e("Unknown runtime environment. Where are we?");"undefined"==!s.load&&s.read&&(s.load=function(a){ga(s.read(a))}),s.print||(s.print=q()),s.printErr||(s.printErr=s.print),s.arguments||(s.arguments=[]),s.print=s.print,s.P=s.printErr,s.preRun=[],s.postRun=[];for(v in aa)aa.hasOwnProperty(v)&&(s[v]=aa[v]);var ma,ka=4,ta={},ua=p,va;s.ccall=function(a,b,c,d){return wa(xa(a),b,c,d)},s.cwrap=function(a,b,c){var d=xa(a);return function(){return wa(d,b,c,Array.prototype.slice.call(arguments))}},s.setValue=Aa,s.getValue=function(a,b){switch(b=b||"i8","*"===b.charAt(b.length-1)&&(b="i32"),b){case"i1":return I[a];case"i8":return I[a];case"i16":return J[a>>1];case"i32":return K[a>>2];case"i64":return K[a>>2];case"float":return Fa[a>>2];case"double":return Ga[a>>3];default:E("invalid type for setValue: "+b)}return m};var Ha=1,Ia=2,Ja=4;s.ALLOC_NORMAL=0,s.ALLOC_STACK=Ha,s.ALLOC_STATIC=Ia,s.ALLOC_DYNAMIC=3,s.ALLOC_NONE=Ja,s.allocate=L,s.Pointer_stringify=za,s.UTF16ToString=function(a){for(var b=0,c="";;){var d=J[a+2*b>>1];if(0==d)return c;++b,c+=String.fromCharCode(d)}},s.stringToUTF16=function(a,b){for(var c=0;c<a.length;++c)J[b+2*c>>1]=a.charCodeAt(c);J[b+2*a.length>>1]=0},s.UTF32ToString=function(a){for(var b=0,c="";;){var d=K[a+4*b>>2];if(0==d)return c;++b,d>=65536?(d-=65536,c+=String.fromCharCode(55296|d>>10,56320|1023&d)):c+=String.fromCharCode(d)}},s.stringToUTF32=function(a,b){for(var c=0,d=0;d<a.length;++d){var e=a.charCodeAt(d);if(e>=55296&&57343>=e)var f=a.charCodeAt(++d),e=65536+((1023&e)<<10)|1023&f;K[b+4*c>>2]=e,++c}K[b+4*c>>2]=0};var I,M,J,Na,K,Oa,Fa,Ga,Qa=0,B=0,Ra=0,x=0,Sa=0,Ta=0,D=0,ra=s.TOTAL_MEMORY||16777216;A("undefined"!=typeof Int32Array&&"undefined"!=typeof Float64Array&&!!new Int32Array(1).subarray&&!!new Int32Array(1).set,"Cannot fallback to non-typed array case: Code is too specialized");var N=new ArrayBuffer(ra);I=new Int8Array(N),J=new Int16Array(N),K=new Int32Array(N),M=new Uint8Array(N),Na=new Uint16Array(N),Oa=new Uint32Array(N),Fa=new Float32Array(N),Ga=new Float64Array(N),K[0]=255,A(255===M[0]&&0===M[3],"Typed arrays 2 must be run on a little-endian system"),s.HEAP=j,s.HEAP8=I,s.HEAP16=J,s.HEAP32=K,s.HEAPU8=M,s.HEAPU16=Na,s.HEAPU32=Oa,s.HEAPF32=Fa,s.HEAPF64=Ga;var Va=[],O=[],Wa=[],Xa=[],Ya=[],Za=p;s.addOnPreRun=s.Id=$a,s.addOnInit=s.Fd=function(a){O.unshift(a)},s.addOnPreMain=s.Hd=function(a){Wa.unshift(a)},s.addOnExit=s.Ed=function(a){Xa.unshift(a)},s.addOnPostRun=s.Gd=ab,s.intArrayFromString=H,s.intArrayToString=function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c];d>255&&(d&=255),b.push(String.fromCharCode(d))}return b.join("")},s.writeStringToMemory=function(a,b,c){for(a=H(a,c),c=0;c<a.length;)I[b+c|0]=a[c],c+=1},s.writeArrayToMemory=ya,s.writeAsciiToMemory=function(a,b,c){for(var d=0;d<a.length;d++)I[b+d|0]=a.charCodeAt(d);c||(I[b+a.length|0]=0)},Math.imul||(Math.imul=function(a,b){var c=65535&a,d=65535&b;return c*d+((a>>>16)*d+c*(b>>>16)<<16)|0}),Math.Vd=Math.imul;var Ba=Math.abs,Ea=Math.ceil,Da=Math.floor,Ca=Math.min,Q=0,db={},eb=m,fb=m;s.addRunDependency=gb,s.removeRunDependency=hb,s.preloadedImages={},s.preloadedAudios={},Qa=8,B=Qa+1376,O.push({M:function(){ib()}}),L([109,95,108,111,111,107,117,112,91,116,93,32,61,61,32,99,85,73,78,84,51,50,95,77,65,88,0,0,0,0,0,0,116,32,60,32,40,49,85,32,60,60,32,116,97,98,108,101,95,98,105,116,115,41,0,0,112,67,111,100,101,115,105,122,101,115,91,115,121,109,95,105,110,100,101,120,93,32,61,61,32,99,111,100,101,115,105,122,101,0,0,0,0,0,0,0,115,111,114,116,101,100,95,112,111,115,32,60,32,116,111,116,97,108,95,117,115,101,100,95,115,121,109,115,0,0,0,0,110,117,109,95,99,111,100,101,115,91,99,93,0,0,0,0,110,101,119,95,99,97,112,97,99,105,116,121,32,38,38,32,40,110,101,119,95,99,97,112,97,99,105,116,121,32,62,32,109,95,99,97,112,97,99,105,116,121,41,0,0,0,0,0,40,108,101,110,32,62,61,32,49,41,32,38,38,32,40,108,101,110,32,60,61,32,99,77,97,120,69,120,112,101,99,116,101,100,67,111,100,101,83,105,122,101,41,0,0,0,0,0,110,101,120,116,95,108,101,118,101,108,95,111,102,115,32,62,32,99,117,114,95,108,101,118,101,108,95,111,102,115,0,0,110,117,109,32,38,38,32,40,110,117,109,32,61,61,32,126,110,117,109,95,99,104,101,99,107,41,0,0,0,0,0,0,105,32,60,32,109,95,115,105,122,101,0,0,0,0,0,0,109,105,110,95,110,101,119,95,99,97,112,97,99,105,116,121,32,60,32,40,48,120,55,70,70,70,48,48,48,48,85,32,47,32,101,108,101,109,101,110,116,95,115,105,122,101,41,0,109,111,100,101,108,46,109,95,99,111,100,101,95,115,105,122,101,115,91,115,121,109,93,32,61,61,32,108,101,110,0,0,116,32,33,61,32,99,85,73,78,84,51,50,95,77,65,88,0,0,0,0,0,0,0,0,109,95,98,105,116,95,99,111,117,110,116,32,60,61,32,99,66,105,116,66,117,102,83,105,122,101,0,0,0,0,0,0,48,0,0,0,0,0,0,0,46,46,47,105,110,99,47,99,114,110,95,100,101,99,111,109,112,46,104,0,0,0,0,0,40,116,111,116,97,108,95,115,121,109,115,32,62,61,32,49,41,32,38,38,32,40,116,111,116,97,108,95,115,121,109,115,32,60,61,32,112,114,101,102,105,120,95,99,111,100,105,110,103,58,58,99,77,97,120,83,117,112,112,111,114,116,101,100,83,121,109,115,41,0,0,0,102,97,108,115,101,0,0,0,99,114,110,100,95,102,114,101,101,58,32,98,97,100,32,112,116,114,0,0,0,0,0,0,99,114,110,100,95,114,101,97,108,108,111,99,58,32,98,97,100,32,112,116,114,0,0,0,40,40,117,105,110,116,51,50,41,112,95,110,101,119,32,38,32,40,67,82,78,68,95,77,73,78,95,65,76,76,79,67,95,65,76,73,71,78,77,69,78,84,32,45,32,49,41,41,32,61,61,32,48,0,0,0,99,114,110,100,95,109,97,108,108,111,99,58,32,111,117,116,32,111,102,32,109,101,109,111,114,121,0,0,0,0,0,0,99,114,110,100,95,109,97,108,108,111,99,58,32,115,105,122,101,32,116,111,111,32,98,105,103,0,0,0,0,0,0,0,109,95,115,105,122,101,32,60,61,32,109,95,99,97,112,97,99,105,116,121,0,0,0,0,37,115,40,37,117,41,58,32,65,115,115,101,114,116,105,111,110,32,102,97,105,108,117,114,101,58,32,34,37,115,34,10,0,0,0,0,0,0,0,0,17,18,19,20,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15,16,0,0,0,1,2,2,3,3,3,3,4,0,0,0,0,0,0,1,1,0,1,0,1,0,0,1,2,1,2,0,0,0,1,0,2,1,0,2,0,0,1,2,3,0,2,3,4,5,6,7,1,0,2,3,1,0,0,0,0],"i8",Ja,8);var jb=sa(L(12,"i8",Ia),8);A(0==jb%8),s._strlen=kb;var R={W:1,qa:2,qd:3,nc:4,L:5,Ga:6,Kb:7,Kc:8,ba:9,Yb:10,V:11,Ad:11,lb:12,eb:13,ic:14,Wc:15,Wb:16,Da:17,Bd:18,Ea:19,Xc:20,oa:21,u:22,Fc:23,kb:24,ad:25,xd:26,jc:27,Sc:28,sa:29,nd:30,yc:31,fd:32,fc:33,kd:34,Oc:42,lc:43,Zb:44,pc:45,qc:46,rc:47,xc:48,yd:49,Ic:50,oc:51,dc:35,Lc:37,Pb:52,Sb:53,Cd:54,Gc:55,Tb:56,Ub:57,ec:35,Vb:59,Uc:60,Jc:61,ud:62,Tc:63,Pc:64,Qc:65,md:66,Mc:67,Nb:68,rd:69,$b:70,gd:71,Ac:72,gc:73,Rb:74,bd:76,Qb:77,ld:78,sc:79,tc:80,wc:81,vc:82,uc:83,Vc:38,Fa:39,Bc:36,pa:40,ra:95,ed:96,cc:104,Hc:105,Ob:97,jd:91,Zc:88,Rc:92,od:108,bc:111,Lb:98,ac:103,Ec:101,Cc:100,vd:110,kc:112,hb:113,ib:115,fb:114,gb:89,zc:90,hd:93,pd:94,Mb:99,Dc:102,jb:106,ca:107,wd:109,zd:87,hc:122,sd:116,$c:95,Nc:123,mc:84,cd:75,Xb:125,Yc:131,dd:130,td:86},ob={0:"Success",1:"Not super-user",2:"No such file or directory",3:"No such process",4:"Interrupted system call",5:"I/O error",6:"No such device or address",7:"Arg list too long",8:"Exec format error",9:"Bad file number",10:"No children",11:"No more processes",12:"Not enough core",13:"Permission denied",14:"Bad address",15:"Block device required",16:"Mount device busy",17:"File exists",18:"Cross-device link",19:"No such device",20:"Not a directory",21:"Is a directory",22:"Invalid argument",23:"Too many open files in system",24:"Too many open files",25:"Not a typewriter",26:"Text file busy",27:"File too large",28:"No space left on device",29:"Illegal seek",30:"Read only file system",31:"Too many links",32:"Broken pipe",33:"Math arg out of domain of func",34:"Math result not representable",35:"File locking deadlock error",36:"File or path name too long",37:"No record locks available",38:"Function not implemented",39:"Directory not empty",40:"Too many symbolic links",42:"No message of desired type",43:"Identifier removed",44:"Channel number out of range",45:"Level 2 not synchronized",46:"Level 3 halted",47:"Level 3 reset",48:"Link number out of range",49:"Protocol driver not attached",50:"No CSI structure available",51:"Level 2 halted",52:"Invalid exchange",53:"Invalid request descriptor",54:"Exchange full",55:"No anode",56:"Invalid request code",57:"Invalid slot",59:"Bad font file fmt",60:"Device not a stream",61:"No data (for no delay io)",62:"Timer expired",63:"Out of streams resources",64:"Machine is not on the network",65:"Package not installed",66:"The object is remote",67:"The link has been severed",68:"Advertise error",69:"Srmount error",70:"Communication error on send",71:"Protocol error",72:"Multihop attempted",73:"Cross mount point (not really error)",74:"Trying to read unreadable message",75:"Value too large for defined data type",76:"Given log. name not unique",77:"f.d. invalid for this operation",78:"Remote address changed",79:"Can   access a needed shared lib",80:"Accessing a corrupted shared lib",81:".lib section in a.out corrupted",82:"Attempting to link in too many libs",83:"Attempting to exec a shared library",84:"Illegal byte sequence",86:"Streams pipe error",87:"Too many users",88:"Socket operation on non-socket",89:"Destination address required",90:"Message too long",91:"Protocol wrong type for socket",92:"Protocol not available",93:"Unknown protocol",94:"Socket type not supported",95:"Not supported",96:"Protocol family not supported",97:"Address family not supported by protocol family",98:"Address already in use",99:"Address not available",100:"Network interface is not configured",101:"Network is unreachable",102:"Connection reset by network",103:"Connection aborted",104:"Connection reset by peer",105:"No buffer space available",106:"Socket is already connected",107:"Socket is not connected",108:"Can't send after socket shutdown",109:"Too many references",110:"Connection timed out",111:"Connection refused",112:"Host is down",113:"Host is unreachable",114:"Socket already connected",115:"Connection already in progress",116:"Stale file handle",122:"Quota exceeded",123:"No medium (in tape drive)",125:"Operation canceled",130:"Previous owner died",131:"State not recoverable"},pb=0,ub=[],xb={open:function(a){var b=ub[a.g.ka];b||e(new V(R.Ea)),a.B=b,a.seekable=p},close:function(a){a.B.O.length&&a.B.Z.ja(a.B,10)},K:function(a,b,c,d){(!a.B||!a.B.Z.Qa)&&e(new V(R.Ga));for(var f=0,g=0;d>g;g++){var h;try{h=a.B.Z.Qa(a.B)}catch(i){e(new V(R.L))}if(h===j&&0===f&&e(new V(R.V)),h===m||h===j)break;f++,b[c+g]=h}return f&&(a.g.timestamp=Date.now()),f},write:function(a,b,c,d){(!a.B||!a.B.Z.ja)&&e(new V(R.Ga));for(var f=0;d>f;f++)try{a.B.Z.ja(a.B,b[c+f])}catch(g){e(new V(R.L))}return d&&(a.g.timestamp=Date.now()),f}},W={cb:1,na:2,bb:3,D:function(){return W.createNode(m,"/",16895,0)},createNode:function(a,b,c,d){return(24576===(61440&c)||4096===(61440&c))&&e(new V(R.W)),c=yb(a,b,c,d),16384===(61440&c.mode)?(c.n={J:W.n.J,A:W.n.A,wa:W.n.wa,Q:W.n.Q,Q:W.n.Q,rename:W.n.rename,ab:W.n.ab,Za:W.n.Za,Xa:W.n.Xa,ma:W.n.ma},c.k={N:W.k.N},c.o={}):32768===(61440&c.mode)?(c.n={J:W.n.J,A:W.n.A},c.k={N:W.k.N,K:W.k.K,write:W.k.write,Ja:W.k.Ja,Ta:W.k.Ta},c.o=[],c.ea=W.na):40960===(61440&c.mode)?(c.n={J:W.n.J,A:W.n.A,la:W.n.la},c.k={}):8192===(61440&c.mode)&&(c.n={J:W.n.J,A:W.n.A},c.k=zb),c.timestamp=Date.now(),a&&(a.o[b]=c),c},ua:function(a){a.ea!==W.na&&(a.o=Array.prototype.slice.call(a.o),a.ea=W.na)},n:{J:function(a){var b={};return b.Qd=8192===(61440&a.mode)?a.id:1,b.Wd=a.id,b.mode=a.mode,b.ae=1,b.uid=0,b.Ud=0,b.ka=a.ka,b.size=16384===(61440&a.mode)?4096:32768===(61440&a.mode)?a.o.length:40960===(61440&a.mode)?a.link.length:0,b.Kd=new Date(a.timestamp),b.$d=new Date(a.timestamp),b.Pd=new Date(a.timestamp),b.pb=4096,b.Md=Math.ceil(b.size/b.pb),b},A:function(a,b){if(b.mode!==j&&(a.mode=b.mode),b.timestamp!==j&&(a.timestamp=b.timestamp),b.size!==j){W.ua(a);var c=a.o;if(b.size<c.length)c.length=b.size;else for(;b.size>c.length;)c.push(0)}},wa:function(){e(new V(R.qa))},Q:function(a,b,c,d){return W.createNode(a,b,c,d)},rename:function(a,b,c){if(16384===(61440&a.mode)){var d;try{d=Ab(b,c)}catch(f){}if(d)for(var g in d.o)e(new V(R.Fa))}delete a.parent.o[a.name],a.name=c,b.o[c]=a,a.parent=b},ab:function(a,b){delete a.o[b]},Za:function(a,b){var c,d=Ab(a,b);for(c in d.o)e(new V(R.Fa));delete a.o[b]},Xa:function(a){var b,c=[".",".."];for(b in a.o)a.o.hasOwnProperty(b)&&c.push(b);return c},ma:function(a,b,c){return a=W.createNode(a,b,41471,0),a.link=c,a},la:function(a){return 40960!==(61440&a.mode)&&e(new V(R.u)),a.link}},k:{K:function(a,b,c,d,e){if(a=a.g.o,e>=a.length)return 0;if(d=Math.min(a.length-e,d),A(d>=0),d>8&&a.subarray)b.set(a.subarray(e,e+d),c);else for(var f=0;d>f;f++)b[c+f]=a[e+f];return d},write:function(a,b,c,d,e,f){var g=a.g;if(g.timestamp=Date.now(),a=g.o,d&&0===a.length&&0===e&&b.subarray)return A(b.length),f&&b.buffer===I.buffer&&0===c?(g.o=b,g.ea=W.cb):(g.o=new Uint8Array(b.subarray(c,c+d)),g.ea=W.bb),d;for(W.ua(g),a=g.o;a.length<e;)a.push(0);for(f=0;d>f;f++)a[e+f]=b[c+f];return d},N:function(a,b,c){
return 1===c?b+=a.position:2===c&&32768===(61440&a.g.mode)&&(b+=a.g.o.length),0>b&&e(new V(R.u)),a.Hb=[],a.position=b},Ja:function(a,b,c){for(W.ua(a.g),a=a.g.o,b+=c;b>a.length;)a.push(0)},Ta:function(a,b,c,d,f,g,h){return 32768!==(61440&a.g.mode)&&e(new V(R.Ea)),a=a.g.o,2&h||a.buffer!==b&&a.buffer!==b.buffer?((f>0||f+d<a.length)&&(a=a.subarray?a.subarray(f,f+d):Array.prototype.slice.call(a,f,f+d)),f=l,(d=Ka(d))||e(new V(R.lb)),b.set(a,d)):(f=p,d=a.byteOffset),{de:d,Jd:f}}}},Bb=L(1,"i32*",Ia),Cb=L(1,"i32*",Ia),Db=L(1,"i32*",Ia),Eb=m,Fb=[],wb=[m],X=[m],Gb=1,Hb=m,Ib=l,V=m,Nb={r:0,rs:1052672,"r+":2,w:577,wx:705,xw:705,"w+":578,"wx+":706,"xw+":706,a:1089,ax:1217,xa:1217,"a+":1090,"ax+":1218,"xa+":1218},zb={open:function(a){a.k=wb[a.g.ka].k,a.k.open&&a.k.open(a)},N:function(){e(new V(R.sa))}},cc,Zb,Z={D:function(){return yb(m,"/",16895,0)},sb:function(a,b,c){return c&&A(1==b==(6==c)),a={tb:a,type:b,protocol:c,p:m,$:{},ya:[],R:[],T:Z.q},b=Z.ia(),c=yb(Z.root,b,49152,0),c.S=a,b=Qb({path:b,g:c,I:Ob("r+"),seekable:p,k:Z.k}),a.$a=b,a},ub:function(a){return a=X[a],a&&49152===(49152&a.g.mode)?a.g.S:m},k:{Wa:function(a){return a=a.g.S,a.T.Wa(a)},Ra:function(a,b,c){return a=a.g.S,a.T.Ra(a,b,c)},K:function(a,b,c,d){return a=a.g.S,(d=a.T.Db(a,d))?(b.set(d.buffer,c),d.buffer.length):0},write:function(a,b,c,d){return a=a.g.S,a.T.Fb(a,b,c,d)},close:function(a){a=a.g.S,a.T.close(a)}},ia:function(){return Z.ia.Ma||(Z.ia.Ma=0),"socket["+Z.ia.Ma++ +"]"},q:{fa:function(a,b,c){var d;if("object"==typeof b&&(d=b,c=b=m),d)d.Ha?(b=d.Ha.ee,c=d.Ha.fe):((c=/ws[s]?:\/\/([^:]+):(\d+)/.exec(d.url))||e(Error("WebSocket URL must be in the format ws(s)://address:port")),b=c[1],c=parseInt(c[2],10));else try{d=new WebSocket("ws://"+b+":"+c,w?{}:["binary"]),d.binaryType="arraybuffer"}catch(f){e(new V(R.hb))}return b={F:b,port:c,e:d,ga:[]},Z.q.Ia(a,b),Z.q.wb(a,b),2===a.type&&"undefined"!=typeof a.U&&b.ga.push(new Uint8Array([255,255,255,255,112,111,114,116,(65280&a.U)>>8,255&a.U])),b},ha:function(a,b,c){return a.$[b+":"+c]},Ia:function(a,b){a.$[b.F+":"+b.port]=b},Ya:function(a,b){delete a.$[b.F+":"+b.port]},wb:function(a,b){function c(c){A("string"!=typeof c&&c.byteLength!==j);var c=new Uint8Array(c),d=e;e=p,d&&10===c.length&&255===c[0]&&255===c[1]&&255===c[2]&&255===c[3]&&112===c[4]&&111===c[5]&&114===c[6]&&116===c[7]?(c=c[8]<<8|c[9],Z.q.Ya(a,b),b.port=c,Z.q.Ia(a,b)):a.R.push({F:b.F,port:b.port,data:c})}function d(){try{for(var a=b.ga.shift();a;)b.e.send(a),a=b.ga.shift()}catch(c){b.e.close()}}var e=l;w?(b.e.Y("open",d),b.e.Y("message",function(a,b){b.Ld&&c(new Uint8Array(a).buffer)}),b.e.Y("error",q())):(b.e.onopen=d,b.e.onmessage=function(a){c(a.data)})},Wa:function(a){if(1===a.type&&a.p)return a.ya.length?65:0;var b=0,c=1===a.type?Z.q.ha(a,a.G,a.H):m;return(a.R.length||!c||c&&c.e.readyState===c.e.aa||c&&c.e.readyState===c.e.CLOSED)&&(b|=65),(!c||c&&c.e.readyState===c.e.OPEN)&&(b|=4),(c&&c.e.readyState===c.e.aa||c&&c.e.readyState===c.e.CLOSED)&&(b|=16),b},Ra:function(a,b,c){switch(b){case 21531:return b=0,a.R.length&&(b=a.R[0].data.length),K[c>>2]=b,0;default:return R.u}},close:function(a){if(a.p){try{a.p.close()}catch(b){}a.p=m}for(var c=Object.keys(a.$),d=0;d<c.length;d++){var e=a.$[c[d]];try{e.e.close()}catch(f){}Z.q.Ya(a,e)}return 0},bind:function(a,b,c){if(("undefined"!=typeof a.Ca||"undefined"!=typeof a.U)&&e(new V(R.u)),a.Ca=b,a.U=c||_mkport(),2===a.type){a.p&&(a.p.close(),a.p=m);try{a.T.zb(a,0)}catch(d){d instanceof V||e(d),d.Na!==R.ra&&e(d)}}},Od:function(a,b,c){if(a.p&&e(new V(ERRNO_CODS.ra)),"undefined"!=typeof a.G&&"undefined"!=typeof a.H){var d=Z.q.ha(a,a.G,a.H);d&&(d.e.readyState===d.e.CONNECTING&&e(new V(R.fb)),e(new V(R.jb)))}b=Z.q.fa(a,b,c),a.G=b.F,a.H=b.port,e(new V(R.ib))},zb:function(a){w||e(new V(R.ra)),a.p&&e(new V(R.u));var b=require("ws").Dd;a.p=new b({host:a.Ca,port:a.U}),a.p.Y("connection",function(b){if(1===a.type){var c=Z.sb(a.tb,a.type,a.protocol),b=Z.q.fa(c,b);c.G=b.F,c.H=b.port,a.ya.push(c)}else Z.q.fa(a,b)}),a.p.Y("closed",function(){a.p=m}),a.p.Y("error",q())},accept:function(a){a.p||e(new V(R.u));var b=a.ya.shift();return b.$a.I=a.$a.I,b},Td:function(a,b){var c,d;return b?((a.G===j||a.H===j)&&e(new V(R.ca)),c=a.G,d=a.H):(c=a.Ca||0,d=a.U||0),{F:c,port:d}},Fb:function(a,b,c,d,f,g){2===a.type?((f===j||g===j)&&(f=a.G,g=a.H),(f===j||g===j)&&e(new V(R.gb))):(f=a.G,g=a.H);var h=Z.q.ha(a,f,g);if(1===a.type&&((!h||h.e.readyState===h.e.aa||h.e.readyState===h.e.CLOSED)&&e(new V(R.ca)),h.e.readyState===h.e.CONNECTING&&e(new V(R.V))),b=b instanceof Array||b instanceof ArrayBuffer?b.slice(c,c+d):b.buffer.slice(b.byteOffset+c,b.byteOffset+c+d),2===a.type&&(!h||h.e.readyState!==h.e.OPEN))return h&&h.e.readyState!==h.e.aa&&h.e.readyState!==h.e.CLOSED||(h=Z.q.fa(a,f,g)),h.ga.push(b),d;try{return h.e.send(b),d}catch(i){e(new V(R.u))}},Db:function(a,b){1===a.type&&a.p&&e(new V(R.ca));var c=a.R.shift();if(!c){if(1===a.type){var d=Z.q.ha(a,a.G,a.H);if(d){if(d.e.readyState===d.e.aa||d.e.readyState===d.e.CLOSED)return m;e(new V(R.V))}e(new V(R.ca))}e(new V(R.V))}var d=c.data.byteLength||c.data.length,f=c.data.byteOffset||0,g=c.data.buffer||c.data,h=Math.min(b,d),i={buffer:new Uint8Array(g,f,h),F:c.F,port:c.port};return 1===a.type&&d>h&&(c.data=new Uint8Array(g,f+h,d-h),a.R.unshift(c)),i}}};s._memset=kc,s._memcpy=lc;var oc=p,pc=p,qc=p,rc=p,sc=j,tc=j,vc=[],zc,Ac,Bc,Cc;bc(),Hb=Array(4096),Eb=yb(m,"/",16895,0),Rb(W,"/"),Ub("/tmp"),Ub("/dev"),wb[259]={k:{K:function(){return 0},write:function(){return 0}}},Vb("/dev/null",259),vb(1280,{Qa:function(a){if(!a.input.length){var b=m;if(w){if(b=process.stdin.read(),!b){if(process.stdin._readableState&&process.stdin._readableState.ended)return m;return}}else"undefined"!=typeof window&&"function"==typeof window.prompt?(b=window.prompt("Input: "),b!==m&&(b+="\n")):"function"==typeof readline&&(b=readline(),b!==m&&(b+="\n"));if(!b)return m;a.input=H(b,l)}return a.input.shift()},ja:function(a,b){b===m||10===b?(s.print(a.O.join("")),a.O=[]):a.O.push(Dc.za(b))}}),vb(1536,{ja:function(a,b){b===m||10===b?(s.printErr(a.O.join("")),a.O=[]):a.O.push(Dc.za(b))}}),Vb("/dev/tty",1280),Vb("/dev/tty1",1536),Ub("/dev/shm"),Ub("/dev/shm/tmp"),O.unshift({M:function(){if(!s.noFSInit&&!cc){A(!cc,"FS.init was previously called. If you want to initialize later with custom parameters, remove any earlier calls (note that one is automatically added to the generated code)"),cc=l,bc(),s.stdin=s.stdin,s.stdout=s.stdout,s.stderr=s.stderr,s.stdin?fc("/dev","stdin",s.stdin):Wb("/dev/tty","/dev/stdin"),s.stdout?fc("/dev","stdout",m,s.stdout):Wb("/dev/tty","/dev/stdout"),s.stderr?fc("/dev","stderr",m,s.stderr):Wb("/dev/tty1","/dev/stderr");var a=Yb("/dev/stdin","r");K[Bb>>2]=a.C,A(1===a.C,"invalid handle for stdin ("+a.C+")"),a=Yb("/dev/stdout","w"),K[Cb>>2]=a.C,A(2===a.C,"invalid handle for stdout ("+a.C+")"),a=Yb("/dev/stderr","w"),K[Db>>2]=a.C,A(3===a.C,"invalid handle for stderr ("+a.C+")")}}}),Wa.push({M:function(){Ib=p}}),Xa.push({M:function(){cc=p;for(var a=0;a<X.length;a++){var b=X[a];b&&$b(b)}}}),s.FS_createFolder=function(a,b,c,d){return a=U("string"==typeof a?a:Kb(a),b),Ub(a,dc(c,d))},s.FS_createPath=function(a,b){for(var a="string"==typeof a?a:Kb(a),c=b.split("/").reverse();c.length;){var d=c.pop();if(d){var e=U(a,d);try{Ub(e)}catch(f){}a=e}}return e},s.FS_createDataFile=ec,s.FS_createPreloadedFile=function(a,b,c,d,f,g,h,i,k){function n(){qc=document.pointerLockElement===t||document.mozPointerLockElement===t||document.webkitPointerLockElement===t}function o(c){function e(c){i||ec(a,b,c,d,f,k),g&&g(),hb("cp "+u)}var j=p;s.preloadPlugins.forEach(function(a){!j&&a.canHandle(u)&&(a.handle(c,u,e,function(){h&&h(),hb("cp "+u)}),j=l)}),j||e(c)}if(s.preloadPlugins||(s.preloadPlugins=[]),!zc&&!ca){zc=l;try{new Blob,Ac=l}catch(r){Ac=p,console.log("warning: no blob constructor, cannot create blobs with mimetypes")}Bc="undefined"!=typeof MozBlobBuilder?MozBlobBuilder:"undefined"!=typeof WebKitBlobBuilder?WebKitBlobBuilder:Ac?m:console.log("warning: no BlobBuilder"),Cc="undefined"!=typeof window?window.URL?window.URL:window.webkitURL:j,!s.Va&&"undefined"==typeof Cc&&(console.log("warning: Browser does not support creating object URLs. Built-in browser image decoding will not be available."),s.Va=l),s.preloadPlugins.push({canHandle:function(a){return!s.Va&&/\.(jpg|jpeg|png|bmp)$/i.test(a)},handle:function(a,b,c,d){var e=m;if(Ac)try{e=new Blob([a],{type:uc(b)}),e.size!==a.length&&(e=new Blob([new Uint8Array(a).buffer],{type:uc(b)}))}catch(f){var g="Blob constructor present but fails: "+f+"; falling back to blob builder";ma||(ma={}),ma[g]||(ma[g]=1,s.P(g))}e||(e=new Bc,e.append(new Uint8Array(a).buffer),e=e.getBlob());var h=Cc.createObjectURL(e),i=new Image;i.onload=function(){A(i.complete,"Image "+b+" could not be decoded");var d=document.createElement("canvas");d.width=i.width,d.height=i.height,d.getContext("2d").drawImage(i,0,0),s.preloadedImages[b]=d,Cc.revokeObjectURL(h),c&&c(a)},i.onerror=function(){console.log("Image "+h+" could not be decoded"),d&&d()},i.src=h}}),s.preloadPlugins.push({canHandle:function(a){return!s.be&&a.substr(-4)in{".ogg":1,".wav":1,".mp3":1}},handle:function(a,b,c,d){function e(d){g||(g=l,s.preloadedAudios[b]=d,c&&c(a))}function f(){g||(g=l,s.preloadedAudios[b]=new Audio,d&&d())}var g=p;if(!Ac)return f();try{var h=new Blob([a],{type:uc(b)})}catch(i){return f()}var h=Cc.createObjectURL(h),j=new Audio;j.addEventListener("canplaythrough",function(){e(j)},p),j.onerror=function(){if(!g){console.log("warning: browser could not fully decode audio "+b+", trying slower base64 approach");for(var c="",d=0,f=0,h=0;h<a.length;h++)for(d=d<<8|a[h],f+=8;f>=6;)var i=d>>f-6&63,f=f-6,c=c+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[i];2==f?(c+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(3&d)<<4],c+="=="):4==f&&(c+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(15&d)<<2],c+="="),j.src="data:audio/x-"+b.substr(-3)+";base64,"+c,e(j)}},j.src=h,setTimeout(function(){ua||e(j)},1e4)}});var t=s.canvas;t.Ba=t.requestPointerLock||t.mozRequestPointerLock||t.webkitRequestPointerLock,t.Oa=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock||q(),t.Oa=t.Oa.bind(document),document.addEventListener("pointerlockchange",n,p),document.addEventListener("mozpointerlockchange",n,p),document.addEventListener("webkitpointerlockchange",n,p),s.elementPointerLock&&t.addEventListener("click",function(a){!qc&&t.Ba&&(t.Ba(),a.preventDefault())},p)}var u=b?tb(U(a,b)):a;if(gb("cp "+u),"string"==typeof c){var v=h,w=function(){v?v():e('Loading data file "'+c+'" failed.')},x=new XMLHttpRequest;x.open("GET",c,l),x.responseType="arraybuffer",x.onload=function(){if(200==x.status||0==x.status&&x.response){var a=x.response;A(a,'Loading data file "'+c+'" failed (no arrayBuffer).'),a=new Uint8Array(a),o(a),hb("al "+c)}else w()},x.onerror=w,x.send(m),gb("al "+c)}else o(c)},s.FS_createLazyFile=function(a,b,c,d,f){var g,h;"undefined"!=typeof XMLHttpRequest?(ca||e("Cannot do synchronous binary XHRs outside webworkers in modern browsers. Use --embed-file or --preload-file in emcc"),g=function(){this.va=p,this.da=[]},g.prototype.get=function(a){if(!(a>this.length-1||0>a)){var b=a%this.rb;return this.vb(Math.floor(a/this.rb))[b]}},g.prototype.Gb=function(a){this.vb=a},g.prototype.Ka=function(){var a=new XMLHttpRequest;a.open("HEAD",c,p),a.send(m),200<=a.status&&300>a.status||304===a.status||e(Error("Couldn't load "+c+". Status: "+a.status));var b,d=Number(a.getResponseHeader("Content-length")),f=1048576;(b=a.getResponseHeader("Accept-Ranges"))&&"bytes"===b||(f=d);var g=this;g.Gb(function(a){var b=a*f,h=(a+1)*f-1,h=Math.min(h,d-1);if("undefined"==typeof g.da[a]){var i=g.da;b>h&&e(Error("invalid range ("+b+", "+h+") or no bytes requested!")),h>d-1&&e(Error("only "+d+" bytes available! programmer error!"));var k=new XMLHttpRequest;k.open("GET",c,p),d!==f&&k.setRequestHeader("Range","bytes="+b+"-"+h),"undefined"!=typeof Uint8Array&&(k.responseType="arraybuffer"),k.overrideMimeType&&k.overrideMimeType("text/plain; charset=x-user-defined"),k.send(m),200<=k.status&&300>k.status||304===k.status||e(Error("Couldn't load "+c+". Status: "+k.status)),b=k.response!==j?new Uint8Array(k.response||[]):H(k.responseText||"",l),i[a]=b}return"undefined"==typeof g.da[a]&&e(Error("doXHR failed!")),g.da[a]}),this.nb=d,this.mb=f,this.va=l},g=new g,Object.defineProperty(g,"length",{get:function(){return this.va||this.Ka(),this.nb}}),Object.defineProperty(g,"chunkSize",{get:function(){return this.va||this.Ka(),this.mb}}),h=j):(h=c,g=j);var i,a=U("string"==typeof a?a:Kb(a),b);i=Tb(a,dc(d,f)),g?i.o=g:h&&(i.o=m,i.url=h);var k={};return Object.keys(i.k).forEach(function(a){var b=i.k[a];k[a]=function(){return gc(i)||e(new V(R.L)),b.apply(m,arguments)}}),k.K=function(a,b,c,d,f){if(gc(i)||e(new V(R.L)),a=a.g.o,f>=a.length)return 0;if(d=Math.min(a.length-f,d),A(d>=0),a.slice)for(var g=0;d>g;g++)b[c+g]=a[f+g];else for(g=0;d>g;g++)b[c+g]=a.get(f+g);return d},i.k=k,i},s.FS_createLink=function(a,b,c){return a=U("string"==typeof a?a:Kb(a),b),Wb(c,a)},s.FS_createDevice=fc,pb=pa(4),K[pb>>2]=0,O.unshift({M:q()}),Xa.push({M:q()});var Dc=new na;w&&(require("fs"),process.platform.match(/^win/)),O.push({M:function(){Z.root=Rb(Z,m)}}),s.requestFullScreen=function(a,b){function c(){pc=p,(document.webkitFullScreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.mozFullscreenElement||document.fullScreenElement||document.fullscreenElement)===d?(d.La=document.cancelFullScreen||document.mozCancelFullScreen||document.webkitCancelFullScreen,d.La=d.La.bind(document),sc&&d.Ba(),pc=l,tc&&xc()):tc&&yc(),s.onFullScreen&&s.onFullScreen(pc)}sc=a,tc=b,"undefined"==typeof sc&&(sc=l),"undefined"==typeof tc&&(tc=p);var d=s.canvas;rc||(rc=l,document.addEventListener("fullscreenchange",c,p),document.addEventListener("mozfullscreenchange",c,p),document.addEventListener("webkitfullscreenchange",c,p)),d.Eb=d.requestFullScreen||d.mozRequestFullScreen||(d.webkitRequestFullScreen?function(){d.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)}:m),d.Eb()},s.requestAnimationFrame=function(a){window.requestAnimationFrame||(window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||window.setTimeout),window.requestAnimationFrame(a)},s.setCanvasSize=function(a,b,c){var d=s.canvas;d.width=a,d.height=b,c||wc()},s.pauseMainLoop=q(),s.resumeMainLoop=function(){oc&&(oc=p,m())},s.getUserMedia=function(){window.Pa||(window.Pa=navigator.getUserMedia||navigator.mozGetUserMedia),window.Pa(j)},Ra=x=sa(B),Sa=Ra+5242880,Ta=D=sa(Sa),A(ra>Ta),Ca=Math.min;var $=function(a,b,c){"use asm";function d(a){a|=0;var b=0;return b=ba,ba=ba+a|0,ba=ba+7&-8,b|0}function e(){return ba|0}function f(a){a|=0,ba=a}function g(a,b){a|=0,b|=0,(da|0)==0&&(da=a,ea=b)}function h(a){a|=0,fa=a}function i(a){a|=0,ga=a}function j(a){a|=0,ha=a}function k(a){a|=0,ia=a}function l(a){a|=0,ja=a}function m(a){a|=0,ka=a}function n(a){a|=0,la=a}function o(a){a|=0,ma=a}function p(a){a|=0,na=a}function q(a){a|=0,oa=a}function r(){}function s(a,b,c,d){a|=0,b|=0,c|=0,d|=0;var e=0,f=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=0,p=0;if(e=ba,ba=ba+1032|0,f=e|0,g=e+512|0,h=e+520|0,i=a+8|0,($[a+4>>2]|0)>>>0>($[i>>2]|0)>>>0&&(j=h|0,ua(j|0,768,(k=ba,ba=ba+24|0,$[k>>2]=472,$[k+8>>2]=2121,$[k+16>>2]=744,k|0))|0,ba=k,sa(j|0,(k=ba,ba=ba+1|0,ba=ba+7&-8,$[k>>2]=0,k|0))|0,ba=k),(2147418112/(d>>>0)|0)>>>0<=b>>>0&&(j=h|0,ua(j|0,768,(k=ba,ba=ba+24|0,$[k>>2]=472,$[k+8>>2]=2122,$[k+16>>2]=328,k|0))|0,ba=k,sa(j|0,(k=ba,ba=ba+1|0,ba=ba+7&-8,$[k>>2]=0,k|0))|0,ba=k),j=$[i>>2]|0,j>>>0>=b>>>0)return l=1,ba=e,l|0;do if(c){if(m=b-1|0,(b|0)!=0&&(m&b|0)==0){n=b;break}o=m>>>16|m,m=o>>>8|o,o=m>>>4|m,m=o>>>2|o,n=(m>>>1|m)+1|0}else n=b;while(0);return(n|0)!=0&n>>>0>j>>>0||(j=h|0,ua(j|0,768,(k=ba,ba=ba+24|0,$[k>>2]=472,$[k+8>>2]=2131,$[k+16>>2]=152,k|0))|0,ba=k,sa(j|0,(k=ba,ba=ba+1|0,ba=ba+7&-8,$[k>>2]=0,k|0))|0,ba=k),j=pa(n,d)|0,h=a|0,a=$[h>>2]|0,(a&7|0)!=0?(b=f|0,ua(b|0,768,(k=ba,ba=ba+24|0,$[k>>2]=472,$[k+8>>2]=2500,$[k+16>>2]=600,k|0))|0,ba=k,sa(b|0,(k=ba,ba=ba+1|0,ba=ba+7&-8,$[k>>2]=0,k|0))|0,ba=k,l=0,ba=e,l|0):j>>>0>2147418112?(b=f|0,ua(b|0,768,(k=ba,ba=ba+24|0,$[k>>2]=472,$[k+8>>2]=2500,$[k+16>>2]=712,k|0))|0,ba=k,sa(b|0,(k=ba,ba=ba+1|0,ba=ba+7&-8,$[k>>2]=0,k|0))|0,ba=k,l=0,ba=e,l|0):($[g>>2]=j,b=u(a,j,g,1)|0,a=$[g>>2]|0,(b&7|0)!=0&&(g=f|0,ua(g|0,768,(k=ba,ba=ba+24|0,$[k>>2]=472,$[k+8>>2]=2552,$[k+16>>2]=624,k|0))|0,ba=k,sa(g|0,(k=ba,ba=ba+1|0,ba=ba+7&-8,$[k>>2]=0,k|0))|0,ba=k),(b|0)==0?(l=0,ba=e,l|0):($[h>>2]=b,p=a>>>0>j>>>0?(a>>>0)/(d>>>0)|0:n,$[i>>2]=p,l=1,ba=e,l|0))}function t(a){a|=0;var b=0,c=0,d=0,e=0,f=0,g=0,h=0,i=0;if(b=ba,ba=ba+512|0,c=b|0,d=a+3&-4,a=(d|0)==0?4:d,a>>>0>2147418112)return d=c|0,ua(d|0,768,(e=ba,ba=ba+24|0,$[e>>2]=472,$[e+8>>2]=2500,$[e+16>>2]=712,e|0))|0,ba=e,sa(d|0,(e=ba,ba=ba+1|0,ba=ba+7&-8,$[e>>2]=0,e|0))|0,ba=e,f=0,ba=b,f|0;d=J(a)|0;do if((d|0)!=0){if(g=$[d-4>>2]|0,h=g&3,i=(h|0)==1?0:(g&-8)-((h|0)==0?8:4)|0,i>>>0<a>>>0)break;return(d&7|0)==0?(f=d,ba=b,f|0):(h=c|0,ua(h|0,768,(e=ba,ba=ba+24|0,$[e>>2]=472,$[e+8>>2]=2527,$[e+16>>2]=624,e|0))|0,ba=e,sa(h|0,(e=ba,ba=ba+1|0,ba=ba+7&-8,$[e>>2]=0,e|0))|0,ba=e,f=d,ba=b,f|0)}while(0);return d=c|0,ua(d|0,768,(e=ba,ba=ba+24|0,$[e>>2]=472,$[e+8>>2]=2500,$[e+16>>2]=680,e|0))|0,ba=e,sa(d|0,(e=ba,ba=ba+1|0,ba=ba+7&-8,$[e>>2]=0,e|0))|0,ba=e,f=0,ba=b,f|0}function u(a,b,c,d){a|=0,b|=0,c|=0,d|=0;var e=0,f=0,g=0,h=0,i=0,j=0,k=0,l=0;if((a|0)==0){if(e=J(b)|0,(c|0)==0)return f=e,f|0;do if((e|0)==0)g=0;else{if(h=$[e-4>>2]|0,i=h&3,(i|0)==1){g=0;break}g=(h&-8)-((i|0)==0?8:4)|0}while(0);return $[c>>2]=g,f=e,f|0}if((b|0)==0)return K(a),(c|0)==0?(f=0,f|0):($[c>>2]=0,f=0,f|0);if(e=L(a,b)|0,g=(e|0)!=0,g|d^1?(j=g?e:a,k=e):(e=L(a,b)|0,j=(e|0)==0?a:e,k=e),(c|0)==0)return f=k,f|0;do if((j|0)==0)l=0;else{if(e=$[j-4>>2]|0,a=e&3,(a|0)==1){l=0;break}l=(e&-8)-((a|0)==0?8:4)|0}while(0);return $[c>>2]=l,f=k,f|0}function v(a,b,c){a|=0,b|=0,c|=0;var d=0,e=0;(a|0)==0|b>>>0<74|(c|0)==0||($[c>>2]|0)==40&&((_[a]|0)<<8|(_[a+1|0]|0)|0)==18552&&(((_[a+2|0]|0)<<8|(_[a+3|0]|0))>>>0<74||(d=((_[a+7|0]|0)<<16|(_[a+6|0]|0)<<24|(_[a+8|0]|0)<<8|(_[a+9|0]|0))>>>0>b>>>0?0:a,(d|0)!=0&&($[c+4>>2]=(_[d+12|0]|0)<<8|(_[d+13|0]|0),$[c+8>>2]=(_[d+14|0]|0)<<8|(_[d+15|0]|0),$[c+12>>2]=_[d+16|0]|0,$[c+16>>2]=_[d+17|0]|0,a=d+18|0,b=c+32|0,$[b>>2]=_[a]|0,$[b+4>>2]=0,b=Y[a]|0,e=b<<24>>24==0?8:b<<24>>24==9?8:16,$[c+20>>2]=e,$[c+24>>2]=(_[d+26|0]|0)<<16|(_[d+25|0]|0)<<24|(_[d+27|0]|0)<<8|(_[d+28|0]|0),$[c+28>>2]=(_[d+30|0]|0)<<16|(_[d+29|0]|0)<<24|(_[d+31|0]|0)<<8|(_[d+32|0]|0))))}function w(a){a|=0;var b=0,c=0,d=0,e=0,f=0;return b=ba,ba=ba+512|0,c=$[a+20>>2]|0,(c|0)!=0&&x(c),c=a+4|0,d=$[c>>2]|0,(d|0)==0?(e=a+16|0,Y[e]=0,void(ba=b)):((d&7|0)==0?K(d):(d=b|0,ua(d|0,768,(f=ba,ba=ba+24|0,$[f>>2]=472,$[f+8>>2]=2500,$[f+16>>2]=576,f|0))|0,ba=f,sa(d|0,(f=ba,ba=ba+1|0,ba=ba+7&-8,$[f>>2]=0,f|0))|0,ba=f),$[c>>2]=0,$[a+8>>2]=0,$[a+12>>2]=0,e=a+16|0,Y[e]=0,void(ba=b))}function x(a){a|=0;var b=0,c=0,d=0,e=0,f=0,g=0,h=0,i=0,j=0;if(b=ba,ba=ba+1536|0,c=b|0,d=b+512|0,e=b+1024|0,(a|0)==0)return void(ba=b);f=$[a+168>>2]|0;do if((f|0)!=0){if(g=$[f-4>>2]|0,h=f-8|0,(g|0)==0?i=94:(g|0)!=(~$[h>>2]|0)&&(i=94),(i|0)==94&&(g=c|0,ua(g|0,768,(j=ba,ba=ba+24|0,$[j>>2]=472,$[j+8>>2]=645,$[j+16>>2]=280,j|0))|0,ba=j,sa(g|0,(j=ba,ba=ba+1|0,ba=ba+7&-8,$[j>>2]=0,j|0))|0,ba=j,(h|0)==0))break;if((h&7|0)!=0){g=c|0,ua(g|0,768,(j=ba,ba=ba+24|0,$[j>>2]=472,$[j+8>>2]=2500,$[j+16>>2]=576,j|0))|0,ba=j,sa(g|0,(j=ba,ba=ba+1|0,ba=ba+7&-8,$[j>>2]=0,j|0))|0,ba=j;break}if((h|0)==0){J(0)|0;break}K(h);break}while(0);c=$[a+176>>2]|0;do if((c|0)!=0){if(f=$[c-4>>2]|0,h=c-8|0,(f|0)==0?i=103:(f|0)!=(~$[h>>2]|0)&&(i=103),(i|0)==103&&(f=e|0,ua(f|0,768,(j=ba,ba=ba+24|0,$[j>>2]=472,$[j+8>>2]=645,$[j+16>>2]=280,j|0))|0,ba=j,sa(f|0,(j=ba,ba=ba+1|0,ba=ba+7&-8,$[j>>2]=0,j|0))|0,ba=j,(h|0)==0))break;if((h&7|0)!=0){f=e|0,ua(f|0,768,(j=ba,ba=ba+24|0,$[j>>2]=472,$[j+8>>2]=2500,$[j+16>>2]=576,j|0))|0,ba=j,sa(f|0,(j=ba,ba=ba+1|0,ba=ba+7&-8,$[j>>2]=0,j|0))|0,ba=j;break}if((h|0)==0){J(0)|0;break}K(h);break}while(0);return(a&7|0)==0?(K(a),void(ba=b)):(a=d|0,ua(a|0,768,(j=ba,ba=ba+24|0,$[j>>2]=472,$[j+8>>2]=2500,$[j+16>>2]=576,j|0))|0,ba=j,sa(a|0,(j=ba,ba=ba+1|0,ba=ba+7&-8,$[j>>2]=0,j|0))|0,ba=j,void(ba=b))}function y(a){a|=0;var b=0,c=0,d=0,e=0,f=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,u=0,v=0,w=0,x=0,y=0,z=0,A=0,B=0,C=0,D=0,E=0,F=0,G=0,H=0,I=0,L=0,M=0,N=0,P=0;if(b=ba,ba=ba+1232|0,c=b|0,d=b+512|0,e=b+576|0,f=b+648|0,g=b+720|0,h=a+8|0,i=$[h>>2]|0,(i|0)!=0&i>>>0<8193||(j=g|0,ua(j|0,768,(k=ba,ba=ba+24|0,$[k>>2]=472,$[k+8>>2]=2998,$[k+16>>2]=496,k|0))|0,ba=k,sa(j|0,(k=ba,ba=ba+1|0,ba=ba+7&-8,$[k>>2]=0,k|0))|0,ba=k),j=a|0,$[j>>2]=i,l=a+20|0,m=$[l>>2]|0,(m|0)==0?(n=t(180)|0,(n|0)==0?o=0:(O(n+164|0,0,16),o=n),$[l>>2]=o,p=o,q=$[j>>2]|0):(p=m,q=i),($[h>>2]|0)==0?(h=g|0,ua(h|0,768,(k=ba,ba=ba+24|0,$[k>>2]=472,$[k+8>>2]=904,$[k+16>>2]=312,k|0))|0,ba=k,sa(h|0,(k=ba,ba=ba+1|0,ba=ba+7&-8,$[k>>2]=0,k|0))|0,ba=k,r=$[j>>2]|0):r=q,j=$[a+4>>2]|0,r>>>0>16){for(a=r,h=0;;){if(s=h+1|0,!(a>>>0>3))break;a>>>=1,h=s}a=h+2+((s|0)!=32&1<<s>>>0<r>>>0&1)|0,u=a>>>0<11?a&255:11}else u=0;if((q|0)==0|u>>>0>11)return v=0,ba=b,v|0;for($[p>>2]=q,O(e|0,0,68),a=0;;){if(r=Y[j+a|0]|0,r<<24>>24!=0&&(s=e+((r&255)<<2)|0,$[s>>2]=($[s>>2]|0)+1),s=a+1|0,!(s>>>0<q>>>0)){w=1,x=-1,y=0,z=0,A=0;break}a=s}for(;;){if(a=$[e+(w<<2)>>2]|0,(a|0)==0?($[p+28+(w-1<<2)>>2]=0,B=A,C=z,D=y,E=x):(s=w-1|0,$[d+(s<<2)>>2]=A,r=a+A|0,h=16-w|0,$[p+28+(s<<2)>>2]=(r-1<<h|(1<<h)-1)+1,$[p+96+(s<<2)>>2]=z,$[f+(w<<2)>>2]=z,B=r,C=a+z|0,D=y>>>0>w>>>0?y:w,E=x>>>0<w>>>0?x:w),a=w+1|0,!(a>>>0<17))break;w=a,x=E,y=D,z=C,A=B<<1}$[p+4>>2]=C,B=p+172|0;do{if(C>>>0>($[B>>2]|0)>>>0){$[B>>2]=C,A=C-1|0,(C|0)==0?F=140:(A&C|0)!=0&&(F=140),(F|0)==140&&(z=A>>>16|A,A=z>>>8|z,z=A>>>4|A,A=z>>>2|z,z=(A>>>1|A)+1|0,$[B>>2]=z>>>0>q>>>0?q:z),z=p+176|0,A=$[z>>2]|0;do if((A|0)!=0){if(y=$[A-4>>2]|0,x=A-8|0,(y|0)==0?F=144:(y|0)!=(~$[x>>2]|0)&&(F=144),(F|0)==144&&(y=c|0,ua(y|0,768,(k=ba,ba=ba+24|0,$[k>>2]=472,$[k+8>>2]=645,$[k+16>>2]=280,k|0))|0,ba=k,sa(y|0,(k=ba,ba=ba+1|0,ba=ba+7&-8,$[k>>2]=0,k|0))|0,ba=k,(x|0)==0))break;if((x&7|0)!=0){y=c|0,ua(y|0,768,(k=ba,ba=ba+24|0,$[k>>2]=472,$[k+8>>2]=2500,$[k+16>>2]=576,k|0))|0,ba=k,sa(y|0,(k=ba,ba=ba+1|0,ba=ba+7&-8,$[k>>2]=0,k|0))|0,ba=k;break}if((x|0)==0){J(0)|0;break}K(x);break}while(0);if(A=$[B>>2]|0,x=(A|0)==0?1:A,A=t((x<<1)+8|0)|0,(A|0)==0)return $[z>>2]=0,v=0,ba=b,v|0;if(y=A+8|0,$[A+4>>2]=x,$[A>>2]=~x,$[z>>2]=y,(y|0)!=0){G=z;break}return v=0,ba=b,v|0}G=p+176|0}while(0);B=p+24|0,Y[B]=E&255,Y[p+25|0]=D&255,E=c|0,c=0;do y=Y[j+c|0]|0,x=y&255,y<<24>>24!=0&&(($[e+(x<<2)>>2]|0)==0&&(ua(E|0,768,(k=ba,ba=ba+24|0,$[k>>2]=472,$[k+8>>2]=2274,$[k+16>>2]=136,k|0))|0,ba=k,sa(E|0,(k=ba,ba=ba+1|0,ba=ba+7&-8,$[k>>2]=0,k|0))|0,ba=k),y=f+(x<<2)|0,x=$[y>>2]|0,$[y>>2]=x+1,x>>>0>=C>>>0&&(ua(E|0,768,(k=ba,ba=ba+24|0,$[k>>2]=472,$[k+8>>2]=2278,$[k+16>>2]=104,k|0))|0,ba=k,sa(E|0,(k=ba,ba=ba+1|0,ba=ba+7&-8,$[k>>2]=0,k|0))|0,ba=k),Z[($[G>>2]|0)+(x<<1)>>1]=c&65535),c=c+1|0;while(c>>>0<q>>>0);if(q=Y[B]|0,c=(q&255)>>>0<u>>>0?u:0,u=p+8|0,$[u>>2]=c,C=(c|0)!=0){f=1<<c,x=p+164|0;do{if(f>>>0>($[x>>2]|0)>>>0){$[x>>2]=f,y=p+168|0,A=$[y>>2]|0;do if((A|0)!=0){if(w=$[A-4>>2]|0,a=A-8|0,(w|0)==0?F=169:(w|0)!=(~$[a>>2]|0)&&(F=169),(F|0)==169&&(ua(E|0,768,(k=ba,ba=ba+24|0,$[k>>2]=472,$[k+8>>2]=645,$[k+16>>2]=280,k|0))|0,ba=k,sa(E|0,(k=ba,ba=ba+1|0,ba=ba+7&-8,$[k>>2]=0,k|0))|0,ba=k,(a|0)==0))break;if((a&7|0)!=0){ua(E|0,768,(k=ba,ba=ba+24|0,$[k>>2]=472,$[k+8>>2]=2500,$[k+16>>2]=576,k|0))|0,ba=k,sa(E|0,(k=ba,ba=ba+1|0,ba=ba+7&-8,$[k>>2]=0,k|0))|0,ba=k;break}if((a|0)==0){J(0)|0;break}K(a);break}while(0);if(A=f<<2,z=t(A+8|0)|0,(z|0)==0)return $[y>>2]=0,v=0,ba=b,v|0;if(a=z+8|0,w=a,$[z+4>>2]=f,$[z>>2]=~f,$[y>>2]=w,(a|0)!=0){H=w,I=A;break}return v=0,ba=b,v|0}H=$[p+168>>2]|0,I=f<<2}while(0);F=p+168|0,O(H|0,-1,I|0),I=1;do{do if(($[e+(I<<2)>>2]|0)!=0){if(H=c-I|0,x=1<<H,A=I-1|0,w=$[d+(A<<2)>>2]|0,(I|0)!=0&I>>>0<17||(ua(E|0,768,(k=ba,ba=ba+24|0,$[k>>2]=472,$[k+8>>2]=1954,$[k+16>>2]=200,k|0))|0,ba=k,sa(E|0,(k=ba,ba=ba+1|0,ba=ba+7&-8,$[k>>2]=0,k|0))|0,ba=k),a=$[p+28+(A<<2)>>2]|0,L=(a|0)==0?-1:(a-1|0)>>>((16-I|0)>>>0),w>>>0>L>>>0)break;a=($[p+96+(A<<2)>>2]|0)-w|0,A=I<<16,z=w;do{w=aa[($[G>>2]|0)+(a+z<<1)>>1]|0,(_[j+w|0]|0|0)!=(I|0)&&(ua(E|0,768,(k=ba,ba=ba+24|0,$[k>>2]=472,$[k+8>>2]=2320,$[k+16>>2]=64,k|0))|0,ba=k,sa(E|0,(k=ba,ba=ba+1|0,ba=ba+7&-8,$[k>>2]=0,k|0))|0,ba=k),r=z<<H,s=w|A,w=0;do h=w+r|0,h>>>0>=f>>>0&&(ua(E|0,768,(k=ba,ba=ba+24|0,$[k>>2]=472,$[k+8>>2]=2326,$[k+16>>2]=40,k|0))|0,ba=k,sa(E|0,(k=ba,ba=ba+1|0,ba=ba+7&-8,$[k>>2]=0,k|0))|0,ba=k),g=$[F>>2]|0,($[g+(h<<2)>>2]|0)==-1?M=g:(ua(E|0,768,(k=ba,ba=ba+24|0,$[k>>2]=472,$[k+8>>2]=2328,$[k+16>>2]=8,k|0))|0,ba=k,sa(E|0,(k=ba,ba=ba+1|0,ba=ba+7&-8,$[k>>2]=0,k|0))|0,ba=k,M=$[F>>2]|0),$[M+(h<<2)>>2]=s,w=w+1|0;while(w>>>0<x>>>0);z=z+1|0}while(z>>>0<=L>>>0)}while(0);I=I+1|0}while(I>>>0<=c>>>0);N=Y[B]|0}else N=q;q=p+96|0,$[q>>2]=($[q>>2]|0)-($[d>>2]|0),q=p+100|0,$[q>>2]=($[q>>2]|0)-($[d+4>>2]|0),q=p+104|0,$[q>>2]=($[q>>2]|0)-($[d+8>>2]|0),q=p+108|0,$[q>>2]=($[q>>2]|0)-($[d+12>>2]|0),q=p+112|0,$[q>>2]=($[q>>2]|0)-($[d+16>>2]|0),q=p+116|0,$[q>>2]=($[q>>2]|0)-($[d+20>>2]|0),q=p+120|0,$[q>>2]=($[q>>2]|0)-($[d+24>>2]|0),q=p+124|0,$[q>>2]=($[q>>2]|0)-($[d+28>>2]|0),q=p+128|0,$[q>>2]=($[q>>2]|0)-($[d+32>>2]|0),q=p+132|0,$[q>>2]=($[q>>2]|0)-($[d+36>>2]|0),q=p+136|0,$[q>>2]=($[q>>2]|0)-($[d+40>>2]|0),q=p+140|0,$[q>>2]=($[q>>2]|0)-($[d+44>>2]|0),q=p+144|0,$[q>>2]=($[q>>2]|0)-($[d+48>>2]|0),q=p+148|0,$[q>>2]=($[q>>2]|0)-($[d+52>>2]|0),q=p+152|0,$[q>>2]=($[q>>2]|0)-($[d+56>>2]|0),q=p+156|0,$[q>>2]=($[q>>2]|0)-($[d+60>>2]|0),d=p+16|0,$[d>>2]=0,q=p+20|0,$[q>>2]=N&255;a:do if(C){for(N=c;;){if((N|0)==0)break a;if(P=N-1|0,($[e+(N<<2)>>2]|0)!=0)break;N=P}for($[d>>2]=$[p+28+(P<<2)>>2],N=c+1|0,$[q>>2]=N,B=N;;){if(B>>>0>D>>>0)break a;if(($[e+(B<<2)>>2]|0)!=0)break;B=B+1|0}$[q>>2]=B}while(0);return $[p+92>>2]=-1,$[p+160>>2]=1048575,$[p+12>>2]=32-($[u>>2]|0),v=1,ba=b,v|0}function z(a,b){a|=0,b|=0;var c=0,d=0,e=0,f=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,t=0,u=0,v=0,z=0,B=0,C=0,D=0,E=0,F=0,G=0,H=0,I=0,J=0,L=0,M=0,N=0,P=0,Q=0,R=0,S=0,T=0,U=0,V=0,W=0,X=0,Z=0,aa=0,ca=0,da=0,ea=0,fa=0,ga=0,ha=0,ia=0,ja=0,ka=0,la=0,ma=0,na=0,oa=0,pa=0,qa=0;if(c=ba,ba=ba+4120|0,d=c+512|0,e=c+1024|0,f=c+1536|0,g=c+2048|0,h=c+2560|0,i=c+3072|0,j=c+3584|0,k=c+4096|0,l=a+20|0,m=$[l>>2]|0,(m|0)<14)for(n=a+4|0,o=a+8|0,p=a+16|0,q=c|0,r=m;;){if(t=$[n>>2]|0,(t|0)==($[o>>2]|0)?u=0:($[n>>2]=t+1,u=_[t]|0),t=r+8|0,$[l>>2]=t,(t|0)<33?v=t:(ua(q|0,768,(z=ba,ba=ba+24|0,$[z>>2]=472,$[z+8>>2]=3200,$[z+16>>2]=432,z|0))|0,ba=z,sa(q|0,(z=ba,ba=ba+1|0,ba=ba+7&-8,$[z>>2]=0,z|0))|0,ba=z,v=$[l>>2]|0),t=u<<32-v|$[p>>2],$[p>>2]=t,!((v|0)<14)){B=v,C=t;break}r=v}else B=m,C=$[a+16>>2]|0;if(m=a+16|0,v=C>>>18,$[m>>2]=C<<14,$[l>>2]=B-14,(v|0)==0)return $[b>>2]=0,B=b+4|0,C=$[B>>2]|0,(C|0)!=0&&((C&7|0)==0?K(C):(C=j|0,ua(C|0,768,(z=ba,ba=ba+24|0,$[z>>2]=472,$[z+8>>2]=2500,$[z+16>>2]=576,z|0))|0,ba=z,sa(C|0,(z=ba,ba=ba+1|0,ba=ba+7&-8,$[z>>2]=0,z|0))|0,ba=z),$[B>>2]=0,$[b+8>>2]=0,$[b+12>>2]=0),Y[b+16|0]=0,B=b+20|0,C=$[B>>2]|0,(C|0)==0?(D=1,ba=c,D|0):(x(C),$[B>>2]=0,D=1,ba=c,D|0);if(B=b+4|0,C=b+8|0,r=$[C>>2]|0,(r|0)!=(v|0)){if(r>>>0<=v>>>0){do{if(($[b+12>>2]|0)>>>0<v>>>0){if(s(B,v,(r+1|0)==(v|0),1)|0){E=$[C>>2]|0;break}return Y[b+16|0]=1,D=0,ba=c,D|0}E=r}while(0);O(($[B>>2]|0)+E|0,0,v-E|0)}$[C>>2]=v}if(E=B|0,O($[E>>2]|0,0,v|0),B=$[l>>2]|0,(B|0)<5)for(r=a+4|0,p=a+8|0,u=i|0,i=B;;){if(q=$[r>>2]|0,(q|0)==($[p>>2]|0)?F=0:($[r>>2]=q+1,F=_[q]|0),q=i+8|0,$[l>>2]=q,(q|0)<33?G=q:(ua(u|0,768,(z=ba,ba=ba+24|0,$[z>>2]=472,$[z+8>>2]=3200,$[z+16>>2]=432,z|0))|0,ba=z,sa(u|0,(z=ba,ba=ba+1|0,ba=ba+7&-8,$[z>>2]=0,z|0))|0,ba=z,G=$[l>>2]|0),q=F<<32-G|$[m>>2],$[m>>2]=q,!((G|0)<5)){H=G,I=q;break}i=G}else H=B,I=$[m>>2]|0;if(B=I>>>27,$[m>>2]=I<<5,$[l>>2]=H-5,(B|0)==0|I>>>0>2952790015)return D=0,ba=c,D|0;$[k+20>>2]=0,O(k|0,0,17),I=k+4|0,H=k+8|0;a:do if(s(I,21,0,1)|0){G=$[H>>2]|0,i=$[I>>2]|0,O(i+G|0,0,21-G|0),$[H>>2]=21,G=a+4|0,F=a+8|0,u=h|0,r=0;do{if(p=$[l>>2]|0,(p|0)<3)for(q=p;;){if(n=$[G>>2]|0,(n|0)==($[F>>2]|0)?J=0:($[G>>2]=n+1,J=_[n]|0),n=q+8|0,$[l>>2]=n,(n|0)<33?L=n:(ua(u|0,768,(z=ba,ba=ba+24|0,$[z>>2]=472,$[z+8>>2]=3200,$[z+16>>2]=432,z|0))|0,ba=z,sa(u|0,(z=ba,ba=ba+1|0,ba=ba+7&-8,$[z>>2]=0,z|0))|0,ba=z,L=$[l>>2]|0),n=J<<32-L|$[m>>2],$[m>>2]=n,!((L|0)<3)){M=L,N=n;break}q=L}else M=p,N=$[m>>2]|0;$[m>>2]=N<<3,$[l>>2]=M-3,Y[i+(_[808+r|0]|0)|0]=N>>>29&255,r=r+1|0}while(r>>>0<B>>>0);if(!(y(k)|0)){P=0;break}r=j|0,i=e|0,u=d|0,q=g|0,n=f|0,o=0;b:for(;;){t=v-o|0,Q=A(a,k)|0;do if(Q>>>0<17)($[C>>2]|0)>>>0<=o>>>0&&(ua(r|0,768,(z=ba,ba=ba+24|0,$[z>>2]=472,$[z+8>>2]=904,$[z+16>>2]=312,z|0))|0,ba=z,sa(r|0,(z=ba,ba=ba+1|0,ba=ba+7&-8,$[z>>2]=0,z|0))|0,ba=z),Y[($[E>>2]|0)+o|0]=Q&255,R=o+1|0;else{if((Q|0)==18){if(S=$[l>>2]|0,(S|0)<7)for(T=S;;){if(U=$[G>>2]|0,(U|0)==($[F>>2]|0)?V=0:($[G>>2]=U+1,V=_[U]|0),U=T+8|0,$[l>>2]=U,(U|0)<33?W=U:(ua(n|0,768,(z=ba,ba=ba+24|0,$[z>>2]=472,$[z+8>>2]=3200,$[z+16>>2]=432,z|0))|0,ba=z,sa(n|0,(z=ba,ba=ba+1|0,ba=ba+7&-8,$[z>>2]=0,z|0))|0,ba=z,W=$[l>>2]|0),U=V<<32-W|$[m>>2],$[m>>2]=U,!((W|0)<7)){X=W,Z=U;break}T=W}else X=S,Z=$[m>>2]|0;if($[m>>2]=Z<<7,$[l>>2]=X-7,T=(Z>>>25)+11|0,T>>>0>t>>>0){P=0;break a}R=T+o|0;break}if((Q|0)==17){if(T=$[l>>2]|0,(T|0)<3)for(U=T;;){if(aa=$[G>>2]|0,(aa|0)==($[F>>2]|0)?ca=0:($[G>>2]=aa+1,ca=_[aa]|0),aa=U+8|0,$[l>>2]=aa,(aa|0)<33?da=aa:(ua(q|0,768,(z=ba,ba=ba+24|0,$[z>>2]=472,$[z+8>>2]=3200,$[z+16>>2]=432,z|0))|0,ba=z,sa(q|0,(z=ba,ba=ba+1|0,ba=ba+7&-8,$[z>>2]=0,z|0))|0,ba=z,da=$[l>>2]|0),aa=ca<<32-da|$[m>>2],$[m>>2]=aa,!((da|0)<3)){ea=da,fa=aa;break}U=da}else ea=T,fa=$[m>>2]|0;if($[m>>2]=fa<<3,$[l>>2]=ea-3,U=(fa>>>29)+3|0,U>>>0>t>>>0){P=0;break a}R=U+o|0;break}if((Q-19|0)>>>0>=2){ga=306;break b}if(U=$[l>>2]|0,(Q|0)==19){if((U|0)<2)for(S=U;;){if(aa=$[G>>2]|0,(aa|0)==($[F>>2]|0)?ha=0:($[G>>2]=aa+1,ha=_[aa]|0),aa=S+8|0,$[l>>2]=aa,(aa|0)<33?ia=aa:(ua(i|0,768,(z=ba,ba=ba+24|0,$[z>>2]=472,$[z+8>>2]=3200,$[z+16>>2]=432,z|0))|0,ba=z,sa(i|0,(z=ba,ba=ba+1|0,ba=ba+7&-8,$[z>>2]=0,z|0))|0,ba=z,ia=$[l>>2]|0),aa=ha<<32-ia|$[m>>2],$[m>>2]=aa,!((ia|0)<2)){ja=ia,ka=aa;break}S=ia}else ja=U,ka=$[m>>2]|0;$[m>>2]=ka<<2,$[l>>2]=ja-2,la=(ka>>>30)+3|0}else{if((U|0)<6)for(S=U;;){if(T=$[G>>2]|0,(T|0)==($[F>>2]|0)?ma=0:($[G>>2]=T+1,ma=_[T]|0),T=S+8|0,$[l>>2]=T,(T|0)<33?na=T:(ua(u|0,768,(z=ba,ba=ba+24|0,$[z>>2]=472,$[z+8>>2]=3200,$[z+16>>2]=432,z|0))|0,ba=z,sa(u|0,(z=ba,ba=ba+1|0,ba=ba+7&-8,$[z>>2]=0,z|0))|0,ba=z,na=$[l>>2]|0),T=ma<<32-na|$[m>>2],$[m>>2]=T,!((na|0)<6)){oa=na,pa=T;break}S=na}else oa=U,pa=$[m>>2]|0;$[m>>2]=pa<<6,$[l>>2]=oa-6,la=(pa>>>26)+7|0}if((o|0)==0|la>>>0>t>>>0){P=0;break a}if(S=o-1|0,($[C>>2]|0)>>>0<=S>>>0&&(ua(r|0,768,(z=ba,ba=ba+24|0,$[z>>2]=472,$[z+8>>2]=904,$[z+16>>2]=312,z|0))|0,ba=z,sa(r|0,(z=ba,ba=ba+1|0,ba=ba+7&-8,$[z>>2]=0,z|0))|0,ba=z),T=Y[($[E>>2]|0)+S|0]|0,T<<24>>24==0){P=0;break a}if(S=la+o|0,!(o>>>0<S>>>0)){R=o;break}for(qa=o;;){if(($[C>>2]|0)>>>0<=qa>>>0&&(ua(r|0,768,(z=ba,ba=ba+24|0,$[z>>2]=472,$[z+8>>2]=904,$[z+16>>2]=312,z|0))|0,ba=z,sa(r|0,(z=ba,ba=ba+1|0,ba=ba+7&-8,$[z>>2]=0,z|0))|0,ba=z),aa=qa+1|0,Y[($[E>>2]|0)+qa|0]=T,!(aa>>>0<S>>>0)){R=S;break}qa=aa}}while(0);if(!(R>>>0<v>>>0))break;o=R}if((ga|0)==306){ua(r|0,768,(z=ba,ba=ba+24|0,$[z>>2]=472,$[z+8>>2]=3141,$[z+16>>2]=464,z|0))|0,ba=z,sa(r|0,(z=ba,ba=ba+1|0,ba=ba+7&-8,$[z>>2]=0,z|0))|0,ba=z,P=0;break}if((R|0)!=(v|0)){P=0;break}P=y(b)|0}else Y[k+16|0]=1,P=0;while(0);return w(k),D=P,ba=c,D|0}function A(a,b){a|=0,b|=0;var c=0,d=0,e=0,f=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0,x=0;c=ba,ba=ba+512|0,d=c|0,e=$[b+20>>2]|0,f=a+20|0,g=$[f>>2]|0;do if((g|0)<24){if(h=a+4|0,i=$[h>>2]|0,j=$[a+8>>2]|0,k=i>>>0<j>>>0,(g|0)>=16){k?($[h>>2]=i+1,l=_[i]|0):l=0,$[f>>2]=g+8,m=a+16|0,n=l<<24-g|$[m>>2],$[m>>2]=n,o=n;break}k?(p=(_[i]|0)<<8,q=i+1|0):(p=0,q=i),q>>>0<j>>>0?(r=_[q]|0,s=q+1|0):(r=0,s=q),$[h>>2]=s,$[f>>2]=g+16,h=a+16|0,j=(r|p)<<16-g|$[h>>2],$[h>>2]=j,o=j}else o=$[a+16>>2]|0;while(0);
g=a+16|0,a=(o>>>16)+1|0;do{if(a>>>0>($[e+16>>2]|0)>>>0){for(p=$[e+20>>2]|0;;){if(t=p-1|0,!(a>>>0>($[e+28+(t<<2)>>2]|0)>>>0))break;p=p+1|0}if(r=($[e+96+(t<<2)>>2]|0)+(o>>>((32-p|0)>>>0))|0,r>>>0<($[b>>2]|0)>>>0){u=p,v=aa[($[e+176>>2]|0)+(r<<1)>>1]|0;break}return r=d|0,ua(r|0,768,(w=ba,ba=ba+24|0,$[w>>2]=472,$[w+8>>2]=3267,$[w+16>>2]=464,w|0))|0,ba=w,sa(r|0,(w=ba,ba=ba+1|0,ba=ba+7&-8,$[w>>2]=0,w|0))|0,ba=w,x=0,ba=c,x|0}if(r=$[($[e+168>>2]|0)+(o>>>((32-($[e+8>>2]|0)|0)>>>0)<<2)>>2]|0,(r|0)==-1&&(s=d|0,ua(s|0,768,(w=ba,ba=ba+24|0,$[w>>2]=472,$[w+8>>2]=3245,$[w+16>>2]=408,w|0))|0,ba=w,sa(s|0,(w=ba,ba=ba+1|0,ba=ba+7&-8,$[w>>2]=0,w|0))|0,ba=w),s=r&65535,q=r>>>16,($[b+8>>2]|0)>>>0<=s>>>0&&(r=d|0,ua(r|0,768,(w=ba,ba=ba+24|0,$[w>>2]=472,$[w+8>>2]=903,$[w+16>>2]=312,w|0))|0,ba=w,sa(r|0,(w=ba,ba=ba+1|0,ba=ba+7&-8,$[w>>2]=0,w|0))|0,ba=w),(_[($[b+4>>2]|0)+s|0]|0|0)==(q|0)){u=q,v=s;break}r=d|0,ua(r|0,768,(w=ba,ba=ba+24|0,$[w>>2]=472,$[w+8>>2]=3249,$[w+16>>2]=376,w|0))|0,ba=w,sa(r|0,(w=ba,ba=ba+1|0,ba=ba+7&-8,$[w>>2]=0,w|0))|0,ba=w,u=q,v=s}while(0);return $[g>>2]=$[g>>2]<<u,$[f>>2]=($[f>>2]|0)-u,x=v,ba=c,x|0}function B(a,b){a|=0,b|=0;var c=0,d=0;return c=ba,ba=ba+40|0,d=c|0,$[d>>2]=40,v(a,b,d),ba=c,$[d+4>>2]|0}function C(a,b){a|=0,b|=0;var c=0,d=0;return c=ba,ba=ba+40|0,d=c|0,$[d>>2]=40,v(a,b,d),ba=c,$[d+8>>2]|0}function D(a,b){a|=0,b|=0;var c=0,d=0;return c=ba,ba=ba+40|0,d=c|0,$[d>>2]=40,v(a,b,d),ba=c,$[d+12>>2]|0}function E(a,b){a|=0,b|=0;var c=0,d=0;return c=ba,ba=ba+40|0,d=c|0,$[d>>2]=40,v(a,b,d),ba=c,$[d+32>>2]|0}function F(a,b){a|=0,b|=0;var c=0,d=0,e=0,f=0,g=0,h=0,i=0;return c=ba,ba=ba+552|0,d=c|0,e=c+512|0,$[e>>2]=40,v(a,b,e),b=e+32|0,e=$[b>>2]|0,a=$[b+4>>2]|0,b=9,f=0,g=0,h=0,(e|0)==1&(a|0)==0|(e|0)==2&(a|0)==0|(e|0)==7&(a|0)==0|(e|0)==8&(a|0)==0|(e|0)==3&(a|0)==0|(e|0)==4&(a|0)==0|(e|0)==5&(a|0)==0|(e|0)==6&(a|0)==0?(i=16,ba=c,i|0):(e|0)==(g|0)&(a|0)==(h|0)|(e|0)==(b|0)&(a|0)==(f|0)?(i=8,ba=c,i|0):(f=d|0,ua(f|0,768,(d=ba,ba=ba+24|0,$[d>>2]=472,$[d+8>>2]=2664,$[d+16>>2]=568,d|0))|0,ba=d,sa(f|0,(d=ba,ba=ba+1|0,ba=ba+7&-8,$[d>>2]=0,d|0))|0,ba=d,i=0,ba=c,i|0)}function G(a,b,c){a|=0,b|=0,c|=0;var d=0,e=0,f=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0;return d=ba,ba=ba+552|0,e=d|0,f=d+512|0,$[f>>2]=40,v(a,b,f),b=((($[f+4>>2]|0)>>>(c>>>0))+3|0)>>>2,a=((($[f+8>>2]|0)>>>(c>>>0))+3|0)>>>2,c=f+32|0,f=$[c>>2]|0,g=$[c+4>>2]|0,c=9,h=0,i=0,j=0,(f|0)==1&(g|0)==0|(f|0)==2&(g|0)==0|(f|0)==7&(g|0)==0|(f|0)==8&(g|0)==0|(f|0)==3&(g|0)==0|(f|0)==4&(g|0)==0|(f|0)==5&(g|0)==0|(f|0)==6&(g|0)==0?(k=16,l=pa(a,b)|0,m=pa(l,k)|0,ba=d,m|0):(f|0)==(i|0)&(g|0)==(j|0)|(f|0)==(c|0)&(g|0)==(h|0)?(k=8,l=pa(a,b)|0,m=pa(l,k)|0,ba=d,m|0):(h=e|0,ua(h|0,768,(e=ba,ba=ba+24|0,$[e>>2]=472,$[e+8>>2]=2664,$[e+16>>2]=568,e|0))|0,ba=e,sa(h|0,(e=ba,ba=ba+1|0,ba=ba+7&-8,$[e>>2]=0,e|0))|0,ba=e,k=0,l=pa(a,b)|0,m=pa(l,k)|0,ba=d,m|0)}function H(a,b,c,d,e,f){a|=0,b|=0,c|=0,d|=0,e|=0,f|=0;var g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,u=0,x=0,y=0,B=0,C=0,D=0,E=0,F=0,G=0,H=0,J=0,L=0,M=0,N=0,P=0,Q=0,R=0,S=0,T=0,U=0,V=0,W=0,X=0,ca=0,da=0,ea=0,fa=0,ga=0,ha=0,ia=0,ja=0,ka=0,la=0,ma=0,na=0,oa=0,qa=0,ra=0,ta=0,va=0,wa=0,xa=0,ya=0,za=0,Aa=0,Ba=0,Ca=0,Da=0,Ea=0,Fa=0,Ga=0,Ha=0,Ia=0,Ja=0,Ka=0,La=0,Ma=0,Na=0,Oa=0,Pa=0,Qa=0,Ra=0,Sa=0,Ta=0,Ua=0,Va=0,Wa=0,Xa=0,Ya=0,Za=0,$a=0,_a=0,ab=0,bb=0,cb=0,db=0,eb=0,fb=0,gb=0,hb=0,ib=0,jb=0,kb=0,lb=0,mb=0,nb=0,ob=0,pb=0,qb=0,rb=0,sb=0,tb=0,ub=0,vb=0,wb=0,xb=0,yb=0,zb=0,Ab=0,Bb=0,Cb=0,Db=0,Eb=0,Fb=0,Gb=0,Hb=0,Ib=0,Jb=0,Kb=0,Lb=0,Mb=0,Nb=0,Ob=0,Pb=0,Qb=0,Rb=0,Sb=0,Tb=0,Ub=0,Vb=0,Wb=0,Xb=0,Yb=0,Zb=0,$b=0,_b=0,ac=0,bc=0,cc=0,dc=0,ec=0,fc=0,gc=0,hc=0,ic=0,jc=0,kc=0,lc=0,mc=0,nc=0,oc=0,pc=0,qc=0,rc=0,sc=0,tc=0,uc=0,vc=0,wc=0,xc=0,yc=0,zc=0,Ac=0,Bc=0,Cc=0,Dc=0,Ec=0,Fc=0,Gc=0,Hc=0,Ic=0,Jc=0,Kc=0,Lc=0,Mc=0;d=ba,ba=ba+4008|0,g=d|0,h=d+16|0,i=d+32|0,j=d+56|0,k=d+960|0,l=d+1864|0,m=d+1888|0,n=d+1912|0,o=d+2112|0,p=d+2312|0,q=d+2376|0,r=d+2888|0,u=d+2936|0,x=d+3448|0,y=d+3960|0,B=d+4e3|0,$[y>>2]=40,v(a,b,y),C=($[y+4>>2]|0)>>>(e>>>0),D=($[y+8>>2]|0)>>>(e>>>0),E=y+32|0,y=$[E>>2]|0,F=$[E+4>>2]|0,E=9,G=0,H=0,J=0,(y|0)==1&(F|0)==0|(y|0)==2&(F|0)==0|(y|0)==7&(F|0)==0|(y|0)==8&(F|0)==0|(y|0)==3&(F|0)==0|(y|0)==4&(F|0)==0|(y|0)==5&(F|0)==0|(y|0)==6&(F|0)==0?L=16:(y|0)==(H|0)&(F|0)==(J|0)|(y|0)==(E|0)&(F|0)==(G|0)?L=8:(G=x|0,ua(G|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=2664,$[M+16>>2]=568,M|0))|0,ba=M,sa(G|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M,L=0),G=B|0,$[G>>2]=c;a:do{if(!((a|0)==0|b>>>0<62)){if(F=t(300)|0,(F|0)==0){N=0;break}E=F,$[F>>2]=519686845,y=F+4|0,$[y>>2]=0,J=F+8|0,$[J>>2]=0,H=F+88|0,O(H|0,0,45),P=F+252|0,O(P|0,0,13),Q=F+268|0,O(Q|0,0,13),R=F+284|0,O(R|0,0,13),O(F+136|0,0,21),O(F+160|0,0,21),O(F+184|0,0,21),O(F+208|0,0,21),O(F+232|0,0,17);b:do if(b>>>0<74)S=369;else{if(((_[a]|0)<<8|(_[a+1|0]|0)|0)!=18552){S=369;break}if(((_[a+2|0]|0)<<8|(_[a+3|0]|0))>>>0<74){S=369;break}if(T=((_[a+7|0]|0)<<16|(_[a+6|0]|0)<<24|(_[a+8|0]|0)<<8|(_[a+9|0]|0))>>>0>b>>>0?0:a,U=H,$[U>>2]=T,(T|0)==0)break;if($[y>>2]=a,$[J>>2]=b,V=F+92|0,W=V,X=(_[T+68|0]|0)<<8|(_[T+67|0]|0)<<16|(_[T+69|0]|0),ca=a+X|0,da=(_[T+65|0]|0)<<8|(_[T+66|0]|0),(da|0)==0)break;if(T=V,$[T>>2]=ca,V=F+96|0,$[V>>2]=ca,ca=F+104|0,$[ca>>2]=da,ea=F+100|0,$[ea>>2]=a+(da+X),X=F+108|0,$[X>>2]=0,da=F+112|0,$[da>>2]=0,!(z(W,F+116|0)|0))break;if(fa=$[U>>2]|0,((_[fa+39|0]|0)<<8|(_[fa+40|0]|0)|0)==0){if(ga=Y[fa+55|0]|0,ha=Y[fa+56|0]|0,((ga&255)<<8|ha&255|0)==0)break;ia=ga,ja=ha,ka=fa}else{if(!(z(W,F+140|0)|0))break;if(!(z(W,F+188|0)|0))break;fa=$[U>>2]|0,ia=Y[fa+55|0]|0,ja=Y[fa+56|0]|0,ka=fa}if(((ia&255)<<8|ja&255|0)==0)la=ka;else{if(!(z(W,F+164|0)|0))break;if(!(z(W,F+212|0)|0))break;la=$[U>>2]|0}if(fa=(_[la+39|0]|0)<<8|(_[la+40|0]|0),(fa|0)==0)ma=la;else{if(ha=r,ga=F+236|0,na=F+240|0,oa=$[na>>2]|0,(oa|0)==(fa|0))qa=la;else{if(oa>>>0>fa>>>0)ra=la;else{do{if(($[F+244>>2]|0)>>>0<fa>>>0){if(s(ga,fa,(oa+1|0)==(fa|0),4)|0){ta=$[na>>2]|0;break}Y[F+248|0]=1;break b}ta=oa}while(0);O(($[ga>>2]|0)+(ta<<2)|0,0,fa-ta<<2|0),ra=$[U>>2]|0}$[na>>2]=fa,qa=ra}if(oa=$[y>>2]|0,va=(_[qa+34|0]|0)<<8|(_[qa+33|0]|0)<<16|(_[qa+35|0]|0),wa=oa+va|0,xa=(_[qa+37|0]|0)<<8|(_[qa+36|0]|0)<<16|(_[qa+38|0]|0),(xa|0)==0)break;for($[T>>2]=wa,$[V>>2]=wa,$[ca>>2]=xa,$[ea>>2]=oa+(xa+va),$[X>>2]=0,$[da>>2]=0,va=r|0,O(ha|0,0,17),xa=r+24|0,$[r+44>>2]=0,O(r+20|0,0,21),oa=0;;){if(oa>>>0>=2){S=397;break}if(!(z(W,r+(oa*24|0)|0)|0)){ya=0;break}oa=oa+1|0}if((S|0)==397)for(($[na>>2]|0)==0&&(oa=q|0,ua(oa|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=904,$[M+16>>2]=312,M|0))|0,ba=M,sa(oa|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M),oa=0,ha=0,wa=0,za=0,Aa=0,Ba=$[ga>>2]|0,Ca=0,Da=0;;){if(Ea=(A(W,va)|0)+Da&31,Fa=(A(W,xa)|0)+oa&63,Ga=(A(W,va)|0)+ha&31,Ha=(A(W,va)|0)+wa|0,Ia=(A(W,xa)|0)+za&63,Ja=(A(W,va)|0)+Aa&31,$[Ba>>2]=Fa<<5|Ea<<11|Ga|Ha<<27|Ia<<21|Ja<<16,Ka=Ca+1|0,!(Ka>>>0<fa>>>0)){ya=1;break}oa=Fa,ha=Ga,wa=Ha&31,za=Ia,Aa=Ja,Ba=Ba+4|0,Ca=Ka,Da=Ea}if(w(xa),w(va),!ya)break;if(Da=p,Ca=$[U>>2]|0,Ba=(_[Ca+47|0]|0)<<8|(_[Ca+48|0]|0),Aa=$[y>>2]|0,za=(_[Ca+42|0]|0)<<8|(_[Ca+41|0]|0)<<16|(_[Ca+43|0]|0),wa=Aa+za|0,ha=(_[Ca+45|0]|0)<<8|(_[Ca+44|0]|0)<<16|(_[Ca+46|0]|0),(ha|0)==0)break;if($[T>>2]=wa,$[V>>2]=wa,$[ca>>2]=ha,$[ea>>2]=Aa+(ha+za),$[X>>2]=0,$[da>>2]=0,$[m+20>>2]=0,O(m|0,0,17),!(z(W,m)|0)){w(m);break}for(La=-3,Ma=-3,Na=0;;){if($[n+(Na<<2)>>2]=La,$[o+(Na<<2)>>2]=Ma,za=La+1|0,ha=(za|0)>3,Aa=Na+1|0,!(Aa>>>0<49))break;La=ha?-3:za,Ma=(ha&1)+Ma|0,Na=Aa}if(O(Da|0,0,64),va=F+256|0,xa=$[va>>2]|0,(xa|0)!=(Ba|0)){if(xa>>>0<=Ba>>>0){do{if(($[F+260>>2]|0)>>>0<Ba>>>0){if(s(P,Ba,(xa+1|0)==(Ba|0),4)|0){Oa=$[va>>2]|0;break}Y[F+264|0]=1,w(m);break b}Oa=xa}while(0);O(($[P>>2]|0)+(Oa<<2)|0,0,Ba-Oa<<2|0)}$[va>>2]=Ba}if((Ba|0)==0)xa=q|0,ua(xa|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=904,$[M+16>>2]=312,M|0))|0,ba=M,sa(xa|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M;else for(xa=p|0,Da=p+4|0,Aa=p+8|0,ha=p+12|0,za=p+16|0,wa=p+20|0,Ca=p+24|0,oa=p+28|0,fa=p+32|0,ga=p+36|0,na=p+40|0,Ea=p+44|0,Ka=p+48|0,Ja=p+52|0,Ia=p+56|0,Ha=p+60|0,Ga=$[P>>2]|0,Fa=0;;){Pa=0;do Qa=A(W,m)|0,Ra=Pa<<1,Sa=p+(Ra<<2)|0,$[Sa>>2]=($[Sa>>2]|0)+($[n+(Qa<<2)>>2]|0)&3,Sa=p+((Ra|1)<<2)|0,$[Sa>>2]=($[Sa>>2]|0)+($[o+(Qa<<2)>>2]|0)&3,Pa=Pa+1|0;while(Pa>>>0<8);if($[Ga>>2]=(_[880+($[Da>>2]|0)|0]|0)<<2|(_[880+($[xa>>2]|0)|0]|0)|(_[880+($[Aa>>2]|0)|0]|0)<<4|(_[880+($[ha>>2]|0)|0]|0)<<6|(_[880+($[za>>2]|0)|0]|0)<<8|(_[880+($[wa>>2]|0)|0]|0)<<10|(_[880+($[Ca>>2]|0)|0]|0)<<12|(_[880+($[oa>>2]|0)|0]|0)<<14|(_[880+($[fa>>2]|0)|0]|0)<<16|(_[880+($[ga>>2]|0)|0]|0)<<18|(_[880+($[na>>2]|0)|0]|0)<<20|(_[880+($[Ea>>2]|0)|0]|0)<<22|(_[880+($[Ka>>2]|0)|0]|0)<<24|(_[880+($[Ja>>2]|0)|0]|0)<<26|(_[880+($[Ia>>2]|0)|0]|0)<<28|(_[880+($[Ha>>2]|0)|0]|0)<<30,Pa=Fa+1|0,!(Pa>>>0<Ba>>>0))break;Ga=Ga+4|0,Fa=Pa}w(m),ma=$[U>>2]|0}if(Fa=(_[ma+55|0]|0)<<8|(_[ma+56|0]|0),(Fa|0)==0){N=F;break a}if(Ga=$[y>>2]|0,Ba=(_[ma+50|0]|0)<<8|(_[ma+49|0]|0)<<16|(_[ma+51|0]|0),Ha=Ga+Ba|0,Ia=(_[ma+53|0]|0)<<8|(_[ma+52|0]|0)<<16|(_[ma+54|0]|0),(Ia|0)==0)break;$[T>>2]=Ha,$[V>>2]=Ha,$[ca>>2]=Ia,$[ea>>2]=Ga+(Ia+Ba),$[X>>2]=0,$[da>>2]=0,$[l+20>>2]=0,O(l|0,0,17);c:do if(z(W,l)|0){if(Ba=F+272|0,Ia=$[Ba>>2]|0,(Ia|0)!=(Fa|0)){if(Ia>>>0<=Fa>>>0){do{if(($[F+276>>2]|0)>>>0<Fa>>>0){if(s(Q,Fa,(Ia+1|0)==(Fa|0),2)|0){Ta=$[Ba>>2]|0;break}Y[F+280|0]=1;break c}Ta=Ia}while(0);O(($[Q>>2]|0)+(Ta<<1)|0,0,Fa-Ta<<1|0)}$[Ba>>2]=Fa}for(Ia=$[Q>>2]|0,Ga=0,Ha=0,Ja=0;;){if(Ka=A(W,l)|0,Ea=Ka+Ga&255,Ka=(A(W,l)|0)+Ha&255,Z[Ia>>1]=(Ka<<8|Ea)&65535,na=Ja+1|0,!(na>>>0<Fa>>>0))break;Ia=Ia+2|0,Ga=Ea,Ha=Ka,Ja=na}if(w(l),Ja=p,Ha=$[U>>2]|0,Ga=(_[Ha+63|0]|0)<<8|(_[Ha+64|0]|0),Ia=$[y>>2]|0,Ba=(_[Ha+58|0]|0)<<8|(_[Ha+57|0]|0)<<16|(_[Ha+59|0]|0),na=Ia+Ba|0,Ka=(_[Ha+61|0]|0)<<8|(_[Ha+60|0]|0)<<16|(_[Ha+62|0]|0),(Ka|0)==0)Ua=0;else{$[T>>2]=na,$[V>>2]=na,$[ca>>2]=Ka,$[ea>>2]=Ia+(Ka+Ba),$[X>>2]=0,$[da>>2]=0,$[i+20>>2]=0,O(i|0,0,17);d:do if(z(W,i)|0){for(Ba=-7,Ka=-7,Ia=0;;){if($[j+(Ia<<2)>>2]=Ba,$[k+(Ia<<2)>>2]=Ka,na=Ba+1|0,Ha=(na|0)>7,Ea=Ia+1|0,!(Ea>>>0<225))break;Ba=Ha?-7:na,Ka=(Ha&1)+Ka|0,Ia=Ea}if(O(Ja|0,0,64),Ia=Ga*3|0,Ka=F+288|0,Ba=$[Ka>>2]|0,(Ba|0)!=(Ia|0)){if(Ba>>>0<=Ia>>>0){do{if(($[F+292>>2]|0)>>>0<Ia>>>0){if(s(R,Ia,(Ba+1|0)==(Ia|0),2)|0){Va=$[Ka>>2]|0;break}Y[F+296|0]=1,Wa=0;break d}Va=Ba}while(0);O(($[R>>2]|0)+(Va<<1)|0,0,Ia-Va<<1|0)}$[Ka>>2]=Ia}if((Ia|0)==0&&(Ba=q|0,ua(Ba|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=904,$[M+16>>2]=312,M|0))|0,ba=M,sa(Ba|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M),(Ga|0)==0){Wa=1;break}for(Ba=p|0,Ea=p+4|0,Ha=p+8|0,na=p+12|0,ga=p+16|0,fa=p+20|0,oa=p+24|0,Ca=p+28|0,wa=p+32|0,za=p+36|0,ha=p+40|0,Aa=p+44|0,xa=p+48|0,Da=p+52|0,va=p+56|0,Pa=p+60|0,Qa=$[R>>2]|0,Sa=0;;){Ra=0;do Xa=A(W,i)|0,Ya=Ra<<1,Za=p+(Ya<<2)|0,$[Za>>2]=($[Za>>2]|0)+($[j+(Xa<<2)>>2]|0)&7,Za=p+((Ya|1)<<2)|0,$[Za>>2]=($[Za>>2]|0)+($[k+(Xa<<2)>>2]|0)&7,Ra=Ra+1|0;while(Ra>>>0<8);if(Z[Qa>>1]=(_[872+($[Ea>>2]|0)|0]|0)<<3|(_[872+($[Ba>>2]|0)|0]|0)|(_[872+($[Ha>>2]|0)|0]|0)<<6|(_[872+($[na>>2]|0)|0]|0)<<9|(_[872+($[ga>>2]|0)|0]|0)<<12|(_[872+($[fa>>2]|0)|0]|0)<<15,Z[Qa+2>>1]=(_[872+($[oa>>2]|0)|0]|0)<<2|(Y[872+($[fa>>2]|0)|0]&255)>>>1|(_[872+($[Ca>>2]|0)|0]|0)<<5|(_[872+($[wa>>2]|0)|0]|0)<<8|(_[872+($[za>>2]|0)|0]|0)<<11|(_[872+($[ha>>2]|0)|0]|0)<<14,Z[Qa+4>>1]=(_[872+($[Aa>>2]|0)|0]|0)<<1|(Y[872+($[ha>>2]|0)|0]&255)>>>2|(_[872+($[xa>>2]|0)|0]|0)<<4|(_[872+($[Da>>2]|0)|0]|0)<<7|(_[872+($[va>>2]|0)|0]|0)<<10|(_[872+($[Pa>>2]|0)|0]|0)<<13,Ra=Sa+1|0,!(Ra>>>0<Ga>>>0)){Wa=1;break}Qa=Qa+6|0,Sa=Ra}}else Wa=0;while(0);w(i),Ua=Wa}if(Ua){N=Ua?F:0;break a}break b}while(0);w(l)}while(0);if((S|0)==369&&($[H>>2]=0),I(E),(F&7|0)==0){K(F),N=0;break}R=u|0,ua(R|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=2500,$[M+16>>2]=576,M|0))|0,ba=M,sa(R|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M,N=0;break}N=0}while(0);l=f+e|0;do if(l>>>0>e>>>0){if(f=N,(N|0)==0){for(Ua=e,Wa=D,i=C,k=c;;){if($a=k+(pa(pa((i+3|0)>>>2,L)|0,(Wa+3|0)>>>2)|0)|0,p=Ua+1|0,!(p>>>0<l>>>0))break;Ua=p,Wa>>>=1,i>>>=1,k=$a}$[G>>2]=$a;break}for(k=N+88|0,i=N+8|0,Wa=N+4|0,Ua=N+92|0,F=Ua,E=N+96|0,H=N+104|0,p=N+100|0,j=N+108|0,Va=N+112|0,Ta=N+240|0,ma=N+256|0,m=Ua,Ua=N+116|0,o=N+140|0,n=N+236|0,Oa=q|0,Na=N+188|0,Ma=N+252|0,La=N+272|0,ya=N+212|0,r=N+288|0,qa=N+284|0,ra=N+164|0,ta=N+268|0,la=u|0,ka=e,ja=D,ia=C,a=c;;){b=pa((ia+3|0)>>>2,L)|0,R=pa(b,(ja+3|0)>>>2)|0;do if(R>>>0<8|ka>>>0>15)_a=a;else{if(($[f>>2]|0)!=519686845){_a=a;break}y=$[k>>2]|0,Q=(_[y+70+(ka<<2)+1|0]|0)<<16|(_[y+70+(ka<<2)|0]|0)<<24|(_[y+70+(ka<<2)+2|0]|0)<<8|(_[y+70+(ka<<2)+3|0]|0),P=ka+1|0,ab=P>>>0<(_[y+16|0]|0)>>>0?(_[y+70+(P<<2)+1|0]|0)<<16|(_[y+70+(P<<2)|0]|0)<<24|(_[y+70+(P<<2)+2|0]|0)<<8|(_[y+70+(P<<2)+3|0]|0):$[i>>2]|0,ab>>>0>Q>>>0?bb=y:(ua(la|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=3705,$[M+16>>2]=248,M|0))|0,ba=M,sa(la|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M,bb=$[k>>2]|0),y=$[Wa>>2]|0,P=y+Q|0,J=ab-Q|0,W=((_[bb+12|0]|0)<<8|(_[bb+13|0]|0))>>>(ka>>>0),da=((_[bb+14|0]|0)<<8|(_[bb+15|0]|0))>>>(ka>>>0),X=W>>>0>1?(W+3|0)>>>2:1,W=da>>>0>1?(da+3|0)>>>2:1,da=bb+18|0,ea=Y[da]|0,cb=ea<<24>>24==0?8:ea<<24>>24==9?8:16,ea=pa(cb,X)|0,(b|0)==0?(db=ea,S=494):ea>>>0<=b>>>0&&(db=b,S=494);a:do if((S|0)==494){if(S=0,(pa(db,W)|0)>>>0>R>>>0)break;if(ea=(X+1|0)>>>1,ca=(W+1|0)>>>1,(ab|0)==(Q|0))break;switch($[F>>2]=P,$[E>>2]=P,$[H>>2]=J,$[p>>2]=y+ab,$[j>>2]=0,$[Va>>2]=0,_[da]|0|0){case 0:if(V=$[Ta>>2]|0,T=$[ma>>2]|0,U=Y[bb+17|0]|0,Fa=U&255,Ga=db>>>2,U<<24>>24==0)break a;for(U=(ca|0)==0,Ja=ca-1|0,Sa=(W&1|0)!=0,Qa=db<<1,Pa=Ga+1|0,va=Ga+2|0,Da=Ga+3|0,xa=ea-1|0,ha=xa<<4,Aa=(X&1|0)!=0,za=db+4|0,wa=0,Ca=0,fa=0,oa=1;;){if(U)eb=wa,fb=Ca,gb=oa;else for(ga=wa,na=Ca,Ha=0,Ba=$[B+(fa<<2)>>2]|0,Ea=oa;;){if((Ha&1|0)==0?(hb=0,ib=ea,jb=1,kb=16,lb=Ba):(hb=xa,ib=-1,jb=-1,kb=-16,lb=Ba+ha|0),Ia=(Ha|0)==(Ja|0),Ka=Ia&Sa,(hb|0)==(ib|0))mb=ga,nb=na,ob=Ea;else for(Ra=Ia&Sa^1,Ia=ga,Xa=na,Za=hb,Ya=lb,pb=Ea;;){qb=(pb|0)==1?A(m,Ua)|0|512:pb,rb=qb&7,sb=_[832+rb|0]|0,tb=Ia,ub=0;do vb=(A(m,o)|0)+tb|0,wb=vb-V|0,xb=wb>>31,tb=xb&vb|wb&~xb,($[Ta>>2]|0)>>>0<=tb>>>0&&(ua(Oa|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=904,$[M+16>>2]=312,M|0))|0,ba=M,sa(Oa|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M),$[h+(ub<<2)>>2]=$[($[n>>2]|0)+(tb<<2)>>2],ub=ub+1|0;while(ub>>>0<sb>>>0);sb=qb>>>3,ub=(Za|0)==(xa|0)&Aa,xb=Ya;do if(Ka|ub){if(ub){if(wb=(A(m,Na)|0)+Xa|0,vb=wb-T|0,yb=vb>>31,zb=yb&wb|vb&~yb,$[xb>>2]=$[h+((_[840+(rb<<2)|0]|0)<<2)>>2],($[ma>>2]|0)>>>0<=zb>>>0&&(ua(Oa|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=904,$[M+16>>2]=312,M|0))|0,ba=M,sa(Oa|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M),$[Ya+4>>2]=$[($[Ma>>2]|0)+(zb<<2)>>2],yb=(A(m,Na)|0)+zb|0,zb=yb-T|0,vb=zb>>31,wb=(A(m,Na)|0)+(vb&yb|zb&~vb)|0,vb=wb-T|0,zb=vb>>31,yb=zb&wb|vb&~zb,Ka){zb=(A(m,Na)|0)+yb|0,vb=zb-T|0,wb=vb>>31,Ab=wb&zb|vb&~wb;break}$[Ya+db>>2]=$[h+((_[842+(rb<<2)|0]|0)<<2)>>2],($[ma>>2]|0)>>>0<=yb>>>0&&(ua(Oa|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=904,$[M+16>>2]=312,M|0))|0,ba=M,sa(Oa|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M),$[Ya+za>>2]=$[($[Ma>>2]|0)+(yb<<2)>>2],wb=(A(m,Na)|0)+yb|0,yb=wb-T|0,vb=yb>>31,Ab=vb&wb|yb&~vb;break}for(Bb=Xa,Cb=0;;){if(vb=pa(Cb,db)|0,yb=Cb<<1,wb=(A(m,Na)|0)+Bb|0,zb=wb-T|0,Db=zb>>31,Eb=Db&wb|zb&~Db,(Cb|0)==0|Ra?($[Ya+vb>>2]=$[h+((_[840+(rb<<2)+yb|0]|0)<<2)>>2],($[ma>>2]|0)>>>0<=Eb>>>0&&(ua(Oa|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=904,$[M+16>>2]=312,M|0))|0,ba=M,sa(Oa|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M),$[Ya+(vb+4)>>2]=$[($[Ma>>2]|0)+(Eb<<2)>>2],Db=(A(m,Na)|0)+Eb|0,zb=Db-T|0,wb=zb>>31,Fb=wb&Db|zb&~wb,$[Ya+(vb+8)>>2]=$[h+((_[(yb|1)+(840+(rb<<2))|0]|0)<<2)>>2],($[ma>>2]|0)>>>0<=Fb>>>0&&(ua(Oa|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=904,$[M+16>>2]=312,M|0))|0,ba=M,sa(Oa|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M),$[Ya+(vb+12)>>2]=$[($[Ma>>2]|0)+(Fb<<2)>>2],Gb=Fb):(Fb=(A(m,Na)|0)+Eb|0,Eb=Fb-T|0,vb=Eb>>31,Gb=vb&Fb|Eb&~vb),vb=Cb+1|0,!(vb>>>0<2)){Ab=Gb;break}Bb=Gb,Cb=vb}}else $[xb>>2]=$[h+((_[840+(rb<<2)|0]|0)<<2)>>2],vb=(A(m,Na)|0)+Xa|0,Eb=vb-T|0,Fb=Eb>>31,yb=Fb&vb|Eb&~Fb,($[ma>>2]|0)>>>0<=yb>>>0&&(ua(Oa|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=904,$[M+16>>2]=312,M|0))|0,ba=M,sa(Oa|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M),$[Ya+4>>2]=$[($[Ma>>2]|0)+(yb<<2)>>2],$[Ya+8>>2]=$[h+((_[841+(rb<<2)|0]|0)<<2)>>2],Fb=(A(m,Na)|0)+yb|0,yb=Fb-T|0,Eb=yb>>31,vb=Eb&Fb|yb&~Eb,($[ma>>2]|0)>>>0<=vb>>>0&&(ua(Oa|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=904,$[M+16>>2]=312,M|0))|0,ba=M,sa(Oa|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M),$[Ya+12>>2]=$[($[Ma>>2]|0)+(vb<<2)>>2],$[xb+(Ga<<2)>>2]=$[h+((_[842+(rb<<2)|0]|0)<<2)>>2],Eb=(A(m,Na)|0)+vb|0,vb=Eb-T|0,yb=vb>>31,Fb=yb&Eb|vb&~yb,($[ma>>2]|0)>>>0<=Fb>>>0&&(ua(Oa|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=904,$[M+16>>2]=312,M|0))|0,ba=M,sa(Oa|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M),$[xb+(Pa<<2)>>2]=$[($[Ma>>2]|0)+(Fb<<2)>>2],$[xb+(va<<2)>>2]=$[h+((_[843+(rb<<2)|0]|0)<<2)>>2],yb=(A(m,Na)|0)+Fb|0,Fb=yb-T|0,vb=Fb>>31,Eb=vb&yb|Fb&~vb,($[ma>>2]|0)>>>0<=Eb>>>0&&(ua(Oa|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=904,$[M+16>>2]=312,M|0))|0,ba=M,sa(Oa|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M),$[xb+(Da<<2)>>2]=$[($[Ma>>2]|0)+(Eb<<2)>>2],Ab=Eb;while(0);if(xb=Za+jb|0,(xb|0)==(ib|0)){mb=tb,nb=Ab,ob=sb;break}Ia=tb,Xa=Ab,Za=xb,Ya=Ya+kb|0,pb=sb}if(pb=Ha+1|0,!(pb>>>0<ca>>>0)){eb=mb,fb=nb,gb=ob;break}ga=mb,na=nb,Ha=pb,Ba=Ba+Qa|0,Ea=ob}if(Ea=fa+1|0,!(Ea>>>0<Fa>>>0))break;wa=eb,Ca=fb,fa=Ea,oa=gb}break;case 2:case 3:case 5:case 6:case 4:if(oa=$[Ta>>2]|0,fa=$[ma>>2]|0,Ca=$[La>>2]|0,wa=(_[bb+63|0]|0)<<8|(_[bb+64|0]|0),Fa=Y[bb+17|0]|0,Qa=Fa&255,Fa<<24>>24==0)break a;for(Fa=(ca|0)==0,Da=ca-1|0,T=(W&1|0)==0,va=db<<1,Pa=(X&1|0)==0,Ga=ea-1|0,za=Ga<<5,Aa=0,xa=0,V=0,Sa=0,Ja=0,ha=1;;){if(Fa)Hb=Aa,Ib=xa,Jb=V,Kb=Sa,Lb=ha;else for(U=Aa,Ea=xa,Ba=V,Ha=Sa,na=0,ga=$[B+(Ja<<2)>>2]|0,pb=ha;;){if((na&1|0)==0?(Mb=0,Nb=ea,Ob=1,Pb=32,Qb=ga):(Mb=Ga,Nb=-1,Ob=-1,Pb=-32,Qb=ga+za|0),Ya=T|(na|0)!=(Da|0),(Mb|0)==(Nb|0))Rb=U,Sb=Ea,Tb=Ba,Ub=Ha,Vb=pb;else for(Za=U,Xa=Ea,Ia=Ba,Ra=Ha,Ka=Mb,xb=Qb,rb=pb;;){Wb=(rb|0)==1?A(m,Ua)|0|512:rb,ub=Wb&7,Eb=_[832+ub|0]|0,vb=(Ka|0)!=(Ga|0),Fb=Ia,yb=0;do wb=(A(m,ra)|0)+Fb|0,zb=wb-Ca|0,Db=zb>>31,Fb=Db&wb|zb&~Db,($[La>>2]|0)>>>0<=Fb>>>0&&(ua(Oa|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=904,$[M+16>>2]=312,M|0))|0,ba=M,sa(Oa|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M),$[g+(yb<<2)>>2]=aa[($[ta>>2]|0)+(Fb<<1)>>1]|0,yb=yb+1|0;while(yb>>>0<Eb>>>0);yb=Wb>>>3,sb=Za,tb=0;do Db=(A(m,o)|0)+sb|0,zb=Db-oa|0,wb=zb>>31,sb=wb&Db|zb&~wb,($[Ta>>2]|0)>>>0<=sb>>>0&&(ua(Oa|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=904,$[M+16>>2]=312,M|0))|0,ba=M,sa(Oa|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M),$[h+(tb<<2)>>2]=$[($[n>>2]|0)+(sb<<2)>>2],tb=tb+1|0;while(tb>>>0<Eb>>>0);for(Eb=Pa|vb,tb=Xa,wb=Ra,zb=xb,Db=0;;){for(Xb=(Db|0)==0|Ya,Yb=Db<<1,Zb=tb,$b=wb,_b=zb,ac=0;;){if(bc=(A(m,ya)|0)+$b|0,cc=bc-wa|0,dc=cc>>31,ec=dc&bc|cc&~dc,dc=(A(m,Na)|0)+Zb|0,cc=dc-fa|0,bc=cc>>31,fc=bc&dc|cc&~bc,((ac|0)==0|Eb)&Xb&&(bc=_[ac+Yb+(840+(ub<<2))|0]|0,cc=ec*3|0,($[r>>2]|0)>>>0<=cc>>>0&&(ua(Oa|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=904,$[M+16>>2]=312,M|0))|0,ba=M,sa(Oa|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M),dc=$[qa>>2]|0,$[_b>>2]=(aa[dc+(cc<<1)>>1]|0)<<16|$[g+(bc<<2)>>2],$[_b+4>>2]=(aa[dc+(cc+2<<1)>>1]|0)<<16|(aa[dc+(cc+1<<1)>>1]|0),$[_b+8>>2]=$[h+(bc<<2)>>2],($[ma>>2]|0)>>>0<=fc>>>0&&(ua(Oa|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=904,$[M+16>>2]=312,M|0))|0,ba=M,sa(Oa|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M),$[_b+12>>2]=$[($[Ma>>2]|0)+(fc<<2)>>2]),bc=ac+1|0,!(bc>>>0<2))break;Zb=fc,$b=ec,_b=_b+16|0,ac=bc}if(ac=Db+1|0,!(ac>>>0<2))break;tb=fc,wb=ec,zb=zb+db|0,Db=ac}if(Db=Ka+Ob|0,(Db|0)==(Nb|0)){Rb=sb,Sb=fc,Tb=Fb,Ub=ec,Vb=yb;break}Za=sb,Xa=fc,Ia=Fb,Ra=ec,Ka=Db,xb=xb+Pb|0,rb=yb}if(rb=na+1|0,!(rb>>>0<ca>>>0)){Hb=Rb,Ib=Sb,Jb=Tb,Kb=Ub,Lb=Vb;break}U=Rb,Ea=Sb,Ba=Tb,Ha=Ub,na=rb,ga=ga+va|0,pb=Vb}if(pb=Ja+1|0,!(pb>>>0<Qa>>>0))break;Aa=Hb,xa=Ib,V=Jb,Sa=Kb,Ja=pb,ha=Lb}break;case 9:if(ha=$[La>>2]|0,Ja=(_[bb+63|0]|0)<<8|(_[bb+64|0]|0),Sa=Y[bb+17|0]|0,V=Sa&255,Sa<<24>>24==0)break a;for(Sa=(ca|0)==0,xa=ca-1|0,Aa=(W&1|0)==0,Qa=db<<1,va=ea-1|0,fa=va<<4,wa=(X&1|0)!=0,Pa=0,oa=0,Ca=0,Ga=1;;){if(Sa)gc=Pa,hc=oa,ic=Ga;else for(Da=Pa,T=oa,za=0,Fa=$[B+(Ca<<2)>>2]|0,pb=Ga;;){if((za&1|0)==0?(jc=0,kc=ea,lc=1,mc=16,nc=Fa):(jc=va,kc=-1,lc=-1,mc=-16,nc=Fa+fa|0),ga=Aa|(za|0)!=(xa|0),(jc|0)==(kc|0))oc=Da,pc=T,qc=pb;else for(na=Da,Ha=T,Ba=nc,Ea=jc,U=pb;;){rc=(U|0)==1?A(m,Ua)|0|512:U,rb=rc&7,xb=_[832+rb|0]|0,Ka=na,Ra=0;do Ia=(A(m,ra)|0)+Ka|0,Xa=Ia-ha|0,Za=Xa>>31,Ka=Za&Ia|Xa&~Za,($[La>>2]|0)>>>0<=Ka>>>0&&(ua(Oa|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=904,$[M+16>>2]=312,M|0))|0,ba=M,sa(Oa|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M),$[h+(Ra<<2)>>2]=aa[($[ta>>2]|0)+(Ka<<1)>>1]|0,Ra=Ra+1|0;while(Ra>>>0<xb>>>0);for(xb=(Ea|0)==(va|0)&wa,Ra=Ha,yb=Ba,Fb=0;;){if(sb=yb,Za=(Fb|0)==0|ga,Xa=Fb<<1,Ia=(A(m,ya)|0)+Ra|0,Ya=Ia-Ja|0,Db=Ya>>31,zb=Db&Ia|Ya&~Db,Za&&(Db=_[840+(rb<<2)+Xa|0]|0,Ya=zb*3|0,($[r>>2]|0)>>>0<=Ya>>>0&&(ua(Oa|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=904,$[M+16>>2]=312,M|0))|0,ba=M,sa(Oa|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M),Ia=$[qa>>2]|0,$[sb>>2]=(aa[Ia+(Ya<<1)>>1]|0)<<16|$[h+(Db<<2)>>2],$[yb+4>>2]=(aa[Ia+(Ya+2<<1)>>1]|0)<<16|(aa[Ia+(Ya+1<<1)>>1]|0)),Ya=yb+8|0,Ia=(A(m,ya)|0)+zb|0,zb=Ia-Ja|0,Db=zb>>31,sc=Db&Ia|zb&~Db,xb|Za^1||(Za=_[(Xa|1)+(840+(rb<<2))|0]|0,Xa=sc*3|0,($[r>>2]|0)>>>0<=Xa>>>0&&(ua(Oa|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=904,$[M+16>>2]=312,M|0))|0,ba=M,sa(Oa|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M),Db=$[qa>>2]|0,$[Ya>>2]=(aa[Db+(Xa<<1)>>1]|0)<<16|$[h+(Za<<2)>>2],$[yb+12>>2]=(aa[Db+(Xa+2<<1)>>1]|0)<<16|(aa[Db+(Xa+1<<1)>>1]|0)),Xa=Fb+1|0,!(Xa>>>0<2))break;Ra=sc,yb=yb+db|0,Fb=Xa}if(Fb=rc>>>3,yb=Ea+lc|0,(yb|0)==(kc|0)){oc=Ka,pc=sc,qc=Fb;break}na=Ka,Ha=sc,Ba=Ba+mc|0,Ea=yb,U=Fb}if(U=za+1|0,!(U>>>0<ca>>>0)){gc=oc,hc=pc,ic=qc;break}Da=oc,T=pc,za=U,Fa=Fa+Qa|0,pb=qc}if(pb=Ca+1|0,!(pb>>>0<V>>>0))break;Pa=gc,oa=hc,Ca=pb,Ga=ic}break;case 7:case 8:if(Ga=$[La>>2]|0,Ca=(_[bb+63|0]|0)<<8|(_[bb+64|0]|0),oa=Y[bb+17|0]|0,Pa=oa&255,oa<<24>>24==0)break a;for(oa=(ca|0)==0,V=ca-1|0,Qa=(W&1|0)==0,Ja=db<<1,wa=(X&1|0)==0,va=ea-1|0,ha=va<<5,xa=0,Aa=0,fa=0,Sa=0,pb=0,Fa=1;;){if(oa)tc=xa,uc=Aa,vc=fa,wc=Sa,xc=Fa;else for(za=xa,T=Aa,Da=fa,U=Sa,Ea=0,Ba=$[B+(pb<<2)>>2]|0,Ha=Fa;;){if((Ea&1|0)==0?(yc=0,zc=ea,Ac=1,Bc=32,Cc=Ba):(yc=va,zc=-1,Ac=-1,Bc=-32,Cc=Ba+ha|0),na=Qa|(Ea|0)!=(V|0),(yc|0)==(zc|0))Dc=za,Ec=T,Fc=Da,Gc=U,Hc=Ha;else for(ga=za,Fb=T,yb=Da,Ra=U,rb=yc,xb=Cc,Xa=Ha;;){Ic=(Xa|0)==1?A(m,Ua)|0|512:Xa,Db=Ic&7,Za=_[832+Db|0]|0,Ya=(rb|0)!=(va|0),zb=ga,Ia=0;do sb=(A(m,ra)|0)+zb|0,wb=sb-Ga|0,tb=wb>>31,zb=tb&sb|wb&~tb,($[La>>2]|0)>>>0<=zb>>>0&&(ua(Oa|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=904,$[M+16>>2]=312,M|0))|0,ba=M,sa(Oa|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M),$[h+(Ia<<2)>>2]=aa[($[ta>>2]|0)+(zb<<1)>>1]|0,Ia=Ia+1|0;while(Ia>>>0<Za>>>0);Ia=Ic>>>3,Ka=yb,tb=0;do wb=(A(m,ra)|0)+Ka|0,sb=wb-Ga|0,ub=sb>>31,Ka=ub&wb|sb&~ub,($[La>>2]|0)>>>0<=Ka>>>0&&(ua(Oa|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=904,$[M+16>>2]=312,M|0))|0,ba=M,sa(Oa|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M),$[g+(tb<<2)>>2]=aa[($[ta>>2]|0)+(Ka<<1)>>1]|0,tb=tb+1|0;while(tb>>>0<Za>>>0);for(Za=wa|Ya,tb=Fb,ub=Ra,sb=xb,wb=0;;){for(Eb=(wb|0)==0|na,vb=wb<<1,ac=tb,_b=ub,$b=sb,Zb=0;;){if(Yb=(A(m,ya)|0)+ac|0,Xb=Yb-Ca|0,bc=Xb>>31,Jc=bc&Yb|Xb&~bc,bc=(A(m,ya)|0)+_b|0,Xb=bc-Ca|0,Yb=Xb>>31,Kc=Yb&bc|Xb&~Yb,((Zb|0)==0|Za)&Eb&&(Yb=_[Zb+vb+(840+(Db<<2))|0]|0,Xb=Jc*3|0,bc=$[r>>2]|0,bc>>>0>Xb>>>0?Lc=bc:(ua(Oa|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=904,$[M+16>>2]=312,M|0))|0,ba=M,sa(Oa|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M,Lc=$[r>>2]|0),bc=$[qa>>2]|0,cc=Kc*3|0,Lc>>>0>cc>>>0?Mc=bc:(ua(Oa|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=904,$[M+16>>2]=312,M|0))|0,ba=M,sa(Oa|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M,Mc=$[qa>>2]|0),$[$b>>2]=(aa[bc+(Xb<<1)>>1]|0)<<16|$[h+(Yb<<2)>>2],$[$b+4>>2]=(aa[bc+(Xb+2<<1)>>1]|0)<<16|(aa[bc+(Xb+1<<1)>>1]|0),$[$b+8>>2]=(aa[Mc+(cc<<1)>>1]|0)<<16|$[g+(Yb<<2)>>2],$[$b+12>>2]=(aa[Mc+(cc+2<<1)>>1]|0)<<16|(aa[Mc+(cc+1<<1)>>1]|0)),cc=Zb+1|0,!(cc>>>0<2))break;ac=Jc,_b=Kc,$b=$b+16|0,Zb=cc}if(Zb=wb+1|0,!(Zb>>>0<2))break;tb=Jc,ub=Kc,sb=sb+db|0,wb=Zb}if(wb=rb+Ac|0,(wb|0)==(zc|0)){Dc=zb,Ec=Jc,Fc=Ka,Gc=Kc,Hc=Ia;break}ga=zb,Fb=Jc,yb=Ka,Ra=Kc,rb=wb,xb=xb+Bc|0,Xa=Ia}if(Xa=Ea+1|0,!(Xa>>>0<ca>>>0)){tc=Dc,uc=Ec,vc=Fc,wc=Gc,xc=Hc;break}za=Dc,T=Ec,Da=Fc,U=Gc,Ea=Xa,Ba=Ba+Ja|0,Ha=Hc}if(Ha=pb+1|0,!(Ha>>>0<Pa>>>0))break;xa=tc,Aa=uc,fa=vc,Sa=wc,pb=Ha,Fa=xc}break;default:break a}}while(0);_a=$[G>>2]|0}while(0);if(b=_a+R|0,$[G>>2]=b,X=ka+1|0,!(X>>>0<l>>>0))break;ka=X,ja>>>=1,ia>>>=1,a=b}}while(0);return(N|0)==0?void(ba=d):($[N>>2]|0)!=519686845?void(ba=d):(I(N),(N&7|0)==0?(K(N),void(ba=d)):(N=x|0,ua(N|0,768,(M=ba,ba=ba+24|0,$[M>>2]=472,$[M+8>>2]=2500,$[M+16>>2]=576,M|0))|0,ba=M,sa(N|0,(M=ba,ba=ba+1|0,ba=ba+7&-8,$[M>>2]=0,M|0))|0,ba=M,void(ba=d)))}function I(a){a|=0;var b=0,c=0,d=0,e=0,f=0;b=ba,ba=ba+512|0,c=b|0,$[a>>2]=0,d=a+284|0,e=$[d>>2]|0,(e|0)!=0&&((e&7|0)==0?K(e):(e=c|0,ua(e|0,768,(f=ba,ba=ba+24|0,$[f>>2]=472,$[f+8>>2]=2500,$[f+16>>2]=576,f|0))|0,ba=f,sa(e|0,(f=ba,ba=ba+1|0,ba=ba+7&-8,$[f>>2]=0,f|0))|0,ba=f),$[d>>2]=0,$[a+288>>2]=0,$[a+292>>2]=0),Y[a+296|0]=0,d=a+268|0,e=$[d>>2]|0,(e|0)!=0&&((e&7|0)==0?K(e):(e=c|0,ua(e|0,768,(f=ba,ba=ba+24|0,$[f>>2]=472,$[f+8>>2]=2500,$[f+16>>2]=576,f|0))|0,ba=f,sa(e|0,(f=ba,ba=ba+1|0,ba=ba+7&-8,$[f>>2]=0,f|0))|0,ba=f),$[d>>2]=0,$[a+272>>2]=0,$[a+276>>2]=0),Y[a+280|0]=0,d=a+252|0,e=$[d>>2]|0,(e|0)!=0&&((e&7|0)==0?K(e):(e=c|0,ua(e|0,768,(f=ba,ba=ba+24|0,$[f>>2]=472,$[f+8>>2]=2500,$[f+16>>2]=576,f|0))|0,ba=f,sa(e|0,(f=ba,ba=ba+1|0,ba=ba+7&-8,$[f>>2]=0,f|0))|0,ba=f),$[d>>2]=0,$[a+256>>2]=0,$[a+260>>2]=0),Y[a+264|0]=0,d=a+236|0,e=$[d>>2]|0,(e|0)!=0&&((e&7|0)==0?K(e):(e=c|0,ua(e|0,768,(f=ba,ba=ba+24|0,$[f>>2]=472,$[f+8>>2]=2500,$[f+16>>2]=576,f|0))|0,ba=f,sa(e|0,(f=ba,ba=ba+1|0,ba=ba+7&-8,$[f>>2]=0,f|0))|0,ba=f),$[d>>2]=0,$[a+240>>2]=0,$[a+244>>2]=0),Y[a+248|0]=0,w(a+212|0),w(a+188|0),w(a+164|0),w(a+140|0),w(a+116|0),ba=b}function J(a){a|=0;var b=0,c=0,d=0,e=0,f=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0,x=0,y=0,z=0,A=0,B=0,C=0,D=0,E=0,F=0,G=0,H=0,I=0,J=0,K=0,L=0,M=0,N=0,O=0,P=0,Q=0,R=0,S=0,T=0,U=0,V=0,W=0,X=0,Y=0,Z=0,_=0,aa=0,ba=0,ca=0,da=0,ea=0,fa=0,ga=0,ha=0,ia=0,ja=0,ka=0,la=0,ma=0,na=0,oa=0,pa=0,qa=0,sa=0,ua=0,ya=0,za=0,Aa=0,Ba=0,Ca=0,Da=0,Ea=0,Fa=0,Ga=0,Ha=0,Ia=0,Ja=0,Ka=0,La=0;do{if(a>>>0<245){if(b=a>>>0<11?16:a+11&-8,c=b>>>3,d=$[228]|0,e=d>>>(c>>>0),(e&3|0)!=0){f=(e&1^1)+c|0,g=f<<1,h=952+(g<<2)|0,i=952+(g+2<<2)|0,g=$[i>>2]|0,j=g+8|0,k=$[j>>2]|0;do{if((h|0)!=(k|0)){if(k>>>0<($[232]|0)>>>0)return ra(),0;if(l=k+12|0,($[l>>2]|0)==(g|0)){$[l>>2]=h,$[i>>2]=k;break}return ra(),0}$[228]=d&~(1<<f)}while(0);return k=f<<3,$[g+4>>2]=k|3,i=g+(k|4)|0,$[i>>2]=$[i>>2]|1,m=j,m|0}if(b>>>0<=($[230]|0)>>>0){n=b;break}if((e|0)!=0){i=2<<c,k=e<<c&(i|-i),i=(k&-k)-1|0,k=i>>>12&16,h=i>>>(k>>>0),i=h>>>5&8,l=h>>>(i>>>0),h=l>>>2&4,o=l>>>(h>>>0),l=o>>>1&2,p=o>>>(l>>>0),o=p>>>1&1,q=(i|k|h|l|o)+(p>>>(o>>>0))|0,o=q<<1,p=952+(o<<2)|0,l=952+(o+2<<2)|0,o=$[l>>2]|0,h=o+8|0,k=$[h>>2]|0;do{if((p|0)!=(k|0)){if(k>>>0<($[232]|0)>>>0)return ra(),0;if(i=k+12|0,($[i>>2]|0)==(o|0)){$[i>>2]=p,$[l>>2]=k;break}return ra(),0}$[228]=d&~(1<<q)}while(0);if(k=q<<3,l=k-b|0,$[o+4>>2]=b|3,p=o,d=p+b|0,$[p+(b|4)>>2]=l|1,$[p+k>>2]=l,k=$[230]|0,(k|0)!=0){p=$[233]|0,c=k>>>3,k=c<<1,e=952+(k<<2)|0,j=$[228]|0,g=1<<c;do{if((j&g|0)!=0){if(c=952+(k+2<<2)|0,f=$[c>>2]|0,f>>>0>=($[232]|0)>>>0){r=f,s=c;break}return ra(),0}$[228]=j|g,r=e,s=952+(k+2<<2)|0}while(0);$[s>>2]=p,$[r+12>>2]=p,$[p+8>>2]=r,$[p+12>>2]=e}return $[230]=l,$[233]=d,m=h,m|0}if(k=$[229]|0,(k|0)==0){n=b;break}for(g=(k&-k)-1|0,k=g>>>12&16,j=g>>>(k>>>0),g=j>>>5&8,o=j>>>(g>>>0),j=o>>>2&4,q=o>>>(j>>>0),o=q>>>1&2,c=q>>>(o>>>0),q=c>>>1&1,f=$[1216+((g|k|j|o|q)+(c>>>(q>>>0))<<2)>>2]|0,q=f,c=f,o=($[f+4>>2]&-8)-b|0;;){if(f=$[q+16>>2]|0,(f|0)==0){if(j=$[q+20>>2]|0,(j|0)==0)break;t=j}else t=f;f=($[t+4>>2]&-8)-b|0,j=f>>>0<o>>>0,q=t,c=j?t:c,o=j?f:o}if(q=c,h=$[232]|0,q>>>0<h>>>0)return ra(),0;if(d=q+b|0,l=d,q>>>0>=d>>>0)return ra(),0;d=$[c+24>>2]|0,e=$[c+12>>2]|0;do{if((e|0)==(c|0)){if(p=c+20|0,f=$[p>>2]|0,(f|0)==0){if(j=c+16|0,k=$[j>>2]|0,(k|0)==0){u=0;break}v=k,w=j}else v=f,w=p;for(;;)if(p=v+20|0,f=$[p>>2]|0,(f|0)==0){if(p=v+16|0,f=$[p>>2]|0,(f|0)==0)break;v=f,w=p}else v=f,w=p;if(w>>>0<h>>>0)return ra(),0;$[w>>2]=0,u=v;break}if(p=$[c+8>>2]|0,p>>>0<h>>>0)return ra(),0;if(f=p+12|0,($[f>>2]|0)!=(c|0))return ra(),0;if(j=e+8|0,($[j>>2]|0)==(c|0)){$[f>>2]=e,$[j>>2]=p,u=e;break}return ra(),0}while(0);a:do if((d|0)!=0){e=c+28|0,h=1216+($[e>>2]<<2)|0;do{if((c|0)==($[h>>2]|0)){if($[h>>2]=u,(u|0)!=0)break;$[229]=$[229]&~(1<<$[e>>2]);break a}if(d>>>0<($[232]|0)>>>0)return ra(),0;if(p=d+16|0,($[p>>2]|0)==(c|0)?$[p>>2]=u:$[d+20>>2]=u,(u|0)==0)break a}while(0);if(u>>>0<($[232]|0)>>>0)return ra(),0;$[u+24>>2]=d,e=$[c+16>>2]|0;do if((e|0)!=0){if(e>>>0<($[232]|0)>>>0)return ra(),0;$[u+16>>2]=e,$[e+24>>2]=u;break}while(0);if(e=$[c+20>>2]|0,(e|0)==0)break;if(e>>>0<($[232]|0)>>>0)return ra(),0;$[u+20>>2]=e,$[e+24>>2]=u;break}while(0);if(o>>>0<16)d=o+b|0,$[c+4>>2]=d|3,e=q+(d+4)|0,$[e>>2]=$[e>>2]|1;else{if($[c+4>>2]=b|3,$[q+(b|4)>>2]=o|1,$[q+(o+b)>>2]=o,e=$[230]|0,(e|0)!=0){d=$[233]|0,h=e>>>3,e=h<<1,p=952+(e<<2)|0,j=$[228]|0,f=1<<h;do{if((j&f|0)!=0){if(h=952+(e+2<<2)|0,k=$[h>>2]|0,k>>>0>=($[232]|0)>>>0){x=k,y=h;break}return ra(),0}$[228]=j|f,x=p,y=952+(e+2<<2)|0}while(0);$[y>>2]=d,$[x+12>>2]=d,$[d+8>>2]=x,$[d+12>>2]=p}$[230]=o,$[233]=l}if(e=c+8|0,(e|0)==0){n=b;break}return m=e,m|0}if(a>>>0>4294967231){n=-1;break}if(e=a+11|0,f=e&-8,j=$[229]|0,(j|0)==0){n=f;break}q=-f|0,h=e>>>8;do if((h|0)==0)z=0;else{if(f>>>0>16777215){z=31;break}e=(h+1048320|0)>>>16&8,k=h<<e,g=(k+520192|0)>>>16&4,i=k<<g,k=(i+245760|0)>>>16&2,A=14-(g|e|k)+(i<<k>>>15)|0,z=f>>>((A+7|0)>>>0)&1|A<<1}while(0);h=$[1216+(z<<2)>>2]|0;a:do if((h|0)==0)B=0,C=q,D=0;else for(E=(z|0)==31?0:25-(z>>>1)|0,c=0,l=q,o=h,p=f<<E,d=0;;){if(A=$[o+4>>2]&-8,k=A-f|0,k>>>0<l>>>0){if((A|0)==(f|0)){B=o,C=k,D=o;break a}F=o,G=k}else F=c,G=l;if(k=$[o+20>>2]|0,A=$[o+16+(p>>>31<<2)>>2]|0,i=(k|0)==0|(k|0)==(A|0)?d:k,(A|0)==0){B=F,C=G,D=i;break}c=F,l=G,o=A,p<<=1,d=i}while(0);if((D|0)==0&(B|0)==0){if(h=2<<z,q=(h|-h)&j,(q|0)==0){n=f;break}h=(q&-q)-1|0,q=h>>>12&16,d=h>>>(q>>>0),h=d>>>5&8,p=d>>>(h>>>0),d=p>>>2&4,o=p>>>(d>>>0),p=o>>>1&2,l=o>>>(p>>>0),o=l>>>1&1,H=$[1216+((h|q|d|p|o)+(l>>>(o>>>0))<<2)>>2]|0}else H=D;if((H|0)==0)I=C,J=B;else for(o=H,l=C,p=B;;)if(d=($[o+4>>2]&-8)-f|0,q=d>>>0<l>>>0,h=q?d:l,d=q?o:p,q=$[o+16>>2]|0,(q|0)==0){if(q=$[o+20>>2]|0,(q|0)==0){I=h,J=d;break}o=q,l=h,p=d}else o=q,l=h,p=d;if((J|0)==0){n=f;break}if(I>>>0>=(($[230]|0)-f|0)>>>0){n=f;break}if(p=J,l=$[232]|0,p>>>0<l>>>0)return ra(),0;if(o=p+f|0,j=o,p>>>0>=o>>>0)return ra(),0;d=$[J+24>>2]|0,h=$[J+12>>2]|0;do{if((h|0)==(J|0)){if(q=J+20|0,c=$[q>>2]|0,(c|0)==0){if(i=J+16|0,A=$[i>>2]|0,(A|0)==0){K=0;break}L=A,M=i}else L=c,M=q;for(;;)if(q=L+20|0,c=$[q>>2]|0,(c|0)==0){if(q=L+16|0,c=$[q>>2]|0,(c|0)==0)break;L=c,M=q}else L=c,M=q;if(M>>>0<l>>>0)return ra(),0;$[M>>2]=0,K=L;break}if(q=$[J+8>>2]|0,q>>>0<l>>>0)return ra(),0;if(c=q+12|0,($[c>>2]|0)!=(J|0))return ra(),0;if(i=h+8|0,($[i>>2]|0)==(J|0)){$[c>>2]=h,$[i>>2]=q,K=h;break}return ra(),0}while(0);a:do if((d|0)!=0){h=J+28|0,l=1216+($[h>>2]<<2)|0;do{if((J|0)==($[l>>2]|0)){if($[l>>2]=K,(K|0)!=0)break;$[229]=$[229]&~(1<<$[h>>2]);break a}if(d>>>0<($[232]|0)>>>0)return ra(),0;if(q=d+16|0,($[q>>2]|0)==(J|0)?$[q>>2]=K:$[d+20>>2]=K,(K|0)==0)break a}while(0);if(K>>>0<($[232]|0)>>>0)return ra(),0;$[K+24>>2]=d,h=$[J+16>>2]|0;do if((h|0)!=0){if(h>>>0<($[232]|0)>>>0)return ra(),0;$[K+16>>2]=h,$[h+24>>2]=K;break}while(0);if(h=$[J+20>>2]|0,(h|0)==0)break;if(h>>>0<($[232]|0)>>>0)return ra(),0;$[K+20>>2]=h,$[h+24>>2]=K;break}while(0);do{if(!(I>>>0<16)){if($[J+4>>2]=f|3,$[p+(f|4)>>2]=I|1,$[p+(I+f)>>2]=I,h=I>>>3,I>>>0<256){d=h<<1,l=952+(d<<2)|0,q=$[228]|0,i=1<<h;do{if((q&i|0)!=0){if(h=952+(d+2<<2)|0,c=$[h>>2]|0,c>>>0>=($[232]|0)>>>0){N=c,O=h;break}return ra(),0}$[228]=q|i,N=l,O=952+(d+2<<2)|0}while(0);$[O>>2]=j,$[N+12>>2]=j,$[p+(f+8)>>2]=N,$[p+(f+12)>>2]=l;break}d=o,i=I>>>8;do if((i|0)==0)P=0;else{if(I>>>0>16777215){P=31;break}q=(i+1048320|0)>>>16&8,h=i<<q,
c=(h+520192|0)>>>16&4,A=h<<c,h=(A+245760|0)>>>16&2,k=14-(c|q|h)+(A<<h>>>15)|0,P=I>>>((k+7|0)>>>0)&1|k<<1}while(0);if(i=1216+(P<<2)|0,$[p+(f+28)>>2]=P,$[p+(f+20)>>2]=0,$[p+(f+16)>>2]=0,l=$[229]|0,k=1<<P,(l&k|0)==0){$[229]=l|k,$[i>>2]=d,$[p+(f+24)>>2]=i,$[p+(f+12)>>2]=d,$[p+(f+8)>>2]=d;break}for(Q=(P|0)==31?0:25-(P>>>1)|0,k=I<<Q,l=$[i>>2]|0;;){if(($[l+4>>2]&-8|0)==(I|0))break;if(R=l+16+(k>>>31<<2)|0,i=$[R>>2]|0,(i|0)==0){S=829;break}k<<=1,l=i}if((S|0)==829){if(R>>>0<($[232]|0)>>>0)return ra(),0;$[R>>2]=d,$[p+(f+24)>>2]=l,$[p+(f+12)>>2]=d,$[p+(f+8)>>2]=d;break}if(k=l+8|0,i=$[k>>2]|0,h=$[232]|0,l>>>0<h>>>0)return ra(),0;if(i>>>0<h>>>0)return ra(),0;$[i+12>>2]=d,$[k>>2]=d,$[p+(f+8)>>2]=i,$[p+(f+12)>>2]=l,$[p+(f+24)>>2]=0;break}d=I+f|0,$[J+4>>2]=d|3,h=p+(d+4)|0,$[h>>2]=$[h>>2]|1}while(0);if(p=J+8|0,(p|0)==0){n=f;break}return m=p,m|0}while(0);if(J=$[230]|0,n>>>0<=J>>>0)return R=J-n|0,I=$[233]|0,R>>>0>15?(Q=I,$[233]=Q+n,$[230]=R,$[Q+(n+4)>>2]=R|1,$[Q+J>>2]=R,$[I+4>>2]=n|3):($[230]=0,$[233]=0,$[I+4>>2]=J|3,R=I+(J+4)|0,$[R>>2]=$[R>>2]|1),m=I+8|0,m|0;if(I=$[231]|0,n>>>0<I>>>0)return R=I-n|0,$[231]=R,I=$[234]|0,J=I,$[234]=J+n,$[J+(n+4)>>2]=R|1,$[I+4>>2]=n|3,m=I+8|0,m|0;do if(($[222]|0)==0){if(I=ta(30)|0,(I-1&I|0)==0){$[224]=I,$[223]=I,$[225]=-1,$[226]=-1,$[227]=0,$[339]=0,$[222]=(xa(0)|0)&-16^1431655768;break}return ra(),0}while(0);if(I=n+48|0,R=$[224]|0,J=n+47|0,Q=R+J|0,P=-R|0,R=Q&P,R>>>0<=n>>>0)return m=0,m|0;N=$[338]|0;do if((N|0)!=0){if(O=$[336]|0,K=O+R|0,!(K>>>0<=O>>>0|K>>>0>N>>>0))break;return m=0,m|0}while(0);a:do if(($[339]&4|0)==0){N=$[234]|0;b:do if((N|0)==0)S=859;else{for(K=N,O=1360;;){if(T=O|0,L=$[T>>2]|0,L>>>0<=K>>>0&&(U=O+4|0,(L+($[U>>2]|0)|0)>>>0>K>>>0))break;if(L=$[O+8>>2]|0,(L|0)==0){S=859;break b}O=L}if((O|0)==0){S=859;break}if(K=Q-($[231]|0)&P,K>>>0>=2147483647){V=0;break}l=va(K|0)|0,d=(l|0)==(($[T>>2]|0)+($[U>>2]|0)|0),W=d?l:-1,X=d?K:0,Y=l,Z=K,S=868}while(0);do if((S|0)==859){if(N=va(0)|0,(N|0)==-1){V=0;break}if(f=N,K=$[223]|0,l=K-1|0,_=(l&f|0)==0?R:R-f+(l+f&-K)|0,K=$[336]|0,f=K+_|0,!(_>>>0>n>>>0&_>>>0<2147483647)){V=0;break}if(l=$[338]|0,(l|0)!=0&&f>>>0<=K>>>0|f>>>0>l>>>0){V=0;break}l=va(_|0)|0,f=(l|0)==(N|0),W=f?N:-1,X=f?_:0,Y=l,Z=_,S=868}while(0);b:do if((S|0)==868){if(l=-Z|0,(W|0)!=-1){aa=X,ba=W,S=879;break a}do{if((Y|0)!=-1&Z>>>0<2147483647&Z>>>0<I>>>0){if(f=$[224]|0,N=J-Z+f&-f,N>>>0>=2147483647){ca=Z;break}if((va(N|0)|0)==-1){va(l|0)|0,V=X;break b}ca=N+Z|0;break}ca=Z}while(0);if((Y|0)!=-1){aa=ca,ba=Y,S=879;break a}V=X}while(0);$[339]=$[339]|4,da=V,S=876}else da=0,S=876;while(0);do if((S|0)==876){if(R>>>0>=2147483647)break;if(V=va(R|0)|0,Y=va(0)|0,!((Y|0)!=-1&(V|0)!=-1&V>>>0<Y>>>0))break;ca=Y-V|0,Y=ca>>>0>(n+40|0)>>>0,X=Y?V:-1,(X|0)!=-1&&(aa=Y?ca:da,ba=X,S=879)}while(0);do if((S|0)==879){da=($[336]|0)+aa|0,$[336]=da,da>>>0>($[337]|0)>>>0&&($[337]=da),da=$[234]|0;a:do{if((da|0)!=0){for(R=1360;;){if(fa=$[R>>2]|0,ga=R+4|0,ha=$[ga>>2]|0,(ba|0)==(fa+ha|0)){S=891;break}if(ca=$[R+8>>2]|0,(ca|0)==0)break;R=ca}do if((S|0)==891){if(($[R+12>>2]&8|0)!=0)break;if(ca=da,!(ca>>>0>=fa>>>0&ca>>>0<ba>>>0))break;$[ga>>2]=ha+aa,ca=$[234]|0,X=($[231]|0)+aa|0,Y=ca,V=ca+8|0,ia=(V&7|0)==0?0:-V&7,V=X-ia|0,$[234]=Y+ia,$[231]=V,$[Y+(ia+4)>>2]=V|1,$[Y+(X+4)>>2]=40,$[235]=$[226];break a}while(0);for(ba>>>0<($[232]|0)>>>0&&($[232]=ba),R=ba+aa|0,X=1360;;){if(ja=X|0,($[ja>>2]|0)==(R|0)){S=901;break}if(Y=$[X+8>>2]|0,(Y|0)==0)break;X=Y}do if((S|0)==901){if(($[X+12>>2]&8|0)!=0)break;$[ja>>2]=ba,R=X+4|0,$[R>>2]=($[R>>2]|0)+aa,R=ba+8|0,ka=(R&7|0)==0?0:-R&7,R=ba+(aa+8)|0,la=(R&7|0)==0?0:-R&7,R=ba+(la+aa)|0,Y=R,V=ka+n|0,ca=ba+V|0,Z=ca,J=R-(ba+ka)-n|0,$[ba+(ka+4)>>2]=n|3;do{if((Y|0)!=($[234]|0)){if((Y|0)==($[233]|0)){I=($[230]|0)+J|0,$[230]=I,$[233]=Z,$[ba+(V+4)>>2]=I|1,$[ba+(I+V)>>2]=I;break}if(I=aa+4|0,W=$[ba+(la+I)>>2]|0,(W&3|0)==1){_=W&-8,U=W>>>3;b:do{if(!(W>>>0<256)){Q=R,l=$[ba+((la|24)+aa)>>2]|0,O=$[ba+(aa+12+la)>>2]|0;do{if((O|0)==(Q|0)){if(N=la|16,f=ba+(N+I)|0,K=$[f>>2]|0,(K|0)==0){if(d=ba+(N+aa)|0,N=$[d>>2]|0,(N|0)==0){na=0;break}oa=N,pa=d}else oa=K,pa=f;for(;;)if(f=oa+20|0,K=$[f>>2]|0,(K|0)==0){if(f=oa+16|0,K=$[f>>2]|0,(K|0)==0)break;oa=K,pa=f}else oa=K,pa=f;if(pa>>>0<($[232]|0)>>>0)return ra(),0;$[pa>>2]=0,na=oa;break}if(f=$[ba+((la|8)+aa)>>2]|0,f>>>0<($[232]|0)>>>0)return ra(),0;if(K=f+12|0,($[K>>2]|0)!=(Q|0))return ra(),0;if(d=O+8|0,($[d>>2]|0)==(Q|0)){$[K>>2]=O,$[d>>2]=f,na=O;break}return ra(),0}while(0);if((l|0)==0)break;O=ba+(aa+28+la)|0,T=1216+($[O>>2]<<2)|0;do{if((Q|0)==($[T>>2]|0)){if($[T>>2]=na,(na|0)!=0)break;$[229]=$[229]&~(1<<$[O>>2]);break b}if(l>>>0<($[232]|0)>>>0)return ra(),0;if(P=l+16|0,($[P>>2]|0)==(Q|0)?$[P>>2]=na:$[l+20>>2]=na,(na|0)==0)break b}while(0);if(na>>>0<($[232]|0)>>>0)return ra(),0;$[na+24>>2]=l,Q=la|16,O=$[ba+(Q+aa)>>2]|0;do if((O|0)!=0){if(O>>>0<($[232]|0)>>>0)return ra(),0;$[na+16>>2]=O,$[O+24>>2]=na;break}while(0);if(O=$[ba+(Q+I)>>2]|0,(O|0)==0)break;if(O>>>0<($[232]|0)>>>0)return ra(),0;$[na+20>>2]=O,$[O+24>>2]=na;break}T=$[ba+((la|8)+aa)>>2]|0,P=$[ba+(aa+12+la)>>2]|0,Q=952+(U<<1<<2)|0;do if((T|0)!=(Q|0)){if(T>>>0<($[232]|0)>>>0)return ra(),0;if(($[T+12>>2]|0)==(Y|0))break;return ra(),0}while(0);if((P|0)==(T|0)){$[228]=$[228]&~(1<<U);break}do{if((P|0)!=(Q|0)){if(P>>>0<($[232]|0)>>>0)return ra(),0;if(l=P+8|0,($[l>>2]|0)==(Y|0)){ma=l;break}return ra(),0}ma=P+8|0}while(0);$[T+12>>2]=P,$[ma>>2]=T}while(0);qa=ba+((_|la)+aa)|0,sa=_+J|0}else qa=Y,sa=J;if(I=qa+4|0,$[I>>2]=$[I>>2]&-2,$[ba+(V+4)>>2]=sa|1,$[ba+(sa+V)>>2]=sa,I=sa>>>3,sa>>>0<256){U=I<<1,W=952+(U<<2)|0,O=$[228]|0,l=1<<I;do{if((O&l|0)!=0){if(I=952+(U+2<<2)|0,T=$[I>>2]|0,T>>>0>=($[232]|0)>>>0){ua=T,ya=I;break}return ra(),0}$[228]=O|l,ua=W,ya=952+(U+2<<2)|0}while(0);$[ya>>2]=Z,$[ua+12>>2]=Z,$[ba+(V+8)>>2]=ua,$[ba+(V+12)>>2]=W;break}U=ca,l=sa>>>8;do if((l|0)==0)za=0;else{if(sa>>>0>16777215){za=31;break}O=(l+1048320|0)>>>16&8,_=l<<O,I=(_+520192|0)>>>16&4,T=_<<I,_=(T+245760|0)>>>16&2,P=14-(I|O|_)+(T<<_>>>15)|0,za=sa>>>((P+7|0)>>>0)&1|P<<1}while(0);if(l=1216+(za<<2)|0,$[ba+(V+28)>>2]=za,$[ba+(V+20)>>2]=0,$[ba+(V+16)>>2]=0,W=$[229]|0,P=1<<za,(W&P|0)==0){$[229]=W|P,$[l>>2]=U,$[ba+(V+24)>>2]=l,$[ba+(V+12)>>2]=U,$[ba+(V+8)>>2]=U;break}for(Aa=(za|0)==31?0:25-(za>>>1)|0,P=sa<<Aa,W=$[l>>2]|0;;){if(($[W+4>>2]&-8|0)==(sa|0))break;if(Ba=W+16+(P>>>31<<2)|0,l=$[Ba>>2]|0,(l|0)==0){S=974;break}P<<=1,W=l}if((S|0)==974){if(Ba>>>0<($[232]|0)>>>0)return ra(),0;$[Ba>>2]=U,$[ba+(V+24)>>2]=W,$[ba+(V+12)>>2]=U,$[ba+(V+8)>>2]=U;break}if(P=W+8|0,l=$[P>>2]|0,_=$[232]|0,W>>>0<_>>>0)return ra(),0;if(l>>>0<_>>>0)return ra(),0;$[l+12>>2]=U,$[P>>2]=U,$[ba+(V+8)>>2]=l,$[ba+(V+12)>>2]=W,$[ba+(V+24)>>2]=0;break}I=($[231]|0)+J|0,$[231]=I,$[234]=Z,$[ba+(V+4)>>2]=I|1}while(0);return m=ba+(ka|8)|0,m|0}while(0);for(X=da,V=1360;;){if(Ca=$[V>>2]|0,Ca>>>0<=X>>>0&&(Da=$[V+4>>2]|0,Ea=Ca+Da|0,Ea>>>0>X>>>0))break;V=$[V+8>>2]|0}if(V=Ca+(Da-39)|0,Fa=(V&7|0)==0?0:-V&7,V=Ca+(Da-47+Fa)|0,ca=V>>>0<(da+16|0)>>>0?X:V,V=ca+8|0,Z=ba+8|0,Ga=(Z&7|0)==0?0:-Z&7,Z=aa-40-Ga|0,$[234]=ba+Ga,$[231]=Z,$[ba+(Ga+4)>>2]=Z|1,$[ba+(aa-36)>>2]=40,$[235]=$[226],$[ca+4>>2]=27,$[V>>2]=$[340],$[V+4>>2]=$[341],$[V+8>>2]=$[342],$[V+12>>2]=$[343],$[340]=ba,$[341]=aa,$[343]=0,$[342]=V,V=ca+28|0,$[V>>2]=7,(ca+32|0)>>>0<Ea>>>0)for(Z=V;;){if(V=Z+4|0,$[V>>2]=7,!((Z+8|0)>>>0<Ea>>>0))break;Z=V}if((ca|0)==(X|0))break;if(Z=ca-da|0,V=X+(Z+4)|0,$[V>>2]=$[V>>2]&-2,$[da+4>>2]=Z|1,$[X+Z>>2]=Z,V=Z>>>3,Z>>>0<256){J=V<<1,Y=952+(J<<2)|0,R=$[228]|0,l=1<<V;do{if((R&l|0)!=0){if(V=952+(J+2<<2)|0,P=$[V>>2]|0,P>>>0>=($[232]|0)>>>0){Ha=P,Ia=V;break}return ra(),0}$[228]=R|l,Ha=Y,Ia=952+(J+2<<2)|0}while(0);$[Ia>>2]=da,$[Ha+12>>2]=da,$[da+8>>2]=Ha,$[da+12>>2]=Y;break}J=da,l=Z>>>8;do if((l|0)==0)Ja=0;else{if(Z>>>0>16777215){Ja=31;break}R=(l+1048320|0)>>>16&8,X=l<<R,ca=(X+520192|0)>>>16&4,V=X<<ca,X=(V+245760|0)>>>16&2,P=14-(ca|R|X)+(V<<X>>>15)|0,Ja=Z>>>((P+7|0)>>>0)&1|P<<1}while(0);if(l=1216+(Ja<<2)|0,$[da+28>>2]=Ja,$[da+20>>2]=0,$[da+16>>2]=0,Y=$[229]|0,P=1<<Ja,(Y&P|0)==0){$[229]=Y|P,$[l>>2]=J,$[da+24>>2]=l,$[da+12>>2]=da,$[da+8>>2]=da;break}for(Ka=(Ja|0)==31?0:25-(Ja>>>1)|0,P=Z<<Ka,Y=$[l>>2]|0;;){if(($[Y+4>>2]&-8|0)==(Z|0))break;if(La=Y+16+(P>>>31<<2)|0,l=$[La>>2]|0,(l|0)==0){S=1009;break}P<<=1,Y=l}if((S|0)==1009){if(La>>>0<($[232]|0)>>>0)return ra(),0;$[La>>2]=J,$[da+24>>2]=Y,$[da+12>>2]=da,$[da+8>>2]=da;break}if(P=Y+8|0,Z=$[P>>2]|0,l=$[232]|0,Y>>>0<l>>>0)return ra(),0;if(Z>>>0<l>>>0)return ra(),0;$[Z+12>>2]=J,$[P>>2]=J,$[da+8>>2]=Z,$[da+12>>2]=Y,$[da+24>>2]=0;break}R=$[232]|0,(R|0)==0|ba>>>0<R>>>0&&($[232]=ba),$[340]=ba,$[341]=aa,$[343]=0,$[237]=$[222],$[236]=-1,R=0;do X=R<<1,ca=952+(X<<2)|0,$[952+(X+3<<2)>>2]=ca,$[952+(X+2<<2)>>2]=ca,R=R+1|0;while(R>>>0<32);R=ba+8|0,ea=(R&7|0)==0?0:-R&7,R=aa-40-ea|0,$[234]=ba+ea,$[231]=R,$[ba+(ea+4)>>2]=R|1,$[ba+(aa-36)>>2]=40,$[235]=$[226]}while(0);if(da=$[231]|0,da>>>0<=n>>>0)break;return Z=da-n|0,$[231]=Z,da=$[234]|0,P=da,$[234]=P+n,$[P+(n+4)>>2]=Z|1,$[da+4>>2]=n|3,m=da+8|0,m|0}while(0);return $[(wa()|0)>>2]=12,m=0,m|0}function K(a){a|=0;var b=0,c=0,d=0,e=0,f=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0,x=0,y=0,z=0,A=0,B=0,C=0,D=0,E=0,F=0,G=0,H=0,I=0,J=0,K=0,L=0,M=0,N=0;if((a|0)!=0){b=a-8|0,c=b,d=$[232]|0,b>>>0<d>>>0&&ra(),e=$[a-4>>2]|0,f=e&3,(f|0)==1&&ra(),g=e&-8,h=a+(g-8)|0,i=h;a:do if((e&1|0)==0){if(j=$[b>>2]|0,(f|0)==0)return;if(k=-8-j|0,l=a+k|0,m=l,n=j+g|0,l>>>0<d>>>0&&ra(),(m|0)==($[233]|0)){if(o=a+(g-4)|0,($[o>>2]&3|0)!=3){p=m,q=n;break}return $[230]=n,$[o>>2]=$[o>>2]&-2,$[a+(k+4)>>2]=n|1,void($[h>>2]=n)}if(o=j>>>3,j>>>0<256){j=$[a+(k+8)>>2]|0,r=$[a+(k+12)>>2]|0,s=952+(o<<1<<2)|0;do if((j|0)!=(s|0)){if(j>>>0<d>>>0&&ra(),($[j+12>>2]|0)==(m|0))break;ra()}while(0);if((r|0)==(j|0)){$[228]=$[228]&~(1<<o),p=m,q=n;break}do if((r|0)==(s|0))t=r+8|0;else{if(r>>>0<d>>>0&&ra(),u=r+8|0,($[u>>2]|0)==(m|0)){t=u;break}ra()}while(0);$[j+12>>2]=r,$[t>>2]=j,p=m,q=n;break}s=l,o=$[a+(k+24)>>2]|0,u=$[a+(k+12)>>2]|0;do if((u|0)==(s|0)){if(v=a+(k+20)|0,w=$[v>>2]|0,(w|0)==0){if(x=a+(k+16)|0,y=$[x>>2]|0,(y|0)==0){z=0;break}A=y,B=x}else A=w,B=v;for(;;)if(v=A+20|0,w=$[v>>2]|0,(w|0)==0){if(v=A+16|0,w=$[v>>2]|0,(w|0)==0)break;A=w,B=v}else A=w,B=v;if(!(B>>>0<d>>>0)){$[B>>2]=0,z=A;break}ra()}else{if(v=$[a+(k+8)>>2]|0,v>>>0<d>>>0&&ra(),w=v+12|0,($[w>>2]|0)!=(s|0)&&ra(),x=u+8|0,($[x>>2]|0)==(s|0)){$[w>>2]=u,$[x>>2]=v,z=u;break}ra()}while(0);if((o|0)==0){p=m,q=n;break}u=a+(k+28)|0,l=1216+($[u>>2]<<2)|0;do{if((s|0)==($[l>>2]|0)){if($[l>>2]=z,(z|0)!=0)break;$[229]=$[229]&~(1<<$[u>>2]),p=m,q=n;break a}if(o>>>0<($[232]|0)>>>0&&ra(),j=o+16|0,($[j>>2]|0)==(s|0)?$[j>>2]=z:$[o+20>>2]=z,(z|0)==0){p=m,q=n;break a}}while(0);z>>>0<($[232]|0)>>>0&&ra(),$[z+24>>2]=o,s=$[a+(k+16)>>2]|0;do if((s|0)!=0){if(!(s>>>0<($[232]|0)>>>0)){$[z+16>>2]=s,$[s+24>>2]=z;break}ra()}while(0);if(s=$[a+(k+20)>>2]|0,(s|0)==0){p=m,q=n;break}if(!(s>>>0<($[232]|0)>>>0)){$[z+20>>2]=s,$[s+24>>2]=z,p=m,q=n;break}ra()}else p=c,q=g;while(0);c=p,c>>>0>=h>>>0&&ra(),z=a+(g-4)|0,d=$[z>>2]|0,(d&1|0)==0&&ra();do{if((d&2|0)==0){if((i|0)==($[234]|0)){if(A=($[231]|0)+q|0,$[231]=A,$[234]=p,$[p+4>>2]=A|1,(p|0)!=($[233]|0))return;return $[233]=0,void($[230]=0)}if((i|0)==($[233]|0))return A=($[230]|0)+q|0,$[230]=A,$[233]=p,$[p+4>>2]=A|1,void($[c+A>>2]=A);A=(d&-8)+q|0,B=d>>>3;a:do if(d>>>0<256){t=$[a+g>>2]|0,f=$[a+(g|4)>>2]|0,b=952+(B<<1<<2)|0;do if((t|0)!=(b|0)){if(t>>>0<($[232]|0)>>>0&&ra(),($[t+12>>2]|0)==(i|0))break;ra()}while(0);if((f|0)==(t|0)){$[228]=$[228]&~(1<<B);break}do if((f|0)==(b|0))C=f+8|0;else{if(f>>>0<($[232]|0)>>>0&&ra(),e=f+8|0,($[e>>2]|0)==(i|0)){C=e;break}ra()}while(0);$[t+12>>2]=f,$[C>>2]=t}else{b=h,e=$[a+(g+16)>>2]|0,s=$[a+(g|4)>>2]|0;do if((s|0)==(b|0)){if(o=a+(g+12)|0,u=$[o>>2]|0,(u|0)==0){if(l=a+(g+8)|0,j=$[l>>2]|0,(j|0)==0){D=0;break}E=j,F=l}else E=u,F=o;for(;;)if(o=E+20|0,u=$[o>>2]|0,(u|0)==0){if(o=E+16|0,u=$[o>>2]|0,(u|0)==0)break;E=u,F=o}else E=u,F=o;if(!(F>>>0<($[232]|0)>>>0)){$[F>>2]=0,D=E;break}ra()}else{if(o=$[a+g>>2]|0,o>>>0<($[232]|0)>>>0&&ra(),u=o+12|0,($[u>>2]|0)!=(b|0)&&ra(),l=s+8|0,($[l>>2]|0)==(b|0)){$[u>>2]=s,$[l>>2]=o,D=s;break}ra()}while(0);if((e|0)==0)break;s=a+(g+20)|0,t=1216+($[s>>2]<<2)|0;do{if((b|0)==($[t>>2]|0)){if($[t>>2]=D,(D|0)!=0)break;$[229]=$[229]&~(1<<$[s>>2]);break a}if(e>>>0<($[232]|0)>>>0&&ra(),f=e+16|0,($[f>>2]|0)==(b|0)?$[f>>2]=D:$[e+20>>2]=D,(D|0)==0)break a}while(0);D>>>0<($[232]|0)>>>0&&ra(),$[D+24>>2]=e,b=$[a+(g+8)>>2]|0;do if((b|0)!=0){if(!(b>>>0<($[232]|0)>>>0)){$[D+16>>2]=b,$[b+24>>2]=D;break}ra()}while(0);if(b=$[a+(g+12)>>2]|0,(b|0)==0)break;if(!(b>>>0<($[232]|0)>>>0)){$[D+20>>2]=b,$[b+24>>2]=D;break}ra()}while(0);if($[p+4>>2]=A|1,$[c+A>>2]=A,(p|0)!=($[233]|0)){G=A;break}return void($[230]=A)}$[z>>2]=d&-2,$[p+4>>2]=q|1,$[c+q>>2]=q,G=q}while(0);if(q=G>>>3,G>>>0<256){c=q<<1,d=952+(c<<2)|0,z=$[228]|0,D=1<<q;do if((z&D|0)==0)$[228]=z|D,H=d,I=952+(c+2<<2)|0;else{if(q=952+(c+2<<2)|0,g=$[q>>2]|0,g>>>0>=($[232]|0)>>>0){H=g,I=q;break}ra()}while(0);return $[I>>2]=p,$[H+12>>2]=p,$[p+8>>2]=H,void($[p+12>>2]=d)}d=p,H=G>>>8;do if((H|0)==0)J=0;else{if(G>>>0>16777215){J=31;break}I=(H+1048320|0)>>>16&8,c=H<<I,D=(c+520192|0)>>>16&4,z=c<<D,c=(z+245760|0)>>>16&2,q=14-(D|I|c)+(z<<c>>>15)|0,J=G>>>((q+7|0)>>>0)&1|q<<1}while(0);H=1216+(J<<2)|0,$[p+28>>2]=J,$[p+20>>2]=0,$[p+16>>2]=0,q=$[229]|0,c=1<<J;do if((q&c|0)==0)$[229]=q|c,$[H>>2]=d,$[p+24>>2]=H,$[p+12>>2]=p,$[p+8>>2]=p;else{for(K=(J|0)==31?0:25-(J>>>1)|0,z=G<<K,I=$[H>>2]|0;;){if(($[I+4>>2]&-8|0)==(G|0))break;if(L=I+16+(z>>>31<<2)|0,D=$[L>>2]|0,(D|0)==0){M=1186;break}z<<=1,I=D}if((M|0)==1186){if(!(L>>>0<($[232]|0)>>>0)){$[L>>2]=d,$[p+24>>2]=I,$[p+12>>2]=p,$[p+8>>2]=p;break}ra()}if(z=I+8|0,A=$[z>>2]|0,D=$[232]|0,I>>>0<D>>>0&&ra(),!(A>>>0<D>>>0)){$[A+12>>2]=d,$[z>>2]=d,$[p+8>>2]=A,$[p+12>>2]=I,$[p+24>>2]=0;break}ra()}while(0);if(p=($[236]|0)-1|0,$[236]=p,(p|0)==0){for(N=1368;;){if(p=$[N>>2]|0,(p|0)==0)break;N=p+8|0}$[236]=-1}}}function L(a,b){a|=0,b|=0;var c=0,d=0,e=0,f=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0,x=0,y=0,z=0,A=0,B=0,C=0,D=0,E=0,F=0,G=0;if((a|0)==0)return c=J(b)|0,c|0;if(b>>>0>4294967231)return $[(wa()|0)>>2]=12,c=0,c|0;if(d=b>>>0<11?16:b+11&-8,e=a-8|0,f=a-4|0,g=$[f>>2]|0,h=g&-8,i=h-8|0,j=a+i|0,k=j,l=$[232]|0,e>>>0<l>>>0)return ra(),0;if(m=g&3,!((m|0)!=1&(i|0)>-8))return ra(),0;if(i=h|4,n=a+(i-8)|0,o=$[n>>2]|0,(o&1|0)==0)return ra(),0;a:do{if((m|0)==0){if(d>>>0<256|h>>>0<(d|4)>>>0)break;if((h-d|0)>>>0>$[224]<<1>>>0|(e|0)==0)break;return c=a,c|0}do{if(h>>>0<d>>>0){if((k|0)==($[234]|0)){if(p=($[231]|0)+h|0,p>>>0<=d>>>0)break a;q=p-d|0,$[f>>2]=g&1|d|2,$[a+((d|4)-8)>>2]=q|1,$[234]=a+(d-8),$[231]=q;break}if((k|0)==($[233]|0)){if(q=($[230]|0)+h|0,q>>>0<d>>>0)break a;p=q-d|0,p>>>0>15?($[f>>2]=g&1|d|2,$[a+((d|4)-8)>>2]=p|1,$[a+(q-8)>>2]=p,r=a+(q-4)|0,$[r>>2]=$[r>>2]&-2,s=a+(d-8)|0,t=p):($[f>>2]=g&1|q|2,p=a+(q-4)|0,$[p>>2]=$[p>>2]|1,s=0,t=0),$[230]=t,$[233]=s;break}if((o&2|0)!=0)break a;if(p=(o&-8)+h|0,p>>>0<d>>>0)break a;q=p-d|0,r=o>>>3;b:do{if(!(o>>>0<256)){w=j,y=$[a+(h+16)>>2]|0,z=$[a+i>>2]|0;do{if((z|0)==(w|0)){if(A=a+(h+12)|0,B=$[A>>2]|0,(B|0)==0){if(C=a+(h+8)|0,D=$[C>>2]|0,(D|0)==0){E=0;break}F=D,G=C}else F=B,G=A;for(;;)if(A=F+20|0,B=$[A>>2]|0,(B|0)==0){if(A=F+16|0,B=$[A>>2]|0,(B|0)==0)break;F=B,G=A}else F=B,G=A;if(G>>>0<l>>>0)return ra(),0;$[G>>2]=0,E=F;break}if(A=$[a+h>>2]|0,A>>>0<l>>>0)return ra(),0;if(B=A+12|0,($[B>>2]|0)!=(w|0))return ra(),0;if(C=z+8|0,($[C>>2]|0)==(w|0)){$[B>>2]=z,$[C>>2]=A,E=z;break}return ra(),0}while(0);if((y|0)==0)break;z=a+(h+20)|0,u=1216+($[z>>2]<<2)|0;do{if((w|0)==($[u>>2]|0)){if($[u>>2]=E,(E|0)!=0)break;$[229]=$[229]&~(1<<$[z>>2]);break b}if(y>>>0<($[232]|0)>>>0)return ra(),0;if(v=y+16|0,($[v>>2]|0)==(w|0)?$[v>>2]=E:$[y+20>>2]=E,(E|0)==0)break b}while(0);if(E>>>0<($[232]|0)>>>0)return ra(),0;$[E+24>>2]=y,w=$[a+(h+8)>>2]|0;do if((w|0)!=0){if(w>>>0<($[232]|0)>>>0)return ra(),0;$[E+16>>2]=w,$[w+24>>2]=E;break}while(0);if(w=$[a+(h+12)>>2]|0,(w|0)==0)break;if(w>>>0<($[232]|0)>>>0)return ra(),0;$[E+20>>2]=w,$[w+24>>2]=E;break}u=$[a+h>>2]|0,v=$[a+i>>2]|0,w=952+(r<<1<<2)|0;do if((u|0)!=(w|0)){if(u>>>0<l>>>0)return ra(),0;if(($[u+12>>2]|0)==(k|0))break;return ra(),0}while(0);if((v|0)==(u|0)){$[228]=$[228]&~(1<<r);break}do{if((v|0)!=(w|0)){if(v>>>0<l>>>0)return ra(),0;if(y=v+8|0,($[y>>2]|0)==(k|0)){x=y;break}return ra(),0}x=v+8|0}while(0);$[u+12>>2]=v,$[x>>2]=u}while(0);if(q>>>0>=16){$[f>>2]=$[f>>2]&1|d|2,$[a+((d|4)-8)>>2]=q|3,r=a+((p|4)-8)|0,$[r>>2]=$[r>>2]|1,M(a+(d-8)|0,q);break}return $[f>>2]=p|$[f>>2]&1|2,r=a+((p|4)-8)|0,$[r>>2]=$[r>>2]|1,c=a,c|0}if(r=h-d|0,r>>>0<=15)break;return $[f>>2]=g&1|d|2,$[a+((d|4)-8)>>2]=r|3,$[n>>2]=$[n>>2]|1,M(a+(d-8)|0,r),c=a,c|0}while(0);if((e|0)==0)break;return c=a,c|0}while(0);return e=J(b)|0,(e|0)==0?(c=0,c|0):(d=$[f>>2]|0,f=(d&-8)-((d&3|0)==0?8:4)|0,d=f>>>0<b>>>0?f:b,P(e|0,a|0,d)|0,K(a),c=e,c|0)}function M(a,b){a|=0,b|=0;var c=0,d=0,e=0,f=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0,x=0,y=0,z=0,A=0,B=0,C=0,D=0,E=0,F=0,G=0,H=0,I=0,J=0,K=0;c=a,d=c+b|0,e=d,f=$[a+4>>2]|0;a:do if((f&1|0)==0){if(g=$[a>>2]|0,(f&3|0)==0)return;if(h=c+(-g|0)|0,i=h,j=g+b|0,k=$[232]|0,h>>>0<k>>>0&&ra(),(i|0)==($[233]|0)){if(l=c+(b+4)|0,($[l>>2]&3|0)!=3){m=i,n=j;break}return $[230]=j,$[l>>2]=$[l>>2]&-2,$[c+(4-g)>>2]=j|1,void($[d>>2]=j)}if(l=g>>>3,g>>>0<256){o=$[c+(8-g)>>2]|0,p=$[c+(12-g)>>2]|0,q=952+(l<<1<<2)|0;do if((o|0)!=(q|0)){if(o>>>0<k>>>0&&ra(),($[o+12>>2]|0)==(i|0))break;ra()}while(0);if((p|0)==(o|0)){$[228]=$[228]&~(1<<l),m=i,n=j;break}do if((p|0)==(q|0))r=p+8|0;else{if(p>>>0<k>>>0&&ra(),s=p+8|0,($[s>>2]|0)==(i|0)){r=s;break}ra()}while(0);$[o+12>>2]=p,$[r>>2]=o,m=i,n=j;break}q=h,l=$[c+(24-g)>>2]|0,s=$[c+(12-g)>>2]|0;do if((s|0)==(q|0)){if(t=16-g|0,u=c+(t+4)|0,v=$[u>>2]|0,(v|0)==0){if(w=c+t|0,t=$[w>>2]|0,(t|0)==0){x=0;break}y=t,z=w}else y=v,z=u;for(;;)if(u=y+20|0,v=$[u>>2]|0,(v|0)==0){if(u=y+16|0,v=$[u>>2]|0,(v|0)==0)break;y=v,z=u}else y=v,z=u;if(!(z>>>0<k>>>0)){$[z>>2]=0,x=y;break}ra()}else{if(u=$[c+(8-g)>>2]|0,u>>>0<k>>>0&&ra(),v=u+12|0,($[v>>2]|0)!=(q|0)&&ra(),w=s+8|0,($[w>>2]|0)==(q|0)){$[v>>2]=s,$[w>>2]=u,x=s;break}ra()}while(0);if((l|0)==0){m=i,n=j;break}s=c+(28-g)|0,k=1216+($[s>>2]<<2)|0;do{if((q|0)==($[k>>2]|0)){if($[k>>2]=x,(x|0)!=0)break;$[229]=$[229]&~(1<<$[s>>2]),m=i,n=j;break a}if(l>>>0<($[232]|0)>>>0&&ra(),h=l+16|0,($[h>>2]|0)==(q|0)?$[h>>2]=x:$[l+20>>2]=x,(x|0)==0){m=i,n=j;break a}}while(0);x>>>0<($[232]|0)>>>0&&ra(),$[x+24>>2]=l,q=16-g|0,s=$[c+q>>2]|0;do if((s|0)!=0){if(!(s>>>0<($[232]|0)>>>0)){$[x+16>>2]=s,$[s+24>>2]=x;break}ra()}while(0);if(s=$[c+(q+4)>>2]|0,(s|0)==0){m=i,n=j;break}if(!(s>>>0<($[232]|0)>>>0)){$[x+20>>2]=s,$[s+24>>2]=x,m=i,n=j;break}ra()}else m=a,n=b;while(0);a=$[232]|0,d>>>0<a>>>0&&ra(),x=c+(b+4)|0,y=$[x>>2]|0;do{if((y&2|0)==0){if((e|0)==($[234]|0)){if(z=($[231]|0)+n|0,$[231]=z,$[234]=m,$[m+4>>2]=z|1,(m|0)!=($[233]|0))return;return $[233]=0,void($[230]=0)}if((e|0)==($[233]|0))return z=($[230]|0)+n|0,$[230]=z,$[233]=m,$[m+4>>2]=z|1,void($[m+z>>2]=z);z=(y&-8)+n|0,r=y>>>3;a:do if(y>>>0<256){f=$[c+(b+8)>>2]|0,s=$[c+(b+12)>>2]|0,g=952+(r<<1<<2)|0;do if((f|0)!=(g|0)){if(f>>>0<a>>>0&&ra(),($[f+12>>2]|0)==(e|0))break;ra()}while(0);if((s|0)==(f|0)){$[228]=$[228]&~(1<<r);break}do if((s|0)==(g|0))A=s+8|0;else{if(s>>>0<a>>>0&&ra(),l=s+8|0,($[l>>2]|0)==(e|0)){A=l;break}ra()}while(0);$[f+12>>2]=s,$[A>>2]=f}else{g=d,l=$[c+(b+24)>>2]|0,k=$[c+(b+12)>>2]|0;do if((k|0)==(g|0)){if(h=c+(b+20)|0,o=$[h>>2]|0,(o|0)==0){if(p=c+(b+16)|0,u=$[p>>2]|0,(u|0)==0){B=0;break}C=u,D=p}else C=o,D=h;for(;;)if(h=C+20|0,o=$[h>>2]|0,(o|0)==0){if(h=C+16|0,o=$[h>>2]|0,(o|0)==0)break;C=o,D=h}else C=o,D=h;if(!(D>>>0<a>>>0)){$[D>>2]=0,B=C;break}ra()}else{if(h=$[c+(b+8)>>2]|0,h>>>0<a>>>0&&ra(),o=h+12|0,($[o>>2]|0)!=(g|0)&&ra(),p=k+8|0,($[p>>2]|0)==(g|0)){$[o>>2]=k,$[p>>2]=h,B=k;break}ra()}while(0);if((l|0)==0)break;k=c+(b+28)|0,f=1216+($[k>>2]<<2)|0;do{if((g|0)==($[f>>2]|0)){if($[f>>2]=B,(B|0)!=0)break;$[229]=$[229]&~(1<<$[k>>2]);break a}if(l>>>0<($[232]|0)>>>0&&ra(),s=l+16|0,($[s>>2]|0)==(g|0)?$[s>>2]=B:$[l+20>>2]=B,(B|0)==0)break a}while(0);B>>>0<($[232]|0)>>>0&&ra(),$[B+24>>2]=l,g=$[c+(b+16)>>2]|0;do if((g|0)!=0){if(!(g>>>0<($[232]|0)>>>0)){$[B+16>>2]=g,$[g+24>>2]=B;break}ra()}while(0);if(g=$[c+(b+20)>>2]|0,(g|0)==0)break;if(!(g>>>0<($[232]|0)>>>0)){$[B+20>>2]=g,$[g+24>>2]=B;break}ra()}while(0);if($[m+4>>2]=z|1,$[m+z>>2]=z,(m|0)!=($[233]|0)){E=z;break}return void($[230]=z)}$[x>>2]=y&-2,$[m+4>>2]=n|1,$[m+n>>2]=n,E=n}while(0);if(n=E>>>3,E>>>0<256){y=n<<1,x=952+(y<<2)|0,B=$[228]|0,b=1<<n;do if((B&b|0)==0)$[228]=B|b,F=x,G=952+(y+2<<2)|0;else{if(n=952+(y+2<<2)|0,c=$[n>>2]|0,c>>>0>=($[232]|0)>>>0){F=c,G=n;break}ra()}while(0);return $[G>>2]=m,$[F+12>>2]=m,$[m+8>>2]=F,void($[m+12>>2]=x)}x=m,F=E>>>8;do if((F|0)==0)H=0;else{if(E>>>0>16777215){H=31;break}G=(F+1048320|0)>>>16&8,y=F<<G,b=(y+520192|0)>>>16&4,B=y<<b,y=(B+245760|0)>>>16&2,n=14-(b|G|y)+(B<<y>>>15)|0,H=E>>>((n+7|0)>>>0)&1|n<<1}while(0);if(F=1216+(H<<2)|0,$[m+28>>2]=H,$[m+20>>2]=0,$[m+16>>2]=0,n=$[229]|0,y=1<<H,(n&y|0)==0)return $[229]=n|y,$[F>>2]=x,$[m+24>>2]=F,$[m+12>>2]=m,void($[m+8>>2]=m);for(I=(H|0)==31?0:25-(H>>>1)|0,H=E<<I,I=$[F>>2]|0;;){if(($[I+4>>2]&-8|0)==(E|0))break;if(J=I+16+(H>>>31<<2)|0,F=$[J>>2]|0,(F|0)==0){K=1452;break}H<<=1,I=F}return(K|0)==1452?(J>>>0<($[232]|0)>>>0&&ra(),$[J>>2]=x,$[m+24>>2]=I,$[m+12>>2]=m,void($[m+8>>2]=m)):(J=I+8|0,K=$[J>>2]|0,H=$[232]|0,I>>>0<H>>>0&&ra(),K>>>0<H>>>0&&ra(),$[K+12>>2]=x,$[J>>2]=x,$[m+8>>2]=K,$[m+12>>2]=I,void($[m+24>>2]=0))}function N(a){a|=0;var b=0;for(b=a;Y[b]|0;)b=b+1|0;return b-a|0}function O(a,b,c){a|=0,b|=0,c|=0;var d=0,e=0,f=0;if(d=a+c|0,(c|0)>=20){if(b&=255,c=a&3,e=b|b<<8|b<<16|b<<24,f=d&-4,c)for(c=a+4-c|0;(a|0)<(c|0);)Y[a]=b,a=a+1|0;for(;(a|0)<(f|0);)$[a>>2]=e,a=a+4|0}for(;(a|0)<(d|0);)Y[a]=b,a=a+1|0}function P(a,b,c){a|=0,b|=0,c|=0;var d=0;if(d=a|0,(a&3)==(b&3)){for(;a&3;){if((c|0)==0)return d|0;Y[a]=Y[b]|0,a=a+1|0,b=b+1|0,c=c-1|0}for(;(c|0)>=4;)$[a>>2]=$[b>>2],a=a+4|0,b=b+4|0,c=c-4|0}for(;(c|0)>0;)Y[a]=Y[b]|0,a=a+1|0,b=b+1|0,c=c-1|0;return d|0}function Q(a,b){return a|=0,b|=0,ya[a&1](b|0)|0}function R(a){a|=0,za[a&1]()}function S(a,b,c){return a|=0,b|=0,c|=0,Aa[a&1](b|0,c|0)|0}function T(a,b){a|=0,b|=0,Ba[a&1](b|0)}function U(a){return a|=0,qa(0),0}function V(){qa(1)}function W(a,b){return a|=0,b|=0,qa(2),0}function X(a){a|=0,qa(3)}var Y=new a.Int8Array(c),Z=new a.Int16Array(c),$=new a.Int32Array(c),_=new a.Uint8Array(c),aa=new a.Uint16Array(c),ba=(new a.Uint32Array(c),new a.Float32Array(c),new a.Float64Array(c),b.STACKTOP|0),ca=(b.STACK_MAX|0,b.tempDoublePtr|0),da=(b.ABORT|0,+b.NaN,+b.Infinity,0),ea=0,fa=0,ga=0,ha=0,ia=0,ja=0,ka=0,la=0,ma=0,na=0,oa=0,pa=(a.Math.floor,a.Math.abs,a.Math.sqrt,a.Math.pow,a.Math.cos,a.Math.sin,a.Math.tan,a.Math.acos,a.Math.asin,a.Math.atan,a.Math.atan2,a.Math.exp,a.Math.log,a.Math.ceil,a.Math.imul),qa=b.abort,ra=(b.assert,b.asmPrintInt,b.asmPrintFloat,b.min,b.invoke_ii,b.invoke_v,b.invoke_iii,b.invoke_vi,b._llvm_lifetime_end,b._snprintf,b._abort),sa=(b._fprintf,b._printf),ta=(b._fflush,b.__reallyNegative,b._sysconf),ua=(b.___setErrNo,b._fwrite,b._send,b._write,b._exit,b._sprintf),va=(b.__formatString,b.__ZSt9terminatev,b._pwrite,b._sbrk),wa=b.___errno_location,xa=(b.___gxx_personality_v0,b._llvm_lifetime_start,b._time),ya=(b.__exit,[U,U]),za=[V,V],Aa=[W,W],Ba=[X,X];return{_strlen:N,_crn_get_levels:D,_crn_get_uncompressed_size:G,_crn_decompress:H,_crn_get_width:B,_realloc:L,_crn_get_bytes_per_block:F,_memset:O,_malloc:J,_memcpy:P,_free:K,_crn_get_height:C,_crn_get_dxt_format:E,runPostSets:r,stackAlloc:d,stackSave:e,stackRestore:f,setThrew:g,setTempRet0:h,setTempRet1:i,setTempRet2:j,setTempRet3:k,setTempRet4:l,setTempRet5:m,setTempRet6:n,setTempRet7:o,setTempRet8:p,setTempRet9:q,dynCall_ii:Q,dynCall_v:R,dynCall_iii:S,dynCall_vi:T}}({Math:Math,Int8Array:Int8Array,Int16Array:Int16Array,Int32Array:Int32Array,Uint8Array:Uint8Array,Uint16Array:Uint16Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array},{abort:E,assert:A,asmPrintInt:function(a,b){s.print("int "+a+","+b)},asmPrintFloat:function(a,b){s.print("float "+a+","+b)},min:Ca,invoke_ii:function(a,b){try{return s.dynCall_ii(a,b)}catch(c){"number"!=typeof c&&"longjmp"!==c&&e(c),$.setThrew(1,0)}},invoke_v:function(a){try{s.dynCall_v(a)}catch(b){"number"!=typeof b&&"longjmp"!==b&&e(b),$.setThrew(1,0)}},invoke_iii:function(a,b,c){try{return s.dynCall_iii(a,b,c)}catch(d){"number"!=typeof d&&"longjmp"!==d&&e(d),$.setThrew(1,0)}},invoke_vi:function(a,b){try{s.dynCall_vi(a,b)}catch(c){"number"!=typeof c&&"longjmp"!==c&&e(c),$.setThrew(1,0)}},_llvm_lifetime_end:q(),_snprintf:nb,_abort:function(){s.abort()},_fprintf:jc,_printf:function(a,b){return jc(K[Cb>>2],a,b)},_fflush:q(),__reallyNegative:lb,_sysconf:function(a){switch(a){case 30:return 4096;case 132:case 133:case 12:case 137:case 138:case 15:case 235:case 16:case 17:case 18:case 19:case 20:case 149:case 13:case 10:case 236:case 153:case 9:case 21:case 22:case 159:case 154:case 14:case 77:case 78:case 139:case 80:case 81:case 79:case 82:case 68:case 67:case 164:case 11:case 29:case 47:case 48:case 95:case 52:case 51:case 46:return 200809;case 27:case 246:case 127:case 128:case 23:case 24:case 160:case 161:case 181:case 182:case 242:case 183:case 184:case 243:case 244:case 245:case 165:case 178:case 179:case 49:case 50:case 168:case 169:case 175:case 170:case 171:case 172:case 97:case 76:case 32:case 173:case 35:return-1;case 176:case 177:case 7:case 155:case 8:case 157:case 125:case 126:case 92:case 93:case 129:case 130:case 131:case 94:case 91:return 1;case 74:case 60:case 69:case 70:case 4:return 1024;case 31:case 42:case 72:return 32;case 87:case 26:case 33:return 2147483647;case 34:case 1:return 47839;case 38:case 36:return 99;case 43:case 37:return 2048;case 0:return 2097152;case 3:return 65536;case 28:return 32768;case 44:return 32767;case 75:return 16384;case 39:return 1e3;case 89:return 700;case 71:return 256;case 40:return 255;case 2:return 100;case 180:return 64;case 25:return 20;case 5:return 16;case 6:return 6;case 73:return 4;case 84:return 1}return S(R.u),-1},___setErrNo:S,_fwrite:ic,_send:function(a,b,c){return Z.ub(a)?hc(a,b,c):(S(R.ba),-1)},_write:hc,_exit:function(a){mc(a)},_sprintf:function(a,b,c){return nb(a,j,b,c)},__formatString:mb,__ZSt9terminatev:function(){mc(-1234)},_pwrite:function(a,b,c,d){if(a=X[a],!a)return S(R.ba),-1;try{return ac(a,I,b,c,d)}catch(e){return Jb(e),-1}},_sbrk:nc,___errno_location:function(){return pb},___gxx_personality_v0:q(),_llvm_lifetime_start:q(),_time:function(a){var b=Math.floor(Date.now()/1e3);return a&&(K[a>>2]=b),b},__exit:mc,STACKTOP:x,STACK_MAX:Sa,tempDoublePtr:jb,ABORT:ua,NaN:NaN,Infinity:1/0},N),kb=s._strlen=$._strlen;s._crn_get_levels=$._crn_get_levels,s._crn_get_uncompressed_size=$._crn_get_uncompressed_size,s._crn_decompress=$._crn_decompress,s._crn_get_width=$._crn_get_width,s._realloc=$._realloc,s._crn_get_bytes_per_block=$._crn_get_bytes_per_block;var kc=s._memset=$._memset,Ka=s._malloc=$._malloc,lc=s._memcpy=$._memcpy;s._free=$._free,s._crn_get_height=$._crn_get_height,s._crn_get_dxt_format=$._crn_get_dxt_format;var ib=s.runPostSets=$.runPostSets;s.dynCall_ii=$.dynCall_ii,s.dynCall_v=$.dynCall_v,s.dynCall_iii=$.dynCall_iii,s.dynCall_vi=$.dynCall_vi,oa=function(a){return $.stackAlloc(a)},ha=function(){return $.stackSave()},ia=function(a){$.stackRestore(a)},Ec.prototype=Error();var Fc,Gc=m,fb=function a(){!s.calledRun&&Ic&&Jc(),s.calledRun||(fb=a)};if(s.callMain=s.Nd=function(a){function b(){for(var a=0;3>a;a++)d.push(0)}A(0==Q,"cannot call main when async dependencies remain! (listen on __ATMAIN__)"),A(0==Va.length,"cannot call main when preRun functions remain to be called"),a=a||[],ba&&Gc!==m&&s.P("preload time: "+(Date.now()-Gc)+" ms"),Za||(Za=l,Ua(O));var c=a.length+1,d=[L(H("/bin/this.program"),"i8",0)];b();for(var f=0;c-1>f;f+=1)d.push(L(H(a[f]),"i8",0)),b();d.push(0),d=L(d,"i32",0),Fc=x;try{var g=s._main(c,d,0);s.noExitRuntime||Kc(g)}catch(h){h instanceof Ec||("SimulateInfiniteLoop"==h?s.noExitRuntime=l:(h&&"object"==typeof h&&h.stack&&s.P("exception thrown: "+[h,h.stack]),e(h)))}finally{}},s.run=s.ge=Jc,s.exit=s.Rd=Kc,s.abort=s.abort=E,s.preInit)for("function"==typeof s.preInit&&(s.preInit=[s.preInit]);0<s.preInit.length;)s.preInit.pop()();var Ic=l;return s.noInitialRun&&(Ic=p),Jc(),Module}function transformDirection(a,b){var c=a.x,d=a.y,e=a.z,f=b.elements;a.x=f[0]*c+f[4]*d+f[8]*e,a.y=f[1]*c+f[5]*d+f[9]*e,a.z=f[2]*c+f[6]*d+f[10]*e}function randomizeValue(a,b,c){return!MathUtils.isNumber(a)||!MathUtils.isNumber(b)||b>a?c:MathUtils.clamp(a+(b-a)*Math.random(),a,b)}function randomDeviant(a,b,c){var d=(new THREE.Quaternion).setFromAxisAngle(a,2*Math.random()*Math.PI);return c.applyQuaternion(d),d.setFromAxisAngle(c,b),a.applyQuaternion(d),a}!function(){if("undefined"==typeof window.performance&&(window.performance={}),!window.performance.now){var a=Date.now();performance.timing&&performance.timing.navigationStart&&(a=performance.timing.navigationStart),window.performance.now=function(){return Date.now()-a}}}();var Tundra={container:null,client:null,config:null,events:null,network:null,frame:null,console:null,asset:null,input:null,ui:null,scene:null,renderer:null,APINames:function(){return["Tundra","TundraClient","ConfigAPI","Network","FrameAPI","EventAPI","AssetAPI","InputAPI","UiAPI","ConsoleAPI","Scene"]},framework:{},Classes:{},pluginList:[],plugins:{},registerPlugin:function(a){if(void 0===a||null===a)return!1;a._setFramework(this),this.pluginList.push(a);var b=a.pluginPropertyName();return("string"!=typeof b||""===b)&&(b=a.name),"string"==typeof b&&""!==b&&(b=b.substring(0,1).toLowerCase()+b.substring(1),void 0===this.plugins[b]?this.plugins[b]=a:console.error("Plugin '"+a.name+"' property name '"+b+"' is already reserved in Tundra.plugins. Skipping registration.")),!0},plugin:function(a){for(var b=0;b<this.pluginList.length;b++){var c=this.pluginList[b];if(c.name===a)return c;if(Array.isArray(c.nameAliases)&&c.nameAliases.length>0)for(var d=0;d<c.nameAliases.length;d++)if(c.nameAliases[d]===a)return c}return null},pluginNames:function(){for(var a=[],b=0;b<this.pluginList.length;b++)try{a.push(this.pluginList[b].name)}catch(c){}return a},loadPlugins:function(a){var b;for(b=0;b<this.pluginList.length;b++)if(this.pluginList[b].loaded!==!0)try{var c=this.pluginList[b];console.log("[Tundra]: Loading",c.name),c._initialize($.extend({},a[c.name]))}catch(d){console.error("[Tundra]: Failed to initialize "+this.pluginList[b].name+":",d.toString()),console.error(d.stack||d)}for(b=0;b<Tundra.pluginList.length;b++)try{var c=this.pluginList[b];c._postInitialize($.extend({},a[c.name]))}catch(d){console.error("[Tundra]: Failed to postInitialize "+this.pluginList[b].name+":",d.toString()),console.error(d.stack||d)}},debugOnCheckFail:!1,throwOnCheckFail:!1,checkDefined:function(){if(Tundra.debugOnCheckFail||Tundra.throwOnCheckFail)for(var a=0;a<arguments.length;a++)if(void 0===arguments[a])if(Tundra.debugOnCheckFail);else if(Tundra.throwOnCheckFail)throw"undefined value, arg #"+a},check:function(){if(Tundra.debugOnCheckFail||Tundra.throwOnCheckFail)for(var a=0;a<arguments.length;a++)if(arguments[a]!==!0)if(Tundra.debugOnCheckFail);else if(Tundra.throwOnCheckFail)throw"untrue value"+arguments[a]+", arg #"+a},noop:function(){},getDefaultOptions:function(){return{requirejs:!1,polymer:!1,deprecatedWarnings:!1}},options:{},usingRequireJS:function(){return this.options.requirejs===!0&&"function"==typeof require},usingPolymer:function(){return this.options.polymer===!0&&"function"==typeof Polymer},resolvePolymerResources:function(a){console.warn("DEPRECATED: Tundra.resolvePolymerResources > AssetAPI.loadDependencies");var b=[];Array.isArray(a)||(a=[a]);for(var c=0;c<a.length;c++)this.asset.isRelativeRef(a[c])?b.push(this.asset.getLocalAssetPath(a[c])):b.push(a[c]);return b},browser:{isChrome:void 0!==navigator?navigator.userAgent.indexOf("Chrome")>-1:!1,isExplorer:void 0!==navigator?navigator.userAgent.indexOf("MSIE")>-1:!1,isFirefox:void 0!==navigator?navigator.userAgent.indexOf("Firefox")>-1:!1,isSafari:void 0!==navigator?navigator.userAgent.indexOf("Safari")>-1:!1,isOpera:void 0!==navigator?navigator.userAgent.indexOf("Presto")>-1||navigator.userAgent.indexOf("Opera")>-1||navigator.userAgent.indexOf("OPR/")>-1:!1,
isMobileAndroid:function(){var a=navigator.userAgent.match(/Android/i);return void 0!==a&&null!==a},isMobileBlackBerry:function(){var a=navigator.userAgent.match(/BlackBerry/i);return void 0!==a&&null!==a},isMobileiOS:function(){var a=navigator.userAgent.match(/iPhone|iPad|iPod/i);return void 0!==a&&null!==a},isMobileOpera:function(){var a=navigator.userAgent.match(/Opera Mini/i);return void 0!==a&&null!==a},isMobileWindows:function(){var a=navigator.userAgent.match(/IEMobile/i)||navigator.userAgent.match(/WPDesktop/i);return void 0!==a&&null!==a},_isMobileCached:void 0,isMobile:function(){return"boolean"==typeof this._isMobileCached?this._isMobileCached:(this._isMobileCached=this.isMobileAndroid()||this.isMobileiOS()||this.isMobileBlackBerry()||this.isMobileOpera()||this.isMobileWindows(),this._isMobileCached)},name:function(){var a,b=navigator.userAgent,c=b.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(c[1])?(a=/\brv[ :]+(\d+)/g.exec(b)||[],"IE "+(a[1]||"")):"Chrome"===c[1]&&(a=b.match(/\bOPR\/(\d+)/),null!=a)?"Opera "+a[1]:(c=c[2]?[c[1],c[2]]:[navigator.appName,navigator.appVersion,"-?"],null!=(a=b.match(/version\/(\d+)/i))&&c.splice(1,1,a[1]),c[0])},version:function(){var a,b=navigator.userAgent,c=b.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(c[1])?(a=/\brv[ :]+(\d+)/g.exec(b)||[],"IE "+(a[1]||"")):"Chrome"===c[1]&&(a=b.match(/\bOPR\/(\d+)/),null!=a)?"Opera "+a[1]:(c=c[2]?[c[1],c[2]]:[navigator.appName,navigator.appVersion,"-?"],null!=(a=b.match(/version\/(\d+)/i))&&c.splice(1,1,a[1]),c[1])}}};window.TundraSDK=Tundra,window.Tundra=Tundra,Object.defineProperties(Tundra.framework,{client:{get:function(){return Tundra.options.deprecatedWarnings&&console.warn("DEPRECATED: Tundra.framework.client > Tundra.client"),Tundra.client}},network:{get:function(){return Tundra.options.deprecatedWarnings&&console.warn("DEPRECATED: Tundra.framework.network > Tundra.network"),Tundra.network}},scene:{get:function(){return Tundra.options.deprecatedWarnings&&console.warn("DEPRECATED: Tundra.framework.scene > Tundra.scene"),Tundra.scene}},renderer:{get:function(){return Tundra.options.deprecatedWarnings&&console.warn("DEPRECATED: Tundra.framework.renderer > Tundra.renderer"),Tundra.renderer}},frame:{get:function(){return Tundra.options.deprecatedWarnings&&console.warn("DEPRECATED: Tundra.framework.frame > Tundra.frame"),Tundra.frame}},events:{get:function(){return Tundra.options.deprecatedWarnings&&console.warn("DEPRECATED: Tundra.framework.events > Tundra.events"),Tundra.events}},asset:{get:function(){return Tundra.options.deprecatedWarnings&&console.warn("DEPRECATED: Tundra.framework.asset > Tundra.asset"),Tundra.asset}},input:{get:function(){return Tundra.options.deprecatedWarnings&&console.warn("DEPRECATED: Tundra.framework.input > Tundra.input"),Tundra.input}},ui:{get:function(){return Tundra.options.deprecatedWarnings&&console.warn("DEPRECATED: Tundra.framework.ui > Tundra.ui"),Tundra.ui}},console:{get:function(){return Tundra.options.deprecatedWarnings&&console.warn("DEPRECATED: Tundra.framework.console > Tundra.console"),Tundra.console}}});var TundraLogger=Class.$extend({__init__:function(a){this.name=a,this.prefix="["+a+"]:"},isDebug:function(){return log&&log.level<=1},_createArguments:function(a,b){var c=[].slice.call(a);return c.splice(0,0,this.prefix),b===!0&&c.splice(0,0,this._callerLine()),c},_createArgumentsString:function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c];Array.isArray(d)?b.push("["+d.join(", ")+"]"):"object"==typeof d?b.push(JSON.stringify(d)):b.push(d.toString())}return b.join(" ")},_callerLineLink:function(a){void 0===a&&(a=4);var b=(new Error).stack.split("\n")[a];return b=b.substring(b.indexOf("at ")+3),b.substring(b.lastIndexOf("(")+1,b.length-1)},info:function(){log.info.apply(null,this._createArguments(arguments))},infoC:function(){var a=this._createArguments(arguments);log.info.apply(null,a),null!=Tundra.console&&Tundra.console.logInfo(this._createArgumentsString(a))},warn:function(){log.warn.apply(null,this._createArguments(arguments))},warnC:function(){var a=this._createArguments(arguments);log.warn.apply(null,a),null!=Tundra.console&&Tundra.console.logWarning(this._createArgumentsString(a))},error:function(){log.error.apply(null,this._createArguments(arguments))},errorC:function(){var a=this._createArguments(arguments);log.error.apply(null,a),null!=Tundra.console&&Tundra.console.logError(this._createArgumentsString(a))},debug:function(){log.debug.apply(null,this._createArguments(arguments))},trace:function(){log.trace.apply(null,this._createArguments(arguments))}}),TundraLogging={Level:{TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},loggers:[],CurrentLevel:"INFO",DebugLevelEnabled:!1,getLogger:function(a){for(var b=0;b<this.loggers.length;b++)if(this.loggers[b].name===a)return this.loggers[b];var c=new TundraLogger(a);return this.loggers.push(c),c},enableAll:function(){log.enableAll()},disableAll:function(){log.disableAll()},setLevel:function(a){if("string"==typeof a)a=a.toUpperCase();else if("number"!=typeof a)return;this.CurrentLevel=this.levelString(a),this.DebugLevelEnabled="DEBUG"===this.CurrentLevel||"TRACE"===this.CurrentLevel,log.setLevel(a),log.debug("[WebRocket]: Setting log level to",this.CurrentLevel)},levelString:function(a){if("string"==typeof a)return a;if("number"==typeof a)for(var b in TundraLogging.Level)if(a===TundraLogging.Level[b])return b;return"Invalid loglevel "+a.toString()}},CoreStringUtils={_splitLinesRegExp:/\r?\n/g,_dblFwdSlashRegExp:/^\s*\/\/.*/gm,_whiteSpaceStartRegExp:/^\s+/,_whiteSpaceEndRegExp:/\s+$/,formatNumber:function(a){return a.toLocaleString("fr-FR")},startsWith:function(a,b,c){return c===!0?0===a.toLowerCase().indexOf(b.toLowerCase()):0===a.indexOf(b)},endsWith:function(a,b,c){var d=a.length-b.length;return c===!0?d>-1&&a.toLowerCase().substring(d)===b.toLowerCase():d>-1&&a.substring(d)===b},trim:function(a){return a.trim?a.trim():a.replace(this._whiteSpaceStartRegExp,"").replace(this._whiteSpaceEndRegExp,"")},trimLeft:function(a){return a.trimLeft?a.trimLeft():a.replace(this._whiteSpaceStartRegExp,"")},trimStringLeft:function(a,b){for(var c=b.length;a.length>0&&a.substring(0,c)===b;)a=a.substring(c);return a},trimRight:function(a){return a.trimRight?a.trimRight():a.replace(this._whiteSpaceEndRegExp,"")},trimStringRight:function(a,b){for(var c=b.length;a.length>0&&a.substring(a.length-c)===b;)a=a.substring(0,a.length-c);return a},readLine:function(a,b,c,d){c="boolean"==typeof c?c:!1,d="boolean"==typeof d?d:!1;var e=-1,f=a.indexOf("\n"),g=a.indexOf("\r\n"),h=c?a.indexOf("	"):-1,i="string"==typeof b&&""!==b?a.indexOf(b):-1;(-1===e||-1!==f&&e>f)&&(e=f),(-1===e||-1!==g&&e>g)&&(e=g),(-1===e||-1!==h&&e>h)&&(e=h),(-1===e||-1!==i&&e>i)&&(e=i);var j=-1!==e?a.substring(0,e):"";return d&&(j=this.trim(j)),j},splitLines:function(a){return a.split(this._splitLinesRegExp)},removeEmptyLines:function(a){if("string"!=typeof a||""===a)return a;for(var b="\n"===a[a.length-1],c=this.splitLines(a),d=0;d<c.length;d++)""===this.trim(c[d])&&(c.splice(d,1),d--);return c.join("\n")+(b?"\n":"")},extension:function(a){var b=this.trim(a);this.startsWith(b,"http",!0)&&-1!==b.indexOf("?")&&(b=b.substring(0,b.indexOf("?")));var c=b.lastIndexOf(".");return-1!==c?b.substring(c).toLowerCase():""},removeComments:function(a){if("string"!=typeof a||""===a)return a;var b=a.indexOf("/*");if(-1!==b)for(var c=a.indexOf("*/",b+2);-1!==b&&-1!==c;){var d=a.substring(0,b),e=a.substring(c+2);a=d+e,b=a.indexOf("/*"),-1!==b&&(c=a.indexOf("*/",b+2))}return this._dblFwdSlashRegExp.test(a)&&(a=a.replace(this._dblFwdSlashRegExp,"")),a},queryValue:function(a){if(""===window.location.search||"string"!=typeof a||""===a)return"";a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(window.location.search);return null===c?"":decodeURIComponent(c[1].replace(/\+/g," "))},queryValueBool:function(a){var b=this.queryValue(a);return"string"==typeof b&&""!==b?"true"===b.toLowerCase()||"1"===b:!1},queryValueInt:function(a,b){b="number"==typeof b?b:0;var c=this.queryValue(a);if("string"==typeof c&&""!==c){var d=parseInt(c);if("number"==typeof d&&!isNaN(d))return d}return b},queryValueFloat:function(a,b){b="number"==typeof b?b:0;var c=this.queryValue(a);if("string"==typeof c&&""!==c){var d=parseFloat(c);if("number"==typeof d&&!isNaN(d))return d}return b},createQueryString:function(a,b){if("object"!=typeof a)return console.error("CoreStringUtils.query: 'options' must bea object"),"";b="boolean"==typeof b?b:!1;var c="";for(var d in a){var e=a[d].toString();b&&(e=encodeURIComponent(e)),c+=""===c?"?"+d+"="+e:"&"+d+"="+e}return c},enumToString:function(a,b,c){for(var d in a)if(a.hasOwnProperty(d)&&"number"==typeof a[d]&&b===a[d])return d;return c},stringToEnum:function(a,b,c,d){for(var e in a)if(a.hasOwnProperty(e)&&"number"==typeof a[e]&&b.match(new RegExp(e,d?"":"i")))return a[e];return c},parseCommand:function(a){var b={command:"",parameters:[]};if(a=a.trim(),0===a.length)return b;var c=a.indexOf("(");if(-1==c)return b.command=a,b;b.command=a.slice(0,c).trim();var d=a.lastIndexOf(")");-1!=d&&d==a.length-1&&(a=a.substring(0,d)),b.parameters=a.substring(c+1).split(",");for(var e=0;e<b.parameters.length;++e)b.parameters[e]=b.parameters[e].trim();return b}};Tundra.Classes.CoreStringUtils=CoreStringUtils;var MathUtils=Class.$extend({__init__:function(){Object.defineProperties(this,{Zero:{enumerable:!1,writable:!1,value:0},One:{enumerable:!1,writable:!1,value:1},DefaultEpsilon:{enumerable:!1,writable:!1,value:1e-6},TypeOfNumber:{enumerable:!1,writable:!1,value:"number"},SubComponents:{enumerable:!1,writable:!1,value:["x","y","z","w"]},RegExpFloats:{enumerable:!1,writable:!1,value:/[+\-]?((?:[1-9]\d*|0)(?:\.\d*)?|\.\d+)([eE][+-]?\d+)?/g}})},isNaN:Number.isNaN||window.isNaN,isFinite:Number.isFinite||window.isFinite,isInteger:Number.isInteger||function(a){return this.isNumber(nVal)&&this.isFinite(a)&&a>-9007199254740992&&9007199254740992>a&&Math.floor(a)===a},parseFloat:Number.parseFloat||window.parseFloat,parseInt:Number.parseInt||window.parseInt,isNumber:function(a){return typeof a===this.TypeOfNumber&&!this.isNaN(a)},isPow2:function(a){return 0===(a&a-1)},lerp:function(a,b,c){return a+c*(b-a)},clamp:function(a,b,c){return this.isNaN(a)?b:c>=a?a>=b?a:b:c},clamp01:function(a,b,c){return this.clamp(a,0,1)},clampVector3:function(a,b,c){return a.set(this.clamp(a.x,b,c),this.clamp(a.y,b,c),this.clamp(a.z,b,c))},symmetricRandom:function(){return 2*Math.random()-1},equal:function(a,b,c){return this.isNaN(a)||this.isNaN(b)?!1:Math.abs(a-b)<=(c||this.DefaultEpsilon)},equalVector2:function(a,b,c){return this.equal(a.x,b.x,c)&&this.equal(a.y,b.y,c)},equalVector3:function(a,b,c){return this.equal(a.x,b.x,c)&&this.equal(a.y,b.y,c)&&this.equal(a.z,b.z,c)},equalVector4:function(a,b,c){return this.equalVector3(a,b,c)&&this.equal(a.w,b.w,c)},equalQuaternion:function(a,b,c){return this.equalVector4(a,b,c)},isZero:function(a,b){return this.equal(a,this.Zero,b)},isZeroVector2:function(a,b){return this.isZero(a.x,b)&&this.isZero(a.y,b)},isZeroVector3:function(a,b){return this.isZero(a.x,b)&&this.isZero(a.y,b)&&this.isZero(a.z,b)},isZeroVector4:function(a,b){return this.isZeroVector3(a,b)&&this.isZero(a.w,b)},isZeroQuaternion:function(a,b){return this.isZeroVector3(a,b)&&this.equal(a.w,this.One,b)},isFiniteVector2:function(a){return this.isFinite(a.x)&&this.isFinite(a.y)},isFiniteVector3:function(a){return this.isFinite(a.x)&&this.isFinite(a.y)&&this.isFinite(a.z)},isFiniteVector4:function(a){return this.isFiniteVector3(a)&&this.isFinite(a.w)},isFiniteQuaternion:function(a){return this.isFiniteVector4(a)},isFiniteBox3:function(a){return this.isFiniteVector3(a.min)&&this.isFiniteVector3(a.max)},radToDeg:function(a){return THREE.Math.radToDeg(a)},degToRad:function(a){return THREE.Math.degToRad(a)},radToDegVector3:function(a){return new THREE.Vector3(this.radToDeg(a.x),this.radToDeg(a.y),this.radToDeg(a.z))},degToRadVector3:function(a){return new THREE.Vector3(this.degToRad(a.x),this.degToRad(a.y),this.degToRad(a.z))},parseFloatsTo:function(a,b){if("string"==typeof a&&void 0!==b&&null!==b&&"object"==typeof b){var c=a.match(this.RegExpFloats);if(c)for(var d=0;4>d&&!(c.length<=d);++d){var e=this.parseFloat(c[d]);this.isNaN(e)&&(e=0),b[this.SubComponents[d]]=e}}},round:function(a,b){return Math.round(a*Math.pow(10,b))/Math.pow(10,b)},roundVector2:function(a,b){return new THREE.Vector2(this.round(a.x,b),this.round(a.y,b))},roundVector3:function(a,b){return new THREE.Vector3(this.round(a.x,b),this.round(a.y,b),this.round(a.z,b))},roundVector4:function(a,b){return new THREE.Vector4(this.round(a.x,b),this.round(a.y,b),this.round(a.z,b),this.round(a.w,b))}});!function(a){THREE.Vector2.prototype.equals=function(b,c){return a.equalVector2(this,b,c)},THREE.Vector3.prototype.equals=function(b,c){return a.equalVector3(this,b,c)},THREE.Vector4.prototype.equals=function(b,c){return a.equalVector4(this,b,c)},THREE.Quaternion.prototype.equals=function(b,c){return a.equalQuaternion(this,b,c)},THREE.Vector2.prototype.isZero=function(b){return a.isZeroVector2(this,b)},THREE.Vector3.prototype.isZero=function(b){return a.isZeroVector3(this,b)},THREE.Vector4.prototype.isZero=function(b){return a.isZeroVector4(this,b)},THREE.Quaternion.prototype.isZero=function(b){return a.isZeroQuaternion(this,b)},THREE.Vector2.prototype.isFinite=function(){return a.isFiniteVector2(this)},THREE.Vector3.prototype.isFinite=function(){return a.isFiniteVector3(this)},THREE.Vector4.prototype.isFinite=function(){return a.isFiniteVector4(this)},THREE.Quaternion.prototype.isFinite=function(){return a.isFiniteQuaternion(this)},THREE.Box3.prototype.isFinite=function(){return a.isFiniteBox3(this)},THREE.Box3.prototype.isDegenerate=function(){return this.min.x>this.max.x||this.min.y>this.max.y||this.min.z>this.max.z},THREE.Vector2.fromString=function(b){var c=new THREE.Vector2;return a.parseFloatsTo(b,c),c},THREE.Vector3.fromString=function(b){var c=new THREE.Vector3;return a.parseFloatsTo(b,c),c},THREE.Vector4.fromString=function(b){var c=new THREE.Vector4;return a.parseFloatsTo(b,c),c},THREE.Quaternion.fromString=function(b){var c=new THREE.Quaternion;return a.parseFloatsTo(b,c),c},THREE.Vector2.prototype.setFromString=function(b){a.parseFloatsTo(b,this)},THREE.Vector3.prototype.setFromString=function(b){a.parseFloatsTo(b,this)},THREE.Vector4.prototype.setFromString=function(b){a.parseFloatsTo(b,this)},THREE.Quaternion.prototype.setFromString=function(b){a.parseFloatsTo(b,this)},THREE.Box2.prototype.toString=function(){return"(min: "+this.min+" max: "+this.max+")"},THREE.Box3.prototype.toString=function(){return"(min: "+this.min+" max: "+this.max+")"},THREE.Color.prototype.toString=function(){return"("+this.r+", "+this.g+", "+this.b+")"},THREE.Euler.prototype.toString=function(){return"("+this.x+", "+this.y+", "+this.z+" "+this.order+")"},THREE.Vector2.prototype.toString=function(){return"("+this.x+", "+this.y+")"},THREE.Vector3.prototype.toString=function(){return"("+this.x+", "+this.y+", "+this.z+")"},THREE.Vector4.prototype.toString=function(){return"("+this.x+", "+this.y+", "+this.z+", "+this.w+")"},THREE.Quaternion.prototype.toString=function(){return"("+this.x+", "+this.y+", "+this.z+", "+this.w+")"},THREE.Matrix3.prototype.toString=function(){var a=this.elements;return"("+a[0]+", "+a[3]+", "+a[6]+") ("+a[1]+", "+a[4]+", "+a[7]+") ("+a[2]+", "+a[5]+", "+a[8]+")"},THREE.Matrix4.prototype.toString=function(){var a=this.elements;return"("+a[0]+", "+a[4]+", "+a[8]+", "+a[12]+") ("+a[1]+", "+a[5]+", "+a[9]+", "+a[13]+") ("+a[2]+", "+a[6]+", "+a[10]+" ,"+a[14]+") ("+a[3]+", "+a[7]+", "+a[11]+" ,"+a[15]+")"},THREE.Plane.prototype.toString=function(){return"Plane(Normal:("+this.normal.x+", "+this.normal.y+", "+this.normal.z+") d:"+this.constant+")"}}(new MathUtils),Tundra.Classes.MathUtils=MathUtils,window.MathUtils=new MathUtils;var PlaceableUtils={};PlaceableUtils.Animator=Class.$extend({__init__:function(){this.log=TundraLogging.getLogger("PlaceableUtils.Animator"),this.schedule=[]},reset:function(){this.stop(!0)},getScheduled:function(a){var b=a;if("string"!=typeof b&&"Placeable"===a.typeName&&(b=a.parentEntity.id+"."+a.id),"string"!=typeof b)return void this.log.error("getScheduled: Invalid parameter:",a);for(var c=this.schedule.length-1;c>=0;c--)if(this.schedule[c].key===a)return this.schedule[c];return void 0},getEasing:function(a,b){if("function"==typeof a)return a;if("string"==typeof a){var c=a.toLowerCase();if("linear"===c)return TWEEN.Easing.Linear.None;if("quadratic"===c)return b?TWEEN.Easing.Quadratic.Out:TWEEN.Easing.Quadratic.InOut;if("bounce"===c)return b?TWEEN.Easing.Bounce.Out:TWEEN.Easing.Bounce.InOut;if("cubic"===c)return b?TWEEN.Easing.Cubic.Out:TWEEN.Easing.Cubic.InOut}return b?TWEEN.Easing.Cubic.Out:TWEEN.Easing.Cubic.InOut},position:function(a,b){if(b=b||{},"Placeable"!==a.typeName)return this.log.error("position: First parameter needs to be a Placeable component"),null;if(null==a.parentEntity)return this.log.error("position: Placeable component is not parented."),null;if(void 0===b.to||"number"!=typeof b.to.z)return this.log.error("position: Option 'to' must be a Vector3 like object."),null;b.from=b.from||a.worldPosition();var c=a.parentEntity.id+"."+a.id+".pos",d=this._stopByKey(c);b.easing=this.getEasing(b.easing,d),b.duration=b.duration||1e3,a._animatingPosition=!0;var e={key:c,placeable:a,animator:this};return e.stop=function(){return this.animator&&this.key?void this.animator._stopByKey(this.key):void(this.placeable&&(this.placeable._animatingPosition=!1))},e.animation=new TWEEN.Tween({x:b.from.x,y:b.from.y,z:b.from.z,placeable:a,sheduled:e}).easing(b.easing).to({x:b.to.x,y:b.to.y,z:b.to.z},b.duration).onUpdate(function(){this.placeable&&this.placeable.parentEntity&&this.placeable.setPosition(this.x,this.y,this.z)}).onComplete(function(){this.sheduled.stop()}),this.schedule.push(e),e.animation.start(),e.animation},setVisibilityScaling:function(a,b,c){if(c=c||{},"Placeable"!==a.typeName)return this.log.error("setVisibilityScaling: First parameter needs to be a Placeable component"),null;if(null==a.parentEntity)return this.log.error("setVisibilityScaling: Placeable component is not parented."),null;c.from=c.from||(b?0:a.transform.scale),c.to=c.to||(b?1:0);var d=a.parentEntity.id+"."+a.id+".scale",e=this._stopByKey(d);if(b||a.visible){var f={x:"number"==typeof c.from?c.from:c.from.x,y:"number"==typeof c.from?c.from:c.from.y,z:"number"==typeof c.from?c.from:c.from.z,placeable:a,visible:b},g={x:"number"==typeof c.to?c.to:c.to.x,y:"number"==typeof c.to?c.to:c.to.y,z:"number"==typeof c.to?c.to:c.to.z};c.easing=this.getEasing(c.easing,e),c.duration=c.duration||1e3,a._animatingVisibility=!0,a._animatingVisibilityTo=b,a._animatingScale=!0,a.setScale(f.x,f.y,f.z),a.visible=!0,a.parentEntity.billboard&&(a.parentEntity.billboard.setOverrideScale(f.x,f.y),a.parentEntity.billboard.show(!1));var h={key:d,placeable:a,animator:this};return h.stop=function(){return this.animator&&this.key?void this.animator._stopByKey(this.key):void(this.placeable&&(this.placeable._animatingVisibility=!1,this.placeable._animatingVisibilityTo=void 0,this.placeable._animatingScale=!1))},f.sheduled=h,h.animation=new TWEEN.Tween(f).easing(c.easing).to(g,c.duration).onUpdate(function(){this.placeable&&this.placeable.parentEntity&&((this.x<0||MathUtils.isZero(this.x))&&(this.x=0),(this.y<0||MathUtils.isZero(this.y))&&(this.y=0),(this.z<0||MathUtils.isZero(this.z))&&(this.z=0),this.placeable.setScale(this.x,this.y,this.z),this.placeable.parentEntity.billboard&&this.placeable.parentEntity.billboard.setOverrideScale(this.x,this.y))}).onComplete(function(a){this.placeable&&this.placeable.parentEntity&&(this.placeable.visible=this.visible,this.placeable.parentEntity.billboard&&this.placeable.parentEntity.billboard.setVisible(this.visible)),this.sheduled.stop()}),this.schedule.push(h),h.animation.start(),h.animation}},stop:function(a){var b=!1;if("string"==typeof a||"object"==typeof a){if("string"!=typeof a&&"Placeable"===a.typeName){var c=a.parentEntity.id+"."+a.id;return this._stopByKey(c+".pos")&&(b=!0),this._stopByKey(c+".scale")&&(b=!0),b}return"string"!=typeof a?(this.log.error("stop: Invalid parameter:",a),!1):this._stopByKey(a)}if("boolean"==typeof a&&a===!0){for(;this.schedule.length>0;)this.schedule[0].key?this._stopByKey(this.schedule[0].key):this.schedule.splice(0,1);this.schedule=[],b=!0}else this.log.error("stop: Invalid parameter:",a);return b},_stopByKey:function(a){for(var b=!1,c=this.schedule.length-1;c>=0;c--)if(this.schedule[c].key===a){found=!0;var d=this.schedule.splice(c,1)[0];d.key=void 0,d.stop(),d.animation&&(b||(b=d.animation.isPlaying()),d.animation.stop()),delete d}return b}}),Tundra.Classes.PlaceableUtils=PlaceableUtils;var IRenderSystem=Class.$extend({__init__:function(a){this.name=a},__classvars__:{register:function(a){var b=new this;return a.registerRenderSystem(b)?b:null},getDefaultOptions:function(){return{}}},_load:function(a){TundraLogging.getLogger("IRenderSystem").info("Loading "+this.name+" render system"),this.load(a)},load:function(a){},_unload:function(){TundraLogging.getLogger("IRenderSystem").info("Unloading "+this.name+" render system"),this.unload()},unload:function(){},postInitialize:function(){},setActiveCamera:function(a){TundraLogging.getLogger("IRenderSystem").warn("setActiveCamera() not implemented.")},activeCamera:function(){return TundraLogging.getLogger("IRenderSystem").warn("activeCamera() not implemented."),null},activeCameraEntity:function(){return TundraLogging.getLogger("IRenderSystem").warn("activeCameraEntity() not implemented."),null},createSceneNode:function(){return TundraLogging.getLogger("IRenderSystem").warn("createSceneNode() not implemented."),null},updateSceneNode:function(a,b){TundraLogging.getLogger("IRenderSystem").warn("updateSceneNode() not implemented.")},raycastAllFrom:function(a,b,c){return TundraLogging.getLogger("IRenderSystem").warn("raycastAllFrom() not implemented."),null},raycastFrom:function(a,b,c){return TundraLogging.getLogger("IRenderSystem").warn("raycastFrom() not implemented."),null},raycastAll:function(a,b,c){return TundraLogging.getLogger("IRenderSystem").warn("raycastAll() not implemented."),null},raycast:function(a,b,c){return TundraLogging.getLogger("IRenderSystem").warn("raycast() not implemented."),null}}),IDomIntegration=Class.$extend({__init__:function(a){this.name=a},__classvars__:{register:function(a){var b=new this;return a.registerDomIntegration(b)?b:null}},_load:function(){Tundra.client.log.info("Loading "+this.name+" DOM integration system"),this.load()},load:function(){},_unload:function(){Tundra.client.log.info("Unloading "+this.name+" DOM integration system"),this.unload()},unload:function(){}}),EasingCurve=Class.$extend({__init__:function(a,b){this.p0=new THREE.Vector2(0,0),this.p1=a||new THREE.Vector2(0,.5),this.p2=b||new THREE.Vector2(1,.5),this.p3=new THREE.Vector2(1,1)},getTime:function(a){a=Math.min(Math.max(a,0),1);var b=this.p0.clone().lerp(this.p1,a),c=this.p1.clone().lerp(this.p2,a),d=this.p2.clone().lerp(this.p3,a);return b.lerp(c,a),c.lerp(d,a),b.lerp(c,a).x}}),ITundraAPI=Class.$extend({__init__:function(a,b){("string"!=typeof a||""===a)&&console.error("ITundraAPI constructor must be called with 'name' that is a non-empty string!"),this.name=a,this.options=b||{},this.staging={initialized:!1,postInitialized:!1};var c=this.name;c.length>3&&"API"===c.substring(c.length-3)&&(c=c.substring(0,c.length-3)),this.log=TundraLogging.getLogger(c)},reset:function(){},_initialize:function(){this.staging.initialized||(this.initialize(),this.staging.initialized=!0)},initialize:function(){},_postInitialize:function(){this.staging.postInitialized||(this.postInitialize(),this.staging.postInitialized=!0)},postInitialize:function(){}}),AsyncHelper=Class.$extend({__init__:function(a,b){this.name="string"==typeof a&&""!==a?"AsyncHelper."+a:"AsyncHelper",this.log=TundraLogging.getLogger(this.name),this.handles={},this.deferred={},this.data={},this.defaultContext=b||this},__classvars__:{async:function(a,b,c){if("function"!=typeof a)return console.error("AsyncHelper.async: 'callback' is not a function:",a),!1;"number"==typeof b&&"number"!=typeof c&&(c=b,b=void 0);var d=b&&b.length?b:[b],e=function(){a.apply(this,d)}.bind(this),f="number"==typeof c&&c>0,g=f?setTimeout(e,c):requestAnimationFrame(e);return f?g:~g},cancel:function(a){"number"==typeof a&&(0>a?cancelAnimationFrame(~a):clearTimeout(a))}},async:function(a,b,c,d){if("string"!=typeof a||""===a.trim())return this.log.error("async: 'name' is invalid:",a),!1;if("function"!=typeof b)return this.log.error("async: 'callback' is not a function:",b),!1;this.cancel(a),"number"==typeof c&&"number"!=typeof d&&(d=c,c=void 0);var e=c&&c.length?c:[c],f=this._wrap(a,b,e),g="number"==typeof d&&d>0,h=g?setTimeout(f,d):requestAnimationFrame(f);return this.handles[a]=g?h:~h,!0},hasAsync:function(a){return void 0!==this.handles[a]},numAsync:function(){return Object.keys(this.handles).length},defer:function(a,b){if("string"!=typeof a||""===a.trim())return this.log.error("defer: 'name' is invalid:",a),$.Deferred().promise();var c=this.deferred[a];if(void 0!==c)return c.promise();var d=this._createDefer(a,b);return d.promise},hasDefer:function(a){return void 0!==this.deferred[a]},numDefers:function(){return Object.keys(this.deferred).length},deferImmediate:function(a,b){var c=this.defer(a);return this.resolve.apply(this,arguments),c},resolve:function(a,b){if("string"!=typeof a||""===a.trim())return this.log.error("resolve: 'name' is invalid:",a),!1;var c=this.deferred[a];if(void 0!==c){delete this.deferred[a];var d=[].slice.call(arguments,2);b!==!1?c.resolve.apply(c,d):c.reject.apply(c,d)}},cancel:function(a){if("string"!=typeof a||""===a.trim())return this.log.error("cancel: 'name' is invalid:",a),!1;var b=this.handles[a];return void 0!==b&&(0>b?cancelAnimationFrame(~b):clearTimeout(b)),delete this.handles[a],delete this.deferred[a],void 0!==b},when:function(){for(var a=[],b=0;b<arguments.length;++b)"string"==typeof arguments[b]?a.push(this.defer(arguments[b])):$.isFunction(arguments[b].promise)&&a.push(arguments[b]);return $.when.apply(this.defaultContext||this,a)},_createDefer:function(a,b){var c={isNew:void 0===this.deferred[a]};return void 0!==b&&"function"!=typeof b&&(b=void 0),c.defer=$.Deferred(b),c.promise=c.defer.promise(),c.isNew&&(this.deferred[a]=c.defer),c},_wrap:function(a,b,c){return function(){try{delete this.handles[a]}catch(d){console.error(d.stack||d)}b.apply(this.defaultContext||this,c)}.bind(this)}});Tundra.Classes.AsyncHelper=AsyncHelper;var AssetCache=Class.$extend({__init__:function(){this.assets={}},assetData:function(){for(var a={},b=Object.keys(this.assets),c=0;c<b.length;c++){var d=this.assets[b[c]];d&&d.isLoaded()&&(void 0===a[d.type]?a[d.type]=1:a[d.type]++)}return a},get:function(a){return this.assets[a]},set:function(a,b){this.assets[a]=b},remove:function(a){delete this.assets[a]},hasAsset:function(a){return void 0!==this.get(a)},getAssets:function(){var a=[];for(var b in this.assets)a.push(this.assets[b]);return a},forgetAssets:function(){this.assets={}}}),_enableAssetProfiling=!1,_profiling=_enableAssetProfiling?{loaded:0,timeTotal:0,types:["all"]}:void 0,IAsset=Class.$extend({__init__:function(a,b){this.log=TundraLogging.getLogger(b),this.name=a,this.type=b,this.baseRef=0!=a.indexOf("/")?a.substring(0,a.lastIndexOf("/")+1):"",-1!=a.indexOf(".zip#")&&(this.baseRef=a.substring(0,a.lastIndexOf(".zip#")+5)),this.dependencyRefs=[],this.requiresCloning=!1,this.isCloneSource=!1,this.logging=!1},__classvars__:{cloneCounts:{}},numClones:function(){var a=IAsset.cloneCounts[this.name];return void 0===a&&(a=0),a},originalName:function(){var a=this.name.indexOf("_clone_");return a>0?this.name.substring(0,a):this.name},cloneName:function(a){return this.name+"_clone_"+a},isLoaded:function(){return!1},onDeserializedFromData:function(a,b){return Tundra.events.subscribe("IAsset.DeserializedFromData."+this.name,a,b)},onLoaded:function(a,b){return Tundra.events.subscribe("IAsset.Loaded."+this.name,a,b)},onFailed:function(a,b){return Tundra.events.subscribe("IAsset.Failed."+this.name,a,b)},onDependencyFailed:function(a,b){return Tundra.events.subscribe("IAsset.DependencyFailed."+this.name,a,b)},onUnloaded:function(a,b){return Tundra.events.subscribe("IAsset.Unloaded."+this.name,a,b)},clone:function(a){if(void 0===a||"string"!=typeof a){var b=this.numClones()+1;a=this.cloneName(b),IAsset.cloneCounts[this.name]=b}if(void 0===a||"string"!=typeof a)return this.log.error("Canno clone() as input parameter 'newAssetName' is not defined!"),null;var c=Tundra.asset.getAsset(a);if(void 0!==c&&null!==c)return this.log.error("Cannot clone() asset '"+this.name+"' to new asset '"+a+"', it already exists!"),null;var d=this._cloneImpl(a);return void 0!==d&&null!==d?Tundra.asset.cache.set(d.name,d):this.log.error("Failed to create clone '"+a+"'"),d},_cloneImpl:function(a){return this.log.warn("_cloneImpl() not implemented/overridden by this asset type '"+this.type+"'"),null},numDependencies:function(){return this.dependencies().length},numPendingDependencies:function(){return 0},dependencies:function(){return this.dependencyRefs},pendingDependencies:function(){return[]},deserializeFromData:function(a,b,c){},unload:function(){},_deserializeFromData:function(a,b,c){var d=void 0;if(void 0!==_profiling)for(var e=0;e<_profiling.types.length;e++)if("all"===_profiling.types[e]||_profiling.types[e]===this.type){d=new Date;break}var f=this.deserializeFromData(a,b,c);if(void 0===f?f=!0:"boolean"!=typeof f&&(this.log.error("deserializeFromData returned non boolean type value: "+f+" for "+this.name+". Assuming loading failed, marking to false. Fix your failure code paths to return 'false'.",!0),f=!1),void 0!==_profiling&&void 0!==d){var g=this.name.substring(this.name.lastIndexOf("/")+1),h=new Date-d;_profiling.timeTotal+=h,_profiling.loaded+=f?1:0,console.log("Loaded in "+h+" msec [totals: time spent = "+_profiling.timeTotal+" msec num = "+_profiling.loaded+"] "+g)}return f&&Tundra.asset._emitAssetDeserializedFromData(this),f&&this.isLoaded()&&this._emitLoaded(),f},_unload:function(){this.unload(),this._emiUnloaded()},_emitDeserializedFromData:function(){Tundra.events.send("IAsset.DeserializedFromData."+this.name,this)},_emitLoaded:function(){Tundra.events.send("IAsset.Loaded."+this.name,this)},_emitFailed:function(a){Tundra.events.send("IAsset.Failed."+this.name,this,a)},_emitDependencyFailed:function(a){Tundra.events.send("IAsset.DependencyFailed."+this.name,a)},_emiUnloaded:function(){Tundra.events.send("IAsset.Unloaded."+this.name,this)}}),AssetTransfer=Class.$extend({__init__:function(a,b,c,d,e){this.log=TundraLogging.getLogger("AssetTransfer"),this.factory=a,this.ref=b,this.proxyRef=c,this.type=d,this.suffix=e,this.requestDataType=void 0,this.requestTimeout=1e4,this.active=!1,this.loading=!1,this.aborted=!1,this.silent=!1,this.parentAssets=[],this.httpStatusCode=-1,this.subscribers=[],this.subscriptions=[]},__classvars__:{completedFired:{},reset:function(){AssetTransfer.completedFired={}},HttpStatus:{CONTINUE:100,SWITCHING_PROTOCOLS:101,OK:200,CREATED:201,ACCEPTED:202,NON_AUTHORITATIVE_INFORMATION:203,NO_CONTENT:204,RESET_CONTENT:205,PARTIAL_CONTENT:206,MULTIPLE_CHOICES:300,MOVED_PERMANENTLY:301,FOUND:302,SEE_OTHER:303,NOT_MODIFIED:304,USE_PROXY:305,TEMPORARY_REDIRECT:307,BAD_REQUEST:400,UNAUTHORIZED:401,PAYMENT_REQUIRED:402,FORBIDDEN:403,NOT_FOUND:404,METHOD_NOT_ALLOWED:405,NOT_ACCEPTABLE:406,PROXY_AUTHENTICATION_REQUIRED:407,REQUEST_TIMEOUT:408,CONFLICT:409,GONE:410,LENGTH_REQUIRED:411,PRECONDITION_FAILED:412,REQUEST_ENTITY_TOO_LARGE:413,REQUEST_URI_TOO_LONG:414,UNSUPPORTED_MEDIA_TYPE:415,REQUEST_RANGE_NOT_SATISFIABLE:416,EXPECTATION_FAILED:417,INTERNAL_SERVER_ERROR:500,NOT_IMPLEMENTED:501,BAD_GATEWAY:502,SERVICE_UNAVAILABLE:503,
GATEWAY_TIMEOUT:504,HTTP_VERSION_NOT_SUPPORTED:505},statusCodeName:function(a){switch(a){case this.HttpStatus.CONTINUE:return"Continue";case this.HttpStatus.SWITCHING_PROTOCOLS:return"Switching Protocols";case this.HttpStatus.OK:return"OK";case this.HttpStatus.CREATED:return"Created";case this.HttpStatus.ACCEPTED:return"Accepted";case this.HttpStatus.NON_AUTHORITATIVE_INFORMATION:return"Non Authoritative Information";case this.HttpStatus.NO_CONTENT:return"No Content";case this.HttpStatus.RESET_CONTENT:return"Reset Content";case this.HttpStatus.PARTIAL_CONTENT:return"Partial Content";case this.HttpStatus.MULTIPLE_CHOICES:return"Multiple Choices";case this.HttpStatus.MOVED_PERMANENTLY:return"Moved Permanently";case this.HttpStatus.FOUND:return"Found";case this.HttpStatus.SEE_OTHER:return"See Other";case this.HttpStatus.NOT_MODIFIED:return"Not Modified";case this.HttpStatus.USE_PROXY:return"Use Proxy";case this.HttpStatus.TEMPORARY_REDIRECT:return"Temporary Redirect";case this.HttpStatus.BAD_REQUEST:return"Bad Request";case this.HttpStatus.UNAUTHORIZED:return"Unauthorized";case this.HttpStatus.PAYMENT_REQUIRED:return"Payment Required";case this.HttpStatus.FORBIDDEN:return"Forbidden";case this.HttpStatus.NOT_FOUND:return"Not Found";case this.HttpStatus.METHOD_NOT_ALLOWED:return"Method Not Allowed";case this.HttpStatus.NOT_ACCEPTABLE:return"Not Acceptable";case this.HttpStatus.PROXY_AUTHENTICATION_REQUIRED:return"Proxy Authentication Required";case this.HttpStatus.REQUEST_TIMEOUT:return"Request Timeout";case this.HttpStatus.CONFLICT:return"Conflict";case this.HttpStatus.GONE:return"Gone";case this.HttpStatus.LENGTH_REQUIRED:return"Length Required";case this.HttpStatus.PRECONDITION_FAILED:return"Precondition Failed";case this.HttpStatus.REQUEST_ENTITY_TOO_LARGE:return"Request Rntity Too Large";case this.HttpStatus.REQUEST_URI_TOO_LONG:return"Request Uri Too Long";case this.HttpStatus.UNSUPPORTED_MEDIA_TYPE:return"Unsupported Media Type";case this.HttpStatus.REQUEST_RANGE_NOT_SATISFIABLE:return"Request Range Not Satisfiable";case this.HttpStatus.EXPECTATION_FAILED:return"Expectation Failed";case this.HttpStatus.INTERNAL_SERVER_ERROR:return"Internal Server Error";case this.HttpStatus.NOT_IMPLEMENTED:return"Not Implemented";case this.HttpStatus.BAD_GATEWAY:return"Bad Gateway";case this.HttpStatus.SERVICE_UNAVAILABLE:return"Service Unavailable";case this.HttpStatus.GATEWAY_TIMEOUT:return"Gateway Timeout";case this.HttpStatus.HTTP_VERSION_NOT_SUPPORTED:return"Http Version Not Supported";case 0:return"";default:return"Unknown HTTP status code "+a}},isHttpSuccess:function(a){switch(a){case this.HttpStatus.OK:case this.HttpStatus.CREATED:case this.HttpStatus.ACCEPTED:case this.HttpStatus.NOT_MODIFIED:return!0;default:return!1}}},toString:function(){return"ref = "+this.ref+" type = "+this.type+" suffix = "+this.suffix+" dataType = "+this.requestDataType},abort:function(){this.aborted!==!0&&(this.aborted=!0,Tundra.asset.removeTransfer(this),void 0!==this._ajax&&"function"==typeof this._ajax.abort&&(this._ajax.abort(),this._ajax=void 0))},addParentAsset:function(a){if(!(a instanceof IAsset))return void this.log.error("addParentAsset called with non IAsset object:",a);for(var b=0;b<this.parentAssets.length;b++)if(this.parentAssets[b].name===a.name)return;this.parentAssets.push(a)},onCompleted:function(a,b,c){this.subscribers.push({type:"completed",context:a,callback:b,metadata:c})},onFailed:function(a,b,c){this.subscribers.push({type:"failed",context:a,callback:b,metadata:c})},_detectRequestDataType:function(){var a=null!=this.factory?this.factory.requestDataType(this.suffix):void 0;return"string"==typeof a?a:(this.log.warn("AssetFactory for",this.ref,"failed to return data type. Guessing from known types."),"Binary"===this.type?"arraybuffer":"Text"===this.type&&".xml"===this.suffix||".txml"===this.suffix?"xml":"Text"===this.type&&".html"===this.suffix||".html"===this.suffix?"document":"Text"===this.type&&".json"===this.suffix?"json":"Text"===this.type?"text":void 0)},_send:function(){if(this.active===!0)return void this.log.error("Transfer is already active, refusing to re-send:",this.ref);if(this.active=!0,void 0!==Tundra.asset.getHttpProxyResolver()){var a=Tundra.asset.getHttpProxyResolver().resolveRequestMetadata(this,this.proxyRef);void 0!==a&&(this.requestDataType="string"==typeof a.dataType?a.dataType:void 0,this.requestTimeout="number"==typeof a.timeout?a.timeout:this.requestTimeout)}(void 0===this.requestDataType||null===this.requestDataType||""===this.requestDataType)&&(this.requestDataType=this._detectRequestDataType()),"arraybuffer"!==this.requestDataType&&"document"!==this.requestDataType?this._ajax=$.ajax({type:"GET",timeout:this.requestTimeout,url:void 0!==this.proxyRef?this.proxyRef:this.ref,dataType:this.requestDataType,context:this,success:this._onTransferCompleted,error:this._onTransferFailed}):(this._ajax=new XMLHttpRequest,this._ajax.open("GET",void 0!==this.proxyRef?this.proxyRef:this.ref,!0),this._ajax.responseType=this.requestDataType,this._ajax.timeout=this.requestTimeout,this._ajax.addEventListener("load",this._onTransferCompletedBinary.bind(this),!1),this._ajax.addEventListener("timeout",this._onTransferFailedBinary.bind(this),!1),this._ajax.addEventListener("error",this._onTransferFailedBinary.bind(this),!1),this._ajax.send(null))},_handleHttpErrors:function(a){return AssetTransfer.isHttpSuccess(a)?!1:(Tundra.asset.assetTransferFailed(this,"Request failed "+this.ref+": "+a+" "+AssetTransfer.statusCodeName(a)),!0)},_onTransferCompleted:function(a,b,c){this.aborted!==!0&&(this.httpStatusCode=c.status,this._handleHttpErrors(this.httpStatusCode)||(this._loadAssetFromData(a),c.responseText=null,c.responseXml=null,delete c,c=null,delete a,a=null,this._ajax=void 0))},_onTransferCompletedBinary:function(a){if(this.aborted!==!0){var b=a.currentTarget;this.httpStatusCode=b.status,this._handleHttpErrors(this.httpStatusCode)||(this._loadAssetFromData(b.response),b.response=null,delete b,b=null,this._ajax=void 0)}},_onTransferFailed:function(a,b,c){this.aborted!==!0&&(this.httpStatusCode=a.status,Tundra.asset.assetTransferFailed(this,"Request failed "+this.ref+": "+(0!==a.status?a.status:"Request Timed Out")+" "+AssetTransfer.statusCodeName(a.status)+("string"==typeof b?" ("+b+")":"")),a.responseText=null,a.responseXml=null,delete a,a=null,this._ajax=void 0)},_onTransferFailedBinary:function(a){if(this.aborted!==!0){var b=a.currentTarget;this.httpStatusCode=b.status,Tundra.asset.assetTransferFailed(this,"Request failed "+this.ref+": "+(0!==b.status?b.status:"Request Timed Out")+" "+AssetTransfer.statusCodeName(b.status)),b.response=null,delete b,b=null,this._ajax=void 0}},_loadAssetFromData:function(a){Tundra.asset.removeActiveTransfer(this);var b=Tundra.asset.createEmptyAsset(this.ref,this.type);if(null==b)return void Tundra.asset.assetTransferFailed(this,"Failed to create asset of unknown type '"+this.type+"' for '"+this.ref+"'");try{this._deserializeFromData(b,a)}catch(c){Tundra.asset.assetTransferFailed(this,"Exception while deserializing asset from data: "+c,!0),void 0!==c.stack&&console.error(c.stack),console.log(this)}this.active=!1},_deserializeFromData:function(a,b){var c=a._deserializeFromData(b,this.requestDataType,this);c?a.isLoaded()?this._assetLoadCompleted(a):(this.loading=!0,this.subscriptions.push(a.onLoaded(this,this._assetLoadCompleted)),this.subscriptions.push(a.onFailed(this,this._assetLoadFailed)),this.subscriptions.push(a.onDependencyFailed(this,this._assetDependencyFailed))):Tundra.asset.assetTransferFailed(this,"IAsset.deserializeFromData failed loading asset "+this.ref)},_assetLoadCompleted:function(a){this.loading=!1,Tundra.asset.assetTransferCompleted(this,a)},_assetLoadFailed:function(a,b){this.loading=!1,Tundra.asset.assetTransferFailed(this,"Asset "+this.ref+" request failed: "+("string"==typeof b?b:"Unkown reason"))},_assetDependencyFailed:function(a){this.loading=!1,Tundra.asset.assetTransferFailed(this,"Asset "+this.ref+" request failed. Dependency "+a+" could not be loaded.")},_emitCompleted:function(a){for(var b=0;b<this.subscriptions.length;b++)Tundra.events.unsubscribe(this.subscriptions[b]);this.subscriptions=[];var c=AssetTransfer.completedFired[a.name];void 0===c&&(c=0);for(var b=0;b<this.subscribers.length;++b)try{var d=this.subscribers[b];if("completed"!==d.type)continue;var e=null;a.requiresCloning&&c>0?a.canReuse===!0?(a.canReuse=!1,e=a):e=a.clone():e=a,c++,d.callback.call(void 0!==d.context&&null!==d.context?d.context:this,e,d.metadata)}catch(f){Tundra.client.logError("[AssetTransfer]: Completed handler exception: "+f,!0),void 0!==f.stack&&console.error(f.stack)}AssetTransfer.completedFired[a.name]=c,this.subscribers=[]},_emitFailed:function(a){for(var b=0;b<this.subscriptions.length;b++)Tundra.events.unsubscribe(this.subscriptions[b]);this.subscriptions=[];for(var b=0;b<this.subscribers.length;++b)try{var c=this.subscribers[b];if("failed"!==c.type)continue;c.callback.call(void 0!==c.context&&null!==c.context?c.context:this,this,a,c.metadata)}catch(d){Tundra.client.logError("[AssetTransfer]: Failed handler exception: "+d,!0)}this.subscribers=[]}}),AssetFactory=Class.$extend({__init__:function(a,b,c,d){"string"!=typeof a&&console.error("AssetFactory constructor 'assetType' needs to be a string!"),(void 0===b||null===b)&&console.error("AssetFactory constructor 'assetClass' is not a valid object!"),void 0!==c&&Array.isArray(c)?console.error("AssetFactory constructor 'typeExtensions' must be a object mapping suffix to request data type!"):void 0!==c&&"object"!=typeof c&&console.error("AssetFactory constructor 'typeExtensions' must be a object mapping suffix to request data type!"),this.assetType=a,this.assetClass=b,this.typeExtensions=c,this.defaultDataType=d},supportedSuffixes:function(){return Object.keys(this.typeExtensions)},requestDataType:function(a){var b=this.typeExtensions[a.toLowerCase()];return"string"==typeof b?b:"string"==typeof this.defaultDataType?this.defaultDataType:void 0},canCreate:function(a){if(void 0===this.typeExtensions||null===this.typeExtensions)return!1;for(var b=CoreStringUtils.extension(a),c=(a.toLowerCase(),Object.keys(this.typeExtensions)),d=0,e=c.length;e>d;++d)if(CoreStringUtils.endsWith(b,c[d]))return!0;return!1},createEmptyAsset:function(a){var b=new this.assetClass(a);return this.emptyAssetCreated(b),b},emptyAssetCreated:function(a){}}),TextAsset=IAsset.$extend({__init__:function(a){this.$super(a,"TextAsset"),this.data=null},isLoaded:function(){return null!==this.data},deserializeFromData:function(a,b,c){this.data=a},unload:function(){this.data=null}}),BinaryAsset=IAsset.$extend({__init__:function(a){this.$super(a,"BinaryAsset"),this.data=null},isLoaded:function(){return null!==this.data},deserializeFromData:function(a,b,c){this.data=a},unload:function(){this.data=null}}),AssetAPI=ITundraAPI.$extend({__init__:function(a,b,c){this.$super(a,b);for(var d=Object.keys(this.options.storages),e=0;e<d.length;e++){var f=d[e];""===this.options.storages[f]||CoreStringUtils.endsWith(this.options.storages[f],"/")||(this.options.storages[f]+="/"),this.options.storages[f]!==this.options.storages[f.toLowerCase()]&&(this.options.storages[f.toLowerCase()]=this.options.storages[f],delete this.options.storages[f])}this._timing=new AsyncHelper(this.name),this._timing.data={transferNum:0,tStart:0},this.cache=new AssetCache,this.factories=[],this.autoProcessTransfers=!0,this.maxActiveTransfers=8,this.maxActiveTransfersPerType={}},initialize:function(){this.registerAssetFactory(new AssetFactory("Binary",BinaryAsset,{},"arraybuffer")),this.registerAssetFactory(new AssetFactory("Text",TextAsset,{".xml":"xml",".txml":"xml",".html":"document",".htm":"document",".json":"json",".js":"json",".txt":"text",".rss":"xml"},"text"))},postInitialize:function(){for(var a=0;a<this.factories.length;a++)this._logAssetTypeFactory(this.factories[a],!0)},reset:function(){this.forgetAssets(!0),this.abortTransfers(),this.defaultStorage=null,this.transfers=[],this.readyTransfers=[],this.activeTransfers=[],this.tranferCheckT=0,this.tranferCheckInterval=.1,this.noFactoryErrors={},AssetTransfer.reset()},__classvars__:{getDefaultOptions:function(){return{storages:{"webrocket://":""}}},httpProxyResolver:void 0,setHttpProxyResolver:function(a){this.httpProxyResolver=a},loadScript:function(a,b){return b=$.extend(b||{},{url:a,dataType:"script",cache:!0}),$.ajax(b)},loadDependencies:function(a){if((void 0===a||null===a)&&(a=""),"string"!=typeof a)return Tundra.asset.log.error("loadDependencies: First parameter must be a context ref. If you don't need to specify a context pass in 'undefined'"),$.Deferred(function(a){a.reject()}).promise();var b=[].slice.call(arguments,1);if(!Array.isArray(b)||0===b.length)return Tundra.asset.log.error("loadDependencies: Invoked without any dependencies"),$.Deferred(function(a){a.reject()}).promise();a=Tundra.asset.resolveAssetRef("",a);for(var c=0;c<b.length;c++)if("string"!=typeof b[c])return Tundra.asset.log.error("loadDependencies: Invoked with a dependency that is not a string:",b),$.Deferred(function(a){a.reject()}).promise();for(var c=0;c<b.length;c++){var d=Tundra.asset.resolveAssetRef(a,b[c]);"string"==typeof d&&""!==d&&d!==b[c]&&(b[c]=d)}return promise=$.Deferred(function(c){$.extend(c,{_context:a,_refs:b,_error:void 0,_onFail:function(a,b,c){void 0===this._error&&(this._error="Failed to fetch dependency '"+this._processingRef+"' for '"+this._context+"':",c?this._error+=" "+c.toString():b&&(this._error+=" "+b))},_processNext:function(){if(void 0!==this._error)return Tundra.asset.log.error("loadDependencies:",this._error),void this.reject(this.error);if(0===this._refs.length)return void this.resolve();this._processingRef=this._refs.splice(0,1)[0];var a=CoreStringUtils.extension(this._processingRef);".html"!==a?Tundra.asset.loadScript(this._processingRef).fail(this._onFail.bind(this)).always(this._processNext.bind(this)):Tundra.usingPolymer()?Polymer["import"]([this._processingRef],this._processNext.bind(this)):this._processNext()}}),c._processNext()}).promise()}},loadScript:function(a,b){return AssetAPI.loadScript(a,b)},loadDependencies:function(){return AssetAPI.loadDependencies.apply(AssetAPI,arguments)},setHttpProxyResolver:function(a){return AssetAPI.httpProxyResolver=a,AssetAPI.httpProxyResolver},getHttpProxyResolver:function(){return AssetAPI.httpProxyResolver},registerAssetFactory:function(a){if(!(a instanceof AssetFactory))return this.log.error("registerAssetFactory called with a non AssetFactory object:",a),!1;for(var b=0;b<this.factories.length;++b)if(this.factories[b].assetType===a.assetType)return this.log.error("AssetFactory with type '"+a.assetType+"' already registered:",this.factories[b]),!1;return this.factories.push(a),this._logAssetTypeFactory(a),!0},_logAssetTypeFactory:function(a,b){(this.staging.postInitialized||b===!0)&&(void 0!==a.typeExtensions&&a.supportedSuffixes().length>0?this.log.debug("Registered factory",a.assetType,a.supportedSuffixes()):this.log.debug("Registered factory",a.assetType))},getAssetFactory:function(a,b){if("string"==typeof b){for(var c=0;c<this.factories.length;c++)if(this.factories[c].assetType===b)return this.factories[c];if(0===b.indexOf("."))for(var c=0;c<this.factories.length;c++)if(this.factories[c].canCreate(b))return this.factories[c]}else for(var c=0;c<this.factories.length;c++)if(this.factories[c].canCreate(a))return this.factories[c];return null},getLocalAssetPath:function(a){return CoreStringUtils.startsWith(a,"webrocket://")?a=a.substring(12):CoreStringUtils.startsWith(a,"meshmoon-applications://")&&(a=a.substring(24)),this.options.storages["webrocket://"]+a},getAsset:function(a){return this.cache.get(a)},abortTransfers:function(){if(void 0!==this.transfers)for(var a=0;a<this.transfers.length;a++)this.transfers[a].abort();if(void 0!==this.activeTransfers)for(var a=0;a<this.activeTransfers.length;a++)this.activeTransfers[a].abort()},forgetAssets:function(a){a="boolean"==typeof a?a:!0;for(var b=this.cache.getAssets(),c=0;c<b.length;c++){var d=b[c];null!=d&&Tundra.events.send("AssetAPI.AssetAboutToBeRemoved",d),a&&null!=d&&"function"==typeof d.unload&&(d.requiresCloning=!1,d.isCloneSource=!1,d.unload()),d=null}this.cache.forgetAssets()},forgetAsset:function(a,b){if(b="boolean"==typeof b?b:!0,"string"!=typeof a&&a instanceof IAsset&&(a=a.name),"string"!=typeof a)return void this.log.error("forgetAsset: Must pass in asset reference of IAsset instance:",a,b);var c=this.cache.get(a);c&&(Tundra.events.send("AssetAPI.AssetAboutToBeRemoved",c),b&&"function"==typeof c.unload&&(c.requiresCloning=!1,c.isCloneSource=!1,c.unload()),c=null,this.cache.remove(a))},update:function(a){if(void 0!==a){if(this.tranferCheckT+=a,this.tranferCheckT<this.tranferCheckInterval)return;this.tranferCheckT=0}if(this.transfers.length>0&&this.activeTransfers.length<this.maxActiveTransfers&&this.autoProcessTransfers===!0&&this.processTransfers(),this.readyTransfers.length>0){for(var b=0;b<this.readyTransfers.length;b++){var c=this.readyTransfers[b];c._emitCompleted(this.getAsset(c.ref)),delete c}this.readyTransfers=[]}},handleDefaultStorage:function(a){var b=JSON.parse(a);this.defaultStorage=b.storage},makeDefaultStorageRelativeRef:function(a){return null!=this.defaultStorage&&"string"==typeof this.defaultStorage.src&&CoreStringUtils.startsWith(a,this.defaultStorage.src)?a.substring(this.defaultStorage.src.length):void 0},resourceTypeForAssetRef:function(a){if(""===a)return void 0;var b=this.getAssetFactory(a);return null!=b&&"string"==typeof b.assetType?b.assetType:void 0},isSupportedAssetRef:function(a){return null!==this.getAssetFactory(a)},isSupportedAssetType:function(a){return null!==this.getAssetFactory(void 0,a)},isRelativeRef:function(a){if(0===a.indexOf("/"))return!0;if(this.isRegisteredStorageSheme(a))return!0;var b=a.toLowerCase();return 0!==b.indexOf("http://")&&0!==b.indexOf("https://")},isLocalhostRef:function(a){var b=a.toLowerCase(),c="";if(0===b.indexOf("http://")?c=b.substring(7):0===b.indexOf("https://")&&(c=b.substring(8)),""!==c){if(0===c.indexOf("localhost"))return!0;if("string"==typeof Tundra.DeveloperServerHost&&0===c.indexOf(Tundra.DeveloperServerHost))return!0}return!1},isRegisteredStorageSheme:function(a){var b=a.indexOf("://");return-1!==b?void 0!==this.options.storages[a.substring(0,b+3).toLowerCase()]:!1},resolveAssetRef:function(a,b){if("string"!=typeof b&&"string"==typeof a&&(b=a,a=""),"string"!=typeof b||""===b)return"";if(!this.isRelativeRef(b))return b;if(this.isRegisteredStorageSheme(b))return this.resolveCustomStorageRef(b);var c=b;if(CoreStringUtils.startsWith(b,"/")&&(b=b.substring(1)),a instanceof IAsset)return a.baseRef+b;if("string"==typeof a){if(""===a)return c;var d=a;return-1!==a.indexOf(".zip#")?d=a.substring(0,a.lastIndexOf(".zip#")+5):CoreStringUtils.endsWith(a,"/")||-1===a.indexOf("/")||(d=a.substring(0,a.lastIndexOf("/")+1)),d+b}return this.log.error("resolveAssetRef: Allowed 'context' types are IAsset and String, given:",a,"for ref",b),c},resolveCustomStorageRef:function(a){if("string"!=typeof a||""===a)return"";var b=a.indexOf("://");if(-1===b)return"";var c=a.substring(0,b+3).toLowerCase();if("http://"===c||"https://"===c)return"";var d=a.substring(b+3),e=this.options.storages[c];return"string"!=typeof e?"":(0===d.indexOf("/")&&(d=d.substring(1)),e+d)},requestDependencyAsset:function(a,b,c){if(!(a instanceof IAsset))return this.log.error("requestDependencyAsset called with non IAsset object as 'parentAsset':",a),null;if("string"!=typeof b)return this.log.error("requestDependencyAsset: 'ref' is not a string:",b),null;b=this.resolveAssetRef(a,b);var d=this.transfers.length,e=this.requestAsset(b,c);if(null==e)return e;if(e.addParentAsset(a),this.transfers.length>d){var f=this.transfers.splice(this.transfers.length-1,1)[0];f.ref!==e.ref&&this.log.error("Something went wrong in injecting transfer to the start of the queue: "+e.ref+" removed from last index: "+f.ref),this.transfers.splice(0,0,f)}if(void 0!==a&&void 0!==a.dependencyRefs){for(var g=!1,h=a.dependencyRefs.length-1;h>=0&&!(g=a.dependencyRefs[h]===e.ref);h--);g||a.dependencyRefs.push(e.ref)}return e},requestAsset:function(a,b){if("string"!=typeof a)return this.log.error("requestAsset: 'ref' is not a string:",a),null;if(CoreStringUtils.startsWith(a,"generated://",!0)||CoreStringUtils.startsWith(a,"local://",!0))return null;var c=this.getAssetFactory(a,b);if(null===c){var d=this.noFactoryErrors[a];return void 0===d&&("string"==typeof b?this.log.error("No registered AssetFactory for type '"+b+"':",a):this.log.error("No registered AssetFactory for suffix '"+CoreStringUtils.extension(a)+"':",a),this.noFactoryErrors[a]=!0),null}var e=CoreStringUtils.extension(a),f=c.assetType;("string"!=typeof e||""===e||-1!==e.indexOf("/"))&&(0===b.indexOf(".")?e=b.trim().toLowerCase():"Binary"===f?e="":this.log.warn("Failed to detect asset extension for '"+a+"':",e));var g=this.resolveCustomStorageRef(a);if("string"!=typeof g||""===g){if(CoreStringUtils.startsWith(a,"webrocket://")||CoreStringUtils.startsWith(a,"meshmoon-applications://"))a=this.getLocalAssetPath(a);else if(this.isRelativeRef(a)&&(a=null!=this.defaultStorage&&"string"==typeof this.defaultStorage.src?this.defaultStorage.src+a:this.options.storages["webrocket://"]+a,CoreStringUtils.startsWith(a,"local://",!0)))return console.warn("local:// default storage cannot be used with WebRocket. It has no direct disk access. Ignoring request:",a),null}else a=g;var h=void 0,i={};CoreStringUtils.startsWith(a,"http",!0)&&void 0!==AssetAPI.httpProxyResolver&&(h=AssetAPI.httpProxyResolver.resolve(i,a,f,e));for(var j=null,k=this.readyTransfers.length-1;k>=0;k--)if(j=this.readyTransfers[k],j.ref===a)return j;for(var k=this.transfers.length-1;k>=0;k--)if(j=this.transfers[k],j.ref===a)return j;var l=this.getAsset(a);if(void 0!==l&&null!==l){if(l.isLoaded())return j=new AssetTransfer(null,a,h,f,e),j.proxyMetadata=i,this.readyTransfers.push(j),j;this.cache.remove(l.name)}return j=new AssetTransfer(c,a,h,f,e),j.proxyMetadata=i,this.transfers.push(j),this._timing.cancel("transfers.completed.sync"),0===this._timing.data.transferNum&&(this._timing.data.tStart=performance.now()),this._timing.data.transferNum++,Tundra.events.send("AssetAPI.ActiveAssetTransferCountChanged",this.numCurrentTransfers()),j},processTransfers:function(a){void 0===a&&(a=!0);var b=!0;if(this.transfers.length>0&&this.activeTransfers.length<this.maxActiveTransfers)for(var c=this.numQueuedTransfersPerType(),d=0;d<this.transfers.length;++d){var e=this.transfers[d];if(void 0===e||null===e){this.transfers.splice(0,1);break}if(!e.active&&!e.loading){var f=this.maxAssetTransfersForType(e.type);if(!(void 0!==f&&"number"==typeof f&&f>0&&this.activeTransfersForType(e.type)>=f&&Object.keys(c).length>1)){b=!1,this.activeTransfers.push(e),e._send();break}}}a===!0&&!b&&this.transfers.length>0&&this.activeTransfers.length<this.maxActiveTransfers&&this.processTransfers(a)},maxAssetTransfersForType:function(a){return"string"==typeof a?this.maxActiveTransfersPerType[a]:void 0},numQueuedTransfersPerType:function(){for(var a={},b=0;b<this.transfers.length;b++)if(!this.transfers[b].active&&!this.transfers[b].loading){var c=this.transfers[b].type;void 0===a[c]&&(a[c]=0),a[c]+=1}return a},numQueuedTransfers:function(){for(var a=0,b=0;b<this.transfers.length;b++)!this.transfers[b].active&&this.transfers[b].loading&&(a+=1);return a},transferState:function(){for(var a={active:{},loading:{},queued:{}},b=0;b<this.activeTransfers.length;b++){var c=this.activeTransfers[b].type;void 0===a.active[c]&&(a.active[c]=0),a.active[c]+=1}for(var b=0;b<this.transfers.length;b++)if(!this.transfers[b].active){var d=this.transfers[b].loading?"loading":"queued",c=this.transfers[b].type;void 0===a[d][c]&&(a[d][c]=0),a[d][c]+=1}return a},activeTransfersForType:function(a){for(var b=0,c=0;c<this.activeTransfers.length;++c)this.activeTransfers[c].type===a&&b++;return b},removeActiveTransfer:function(a){for(var b=0;b<this.activeTransfers.length;++b)if(this.activeTransfers[b].ref===a.ref){this.activeTransfers.splice(b,1);break}},removeTransfer:function(a){this.removeActiveTransfer(a);for(var b=0;b<this.transfers.length;++b)if(this.transfers[b].ref===a.ref){this.transfers.splice(b,1);break}var c=this.numCurrentTransfers();Tundra.events.send("AssetAPI.ActiveAssetTransferCountChanged",c),0===c&&(this._timing.resolve("transfers.completed",!0,this._timing.data.transferNum),Tundra.client.isConnected()||this.log.isDebug()?this._timing.async("transfers.completed.sync",function(){if("number"==typeof this._timing.data.transferNum&&this._timing.data.transferNum>0){var a=performance.now()-this._timing.data.tStart,b=a/1e3,c=a/this._timing.data.transferNum,d=this._timing.data.transferNum/b;this.log.info(this._timing.data.transferNum,"transfers completed in",b.toFixed(2),"sec / avg",c.toFixed(0),"msec / QPS",d.toFixed(2),"- All done")}if(this._timing.data.transferNum=0,this.log.isDebug()||Tundra.network.options.debug===!1){for(var e={},f=Tundra.asset.cache.getAssets(),g=0;g<f.length;g++){var h=f[g];void 0===e[h.type]?e[h.type]=1:e[h.type]+=1}this.log.debug("Loaded assets:",e)}}.bind(this),500):this._timing.data.transferNum=0)},assetTransferCompleted:function(a,b){b.requiresCloning&&(b.isCloneSource=!0),void 0===this.getAsset(b.name)&&this.log.warn("Could not find cache item to update for",b.name,"Did you create the original asset with AssetAPI.createEmptyAsset?"),this.cache.set(b.name,b),this.removeTransfer(a),a._emitCompleted(b),b=null,delete a,a=null},assetTransferFailed:function(a,b){"string"==typeof b&&(a.silent||204===a.httpStatusCode||Tundra.client.logError("[AssetAPI]: "+b,!0)),this.removeTransfer(a),a._emitFailed(b),delete a,a=null},createEmptyAsset:function(a,b){var c=this.getAssetFactory(void 0,b);if(null!==c){var d=c.createEmptyAsset(a);return this.cache.set(d.name,d),Tundra.events.send("AssetAPI.AssetCreated",d),d}return null},numCurrentTransfers:function(){return this.transfers.length},allTransfersCompleted:function(){return 0===this.numCurrentTransfers()},onTransfersCompleted:function(){return this.allTransfersCompleted()?this._timing.deferImmediate("transfers.completed",!0,0):this._timing.defer("transfers.completed")},onActiveAssetTransferCountChanged:function(a,b){return Tundra.events.subscribe("AssetAPI.ActiveAssetTransferCountChanged",a,b)},onAssetCreated:function(a,b){return Tundra.events.subscribe("AssetAPI.AssetCreated",a,b)},onAssetDeserializedFromData:function(a,b){return Tundra.events.subscribe("AssetAPI.AssetDeserializedFromData",a,b)},_emitAssetDeserializedFromData:function(a){Tundra.events.send("AssetAPI.AssetDeserializedFromData",a),a._emitDeserializedFromData()},onAssetAboutToBeRemoved:function(a,b){return Tundra.events.subscribe("AssetAPI.AssetAboutToBeRemoved",a,b)}}),IApplication=Class.$extend({__init__:function(a){null==a&&(Tundra.client.log.warn("[IApplication]: Constructor called without a valid application name!",!0),a="Unknown Application"),Tundra.client.log.info("Starting "+a+" application"),this.log=TundraLogging.getLogger(a),this.framework=Tundra.framework,this.name=a,this.assetRef=IApplication.assetRef,this.entity=IApplication.entity,this.component=IApplication.component,this.eventSubscriptions=[],this.startupApplication=IApplication.startupApplication;try{void 0!==IApplication.parentScriptAsset&&null!==IApplication.parentScriptAsset&&IApplication.parentScriptAsset._setApplication(this)}catch(b){console.error("[IApplication]: Failed to register "+this.name+": "+b),void 0!==b.stack&&console.error(b)}},__classvars__:{entity:null,component:null,assetRef:null,startupApplication:null,parentScriptAsset:null,_setupStatic:function(a,b,c,d,e){IApplication.assetRef=c,IApplication.entity=a,IApplication.component=b,IApplication.startupApplication=d,IApplication.parentScriptAsset=e},_resetStatic:function(){IApplication.entity=null,IApplication.component=null,IApplication.assetRef=null,IApplication.startupApplication=null,IApplication.parentScriptAsset=null},loadDependencies:function(a){return a instanceof IApplication?(arguments[0]=a.assetRef,AssetAPI.loadDependencies.apply(AssetAPI,arguments)):(console.error("[IApplication]: loadDependencies: First parameter must be a IApplication instance given:",a),$.Deferred(function(a){a.reject()}).promise())}},_onScriptDestroyed:function(){try{this.onScriptDestroyed()}catch(a){console.error("IApplication.onScriptDestroyed:",this.name,this.entity),console.error(a)}this.name=null,this.assetRef=null,this.entity=null,this.component=null,this.startupApplication=null,this.framework=null,this.unsubscribeEvents()},onScriptDestroyed:function(){},resolveRef:function(a){var b=Tundra.asset.resolveAssetRef("",this.assetRef);return Tundra.asset.resolveAssetRef(b,a)},subscribeEvent:function(a){void 0!==a&&this.eventSubscriptions.push(a)},unsubscribeEvents:function(){for(var a=0;a<this.eventSubscriptions.length;a++)Tundra.events.unsubscribe(this.eventSubscriptions[a]);this.eventSubscriptions=[]}});window.IApplication=IApplication;var ICameraApplication=IApplication.$extend({__init__:function(a,b){void 0===b&&(b=!0),b===!0&&this.$super(a),this.cameraEntity=null,this.cameraApplicationState={applicationName:"",animateActivation:!1,animationT:0,animationDuration:2,animationStartTransform:null,animationEndTransform:null,previousCameraEntity:null,onUpdateSub:null,animationStart:null,animationStop:null,easing:new EasingCurve}},__classvars__:{CollisionsEnabled:!1,CollisionDistance:1.5,CollisionDistanceY:1.5,CollisionTargets:[],DirectionRays:[new THREE.Vector3(0,0,1),new THREE.Vector3(1,0,0),new THREE.Vector3(0,0,-1),new THREE.Vector3(-1,0,0),new THREE.Vector3(0,-1,0)],CollisionLastHitDirection:new THREE.Vector3(0,0,0),CollisionLastHitPosition:new THREE.Vector3(0,0,0),CollisionLastHitDistance:-1,detectCollision:function(a){if(ICameraApplication.CollisionsEnabled!==!0||0===ICameraApplication.CollisionTargets.length)return!1;if(null==a)return!1;for(var b=0,c=ICameraApplication.DirectionRays.length;c>b;++b){var d=ICameraApplication.DirectionRays[b],e=Tundra.renderer.raycastFrom(a,d,void 0,ICameraApplication.CollisionTargets,!0,!0,!1),f=0===d.y?ICameraApplication.CollisionDistance:ICameraApplication.CollisionDistanceY;if(e.distance>-.1&&e.distance<f)return ICameraApplication.CollisionLastHitDirection.copy(d),ICameraApplication.CollisionLastHitPosition.copy(e.pos),ICameraApplication.CollisionLastHitDistance=e.distance,!0}return!1},collision:function(a,b){if(0===ICameraApplication.CollisionTargets.length)return-1;if(null==a)return-1;var c=Tundra.renderer.raycastFrom(a,b,void 0,ICameraApplication.CollisionTargets,!0,!0,!1);return c},cameraApplicationTooltip:null,showCameraApplicationInfoTooltipEnabled:!0,showCameraApplicationInfoTooltip:function(a,b){var c=Tundra.plugin("LoginScreenPlugin");if((null==c||!c.isLoadingScreenVisible())&&ICameraApplication.showCameraApplicationInfoTooltipEnabled){void 0===b&&(b=2e3),null==ICameraApplication.cameraApplicationTooltip&&(ICameraApplication.cameraApplicationTooltip=$("<div/>",{id:"webrocket-camera-application-tooltip"}),ICameraApplication.cameraApplicationTooltip.css(ICameraApplication.cameraTooltipCSS),ICameraApplication.cameraApplicationTooltip.position({my:"center top",at:"center-100 top+10",of:Tundra.client.container}),ICameraApplication.cameraApplicationTooltip.hide(),Tundra.ui.addWidgetToScene(ICameraApplication.cameraApplicationTooltip),ICameraApplication.cameraApplicationTooltip.fadeIn());var d=a+" Camera";ICameraApplication.overrideCameraApplicationInfoTooltipText&&(d=ICameraApplication.overrideCameraApplicationInfoTooltipText(d)),ICameraApplication.cameraApplicationTooltip.text(d),void 0!==ICameraApplication.cameraApplicationTooltip.tooltipTimeoutId&&clearTimeout(ICameraApplication.cameraApplicationTooltip.tooltipTimeoutId),ICameraApplication.cameraApplicationTooltip.tooltipTimeoutId=setTimeout(function(){null!=ICameraApplication.cameraApplicationTooltip&&(ICameraApplication.cameraApplicationTooltip.fadeOut(function(){
$(this).remove()}),ICameraApplication.cameraApplicationTooltip.tooltipTimeoutId=void 0,ICameraApplication.cameraApplicationTooltip=null)},b)}},overrideCameraApplicationInfoTooltipText:function(a){return a},cameraTooltipCSS:{border:"1px solid grey","text-align":"center","min-width":200,"border-radius":4,padding:3,"padding-left":5,"padding-right":5,position:"absolute",width:"auto","font-family":"Arial","font-size":"14pt","font-weight":"bold",color:"color: rgb(56,56,56)","background-color":"rgba(248, 248, 248, 0.85)"}},_onScriptDestroyed:function(){this.$super(),this.resetCameraApplication()},startCameraApplication:function(a,b,c,d){if(void 0===a)return void console.error("[ICameraApplication]: createCameraEntity must pass applicationName e.g. 'Avatar' and entity name e.g. 'AvatarCamera'!");if(void 0===d&&(d=!0),null==this.cameraEntity?this.cameraEntity=Tundra.scene.createLocalEntity(["Name","Placeable","Camera","SoundListener"]):(this.cameraEntity.replicated=!1,this.cameraEntity.local=!0,this.cameraEntity.getOrCreateLocalComponent("Placeable"),this.cameraEntity.getOrCreateLocalComponent("Camera"),this.cameraEntity.getOrCreateLocalComponent("SoundListener")),this.cameraApplicationState.applicationName=a,this.cameraEntity.name=b,void 0!==c&&"number"==typeof c&&(this.cameraEntity.camera.verticalFov=c),this.subscribeEvent(Tundra.renderer.onActiveCameraChanged(this,this._onActiveCameraChanged)),d===!0)try{Tundra.client.registerCameraApplication(a,this)}catch(e){console.error(e.stack||e)}return this.cameraEntity},setVerticalFov:function(a){null!=this.cameraEntity&&null!=this.cameraEntity.camera&&void 0!==a&&"number"==typeof a&&(this.cameraEntity.camera.verticalFov=a)},resetCameraApplication:function(){this._subCameraAnimationFrameUpdates(!0),this.cameraEntity=null},animateBeforeActivation:function(a){"boolean"==typeof a&&(this.cameraApplicationState.animateActivation=a)},_subCameraAnimationFrameUpdates:function(a){void 0===a&&(a=!1),null!=this.cameraApplicationState.onUpdateSub&&Tundra.events.unsubscribe(this.cameraApplicationState.onUpdateSub),a===!1?this.cameraApplicationState.onUpdateSub=Tundra.frame.onUpdate(this,this._onCameraAnimationUpdate):null!=this.cameraEntity&&null!=this.cameraEntity.camera&&(this.cameraEntity.camera._animating=!1)},_onCameraStepAnimation:function(a){var b=this.cameraApplicationState,c=b.animationStart.pos.clone();c.lerp(b.animationStop.pos.clone(),a);var d=b.animationStart.rot.clone();d.slerp(b.animationStop.rot.clone(),a),d.normalize(),this.cameraEntity.placeable.setWorldPosition(c),this.cameraEntity.placeable.setWorldOrientation(d)},_onCameraAnimationUpdate:function(a){var b=this.cameraApplicationState;if(!(b.animationT<b.animationDuration))return this._onCameraStepAnimation(1),this._subCameraAnimationFrameUpdates(!0),this.onCameraActivated(this.cameraEntity,b.previousCameraEntity),b.animationT=0,b.previousCameraEntity=null,b.animationStart=null,void(b.animationStop=null);var c=b.easing.getTime(b.animationT/b.animationDuration);this._onCameraStepAnimation(c),b.animationT+=a},_activateCameraApplication:function(){null!=this.cameraEntity&&null!=this.cameraEntity.camera&&this.cameraEntity.camera.setActive()},_onActiveCameraChanged:function(a,b){void 0!==a&&null!==a&&(a===this.cameraEntity.camera?this._onCameraActivated(this.cameraEntity,void 0!==b?b.parentEntity:void 0):b===this.cameraEntity.camera&&(this._subCameraAnimationFrameUpdates(!0),this.onCameraDeactivated(this.cameraEntity,a.parentEntity)))},_onCameraActivated:function(a,b){ICameraApplication.showCameraApplicationInfoTooltip(this.cameraApplicationState.applicationName),this.cameraApplicationState.animateActivation===!1||null==b||null==b.placeable||null==a.placeable?this.onCameraActivated(a,b):(this.cameraApplicationState.animationT=0,this.cameraApplicationState.previousCameraEntity=b,this.cameraApplicationState.animationStart={pos:b.placeable.worldPosition(),rot:b.placeable.worldOrientation()},this.cameraApplicationState.animationStop={pos:a.placeable.worldPosition(),rot:a.placeable.worldOrientation()},a.placeable.setWorldPosition(this.cameraApplicationState.animationStart.pos),a.placeable.setWorldOrientation(this.cameraApplicationState.animationStart.rot),a.camera._animating=!0,this._subCameraAnimationFrameUpdates(!1))},onCameraActivated:function(a,b){},onCameraDeactivated:function(a,b){}});window.ICameraApplication=ICameraApplication,BitArray.ELEMENT_WIDTH=24,BitArray.prototype.set=function(a,b){1==b?this.field[~~(a/BitArray.ELEMENT_WIDTH)]|=1<<a%BitArray.ELEMENT_WIDTH:this.field[~~(a/BitArray.ELEMENT_WIDTH)]&1<<a%BitArray.ELEMENT_WIDTH&&(this.field[~~(a/BitArray.ELEMENT_WIDTH)]^=1<<a%BitArray.ELEMENT_WIDTH)},BitArray.prototype.get=function(a){return(this.field[~~(a/BitArray.ELEMENT_WIDTH)]&1<<a%BitArray.ELEMENT_WIDTH)>0?1:0},BitArray.prototype.each=function(a){for(var b=0;b<this.size;b++)a(this.get(b),b)},BitArray.prototype.toString=function(){var a=this.field.map(function(a){var b=a.toString(2);return b=new Array(BitArray.ELEMENT_WIDTH-b.length+1).join("0")+b}).reverse().join("");return a.split("").reverse().join("").slice(0,this.size)};var DataDeserializer=Class.$extend({__init__:function(a,b,c){this.bytePos=0,this.bitPos=0,void 0!==a&&this.setBuffer(a,b,c),Object.defineProperties(this,{pos:{get:function(){return this.bytesRead()}}})},__classvars__:{floatReadDataView:new DataView(new ArrayBuffer(4)),doubleReadDataView:new DataView(new ArrayBuffer(8)),readByteFromBits:function(a,b){for(var c=0,d=0;8>d;++d){var e=a.get(b+d);1===e?c|=1<<d:c&=~(1<<d)}return c}},setBuffer:function(a,b,c){void 0===c?this.data=new DataView(a,b):this.data=new DataView(a,b,c),this.bytePos=0,this.bitPos=0},readUint8Array:function(a){var b=new Uint8Array(this.data.buffer,this.bytePos,a);return this.bytePos+=a,b},bytesRead:function(){return this.bytePos},readBytes:function(){return this.bytesRead()},bytesLeft:function(){return this.bytePos>=this.data.byteLength?0:this.data.byteLength-this.bytePos},bitsLeft:function(){return this.bytePos>=this.data.byteLength?0:8*(this.data.byteLength-this.bytePos)-this.bitPos},skipBytes:function(a){this.bytePos+=a},readBoolean:function(){return this.readU8()>0},readBool:function(){return this.readBoolean()},readUtf8CharCode:function(){var a,b,c,d,e;return a=this.readU8(),128>a?a:224>a?(b=this.readU8(),63&b|(31&a)<<6):240>a?(b=this.readU8(),c=this.readU8(),63&c|(63&b)<<6|(15&a)<<12):248>a?(b=this.readU8(),c=this.readU8(),d=this.readU8(),63&d|(63&c)<<6|(63&b)<<12|(7&a)<<18):252>a?(b=this.readU8(),c=this.readU8(),d=this.readU8(),e=this.readU8(),63&e|(63&d)<<6|(63&c)<<12|(63&b)<<18|(3&a)<<24):(b=this.readU8(),c=this.readU8(),d=this.readU8(),e=this.readU8(),char6=this.readU8(),63&char6|(63&e)<<6|(63&d)<<12|(63&c)<<18|(63&b)<<24|(1&a)<<30)},readStringUntil:function(a,b){for(var c="";this.bytesLeft()>0;){var d=this.readU8(),e=String.fromCharCode(d);if(void 0!==b&&d===b)break;if(void 0!==a&&e===a)break;c+=e}return c},readString:function(a,b){"boolean"!=typeof b&&(b=!1);var c="";if(a>0){var d=this.bytePos+a;if(b)for(;this.bytePos<d;)c+=String.fromCharCode(this.readUtf8CharCode(d-this.bytePos));else for(;this.bytePos<d;)c+=String.fromCharCode(this.readU8())}return c},readStringU8:function(a){return this.readString(this.readU8(),a)},readStringU16:function(a){return this.readString(this.readU16(),a)},readStringU32:function(a){return this.readString(this.readU32(),a)},readS8:function(){if(0===this.bitPos){var a=this.data.getInt8(this.bytePos);return this.bytePos+=1,a}return this.readBits(8)},readU8:function(){if(0===this.bitPos){var a=this.data.getUint8(this.bytePos);return this.bytePos+=1,a}return this.readBits(8)},readS16:function(){if(0===this.bitPos){var a=this.data.getInt16(this.bytePos);return this.bytePos+=2,a}return this.readBits(16)},readU16:function(){if(0===this.bitPos){var a=this.data.getUint16(this.bytePos,!0);return this.bytePos+=2,a}return this.readBits(16)},readS32:function(){if(0===this.bitPos){var a=this.data.getInt32(this.bytePos,!0);return this.bytePos+=4,a}return this.readBits(32)},readU32:function(){if(0===this.bitPos){var a=this.data.getUint32(this.bytePos,!0);return this.bytePos+=4,a}return this.readBits(32)},readFloat32:function(){if(0===this.bitPos){var a=this.data.getFloat32(this.bytePos,!0);return this.bytePos+=4,a}return DataDeserializer.floatReadDataView.setUint32(0,this.readBits(32),!0),DataDeserializer.floatReadDataView.getFloat32(0,!0)},readFloat64:function(){if(0===this.bitPos){var a=this.data.getFloat64(this.bytePos,!0);return this.bytePos+=8,a}return DataDeserializer.doubleReadDataView.setUint64(0,this.readBits(64),!0),DataDeserializer.doubleReadDataView.getFloat64(0,!0)},readFloat32Vector3:function(){return{x:this.readFloat32(),y:this.readFloat32(),z:this.readFloat32()}},readFloat32Vector4:function(){return{x:this.readFloat32(),y:this.readFloat32(),z:this.readFloat32(),w:this.readFloat32()}},readVLE:function(){var a=this.readU8();if(0===(128&a))return a;a=127&a;var b=this.readU8();if(0===(128&b))return a|b<<7;b=127&b;var c=this.readU16();return a|b<<7|c<<14},readBit:function(){return this.readBits(1)},readBits:function(a){for(var b=0,c=0,d=this.data.getUint8(this.bytePos);a>0;)d&1<<this.bitPos&&(b|=1<<c),c++,a--,this.bitPos++,this.bitPos>7&&(this.bitPos=0,this.bytePos++,a>0&&(d=this.data.getUint8(this.bytePos)));return b},readBitArray:function(a){for(var b=0,c=new BitArray(8*a,0),d=0;a>d;++d)for(var e=this.readU8(),f=0;8>f;++f){var g=(~~e&1<<f)>0?1:0;c.set(b,g),b++}return c}}),INetworkMessageHandler=Class.$extend({__init__:function(a){this.name=a},canHandle:function(a){return!1},handle:function(a,b){return!1}}),DataSerializer=Class.$extend({__init__:function(a,b){if("number"!=typeof a&&(Tundra.client.logWarning("[DataSerializer]: You are creating a data serializer with undefined size! Initializing size to 0 bytes."),a=0),b="number"==typeof b?b:DataSerializer.ArrayType.Uint8,b===DataSerializer.ArrayType.Uint8)this.array=new Uint8Array(a);else if(b===DataSerializer.ArrayType.Uint16)this.array=new Uint16Array(a);else if(b===DataSerializer.ArrayType.Uint32)this.array=new Uint32Array(a);else if(b===DataSerializer.ArrayType.Float32)this.array=new Float32Array(a);else{if(b!==DataSerializer.ArrayType.Float64)return void Tundra.client.logError("[DataSerializer]: Unknown 'arrayType' "+b+". Use on of the supported ones from DataSerializer.ArrayType");this.array=new Float64Array(a)}this.data=new DataView(this.array.buffer),this.bytePos=0,this.bitPos=0,this.type=b,Object.defineProperties(this,{pos:{get:function(){return this.filledBytes()}}})},__classvars__:{floatWriteDataView:new DataView(new ArrayBuffer(4)),doubleWriteDataView:new DataView(new ArrayBuffer(8)),ArrayType:{Uint8:0,Uint16:1,Uint32:2,Float32:3,Float64:4},utf8StringByteSize:function(a){for(var b=0,c=0,d=a.length;d>c;++c)b+=DataSerializer.utf8CharCodeByteSize(a.charCodeAt(c));return b},utf8CharCodeByteSize:function(a){return 128>a?1:2048>a?2:65536>a?3:2097152>a?4:67108864>a?5:6},vleHeaderSizeBytes:function(a){return 128>a?1:16384>a?2:4}},getBuffer:function(){return this.array.buffer},filledBytes:function(){return 0===this.bitPos?this.bytePos:this.bytePos+1},filledBits:function(){return 8*this.bytePos+this.bitPos},capacity:function(){return this.data.byteLength},bytesLeft:function(){return this.bytePos>=this.data.byteLength?0:this.data.byteLength-this.bytePos},bitsLeft:function(){return this.bytePos>=this.data.byteLength?0:8*(this.data.byteLength-this.bytePos)-this.bitPos},skipBytes:function(a){this.bytePos+=a},writeBoolean:function(a){this.writeU8(a===!0?1:0)},writeUint8Array:function(a){for(var b=0,c=a.length;c>b;++b)this.writeU8(a[b])},writeUtf8Char:function(a){128>a?this.writeU8(a):2048>a?(this.writeU8(192|a>>6&31),this.writeU8(128|63&a)):65536>a?(this.writeU8(224|a>>12&15),this.writeU8(128|a>>6&63),this.writeU8(128|63&a)):2097152>a?(this.writeU8(240|a>>18&7),this.writeU8(128|a>>12&63),this.writeU8(128|a>>6&63),this.writeU8(128|63&a)):67108864>a?(this.writeU8(248|a>>24&3),this.writeU8(128|a>>18&63),this.writeU8(128|a>>12&63),this.writeU8(128|a>>6&63),this.writeU8(128|63&a)):(this.writeU8(252|a>>30&1),this.writeU8(128|a>>24&63),this.writeU8(128|a>>18&63),this.writeU8(128|a>>12&63),this.writeU8(128|a>>6&63),this.writeU8(128|63&a))},writeStringWithHeader:function(a,b,c){"boolean"!=typeof c&&(c=!1);var d=c?DataSerializer.utf8StringByteSize(b):b.length;1==a?this.writeU8(d):2==a?this.writeU16(d):4==a?this.writeU32(d):this.writeVLE(d);var e=0,f=b.length;if(c)for(;f>e;++e)this.writeUtf8Char(b.charCodeAt(e));else for(;f>e;++e)this.writeU8(b.charCodeAt(e))},writeStringVLE:function(a,b){this.writeStringWithHeader(0,a,b)},writeStringU8:function(a,b){this.writeStringWithHeader(1,a,b)},writeStringU16:function(a,b){this.writeStringWithHeader(2,a,b)},writeStringU32:function(a,b){this.writeStringWithHeader(4,a,b)},writeS8:function(a){0===this.bitPos?(this.data.setInt8(this.bytePos,a),this.bytePos+=1):this.writeBits(a,8)},writeU8:function(a){0===this.bitPos?(this.data.setUint8(this.bytePos,a),this.bytePos+=1):this.writeBits(a,8)},writeS16:function(a){0===this.bitPos?(this.data.setInt16(this.bytePos,a,!0),this.bytePos+=2):this.writeBits(a,16)},writeU16:function(a){0===this.bitPos?(this.data.setUint16(this.bytePos,a,!0),this.bytePos+=2):this.writeBits(a,16)},writeS32:function(a){0===this.bitPos?(this.data.setIn32(this.bytePos,a,!0),this.bytePos+=4):this.writeBits(a,32)},writeU32:function(a){0===this.bitPos?(this.data.setUint32(this.bytePos,a,!0),this.bytePos+=4):this.writeBits(a,32)},writeFloat32:function(a){0===this.bitPos?(this.data.setFloat32(this.bytePos,a,!0),this.bytePos+=4):(Tundra.floatWriteDataView.setFloat32(0,a,!0),this.writeBits(Tundra.floatWriteDataView.getUint32(0,!0),32))},writeFloat64:function(a){0===this.bitPos?(this.data.setFloat64(this.bytePos,a,!0),this.bytePos+=8):(Tundra.doubleWriteDataView.setFloat64(0,a,!0),this.writeBits(Tundra.doubleWriteDataView.getUint64(0,!0),64))},writeVLE:function(a){128>a?this.writeU8(a):16384>a?(this.writeU8(127&a|128),this.writeU8(a>>7)):(this.writeU8(127&a|128),this.writeU8(a>>7&127|128),this.writeU16(a>>14))},writeBits:function(a,b){for(var c=0,d=this.data.getUint8(this.bytePos);b>0;)a&1<<c?d|=1<<this.bitPos:d&=255-(1<<this.bitPos),c++,b--,this.bitPos++,this.bitPos>7&&(this.bitPos=0,this.data.setUint8(this.bytePos,d),this.bytePos++,b>0&&(d=this.data.getUint8(this.bytePos)));0!==this.bitPos&&this.data.setUint8(this.bytePos,d)}}),INetworkMessage=Class.$extend({__init__:function(a,b){this.id=a,this.name=void 0!==b?b:INetworkMessage.Ids[a]},__classvars__:{id:0,name:"",Ids:{100:"LoginMessage",101:"LoginReplyMessage",102:"ClientJoinedMessage",103:"ClientLeftMessage",110:"CreateEntityMessage",111:"CreateComponentsMessage",112:"CreateAttributesMessage",113:"EditAttributesMessage",114:"RemoveAttributesMessage",115:"RemoveComponentsMessage",116:"RemoveEntityMessage",117:"CreateEntityReplyMessage",118:"CreateComponentsReplyMessage",119:"RigidBodyUpdateMessage",120:"EntityActionMessage",121:"AssetDiscoveryMessage",122:"AssetDeletedMessage"}},getBuffer:function(){return void 0!==this.ds&&null!==this.ds&&this.ds instanceof DataSerializer?this.ds.getBuffer():null},deserialize:function(a){this.ds=a},serialize:function(a){this.ds=new DataSerializer(a)}}),LoginReplyMessage=INetworkMessage.$extend({__init__:function(){this.$super(LoginReplyMessage.id,"LoginReplyMessage"),this.success=!1,this.connectionId=-1,this.replyData=""},__classvars__:{id:101,name:"LoginReplyMessage"},deserialize:function(a){this.success=a.readBoolean(),this.connectionId=a.readVLE(),this.replyData=a.readStringU16(),delete a}}),ClientJoinedMessage=INetworkMessage.$extend({__init__:function(){this.$super(ClientJoinedMessage.id,"ClientJoinedMessage"),this.connectionId=-1},__classvars__:{id:102,name:"ClientJoinedMessage"},deserialize:function(a){this.connectionId=a.readVLE(),delete a}}),ClientLeftMessage=INetworkMessage.$extend({__init__:function(){this.$super(ClientLeftMessage.id,"ClientLeftMessage"),this.connectionId=-1},__classvars__:{id:103,name:"ClientLeftMessage"},deserialize:function(a){this.connectionId=a.readVLE(),delete a}}),EntityAction=Class.$extend({__init__:function(){this.name=void 0,this.executionType=EntityAction.Invalid,this.parameters=[],this.entity=void 0,this.entityId=void 0},__classvars__:{Invalid:0,Local:1,Server:2,Peers:4}}),EntityActionMessage=INetworkMessage.$extend({__init__:function(){this.$super(EntityActionMessage.id,"EntityActionMessage"),this.entityAction=new EntityAction},__classvars__:{id:120,name:"EntityActionMessage",staticNumBytes:9},deserialize:function(a){var b=!1;this.entityAction.entityId=a.readU32(),this.entityAction.name=a.readStringU8(b),this.entityAction.executionType=a.readU8();for(var c=a.readU8(),d=0;c>d;++d){var e=a.readVLE();this.entityAction.parameters[d]=a.readString(e,b)}delete a},serialize:function(a){if(void 0===a.entityId&&void 0===a.entity)return void Tundra.client.logError("[EntityActionMessage]: serialize() called with entity action that does not have entityId or entity set!");var b=!1,c=DataSerializer.utf8StringByteSize(a.name);c+=4*a.parameters.length;var d,e;for(d=0,e=a.parameters.length;e>d;++d)c+=DataSerializer.utf8StringByteSize(a.parameters[d]);for(this.$super(EntityActionMessage.staticNumBytes+c),this.ds.writeU16(this.id),this.ds.writeU32(void 0!==a.entityId?a.entityId:a.entity.id),this.ds.writeStringU8(a.name),this.ds.writeU8(a.executionType),this.ds.writeU8(a.parameters.length),d=0,e=a.parameters.length;e>d;++d)this.ds.writeStringVLE(a.parameters[d],b)}}),TundraMessageHandler=INetworkMessageHandler.$extend({__init__:function(){this.$super("TundraMessageHandler")},canHandle:function(a){return a>=101&&103>=a?!0:120===a?!0:a>=110&&116>=a?!0:!1},handle:function(a,b){var c=Tundra.client;if(a>=110&&116>=a){var d=new INetworkMessage(a);d.deserialize(b),c.scene.onTundraMessage(d)}else if(a===EntityActionMessage.id){var d=new EntityActionMessage;d.deserialize(b),c.scene.handleEntityActionMessage(d)}else if(a===LoginReplyMessage.id){var d=new LoginReplyMessage;d.deserialize(b),d.success?(c.connectionId=d.connectionId,""!==d.loginReplyData&&c.asset.handleDefaultStorage(d.replyData)):(c.log.error("Authentication to server failed: ",d),c.disconnect())}else if(a===ClientJoinedMessage.id){var d=new ClientJoinedMessage;d.deserialize(b)}else if(a===ClientLeftMessage.id){var d=new ClientLeftMessage;d.deserialize(b)}}}),WebSocketTester=Class.$extend({__init__:function(){this.log=TundraLogging.getLogger("WebSocketTester"),this.timing=new AsyncHelper("WebSocketTester",this)},on:function(a){return a=a.trim().toLowerCase(),"connected"===a&&this.isConnected()?this.timing.deferImmediate(a,!0,{}):this.timing.defer(a)},connect:function(a,b){this.options=$.extend({message:"",disconnectOnFirstMessage:!0,showDialogOnError:!0},b),a=a.trim(),CoreStringUtils.startsWith(a,"http://",!0)?a=a.substring(7):CoreStringUtils.startsWith(a,"https://",!0)&&(a=a.substring(8)),CoreStringUtils.startsWith(a,"ws://")||CoreStringUtils.startsWith(a,"wss://")||(a="ws://"+a),this.websocket=new WebSocket(a),this.websocket.onopen=this.onOpened.bind(this),this.websocket.onerror=this.onError.bind(this),this.websocket.onclose=this.onClosed.bind(this),this.websocket.onmessage=this.onMessage.bind(this)},disconnect:function(){void 0!==this.websocket&&this.websocket.close(),this.websocket=void 0},isConnected:function(){return void 0===this.websocket?!1:3!==this.websocket.readyState?!0:!1},send:function(a){void 0!==this.websocket&&this.websocket.send(a)},onOpened:function(a){this.log.debug("connected"),this._dispatch("connected",!0,a),"string"==typeof this.options.message&&""!==this.options.message&&(this.send(this.options.message),this.options.message=void 0)},onError:function(a){this.log.debug("error",a),this._dispatch("error",!0,a),this.options.showDialogOnError===!0&&Tundra.ui.openModalDialog({heading:"Restricted Network",html:'<div>Check your firewall settings or contact your network administrator.<div><div>Follow <a href="http://doc.meshmoon.com/index.html?page=web-rocket-troubleshooting" target="_blank" style="color:steelblue; text-decoration:none;">this guide</a> to configure your firewall.</div></div>',icon:"warning",iconColor:"rgb(207, 190, 16)"})},onClosed:function(a){this.log.debug("disconnected"),this._dispatch("disconnected",!0,a)},onMessage:function(a){this.log.debug("message",a),this._dispatch("message",!0,a),this.options.disconnectOnFirstMessage===!0&&this.disconnect()},_dispatch:function(a,b,c){try{this.timing.resolve(a,b,c)}catch(d){this.log.error("Exception in '"+a+"' handlers:",d)}}}),Network=ITundraAPI.$extend({__init__:function(a,b,c){this.$super(a,b),this.messageHandlers=[]},initialize:function(){this.registerMessageHandler(new TundraMessageHandler)},postInitialize:function(){Tundra.console.registerCommand("disconnect","Disconnects the active server connection",null,Tundra.client,Tundra.client.disconnect)},__classvars__:{getDefaultOptions:function(){return{debug:!1}},components:{1:"Avatar",21:"RttTarget",2:"Billboard",23:"RigidBody",5:"Script",24:"VolumeTrigger",6:"Sound",25:"DynamicComponent",7:"SoundListener",26:"Name",8:"EnvironmentLight",27:"ParticleSystem",9:"Fog",28:"Highlight",10:"Sky",29:"HoveringText",11:"Terrain",30:"TransformGizmo",12:"WaterPlane",31:"Material",13:"InputMapper",33:"ProximityTrigger",32:"SceneShadowSetup",14:"AnimationController",34:"PlanarMirror",15:"Camera",35:"WidgetCanvas",16:"Light",36:"WebView",17:"Mesh",37:"MediaPlayer",18:"OgreCompositor",38:"SkyX",19:"OgreCustomObject",39:"Hydrax",20:"Placeable",40:"LaserPointer",41:"SlideShow",52:"GraphicsViewCanvas",42:"WidgetBillboard",108:"StencilGlow",43:"PhysicsMotor",500:"MeshmoonAvatar",501:"WebBrowser",502:"MediaBrowser",503:"MeshmoonTeleport",506:"MeshmoonWater",507:"MeshmoonSky",508:"MeshmoonCloudLayer",509:"Meshmoon3DText"}},registerMessageHandler:function(a){return a instanceof INetworkMessageHandler?void this.messageHandlers.push(a):void this.log.error("registerMessageHandler called with a non INetworkMessageHandler object:",hadler)},send:function(a){if(Tundra.client._isWebSocketConnected()){if(!(a instanceof INetworkMessage))return void this.log.error("Cannot send message, given object is not an instance of INetworkMessage!");var b=a.getBuffer();null!==b?Tundra.client.websocket.send(b):this.log.error("Cannot send message as it's buffer is null! Are you sure it's an outgoing message and serialize() has been called?"),delete a,a=null}},receive:function(a){for(var b=new DataDeserializer(a,0),c=b.readU16(),d=0;d<this.messageHandlers.length;d++)if(this.messageHandlers[d].canHandle(c))return void this.messageHandlers[d].handle(c,b);var e=new INetworkMessage(c);this.log.warn("Received an unhandled network message",e.name,e.id)}}),EventSubscription=Class.$extend({__init__:function(a,b,c){this.channel=a,this.id=b,this.priority=c},reset:function(){Tundra.events.unsubscribe(this)},isActive:function(){return void 0!==this.id}}),EventAPI=ITundraAPI.$extend({__init__:function(a,b,c){this.$super(a,b),this.signals={},this.debugging=!1},send:function(a){if(a="string"==typeof a?a:a.channel,"string"!=typeof a)return this.log.error("send: First parameter must be a channel name or a EventSubscription object:",a),!1;var b=this.signals[a];if(void 0===b||!b.hasActiveBindings())return!1;var c=[].slice.call(arguments,1);return b.dispatch.apply(b,c),!b._shouldPropagate},subscribe:function(a,b,c,d){"function"==typeof b&&"function"!=typeof c&&("number"==typeof c&&"number"!=typeof d&&(d=c),c=b,b=void 0),d="number"==typeof d?d:0;var e=this._getOrCreateSignal(a);return e.subscribe(c,b,d)},_getOrCreateSignal:function(a){var b=this.signals[a];return void 0!==b?b:this._createSignal(a)},_createSignal:function(a){var b=new signals.Signal;return b.tundra={subIndex:0,channel:a,debugging:this.debugging},b.subscribe=function(a,b,c){var d=++this.tundra.subIndex,e=new EventSubscription(this.tundra.channel,d),f=this.add(a,b,c);return f.tundra={id:d,subscription:e},this.tundra.debugging===!0&&console.debug("subscribed  ",f.tundra.subscription.id,this.tundra.channel),e},b.unsubscribe=function(a){for(var b=this._bindings.length-1;b>=0;b--){var c=this._bindings[b];if(c.tundra.id===a)return c.tundra.subscription instanceof EventSubscription&&(this.tundra.debugging===!0&&console.debug("unsubscribed",c.tundra.subscription.id,this.tundra.channel),c.tundra.subscription.id=void 0),c.tundra={},c._destroy(),c.active=!1,this._bindings.splice(b,1),!0}return!1},b.aboutToDispose=function(){for(var a=this._bindings.length-1;a>=0;a--){var b=this._bindings[a];b.tundra.subscription instanceof EventSubscription&&(this.tundra.debugging===!0&&console.debug("unsubscribed ALL",b.tundra.subscription.id,this.tundra.channel),b.tundra.subscription.id=void 0),b.tundra={}}},b.numBindings=function(){return this._bindings.length},b.hasActiveBindings=function(){for(var a=this._bindings.length-1;a>=0;a--)if(this._bindings[a].active===!0)return!0;return!1},b.numActiveBindings=function(){for(var a=0,b=this._bindings.length-1;b>=0;b--)this._bindings[b].active===!0&&a++;return a},b.numSubscribtions=function(){for(var a=0,b=this._bindings.length-1;b>=0;b--){var c=this._bindings[b];c.tundra.subscription instanceof EventSubscription&&a++}return a},b.hasActiveSubscribtions=function(){for(var a=this._bindings.length-1;a>=0;a--){var b=this._bindings[a];if(b.tundra.subscription instanceof EventSubscription&&"number"==typeof b.tundra.subscription.id)return!0}return!1},b.numActiveSubscribtions=function(){for(var a=0,b=this._bindings.length-1;b>=0;b--){var c=this._bindings[b];c.tundra.subscription instanceof EventSubscription&&"number"==typeof c.tundra.subscription.id&&a++}return a},this.signals[a]=b,b},unsubscribe:function(a,b){var c=a,d=b;if(a instanceof EventSubscription&&(c=a.channel,d=a.id),"string"!=typeof c||"number"!=typeof d)return!1;var e=this.signals[c];if(void 0===e)return!1;var f=e.unsubscribe(d);return f&&!e.hasActiveBindings()&&(this.debugging===!0&&console.debug("disposing empty channel",e.tundra.channel),e.dispose(),e=void 0,delete this.signals[c]),f&&a instanceof EventSubscription&&(a.id=void 0),f},remove:function(a){var b=this.signals[a];return void 0!==b?(b.aboutToDispose(),b.dispose(),b=void 0,delete this.signals[a],!0):!1},dumpState:function(){var a=0;for(var b in this.signals){var c=this.signals[b];a+=c.numActiveSubscribtions(),console.debug({bindings:c.numBindings(),active_b:c.numActiveBindings(),subs:c.numSubscribtions(),active_s:c.numActiveSubscribtions()},b),(c.numBindings()!==c.numActiveBindings()||c.numSubscribtions()!==c.numActiveSubscribtions())&&console.warn("Number of listeners do not match up. EventAPI internals might have a bug?")}console.debug("Total signals",Object.keys(this.signals).length,"Total subscriptions",a)}}),ConfigAPI=ITundraAPI.$extend({__init__:function(a,b,c){this.$super(a,b),this.supported=void 0!==window.localStorage,this.supported||this.log.warn("Browser does not support 'localStorage', disabling functionality.")},readSection:function(a){if("string"!=typeof a||""===a.trim())return this.log.error("readSection: Invalid 'section':",a),{};if(!this.supported)return{};var b=localStorage.getItem("webrocket."+a);if("string"==typeof b)try{return JSON.parse(b)}catch(c){this.log.error("readSection: failed to parse object from section '"+a+"' value '"+b+"': "+c),c.stack&&console.error(c.stack)}return{}},read:function(a,b,c){if("string"!=typeof b||""===b.trim())return this.log.error("read: Invalid 'key':",b),c;if(!this.supported)return c;var d=this.readSection(a);return"object"!=typeof d?c:void 0!==d[b]?d[b]:c},writeSection:function(a,b){if("string"!=typeof a||""===a.trim())return this.log.error("writeSection: Invalid 'section':",a),!1;if(null===b||"object"!=typeof b||Array.isArray(b))return this.log.error("writeSection: Invalid parameter 'obj' not type of 'object' instead is '"+(Array.isArray(b)?"Array":typeof b)+"'",b),(null===b||void 0===b)&&this.log.error("You used undefined or null, if you wish to reset/remove the section pass in a empty object literal '{}' instead"),!1;if(!this.supported)return!1;try{return localStorage.setItem("webrocket."+a,JSON.stringify(b)),!0}catch(c){this.log.error("writeSection: "+c),c.stack&&console.error(c.stack)}return!1},write:function(a,b,c){if("string"!=typeof b||""===b.trim())return this.log.error("write: Invalid 'key':",b),!1;if(!this.supported)return!1;var d=this.readSection(a);return void 0!==c?d[b]=c:delete d[b],this.writeSection(a,d)},valueExists:function(a,b){if("string"!=typeof b||""===b.trim())return this.log.error("valueExists: Invalid 'key':",b),!1;if(!this.supported)return!1;var c=this.readSection(a);return void 0!==c[b]}}),ConsoleAPI=ITundraAPI.$extend({__init__:function(a,b,c){this.$super(a,b),this.commands=[]},initialize:function(){Tundra.client.onLogInfo(this,this.logInfo),Tundra.client.onLogWarning(this,this.logWarning),Tundra.client.onLogError(this,this.logError),this.registerCommand("help","Prints all available console commands",null,this,this.help)},help:function(){if(!(this.commands.length<=0)){for(var a=0,b=0;b<this.commands.length;++b)this.commands[b].name.length>a&&(a=this.commands[b].name.length);var c="";for(b=0;b<this.commands.length;++b){var d=this.commands[b];if(void 0!==d.name&&null!==d.name){for(var e=d.name;e.length<a;)e+=" ";if(c+="  "+e+(""!==d.description?" - "+d.description:"")+"<br/>",""!==d.parameterDescription){for(var f="";f.length<a;)f+=" ";c+=f+"     <span style='color:black;'>"+d.parameterDescription+"</span><br/>"}}}var g=Tundra.client;if(g.ui.console){var h=g.ui.console.html();g.ui.console.html(h+"<span style='color:brown;'>"+c+"</span>"),g.ui.console.is(":visible")&&g.ui.console.animate({scrollTop:g.ui.console.prop("scrollHeight")},{queue:!1,duration:350})}}},commandSuggestion:function(a){for(var b=a.toLowerCase(),c=0;c<this.commands.length;++c)if(this.commands[c].name.toLowerCase()===b)return null;for(c=0;c<this.commands.length;++c)if(0===this.commands[c].name.toLowerCase().indexOf(b))return this.commands[c].name;return null},getCommandData:function(a){for(var b=a.toLowerCase(),c=0;c<this.commands.length;++c)if(this.commands[c].name.toLowerCase()===b)return this.commands[c];return null},registerCommand:function(a,b,c,d,e){if("string"!=typeof a)return Tundra.client.logError("[ConsoleAPI]: registerCommand 'name' parameter must be a non empty string!",!0),null;var f=this.getCommandData(a);if(f)return this.subscribeCommand(a,d,e);(void 0===b||null===b)&&(b=""),(void 0===c||null===c)&&(c="");var g=this.commands.length;return this.commands.push({channel:"ConsoleAPI."+g,index:g,name:a,description:b,parameterDescription:c}),this.subscribeCommand(a,d,e)},subscribeCommand:function(a,b,c){if(void 0===c||null===c)return null;var d=this.getCommandData(a);return d?Tundra.events.subscribe(d.channel,b,c):null},executeCommandRaw:function(a){a=CoreStringUtils.trim(a);var b=a,c="";-1!=a.indexOf("(")&&(b=CoreStringUtils.trim(a.substring(0,a.indexOf("("))),c=CoreStringUtils.trim(a.substring(a.indexOf("(")+1))),""===c&&-1!=a.indexOf(" ")&&(b=CoreStringUtils.trim(a.substring(0,a.indexOf(" "))),c=CoreStringUtils.trim(a.substring(a.indexOf(" ")+1))),-1!=c.indexOf(")")&&(c=c.substring(0,c.indexOf(")"))),b=CoreStringUtils.trim(b),c=""!==c?CoreStringUtils.trim(c).split(","):[];var d=this.executeCommand(b,c);return d||Tundra.client.logError("Could not find console command '"+b+"'"),d},executeCommand:function(a,b){var c=this.getCommandData(a);return c&&Tundra.events.send(c.channel,b),null!==c},logInfo:function(a){var b=Tundra.client;if(b.ui&&b.ui.console){var c=b.ui.console.html();b.ui.console.html(c+a+"<br />"),b.ui.console.is(":visible")&&b.ui.console.animate({scrollTop:b.ui.console.prop("scrollHeight")},{queue:!1,duration:350})}},logWarning:function(a){var b=Tundra.client;if(b.ui&&b.ui.console){var c=b.ui.console.html();b.ui.console.html(c+"<span style='color: rgb(119,101,0);'>"+a+"</span><br />"),b.ui.console.is(":visible")&&b.ui.console.animate({scrollTop:b.ui.console.prop("scrollHeight")},{queue:!1,duration:350});
}},logError:function(a){var b=Tundra.client;if(b.ui&&b.ui.console){var c=b.ui.console.html();b.ui.console.html(c+"<span style='color: red;'>"+a+"</span><br />"),b.ui.console.is(":visible")&&b.ui.console.animate({scrollTop:b.ui.console.prop("scrollHeight")},{queue:!1,duration:350})}}}),ITundraSerializer=Class.$extend({__init__:function(){},serializeToObject:function(){console.error("[ITundraSerializer]: serializeToObject not implemented!")},serializeToXml:function(){console.error("[ITundraSerializer]: serializeToXml not implemented!")},serializeToBinary:function(){console.error("[ITundraSerializer]: serializeToBinary not implemented!")}}),AttributeChange=Class.$extend({__init__:function(){},__classvars__:{Default:0,Disconnected:1,LocalOnly:2,Replicate:3}}),Color=Class.$extend({__init__:function(a,b,c,d){this.r="number"==typeof a?a:0,this.g="number"==typeof b?b:0,this.b="number"==typeof c?c:0,this.a="number"==typeof d?d:1},__classvars__:{red:function(){return new Color(1,0,0,1)},green:function(){return new Color(0,1,0,1)},blue:function(){return new Color(0,0,1,1)},white:function(){return new Color(1,1,1,1)},black:function(){return new Color(0,0,0,1)},yellow:function(){return new Color(1,1,0,1)},cyan:function(){return new Color(0,1,1,1)},magenta:function(){return new Color(1,0,1,1)},gray:function(){return new Color(.5,.5,.5,1)},fromString:function(a){if(MathUtils.RegExpFloats.test(a)){var b=a.match(MathUtils.RegExpFloats),c=new Color;return b.length>0&&(c.r=MathUtils.parseFloat(b[0])),MathUtils.isNaN(c.r)&&(c.r=0),b.length>1&&(c.g=MathUtils.parseFloat(b[1])),MathUtils.isNaN(c.g)&&(c.g=0),b.length>2&&(c.b=MathUtils.parseFloat(b[2])),MathUtils.isNaN(c.b)&&(c.b=0),b.length>3&&(c.a=MathUtils.parseFloat(b[3]),MathUtils.isNaN(c.a)&&(c.a=0)),c.r>1&&(c.r=Math.min(255,c.r)/255),c.g>1&&(c.g=Math.min(255,c.g)/255),c.b>1&&(c.b=Math.min(255,c.b)/255),c.a>1&&(c.a=Math.min(255,c.b)/255),c}if(/^rgb\((\d+), ?(\d+), ?(\d+)\)$/i.test(a)){var d=/^rgb\((\d+), ?(\d+), ?(\d+)\)$/i.exec(a),e=parseInt(d[1]),f=parseInt(d[2]),g=parseInt(d[3]);return e>1&&(e=Math.min(255,e)/255),f>1&&(f=Math.min(255,f)/255),g>1&&(g=Math.min(255,g)/255),new Color(e,f,g)}if(/^\#([0-9a-f]{6})$/i.test(a)){var h=/^\#([0-9a-f]{6})$/i.exec(a);return Color.fromRgb(parseInt(h[1],16))}return console.error("[Color]: fromString() string format not supported:",a),null},fromRgb:function(a){a=Math.floor(a);var b=(a>>16&255)/255,c=(a>>8&255)/255,d=(255&a)/255;return new Color(b,c,d)},fromHex:function(a){return Color.fromRgb(a)},fromRgba:function(a){a=Math.floor(a);var b=(a>>24&255)/255,c=(a>>16&255)/255,d=(a>>8&255)/255,e=(255&a)/255;return new Color(b,c,d,e)},lerp:function(a,b,c){return a.lerp(b,c)}},clone:function(){return new Color(this.r,this.g,this.b,this.a)},set:function(a,b,c,d){this.r="number"==typeof a?a:this.r,this.g="number"==typeof b?b:this.g,this.b="number"==typeof c?c:this.b,this.a="number"==typeof d?d:this.a},setRGBA:function(a,b,c,d){this.set(a,b,c,d)},copy:function(a){return this.r=a.r,this.g=a.g,this.b=a.b,this.a=a.a,this},toThreeColor:function(){var a=new THREE.Color;return a.setRGB(this.r,this.g,this.b),a},toVector4:function(){return new THREE.Vector4(this.r,this.g,this.b,this.a)},toRgba:function(){var a=this.toRgb(),b=MathUtils.clamp(Math.floor(255*this.a),0,255);return a<<8^b},toRgb:function(a){var b=MathUtils.clamp(Math.floor(255*this.r),0,255),c=MathUtils.clamp(Math.floor(255*this.g),0,255),d=MathUtils.clamp(Math.floor(255*this.b),0,255),e=MathUtils.clamp(Math.floor(255*this.a),0,255);return a!==!0?b<<16^c<<8^d:{r:b,g:c,b:d,a:e}},toHex:function(){return this.toRgb()},toString:function(a){if(a===!0){var b=MathUtils.clamp(Math.floor(255*this.r),0,255),c=MathUtils.clamp(Math.floor(255*this.g),0,255),d=MathUtils.clamp(Math.floor(255*this.b),0,255),e=MathUtils.clamp(Math.floor(255*this.a),0,255);return"rgba("+b+", "+c+", "+d+", "+e+")"}return"rgba("+this.r+", "+this.g+", "+this.b+", "+this.a+")"},serializetoString:function(){return this.r+" "+this.g+" "+this.b+" "+this.a},equals:function(a,b){return MathUtils.equal(this.r,a.r,b)&&MathUtils.equal(this.g,a.g,b)&&MathUtils.equal(this.b,a.b,b)&&MathUtils.equal(this.a,a.a,b)},add:function(a){return this.r+=a.r,this.g+=a.g,this.b+=a.b,this.a+=a.a,this},addScalar:function(a){return this.r+=a,this.g+=a,this.b+=a,this.a+=a,this},multiply:function(a){return this.r*=a.r,this.g*=a.g,this.b*=a.b,this.a*=a.a,this},multiplyScalar:function(a){return this.r*=a,this.g*=a,this.b*=a,this.a*=a,this},lerp:function(a,b){return this.r=MathUtils.lerp(this.r,a.r,b),this.g=MathUtils.lerp(this.g,a.g,b),this.b=MathUtils.lerp(this.b,a.b,b),this.a=MathUtils.lerp(this.a,a.a,b),this},clamp:function(a,b){return this.r=MathUtils.clamp(this.r,a,b),this.g=MathUtils.clamp(this.g,a,b),this.b=MathUtils.clamp(this.b,a,b),this.a=MathUtils.clamp(this.a,a,b),this},clamp01:function(){return this.clamp(0,1)}}),Transform=Class.$extend({__init__:function(a,b,c){this.log=TundraLogging.getLogger("Transform"),void 0===a||a instanceof THREE.Vector3||this.log.warn("Constructor 'pos' parameter is not a THREE.Vector3",a),void 0===b||a instanceof THREE.Vector3||this.log.warn("Constructor 'rot' parameter is not a THREE.Vector3",b),void 0===c||a instanceof THREE.Vector3||this.log.warn("Constructor 'scale' parameter is not a THREE.Vector3",c),this._pos=a instanceof THREE.Vector3?a:new THREE.Vector3(0,0,0),this._rot=b instanceof THREE.Vector3?b:new THREE.Vector3(0,0,0),this._scale=c instanceof THREE.Vector3?c:new THREE.Vector3(1,1,1),this._rotEuler=new THREE.Euler(THREE.Math.degToRad(this._rot.x),THREE.Math.degToRad(this._rot.y),THREE.Math.degToRad(this._rot.z),"ZYX"),Object.defineProperties(this,{pos:{get:function(){return this._pos},set:function(a){this.setPosition(a)}},rot:{get:function(){return this._rot},set:function(a){this.setRotation(a)}},scale:{get:function(){return this._scale},set:function(a){this.setScale(a)}}})},reset:function(){this.setScale(1,1,1),this.setPosition(0,0,0),this.setRotation(0,0,0)},copy:function(a){this._pos.copy(a._pos),this._rot.copy(a._rot),this._scale.copy(a._scale)},decompose:function(a,b,c){a instanceof Transform?(a._pos.copy(this._pos),a._rot.copy(this._rot),a._scale.copy(this._scale)):(a instanceof THREE.Vector3&&a.copy(this._pos),b instanceof THREE.Vector3&&b.copy(this._rot),c instanceof THREE.Vector3&&c.copy(this._scale))},apply:function(a){a.position.copy(this._pos),this.copyOrientationTo(a.quaternion),a.scale.copy(this._scale),a.updateMatrix(),a.updateMatrixWorld(!0)},lookAt:function(a,b){this.setRotation(this.lookAtQuaternion(a,b))},lookAtQuaternion:function(a,b){return void 0===this._orientationMatrix&&(this._orientationMatrix=new THREE.Matrix4),this._orientationMatrix.makeTranslation(0,0,0),this._orientationMatrix.lookAt(a,b,Tundra.renderer.axisY),(new THREE.Quaternion).setFromRotationMatrix(this._orientationMatrix)},orientation:function(a){if(this._updateEuler(),void 0!==a&&a instanceof THREE.Quaternion)return a.setFromEuler(this._rotEuler,!1),a;var b=new THREE.Quaternion;return b.setFromEuler(this._rotEuler,!1),b},quaternion:function(){return this.orientation()},copyOrientationTo:function(a){this._updateEuler(),a.setFromEuler(this._rotEuler,!1)},_updateEuler:function(){this._rotEuler.set(THREE.Math.degToRad(this._rot.x%360),THREE.Math.degToRad(this._rot.y%360),THREE.Math.degToRad(this._rot.z%360))},euler:function(){return this._updateEuler(),this._rotEuler.clone()},setPosition:function(a,b,c){a instanceof THREE.Vector3?this._pos.copy(a):"number"==typeof a&&"number"==typeof b&&"number"==typeof c?(this._pos.x=a,this._pos.y=b,this._pos.z=c):"object"==typeof a&&"number"==typeof a.x&&"number"==typeof a.y&&"number"==typeof a.z?(this._pos.x=a.x,this._pos.y=a.y,this._pos.z=a.z):this.log.error("setPosition must be called with a single Three.Vector3 or x,y,z with type of number.",a,b,c)},setRotation:function(a,b,c){a instanceof THREE.Vector3?this._rot.copy(a):a instanceof THREE.Quaternion?(this._rotEuler.setFromQuaternion(a.normalize(),void 0,!1),this._rot.x=THREE.Math.radToDeg(this._rotEuler.x)%360,this._rot.y=THREE.Math.radToDeg(this._rotEuler.y)%360,this._rot.z=THREE.Math.radToDeg(this._rotEuler.z)%360):a instanceof THREE.Euler?(this._rot.x=THREE.Math.radToDeg(a.x)%360,this._rot.y=THREE.Math.radToDeg(a.y)%360,this._rot.z=THREE.Math.radToDeg(a.z)%360):"number"==typeof a&&"number"==typeof b&&"number"==typeof c?(this._rot.x=a,this._rot.y=b,this._rot.z=c):"object"==typeof a&&"number"==typeof a.x&&"number"==typeof a.y&&"number"==typeof a.z?(this._rot.x=a.x,this._rot.y=a.y,this._rot.z=a.z):this.log.error("setRotation must be called with a single Three.Vector3, THREE.Quaternion or x,y,z with type of number.",a,b,c)},setScale:function(a,b,c){return a instanceof THREE.Vector3?this._scale.copy(a):"number"==typeof a&&"number"==typeof b&&"number"==typeof c?(this._scale.x=a,this._scale.y=b,this._scale.z=c):"object"==typeof a&&"number"==typeof a.x&&"number"==typeof a.y&&"number"==typeof a.z?(this._scale.x=a.x,this._scale.y=a.y,this._scale.z=a.z):this.log.error("setScale must be called with a single Three.Vector3 or x,y,z with type of number.",a,b,c),!1},clone:function(){return new Transform(this.pos.clone(),this.rot.clone(),this.scale.clone())},toString:function(a){void 0===a&&(a=!1);var b=this.pos.x+" "+this.pos.y+" "+this.pos.z+" | "+this.rot.x+" "+this.rot.y+" "+this.rot.z+" | "+this.scale.x+" "+this.scale.y+" "+this.scale.z;return a||(b="Transform("+b+")"),b},formatParts:function(a){"number"!=typeof a&&(a=6);for(var b=[this._pos.x.toFixed(a),this._pos.y.toFixed(a),this._pos.z.toFixed(a),this._rot.x.toFixed(a),this._rot.y.toFixed(a),this._rot.z.toFixed(a),this._scale.x.toFixed(a),this._scale.y.toFixed(a),this._scale.z.toFixed(a)],c=0;c<b.length;c++){var d=b[c];d=CoreStringUtils.trimStringRight(d,"0"),CoreStringUtils.endsWith(d,".")&&(d=d.substring(0,d.length-1)),b[c]=d}return b}}),Attribute=ITundraSerializer.$extend({__init__:function(a,b,c,d,e){this.$super(),this.owner=a,this.interpolation=void 0,this.index=b,this.name=c,this.id=void 0,this.value=d,this.typeId=e,this.typeName=Attribute.toTypeName(e),this.sizeBytes=Attribute.sizeInBytes(e),this.headerSizeBytes=Attribute.headerSizeInBytes(e)},__classvars__:{None:0,String:1,Int:2,Real:3,Color:4,Float2:5,Float3:6,Float4:7,Bool:8,UInt:9,Quat:10,AssetReference:11,AssetReferenceList:12,EntityReference:13,QVariant:14,QVariantList:15,Transform:16,QPoint:17,typeNames:function(){for(var a=[],b=0;b<Attribute.typeNameList.length;++b)a.push(Attribute.typeNameList[b]);return a},typeIds:function(){for(var a=[],b=0;b<Attribute.typIdList.length;++b)a.push(Attribute.typIdList[b]);return a},toTypeName:function(a){if("number"!=typeof a)return TundraLogging.getLogger("Attribute").error("toTypeName function called with non number 'typeId'",a),null;switch(a){case 1:return"string";case 2:return"int";case 3:return"real";case 4:return"Color";case 5:return"float2";case 6:return"float3";case 7:return"float4";case 8:return"bool";case 9:return"uint";case 10:return"Quat";case 11:return"AssetReference";case 13:return"EntityReference";case 12:return"AssetReferenceList";case 15:return"QVariantList";case 14:return"QVariant";case 16:return"Transform";case 17:return"QPoint"}return null},toTypeId:function(a){if("string"!=typeof a)return TundraLogging.getLogger("Attribute").error("toTypeId function called with non string 'typeName'",a),null;var b=a.toLowerCase();return"string"===b?1:"int"===b?2:"real"===b?3:"color"===b?4:"float2"===b?5:"float3"===b?6:"float4"===b?7:"bool"===b?8:"uint"===b?9:"quat"===b?10:"assetreference"===b?11:"entityreference"===b?12:"assetreferencelist"===b?13:"qvariantlist"===b||"variantlist"===b?14:"qvariant"===b||"variant"===b?15:"transform"===b?16:"qpoint"===b||"point"===b?17:null},typeNameList:["string","int","real","Color","float2","float3","float4","bool","uint","Quat","EntityReference","AssetReferenceList","QVariantList","QVariant","Transform","QPoint"],typIdList:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17],sizeInBytes:function(a){switch(a){case 1:return void 0;case 2:return 4;case 3:return 4;case 4:return 16;case 5:return 8;case 6:return 12;case 7:return 16;case 8:return 1;case 9:return 4;case 10:return 16;case 11:case 13:case 12:case 15:case 14:return void 0;case 16:return 36;case 17:return 8}return void TundraLogging.getLogger("Attribute").error("Unknown attribute type id "+a+". Cannot resolve size in bytes!")},headerSizeInBytes:function(a){switch(a){case 1:return 2;case 11:case 13:return 1;case 12:case 15:return 1;case 14:return 1}return 0},defaultValueForType:function(a){switch(a){case 1:return"";case 2:case 9:return 0;case 3:return 0;case 4:return new Color;case 5:case 17:return new THREE.Vector2(0,0);case 6:return new THREE.Vector3(0,0,0);case 7:return new THREE.Vector4(0,0,0,0);case 8:return!1;case 10:return new THREE.Quaternion;case 11:case 13:case 14:return"";case 12:case 15:return[];case 16:return new Transform}return TundraLogging.getLogger("Attribute").error("defaultValueForType() Unknown attribute type id "+a),null}},_reset:function(){this.owner=null,this.index=null,this.name=null,this.id=null,this.value=null,this.typeId=null,this.typeName=null,this.sizeBytes=null,this.headerSizeBytes=null},serializeValue:function(){switch(this.typeId){case 2:case 9:case 3:case 8:return this.value.toString();case 1:case 11:case 13:case 14:return this.value;case 17:return this.value.x+" "+this.value.y;case 5:case 6:case 7:case 10:return this.value.toArray().join(" ");case 4:return this.value.serializetoString();case 12:case 15:return this.value.join(";");case 16:return this.value.formatParts().join(",")}},serializeToObject:function(){var a={};return a.id=this.name,a.type=this.typeName,a.value=this.serializeValue(),a},serializeToXml:function(){var a=document.createElement("attribute");return a.setAttribute("id",this.name),a.setAttribute("type",this.typeName),a.setAttribute("value",this.serializeValue()),a},toString:function(){return"index="+this.index+" name="+this.name+" typeId="+this.typeId+" typeName="+this.typeName+" size="+this.sizeBytes+" header="+this.headerSizeBytes+" value="+this.value.toString()},get:function(){return this.value},getClone:function(){if("function"==typeof this.value.getClone)return this.value.getClone();if("function"==typeof this.value.clone)return this.value.clone();var a=typeof this.value;if("string"===a||"boolean"===a||"number"===a)return this.value;if(Array.isArray(this.value)){for(var b=[],c=0;c<this.value.length;c++)b.push(this.value[c]);return b}return TundraLogging.getLogger("Attribute").warn("getClone() not implemented for type",this.typeName,a),TundraLogging.getLogger("Attribute").warn(this),this.value},set:function(a,b){return(void 0===b||null===b)&&(b=AttributeChange.Default),"number"!=typeof b?(TundraLogging.getLogger("Attribute").error("set called with non-number change type: "+b),!1):(b===AttributeChange.Default&&(b=null!=this.owner&&this.owner.replicated?AttributeChange.Replicate:AttributeChange.LocalOnly),this.interpolation&&this.interpolation.change(a),this.value=a,null!=this.owner&&b!==AttributeChange.Disconnected&&this.owner._attributeChanged(this,b),!0)},onChanged:function(a,b){return null!=this.owner&&this.owner.hasParentEntity()?Tundra.events.subscribe("Scene.AttributeChanged."+this.owner.parentEntity.id.toString()+"."+this.owner.id.toString()+"."+this.index.toString(),a,b):(TundraLogging.getLogger("Attribute").error("Cannot subscribe onChanged, parent component or parent entity not set!"),null)},headerFromBinary:function(a){if(this.headerSizeBytes>0){if(1===this.headerSizeBytes)return a.readU8();if(2===this.headerSizeBytes)return a.readU16()}return void 0},dataFromBinary:function(a,b){switch(this.typeId){case 1:this.set(a.readString(b,!0),AttributeChange.LocalOnly);break;case 11:case 13:case 14:this.set(a.readString(b),AttributeChange.LocalOnly);break;case 2:this.set(a.readS32(),AttributeChange.LocalOnly);break;case 3:this.set(a.readFloat32(),AttributeChange.LocalOnly);break;case 4:this.value.r=a.readFloat32(),this.value.g=a.readFloat32(),this.value.b=a.readFloat32(),this.value.a=a.readFloat32(),this.set(this.value,AttributeChange.LocalOnly);break;case 5:this.value.x=a.readFloat32(),this.value.y=a.readFloat32(),this.set(this.value,AttributeChange.LocalOnly);break;case 6:this.value.x=a.readFloat32(),this.value.y=a.readFloat32(),this.value.z=a.readFloat32(),this.set(this.value,AttributeChange.LocalOnly);break;case 7:this.value.x=a.readFloat32(),this.value.y=a.readFloat32(),this.value.z=a.readFloat32(),this.value.w=a.readFloat32(),this.set(this.value,AttributeChange.LocalOnly);break;case 8:this.set(a.readBoolean(),AttributeChange.LocalOnly);break;case 9:this.set(a.readU32(),AttributeChange.LocalOnly);break;case 10:this.value.x=a.readFloat32(),this.value.y=a.readFloat32(),this.value.z=a.readFloat32(),this.value.w=a.readFloat32(),this.set(this.value,AttributeChange.LocalOnly);break;case 12:case 15:this.value=[];for(var c=0;b>c;++c)this.value.push(a.readStringU8());this.set(this.value,AttributeChange.LocalOnly);break;case 16:this.value.pos.x=a.readFloat32(),this.value.pos.y=a.readFloat32(),this.value.pos.z=a.readFloat32(),this.value.rot.x=a.readFloat32(),this.value.rot.y=a.readFloat32(),this.value.rot.z=a.readFloat32(),this.value.scale.x=a.readFloat32(),this.value.scale.y=a.readFloat32(),this.value.scale.z=a.readFloat32(),this.set(this.value,AttributeChange.LocalOnly);break;case 17:this.value.x=a.readS32(),this.value.y=a.readS32(),this.set(this.value,AttributeChange.LocalOnly)}},fromBinary:function(a){var b=void 0!==this.sizeBytes?this.sizeBytes:this.headerFromBinary(a);return void 0===b?void TundraLogging.getLogger("Attribute").error("Size and header size of '"+this.name+"' seems to be unknown, did you mess up the IComponent.declareAttribute() calls?"):void this.dataFromBinary(a,b)}}),IComponent=ITundraSerializer.$extend({__init__:function(a,b,c,d){this.$super(),this.log=TundraLogging.getLogger(IComponent.ensureComponentNameWithoutPrefix(c)),this.id=a,this.typeId=b,this.typeName=IComponent.ensureComponentNameWithoutPrefix(c),this.name=d,this.replicated=!0,this.local=!1,this.temporary=!1,this.parentEntity=null,this.parentScene=null,this.notImplemented=!1,this.attributes={},this.attributeCount=0,this.attributeIndexes={},this.blockSignals=!1},__classvars__:{ensureComponentNamePrefix:function(a){return"ec_"===a.substring(0,3).toLowerCase()?a:"EC_"+a},ensureComponentNameWithoutPrefix:function(a){return"ec_"===a.substring(0,3).toLowerCase()?a.substr(3):a},propertyName:function(a){return a=IComponent.ensureComponentNameWithoutPrefix(a),a.substring(0,1).toLowerCase()+a.substring(1)}},_reset:function(){this.reset(),this.attributeIndexes={},this.attributeCount=0,this.blockSignals=!1;for(var a in this.attributes){var b=this.attributes[a];void 0!==b&&null!==b&&b._reset(),b=null}this.attrs={},this.parentEntity=null,this.parentScene=null},hasParentEntity:function(){return null!==this.parentEntity},hasParentScene:function(){return null!==this.parentScene},reset:function(){},_update:function(){this.update()},update:function(){},onAttributeChanged:function(a,b){return!this.parentEntity||this.parentEntity.id<=0?(console.log("ERROR: Entity.onAttributeChanged called on a non initialized component! No valid parent entity!"),null):Tundra.events.subscribe("Scene.AttributeChanged."+this.parentEntity.id.toString()+"."+this.id.toString(),a,b)},serializeToObject:function(){var a={};a.id=this.id,a.typeId=this.typeId,a.typeName=this.typeName,a.sync=this.replicated,a.attributes=[],a.temporary=this.temporary;for(var b in this.attributes)a.attributes.push(this.attributes[b].serializeToObject());return a},serializeToXml:function(){var a=document.createElement("component");a.setAttribute("type",this.typeName),a.setAttribute("typeId",this.typeId),a.setAttribute("sync",this.replicated);for(var b in this.attributes)a.appendChild(this.attributes[b].serializeToXml());return a},toString:function(){return this.id+" "+this.typeName+(this.name.length>0?" name = "+this.name:"")},isDynamic:function(){return!1},setParent:function(a){this.parentEntity=void 0!==a?a:null,this.parentScene=void 0!==a?a.parentScene:null},declareAttribute:function(a,b,c,d){var e=new Attribute(this,a,b,c,d);if(this.attributes[b]=e,this.attributeIndexes[a]=b,this.attributeCount=Object.keys(this.attributes).length,void 0===this[b]){var f={};f[b]={get:function(){return e.getClone()},set:function(a){e.set(a)},configurable:this.isDynamic()},Object.defineProperties(this,f)}},setAttribute:function(a,b,c){var d=this.attributes[a];void 0!==d&&d.set(b,c)},attributeById:function(a){return void 0===a||null===a?void 0:this.attributes[a]},attribute:function(a){return this.attributeById(a)},getAttribute:function(a){return this.attributeById(a)},hasAttribute:function(a){return void 0!==this.attribute(a)},attributeByIndex:function(a){return this.attributeById(this.attributeIndexes[a])},getAttributeByIndex:function(a){return this.attributeByIndex(a)},deserializeFromBinary:function(a){if(this.attributeCount<=0&&!this.isDynamic())return-1;this.blockSignals=!0;try{this.isDynamic()?this._deserializeFromBinaryDynamic(a):this._deserializeFromBinaryStatic(a)}catch(b){Tundra.client.logError("[Attribute]: deserializeFromBinary exception: "+b)}this.blockSignals=!1},_deserializeFromBinaryStatic:function(a){for(var b=0;b<this.attributeCount;++b){var c=this.attributeByIndex(b);c.fromBinary(a)}},_deserializeFromBinaryDynamic:function(a){if(void 0!==a.readLimitBytes)for(var b=a.readBytes();a.readBytes()-b<a.readLimitBytes;){var c=a.readU8(),d=a.readU8(),e=a.readStringU8();this.declareAttribute(c,e,Attribute.defaultValueForType(d),d),this.deserializeAttributeFromBinary(c,a)}else console.error("[Attribute]: DataDeserializer for parsing dynamic component structure does not have 'readLimitBytes' property. This information is needed to know when to stop parsing.")},deserializeAttributeFromBinary:function(a,b){if(!(this.attributeCount<=0)){var c=this.attributeByIndex(a);void 0!==c&&null!==c&&c.fromBinary(b)}},createAttributeFromBinary:function(a,b){if(!this.isDynamic())return void Tundra.client.logError("[IComponent]: createAttributeFromBinary called to a non dynamic component!",!0);var c=b.readU8(),d=b.readStringU8();this.declareAttribute(a,d,Attribute.defaultValueForType(c),c),this.deserializeAttributeFromBinary(a,b),"function"==typeof this._attributeAdded&&this._attributeAdded(a)},_attributeChanged:function(a,b){return this.blockSignals?void 0:this.parentEntity&&this.parentEntity.parentScene?void(void 0!==a&&null!==a&&(this.attributeChanged(a.index,a.name,a.get()),null!==this.parentEntity&&null!==this.parentEntity.parentScene&&this.parentEntity.parentScene._publishAttributeChanged(this.parentEntity,a))):void Tundra.client.logError("[IComponent]: Cannot send attribute update event, parent entity or scene is null!",!0)},attributeChanged:function(a,b,c){}}),UniqueIdGenerator=Class.$extend({__init__:function(){this.id=0,this.localId=UniqueIdGenerator.FirstLocalId-1,this.unackedId=UniqueIdGenerator.FirstUnackedId-1},__classvars__:{FirstReplicatedId:1,LastReplicatedId:1073741823,FirstUnackedId:1073741824,FirstLocalId:2147483648,LastLocalId:4294967295},allocateReplicated:function(){return this.id++,this.id>UniqueIdGenerator.LastReplicatedId&&(this.id=UniqueIdGenerator.FirstReplicatedId),this.id},allocateUnacked:function(){return this.unackedId++,this.unackedId>=UniqueIdGenerator.FirstLocalId&&(this.unackedId=UniqueIdGenerator.FirstUnackedId+1),this.unackedId},allocateLocal:function(){return this.localId++,this.localId>UniqueIdGenerator.LastLocalId&&(this.localId=UniqueIdGenerator.FirstLocalId+1),this.localId}}),Entity=ITundraSerializer.$extend({__init__:function(){this.$super(),this.log=TundraLogging.getLogger("Entity"),this.componentIdGenerator=new UniqueIdGenerator,this.id=-1,Object.defineProperties(this,{name:{get:function(){return this.getName()},set:function(a){this.setName(a)}},description:{get:function(){return this.getDescription()},set:function(a){this.setDescription(a)}},group:{get:function(){return this.getGroup()},set:function(a){this.setGroup(a)}}}),this.replicated=!0,this.local=!1,this.temporary=!1,this.parentScene=null,this.components=[]},__classvars__:{ExecType:{Invalid:0,Local:1,Server:2,Peers:4,0:"Invalid",1:"Local",2:"Server",4:"Peers"}},_nextLocalComponentId:function(){return this.componentIdGenerator.allocateLocal()},_nextReplicatedComponentId:function(){return this.componentIdGenerator.allocateReplicated()},setId:function(a){this.id=a},getName:function(){var a=this.component("Name");return a?a.getName():""},setName:function(a,b){var c=this.getOrCreateComponent("Name",void 0,b);c.setName(a,b)},getDescription:function(){var a=this.component("Name");return a?a.getDescription():""},setDescription:function(a,b){var c=this.getOrCreateComponent("Name",void 0,b);c.setDescription(a,b)},getGroup:function(){var a=this.component("Name");return a?a.getGroup():""},setGroup:function(a,b){var c=this.getOrCreateComponent("Name",void 0,b);c.setGroup(a,b)},onAboutToBeRemoved:function(a,b){return null==this.parentScene||this.id<0?(this.log.error("onAboutToBeRemoved called on a non initialized entity!"),null):Tundra.events.subscribe("Entity.AboutToBeRemoved."+this.id.toString(),a,b)},onComponentCreated:function(a,b){return null==this.parentScene||this.id<0?(this.log.error("onComponentCreated called on a non initialized entity!"),null):Tundra.events.subscribe("Scene.ComponentCreated."+this.id.toString(),a,b)},onComponentRemoved:function(a,b){return null==this.parentScene||this.id<0?(this.log.error("onComponentRemoved called on a non initialized entity!"),null):Tundra.events.subscribe("Scene.ComponentRemoved."+this.id.toString(),a,b)},onEntityAction:function(a,b){return null==this.parentScene||this.id<0?(this.log.error("onEntityAction called on a non initialized entity!"),null):Tundra.events.subscribe("Scene.EntityAction."+this.id.toString(),a,b)},reset:function(){Tundra.events.send("Entity.AboutToBeRemoved."+this.id.toString(),this);for(var a=null,b=[],c=0;c<this.components.length;c++)null!=this.components[c]&&("Placeable"!==this.components[c].typeName?b.push(this.components[c].id):a=this.components[c].id);for(c=0;c<b.length;c++)this.removeComponent(b[c]);null!=a&&this.removeComponent(a),this.components=[],Tundra.events.remove("Entity.AboutToBeRemoved."+this.id.toString()),Tundra.events.remove("Scene.EntityAction."+this.id.toString())},serializeToObject:function(a){a=a||!1;var b={};b.id=this.id,b.sync=this.replicated,b.components=[];for(var c=0;c<this.components.length;++c){var d=this.components[c].temporary;(!d||d&&a)&&b.components.push(this.components[c].serializeToObject())}return b},serializeToXml:function(a){a=a||!1;var b=document.createElement("entity");b.setAttribute("id",this.id),b.setAttribute("sync",this.replicated);for(var c=0;c<this.components.length;++c){var d=this.components[c].temporary;(!d||d&&a)&&b.appendChild(this.components[c].serializeToXml())}return b},toString:function(){return this.id+(this.name.length>0?" name = "+this.name:"")},setParent:function(a){this.parentScene=a},update:function(){var a=this.component("Placeable");a&&a.update();for(var b=0;b<this.components.length;++b)null!=this.components[b]&&(null==a||a.id!==this.components[b].id)&&this.components[b]._update()},exec:function(a,b,c){if("string"==typeof a){var d=a.toLowerCase();if("local"===d)a=EntityAction.Local;else if("server"===d)a=EntityAction.Server;else{if("peers"!==d)return void this.log.error("exec(): Error cannot convert string exec type "+a+" no a valid EntityAction exec type!");a=EntityAction.Peers}}if(1>a||a>7)return void this.log.error("exec(): Invalid EntityAction input parameter: "+a);var e=new EntityAction;if(e.entity=this,e.entityId=this.id,e.executionType=a,e.name=b,e.parameters=[],Array.isArray(c))for(var f=0;f<c.length;f++)e.parameters.push(c[f].toString());else"object"==typeof c?e.parameters.push(JSON.stringify(c)):void 0!==c&&null!==c&&e.parameters.push(c.toString());if(0!==(e.executionType&EntityAction.Local)&&this.parentScene&&this.parentScene._publishEntityAction(e),0!==(e.executionType&EntityAction.Server)||0!==(e.executionType&EntityAction.Peers)){var g=new EntityActionMessage;g.serialize(e),Tundra.network.send(g)}},addComponent:function(a){if(void 0===a||null===a)return!1;for(var b=this.components.length-1;b>=0;b--)if(null!=this.components[b]&&this.components[b].id===a.id)return!1;var c=IComponent.propertyName(a.typeName);return""!==a.typeName&&"name"!==c&&(this[c]=a,c!==c.toLowerCase()&&(this[c.toLowerCase()]=a)),this.components.push(a),a.setParent(this),a._update(),a.local&&a.id>this.componentIdGenerator.localId?this.componentIdGenerator.localId=a.id:a.replicated&&a.id>this.componentIdGenerator.id&&(this.componentIdGenerator.id=a.id),null!=this.parentScene&&this.parentScene._publishComponentCreated(this,a),!0},removeComponent:function(a){for(var b=this.components.length-1;b>=0;b--)if(null!=this.components[b]&&this.components[b].id===a){var c=this.components[b];return null!=c&&(null!=this.parentScene&&this.parentScene._publishComponentRemoved(this,c),c._reset()),this.components.splice(b,1),c=null,!0}return!1},removeComponentByName:function(a,b){for(var c=IComponent.ensureComponentNameWithoutPrefix(a),d=this.components.length-1;d>=0;d--)if(this.components[d].typeName===c){if(null!=b&&this.components[d].name!==b)continue;var e=this.components[d];return null!=e&&(Tundra.events.send("Scene.ComponentRemoved."+this.id.toString(),this,e),e._reset()),this.components.splice(d,1),e=null,!0}return!1},component:function(a,b){if("string"!=typeof a)return this.log.error("component() called with non-string type name for Entity: "+this.toString()),null;for(var c=IComponent.ensureComponentNameWithoutPrefix(a),d=this.components.length-1;d>=0;d--)if(this.components[d]&&this.components[d].typeName===c&&(void 0===b||this.components[d].name===b))return this.components[d];return null},getComponent:function(a,b){return this.component(a,b)},componentById:function(a){for(var b=this.components.length-1;b>=0;b--)if(null!=this.components[b]&&this.components[b].id===a)return this.components[b];return null},getComponentById:function(a){return this.componentById(a)},componentByTypeId:function(a,b){for(var c=this.components.length-1;c>=0;c--)if(null!=this.components[c]&&this.components[c].typeId===a&&(void 0===b||this.components[c].name===b))return this.components[c];return null},getComponents:function(a,b){for(var c=[],d="string"!=typeof a,e=d?"":IComponent.ensureComponentNameWithoutPrefix(a),f=this.components.length-1;f>=0;f--){var g=this.components[f];(null!=g&&d&&g.typeId===a||!d&&g.typeName===e)&&(void 0===b||"string"!=typeof b?c.push(g):g.name===b&&c.push(g))}return c},createLocalComponent:function(a,b){return this.createComponent(a,b,AttributeChange.LocalOnly)},createComponent:function(a,b,c){if(null==this.parentScene)return this.log.error("Cannot create component, parent scene is null for Entity: "+this.toString()),null;void 0!==c&&"number"!=typeof c&&this.log.warn("createComponent called with non AttributeChange.Type change mode, defaulting to AttributeChange.Default."),c=c||AttributeChange.Default,b=b||"",c!==AttributeChange.LocalOnly&&(c===AttributeChange.Default?c=AttributeChange.LocalOnly:(this.log.warn("createComponent called with localOnly != AttributeChange.LocalOnly. Creating replicated components is not supported at the moment, defaulting to LocalOnly."),c=AttributeChange.LocalOnly));var d=this.parentScene.createComponent(a,b);return null!=d&&(c==AttributeChange.LocalOnly||c==AttributeChange.Disconnected||c==AttributeChange.Default?d.replicated=!1:d.replicated=!0,d.local=!d.replicated,d.id=d.replicated?this._nextReplicatedComponentId():this._nextLocalComponentId()),this.addComponent(d),d},getOrCreateLocalComponent:function(a,b){return this.getOrCreateComponent(a,b,AttributeChange.LocalOnly)},getOrCreateComponent:function(a,b,c){var d=this.component(a,b);return d||(d=this.createComponent(a,b,c)),d}}),Scene=ITundraAPI.$extend({__init__:function(a,b,c){
this.$super(a,b),this.entities=[],this.id=1,this.entityIdGenerator=new UniqueIdGenerator},postInitialize:function(){for(var a=Scene.registeredComponentsList(),b=0;b<a.length;b++)"string"!=typeof a[b].Implementation&&this._logComponentRegistration(a[b],!0);for(var b=0;b<a.length;b++)"string"==typeof a[b].Implementation&&this._logComponentRegistration(a[b],!0);Tundra.console.registerCommand("dumpScene","Dumps the scene to browsers developer console","(string) Optional entity name if you want to print a single entity",this,this.onDumpScene)},reset:function(){this.id=1,this.removeAllEntities(),Tundra.events.remove("Scene.EntityCreated"),Tundra.events.remove("Scene.EntityRemoved"),Tundra.events.remove("Scene.ComponentCreated"),Tundra.events.remove("Scene.ComponentRemoved"),Tundra.events.remove("Scene.EntityAction"),Tundra.events.send("Scene.Reset",this)},__classvars__:{registeredComponents:{},registeredComponentsList:function(){for(var a=[],b=Object.keys(Scene.registeredComponents),c=0;c<b.length;c++){var d=b[c];a.push(Scene.registeredComponents[d])}return a},registeredComponent:function(a){if("string"==typeof a)for(var b=IComponent.ensureComponentNameWithoutPrefix(a),c=Object.keys(Scene.registeredComponents),d=0;d<c.length;d++){var e=c[d];if(Scene.registeredComponents[e].TypeName===b){a=e;break}}return Scene.registeredComponents[a]},registerComponent:function(a){return a.prototype instanceof IComponent?"number"!=typeof a.TypeId?(TundraLogging.getLogger("Scene").error("registerComponent: Invalid component class. 'TypeId' is not a number."),!1):a.TypeId<=0?(TundraLogging.getLogger("Scene").error("registerComponent: Invalid component class. 'TypeId' number is invalid",a.TypeId),!1):"string"!=typeof a.TypeName?(TundraLogging.getLogger("Scene").error("registerComponent: Invalid component class. 'TypeName' is not a string."),!1):""===a.TypeName?(TundraLogging.getLogger("Scene").error("registerComponent: Invalid component class. 'TypeName' string is invalid",a.TypeName),!1):void 0!==this.registeredComponents[a.TypeId]?(TundraLogging.getLogger("Scene").error("Component with type id",a.TypeId,"("+this.registeredComponents[a.TypeId].TypeName+") already registered!"),!1):(a.TypeName=IComponent.ensureComponentNameWithoutPrefix(a.TypeName),this.registeredComponents[a.TypeId]=a,this._registerComponentPropertyName(a),null!=Tundra.scene&&Tundra.scene._logComponentRegistration(a),!0):(TundraLogging.getLogger("Scene").error("registerComponent: Invalid component class. First parameter must be a IComponent."),!1)},_registerComponentPropertyName:function(a){for(var b=IComponent.propertyName(a.TypeName),c=!1,d=0;d<Scene.componentPropertyNames.length&&!(c=Scene.componentPropertyNames[d]===b);d++);c||Scene.componentPropertyNames.push(b)},componentPropertyNames:function(){var a=[];for(var b in Network.components)a.push(IComponent.propertyName(Network.components[b]));return a}()},serializeToObject:function(a){a=a||!1;var b={};b.id=this.id,b.entities=[];for(var c=0;c<this.entities.length;++c){var d=this.entities[c].temporary;(!d||d&&a)&&b.entities.push(this.entities[c].serializeToObject())}return b},serializeToXml:function(a){a=a||!1;for(var b=document.createElement("scene"),c=0;c<this.entities.length;++c){var d=this.entities[c].temporary;(!d||d&&a)&&b.appendChild(this.entities[c].serializeToXml())}return b},toString:function(){return"id="+this.id+" entities="+this.entities.length},_logComponentRegistration:function(a,b){if(null!=Tundra.scene&&(this.staging.postInitialized||b)){for(var c=void 0!==a.Implementation?"["+a.Implementation+"] ":"",d=a.TypeId.toString();d.length<3;)d=" "+d;Tundra.scene.log.debug("Registered component "+c+d,a.TypeName)}},onDumpScene:function(a){if(0===this.entities.length)return void this.log.info("Current scene has no entities");this.log.info("");for(var b=!1,c=a[0],d=0;d<this.entities.length;d++){var e=this.entities[d],f=void 0!==c?c===e.name:!0;if(f){b=!0,this.log.info(e.id+" "+e.name);for(var g=0;g<e.components.length;g++){var h=e.components[g];if(this.log.info("  "+h.id+" "+h.typeName),h.isDynamic())for(var i in h.attributeIndexes){var j=h.getAttributeByIndex(i);void 0!==j&&null!==j&&this.log.info("    "+j.toString())}else for(var k=0;k<h.attributeCount;k++)this.log.info("    "+h.getAttributeByIndex(k).toString())}}}b||void 0===c||this.log.error("Failed to find entity '"+c+"'")},_onEntityNameChanged:function(a,b,c){for(var d=this.entities.length-1;d>=0;d--){var e=this.entities[d],f=null!=e.placeable?e.placeable.parentRef:void 0;void 0!==f&&null!==f&&(""!==c&&""!==f&&f===c&&e.placeable.removeParent(),""!==b&&f===b&&e.placeable.checkParent())}},onReset:function(a,b){return Tundra.events.subscribe("Scene.Reset",a,b)},onEntityCreated:function(a,b){return Tundra.events.subscribe("Scene.EntityCreated",a,b)},onEntityRemoved:function(a,b){return Tundra.events.subscribe("Scene.EntityRemoved",a,b)},onComponentCreated:function(a,b){return Tundra.events.subscribe("Scene.ComponentCreated",a,b)},onComponentRemoved:function(a,b){return Tundra.events.subscribe("Scene.ComponentRemoved",a,b)},onAttributeChanged:function(a,b){return Tundra.events.subscribe("Scene.AttributeChanged",a,b)},onEntityAction:function(a,b){return Tundra.events.subscribe("Scene.EntityAction",a,b)},_publishEntityCreated:function(a){return null==a?void console.log("ERROR: Scene trying to publish EntityCreated with null entity!"):void Tundra.events.send("Scene.EntityCreated",a)},_publishEntityRemoved:function(a){if(null==a)return void console.log("ERROR: Scene trying to publish EntityRemoved with null entity!");try{Tundra.events.send("Scene.EntityRemoved",a)}catch(b){this.log.error("Scene.EntityRemoved handler exception:",b.stack||b)}var c=a.id.toString();Tundra.events.remove("Scene.ComponentCreated."+c),Tundra.events.remove("Scene.ComponentRemoved."+c),Tundra.events.remove("Scene.AttributeChanged."+c),Tundra.events.remove("Scene.EntityAction."+c)},_publishComponentCreated:function(a,b){return null==a?void console.log("ERROR: Scene trying to publish ComponentCreated with null entity!"):null==b?void console.log("ERROR: Scene trying to publish ComponentCreated with null component!"):(Tundra.events.send("Scene.ComponentCreated",a,b),void Tundra.events.send("Scene.ComponentCreated."+a.id.toString(),a,b))},_publishComponentRemoved:function(a,b){return null==a?void console.log("ERROR: Scene trying to publish ComponentRemoved with null entity!"):null==b?void console.log("ERROR: Scene trying to publish ComponentRemoved with null component!"):(Tundra.events.send("Scene.ComponentRemoved",a,b),void Tundra.events.send("Scene.ComponentRemoved."+a.id.toString(),a,b))},_publishEntityAction:function(a){return null==a?void console.log("ERROR: Scene trying to publish EntityAction with null entity action object!"):null==a.entity?void console.log("ERROR: Scene trying to publish EntityAction with null entity in the action object!"):(Tundra.events.send("Scene.EntityAction",a),void Tundra.events.send("Scene.EntityAction."+a.entity.id.toString(),a))},_publishAttributeChanged:function(a,b){if(null==a)return void console.log("ERROR: Scene trying to publish AttributeChanged with null entity!");if(null==b.owner)return void console.log("ERROR: Scene trying to publish AttributeChanged with null component!");var c=a.id.toString(),d=b.owner.id.toString(),e=b.index,f=b.getClone();Tundra.events.send("Scene.AttributeChanged",a,b.owner,b.index,b.name,f),Tundra.events.send("Scene.AttributeChanged."+c,a,b.owner,b.index,b.name,f),Tundra.events.send("Scene.AttributeChanged."+c+"."+d,a,b.owner,b.index,b.name,f),Tundra.events.send("Scene.AttributeChanged."+c+"."+d+"."+e,f)},_initComponentProperties:function(a){for(var b=Scene.componentPropertyNames,c=b.length-1;c>=0;c--){var d=b[c];if("name"!==d){a[d]=null;var e=d.toLowerCase();d!==e&&(a[e]=null)}}},nextFreeIdLocal:function(){return this.entityIdGenerator.allocateLocal()},nextFreeId:function(){return this.entityIdGenerator.allocateReplicated()},update:function(a){},createLocalEntity:function(a,b,c){return(void 0===a||null===a)&&(a=[]),(void 0===b||null===b)&&(b=AttributeChange.LocalOnly),(void 0===c||null===c||"boolean"!=typeof c)&&(c=!1),this.createEntity(this.nextFreeIdLocal(),a,b,!1,c)},createEntity:function(a,b,c,d,e,f){if((void 0===a||null===a||"number"!=typeof a)&&(a=0),(void 0===b||null===b)&&(b=[]),(void 0===c||null===c)&&(c=AttributeChange.Default),"number"!=typeof c&&(this.log.warn("createEntity called with non AttributeChange.Type change mode, defaulting to AttributeChange.Default."),c=AttributeChange.Default),c!=AttributeChange.LocalOnly&&(c=AttributeChange.LocalOnly),(void 0===d||null===d||"boolean"!=typeof d)&&(d=!0),(void 0===e||null===e||"boolean"!=typeof e)&&(e=!0),a=0!==a?a:d?this.nextFreeId():this.nextFreeIdLocal(),this.entityById(a))return this.log.error("Entity id "+a+" already exists in scene, can not create"),null;var g=new Entity;g.replicated=d,g.local=!g.replicated,g.setId(a),this._initComponentProperties(g),this.addEntity(g,f!==!1&&0===b.length);for(var h=0;h<b.length;++h){var i=IComponent.ensureComponentNameWithoutPrefix(b[h]);g.createComponent(i,null,e?AttributeChange.Replicate:AttributeChange.LocalOnly)}return b.length>0&&g.update(),f!==!1&&this._publishEntityCreated(g),g},addEntity:function(a,b){return this.entities.push(a),a.setParent(this),a.update(),b!==!1&&this._publishEntityCreated(a),!0},removeEntity:function(a){a instanceof Entity&&(a=a.id);for(var b=this.entities.length-1;b>=0;b--)if(this.entities[b].id===a){var c=this.entities[b];if(null!=c){this._publishEntityRemoved(c);try{c.reset()}catch(d){this.log.error("removeEntity: Failed to remove entity:"),this.log.error(d.stack||d)}c.id=-1,c.parentScene=null}return this.entities.splice(b,1),c=null,!0}return!1},removeAllEntities:function(){for(;this.entities.length>0;){var a=this.entities[0];try{a&&"function"==typeof a.reset&&a.reset()}catch(b){this.log.error("removeAllEntities: Failed to remove entity '"+a.toString()+"'"),this.log.error(b.stack||b)}"object"==typeof a&&(a.id=-1,a.parentScene=null),this.entities.splice(0,1)}this.entities=[]},entityById:function(a){for(var b=this.entities.length-1;b>=0;b--)if(this.entities[b].id===a)return this.entities[b];return null},entityByName:function(a){for(var b=this.entities.length-1;b>=0;b--)if(this.entities[b].name===a)return this.entities[b];return null},findEntityWith:function(a,b){for(var c=this.entitiesWithComponent(a),d=0;d<c.length;d++)if(c[d].name===b)return c[d];return null},findEntitiesContaining:function(a,b){b===!1&&(a=a.toLowerCase());for(var c=[],d=this.entities.length-1;d>=0;d--){var e=b===!1?this.entities[d].name.toLowerCase():this.entities[d].name;""!==e&&-1!==e.indexOf(a)&&c.push(this.entities[d])}return c},entitiesWithComponent:function(a,b){var c=[];if(null==a&&null==b)return c;for(var d="string"!=typeof a,e=this.entities.length-1;e>=0;e--){var f=d?this.entities[e].componentByTypeId(a,b):this.entities[e].component(a,b);null!=f&&c.push(this.entities[e])}return c},entitiesWithComponents:function(a){var b=[];if(null==a||void 0===a.length||a.length<=0)return b;for(var c=this.entities.length-1;c>=0;c--)for(var d=this.entities[c],e=0,f=a.length;f>e;++e){var g=a[e],h="string"!=typeof g?d.componentByTypeId():d.component(a[e]);null!=h&&b.push(d)}return b},components:function(a,b){for(var c=[],d=this.entities.length-1;d>=0;d--){var e=this.entities[d],f=e.getComponents(a,b);f.length>0&&(c=c.concat(f))}return c},createComponent:function(a,b){if("string"!=typeof a&&"number"!=typeof a)return this.log.error("createComponent: 'type' must be string or a number:",a),null;var c=Scene.registeredComponent(a);if(!c&&"string"==typeof a)for(var d=IComponent.ensureComponentNameWithoutPrefix(a),e=Object.keys(Network.components),f=0,g=e.length;g>f;f++)if(Network.components[e[f]]===d){c={TypeId:parseInt(e[f])};break}return c?this.createComponentById(-1,c.TypeId,"string"==typeof b?b:""):(this.log.error("createComponent: Failed to find component implementation for type '"+a+"'"),null)},createComponentById:function(a,b,c,d){void 0===c&&(c=""),null===d&&(d=void 0);var e=null,f=Scene.registeredComponent(b);if(void 0!==f)try{e=this._createComponentImpl(f,a,c)}catch(g){return this.log.error("Failed to instantiate registered component "+f.typeName+": "+g),null!=console.error&&console.error(g),null}if(null!=e)void 0!==d&&e.deserializeFromBinary(d);else{var h=Network.components[b];if(void 0===h||null===h)return this.log.warn("Component type name could not be resolved from ID "+b),null;e=new IComponent(a,b,h,c),e.notImplemented=!0}return e},_createComponentImpl:function(a,b,c){return new a(b,a.TypeId,a.TypeName,c)},createComponentFromBinary:function(a,b){var c=b.readVLE(),d=b.readVLE(),e=b.readStringU8(),f=b.readVLE(),g=b.readBytes();b.readLimitBytes=f;var h=this.createComponentById(c,d,e,b);if(null==h)return void this.log.error("Failed to create Component with id "+c+" and type id "+d+" from binary data.");var i=f-(b.readBytes()-g);return i>0&&b.skipBytes(i),a.addComponent(h)},onTundraMessage:function(a){var b=(a.ds.readVLE(),a.ds.readVLE());113===a.id?this.handleEditAttributesMessage(b,a.ds):110===a.id?this.handleCreateEntityMessage(b,a.ds):116===a.id?this.handleRemoveEntityMessage(b):111===a.id?this.handleCreateComponentsMessage(b,a.ds):115===a.id?this.handleRemoveComponentsMessage(b,a.ds):112===a.id?this.handleCreateAttributesMessage(b,a.ds):114===a.id&&this.handleRemoveAttributesMessage(b,a.ds)},handleEntityActionMessage:function(a){return a.entityAction.entity=this.entityById(a.entityAction.entityId),null==a.entityAction.entity?void(Tundra.network.options.debug&&this.log.error("Failed to find entity with id "+a.entityAction.entityId+" to execute Entity action on!",!0)):void this._publishEntityAction(a.entityAction)},handleCreateEntityMessage:function(a,b){var c=this.createEntity(a,[],AttributeChange.Replicate,!0,!0,!1);c.temporary=b.readBoolean(),a>this.entityIdGenerator.id&&(this.entityIdGenerator.id=a);for(var d=b.readVLE(),e=0;d>e;++e)if(!this.createComponentFromBinary(c,b)){this.log.error("Failed to create Component to a newly created Entity "+a);break}this._publishEntityCreated(c)},handleRemoveEntityMessage:function(a){this.removeEntity(a)||Tundra.network.options.debug&&this.log.error("Failed to find Entity with id "+a+" for removal!")},handleCreateComponentsMessage:function(a,b){var c=this.entityById(a);if(null==c)return void(Tundra.network.options.debug&&this.log.error("Failed to create Components. Entity with id "+a+" was not found!"));for(;b.bytesLeft()>=3;)if(!this.createComponentFromBinary(c,b))return void this.log.error("Failed to create Component to a existing Entity "+a)},handleRemoveComponentsMessage:function(a,b){var c=this.entityById(a);if(null==c)return void(Tundra.network.options.debug&&this.log.error("Failed to remove Components. Entity with id "+a+" was not found!"));for(;b.bytesLeft()>=1;){var d=b.readVLE();if(!c.removeComponent(d))return void(Tundra.network.options.debug&&this.log.error("Failed to remove Component with id "+d+" from Entity "+a))}},handleCreateAttributesMessage:function(a,b){var c=this.entityById(a);if(null==c)return void(Tundra.network.options.debug&&this.log.error("Failed to create Attribute. Entity with id "+a+" was not found!"));for(;b.bytesLeft()>=3;){var d=b.readVLE(),e=c.componentById(d);if(null!=e){var f=b.readU8();e.createAttributeFromBinary(f,b)}else if(Tundra.network.options.debug)return void this.log.error("Failed to create Attribute from Component with id "+d+" from Entity "+a+". Component not found!")}},handleRemoveAttributesMessage:function(a,b){var c=this.entityById(a);if(null==c)return void(Tundra.network.options.debug&&this.log.error("Failed to remove Attribute. Entity with id "+a+" was not found!"));for(;b.bytesLeft()>=2;){var d=b.readVLE(),e=c.componentById(d);if(null==e)return void(Tundra.network.options.debug&&this.log.error("Failed to remove Attribute with component id "+d+". Component not found!"));if(!e.isDynamic())return void this.log.error("Cannot remove Attribute from Component with id "+d+". Component is not of dynamic type.");e.removeAttribute(b.readU8())}},handleEditAttributesMessage:function(a,b){var c=this.entityById(a);if(null==c)return void(Tundra.network.options.debug&&this.log.error("Failed to update Attributes. Entity with id "+a+" was not found!"));for(var d=null,e=null,f=null;b.bytesLeft()>=2;){var g=b.readVLE(),h=c.componentById(g);if(null==h)return void(Tundra.network.options.debug&&this.log.error("Failed to update Attributes with component id "+g+". Component not found!"));var i=b.readVLE();if(h.notImplemented)b.skipBytes(i);else{var j=b.readBitArray(i);if(1===j.get(0)){for(var k=1,l=0;k<j.size;++k,++l)if(0!==j.get(k)){var m=k+1,n=h.getAttributeByIndex(l);if(void 0===n||null===n)return;var o=n.sizeBytes;if(void 0===o){d=new Uint8Array(n.headerSizeBytes),e=new DataView(d.buffer);for(var p=0;p<n.headerSizeBytes;p++){var q=DataDeserializer.readByteFromBits(j,m);e.setUint8(p,q),m+=8}if(f=new DataDeserializer(d.buffer),o=n.headerFromBinary(f),k+=8*n.headerSizeBytes,void 0===o)return}if(n.typeId!==Attribute.AssetReferenceList&&n.typeId!==Attribute.QVariantList){d=new Uint8Array(o),e=new DataView(d.buffer);for(var r=0;o>r;r++){var q=DataDeserializer.readByteFromBits(j,m);e.setUint8(r,q),m+=8}f=new DataDeserializer(d.buffer),n.dataFromBinary(f,o),k+=8*f.bytePos}else{n.value=[];for(var s=0,r=0;o>r;r++){d=new Uint8Array(255),e=new DataView(d.buffer);var t=DataDeserializer.readByteFromBits(j,m);m+=8;for(var u=0;t>u;++u){var q=DataDeserializer.readByteFromBits(j,m);e.setUint8(u,q),m+=8}f=new DataDeserializer(e.buffer,0,t),n.value.push(f.readString(t,!1)),s+=t+1}k+=8*s,n.set(n.value,AttributeChange.LocalOnly)}}}else{d=new Uint8Array(i),e=new DataView(d.buffer);for(var k=1,v=0;k<j.size;k+=8,++v){var q=DataDeserializer.readByteFromBits(j,k);e.setUint8(v,q)}f=new DataDeserializer(d.buffer);for(var w=f.readU8(),x=0;w>x;++x){var y=f.readU8();h.deserializeAttributeFromBinary(y,f)}}}}}}),IInputEvent=Class.$extend({__init__:function(a){return"string"!=typeof a?void console.error("IInputEvent cannot be constructed without a name. Given:",a):(this.log=TundraLogging.getLogger(a),this.name=a,this.type="",this.typeId=IInputEvent.Type.Unknown,this.x=null,this.y=null,this.z=null,this.relativeX=0,this.relativeY=0,this.relativeZ=0,this.target=null,this.targetId="",this.targetNodeName="",this.originalEvent=null,void(this._preventDefaultFunction=null))},__classvars__:{Type:{Unknown:-1}},toString:function(){return"InputEvent{ "+this.basePropertiesToString()+" }"},clear:function(){this.clearPosition()},basePropertiesToString:function(){return"typeId:"+this.typeId+" type:"+this.type+" x:"+this.x+" y:"+this.y+" relativeX:"+this.relativeX+" relativeY:"+this.relativeY+" relativeZ:"+this.relativeZ+" target:"+this.targetNodeName+(""!==this.targetId?"#"+this.targetId:"")+" originalEvent:"+(null!=this.originalEvent?"valid":"null")},suppress:function(a,b){var c=!1;return"object"==typeof this.originalEvent&&(a="boolean"==typeof a?a:!0,a&&("function"==typeof this._preventDefaultFunction?(this._preventDefaultFunction(),c=!0,"boolean"!=typeof preventPropagation&&(preventPropagation=!1)):"function"==typeof this.originalEvent.preventDefault&&(this.originalEvent.preventDefault(),c=!0)),preventPropagation="boolean"==typeof preventPropagation?preventPropagation:!0,preventPropagation&&"function"==typeof this.originalEvent.stopPropagation&&(this.originalEvent.stopPropagation(),c=!0)),c},isTarget:function(){for(var a=!1,b=0;b<arguments.length;b++){var c=arguments[b];if("string"==typeof c?a=c===this.targetId||c===this.targetNodeName:c instanceof Element?a=c.id===this.targetId&&c.localName===this.targetNodeName:"object"==typeof c&&"string"==typeof c.jquery&&"function"==typeof c.get?c.length>0?a=this.isTarget(c.get(0)):this.log.error("isTarget: Passed an empty jQuery selector:",c.selector):this.log.error("isTarget: Invalid element parameter:",c),a===!0)return a}return a},setOriginalEvent:function(a,b){if(this.originalEvent=a,"object"==typeof a.target){var c="string"==typeof a.target.id,d="string"==typeof a.target.localName;return this.targetId=c?a.target.id:"",this.targetNodeName=d?a.target.localName:"",this.target=a.target,c||d}return this.targetNodeName="",this.targetId="",this.target=null,!1},clearPosition:function(){this.setPositionAxis("x",null),this.setPositionAxis("y",null),this.setPositionAxis("z",null)},clearRelativePosition:function(){this.relativeX=this.relativeY=this.relativeZ=0},setPosition:function(a,b,c){this.setPositionAxis("x",a),this.setPositionAxis("y",b),this.setPositionAxis("z",c)},setPositionAxis:function(a,b){var c="relative"+a.toUpperCase();"number"==typeof b?(this[c]="number"==typeof this[a]?b-this[a]:0,this[a]=b):(this[c]=0,this[a]=null)}}),InputEventMouse=IInputEvent.$extend({__init__:function(){this.$super("InputEventMouse"),this.translated={x:0,y:0},this._pressPos={x:0,y:0},this.buttons={},this.prevButtons={},this.clearButtons(),Object.defineProperties(this,{leftDown:{get:function(){return this.isButtonDown(InputEventMouse.Button.Left)},set:function(a){this.setButton(InputEventMouse.Button.Left,a)}},rightDown:{get:function(){return this.isButtonDown(InputEventMouse.Button.Right)},set:function(a){this.setButton(InputEventMouse.Button.Right,a)}},middleDown:{get:function(){return this.isButtonDown(InputEventMouse.Button.Middle)},set:function(a){this.setButton(InputEventMouse.Button.Middle,a)}}})},__classvars__:{Type:{move:1,press:2,release:3,wheel:4,dblclick:5},Button:{NoButton:0,Left:1,Right:2,Middle:4,X1:8,X2:16}},toString:function(){for(var a=this.name+"{ "+this.basePropertiesToString(),b=[],c=Object.keys(InputEventMouse.Button),d=0;d<c.length;d++){var e=InputEventMouse.Button[c[d]];this.buttons[e]===!0&&b.push(c[d])}return b.length>0&&(a+=" buttons:"+b.join("|")),a+" }"},setType:function(a){this.type=a,this.typeId="number"==typeof InputEventMouse.Type[a]?InputEventMouse.Type[a]:IInputEvent.Type.Unknown},clearButtons:function(){for(var a=Object.keys(InputEventMouse.Button),b=0;b<a.length;b++){var c=InputEventMouse.Button[a[b]];this.buttons[c]=!1,this.prevButtons[c]=!1}},setOriginalEvent:function(a,b){this.$super(a,b),"press"===b?(this._pressPos.x=a.pageX,this._pressPos.y=a.pageY):"release"===b?(this.translated.x=a.pageX-this._pressPos.x,this.translated.y=a.pageY-this._pressPos.y):this.translated.y=this.translated.x=0},readButtonsFromEvent:function(a,b){$.extend(this.prevButtons,this.buttons),Tundra.browser.isFirefox?this.setButtons(1===a.buttons,2===a.buttons,3===a.buttons):this.setButtons(1===a.which,3===a.which,2===a.which)},setButtons:function(a,b,c){this.setButton(InputEventMouse.Button.Left,a),this.setButton(InputEventMouse.Button.Right,b),this.setButton(InputEventMouse.Button.Middle,c)},setButton:function(a,b){this.buttons[a]="boolean"==typeof b?b:!1},isAnyButtonDown:function(){return this.buttons[InputEventMouse.Button.Left]||this.buttons[InputEventMouse.Button.Right]||this.buttons[InputEventMouse.Button.Middle]||this.buttons[InputEventMouse.Button.X1]||this.buttons[InputEventMouse.Button.X2]},wasButtonDown:function(a){return this._buttonDown(a,this.prevButtons)},wasAnyButtonDown:function(){return this.prevButtons[InputEventMouse.Button.Left]||this.prevButtons[InputEventMouse.Button.Right]||this.prevButtons[InputEventMouse.Button.Middle]||this.prevButtons[InputEventMouse.Button.X1]||this.prevButtons[InputEventMouse.Button.X2]},hasTranslated:function(a,b){return Math.abs(this.translated.x)>("number"==typeof a?a:0)||Math.abs(this.translated.y)>("number"==typeof b?b:"number"==typeof a?a:0)},isButtonDown:function(a){return this._buttonDown(a,this.buttons)},_buttonDown:function(a,b){if("string"==typeof a){var c=a.toLowerCase();if("left"===c)a=InputEventMouse.Button.Left;else if("right"===c)a=InputEventMouse.Button.Right;else if("middle"===c)a=InputEventMouse.Button.Middle;else if("x1"===c)a=InputEventMouse.Button.X1;else{if("x2"!==c)return this.log.error("is/wasButtonDown: Invalid identifier '"+a+"'"),!1;a=InputEventMouse.Button.X2}}var d=b[a];return"boolean"!=typeof d?(this.log.error("is/wasButtonDown: Invalid identifier '"+a+"'"),!1):d}}),InputAPI=ITundraAPI.$extend({__init__:function(a,b,c){this.$super(a,b),this.mouse=new InputEventMouse,this.keyboard={type:"",keyCode:0,key:"",repeat:!1,pressed:{},targetId:"",targetNodeName:"",originalEvent:null,suppress:function(a,b){null!=this.originalEvent&&((void 0===a||a===!0)&&this.originalEvent.preventDefault(),(void 0===b||b===!0)&&this.originalEvent.stopPropagation())}},this.keys={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},this.keycodes={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"}},initialize:function(){this.clearOverrideCursor(),Tundra.ui.onTabFocusChanged(this,this.clearOverrideCursor.bind(this)),Tundra.input.registerMouseEvents(Tundra.client.container),this.ignoredNodeNameRules=["webrocket-","meshmoon-"],$(document).keydown(function(a){for(var b=a.target.nodeName.toLowerCase(),c=this.ignoredNodeNameRules.length-1;c>=0;c--)if(0===b.indexOf(this.ignoredNodeNameRules[c]))return;$(a.target,document.activeElement).is("input, textarea, core-input, paper-input, overlay-host")||this.onKeyPressInternal(a)}.bind(this)).keyup(function(a){for(var b=a.target.nodeName.toLowerCase(),c=this.ignoredNodeNameRules.length-1;c>=0;c--)if(0===b.indexOf(this.ignoredNodeNameRules[c]))return;$(a.target,document.activeElement).is("input, textarea, core-input, paper-input, overlay-host")||this.onKeyReleaseInternal(a)}.bind(this))},postInitialize:function(){for(var a=0;a<InputAPI.plugins.length;a++)try{InputAPI.plugins[a]._start()}catch(b){this.log.error("Plugin '"+InputAPI.plugins[a].name+"' start() threw exception: "+b)}},reset:function(){Tundra.events.remove("InputAPI.MouseEvent"),Tundra.events.remove("InputAPI.MouseMove"),Tundra.events.remove("InputAPI.MouseClick"),Tundra.events.remove("InputAPI.MousePress"),Tundra.events.remove("InputAPI.MouseRelease"),Tundra.events.remove("InputAPI.MouseWheel"),Tundra.events.remove("InputAPI.MouseDoubleClicked"),Tundra.events.remove("InputAPI.KeyEvent"),Tundra.events.remove("InputAPI.KeyPress"),Tundra.events.remove("InputAPI.KeyRelease");for(var a=0;a<InputAPI.plugins.length;a++)try{InputAPI.plugins[a]._reset()}catch(b){this.log.error("Plugin '"+InputAPI.plugins[a].name+"' reset() threw exception: "+b)}},__classvars__:{plugins:[],registerPlugin:function(a){for(var b=0;b<InputAPI.plugins.length;b++)if(InputAPI.plugins[b].name===a.name)return void this.log.error("registerPlugin() Name of the plugin needs to be unique. Name",a.name,"already registered");InputAPI.plugins.push(a)},getPlugin:function(a){for(var b=0;b<InputAPI.plugins.length;b++)if(InputAPI.plugins[b].name===a)return InputAPI.plugins[b];return null}},registerPluginEvent:function(a,b){var c="on"+a;return void 0!==this[c]?(this.log.error("[InputAPI]: Cannot register plugin event "+a+" the handler InputAPI."+c+" is already registered!"),!1):(this[c]=function(a,c){return Tundra.events.subscribe(b,a,c)},this.log.debug("Registered event",b),!0)},setOverrideCursor:function(a){Tundra.client.container&&Tundra.client.container.css("cursor",a)},getOverrideCursor:function(){var a=Tundra.client.container?Tundra.client.container.css("cursor"):"";return("string"!=typeof a||"default"===a)&&(a=""),a},clearOverrideCursor:function(){this.setOverrideCursor("default")},hasEvent:function(a){return"string"!=typeof a?!1:"function"==typeof this["on"+a]},supportsEventType:function(a){return"function"==typeof this["on"+a]},registerMouseEvents:function(a){var b=this,c=$(a);c.css({"user-select":"none"}),c.mousedown(function(a){b.onMousePressInternal(a)}),c.mouseup(function(a){b.onMouseReleaseInternal(a)}),c.mousemove(function(a){b.onMouseMoveInternal(a)}),c.mousewheel(function(a,c,d,e){b.onMouseWheelInternal(a,c,d,e)}),c.dblclick(function(a){b.onMouseDoubleClickInternal(a)}),c.bind("contextmenu",function(){return!1})},onMouseEvent:function(a,b,c){return Tundra.events.subscribe("InputAPI.MouseEvent",a,b,c)},onMouseMove:function(a,b,c){return Tundra.events.subscribe("InputAPI.MouseMove",a,b,c)},onMouseClick:function(a,b,c){return Tundra.events.subscribe("InputAPI.MouseClick",a,b,c)},onMousePress:function(a,b,c){return Tundra.events.subscribe("InputAPI.MousePress",a,b,c)},onMouseRelease:function(a,b,c){return Tundra.events.subscribe("InputAPI.MouseRelease",a,b,c)},onMouseWheel:function(a,b,c){return Tundra.events.subscribe("InputAPI.MouseWheel",a,b,c)},onMouseDoubleClicked:function(a,b,c){return Tundra.events.subscribe("InputAPI.MouseDoubleClicked",a,b,c)},onKeyEvent:function(a,b,c){return Tundra.events.subscribe("InputAPI.KeyEvent",a,b,c)},onKeyPress:function(a,b,c){return Tundra.events.subscribe("InputAPI.KeyPress",a,b,c)},onKeyRelease:function(a,b,c){return Tundra.events.subscribe("InputAPI.KeyRelease",a,b,c)},onMouseMoveInternal:function(a){this.readMouseEvent("move",a),(0!==this.mouse.relativeX||0!==this.mouse.relativeY)&&(Tundra.events.send("InputAPI.MouseMove",this.mouse)||Tundra.events.send("InputAPI.MouseEvent",this.mouse))},onMousePressInternal:function(a){this.readMouseEvent("press",a),Tundra.events.send("InputAPI.MouseClick",this.mouse)||Tundra.events.send("InputAPI.MousePress",this.mouse)||Tundra.events.send("InputAPI.MouseEvent",this.mouse)},onMouseReleaseInternal:function(a){this.readMouseEvent("release",a),this.mouse.setButtons(!1,!1,!1),Tundra.events.send("InputAPI.MouseClick",this.mouse)||Tundra.events.send("InputAPI.MouseRelease",this.mouse)||Tundra.events.send("InputAPI.MouseEvent",this.mouse)},onMouseWheelInternal:function(a,b,c,d){this.readMouseEvent("wheel",a,d),Tundra.events.send("InputAPI.MouseWheel",this.mouse)||Tundra.events.send("InputAPI.MouseEvent",this.mouse)},onMouseDoubleClickInternal:function(a){this.readMouseEvent("dblclick",a),Tundra.events.send("InputAPI.MouseDoubleClicked",this.mouse)||Tundra.events.send("InputAPI.MouseEvent",this.mouse)},readMouseEvent:function(a,b,c){this.mouse.setOriginalEvent(b,a),this.mouse.readButtonsFromEvent(b,a),this.mouse.setPosition(b.pageX,b.pageY),"number"==typeof c&&(this.mouse.relativeZ=c),this.mouse.setType(a)},onKeyPressInternal:function(a){this.readKeyEvent(a),this.keyboard.type="press",Tundra.events.send("InputAPI.KeyPress",this.keyboard)||Tundra.events.send("InputAPI.KeyEvent",this.keyboard)},onKeyReleaseInternal:function(a){this.readKeyEvent(a),this.keyboard.type="release",Tundra.events.send("InputAPI.KeyRelease",this.keyboard)||Tundra.events.send("InputAPI.KeyEvent",this.keyboard)},readKeyEvent:function(a){this.keyboard.originalEvent=a,void 0!==a.target&&null!==a.target?(this.keyboard.targetNodeName=a.target.localName,this.keyboard.targetId=a.target.id):(this.keyboard.targetNodeName="",this.keyboard.targetId=""),this.keyboard.keyCode=a.which,this.keyboard.key=this.characterForKeyCode(a.which),this.keyboard.repeat=!1,"keydown"===a.type?this.keyboard.pressed[this.keyboard.key]===!0?this.keyboard.repeat=!0:this.keyboard.pressed[this.keyboard.key]=!0:delete this.keyboard.pressed[this.keyboard.key]},characterForKeyCode:function(a){return this.keys[a]?this.keys[a]:this.keycodes[a]?this.keycodes[a]:String.fromCharCode(a).toLowerCase()}}),UiAPI=ITundraAPI.$extend({__init__:function(a,b,c){this.$super(a,b),this.tabActive=!0,this.timing=new AsyncHelper("UiAPI",this),this.buttons=[],this.numContextMenus=0,this.createTaskbar(this.options.taskbar),this.createConsole(this.options.console),this.onWindowResizeDOM(),window.addEventListener("resize",this.onWindowResizeDOM.bind(this),!1),this.options.allowFullscreen&&$(document).on("webkitfullscreenchange mozfullscreenchange fullscreenchange",function(a){var b=this.isFullscreen();console.debug("[UiAPI]: Fullscreen",b),"function"==typeof this.buttonFullscreen.css&&this.buttonFullscreen.css("background-image","url('"+Tundra.asset.getLocalAssetPath("img/"+(b?"icon-collapse.png":"icon-expand.png"))+"')"),
this.isFullscreen()||(this._exitedFullscreen=!0)}.bind(this)),$(window).focus(function(){this.tabActive=!0,Tundra.events.send("UiAPI.TabFocusChanged",!0)}.bind(this)).blur(function(){this.tabActive=!1,Tundra.events.send("UiAPI.TabFocusChanged",!1)}.bind(this)),Tundra.client.onConnected(this,this.onConnected),Tundra.client.onDisconnected(this,this.onDisconnected)},__classvars__:{getDefaultOptions:function(){return{allowFullscreen:!0,taskbar:!0,console:!0,fps:!1}},Layout:{Horizontal:1,Vertical:2,IsValid:function(a){return UiAPI.IsValidEnum(a)?a===this.Horizontal||a===this.Vertical:!1},ToString:function(a){return a===this.Horizontal?"horizontal":a===this.Vertical?"vertical":""}},Align:{Left:1,Right:2,HCenter:4,Justify:8,Top:32,Bottom:64,VCenter:128,Center:132,IsValid:function(a){return UiAPI.IsValidEnum(a)?a===this.Left||a===this.Right||a===this.Top||a===this.Bottom||a===this.Center||a===this.HCenter||a===this.VCenter||a===this.Justify:!1},ToString:function(a,b){switch(b){case this.Left:return a===UiAPI.Layout.Horizontal?"start-justified":"start";case this.Right:return a===UiAPI.Layout.Horizontal?"end-justified":"end";case this.HCenter:case this.Center:return a===UiAPI.Layout.Horizontal?"center-justified":"center";case this.Top:return a===UiAPI.Layout.Horizontal?"start":"start-justified";case this.Bottom:return a===UiAPI.Layout.Horizontal?"end":"end-justified";case this.VCenter:case this.Center:return a===UiAPI.Layout.Horizontal?"center":"center-justified";default:return""}}},Corner:{TopLeft:33,TopRight:34,BottomLeft:65,BottomRight:66,IsValid:function(a){return UiAPI.IsValidEnum(a)?a===this.TopLeft||a===this.TopRight||a===this.BottomLeft||a===this.BottomRight:!1},ToString:function(a){switch(a){case this.TopLeft:return"top-left";case this.TopRight:return"top-right";case this.BottomLeft:return"bottom-left";case this.BottomRight:return"bottom-right";default:return""}}},Position:{Start:1,End:2,Left:4,Right:8,Top:32,Bottom:64,IsValid:function(a){return UiAPI.IsValidEnum(a)?a===this.Start||a===this.End||a===this.Left||a===this.Right||a===this.Top||a===this.Bottom:!1},ToString:function(a){switch(a){case this.Start:return"start";case this.End:return"end";case this.Left:return"left";case this.Right:return"right";case this.Top:return"top";case this.Bottom:return"bottom";default:return""}}},IsValidEnum:function(a){return"number"==typeof a&&a>0}},addToVerticalToolbar:function(a,b,c,d,e){var f=this.getVerticalToolbar(b);if(f)return UiAPI.Position.IsValid(c)||(c=UiAPI.Position.End),f.add(d,e,c,a)},getVerticalToolbar:function(a){if(!Tundra.usingPolymer())return void this.log.error("getVerticalToolbar: Called on non polymer UiAPI");if(!UiAPI.Position.IsValid(a))return void this.log.error("getVerticalToolbar: 'side' is not a valid UiAPI.Position value");if(a!==UiAPI.Position.Left&&a!==UiAPI.Position.Right)return void this.log.error("getVerticalToolbar: 'side' must be UiAPI.Position.Left or UiAPI.Position.Right");void 0===this.toolbars&&(this.toolbars={});var b=this.toolbars[a];if(void 0!==b)return b;b=this.toolbars[a]=this.createVerticalToolbar(a);var c={position:"absolute",top:0};return a===UiAPI.Position.Left?c.left=0:c.right=0,$(b).css(c),this.add(b),this._updateLayouts(),b},createVerticalToolbar:function(a){var b=document.createElement("webrocket-vertical-toolbar");return b.id="webrocket-toolbar-"+UiAPI.Position.ToString(a),b.position=UiAPI.Position.ToString(a),b},_updateLayouts:function(){for(var a in this.layouts){var b=this.layouts[a];if(b){if(this.toolbars&&Object.keys(this.toolbars).length>0){var c=void 0;a===UiAPI.Corner.TopLeft.toString()||a===UiAPI.Corner.BottomLeft.toString()?void 0!==this.toolbars[UiAPI.Position.Left]&&(b.css("margin-left",50),c=this.toolbars[UiAPI.Position.Left]):(a===UiAPI.Corner.TopRight.toString()||a===UiAPI.Corner.BottomRight.toString())&&void 0!==this.toolbars[UiAPI.Position.Right]&&(b.css("margin-right",50),c=this.toolbars[UiAPI.Position.Right]),c&&"function"==typeof c.setHeight&&c.setHeight(b.outerHeight(!0)-10)}for(var d=b.children(),e=0,f=0;e<d.length;e++)$(d[e]).is(":visible")&&($(d[e]).css("margin-top",0===f?10:0),f++)}}},addToCorner:function(a,b,c){var d=this.getCornerLayout(b);return d?(UiAPI.Position.IsValid(c)||(c=UiAPI.Position.End),$(a).each(function(){$(this).css({margin:10,"pointer-events":"auto"}),c===UiAPI.Position.End?($(this).css({"margin-top":0===d.children().length?10:0}),d.append(this)):(d.children().length>0&&d.children().first().css({"margin-top":0}),d.prepend(this))}),this.timing.async("update.layouts",this._updateLayouts,500),a):a},getCornerLayout:function(a){if(!Tundra.usingPolymer())return void this.log.error("getLayout: Called on non polymer UiAPI");if(!UiAPI.Corner.IsValid(a))return void this.log.error("getLayout: 'corner' is not a valid UiAPI.Corner value");void 0===this.layouts&&(this.layouts={}),void 0===this.layoutObservers&&(this.layoutObservers={});var b=this.layouts[a];if(void 0!==b)return b;var c=a===UiAPI.Corner.TopLeft||a===UiAPI.Corner.BottomLeft?UiAPI.Align.Left:UiAPI.Align.Right;b=this.layouts[a]=this.createLayout(UiAPI.Layout.Vertical,c,UiAPI.Align.VCenter),b.attr("id","webrocket-corner-layout-"+UiAPI.Corner.ToString(a));var d={position:"absolute",margin:0,padding:0,"pointer-events":"none"};return(a===UiAPI.Corner.TopLeft||a===UiAPI.Corner.TopRight)&&(d.top=0),(a===UiAPI.Corner.BottomLeft||a===UiAPI.Corner.BottomRight)&&(d.bottom=a===UiAPI.Corner.BottomRight&&this.polymer.toolbar?$(this.polymer.toolbar).outerHeight()+20:0),(a===UiAPI.Corner.TopLeft||a===UiAPI.Corner.BottomLeft)&&(d.left=0),(a===UiAPI.Corner.TopRight||a===UiAPI.Corner.BottomRight)&&(d.right=0),b.css(d),this._updateLayouts(),this.add(b),this.layoutObservers[a]=new MutationObserver(function(a){for(var b=0;b<a.length;b++){var c=a[b];"childList"===c.type&&(c.addedNodes&&c.addedNodes.length>0||c.removedNodes&&c.removedNodes.length>0)&&this._updateLayouts()}}.bind(this)),this.layoutObservers[a].observe(b.get(0),{childList:!0,subtree:!1}),b},createLayout:function(a,b,c){if(!Tundra.usingPolymer())return void this.log.error("getLayout: Called on non polymer UiAPI");if(!UiAPI.Layout.IsValid(a))return void this.log.error("getLayout: 'corner' is not a valid UiAPI.Layout value");var d=$("<div/>"),e={layout:""};return e[UiAPI.Layout.ToString(a)]="",b===UiAPI.Align.Center||c===UiAPI.Align.Center?(e[UiAPI.Align.ToString(a,UiAPI.Align.HCenter)]="",e[UiAPI.Align.ToString(a,UiAPI.Align.VCenter)]=""):(UiAPI.Align.IsValid(b)&&(e[UiAPI.Align.ToString(a,b)]=""),UiAPI.Align.IsValid(c)&&(e[UiAPI.Align.ToString(a,c)]="")),d.attr(e),d},initialize:function(){this.onWindowResizeInternal(),Tundra.console.registerCommand("clear","Clears the console messages",null,this,this.clearConsole),Tundra.console.registerCommand("showFps","Toggles statistics widget",null,this,this.toggleStatsWidget)},_createStatsWidget:function(){this.appStats||Tundra.asset.loadDependencies(void 0,"webrocket://elements/webrocket-stats.html").done(function(){this.appStats||(this.appStats=document.createElement("webrocket-stats"),this.addToCorner(this.appStats,UiAPI.Corner.TopRight,UiAPI.Position.Start),this.buttonStats&&this.buttonStats.setAttribute("colored",""))}.bind(this))},_destroyStatsWidget:function(){this.appStats&&($(this.appStats).remove(),this.appStats=void 0),this.buttonStats&&this.buttonStats.removeAttribute("colored")},toggleStatsWidget:function(){this.setStatsWidgetVisible(void 0===this.appStats)},setStatsWidgetVisible:function(a){Tundra.usingPolymer()&&(a?this._createStatsWidget():this._destroyStatsWidget())},showFps:function(){Tundra.options.deprecatedWarnings&&console.warn("DEPRECATED: Tundra.ui.showFps > Tundra.ui.toggleStatsWidget|setStatsWidgetVisible"),this.setStatsWidgetVisible(!0)},toggleFps:function(){Tundra.options.deprecatedWarnings&&console.warn("DEPRECATED: Tundra.ui.toggleFps > Tundra.ui.toggleStatsWidget|setStatsWidgetVisible"),this.toggleStatsWidget()},reset:function(){for(var a=0;a<this.buttons.length;a++)this.buttons[a].remove();if(this.buttons=[],this.polymer&&this.polymer.toolbar&&"function"==typeof this.polymer.toolbar.clear&&this.polymer.toolbar.clear(),this._destroyStatsWidget(),this.layoutObservers){for(var b=Object.keys(this.layoutObservers),a=0;a<b.length;a++){var c=this.layoutObservers[b[a]];c&&"function"==typeof c.disconnect&&c.disconnect()}this.layoutObservers=void 0}if(this.layouts){for(var b=Object.keys(this.layouts),a=0;a<b.length;a++){var d=this.layouts[b[a]];d&&($(d).empty(),$(d).remove())}this.layouts=void 0}if(this.toolbars){for(var b=Object.keys(this.toolbars),a=0;a<b.length;a++){var e=this.toolbars[b[a]];e&&($(e).empty(),$(e).remove())}this.toolbars=void 0}for(var a=0;a<this.numContextMenus;a++){var f=$("#webrocket-context-menu-"+a);null!=f&&f.remove()}this.numContextMenus=0,this.buttonDisconnect=this.addAction("Disconnect",Tundra.asset.getLocalAssetPath("img/icon-disconnect.png")),this.buttonDisconnect.click(function(a){Tundra.client.disconnect(),a.stopPropagation(),a.preventDefault()}),Tundra.usingPolymer()&&(this.buttonStats=this.addAction("Statistics","view-quilt"),this.buttonStats.click(function(a){this.toggleStatsWidget()}.bind(this))),Tundra.usingRequireJS()&&(this.buttonConsole=this.addAction("Console",Tundra.asset.getLocalAssetPath("img/icon-console.png")),this.buttonConsole.click(function(a){this.toggleConsole(),a.preventDefault(),a.stopPropagation()}.bind(this))),this.options.allowFullscreen&&(this.buttonFullscreen=this.addAction("Go Fullscreen",Tundra.asset.getLocalAssetPath("img/icon-expand.png")),this.buttonFullscreen.click(function(a){this.toggleFullScreen(),a.preventDefault(),a.stopPropagation()}.bind(this))),this.onWindowResizeInternal()},onConnected:function(){Tundra.input.onKeyPress(this,this.onKeyPress),this.options.fps&&this.setStatsWidgetVisible(!0)},onDisconnected:function(){this.console.is(":visible")&&this.toggleConsole(),this.clearConsole(),this._destroyStatsWidget()},topZIndex:function(){var a=null!=this.console?this.console.css("z-index"):5;return"string"==typeof a&&"auto"!==a&&a.length>0?parseInt(a)+50:150},autoFullscreen:function(){this.options.allowFullscreen&&Tundra.browser.isMobile()&&void 0===this._exitedFullscreen&&this.showFullscreen()},toggleFullScreen:function(a){if(this.options.allowFullscreen){var b=this.isFullscreen();void 0===a&&!b||a===!1&&b?this.showFullscreen():(void 0===a&&b||a===!0&&!b)&&this.exitFullscreen()}},isFullscreen:function(){return!!(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement)},showFullscreen:function(a){this.options.allowFullscreen&&(this.isFullscreen()||(a=a||document.documentElement,"function"==typeof a.get&&(a=a.get(0)),a.requestFullscreen?a.requestFullscreen():a.msRequestFullscreen?a.msRequestFullscreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.webkitRequestFullscreen?-1!==navigator.userAgent.indexOf("Safari")&&-1===navigator.userAgent.indexOf("Chrome")?a.webkitRequestFullscreen():a.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT):a.webkitRequestFullScreen&&(-1!==navigator.userAgent.indexOf("Safari")&&-1===navigator.userAgent.indexOf("Chrome")?a.webkitRequestFullScreen():a.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT))))},exitFullscreen:function(){this.isFullscreen()&&(this._exitedFullscreen=!0,document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen())},createTaskbar:function(a){return null==this.taskbar?((void 0===a||null===a)&&(a=!0),a?void(Tundra.usingPolymer()?(this.polymer={toolbar:!0,pendingActions:[],pendingContextMenus:[],pendingContextMenuItems:[]},Tundra.asset.loadDependencies(void 0,"webrocket://elements/webrocket-toolbar.html","webrocket://elements/webrocket-vertical-toolbar.html").done(function(){this.polymer.toolbar=document.createElement("webrocket-toolbar"),this.polymer.toolbar.CoreStringUtils=CoreStringUtils,this.polymer.toolbar.addAction(this.polymer.pendingActions);for(var a=0;a<this.polymer.pendingContextMenus.length;a++)this.polymer.toolbar.addContextMenu(this.polymer.pendingContextMenus[a]);for(var a=0;a<this.polymer.pendingContextMenuItems.length;a++)this.polymer.toolbar.addContextMenuItem(this.polymer.pendingContextMenuItems[a].menu,this.polymer.pendingContextMenuItems[a].item);this.polymer.pendingActions=[],this.polymer.pendingContextMenus=[],this.polymer.pendingContextMenuItems=[],$(this.polymer.toolbar).css({position:"absolute",right:10,bottom:10,margin:0,padding:0,"z-index":10,"pointer-events":"none"}),this.add(this.polymer.toolbar)}.bind(this))):(this.taskbar=$("<div/>"),this.taskbar.attr("id","webrocket-taskbar"),this.taskbar.css({position:"absolute",left:0,bottom:0,padding:0,margin:0,height:Tundra.browser.isMobile()?36:30,width:"100%",border:0,"border-top":"1px solid gray","background-color":"rgb(248,248,248)","box-shadow":"inset 0 0 7px gray, 0 0 7px gray, inset 0 0px 0px 0px gray;","user-select":"none"}),Tundra.browser.isMobile()?this.taskbar.css({"background-color":"transparent","border-top":0,"box-shadow":"none"}):Tundra.browser.isOpera?this.taskbar.css("background-image","-o-linear-gradient(rgb(248,248,248),rgb(190,190,190))"):Tundra.browser.isFirefox?this.taskbar.css({"background-image":"-moz-linear-gradient(top, rgb(248,248,248), rgb(190,190,190))","-moz-box-shadow":"inset 0 0 0px gray, 0 0 5px gray"}):(Tundra.browser.isChrome||Tundra.browser.isSafari)&&this.taskbar.css({"background-image":"-webkit-gradient(linear, left top, left bottom, color-stop(0, rgb(248,248,248)), color-stop(0.8, rgb(190,190,190)))","-webkit-box-shadow":"0 0 7px gray"}),this.add(this.taskbar))):void(this.taskbar=null)):void 0},createConsole:function(a){null==this.console&&((void 0===a||null===a)&&(a=!0),this.console=a?$("<div/>"):null,null!=this.console&&(this.console.attr("id","webrocket-console"),this.console.css({position:"absolute",height:0,width:"100%","white-space":"pre",margin:0,padding:0,"padding-top":5,"padding-bottom":5,border:0,overflow:"auto","font-family":"Courier New","font-size":"10pt",color:"#444","background-color":"rgba(255, 255, 255, 0.8)","z-index":100}),this.consoleInput=$("<input/>",{id:"webrocket-console-input",type:"text"}),this.consoleInput.data("data",{history:[],index:0}),this.consoleInput.css({position:"absolute",color:"#444","background-color":"rgba(221, 221, 221, 0.8)",border:1,"border-top":"1px solid gray","border-bottom":"1px solid gray","padding-left":5,"font-family":"Courier New","font-size":"10pt",height:20,width:"100%","z-index":100}),this.consoleInput.focus(function(){$(this).css("background-color","white")}).blur(function(){$(this).css("background-color","rgba(248,248,248, 0.8)"),Tundra.browser.isMobile()&&Tundra.ui.toggleConsole(!1)}).keydown(function(a){if(9==a.which){var b=Tundra.console.commandSuggestion($(this).val());return null!=b&&b!==$(this).val()&&$(this).val(b),a.preventDefault(),!1}if(38==a.which||40==a.which){var c=$(this).data("data");c.index+=38==a.which?1:-1,c.index>=c.history.length&&(c.index=c.history.length-1);var d=c.index>=0?c.history[c.index]:"";return c.index<-1&&(c.index=-1),$(this).val(d),a.preventDefault(),!1}}).keypress(function(a){if(13==a.which){var b=$(this).val();if(""==b)return;return Tundra.console.executeCommandRaw(b)&&($(this).data("data").history.unshift(b),$(this).data("data").index=-1),$(this).val(""),a.preventDefault(),!1}}).keyup(function(a){27==a.keyCode&&this.toggleConsole()}.bind(this)),this.addWidgetToScene([this.console,this.consoleInput]),this.console.hide(),this.consoleInput.hide()))},clearConsole:function(){this.console.empty()},onWindowResize:function(a,b){return Tundra.events.subscribe("UiAPI.WindowResize",a,b)},onTabFocusChanged:function(a,b){return Tundra.events.subscribe("UiAPI.TabFocusChanged",a,b)},onClearFocus:function(a,b){return Tundra.events.subscribe("UiAPI.ClearFocus",a,b)},clearFocus:function(){Tundra.events.send("UiAPI.ClearFocus")},addWidgetToScene:function(a){this.add(a)},add:function(a){for(var b=Array.isArray(a)?a:[a],c=!0,d=0;d<b.length;++d){var e=$(b[d]);if(null!=e&&void 0!=e){var f=e.css("z-index");"string"==typeof f&&""!==f&&(f=parseInt(f)),("number"!=typeof f||isNaN(f))&&(f=0),5>f&&e.css("z-index",5),Tundra.client.container.append(e)}else console.error("[UiAPI]: Invalid input widget could not be added to the scene."),c=!1}return c},addWebComponentToScene:function(a,b,c,d){console.warn("UiAPI:addWebComponentToScene is deprecated. Use the Polymer library directly. Invoked with:"),console.warn(a,b,c,d)},addAction:function(a,b,c,d){if(this.polymer){var e=document.createElement("paper-icon-button");return e.tabIndex="-1",e.iconUrl="string"==typeof b&&(0===b.toLowerCase().indexOf("http")||0===b.toLowerCase().indexOf(".."))||-1!==b.indexOf("/")?b:"",e.icon=""===e.iconUrl&&"string"==typeof b?b:"",e.tip=a,e.hide=function(){this.hidden=!0}.bind(e),e.show=function(){this.hidden=!1}.bind(e),e.click=function(a){this.addEventListener("click",a,!1)}.bind(e),e.tooltip=function(a){var b=$(this).parent().get(0);if(b&&"core-tooltip"===b.localName)return void 0===a?b.label:void("string"==typeof a&&(b.label=a))}.bind(e),this.polymer.toolbar&&"function"!=typeof this.polymer.toolbar.addAction?this.polymer.pendingActions.splice(0,0,e):this.polymer.toolbar.addAction(e),e}if(null==this.taskbar)return null;var f=this.taskbar.height();null==c&&(c=32),Tundra.browser.isMobile()&&40>c&&(c=40);var g=this.buttons.length,h="taskbar-button-"+g,i=$("<div/>",{id:h,title:null!=a?a:""});return(void 0===d||d===!0)&&i.button(),i.tooltip(),Tundra.browser.isMobile()&&i.tooltip("disable"),i.height(f),i.width(c),i.css({padding:0,margin:0,width:c,"min-width":c,"max-width":c,"background-color":"transparent",border:0,"border-radius":0,"border-color":"transparent"}),Tundra.browser.isMobile()&&i.css("background-color","rgba(230, 230, 230, 0.8)"),null!=b&&""!=b&&i.css({"background-image":"url("+b+")","background-repeat":"no-repeat","background-position":"center"}),i.fadeIn(),this.taskbar.append(i),this.buttons.push(i),this.onWindowResizeInternal(),i},addContextMenu:function(a,b,c,d,e){if(this.polymer){var f=a.contextMenu=document.createElement("paper-dropdown");return this.polymer.toolbar&&"function"==typeof this.polymer.toolbar.addContextMenu?this.polymer.toolbar.addContextMenu(f):this.polymer.pendingContextMenus.splice(0,0,f),f}void 0===b&&(b=!0),void 0===c&&(c=!1);var g="webrocket-context-menu-"+this.numContextMenus;this.numContextMenus++,a=$(a),a.contextMenu(g,{},{disable_native_context_menu:b,leftClick:c,showMenu:d,hideMenu:e});var h=$("#"+g);return h.css({"background-color":"#F2F2F2",border:"1px solid #999999","list-style-type":"none",margin:0,padding:0}),h},addContextMenuItems:function(a,b){b=Array.isArray(b)?b:[b];for(var c=0;c<b.length;c++){var d=b[c];if(this.polymer){var e=document.createElement("paper-item");"string"==typeof d.name&&""!==d.name?e.innerText=d.name:console.error("addContextMenuItems: Item 'text' is not a valid string:",d),"function"==typeof d.callback?e.addEventListener("click",d.callback,!1):console.error("addContextMenuItems: Item 'callback' is not a function:",d),$(e).data("itemName",d.name),this.polymer.toolbar&&"function"==typeof this.polymer.toolbar.addContextMenuItem?this.polymer.toolbar.addContextMenuItem(a,e):this.polymer.pendingContextMenuItems.push({menu:a,item:e})}else{var f=$("<li/>"),e=$('<a href="#">'+d.name+"</a>");e.css({"font-family":"Arial","font-size":20,"background-color":"#F2F2F2",color:"#333333","text-decoration":"none",display:"block",padding:5}),e.hover(function(){$(this).css({"background-color":"rgb(150,150,150)",color:"rgb(255,255,255)"})},function(){$(this).css({"background-color":"#F2F2F2",color:"#333333"})}),e.data("itemName",d.name),e.on("click",d.callback),f.append(e),a.append(f)}}},onKeyPress:function(a){if(null!=this.console&&"1"===a.key&&"input"!==a.targetNodeName){if(this.consoleInput.is(":visible")&&this.consoleInput.is(":focus"))return;this.toggleConsole()}},toggleConsole:function(a){if(null!=this.console){var b=this.console.is(":visible");if((void 0===a||null===a)&&(a=!b),a!=b)if(b||(this.console.height(0),this.console.show(),this.consoleInput.show()),Tundra.browser.isMobile())a?(this.console.show(),this.console.animate({scrollTop:this.console.prop("scrollHeight")},350),this.consoleInput.focus(),this.onWindowResizeInternal()):(this.console.scrollTop(0),this.console.hide(),this.consoleInput.trigger("blur"),this.consoleInput.hide(),this.onWindowResizeInternal());else{var c=this;this.console.animate({height:b?0:250},{duration:250,easing:"swing",progress:function(){c.onWindowResizeInternal()},complete:b?function(){c.console.scrollTop(0),c.console.hide(),c.consoleInput.trigger("blur"),c.consoleInput.hide(),c.onWindowResizeInternal()}:function(){c.console.animate({scrollTop:c.console.prop("scrollHeight")},350),c.consoleInput.focus(),c.onWindowResizeInternal()}})}}},width:function(){return Tundra.client.container.width()},height:function(){return Tundra.client.container.height()},onWindowResizeDOM:function(a){this.onWindowResizeInternal();var b=Tundra.client.container;null!=b&&Tundra.events.send("UiAPI.WindowResize",b.width(),b.height()),this.timing.async("update.layouts",this._updateLayouts,32)},onWindowResizeInternal:function(){if(null!=this.taskbar&&this.buttons.length>0){for(var a=0,b=this.buttons.length-1;b>=0;b--)a+=this.buttons[b].width();this.buttons[0].position({my:"left",at:"right-"+a,of:this.taskbar});for(var c=this.buttons[0],b=1;b<this.buttons.length;b++)this.buttons[b].position({my:"left",at:"right",of:c,collision:"fit"}),c=this.buttons[b]}null!=this.console&&(this.console.is(":visible")&&(this.console.position({my:"left top",at:"left top",of:this.console.parent()}),Tundra.browser.isMobile()&&this.console.outerHeight(this.height()-this.consoleInput.outerHeight())),this.consoleInput.is(":visible")&&this.consoleInput.position({my:"left top",at:"left bottom",of:this.console}))},openModalDialog:function(a){if(!Tundra.usingPolymer())return void this.log.error("openModalDialog is only implemented for polymer");var b=document.createElement("webrocket-dialog");if(a.text||a.html){var c=document.createElement("core-item");c.style.whiteSpace="pre-wrap",c.style.fontSize="18px",c.style.lineHeight="30px","number"==typeof a.fontSize?c.style.fontSize=a.fontSize+"px":c.style.fontSize="17px",a.text?c.innerText=a.text:a.html&&(c.innerHTML=a.html),b.appendChild(c)}else a.element&&b.appendChild(a.element);return b.heading=a.heading||"",b.iconSrc=a.iconSrc||"",b.icon=a.icon||"",b.iconColor=a.iconColor||"",b.buttonLabelAccept=a.accept||"OK",b.buttonLabelDecline=a.decline||"","function"==typeof a.done&&$(b).on("done",function(b){a.done(b.originalEvent)}),$(b).one("closed",function(){AsyncHelper.async(function(){$(this).remove()}.bind(this.dialog)),"function"==typeof this.options.closed&&a.closed()}.bind({dialog:b,options:a})),AsyncHelper.async(b.open.bind(b)),$("body").append(b),b}}),FrameAPI=ITundraAPI.$extend({__init__:function(a,b,c){this.$super(a,b),this.currentWallClockTime=0,this.currentFrameNumber=0,this.delayedExecutes=[]},reset:function(){Tundra.events.remove("FrameAPI.Update"),Tundra.events.remove("FrameAPI.PostFrameUpdate")},_update:function(a){this.currentWallClockTime+=a,Tundra.events.send("FrameAPI.Update",a),this._updateDelayedExecutes(a),this.currentFrameNumber++,this.currentFrameNumber<0&&(this.currentFrameNumber=0)},_updateDelayedExecutes:function(a){if(0!==this.delayedExecutes.length)for(var b=0;b<this.delayedExecutes.length;++b)if(this.delayedExecutes[b].timeLeft-=a,this.delayedExecutes[b].timeLeft<=0){var c=this.delayedExecutes[b];this.delayedExecutes.splice(b,1),b--,this._postDelayedExecute(c)}},_postDelayedExecute:function(a){try{"function"!=typeof a.callback&&"function"==typeof a.context?a.context.call(a.context,a.param):a.callback.call(null!=a.context?a.context:a.callback,a.param)}catch(b){TundraLogging.getLogger("FrameAPI").error("Failed to invoke callback for delayed execute:",b)}},_preRender:function(a){Tundra.events.send("FrameAPI.PreRender",a)},_postUpdate:function(a){Tundra.events.send("FrameAPI.PostFrameUpdate",a)},wallClockTime:function(){return this.currentWallClockTime},frameNumber:function(){return this.currentFrameNumber},onUpdate:function(a,b){return Tundra.events.subscribe("FrameAPI.Update",a,b)},onPreRender:function(a,b){return Tundra.events.subscribe("FrameAPI.PreRender",a,b)},onPostFrameUpdate:function(a,b){return Tundra.events.subscribe("FrameAPI.PostFrameUpdate",a,b)},delayedExecute:function(a,b,c,d){return"number"!=typeof a?void TundraLogging.getLogger("FrameAPI").error("delayedExecute parameter 'afterSeconds' must be a number!"):void this.delayedExecutes.push({timeLeft:a,context:b,callback:c,param:"function"!=typeof c&&void 0===d?c:d})}}),LoginMessage=INetworkMessage.$extend({__init__:function(){this.$super(LoginMessage.id,"LoginMessage")},__classvars__:{id:100,name:"LoginMessage"},serialize:function(a){this.$super(4+DataSerializer.utf8StringByteSize(a)),this.ds.writeU16(this.id),this.ds.writeStringU16(a)}}),EC_Name=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"name","",Attribute.String),this.declareAttribute(1,"description","",Attribute.String),this.declareAttribute(2,"group","",Attribute.String)},__classvars__:{TypeId:26,TypeName:"Name"},onNameChanged:function(){return this.hasParentEntity()?Tundra.events.subscribe("EC_Name.NameChanged."+this.parentEntity.id+"."+this.id,context,callback):(this.log.error("Cannot subscribe onNameChanged, parent entity not set!"),null)},setName:function(a,b){if(a!==this.attributes.name.get()){var c=this.attributes.name.getClone();this.attributes.name.set(a,b),this.hasParentEntity()&&Tundra.events.send("EC_Name.NameChanged."+this.parentEntity.id+"."+this.id,a,c),this.hasParentScene()&&this.parentScene._onEntityNameChanged(this.parentEntity,a,c)}},getName:function(){return this.attributes.name.getClone()},setDescription:function(a,b){a!==this.attributes.description.get()&&this.attributes.description.set(a,b)},getDescription:function(){return this.attributes.description.getClone()},setGroup:function(a,b){a!==this.attributes.group.get()&&this.attributes.group.set(a,b)},getGroup:function(){return this.attributes.group.getClone()},update:function(){},attributeChanged:function(a,b,c){}});Scene.registerComponent(EC_Name);var EC_Script=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.startupApplication=!1,this.scriptsRequested=!1,this.scriptAsset=null,this.declareAttribute(0,"scriptRef",[],Attribute.AssetReferenceList),this.declareAttribute(1,"runOnLoad",!1,Attribute.Bool),this.declareAttribute(2,"runMode",EC_Script.RunMode.Both,Attribute.Int),this.declareAttribute(3,"applicationName","",Attribute.String),this.declareAttribute(4,"className","",Attribute.String)},__classvars__:{TypeId:5,TypeName:"Script",RunMode:{Both:0,Client:1,Server:2},nativeScriptReplacements:[],registerNativeScriptReplacement:function(a,b){var c="object"==typeof a?a:void 0;void 0===c&&(c={},c[a]=b);for(var d=Object.keys(c),e=0;e<d.length;e++){var f=d[e];void 0===this.getNativeScriptReplacement(f)?this.nativeScriptReplacements.push({keyword:f,replacement:c[f]}):console.error("[EC_Script]: Native script replacement '"+f+"' already registered")}},getNativeScriptReplacement:function(a){for(var b=0;b<this.nativeScriptReplacements.length;b++)if(this.nativeScriptReplacements[b].keyword.toLowerCase()===a.toLowerCase())return this.nativeScriptReplacements[b];return void 0},localScriptReplacement:[],registerLocalScriptReplacement:function(a,b){this.localScriptReplacement.push({keyword:a,replacement:b})}},reset:function(){null!=this.scriptAsset&&this.scriptAsset.stop(this.parentEntity,this),this.scriptAsset=null,this.appInstanceStartedSub&&(this.appInstanceStartedSub.reset(),this.appInstanceStartedSub=void 0)},onScriptLoaded:function(a,b){return this.hasParentEntity()?Tundra.events.subscribe("EC_Script."+this.parentEntity.id+"."+this.id+".ScriptLoaded",a,b):(this.log.error("Cannot subscribe onMeshLoaded, parent entity not set!"),null)},onScriptStarted:function(a,b,c){return this.hasParentEntity()?Tundra.events.subscribe("EC_Script."+this.parentEntity.id+"."+this.id+".ScriptStarted",a,b,c):(this.log.error("Cannot subscribe onMeshLoaded, parent entity not set!"),null)},_scriptLoaded:function(a){if(null==this.parentEntity)return void this.log.warn("_scriptLoaded with null Parent Entity");if(this.scriptAsset=a,Tundra.events.send("EC_Script."+this.parentEntity.id+"."+this.id+".ScriptLoaded",this.parentEntity,this,this.scriptAsset),!this.scriptAsset.running&&this.attributes.runOnLoad.get()){var b=this.scriptAsset.run(this.parentEntity,this,this.startupApplication);null!=b&&(this.appInstanceStartedSub&&this.appInstanceStartedSub.reset(),this.appInstanceStartedSub=b.onApplicationStarted(this,function(a,b){return null==this.parentEntity?void console.error("Dead script sent a ScriptStarted event",this):(this.appInstanceStartedSub&&(this.appInstanceStartedSub.reset(),this.appInstanceStartedSub=void 0),void Tundra.events.send("EC_Script."+this.parentEntity.id+"."+this.id+".ScriptStarted",this.parentEntity,this,this.scriptAsset,b))}))}},update:function(){if(!this.scriptsRequested){null!=this.scriptAsset&&this.scriptAsset.stop(this.parentEntity,this),this.scriptAsset=null;var a=this.attributes.scriptRef.getClone();if(0==a.length)return;if(void 0===a[0]||""===a[0])return;if(this.scriptsRequested=!0,this.attributes.runMode.get()===EC_Script.RunMode.Server)return void this.log.debug("Skipping loading and execution of Server only Tundra application '"+a[0]+"'");var b=a[0],c=b.substring(b.lastIndexOf(".")).toLowerCase(),d=!1,e=b.substring(b.lastIndexOf("/")+1);if(".webrocketjs"===c&&(d=!0),d)for(var f=0,g=EC_Script.localScriptReplacement.length;g>f;f++){var h=EC_Script.localScriptReplacement[f];if(-1!==e.toLowerCase().indexOf(h.keyword.toLowerCase())&&null!=h.replacement&&""!=h.replacement){var i=h.replacement.substring(h.replacement.lastIndexOf("/")+1);this.log.infoC("Replacing script '"+e+"' with registered local development script '"+i+"'"),b=h.replacement,d=!0;break}}else for(var f=0,g=EC_Script.nativeScriptReplacements.length;g>f;f++){var h=EC_Script.nativeScriptReplacements[f];if(-1!==e.toLowerCase().indexOf(h.keyword.toLowerCase())&&null!=h.replacement&&""!=h.replacement){var i=h.replacement.substring(h.replacement.lastIndexOf("/")+1);this.log.infoC("Replacing native Tundra script '"+e+"' with registered script '"+i+"'"),b=h.replacement,d=!0;break}}if(!d)return void this.log.debug("Skipping loading and execution of native Tundra application '"+e+"'");var j=Tundra.asset.requestAsset(b,"Script");null!=j&&j.onCompleted(this,this._scriptLoaded)}},attributeChanged:function(a,b,c){0===a?(this.scriptsRequested=!1,this.update()):1===a&&(null==this.scriptAsset||this.scriptAsset.running||c!==!0||this.scriptAsset.run(this.parentEntity,this,this.startupApplication))}});Scene.registerComponent(EC_Script);var EC_Avatar=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"appearanceRef","",Attribute.AssetReference),this.useAvatarAsset=!0,this.defaultAppearanceRef="http://meshmoon.data.s3.amazonaws.com/avatars/boy/boy.avatar",this.avatarAssets={"http://meshmoon.data.s3.amazonaws.com/avatars/man/man.avatar":{mesh:"http://meshmoon.data.s3.amazonaws.com/avatars/man/man.mesh",skeleton:"http://meshmoon.data.s3.amazonaws.com/avatars/man/man.skeleton",materials:["http://meshmoon.data.s3.amazonaws.com/avatars/man/man1.material"]},"http://meshmoon.data.s3.amazonaws.com/avatars/boy/boy.avatar":{mesh:"http://meshmoon.data.s3.amazonaws.com/avatars/boy/boy.mesh",skeleton:"http://meshmoon.data.s3.amazonaws.com/avatars/boy/boy.skeleton",materials:["http://meshmoon.data.s3.amazonaws.com/avatars/boy/boy1.material"]}},this.resetState()},__classvars__:{TypeId:1,
TypeName:"Avatar",MeshComponentName:"EC_Avatar_Generated_Mesh"},reset:function(){this.resetState()},resetState:function(){this.currentAppearanceRef="",this.avatarRequested=!1,this.attachementsRequested=!1,this.avatarApplied=!1,this.avatarDescAsset=null,null!=this.parentEntity&&this.parentEntity.removeComponentByName("Mesh",EC_Avatar.MeshComponentName)},attributeChanged:function(a,b,c){0===a&&this.update()},getAvatarData:function(){return this.avatarAssets[this.attributes.appearanceRef.get()]},getDefaultAvatarData:function(){return this.avatarAssets[this.defaultAppearanceRef]},getAvatarRotation:function(){var a=this.getAvatarData();return null!=a&&null!=a.rotation?a.rotation:0},onAvatarDescLoaded:function(a){this.avatarDescAsset=a.cloneInstance(),this.update()},onAvatarAttachementLoaded:function(a,b){for(var c=0;c<this.avatarDescAsset.attachements.length;c++)if(!this.avatarDescAsset.attachements[c].isLoaded())return;this.update()},update:function(){var a=this.attributes.appearanceRef.get();if(""!==a&&this.currentAppearanceRef!==a&&(""!==this.currentAppearanceRef&&this.currentAppearanceRef!==a&&this.resetState(),!this.avatarApplied)){if(this.useAvatarAsset){if(!this.avatarRequested){this.avatarRequested=!0;var b=Tundra.asset.requestAsset(a,"RealXtendAvatarDescription");return void(null!=b&&b.onCompleted(this,this.onAvatarDescLoaded))}if(null==this.avatarDescAsset)return;if(!this.attachementsRequested&&(this.attachementsRequested=!0,this.avatarDescAsset.attachements.length>0)){for(var c=0;c<this.avatarDescAsset.attachements.length;c++)this.avatarDescAsset.attachements[c].requestAssets(this,this.onAvatarAttachementLoaded);return}}var d=this.useAvatarAsset?void 0!==this.avatarDescAsset&&this.avatarDescAsset.assets:this.getAvatarData();null==d&&(this.log.warn("Avatar '"+this.attributes.appearanceRef.get()+"' not supported, using default."),d=this.getDefaultAvatarData()),this.parentEntity.removeComponentByName("Mesh",EC_Avatar.MeshComponentName);var e=this.parentEntity.createLocalComponent("Mesh",EC_Avatar.MeshComponentName);e.replicated=!1,e.local=!0,e.temporary=!0,e.meshRef=d.mesh,e.skeletonRef=d.skeleton,e.materialRefs=d.materials,e.castShadows=!0;var f=e.nodeTransformation;f.pos.y=-.86,f.rot.y=0,e.nodeTransformation=f,null!=this.avatarDescAsset&&this.avatarDescAsset.attachements.length>0&&e.setAttachements(this.avatarDescAsset.attachements),this.avatarApplied=!0,this.currentAppearanceRef=a,e.update()}}});Scene.registerComponent(EC_Avatar);var EC_DynamicComponent=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d)},__classvars__:{TypeId:25,TypeName:"DynamicComponent"},isDynamic:function(){return!0},hasAttribute:function(a){var b=this.getAttribute(a);return void 0!==b&&null!==b},createAttribute:function(a,b){if("string"==typeof a&&(a=Attribute.toTypeId(a)),void 0===a||null===a)return this.log.error("createAttribute: received invalid type name or id parameter."),!1;if(this.hasAttribute(b))return this.log.error("createAttribute: attribute with name '"+b+"' already exists!"),!1;for(var c=0;1e4>c&&void 0!==this.attributeIndexes[c];)c++;return this.declareAttribute(c,b,Attribute.defaultValueForType(a),a),this._attributeAdded(c),!0},removeAttribute:function(a){try{var b=void 0,c=void 0;if("string"==typeof a?b=a:"number"==typeof a&&(c=a,b=this.attributeIndexes[a]),void 0===b||null===b)return!1;var d=this.attributes[b];if(void 0===d||null===d)return!1;if(void 0===c&&(c=d.index),this._attributeAboutToBeRemoved(d),void 0!==this[b]){var e={};e[b]={get:function(){return void 0},set:function(a){},configurable:!0},Object.defineProperties(this,e)}return d._reset(),d=null,delete this.attributes[b],delete this.attributeIndexes[c],this.attributes[b]=void 0,this.attributeIndexes[c]=void 0,!0}catch(f){this.log.error("removeAttribute:",f)}return!1},onAttributeAdded:function(a,b){return this.hasParentEntity()?Tundra.events.subscribe("EC_DynamicComponent.AttributeAdded."+this.parentEntity.id+"."+this.id,a,b):(this.log.error("Cannot subscribe onAttributeAdded, no parent entity!"),null)},_attributeAdded:function(a){"number"==typeof a&&(a=this.attributeByIndex(a)),void 0!==a&&null!==a&&this.hasParentEntity()&&Tundra.events.send("EC_DynamicComponent.AttributeAdded."+this.parentEntity.id+"."+this.id,this,a)},onAttributeAboutToBeRemoved:function(a,b){return this.hasParentEntity()?Tundra.events.subscribe("EC_DynamicComponent.AttributeAboutToBeRemoved."+this.parentEntity.id+"."+this.id,a,b):(this.log.error("Cannot subscribe onAttributeAboutToBeRemoved, no parent entity!"),null)},_attributeAboutToBeRemoved:function(a){void 0!==a&&null!==a&&this.hasParentEntity()&&Tundra.events.send("EC_DynamicComponent.AttributeAboutToBeRemoved."+this.parentEntity.id+"."+this.id,this,a.index,a.name)}});Scene.registerComponent(EC_DynamicComponent);var EC_HtmlBillboard=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"position",new THREE.Vector3(0,0,0),Attribute.Float3),this.declareAttribute(1,"size",new THREE.Vector2(-1,-1),Attribute.Float2),this.declareAttribute(2,"hoverMagnify",!1,Attribute.Bool)},__classvars__:{TypeId:1e3,TypeName:"HtmlBillboard"}}),TundraClient=Class.$extend({__init__:function(a){if(Tundra.client=this,this.options=TundraClient.mergeOptions(a),Tundra.options=this.options.Tundra,this.log=TundraLogging.getLogger("WebRocket"),this.log.info(this.getVersion()),"number"==typeof this.options.TundraClient.loglevel&&(this.options.TundraClient.loglevel=TundraLogging.levelString(this.options.TundraClient.loglevel)),TundraLogging.setLevel(this.options.TundraClient.loglevel),this.log.debug("Created Tundra",Tundra.options),this.log.debug("Created TundraClient",this.options.TundraClient),Tundra.container=this.container=this.loadContainer(),this.APIs=[],Tundra.config=this.config=this.loadAPI("ConfigAPI",ConfigAPI),Tundra.events=this.events=this.loadAPI("EventAPI",EventAPI),Tundra.network=this.network=this.loadAPI("Network",Network),Tundra.frame=this.frame=this.loadAPI("FrameAPI",FrameAPI),Tundra.console=this.console=this.loadAPI("ConsoleAPI",ConsoleAPI),Tundra.asset=this.asset=this.loadAPI("AssetAPI",AssetAPI),Tundra.input=this.input=this.loadAPI("InputAPI",InputAPI),Tundra.ui=this.ui=this.loadAPI("UiAPI",UiAPI),Tundra.scene=this.scene=this.loadAPI("Scene",Scene),Tundra.renderer=this.renderer=this.loadRenderer(),this.domIntegration=null,this.loginProperties={},this.connectionId=0,this.reset(),this.initializeAPIs(),Tundra.loadPlugins(this.options.plugins),"object"==typeof this.renderer&&"function"==typeof this.renderer.postInitialize&&this.renderer.postInitialize(),this.postInitializeAPIs(),this.onUpdateInternal(),Object.keys(this.options.TundraClient.applications).length>0)for(var b in this.options.TundraClient.applications)this.runApplication(b,this.options.TundraClient.applications[b])},getVersion:function(){try{var a=[];"object"==typeof window.WebRocketVersion&&"string"==typeof window.WebRocketVersion.version?a.push("v"+window.WebRocketVersion.version+" ("+window.WebRocketVersion.commit+")"):a.push("Developer version"),"object"==typeof THREE&&void 0!==THREE.REVISION&&a.push("THREE "+THREE.REVISION),a.push(Tundra.browser.name()+" "+Tundra.browser.version()+(Tundra.browser.isMobile()?" [Mobile]":"")),this.version=a.join(" | ")}catch(b){this.version="Version detection failed: "+b}return this.version},loadAPI:function(a,b){var c=$.extend({},this.options[a]),d=new b(a,c,$.extend({},this.options));return this.APIs.push(d),this.log.debug("Created",d.name,Object.keys(d.options).length>0?d.options:""),d},initializeAPIs:function(){for(var a=0;a<this.APIs.length;a++)this.APIs[a]._initialize()},postInitializeAPIs:function(){for(var a=0;a<this.APIs.length;a++)this.APIs[a]._postInitialize()},loadContainer:function(){var a=null;return void 0===this.options.TundraClient.container||null===this.options.TundraClient.container?(a=$("<div/>"),a.attr("id","webrocket-container"),a.css({"background-color":"black",position:"absolute","z-index":0,top:0,left:0,padding:0,margin:0,width:"100%",height:"100%",overflow:"hidden"}),$("body").append(a)):a=$(this.options.TundraClient.container),a},loadRenderer:function(){var a=null;return"function"==typeof this.options.TundraClient.renderer?a=this.options.TundraClient.renderer.register(TundraClient):"string"==typeof a&&(a=TundraClient.getRenderSystemByName(a)),null==a&&TundraClient.renderSystems.length>0&&(a=TundraClient.renderSystems[0]),null!==a?(this.log.debug("Loading Renderer",this.options.Renderer),a._load($.extend({},this.options.Renderer))):this.log.error("Failed to load a render system. Registered:",TundraClient.renderSystems),a},reset:function(){this.websocket=null,this.websocketFaked=!1,this.loginProperties={},this.connectionId=0,this.authTokens={},"object"==typeof this.renderer&&"function"==typeof this.renderer.reset&&this.renderer.reset();for(var a=0;a<this.APIs.length;a++)this.APIs[a].reset();this.lastTime=performance.now(),this.cameraApplications=[],this.cameraApplicationIndex=0,this.cameraSwitcherButton=null,this.cameraSwitcherMenu=null},__classvars__:{domIntegrations:[],registerDomIntegration:function(a){return a instanceof IDomIntegration?TundraClient.domIntegrations.push(a):null!=console.error&&console.error("[WebRocket]: registerDomIntegration called with object that is not an instance of IDomIntegration!"),a instanceof IDomIntegration},renderSystems:[],registerRenderSystem:function(a){return a instanceof IRenderSystem?TundraClient.renderSystems.push(a):null!=console.error&&console.error("[WebRocket]: registerRenderSystem called with object that is not an instance of IRenderSystem!"),a instanceof IRenderSystem},getRenderSystemByName:function(a){for(var b=0;b<TundraClient.renderSystems.length;b++)if(TundraClient.renderSystems[b].name===a)return TundraClient.renderSystems[b];return TundraClient.log.error("getRenderSystemByName: Failed to find:",a),null},mergeOptions:function(a){a=a||{};var b=$.extend({},a);b.plugins||(b.plugins={}),a.plugins||(a.plugins={});for(var c=TundraClient.getDefaultOptions(),d=0,e=Tundra.APINames();d<e.length;d++)b[e[d]]=$.extend(!0,{},c[e[d]],a[e[d]]);for(var d=0,f=Tundra.pluginNames();d<f.length;d++)b.plugins[f[d]]=$.extend(!0,{},c.plugins[f[d]],a.plugins[f[d]]);"object"==typeof a.TundraClient&&"function"==typeof a.TundraClient.renderer&&"function"==typeof a.TundraClient.renderer.getDefaultOptions?b.Renderer=$.extend({},c.Renderer,a.TundraClient.renderer.getDefaultOptions(),a.Renderer):b.Renderer=$.extend({},c.Renderer,a.Renderer);var g=function(a,b,c){if(Array.isArray(c)){for(var d=0;d<c.length;d++)if(typeof a[b]===c[d])return!0;return!1}return"string"==typeof c?typeof a[b]===c:(console.error("Invalid options type check",a,b,c),!1)},h=function(a,b,c,d,e){d=d||b,c[d]=a[b],delete a[b],"string"==typeof e&&""!==e&&console.warn("DEPRECATED: TundraClient constructor option:",e)};return g(b,"polymer","boolean")&&h(b,"polymer",b.Tundra,"polymer","options.polymer > options.Tundra.polymer"),g(b,"requirejs","boolean")&&h(b,"requirejs",b.Tundra,"requirejs","options.requirejs > options.Tundra.requirejs"),g(b,"container",["string","object"])&&h(b,"container",b.TundraClient,"container","options.container > options.TundraClient.container"),g(b,"renderSystem",["string","object","function"])&&h(b,"renderSystem",b.TundraClient,"renderer","options.renderSystem > options.TundraClient.renderer"),g(b,"applications","object")&&h(b,"applications",b.TundraClient,"applications","options.applications > options.TundraClient.applications"),g(b,"loglevel",["string","number"])&&h(b,"loglevel",b.TundraClient,"loglevel","options.loglevel > options.TundraClient.loglevel"),"object"==typeof b.asset&&g(b.asset,"localStoragePath","string")&&(h(b.asset,"localStoragePath",b.AssetAPI.storages,"webrocket://",'options.asset.localStoragePath > options.AssetAPI.storages["webrocket://"]'),0===Object.keys(b.asset).length&&delete b.asset),g(b,"taskbar","boolean")&&h(b,"taskbar",b.UiAPI,"taskbar","options.taskbar > options.UiAPI.taskbar"),g(b,"console","boolean")&&h(b,"console",b.UiAPI,"console","options.console > options.UiAPI.console"),g(b,"allowFullscreen","boolean")&&h(b,"allowFullscreen",b.UiAPI,"allowFullscreen","options.allowFullscreen > options.UiAPI.allowFullscreen"),g(b,"showfps","boolean")&&h(b,"showfps",b.UiAPI,"fps","options.showfps > options.UiAPI.fps"),g(b,"networkDebugLogging","boolean")&&h(b,"networkDebugLogging",b.Network,"debug","options.networkDebugLogging > options.Network.debug"),b},getDefaultOptions:function(){for(var a={plugins:{}},b=0,c=Tundra.APINames();b<c.length;b++)a[c[b]]={};for(var b=0,d=Tundra.pluginNames();b<d.length;b++)a.plugins[d[b]]={};return $.extend(a.TundraClient,{loglevel:"info",container:null,renderer:null,applications:{}}),$.extend(a.Tundra,Tundra.getDefaultOptions()),$.extend(a.Network,Network.getDefaultOptions()),$.extend(a.UiAPI,UiAPI.getDefaultOptions()),$.extend(a.AssetAPI,AssetAPI.getDefaultOptions()),a.Renderer=IRenderSystem.getDefaultOptions(),a}},getDefaultOptions:function(){return TundraClient.getDefaultOptions()},setDomIntegration:function(a){void 0!==this.domIntegration&&null!==this.domIntegration&&this.domIntegration._unload(),this.domIntegration=a,this.domIntegration._load()},registerCameraApplication:function(a,b){if(!(b instanceof ICameraApplication))return void console.error("[WebRocket]: registerCameraApplication called with object that is not an instance of ICameraApplication!");for(var c=0;c<this.cameraApplications.length;c++)if(this.cameraApplications[c].name===a)return void console.error("[WebRocket]: Camera application '"+a+"' already registered!");if(this.cameraApplications.push({name:a,application:b}),!(this.cameraApplications.length<=1)){var d=this;if(null!=this.cameraSwitcherButton)return void this.ui.addContextMenuItems(this.cameraSwitcherMenu,{name:a,callback:function(){d.activateCameraApplication($(this).data("itemName"))}});this.cameraSwitcherButton=this.ui.addAction("Change Camera (shift+tab)","http://meshmoon.data.s3.amazonaws.com/icons/pictos1/24/209.png",40,!1),this.cameraSwitcherMenu=this.ui.addContextMenu(this.cameraSwitcherButton,!0,!0);for(var c=0;c<this.cameraApplications.length;c++)this.ui.addContextMenuItems(this.cameraSwitcherMenu,{name:this.cameraApplications[c].name,callback:function(){d.activateCameraApplication($(this).data("itemName"))}});this.input.onKeyPress(this,function(a){!a.originalEvent.shiftKey||9!==a.keyCode&&"tab"!==a.key||("body"===a.targetNodeName||"canvas"===a.targetNodeName)&&(this.cameraApplicationIndex++,this.cameraApplicationIndex>=this.cameraApplications.length&&(this.cameraApplicationIndex=0),this.activateCameraApplication(this.cameraApplications[this.cameraApplicationIndex].name),a.originalEvent.preventDefault())})}},activateCameraApplication:function(a){for(var b=0;b<this.cameraApplications.length;b++)if(this.cameraApplications[b].name===a)return this.cameraApplicationIndex=b,void this.cameraApplications[b].application._activateCameraApplication()},setAuthToken:function(a,b){this.authTokens[a]=b},getAuthToken:function(a){return this.authTokens[a]},runApplication:function(a,b){if(null==Scene.registeredComponent("Script"))return this.log.error("runApplication: Cannot run script '"+b+"', Script component not registered."),null;var c=this.scene.createLocalEntity(["Name","Script"]);return c.name=a||"Startup Application",c.script.startupApplication=!0,c.script.attributes.runMode.set(EC_Script.RunMode.Client,AttributeChange.LocalOnly),c.script.attributes.runOnLoad.set(!0,AttributeChange.LocalOnly),c.script.attributes.scriptRef.set([b],AttributeChange.LocalOnly),c},onConnected:function(a,b){return Tundra.events.subscribe("TundraClient.Connected",a,b)},onConnectionError:function(a,b){return Tundra.events.subscribe("TundraClient.ConnectionError",a,b)},onDisconnected:function(a,b){return Tundra.events.subscribe("TundraClient.Disconnected",a,b)},onLogInfo:function(a,b){return Tundra.events.subscribe("TundraClient.LogInfo",a,b)},onLogWarning:function(a,b){return Tundra.events.subscribe("TundraClient.LogWarning",a,b)},onLogError:function(a,b){return Tundra.events.subscribe("TundraClient.LogError",a,b)},onUpdateInternal:function(){var a=Tundra.client;requestAnimationFrame(a.onUpdateInternal);var b=performance.now(),c=b-a.lastTime;frametimeMsec=c,c/=1e3,a.lastTime=b,a.frame._update(c),a.asset.update(c),a.scene.update(c),a.frame._preRender(c),a.renderer.update(c,frametimeMsec),a.frame._postUpdate(c)},logInfo:function(a,b){(void 0===b||null==b)&&(b=!1),b&&null!=console.log&&console.log(a),Tundra.events.send("TundraClient.LogInfo",a)},logWarning:function(a,b){(void 0===b||null==b)&&(b=!1),b&&null!=console.warn&&console.warn(a),Tundra.events.send("TundraClient.LogWarning",a)},logError:function(a,b){(void 0===b||null==b)&&(b=!1),b&&null!=console.error&&console.error(a),Tundra.events.send("TundraClient.LogError",a)},isConnected:function(){return this.websocketFaked===!0?!0:this._isWebSocketConnected()},_isWebSocketConnected:function(){return null==this.websocket?!1:3!==this.websocket.readyState?!0:!1},connect:function(a,b){if("string"!=typeof a)return this.log.error("connect() called with non-string 'host'"),{success:!1,reason:"Host not a string"};a=a.trim(),CoreStringUtils.startsWith(a,"http://",!0)?a=a.substring(7):CoreStringUtils.startsWith(a,"https://",!0)&&(a=a.substring(8)),CoreStringUtils.startsWith(a,"ws://")||CoreStringUtils.startsWith(a,"wss://")||(a="ws://"+a);try{this.websocket=new WebSocket(a)}catch(c){return{success:!1,reason:"This browser does not support WebSocket connections"}}return this.websocket.binaryType="arraybuffer",this.websocket.onopen=this.onWebSocketConnectionOpened,this.websocket.onerror=this.onWebSocketConnectionError,this.websocket.onclose=this.onWebSocketConnectionClosed,this.websocket.onmessage=this.onWebSocketMessage,this.loginProperties=void 0!==b&&null!==b?b:{},{success:!0}},fakeConnectionState:function(){this.isConnected()||(this.websocketFaked=!0,this.events.send("TundraClient.Connected"))},disconnect:function(){null!=this.websocket?this.websocket.close():this.websocketFaked&&this.events.send("TundraClient.Disconnected",{}),this.reset()},onWebSocketConnectionOpened:function(a){var b=Tundra.client;b.log.infoC("Server connection established");var c=new LoginMessage;c.serialize(JSON.stringify(b.loginProperties)),Tundra.network.send(c,a),b.events.send("TundraClient.Connected")},onWebSocketConnectionError:function(a){var b=Tundra.client;b.log.errorC("Failed to connect to",a.target.url),b.events.send("TundraClient.ConnectionError",a)},onWebSocketConnectionClosed:function(a){var b=Tundra.client;b.log.infoC("Server connection disconnected"),b.events.send("TundraClient.Disconnected",a),b.reset()},onWebSocketMessage:function(a){var b=Tundra.client;"string"!=typeof a.data?(Tundra.client.network.receive(a.data),a.data=null):b.log.info("Server sent a unexpected string message '"+a.data+"'")}}),RaycastResult=Class.$extend({__init__:function(){this.entity=null,this.component=null,this.object=null,this.pos=new THREE.Vector3(0,0,0),this.submeshIndex=-1,this.indices=[],this.face=null,this.distance=-1,this.ray=new THREE.Ray,this.execution={error:"",screenPos:new THREE.Vector2(0,0),selectionLayer:-1},this._normal=new THREE.Vector3(0,0,0),this._normalQueried=!1,this._uv1=new THREE.Vector2(0,0),this._uv2=new THREE.Vector2(0,0),this._uv1Queried=!1,this._uv2Queried=!1},reset:function(){this.entity=null,this.component=null,this.object=null,this.pos.set(0,0,0),this.submeshIndex=-1,this.indices=[],this.face=null,this.distance=-1,this.ray.origin.set(0,0,0),this.ray.direction.set(0,0,0),this._normal.set(0,0,0),this._uv1.set(0,0),this._uv2.set(0,0),this._normalQueried=!1,this._uv1Queried=!1,this._uv2Queried=!1,this.execution.error="",this.execution.screenPos.set(0,0),this.execution.selectionLayer=-1},clone:function(){var a=new RaycastResult;return a.entity=this.entity,a.component=this.component,a.object=this.object,a.pos.copy(this.pos),a.submeshIndex=this.submeshIndex,a.indices=this.indices,a.face=this.face,a.distance=this.distance,a.ray.copy(this.ray),a._normal.copy(this._normal),a._uv1.copy(this._uv1),a._uv2.copy(this._uv2),this._normalQueried=this._normalQueried,this._uv1Queried=this._uv1Queried,this._uv2Queried=this._uv2Queried,a.execution.error=this.execution.error,a.execution.screenPos.copy(this.execution.screenPos),a.execution.selectionLayer=this.execution.selectionLayer,a},hasError:function(){return""!==this.execution.error},setError:function(a){this.execution.error=a},executionMatches:function(a,b,c){return this.execution.screenPos.x===a&&this.execution.screenPos.y===b&&this.execution.selectionLayer===c},setExecutionInfo:function(a,b,c){this.execution.screenPos.x=a,this.execution.screenPos.y=b,this.execution.selectionLayer=c},getNormal:function(){if(this._normalQueried)return this._normal;if(this._normalQueried=!0,!this.object||!this.object.geometry)return this._normal;if(this.object.geometry instanceof THREE.BufferGeometry&&3===this.indices.length){var a=this.object.geometry.getAttribute("normal");if(a&&a.array){this._normal.set(0,0,0);for(var b=new THREE.Vector3(0,0,0),c=0;3>c;c++){if(b.set(a.array[3*this.indices[c]],a.array[3*this.indices[c]+1],a.array[3*this.indices[c]+2]),"number"!=typeof b.x||isNaN(b.x)||"number"!=typeof b.y||isNaN(b.y)||"number"!=typeof b.z||isNaN(b.z))return this._normal;this._normal.add(b)}this._normal.divideScalar(3).normalize()}}else this.face&&this.face.normal instanceof THREE.Vector3&&this._normal.copy(this.face.normal);return this._normal},getUV:function(a){if(a="number"==typeof a?a:0,0>a||a>1)return console.warn("[RaycastResult]: UVs 0 or 1 are valid, given:",a),null;if(0===a&&this._uv1Queried)return this._uv1;if(1===a&&this._uv2Queried)return this._uv2;0===a?this._uv1Queried=!0:this._uv2Queried=!0;var b=0===a?this._uv1:this._uv2;if(!this.object||!this.object.geometry)return b;if(this.object.geometry instanceof THREE.BufferGeometry&&3===this.indices.length){var c=0===a?this.object.geometry.getAttribute("uv"):this.object.geometry.getAttribute("uv2");if(c&&c.array&&c.itemSize>=2){b.set(0,0);for(var d=new THREE.Vector2(0,0),a=0;3>a;a++){if(d.set(c.array[this.indices[a]*c.itemSize],c.array[this.indices[a]*c.itemSize+1]),"number"!=typeof d.x||isNaN(d.x)||"number"!=typeof d.y||isNaN(d.y))return b;b.add(d)}b.divideScalar(2)}}else if(this.face&&this.object.geometry instanceof THREE.Geometry){if(!Array.isArray(this.object.geometry.faceVertexUvs)||a>=this.object.geometry.faceVertexUvs.length)return b;var c=this.object.geometry.faceVertexUvs[a];if(Array.isArray(c)&&c.length>0){var e=c[this.face.a],f=c[this.face.b],g=c[this.face.c];if(e instanceof THREE.Vector2==!1||f instanceof THREE.Vector2==!1||g instanceof THREE.Vector2==!1)return b;b.add(e),b.add(f),b.add(g),b.divideScalar(2)}}return b}}),TransformInterpolator=Class.$extend({__init__:function(){this.jobs=[],this.serverUpdateInterval=.05,this.enabled=!0,this.transformCache=[],this.tempTransform=new Transform,this.rotation={q1:new THREE.Quaternion,q2:new THREE.Quaternion},Tundra.frame.onUpdate(this,this.onUpdate)},update:function(a,b,c,d){if(!d.interpolation.previous||a.local||b.local||!this.enabled)return void Tundra.client.renderer.updateSceneNode(c,d.interpolation.current);var e=this.serverUpdateInterval,f=this.end(a,b);void 0===f?Tundra.client.renderer.updateSceneNode(c,d.interpolation.current):e=.5*f.duration+5e-4*(performance.now()-f.timeStart);var g={target:b,start:this.getTransform(),end:this.getTransform(),timeStart:performance.now(),time:void 0!==f?0:e+1e-4,duration:e};g.start.copy(d.interpolation.previous),g.end.copy(d.interpolation.current),this.jobs.push(g)},getTransform:function(){return this.transformCache.length>0?this.transformCache.splice(0,1)[0]:new Transform},end:function(a,b){for(var c=this.jobs.length-1;c>=0;c--){var d=this.jobs[c];if(d.target.parentEntity.id===a.id&&d.target.id===b.id)return this.transformCache.length<=98&&(this.transformCache.push(d.end),this.transformCache.push(d.start)),this.jobs.splice(c,1)[0]}return void 0},onUpdate:function(a){for(var b=this.jobs.length-1;b>=0;b--){var c=this.jobs[b];if(c.time<c.duration){c.time+=a;var d=c.time/c.duration;d>1&&(d=1),this.tempTransform._pos.copy(c.start._pos).lerp(c.end._pos,d),this.tempTransform._scale.copy(c.start._scale).lerp(c.end._scale,d),c.start.orientation(this.rotation.q1),c.end.orientation(this.rotation.q2),this.rotation.q1.slerp(this.rotation.q2,d),this.tempTransform.setRotation(this.rotation.q1),Tundra.client.renderer.updateSceneNode(c.target.sceneNode,this.tempTransform)}else c.time+=a,c.time>=2*c.duration&&(this.transformCache.length<=98&&(this.transformCache.push(c.end),this.transformCache.push(c.start)),delete c,this.jobs.splice(b,1))}}}),EC_EnvironmentLight=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"sunColor",new Color(.639,.639,.639),Attribute.Color),this.declareAttribute(1,"ambientColor",Tundra.renderer.defaultSceneAmbientLightColor(),Attribute.Color),this.declareAttribute(2,"sunDirection",new THREE.Vector3(-1,-1,-1),Attribute.Float3),this.declareAttribute(3,"sunCastShadows",!0,Attribute.Bool),this.declareAttribute(4,"brightness",1,Attribute.Real)},__classvars__:{TypeId:8,TypeName:"EnvironmentLight"}}),EC_EnvironmentLight_ThreeJs=EC_EnvironmentLight.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.directionalLight=null,this.subs=[],this.raycastT=0,this.raycastInterval=.2},__classvars__:{Implementation:"three.js"},reset:function(){var a=Tundra.renderer;null!=this.directionalLight&&a.scene.remove(this.directionalLight),this.directionalLight=null,a.ambientLight.color=a.defaultSceneAmbientLightColor();for(var b=0;b<this.subs.length;b++)Tundra.events.unsubscribe(this.subs[b]);this.subs=[]},onActiveCameraChanged:function(a){null!=a&&null!=a.camera&&this.onUpdate()},onShadowSettingsChanged:function(a){null!=this.directionalLight&&(this.directionalLight.shadowMapWidth=a.textureSize.width,this.directionalLight.shadowMapHeight=a.textureSize.height,this.directionalLight.shadowCameraNear=a.clip.near,this.directionalLight.shadowCameraFar=a.clip.far,this.directionalLight.shadowCameraRight=a.bounds.right,this.directionalLight.shadowCameraLeft=a.bounds.left,this.directionalLight.shadowCameraTop=a.bounds.top,this.directionalLight.shadowCameraBottom=a.bounds.bottom,this.directionalLight.shadowCameraVisible=a.drawDebug)},onUpdate:function(a){if(this.raycastT+=a,!(this.raycastT<this.raycastInterval)&&(this.raycastT=0,null!=this.directionalLight)){var b=null,c=Tundra.renderer,d=c.raycast(c.windowSize.width/2,c.windowSize.height/2);if(null!=d.entity)b=d.pos;else{var e=c.activeCameraComponent;if(null==e||null==e.parentEntity||null==e.parentEntity.placeable)return;b=e.parentEntity.placeable.worldPosition()}this.directionalLight.target.position.copy(b.clone()),this.directionalLight.position.set(b.x+-100*this.sunDirection.x,b.y+-100*this.sunDirection.y,b.z+-100*this.sunDirection.z)}},update:function(){this.createLight(),Tundra.renderer.ambientLight.color=this.ambientColor.toThreeColor()},recreateLight:function(){this.reset(),this.update()},createLight:function(){if(null==this.directionalLight){var a=Tundra.renderer;this.directionalLight=a.createLight("directional"),this.directionalLight.color=this.sunColor.toThreeColor(),this.directionalLight.castShadow=this.sunCastShadows,this.directionalLight.intensity=this.brightness,this.onShadowSettingsChanged(a.shadowSettings),this.onActiveCameraChanged(a.activeCameraComponent),a.scene.add(this.directionalLight),a.shadowCastingLightsChanged(),0===this.subs.length&&(this.subs.push(a.onShadowSettingsChanged(this,this.recreateLight)),this.subs.push(a.onActiveCameraChanged(this,this.onActiveCameraChanged)),this.subs.push(Tundra.frame.onUpdate(this,this.onUpdate)))}},attributeChanged:function(a,b,c){if(null!=this.directionalLight)switch(a){case 0:this.directionalLight.color=c.toThreeColor();break;case 1:Tundra.renderer.ambientLight.color=c.toThreeColor();break;case 3:this.directionalLight.castShadow=this.sunCastShadows,Tundra.renderer.shadowCastingLightsChanged();break;case 4:this.directionalLight.intensity=c}}}),EC_Fog=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"mode",EC_Fog.Type.Linear,Attribute.Int),this.declareAttribute(1,"color",new Color(.707792,.770537,.831373,1),Attribute.Color),this.declareAttribute(2,"startDistance",100,Attribute.Real),this.declareAttribute(3,"endDistance",2e3,Attribute.Real),this.declareAttribute(4,"expDensity",.001,Attribute.Real)},__classvars__:{TypeId:9,TypeName:"Fog",Type:{NoFog:0,Exponentially:1,ExponentiallySquare:2,Linear:3}}}),EC_Fog_ThreeJs=EC_Fog.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this._activated=!1},__classvars__:{Implementation:"three.js"},reset:function(a){(this._activated||a===!0)&&(this._activated=!1,Tundra.renderer.scene.fog=null,Tundra.renderer.renderer.setClearColor(0),this._forceMaterialUpdates())},update:function(){return this._activated||null==Tundra.renderer.scene.fog?(this._forceMaterialUpdates(),void this._createFog(this.mode)):void this.log.warn("Fog is already set, only the first initialized fog will be enabled. Inactivating",this.toString())},_forceMaterialUpdates:function(){for(var a=Tundra.renderer.getAllMeshes(),b=0;b<a.length;b++)void 0!==a[b].material&&null!==a[b].material&&(a[b].material.needsUpdate=!0)},_createFog:function(a){return this.reset(!0),a===EC_Fog.Type.NoFog?void(this._activated=!0):(a===EC_Fog.Type.Linear?Tundra.renderer.scene.fog=new THREE.Fog(this.color.toThreeColor(),this.startDistance,this.endDistance):Tundra.renderer.scene.fog=new THREE.FogExp2(this.color.toThreeColor(),this.expDensity),this._activated=null!=Tundra.renderer.scene.fog,void(this._activated&&Tundra.renderer.renderer.setClearColor(Tundra.renderer.scene.fog.color)))},attributeChanged:function(a,b,c){this._activated&&(0===a?this._createFog(c):1===a?(Tundra.renderer.scene.fog.color=c.toThreeColor(),Tundra.renderer.renderer.setClearColor(Tundra.renderer.scene.fog.color)):2===a?Tundra.renderer.scene.fog.near=c:3===a?Tundra.renderer.scene.fog.far=c:4===a&&(Tundra.renderer.scene.fog.density=c))}}),EC_Sky=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),10===this.typeId&&(this.declareAttribute(0,"materialRef","",Attribute.AssetReference),this.declareAttribute(1,"textureRefs",[],Attribute.AssetReferenceList),this.declareAttribute(2,"distance",999,Attribute.Real),this.declareAttribute(3,"orientation",new THREE.Quaternion(0,0,0,1),Attribute.Quat),this.declareAttribute(4,"drawFirst",!0,Attribute.Bool),this.declareAttribute(5,"enabled",!0,Attribute.Bool))},__classvars__:{TypeId:10,TypeName:"Sky"}}),EC_Sky_ThreeJs=EC_Sky.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.skyBoxMesh=null,this.skyBoxMaterial=null,this.skyBoxTexture=null,this.directionLight=null,this.skyLoaded=!1,this.skipLoading=!1,this.texturesRequested=!1,this.texturesLoaded=!1,this.textures=[]},__classvars__:{Implementation:"three.js"},reset:function(){if(null!=this.skyBoxMesh&&(null!=this.skyBoxMesh.geometry&&(this.skyBoxMesh.geometry.dispose(),this.skyBoxMesh.geometry=null),Tundra.renderer.scene.remove(this.skyBoxMesh),this.skyBoxMesh=null),null!=this.directionLight&&(Tundra.renderer.scene.remove(this.directionLight),this.directionLight=null),null!=this.skyBoxTexture&&(this.skyBoxTexture.dispose(),this.skyBoxTexture=null),null!=this.skyBoxMaterial){for(var a=0;a<this.skyBoxMaterial.materials.length;a++)this.skyBoxMaterial.materials[a].dispose();this.skyBoxMaterial.materials=[],this.skyBoxMaterial=null}this.envLightChecked=!1,this.skyLoaded=!1,this.skipLoading=!1,this.texturesRequested=!1,this.texturesLoaded=!1,this.textures=[],void 0!==this.frameUpdateSubscription&&(Tundra.events.unsubscribe(this.frameUpdateSubscription),this.frameUpdateSubscription=void 0)},setParent:function(a){this.$super(a),this.update()},checkExistingSky:function(){if(null==this.parentEntity||null==this.parentEntity.parentScene)return!1;for(var a=this.parentEntity.parentScene.components("Sky"),b=0;b<a.length;b++)if(a[b].skyLoaded===!0)return!0;
a=this.parentEntity.parentScene.components("SkyX");for(var b=0;b<a.length;b++)if(a[b].skyLoaded===!0)return!0;a=this.parentEntity.parentScene.components("MeshmoonSky");for(var b=0;b<a.length;b++)if(a[b].skyLoaded===!0)return!0;return!1},update:function(){if(null!=this.parentEntity&&null!=this.parentEntity.parentScene&&!this.skyLoaded&&!this.skipLoading){if(this.skipLoading=this.checkExistingSky(),this.skipLoading)return void console.log("Skipping loading of "+this.typeName+", scene already has a sky component");if(this.envLightChecked||(Tundra.frame.delayedExecute(1,this,function(){if(null!=this.parentScene){var a=this.parentScene.entitiesWithComponent("EnvironmentLight");if(0===a.length){var b=this.parentEntity.createComponent("EnvironmentLight","EC_Sky Created Light",AttributeChange.LocalOnly);null!=b&&(b.brightness=.5,b.sunDirection=new THREE.Vector3(-.5,-1,-.5))}}}),this.envLightChecked=!0),!this.texturesRequested){for(var a="http://meshmoon.data.s3.amazonaws.com/asset-library/skybox/default/rex_sky_",b=[a+"right.dds",a+"left.dds",a+"bot.dds",a+"top.dds",a+"front.dds",a+"back.dds"],c=0;c<b.length;++c){var d=Tundra.asset.requestAsset(b[c]);null!=d&&d.onCompleted(this,this.onSkyTextureLoaded,c)}this.texturesRequested=!0}if(this.texturesLoaded){if(void 0===this.frameUpdateSubscription&&(this.frameUpdateSubscription=Tundra.frame.onPreRender(this,this.onPreRender)),null==this.skyBoxMaterial){for(var e=[],c=0;c<this.textures.length;++c){var f=this.textures[c].texture;f.wrapS=THREE.ClampToEdgeWrapping,f.wrapT=THREE.ClampToEdgeWrapping,f.needsUpdate=!0,e.push(new THREE.MeshBasicMaterial({map:f,side:THREE.BackSide,depthWrite:!1}))}this.skyBoxMaterial=new THREE.MeshFaceMaterial(e)}null==this.skyBoxMesh&&(this.skyBoxMesh=new THREE.Mesh(new THREE.BoxGeometry(2500,2500,2500,1,1,1),this.skyBoxMaterial),this.skyBoxMesh.scale.set(2,2,2),this.skyBoxMesh.renderDepth=-1e5,this.skyBoxMesh.quaternion.setFromEuler(new THREE.Euler(Math.PI,0,0)),this.skyBoxMesh.name=this.typeName+"-mesh",Tundra.renderer.scene.add(this.skyBoxMesh)),this.skyLoaded=!0;for(var g=this.parentEntity.parentScene.components("WaterPlane"),c=0;c<g.length;c++)g[c].waterLoaded===!0&&null!=g[c].waterMaterial&&(g[c].waterMaterial.needsUpdate=!0);g=this.parentEntity.parentScene.components("HydraX");for(var c=0;c<g.length;c++)g[c].waterLoaded===!0&&null!=g[c].waterMaterial&&(g[c].waterMaterial.needsUpdate=!0)}}},onSkyTextureLoaded:function(a,b){this.textures[b]=a;for(var c=0;6>c;c++)if(void 0===this.textures[c]||null===this.textures[c])return;this.texturesLoaded=!0,this.update()},onPreRender:function(){if(null!=this.skyBoxMesh){var a=Tundra.renderer.activeCameraEntity(),b=a&&a.placeable?a.placeable.worldPosition():void 0;b&&(this.skyBoxMesh.position.x=b.x,this.skyBoxMesh.position.y=b.y,this.skyBoxMesh.position.z=b.z,this.skyBoxMesh.updateMatrixWorld())}}}),EC_SkyX_ThreeJs=EC_Sky_ThreeJs.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d)},__classvars__:{TypeId:38,TypeName:"SkyX",Implementation:"three.js"}}),EC_WaterPlane=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"xSize",5e3,Attribute.Int),this.declareAttribute(1,"ySize",5e3,Attribute.Int),this.declareAttribute(2,"depth",1e4,Attribute.Int),this.declareAttribute(3,"position",new THREE.Vector3(0,0,0),Attribute.Float3),this.declareAttribute(4,"rotation",new THREE.Quaternion(0,0,0,1),Attribute.Quat),this.declareAttribute(5,"scaleUfactor",2e-4,Attribute.Real),this.declareAttribute(6,"scaleVfactor",2e-4,Attribute.Real),this.declareAttribute(7,"xSegments",10,Attribute.Int),this.declareAttribute(8,"ySegments",10,Attribute.Int),this.declareAttribute(9,"materialName","",Attribute.String),this.declareAttribute(10,"materialRef","",Attribute.AssetReference),this.declareAttribute(11,"fogColor",new Color(.2,.4,.35),Attribute.Color),this.declareAttribute(12,"fogStartDistance",100,Attribute.Real),this.declareAttribute(13,"fogEndDistance",2e3,Attribute.Real),this.declareAttribute(14,"fogMode",EC_WaterPlane.FogMode.Linear,Attribute.Int),this.declareAttribute(15,"fogExpDensity",999,Attribute.Real)},__classvars__:{TypeId:12,TypeName:"WaterPlane",FogMode:{NoFog:0,Exponential:1,ExponentiallySquare:2,Linear:3}}}),EC_WaterPlane_ThreeJs=EC_WaterPlane.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.waterMesh=null,this.waterMaterial=null,this.waterLoaded=!1,this.skipLoading=!1,this.forwardMovement=!0,this.forwardPosition=!0},create:function(){EC_WaterPlane_ThreeJs.createWater(this)},reset:function(){EC_WaterPlane_ThreeJs.resetWater(this)},attributeChanged:function(a,b,c){3===a?EC_WaterPlane_ThreeJs.updateWaterPosition(this):(0==a||1==a||7==a||8==a)&&(EC_WaterPlane_ThreeJs.resetWater(this),EC_WaterPlane_ThreeJs.createWater(this))},update:function(){this.create(),EC_WaterPlane_ThreeJs.updateWater(this)},__classvars__:{Implementation:"three.js",waterNodeScale:new THREE.Vector3(1,1,1),waterNodeRotation:new THREE.Vector3(-90,0,0),createWater:function(a){void 0===a._renderer&&(a._renderer=Tundra.client.renderer.renderer),void 0===a._camera&&(a._camera=Tundra.client.renderer.camera),void 0===a._scene&&(a._scene=Tundra.client.renderer.scene);var b=new THREE.Vector3(0,0,-1),c=16777215,d=Tundra.scene.entitiesWithComponent("EnvironmentLight");if(d.length>0){var e=d[0];b.copy(e.environmentLight.sunDirection),c=e.environmentLight.sunColor.toHex()}a.water=new THREE.Water(a._renderer,a._camera,a._scene,{textureWidth:1024,textureHeight:1024,clipBias:.03,sunDirection:b,sunColor:c,distortionScale:10}),a.waterMaterial=a.water.material;var f=Tundra.asset.requestAsset("webrocket://media/textures/waternormals.dds");f.onCompleted(a,function(a){this.waterMaterial.uniforms.normalSampler.value=this.waterMaterial.normalSampler=a.texture,this.waterMaterial.needsUpdate=!0}),a.waterMesh=new THREE.Mesh(new THREE.PlaneGeometry(a.xSize,a.ySize,a.xSegments,a.ySegments),a.waterMaterial),a.waterMesh.add(a.water),EC_WaterPlane_ThreeJs.attachWater(a),EC_WaterPlane_ThreeJs.updateWaterPosition(a)},attachWater:function(a){void 0===a.parentingSubs&&(a.parentingSubs={});var b=a.waterMesh.parent;if(void 0!==b&&null!==b&&b.remove(a.waterMesh),"MeshmoonWater"!==a.typeName&&null!=a.parentEntity){if(null!=a.parentEntity.placeable)return a.parentEntity.placeable.addChild(a.waterMesh),void(void 0===a.parentingSubs.onAboutToBeDestroyed&&(a.parentingSubs.onAboutToBeDestroyed=a.parentEntity.placeable.onAboutToBeDestroyed(a,EC_WaterPlane_ThreeJs._onParentPlaceableAboutToBeDestroyed)));a.parentingSubs.onComponentCreated=a.parentEntity.onComponentCreated(a,EC_WaterPlane_ThreeJs._onParentComponentCreated)}a._scene.add(a.waterMesh)},_onParentComponentCreated:function(a,b){if("Placeable"===b.typeName){var c=this.waterMesh.parent;void 0!==c&&null!==c&&c.remove(this.waterMesh),b.addChild(this.waterMesh),void 0===this.parentingSubs.onAboutToBeDestroyed&&(this.parentingSubs.onAboutToBeDestroyed=b.onAboutToBeDestroyed(this,EC_WaterPlane_ThreeJs._onParentPlaceableAboutToBeDestroyed))}},_onParentPlaceableAboutToBeDestroyed:function(){var a=this.waterMesh.parent;void 0!==a&&null!==a&&a.remove(this.waterMesh),this._scene.add(this.waterMesh),EC_WaterPlane_ThreeJs.updateWaterPosition(this)},resetWater:function(a){if(void 0!==a.parentingSubs)for(var b in a.parentingSubs){var c=a.parentingSubs[b];void 0!==c&&Tundra.events.unsubscribe(c)}if(null!=a.waterMesh){null!=a.waterMesh.geometry&&(a.waterMesh.geometry.dispose(),a.waterMesh.geometry=null);var d=a.waterMesh.parent;void 0!==d&&null!==d&&d.remove(a.waterMesh),a.waterMesh=null}null!=a.directionLight&&(Tundra.renderer.scene.remove(a.directionLight),a.directionLight=null),null!=a.skyBoxTexture&&(a.skyBoxTexture.dispose(),a.skyBoxTexture=null),null!=a.waterMaterial&&void 0!=a.waterMaterial&&(a.waterMaterial=null),a.waterLoaded=!1,a.skipLoading=!1},updateWater:function(a){if(null!=a.parentEntity&&null!=a.parentEntity.parentScene&&!a.waterLoaded&&!a.skipLoading){if(a.skipLoading=EC_WaterPlane_ThreeJs.checkExistingWater(a),a.skipLoading)return Tundra.client.logWarning("Skipping loading of "+a.typeName+", scene already has a loaded water component.",!0),void a.reset();Tundra.frame.onUpdate(a,EC_WaterPlane_ThreeJs.onUpdate),a.waterLoaded=!0}},updateWaterPosition:function(a){if(null!=a.waterMesh){var b=new THREE.Vector3(0,0,0);"MeshmoonWater"===a.typeName?b.y=a.seaLevel:b.copy(a.position),Tundra.renderer.updateSceneNode(a.waterMesh,new Transform(b,EC_WaterPlane_ThreeJs.waterNodeRotation,EC_WaterPlane_ThreeJs.waterNodeScale))}},onUpdate:function(a){0!=this.waterLoaded&&(null!=this.waterMaterial&&(this.waterMaterial.uniforms.time.value+=a/20),null!=this.water&&"function"==typeof this.water.render&&this.water.render(Tundra.renderer.activeCamera()))},checkExistingWater:function(a){if(null==a.parentEntity||null==a.parentEntity.parentScene)return!1;for(var b=a.parentEntity.parentScene.components("WaterPlane"),c=0;c<b.length;c++)if(b[c].waterLoaded===!0)return!0;b=a.parentEntity.parentScene.components("HydraX");for(var c=0;c<b.length;c++)if(b[c].waterLoaded===!0)return!0;return!1}}}),EC_Hydrax=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"configRef","",Attribute.AssetReference),this.declareAttribute(1,"visible",!0,Attribute.Bool),this.declareAttribute(2,"position",new THREE.Vector3(0,0,0),Attribute.Float3)},__classvars__:{TypeId:39,TypeName:"Hydrax"}}),EC_Hydrax_ThreeJs=EC_Hydrax.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.waterMesh=null,this.waterMaterial=null,this.waterLoaded=!1,this.skipLoading=!1,this.forwardMovement=!0,this.forwardPosition=!0,this.xSize=5e3,this.ySize=5e3,this.xSegments=10,this.ySegments=10},__classvars__:{Implementation:"three.js"},reset:function(){EC_WaterPlane_ThreeJs.resetWater(this)},update:function(){EC_WaterPlane_ThreeJs.createWater(this),EC_WaterPlane_ThreeJs.updateWater(this),null!=this.waterMesh&&(this.waterMesh.visible=this.attributes.visible.get())},attributeChanged:function(a,b,c){1===a?null!=this.waterMesh&&(this.waterMesh.visible=c):2===a&&EC_WaterPlane_ThreeJs.updateWaterPosition(this)}}),FrameLimiter=Class.$extend({__init__:function(a){this.step="number"==typeof a?a:0,this.t=0,this.steps=0,this.fps=0},shouldUpdate:function(a){return this.steps++,this.t+=a,this.t>=this.step?(this.fps=this.steps/this.t,this.steps=0,this.t=this.t%this.step,!0):!1}});Tundra.Classes.FrameLimiter=FrameLimiter;var EC_AnimationController=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"animationState","",Attribute.String),this.declareAttribute(1,"drawDebug",!1,Attribute.Bool)},__classvars__:{TypeId:14,TypeName:"AnimationController"}}),AnimationBlender=Class.$extend({__init__:function(){this.schedule=[],this.sub=Tundra.frame.onUpdate(this,this.onUpdate)},__classvars__:{WeightZero:0,WeightOne:1},reset:function(){this.stop(),Tundra.events.unsubscribe(this.sub)},getScheduled:function(a){for(var b=0;b<this.schedule.length;b++)if(this.schedule[b].animation.name===a)return this.schedule[b];return null},_schedule:function(a,b,c,d){var e=this.getScheduled(a.name);null==e?(e={animation:a,start:b},this.schedule.push(e)):e.start=a.weight,e.end=c,e.duration=d,e.t=0,a.loop===!1&&void 0!==a.data&&e.duration>a.data.length&&(e.duration=a.data.length)},crossfade:function(a,b,c){c="number"==typeof c?c:.5,null!==a&&void 0!==a&&a.isPlaying===!0&&this._schedule(a,a.weight,AnimationBlender.WeightZero,c),this._schedule(b,AnimationBlender.WeightZero,AnimationBlender.WeightOne,c)},stop:function(a){if("string"==typeof a){for(var b=0;b<this.schedule.length;b++)if(this.schedule[b].animation.name===a){this.schedule[b].animation.stop(),this.schedule.splice(b,1);break}}else{for(var b=0;b<this.schedule.length;b++)this.schedule[b].animation.stop();this.schedule=[]}},onUpdate:function(a){for(var b=this.schedule.length-1;b>=0;b--){var c=this.schedule[b];c.t+=a,c.t>=c.duration?(this.schedule.splice(b,1),c.animation.weight=c.end,c.animation.weight<=0&&c.animation.stop()):c.animation.weight=c.start+(c.end-c.start)*c.t/c.duration}}}),EC_AnimationController_ThreeJs=EC_AnimationController.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.updateSkeleton=new FrameLimiter(1/30),this.updateSkeleton.sub=null,this.blender=new AnimationBlender,this.currentAnimation=null,this.skeletonHelper=null,this.subs={}},__classvars__:{Implementation:"three.js"},reset:function(){this.removeSkeletonHelper(),this.unsub(!0),this.blender.reset()},playAnimation:function(a,b,c,d){b="boolean"==typeof b?b:!1,c="number"==typeof c?c:1;var e=this.getSkeletonAsset();if(null==e)return void this.log.warn("playAnimation could not find valid skeleton from Mesh component in Entity '"+(this.parentEntity?this.parentEntity.toString():"")+"'");var f=e.getAnimation(a);null!=f?(f.timeScale=8e-4*c,f.loop=b,"number"==typeof d?this.blender.crossfade(this.currentAnimation,f,d):null!=this.currentAnimation&&this.currentAnimation.stop(),f.play(),this.currentAnimation=f):this.log.error("Could not find animation",a,"for playback in",e.originalName(),". See EC_AnimationController.getAvailableAnimations().")},getAvailableAnimations:function(){var a=this.getSkeletonAsset();return null!=a?a.getAvailableAnimations():[]},getSkeletonAsset:function(){return null!=this.parentEntity&&null!=this.parentEntity.mesh&&null!=this.parentEntity.mesh.skeletonAsset?this.parentEntity.mesh.skeletonAsset:null},hookSkeletonCreated:function(){return null==this.parentEntity?void this.log.error("Parent Entity is not present!"):null==this.parentEntity.mesh?void(void 0===this.subs.onComponentCreated&&(this.subs.onComponentCreated=this.parentEntity.onComponentCreated(this,this.onComponentCreated))):(this.unsub("onComponentCreated"),null==this.parentEntity.mesh.skeletonAsset?void(void 0===this.subs.onSkeletonLoaded&&(this.subs.onSkeletonLoaded=this.parentEntity.mesh.onSkeletonLoaded(this,this.onSkeletonLoaded))):(this.unsub("onSkeletonLoaded"),void(this.drawDebug===!0&&this.createSkeletonHelper())))},unsub:function(a){if("string"==typeof a){var b=this.subs[a];void 0!==b&&(Tundra.events.unsubscribe(b),this.subs[a]=void 0)}else if("boolean"==typeof a&&a===!0){for(var c=Object.keys(this.subs),d=0;d<c.length;d++)Tundra.events.unsubscribe(this.subs[c[d]]);this.subs={}}},onComponentCreated:function(a,b){"Mesh"===b.typeName&&this.hookSkeletonCreated()},onSkeletonLoaded:function(a,b,c){this.hookSkeletonCreated()},createSkeletonHelper:function(){if(null==this.skeletonHelper||null==this.skeletonHelper.parent){var a=this.getSkeletonAsset();if(null==a)return void this.hookSkeletonCreated();if(null==a.skin)return void this.log.error("OgreSkeletonAsset.skin not defined but asset is loaded!");null==this.skeletonHelper&&(this.skeletonHelper=new THREE.SkeletonHelper(a.getSkeletonParent()),this.skeletonHelper.material.linewidth=3),null==this.skeletonHelper.parent&&a.getSkeletonParent().add(this.skeletonHelper),null==this.updateSkeleton.sub&&(this.updateSkeleton.sub=Tundra.frame.onUpdate(this,this.onUpdate)),this.unsub(!0)}},removeSkeletonHelper:function(){if(this.unsub(!0),null!=this.updateSkeleton.sub&&(Tundra.events.unsubscribe(this.updateSkeleton.sub),this.updateSkeleton.sub=null),null!=this.skeletonHelper){var a=this.skeletonHelper.parent;null!=a&&a.remove(this.skeletonHelper),null!=this.skeletonHelper.geometry&&this.skeletonHelper.geometry.dispose(),this.skeletonHelper=null}},update:function(){this.drawDebug===!0?this.createSkeletonHelper():this.removeSkeletonHelper()},onUpdate:function(a){null!=this.skeletonHelper&&this.updateSkeleton.shouldUpdate(a)&&this.skeletonHelper.update()},attributeChanged:function(a,b,c){1===a&&this.update()}}),EC_Camera=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"upVector",new THREE.Vector3(0,1,0),Attribute.Float3),this.declareAttribute(1,"nearPlane",.1,Attribute.Real),this.declareAttribute(2,"farPlane",Tundra.browser.isMobile()?3e3:5e3,Attribute.Real),this.declareAttribute(3,"verticalFov",45,Attribute.Real),this.declareAttribute(4,"aspectRatio","",Attribute.String)},__classvars__:{TypeId:15,TypeName:"Camera"}}),EC_Camera_ThreeJs=EC_Camera.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.camera=void 0,this._active=!1,Object.defineProperties(this,{active:{get:function(){return this.isActive()},set:function(a){this.setActive(a)}}}),this._windowSizeSub=Tundra.ui.onWindowResize(this,this.onWindowResize)},__classvars__:{Implementation:"three.js"},getWorldFocusPosition:function(){return null==this.parentEntity||null==this.parentEntity.placeable?null:this.parentEntity.placeable.worldPosition()},update:function(){void 0===this.camera?this.camera=new THREE.PerspectiveCamera(this.verticalFov,this.aspectRatio(),this.nearPlane,this.farPlane):(this.camera.fov=this.verticalFov,this.camera.aspect=this.aspectRatio(),this.camera.near=this.nearPlane,this.camera.far=this.farPlane,this.camera.updateProjectionMatrix()),null==this.camera.parent&&null!=this.parentEntity&&(null!=this.parentEntity.placeable?this.parentEntity.placeable.addChild(this.camera):this._componentAddedSub=this.parentEntity.onComponentCreated(this,this._onParentEntityComponentCreated))},reset:function(){this.active&&Tundra.renderer.setActiveCamera(null),this._componentAddedSub&&(this._componentAddedSub.reset(),this._componentAddedSub=void 0),this._windowSizeSub&&(this._windowSizeSub.reset(),this._windowSizeSub=void 0)},_onParentEntityComponentCreated:function(a,b){null!=b&&"Placeable"===b.typeName&&(this._componentAddedSub&&(this._componentAddedSub.reset(),this._componentAddedSub=void 0),null!=this.camera&&null==this.camera.parent&&b.addChild(this.camera))},onActiveStateChanged:function(a,b){return this.hasParentEntity()?Tundra.events.subscribe("EC_Camera.ActiveStateChanged."+this.parentEntity.id+"."+this.id,a,b):(Tundra.client.logError("[EC_Camera]: Cannot subscribe onActiveStateChanged, parent entity not set!",!0),null)},_postActiveStateChanged:function(a){Tundra.events.send("EC_Camera.ActiveStateChanged."+this.parentEntity.id+"."+this.id,this.parentEntity,this,a)},setActive:function(a){if(void 0===a&&(a=!0),"boolean"==typeof a&&this._active!==a){if(a&&Tundra.renderer.activeCamera()&&Tundra.renderer.activeCamera()._animating===!0)return void this.log.warn("Current camera is animating, cannot activate "+this.parentEntity.name);this._active=a,this._active&&Tundra.renderer.setActiveCamera(this),this._postActiveStateChanged(this._active)}},isActive:function(){return this._active},attributeChanged:function(a,b,c){this.update()},aspectRatio:function(){var a=Tundra.renderer.windowSize;return void 0!==a&&0!==a.height?a.width/a.height:0},onWindowResize:function(a,b){void 0!==this.camera&&(this.camera.aspect=a/b,this.camera.updateProjectionMatrix())}}),EC_Light=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"type",EC_Light.Type.PointLight,Attribute.Int),this.declareAttribute(1,"diffColor",new Color(1,1,1),Attribute.Color),this.declareAttribute(2,"specColor",new Color(0,0,0),Attribute.Color),this.declareAttribute(3,"castShadows",!1,Attribute.Bool),this.declareAttribute(4,"range",25,Attribute.Real),this.declareAttribute(5,"brightness",1,Attribute.Real),this.declareAttribute(6,"constAtten",0,Attribute.Real),this.declareAttribute(7,"linearAtten",.01,Attribute.Real),this.declareAttribute(8,"quadraAtten",.01,Attribute.Real),this.declareAttribute(9,"innerAngle",30,Attribute.Real),this.declareAttribute(10,"outerAngle",40,Attribute.Real)},__classvars__:{TypeId:16,TypeName:"Light",Type:{PointLight:0,SpotLight:1,DirectionalLight:2,AmbientLight:3},typeToString:function(a){return CoreStringUtils.enumToString(EC_Light.Type,a,void 0)}}}),EC_Light_ThreeJs=EC_Light.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.lightNode=null,this.lightDebugger=null,this._parentingSub=null},__classvars__:{Implementation:"three.js",DrawDebug:!1,createLight:function(a,b,c,d){void 0!==b&&("string"==typeof b&&(b=Color.fromString(b)),b instanceof Color&&(b=b.toThreeColor())),(void 0===c||null===c)&&(c=1),(void 0===d||null===d)&&(d=0),0>c&&(c=0),0>=d&&(d=0);var e=null;return a===EC_Light.Type.PointLight?e=new THREE.PointLight(b,c,d):a===EC_Light.Type.SpotLight?e=new THREE.SpotLight(b,c,d,!0):a===EC_Light.Type.DirectionalLight?e=new THREE.DirectionalLight(b,c,d):a===EC_Light.Type.AmbientLight?e=new THREE.AmbientLight(b):console.error("[EC_Light]: createLight(): Invalid EC_Light.Type!"),null!=e&&(e.matrixAutoUpdate=!1),e},createLightDebugger:function(a){if(null!=a.lightNode){var b=null;return a.lightNode instanceof THREE.PointLight?b=new THREE.PointLightHelper(a.lightNode,a.lightNode.distance):a.lightNode instanceof THREE.SpotLight?b=new THREE.SpotLightHelper(a.lightNode):a.lightNode instanceof THREE.DirectionalLight&&(b=new THREE.DirectionalLightHelper(a.lightNode,5,5)),b}}},reset:function(){this.destroy()},update:function(){this.create()},attributeChanged:function(a,b,c){if(0===a)this.destroy(),this.create();else if(1===a&&null!=this.lightNode)this.lightNode.color=c.toThreeColor(),this._updateDebugger(b);else if(4===a&&null!=this.lightNode)this.lightNode.distance=c>=1?c:1,this._updateDebugger(b);else if(5===a&&null!=this.lightNode)this.lightNode.intensity=c>=0?c:0,this._updateDebugger(b);else if(9===a&&null!=this.lightNode){var d=.5*THREE.Math.degToRad(c);this.lightNode.angle=d,this._updateDebugger(b)}else if(10===a&&null!=this.lightNode){var d=.5*THREE.Math.degToRad(c);this.lightNode.exponent=Math.cos(d),this._updateDebugger(b)}},create:function(){if(null==this.lightNode){if(this.lightNode=EC_Light_ThreeJs.createLight(this.type,this.diffColor,this.brightness,this.range),this.type===EC_Light.Type.SpotLight){var a=.5*THREE.Math.degToRad(this.innerAngle);this.lightNode.angle=a,a=.5*THREE.Math.degToRad(this.outerAngle),this.lightNode.exponent=Math.cos(a)}this._parentLight()}},destroy:function(){this._destroyDebugger(),null!=this.lightNode&&null!=this.lightNode.parent&&this.lightNode.parent.remove(this.lightNode),null!=this._parentingSub&&Tundra.events.unsubscribe(this._parentingSub),this.lightNode=null,this._parentingSub=null},_updateDebugger:function(a){if(EC_Light_ThreeJs.DrawDebug===!0&&null!=this.lightNode&&null!=this.lightNode.parent){var b=!1;if(null==this.lightDebugger){if(this.lightDebugger=EC_Light_ThreeJs.createLightDebugger(this),null==this.lightDebugger)return;this.lightNode.add(this.lightDebugger),b=!0}if(void 0!==a&&!b&&"range"===a&&this.lightDebugger instanceof THREE.PointLightHelper)return this._destroyDebugger(),void this._updateDebugger();this.lightNode.updateMatrix(),this.lightNode.updateMatrixWorld(!0),this.lightDebugger.matrixWorld=this.lightNode.matrixWorld,this.lightDebugger.updateMatrix(),this.lightDebugger.updateMatrixWorld(!0),this.lightDebugger.update()}},_destroyDebugger:function(){null!=this.lightDebugger&&null!=this.lightDebugger.parent&&this.lightDebugger.parent.remove(this.lightDebugger),this.lightDebugger=null},_parentLight:function(){if(null!=this.parentEntity&&null!=this.lightNode&&null==this.lightNode.parent){if(null==this.parentEntity.placeable)return void(this._parentingSub=this.parentEntity.onComponentCreated(this,this._onParentEntityComponentCreated));null!=this._parentingSub&&Tundra.events.unsubscribe(this._parentingSub),this._parentingSub=null,this.lightNode.target instanceof THREE.Object3D&&(this.lightNode.target=this.parentEntity.placeable.sceneNode),this.lightNode.position.set(0,0,-1e-4),this.parentEntity.placeable.addChild(this.lightNode),this._updateDebugger(),Tundra.renderer.shadowCastingLightsChanged()}},_onParentEntityComponentCreated:function(a,b){null!=b&&"Placeable"===b.typeName&&this._parentLight()}}),EC_Mesh=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"nodeTransformation",new Transform,Attribute.Transform),this.declareAttribute(1,"meshRef","",Attribute.AssetReference),this.declareAttribute(2,"skeletonRef","",Attribute.AssetReference),this.declareAttribute(3,"materialRefs","",Attribute.AssetReferenceList),this.declareAttribute(4,"drawDistance",0,Attribute.Real),this.declareAttribute(5,"castShadows",!1,Attribute.Bool)},__classvars__:{TypeId:17,TypeName:"Mesh"}}),EC_Mesh_ThreeJs=EC_Mesh.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.meshAsset=null,this.skeletonAsset=null,this.materialAssets=[],this.meshRequested=!1,this.skeletonRequested=!1,this.materialsRequested=!1,this.attachements=[],this.attachementsMeta={},this._loadsEmitted={mesh:!1}},__classvars__:{Implementation:"three.js"},reset:function(){Tundra.events.remove("EC_Mesh."+this.parentEntity.id+"."+this.id+".MeshLoaded"),Tundra.events.remove("EC_Mesh."+this.parentEntity.id+"."+this.id+".SkeletonLoaded"),Tundra.events.remove("EC_Mesh."+this.parentEntity.id+"."+this.id+".MaterialLoaded"),this.resetMesh(),this.resetMaterials(),this.attachements=[],this.attachementsMeta={},void 0!==this._componentAddedSub&&(Tundra.events.unsubscribe(this._componentAddedSub),this._componentAddedSub=void 0)},attributeChanged:function(a,b,c){if(0===a)this.meshAsset&&this.meshAsset.isLoaded()?Tundra.renderer.updateSceneNode(this.meshAsset.mesh,this.nodeTransformation):this.update();else if(1===a)this.resetMesh(),this.update();else if(2===a)this.update();else if(3===a)this.materialsRequested=!1,this.update();else if(4===a);else if(5===a){if(null==this.meshAsset)return;for(var d=0,e=this.meshAsset.numSubmeshes();e>d;++d){var f=this.meshAsset.getSubmesh(d);void 0!==f&&null!==f&&(f.castShadow=c)}}},getSceneNode:function(){return null!=this.meshAsset?this.meshAsset.getSceneNode():null},getSubmesh:function(a){return null!=this.meshAsset?this.meshAsset.getSubmesh(a):null},numSubmeshes:function(){return null!=this.meshAsset?this.meshAsset.numSubmeshes():0},getBoundingBox:function(){var a=new THREE.Box3;this.numSubmeshes()>0&&a.set(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0));for(var b=0,c=this.numSubmeshes();c>b;b++){var d=this.getSubmesh(b);null!=d&&null!=d.geometry&&(null==d.geometry.boundingBox&&d.geometry.computeBoundingBox(),a.union(d.geometry.boundingBox))}return a},update:function(){if(null==this.meshAsset&&!this.meshRequested){var a=this.attributes.meshRef.get();if(null!=a&&""!=a){var b=void 0;(CoreStringUtils.endsWith(a,".json",!0)||CoreStringUtils.endsWith(a,".js",!0))&&(b="ThreeJsonMesh"),this.meshRequested=!0;var c=Tundra.asset.requestAsset(a,b);null!=c&&c.onCompleted(this,this._meshAssetLoaded)}}if(!this.materialsRequested)for(var d=this.attributes.materialRefs.get(),e=0;e<d.length;e++){this.materialsRequested=!0;var f=d[e];if("string"==typeof f&&""!==f){var g=null!=this.meshAsset?this.meshAsset.getSubmesh(e):void 0;if(void 0!=g&&null!=g.material&&g.material.name===f)continue;var c=Tundra.asset.requestAsset(f,"OgreMaterial");null!=c&&(c.onCompleted(this,this._materialAssetLoaded,e),c.onFailed(this,this._materialAssetFailed,e),this.materialAssets[e]=c)}}if(null!=this.meshAsset&&this.meshAsset.isLoaded()){if(this.allMaterialsLoaded()){if(null==this.skeletonAsset&&!this.skeletonRequested){var h=this.attributes.skeletonRef.get();if(null!=h&&""!=h){this.skeletonRequested=!0;var c=Tundra.asset.requestAsset(h);if(null!=c)return void c.onCompleted(this,this._skeletonAssetLoaded)}}for(var d=this.attributes.materialRefs.get(),i=this.meshAsset.numSubmeshes(),e=0;i>e;++e){var g=this.meshAsset.getSubmesh(e);if(void 0!==g&&null!==g){var f=d[e];if(null==g.material||g.material.name!==f){var j=this.materialAssets[e];j instanceof IAsset||j instanceof THREE.Material?g.material=j instanceof IAsset?j.material:j:g.material=Tundra.renderer.materialWhite,g.receiveShadow=null!=g.material&&void 0!==g.material.hasTundraShadowShader&&g.material.hasTundraShadowShader===!0,g.castShadow=this.castShadows}}}this.materialAssets.length>i&&this.log.warnC("Too many materials for target mesh "+this.meshAsset.name+". Materials: "+this.materialAssets.length+" Submeshes: "+i+" In entity: "+this.parentEntity.id+" "+this.parentEntity.name)}null==this.meshAsset.mesh.parent&&(null!=this.parentEntity.placeable?this._onParentEntityComponentCreated(this.parentEntity,this.parentEntity.placeable):this._componentAddedSub=this.parentEntity.onComponentCreated(this,this._onParentEntityComponentCreated)),Tundra.renderer.updateSceneNode(this.meshAsset.mesh,this.nodeTransformation),null!=this.skeletonAsset&&this.skeletonAsset.attach(this.meshAsset),(""===this.skeletonRef||null!=this.skeletonAsset)&&this.attachAttachements()}},_onParentEntityComponentCreated:function(a,b){null!=b&&"Placeable"===b.typeName&&(void 0!==this._componentAddedSub&&(Tundra.events.unsubscribe(this._componentAddedSub),this._componentAddedSub=void 0),null!=b.sceneNode?this._onParentPlaceableNodeCreated(b,b.sceneNode):this._placeableNodeCreatedSub=b.onSceneNodeCreated(this,this._onParentPlaceableNodeCreated))},_onParentPlaceableNodeCreated:function(a,b){if(void 0!==this._placeableNodeCreatedSub&&(Tundra.events.unsubscribe(this._placeableNodeCreatedSub),this._placeableNodeCreatedSub=void 0),null!=this.meshAsset&&null!=this.meshAsset.mesh){var c=null==this.meshAsset.mesh.parent;a.addChild(this.meshAsset.mesh),c&&this._loadsEmitted.mesh===!1&&(this._loadsEmitted.mesh=!0,Tundra.events.send("EC_Mesh."+this.parentEntity.id+"."+this.id+".MeshLoaded",this.parentEntity,this,this.meshAsset))}else this.log.error("Mesh not ready but placeable is?!")},attachAttachements:function(){if(""!==this.meshRef&&null==this.meshAsset)return void this.log.warn("attachAttachements: Mesh",this.meshRef,"not ready yet!");if(""!==this.skeletonRef&&null==this.skeletonAsset)return void this.log.warn("attachAttachements: Skeleton",this.skeletonRef,"not ready yet!");for(var a=[],b=0;b<this.attachements.length;b++){var c=this.attachements[b];c.attach(this.meshAsset,this.skeletonAsset)&&c.verticesToHide.length>0&&(a=a.concat(c.verticesToHide))}if(0!==a.length){for(var d=0;d<a.length&&void 0!==a[d];d++)for(var e=d+1;e<a.length;e++)a[d]===a[e]&&(a.splice(e,1),e--);var f=!0;if(Array.isArray(this.attachementsMeta.vertices)){f=!1;for(var g=0,h=this.attachementsMeta.vertices.length;h>g;g++)if(this.attachementsMeta.vertices[g]!==a[g]){f=!0;break}}if(f){this.attachementsMeta.vertices=a;var i=this.meshAsset.getSubmesh(0);if(null!=i){void 0===this.attachementsMeta.geometryOriginal&&(this.attachementsMeta.geometryOriginal=i.geometry),void 0===this.attachementsMeta.submeshOriginal&&(this.attachementsMeta.submeshOriginal=i),void 0!==this.attachementsMeta.geometry&&this.attachementsMeta.geometry.dispose(),this.attachementsMeta.geometry=this.attachementsMeta.geometryOriginal.clone();for(var j=this.attachementsMeta.geometry.attributes.index.array,k=Array.prototype.slice.call(j),l=(k.length,0),m=k.length;m>l;l+=3){var n=a.indexOf(k[l]),o=-1!==n?a.indexOf(k[l+1]):-1,p=-1!==o?a.indexOf(k[l+2]):-1;-1!==p&&(k.splice(l,3),m-=3,l-=3)}for(var q=this.attachementsMeta.geometryOriginal.attributes.index.is32bit,r=new DataSerializer(k.length,q===!0?DataSerializer.ArrayType.Uint32:DataSerializer.ArrayType.Uint16),l=0,m=k.length;m>l;++l)q?r.writeU32(k[l]):r.writeU16(k[l]);this.attachementsMeta.geometry.attributes.index.array=r.array,this.attachementsMeta.geometry.drawcalls=[],this.attachementsMeta.geometry.addDrawCall(0,r.array.length),this.attachementsMeta.geometry.offsets=this.attachementsMeta.geometry.drawcalls;var s=i.parent;s.remove(i),this.attachementsMeta.submesh=new THREE.SkinnedMesh(this.attachementsMeta.geometry,i.material,i.useVertexTexture),this.meshAsset.mesh.add(this.attachementsMeta.submesh),this.attachementsMeta.submesh.bind(this.skeletonAsset.skeleton),this.skeletonAsset.skeleton.pose()}}}},detachAttachements:function(){for(var a=0;a<this.attachements.length;a++)this.attachements[a].detach()},resetMesh:function(){if(this.detachAttachements(),null!=this.meshAsset){var a=this.parentEntity.getComponent("Placeable");null!=a&&null!=a.sceneNode&&a.sceneNode.remove(this.meshAsset.mesh),this.meshAsset.unload()}this.meshAsset=null,this.meshRequested=!1,this._loadsEmitted.mesh=!1},resetMaterials:function(){null!=this.meshAsset&&this.meshAsset.resetMaterials();
for(var a=0;a<this.materialAssets.length;a++){var b=this.materialAssets[a];null!=b&&"function"==typeof b.unload&&b.unload(),b=null}this.materialAssets=[],this.materialsRequested=!1},setMesh:function(a,b){return"string"!=typeof a?(this.log.errorC("setMesh must be called with a string ref, called with:",a),!1):this.attributes.meshRef.set(a,b)},setMaterial:function(a,b,c){if("string"==typeof a&&"number"==typeof b){for(var d=this.attributes.materialRefs.get(),e=d.length;b>e;++e)d.push("");return d[b]=a,this.attributes.materialRefs.set(d,c)}return this.log.errorC("setMaterial must be called single string ref and material index as the second parameter, called with:",a,b),!1},setMaterials:function(a,b){return Array.isArray(a)?this.attributes.materialRefs.set(a,b):(this.log.errorC("setMaterials must be called with Array parameter, called with:",a),!1)},onMeshLoaded:function(a,b){return this.hasParentEntity()?Tundra.events.subscribe("EC_Mesh."+this.parentEntity.id+"."+this.id+".MeshLoaded",a,b):(this.log.error("Cannot subscribe onMeshLoaded, parent entity not set!"),null)},onSkeletonLoaded:function(a,b){return this.hasParentEntity()?Tundra.events.subscribe("EC_Mesh."+this.parentEntity.id+"."+this.id+".SkeletonLoaded",a,b):(this.log.error("Cannot subscribe onSkeletonLoaded, parent entity not set!"),null)},onMaterialLoaded:function(a,b){return this.hasParentEntity()?Tundra.events.subscribe("EC_Mesh."+this.parentEntity.id+"."+this.id+".MaterialLoaded",a,b):(this.log.error("Cannot subscribe onMaterialLoaded, parent entity not set!"),null)},onMaterialsLoaded:function(a,b){return this.hasParentEntity()?Tundra.events.subscribe("EC_Mesh."+this.parentEntity.id+"."+this.id+".MaterialsLoaded",a,b):(this.log.error("Cannot subscribe onMaterialsLoaded, parent entity not set!"),null)},_meshAssetLoaded:function(a){if(this.hasParentEntity()){if(this.meshAsset=a,null!=this.meshAsset.mesh){this.meshAsset.mesh.tundraEntityId=this.parentEntity.id;for(var b=0,c=this.meshAsset.numSubmeshes();c>b;b++){var d=this.meshAsset.getSubmesh(b);null!=d&&(d.tundraEntityId=this.parentEntity.id)}}this.update(),null!=this.meshAsset.mesh.parent&&this._loadsEmitted.mesh===!1&&(this._loadsEmitted.mesh=!0,Tundra.events.send("EC_Mesh."+this.parentEntity.id+"."+this.id+".MeshLoaded",this.parentEntity,this,this.meshAsset))}},_skeletonAssetLoaded:function(a,b){this.hasParentEntity()&&(this.skeletonAsset=a,this.update(),Tundra.events.send("EC_Mesh."+this.parentEntity.id+"."+this.id+".SkeletonLoaded",this.parentEntity,this,this.skeletonAsset))},_materialAssetLoaded:function(a,b){if(this.hasParentEntity()&&(void 0!==a&&void 0!==b&&(this.materialAssets[b]=a),this.allMaterialsLoaded())){this.update();for(var c=0;c<this.materialAssets.length;++c){var d=this.materialAssets[c];d instanceof IAsset&&d.isLoaded()&&Tundra.events.send("EC_Mesh."+this.parentEntity.id+"."+this.id+".MaterialLoaded",this.parentEntity,this,c,d)}Tundra.events.send("EC_Mesh."+this.parentEntity.id+"."+this.id+".MaterialsLoaded",this.parentEntity,this)}},_materialAssetFailed:function(a,b,c){this._materialAssetLoaded(Tundra.renderer.materialLoadError,c)},allMaterialsLoaded:function(){for(var a=0;a<this.materialAssets.length;++a){var b=this.materialAssets[a];if(void 0!==b&&null!==b&&!(b instanceof THREE.Material)){if(b instanceof AssetTransfer)return!1;if(!(b instanceof IAsset))return!1}}return!0},numMaterialsLoading:function(){for(var a=0,b=0;b<this.materialAssets.length;++b){var c=this.materialAssets[b];void 0!==c&&null!==c&&(c instanceof AssetTransfer&&a++,c instanceof IAsset&&!c.isLoaded()&&a++)}return a},setAttachements:function(a){return this.attachements.length>0&&this.detachAttachements(),Array.isArray(a)?(this.attachements=a,void(null==this.meshAsset||""!==this.skeletonRef&&null==this.skeletonAsset||this.attachAttachements())):void(this.attachements=[])}}),AttributeInterpolationData=Class.$extend({__init__:function(a){this.previous=void 0,this.current=void 0,this.previousCanCopy=!1,this.currentCanCopy=!1},change:function(a){this.current&&(this.previousCanCopy?this.previous.copy(this.current):(this.previous=this.current.clone(),this.previousCanCopy="function"==typeof this.previous.copy)),this.currentCanCopy?this.current.copy(a):(this.current=a.clone(),this.currentCanCopy="function"==typeof this.current.copy)},reset:function(){this.previous=void 0,this.current=void 0}}),EC_Placeable=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"transform",new Transform,Attribute.Transform),this.declareAttribute(1,"drawDebug",!1,Attribute.Bool),this.declareAttribute(2,"visible",!0,Attribute.Bool),this.declareAttribute(3,"selectionLayer",1,Attribute.Int),this.declareAttribute(4,"parentRef","",Attribute.EntityReference),this.declareAttribute(5,"parentBone","",Attribute.String)},__classvars__:{TypeId:20,TypeName:"Placeable"}}),EC_Placeable_ThreeJs=EC_Placeable.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.attributes.transform.interpolation=new AttributeInterpolationData,this.sceneNode=null,this._pendingChildren=[]},__classvars__:{Implementation:"three.js",TransformInterpolator:void 0},reset:function(){if(null!=this.sceneNode){Tundra.events.send("EC_Placeable."+this.parentEntity.id+"."+this.id+".AboutToBeDestroyed",this,this.sceneNode);var a=this.sceneNode.parent;void 0!==a&&null!==a&&a.remove(this.sceneNode)}this.sceneNode=null,void 0!==this._componentAddedSub&&(Tundra.events.unsubscribe(this._componentAddedSub),this._componentAddedSub=void 0),void 0!==this._entityCreatedSub&&(Tundra.events.unsubscribe(this._entityCreatedSub),this._entityCreatedSub=void 0)},update:function(){var a=Tundra.renderer;if(null==this.sceneNode){this.sceneNode=a.createSceneNode(),this.sceneNode.name=this.parentEntity.name,this.sceneNode.tundraEntityId=this.parentEntity.id,this.sceneNode.tundraComponentId=this.id,this._setVisible(this.attributes.visible.get()),a.scene.add(this.sceneNode),this.checkParent(),a.updateSceneNode(this.sceneNode,this.attributes.transform.value);for(var b=0;b<this._pendingChildren.length;b++)this.addChild(this._pendingChildren[b]);return this._pendingChildren=[],void Tundra.events.send("EC_Placeable."+this.parentEntity.id+"."+this.id+".SceneNodeCreated",this,this.sceneNode)}this.checkParent(),a.updateSceneNode(this.sceneNode,this.attributes.transform.value)},attributeChanged:function(a,b,c){switch(a){case 0:null!=this.sceneNode&&(EC_Placeable_ThreeJs.TransformInterpolator?EC_Placeable_ThreeJs.TransformInterpolator.update(this.parentEntity,this,this.sceneNode,this.attributes.transform):Tundra.client.renderer.updateSceneNode(this.sceneNode,c));break;case 1:break;case 2:this._setVisible(c);break;case 3:break;case 4:this.checkParent();break;case 5:}},onSceneNodeCreated:function(a,b){return this.hasParentEntity()?Tundra.events.subscribe("EC_Placeable."+this.parentEntity.id+"."+this.id+".SceneNodeCreated",a,b):(this.log.error("Cannot subscribe onSceneNodeCreated, parent entity not set!"),null)},onAboutToBeDestroyed:function(a,b){return this.hasParentEntity()?Tundra.events.subscribe("EC_Placeable."+this.parentEntity.id+"."+this.id+".AboutToBeDestroyed",a,b):(this.log.error("Cannot subscribe onAboutToBeDestroyed, parent entity not set!"),null)},addChild:function(a){return void 0!==a&&null!==a?a instanceof EC_Placeable?void this.addChild(a.sceneNode):void(null!=this.sceneNode?(this.sceneNode.add(a),a.updateMatrix(),a.updateMatrixWorld(!0),void 0!==this._visibilityTimerId&&clearTimeout(this._visibilityTimerId),this._visibilityTimerId=setTimeout(this.updateVisibility.bind(this),50)):this._pendingChildren.push(a)):void 0},_applyParentChain:function(a,b){for(var c=this.sceneNode.parent;null!==c&&void 0!==c&&c instanceof THREE.Scene==!1;)a instanceof THREE.Vector3?a.add(c[b]):a instanceof THREE.Quaternion&&a.multiply(c[b].clone().normalize()),c=c.parent},distanceTo:function(a){var b=a instanceof THREE.Vector3?a:void 0;if(void 0===b){var c=a instanceof Entity?a.placeable:a instanceof EC_Placeable?a:void 0;null!=c&&(b=c.worldPosition())}return void 0!==b?this.worldPosition().distanceTo(b):void 0},decompose:function(a,b,c){this.attributes.transform.value.decompose(a,b,c)},position:function(){return this.attributes.transform.get().pos.clone()},setPosition:function(a,b,c,d){var e=this.attributes.transform.get();e.setPosition(a,b,c);var f="number"!=typeof a?b:d;return this.attributes.transform.set(e,f)},worldPosition:function(a){return null==this.sceneNode?null:(a=a||new THREE.Vector3,a.setFromMatrixPosition(this.sceneNode.matrixWorld),a)},setWorldPosition:function(a){var b=this.attributes.transform.get(),c=a.clone();""!==this.parentRef&&this.sceneNode.parent.worldToLocal(c),b.pos.copy(c),this.attributes.transform.set(b)},scale:function(){return this.attributes.transform.get().scale.clone()},setScale:function(a,b,c,d){var e=this.attributes.transform.get();e.setScale(a,b,c);var f="number"!=typeof a?b:d;return this.attributes.transform.set(e,f)},rotation:function(){return this.attributes.transform.get().rot.clone()},setRotation:function(a,b,c,d){var e=this.attributes.transform.get();e.setRotation(a,b,c);var f="number"!=typeof a?b:d;return this.attributes.transform.set(e,f)},checkParent:function(){if(null!=this.sceneNode&&null!=this.parentEntity&&null!=this.parentScene){if(void 0!==this._componentAddedSub&&(Tundra.events.unsubscribe(this._componentAddedSub),this._componentAddedSub=void 0),void 0!==this._entityCreatedSub&&(Tundra.events.unsubscribe(this._entityCreatedSub),this._entityCreatedSub=void 0),""!==this.parentRef){for(var a=null,b=this.attributes.parentRef.value,c=parseInt(b),d=!isNaN(c),e=0,f=this.parentScene.entities.length;f>e;e++){var g=this.parentScene.entities[e];if(d&&g.id===c){a=g;break}if(!d&&g.name===b&&(a=g,a.placeable))break}if(null!=a){if(null!=a.placeable)return void a.placeable.addChild(this);this._componentAddedSub=a.onComponentCreated(this,this._onParentPlaceableEntityComponentCreated)}else this._entityCreatedSub=this.parentScene.onEntityCreated(this,this._onParentSceneEntityCreated)}this.removeParent()}},removeParent:function(){null!=this.sceneNode&&null!=this.parentEntity&&null!=this.parentScene&&void 0!==this.sceneNode.parent&&null!==this.sceneNode.parent&&this.sceneNode.parent!==Tundra.renderer.scene&&(Tundra.renderer.scene.add(this.sceneNode),Tundra.client.renderer.updateSceneNode(this.sceneNode,this.transform))},_onParentSceneEntityCreated:function(a){(""!==a.name&&a.name===this.parentRef||a.id===parseInt(this.parentRef))&&this.checkParent()},_onParentPlaceableEntityComponentCreated:function(a,b){null!=b&&"Placeable"===b.typeName&&this.checkParent()},updateVisibility:function(){this._setVisible(this.attributes.visible.get())},isVisibleTraverse:function(){if(!this.attributes.visible.get())return!1;if(!this.sceneNode)return!1;for(var a=this.sceneNode.parent;a&&!(a instanceof THREE.Scene);){if(a.visible===!1)return!1;a=a.parent}return!0},_setVisible:function(a){null!=this.sceneNode&&this.sceneNode.traverse(function(b){if(!(b instanceof THREE.PerspectiveCamera)){if(a&&void 0!==b.tundraEntityId){var c=Tundra.scene.entityById(b.tundraEntityId),d=null!=c?void 0!==b.tundraComponentId?c.componentById(b.tundraComponentId):c.placeable:null;if(null!=d&&!d.visible)return}b.visible=a}})},lookAt:function(a){var b,c=this.attributes.transform.get(),d=this.worldPosition();b=a instanceof THREE.Vector3?a:a.placeable.worldPosition();var e=c.lookAtQuaternion(d,b);if(this.sceneNode&&this.sceneNode.parent){var f=new THREE.Quaternion;f.setFromRotationMatrix(this.sceneNode.parent.matrixWorld),f.inverse(),e.multiplyQuaternions(f,e)}c.setRotation(e),this.transform=c},orientation:function(){return this.attributes.transform.get().orientation()},worldOrientation:function(){if(null==this.sceneNode)return null;var a=new THREE.Quaternion;return a.setFromRotationMatrix(this.sceneNode.matrixWorld),a},setWorldOrientation:function(a){var b=this.attributes.transform.get(),c=a.clone();if(""!==this.parentRef){var d=new THREE.Quaternion;d.setFromRotationMatrix(this.sceneNode.parent.matrixWorld),d.inverse(),c.multiplyQuaternions(d,c)}b.setRotation(c),this.attributes.transform.set(b)},worldTransform:function(){var a=this.transform.clone();return a.pos=this.worldPosition(),a},setWorldTransform:function(a){var b=this.attributes.transform.get(),c=""!==this.parentRef?this.transform.pos.clone():new THREE.Vector3(0,0,0);b=a,b.pos.add(c),this.attributes.transform.set(b)}}),EC_ParticleSystem=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"particleRef","",Attribute.AssetReference),this.declareAttribute(1,"castShadows",!1,Attribute.Bool),this.declareAttribute(2,"enabled",!0,Attribute.Bool),this.declareAttribute(3,"renderingDistance",0,Attribute.Real)},__classvars__:{TypeId:27,TypeName:"ParticleSystem"}}),EC_ParticleSystem_ThreeJs=EC_ParticleSystem.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.particleAsset=null,this.system=null},__classvars__:{Implementation:"three.js"},attributeChanged:function(a){switch(a){case this.attributes.particleRef.index:this.requestParticleAsset();break;case this.attributes.enabled.index:this.update(),this.system&&(this.system.emitting=this.enabled)}},requestParticleAsset:function(){var a=Tundra.asset.requestAsset(this.particleRef,"OgreParticle");a?(a.onCompleted(this,this.onParticleLoaded),a.onFailed(this,this.onParticleFailed),this.particleAsset=null):this.log.error("Failed to request particle asset "+this.particleRef)},onParticleLoaded:function(a){this.particleAsset=a,this.update()},onParticleFailed:function(){this.particleAsset=null},update:function(){if(!this.particleAsset&&this.particleRef.trim().length>0)return void this.requestParticleAsset();if(this.enabled&&0!==this.particleRef.trim().length){var a="",b=-1!==this.particleRef.indexOf(a);if((!(a.length>0)||b)&&this.particleAsset&&this.particleAsset.isLoaded()&&(this.system=this.particleAsset.system,0!==this.system.emitters.length)){var c={};c=this.particleAsset.material.clone(c),this.system.initialize(c)&&(this.parentEntity.placeable?this.handleComponentCreated(this.parentEntity,this.parentEntity.placeable):this.componentAddedSub=this.parentEntity.onComponentCreated(this,this.handleComponentCreated),this.updateSub=Tundra.frame.onUpdate(this,this.frameUpdate))}}},reset:function(){this.updateSub&&Tundra.events.unsubscribe(this.updateSub),this.updateSub=null,this.system&&this.system.dispose(),this.system=null},frameUpdate:function(a){this.system&&this.system.update(a)},handleComponentCreated:function(a,b){Tundra.noop(a),20==b.typeId&&(this.componentAddedSub&&(Tundra.events.unsubscribe(this.componentAddedSub),this.componentAddedSub=null),b.sceneNode?this.handleSceneNodeCreated(b,b.sceneNode):this.sceneNodeCreatedSub=b.onSceneNodeCreated(this,this.handleSceneNodeCreated))},handleSceneNodeCreated:function(a,b){Tundra.noop(b),this.sceneNodeCreatedSub&&Tundra.events.unsubscribe(this.sceneNodeCreatedSub),this.sceneNodeCreatedSub=null,this.system&&this.system.particleSystem?a.addChild(this.system.particleSystem):this.log.error("handleSceneNodeCreated: ParticleSystem is not ready but Placeable is.")}}),EC_Billboard=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"materialRef","",Attribute.AssetReference),this.declareAttribute(1,"position",new THREE.Vector3(0,0,0),Attribute.Float3),this.declareAttribute(2,"width",1,Attribute.Real),this.declareAttribute(3,"height",1,Attribute.Real),this.declareAttribute(4,"rotation",0,Attribute.Real),this.declareAttribute(5,"show",!0,Attribute.Bool)},__classvars__:{TypeId:2,TypeName:"Billboard"}}),EC_Billboard_ThreeJs=EC_Billboard.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.material=null,this.sprite=null;var e=this;this._text=void 0,Object.defineProperties(this,{text:{get:function(){return this._text},set:function(a){this._text=a,e.loadTextSprite()}},autoHideDistanceFurtherThan:{get:function(){return this._autoHideDistanceFurtherThan},set:function(a){this._autoHideDistanceFurtherThan="number"==typeof a&&a>0?a*a:-1},_autoHideDistanceFurtherThan:-1},autoHideDistanceFurtherThanFromCamera:{get:function(){return this._autoHideDistanceFurtherThanFromCamera},set:function(a){this._autoHideDistanceFurtherThanFromCamera="number"==typeof a&&a>0?a*a:-1},_autoHideDistanceFurtherThanFromCamera:-1},autoScaleDistanceCloserThan:{get:function(){return this._autoScaleDistanceCloserThan},set:function(a){this._autoScaleDistanceCloserThan="number"==typeof a&&a>0?a*a:-1},_autoScaleDistanceCloserThan:-1},autoScaleDistanceFurtherThan:{get:function(){return this._autoScaleDistanceFurtherThan},set:function(a){this._autoScaleDistanceFurtherThan="number"==typeof a&&a>0?a*a:-1},_autoScaleDistanceFurtherThan:-1}}),this.style={background:void 0,font:"black",fontSize:48,border:void 0,borderWidth:1,padding:void 0,isDefined:function(){return this.background||this.border},key:function(){var a="";return this.background instanceof Color?a+="_background="+this.background.toString(!0):"string"==typeof this.background&&(a+="_background="+this.background),this.border instanceof Color?a+="_border="+this.border.toString(!0):"string"==typeof this.border&&(a+="_border="+this.border),this.font instanceof Color?a+="_font="+this.font.toString(!0):"string"==typeof this.font&&(a+="_font="+this.font),a},css:function(a){if("borderWidth"===a)return"number"==typeof this.borderWidth?this.borderWidth.toString():"0";var b=void 0;return"background"===a&&(b=this.background),"border"===a&&(b=this.border),"font"===a&&(b=this.font),b?b instanceof Color?b.toString(!0):b:"transparent"}},this.color=new THREE.Color(1,1,1),this.depthTest=!0,this.depthWrite=!0,this.autoScaleLimits=new THREE.Vector2(1,1),this.autoOffset=new THREE.Vector3(0,0,0),this._autoScalingFactor=1,this.onHoverIn=null,this.onHoverOut=null,this._overrideScale=new THREE.Vector2(1,1)},__classvars__:{Implementation:"three.js",MaterialCache:{},ImgCache:{},Canvas:void 0,Animator:new PlaceableUtils.Animator,GetOrCreateMaterial:function(a,b){depthTest="boolean"==typeof depthTest?depthTest:!0,depthWrite="boolean"==typeof depthWrite?depthWrite:!0;var c=b+"_"+depthTest+"_"+depthWrite,d=this.MaterialCache[c];if(void 0===d){if(d=new THREE.SpriteMaterial({color:a.color}),d.depthTest=a.depthTest,d.depthWrite=a.depthWrite,-1===b.indexOf(".dds")&&a.style.isDefined()){var c=b+a.style.key(),e=EC_Billboard_ThreeJs.ImgCache[c];if(e)if(e.complete)d.map=EC_Billboard_ThreeJs.StylizeImage(a,a.style,e),d.needsUpdate=!0;else{var f=$(e).data("materials");Array.isArray(f)?f.push(d):f=[d],$(e).data("materials",f)}else{e=new Image,e.onload=function(){for(var a=$(e).data("materials"),b=0;b<a.length;b++)a[b].map=EC_Billboard_ThreeJs.StylizeImage(this.ec_billboard,this.ec_billboard.style,e),a[b].needsUpdate=!0}.bind({ec_billboard:a}),e.crossOrigin="anonymous",e.src=b,EC_Billboard_ThreeJs.ImgCache[c]=e;var f=$(e).data("materials");Array.isArray(f)?f.push(d):f=[d],$(e).data("materials",f)}}else{var g=Tundra.asset.requestAsset(b);g.onCompleted(d,function(a){this.map=a.texture,this.map.repeat.set(-1,1),this.map.offset.set(1,0),this.needsUpdate=!0})}this.MaterialCache[c]=d}return d},GetOrCreateTextMaterial:function(a,b){depthTest="boolean"==typeof depthTest?depthTest:!0,depthWrite="boolean"==typeof depthWrite?depthWrite:!0;var c=b+"_"+depthTest+"_"+depthWrite+"_",d=this.MaterialCache[c];return void 0===d?(d=new THREE.SpriteMaterial({color:a.color}),d.depthTest=a.depthTest,d.depthWrite=a.depthWrite,d.map=EC_Billboard_ThreeJs.StylizeImage(a,a.style,void 0,b),this.MaterialCache[c]=d):a.width=a.width*d.map._tundraRatio,d},StylizeImage:function(a,b,c,d){if((!c||0===c.width||0===c.height)&&"string"!=typeof d)return console.error("EC_Billboard_ThreeJs.StylizeImage: null image",c),null;void 0===EC_Billboard_ThreeJs.Canvas&&(EC_Billboard_ThreeJs.Canvas=document.createElement("canvas"));var e="number"==typeof b.padding?b.padding:0,f=2*e,g=2*e,h=EC_Billboard_ThreeJs.Canvas.getContext("2d");if(c)f+=c.width,g+=c.height,EC_Billboard_ThreeJs.Canvas.width=128,EC_Billboard_ThreeJs.Canvas.height=128;else{h.font=b.fontSize+"px serif",h.textAlign="center",h.textBaseline="middle";var i=h.measureText(d);f+=i.width,g+=b.fontSize;var j=function(a){var b=a>0?a-1:0;b|=b>>1,b|=b>>2,b|=b>>4,b|=b>>8,b|=b>>16,b++;var c=Math.pow(2,Math.floor(Math.log(a)/Math.log(2)));return b-a>a-c?c:b};EC_Billboard_ThreeJs.Canvas.width=j(f),EC_Billboard_ThreeJs.Canvas.height=j(g)}h.scale(EC_Billboard_ThreeJs.Canvas.width/f,EC_Billboard_ThreeJs.Canvas.height/g),h.clearRect(0,0,f,g),h.fillStyle=b.css("background"),h.strokeStyle=b.css("border"),h.lineWidth=b.css("borderWidth"),h.lineCap="round",h.lineJoin="round",h.fillRect(0,0,f,g),h.rect(0,0,f,g),h.stroke(),c?h.drawImage(c,e,e):(h.fillStyle=b.css("font"),h.font=b.fontSize+"px 'Open Sans', sans-serif",h.textBaseline="hanging",h.fillText(d,e,e,f-2*e));var k=new Image,l=new THREE.Texture(k);l.flipY=!1;try{k.onload=function(){l.repeat.set(-1,1),l.offset.set(1,0),l.needsUpdate=!0},k.src=EC_Billboard_ThreeJs.Canvas.toDataURL("image/png")}catch(m){return console.error("Failed to draw billboard from '"+c.src+"': "+m.toString()),null}return l._tundraRatio=f/g,d&&(a.width=a.width*l._tundraRatio),l},LastHovered:null,UpdateSub:null,Update:function(){var a=Tundra.scene.components(EC_Billboard.TypeId);if(0===a.length)return void(null!=EC_Billboard_ThreeJs.UpdateSub&&(Tundra.events.unsubscribe(EC_Billboard_ThreeJs.UpdateSub),EC_Billboard_ThreeJs.UpdateSub=null));var b=[],c=Tundra.renderer.activeCameraEntity(),d=null!=c&&null!=c.camera?c.camera.camera:null;if(null!=d&&null!=c.placeable){for(var e=c.placeable.worldPosition(),f=c.camera.getWorldFocusPosition(),g=new THREE.Vector3(0,0,0),h=0,i=0;i<a.length;i++){var j=a[i];if(null!=j&&j.sprite&&j.visibleOverride!==!1&&!(j.autoScaleDistanceCloserThan<0&&j.autoScaleDistanceFurtherThan<0&&j.autoHideDistanceFurtherThan<0))if(j.worldPosition(g))if(h=f.distanceToSquared(g),j.autoHideDistanceFurtherThan>0&&h>=j.autoHideDistanceFurtherThan)j.hide(!1);else if(h=e.distanceToSquared(g),j.autoHideDistanceFurtherThanFromCamera>0&&h>=j.autoHideDistanceFurtherThanFromCamera)j.hide(!1);else{j.show(!0);var k=j.attributes.position.value,l=1;j.autoScaleDistanceCloserThan>0&&h<j.autoScaleDistanceCloserThan?(l=h/j.autoScaleDistanceCloserThan,l<j.autoScaleLimits.x&&(l=j.autoScaleLimits.x)):j.autoScaleDistanceFurtherThan>0&&h>j.autoScaleDistanceFurtherThan&&(l=h/j.autoScaleDistanceFurtherThan,l>j.autoScaleLimits.y&&(l=j.autoScaleLimits.y)),j._autoScalingFactor=l,j._updateSize(),0!=k.y?j.sprite.position.set(k.x,k.y+k.y*l,k.z):j.sprite.position.set(0,0,0),l>1&&!j.autoOffset.isZero()&&j.sprite.position.add(j.autoOffset.clone().multiplyScalar(l-1)),b.push(j.sprite)}else j.hide(!1)}if(b.length>0){var m=Tundra.renderer.raycast(void 0,void 0,void 0,b,!0,!1,!1);if(null!=m.object&&null!=m.object.tundraBillboard){var n=m.object.tundraBillboard.parentEntity.id+"."+m.object.tundraBillboard.id,o=null!=EC_Billboard_ThreeJs.LastHovered?EC_Billboard_ThreeJs.LastHovered.parentEntity.id+"."+EC_Billboard_ThreeJs.LastHovered.id:"";return void(o!==n&&(null!=EC_Billboard_ThreeJs.LastHovered&&null!=EC_Billboard_ThreeJs.LastHovered.onHoverOut&&EC_Billboard_ThreeJs.LastHovered.onHoverOut(EC_Billboard_ThreeJs.LastHovered,m),EC_Billboard_ThreeJs.LastHovered=m.object.tundraBillboard,null!=EC_Billboard_ThreeJs.LastHovered.onHoverIn&&EC_Billboard_ThreeJs.LastHovered.onHoverIn(EC_Billboard_ThreeJs.LastHovered,m)))}}null!=EC_Billboard_ThreeJs.LastHovered&&(null!=EC_Billboard_ThreeJs.LastHovered.onHoverOut&&EC_Billboard_ThreeJs.LastHovered.onHoverOut(EC_Billboard_ThreeJs.LastHovered),EC_Billboard_ThreeJs.LastHovered=null)}}},isVisible:function(){return this.sprite&&this.sprite.parent&&this.parentEntity&&this.parentEntity.placeable?this.parentEntity.placeable.visible:!1},setVisible:function(a,b){a===!0||void 0===a?this.show(b):this.hide(b)},show:function(){!this.parentEntity.placeable||this.parentEntity.placeable.visible||this.parentEntity.placeable._animatingVisibility&&this.parentEntity.placeable._animatingVisibilityTo===!0||(this.visibleOverride=!0,this.animation&&this.animation.stop(),this.animation=EC_Billboard_ThreeJs.Animator.setVisibilityScaling(this.parentEntity.placeable,!0))},hide:function(a){!this.parentEntity.placeable||!this.parentEntity.placeable.visible||this.parentEntity.placeable._animatingVisibility&&this.parentEntity.placeable._animatingVisibilityTo===!1||(a="boolean"==typeof a?a:!0,a&&(this.visibleOverride=!1),this.animation&&this.animation.stop(),this.animation=EC_Billboard_ThreeJs.Animator.setVisibilityScaling(this.parentEntity.placeable,!1))},getMaterial:function(){return null!=this.sprite&&null!=this.sprite.material?this.sprite.material:null},loadTextSprite:function(){if("string"==typeof this._text&&""!==this._text){if(null!=this.sprite){if("string"==typeof this.sprite.tundraReference&&this.sprite.tundraReference===this._text)return;this.reset()}null==this.sprite&&(this.sprite=new THREE.Sprite(EC_Billboard_ThreeJs.GetOrCreateTextMaterial(this,this._text)),this.sprite.matrixAutoUpdate=!1,this.sprite.tundraReference=this._text,this.sprite.tundraBillboard=this,null!=this.parentEntity.placeable?this.parentEntity.placeable.addChild(this.sprite):void 0===this.subPlaceableCreated&&(this.subPlaceableCreated=this.parentEntity.onComponentCreated(this,this.onComponentCreated))),this._updatePosition(),this._updateSize(),this._updateRotation(),null==EC_Billboard_ThreeJs.UpdateSub&&(EC_Billboard_ThreeJs.UpdateSub=Tundra.frame.onUpdate(EC_Billboard_ThreeJs,EC_Billboard_ThreeJs.Update))}},loadSprite:function(){if(""!==this.materialRef){var a=Tundra.asset.resourceTypeForAssetRef(this.materialRef);if("Texture"!==a)return void this.log.warn("Currently only 'Texture' type references are supported for 'materialRef' attribute:",this.materialRef);if(null!=this.sprite){if("string"==typeof this.sprite.tundraReference&&this.sprite.tundraReference===this.materialRef)return;this.reset()}null==this.sprite&&(this.sprite=new THREE.Sprite(EC_Billboard_ThreeJs.GetOrCreateMaterial(this,this.materialRef)),this.sprite.matrixAutoUpdate=!1,this.sprite.tundraReference=this.materialRef,this.sprite.tundraBillboard=this,null!=this.parentEntity.placeable?this.parentEntity.placeable.addChild(this.sprite):void 0===this.subPlaceableCreated&&(this.subPlaceableCreated=this.parentEntity.onComponentCreated(this,this.onComponentCreated))),this._updatePosition(),this._updateSize(),this._updateRotation(),null==EC_Billboard_ThreeJs.UpdateSub&&(EC_Billboard_ThreeJs.UpdateSub=Tundra.frame.onUpdate(EC_Billboard_ThreeJs,EC_Billboard_ThreeJs.Update))}},onComponentCreated:function(a,b){20===b.typeId&&(null!=this.sprite&&b.addChild(this.sprite),void 0!==this.subPlaceableCreated&&(Tundra.events.unsubscribe(this.subPlaceableCreated),this.subPlaceableCreated=void 0))},reset:function(){null!=this.sprite&&null!=this.sprite.parent&&this.sprite.parent.remove(this.sprite),this.sprite=null},update:function(){this.loadSprite()},setOverrideScale:function(a,b){this._overrideScale.set(a,b),(this._overrideScale.isZero()||this.parentEntity&&this.parentEntity.placeable&&this.parentEntity.placeable._animatingVisibility||this.autoScaleDistanceCloserThan<0&&this.autoScaleDistanceFurtherThan<0&&this.autoHideDistanceFurtherThan<0)&&this._updateSize()},_updatePosition:function(){null!=this.sprite&&(this.sprite.position.copy(this.position),this.sprite.updateMatrix(),this.sprite.updateMatrixWorld(!0))},_updateSize:function(){null!=this.sprite&&(this.sprite.scale.set(this.width*this._autoScalingFactor*this._overrideScale.x,this.height*this._autoScalingFactor*this._overrideScale.y,1),this.sprite.updateMatrix(),this.sprite.updateMatrixWorld(!0))},_updateRotation:function(){var a=this.getMaterial();null!=a&&(a.rotation=MathUtils.degToRad(180+this.rotation),a.needsUpdate=!0)},attributeChanged:function(a){0===a?this.loadSprite():1===a?this._updatePosition():2===a||3===a?this._updateSize():4===a?this._updateRotation():5===a&&this.sprite&&this.setVisible(this.attributes.show.value)},worldPosition:function(a){return null==this.parentEntity||null==this.parentScene?!1:(null!=this.parentEntity.placeable?a.copy(this.parentEntity.placeable.worldPosition()).add(this.position):a.copy(this.position),!0)}}),EC_HtmlBillboard_ThreeJs=EC_HtmlBillboard.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this._element=null,Object.defineProperties(this,{element:{get:function(){return this._element},set:this.setElement.bind(this)}}),this.hovering=!1,this.hovertingT=0},__classvars__:{Implementation:"three.js",MaxDistance:1e3,MinScale:.15,UpdateSub:null,Update:function(a){var b=Tundra.scene.components(EC_HtmlBillboard.TypeId);if(0===b.length)return void(null!=EC_HtmlBillboard_ThreeJs.UpdateSub&&(Tundra.events.unsubscribe(EC_HtmlBillboard_ThreeJs.UpdateSub),EC_HtmlBillboard_ThreeJs.UpdateSub=null));var c=Tundra.renderer.activeCameraEntity(),d=null!=c&&null!=c.camera?c.camera.camera:null;if(null!=d&&null!=c.placeable){void 0===this._sphere&&(this._sphere=new THREE.Sphere(void 0,5)),void 0===this._projScreenMatrix&&(this._projScreenMatrix=new THREE.Matrix4),void 0===this._frustum&&(this._frustum=new THREE.Frustum),void 0===this._projector&&(this._projector=new THREE.Projector);var e=Tundra.client.container.width(),f=Tundra.client.container.height();this._projScreenMatrix.multiplyMatrices(d.projectionMatrix,d.matrixWorldInverse),this._frustum.setFromMatrix(this._projScreenMatrix);for(var g=c.placeable.worldPosition(),h=[],i=0,j=!1,k=!1,l=0,m=0,n=0,o=0,p=0,q=0;q<b.length;q++){var r=b[q];if(null!=r._element)if(k=r._element.is(":visible"),r.worldPosition(this._sphere.center)){var j=this._frustum.intersectsSphere(this._sphere);if(j){if(i=g.distanceTo(this._sphere.center),i>=EC_HtmlBillboard_ThreeJs.MaxDistance){if(!k)continue;r._element.fadeOut(1e3)}for(var s={d:i,w:r._element},t=!1,u=0;u<h.length;u++)if(i<h[u].d){h.splice(u,0,s),t=!0;break}t||h.push(s);var v=this._projector.projectVector(this._sphere.center,d);if(l=(v.x+1)/2,m=(-v.y+1)/2,void 0===r._cssCache&&(r._cssCache={left:-1e3,top:-1e3}),p=1,100>i)r._element.css("transform","scale(1,1)");else{if(p=Math.round(100/i*1e4)/1e4,p<=EC_HtmlBillboard_ThreeJs.MinScale){if(!k)continue;r._element.fadeOut(1e3)}else if(r.attributes.hoverMagnify)if(r.hovering)p=r.hoveringScaleIn(a,p),s.hovering=!0;else if(r.hovertingT>=0){var w=r.hoveringScaleOut(a,p);void 0!==w&&(p=w,s.hovering=!0)}r._element.css("transform","scale("+p+","+p+")")}var x=r._element.outerWidth(!0)/2,y=r._element.outerHeight(!0)/2;o=Math.round(100*(l*e-x))/100,n=Math.round(100*(m*f-y))/100;var z=Math.abs(r._cssCache.left-o);z>=.75&&(r._element.css("left",o),r._cssCache.left=o);var A=Math.abs(r._cssCache.top-n);A>=.75&&(r._element.css("top",n),r._cssCache.top=n),k||r._element.fadeIn(1e3)}else k&&r._element.hide()}else k&&r._element.hide()}for(var B=100+h.length,u=0;u<h.length;u++)h[u].hovering===!0?h[u].w.css("z-index",101+h.length):(h[u].w.css("z-index",B),B--)}}},setElement:function(a){null!=this._element&&(this._updateHover(!1),"function"==typeof this._element.remove&&this._element.remove()),this._element=null,null!=a&&(this._element=$(a),this._updateSize(),this._element.remove(),Tundra.client.container.append(this._element),this._updateHover(),this._element.hide(),this._element.css("position","absolute"),null==EC_HtmlBillboard_ThreeJs.UpdateSub&&(EC_HtmlBillboard_ThreeJs.UpdateSub=Tundra.frame.onUpdate(EC_HtmlBillboard_ThreeJs,EC_HtmlBillboard_ThreeJs.Update)))},setUnselectable:function(a){null!=this._element&&(a="boolean"==typeof a?a:!0,this._element.css({cursor:a?"pointer":"auto","user-select":a?"none":"text"}))},_updateHover:function(a){if(null!=this._element){a=a||this.hoverMagnify;var b=this._element.data("HtmlBillboardHoverConnected");a||b!==!0?!a||void 0!==b&&b!==!1||(this._element.hover(this._onHoverIn.bind(this),this._onHoverOut.bind(this)),this.hovering=!1,this._element.data("HtmlBillboardHoverConnected",!0)):(this._element.off("mouseenter mouseleave"),this.hovering=!1,
this._element.data("HtmlBillboardHoverConnected",!1))}},_onHoverIn:function(){this.hovering=!0,this.hovertingT<0&&(this.hovertingT=0)},_onHoverOut:function(){this.hovering=!1,this.hovertingT>1&&(this.hovertingT=1)},hoveringScaleIn:function(a,b){return this.hovering?this.hovertingT>=1?1:(this.hovertingT+=2*a,this.hovertingT>1&&(this.hovertingT=1),b+=this.hovertingT,this.hovertingScale=MathUtils.lerp(b,1,this.hovertingT),this.hovertingScale):b},hoveringScaleOut:function(a,b){return this.hovertingT<=0?void 0:(this.hovertingT-=4*a,MathUtils.lerp(b,this.hovertingScale,this.hovertingT))},_updateSize:function(){null!=this._element&&(this.size.x>=0&&this._element.css("width",this.size.x),this.size.y>=0&&this._element.css("height",this.size.y))},reset:function(){this.setElement(null)},update:function(){},attributeChanged:function(a,b,c){1===a?this._updateSize():2===a&&this._updateHover()},worldPosition:function(a){return null==this.parentEntity||null==this.parentScene?!1:(null!=this.parentEntity.placeable?a.copy(this.parentEntity.placeable.worldPosition()).add(this.position):a.copy(this.position),!0)}}),EC_StencilGlow=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"enabled",!0,Attribute.Bool),this.declareAttribute(1,"color",new Color(1,1,1,.4),Attribute.Color),this.declareAttribute(2,"scale",new THREE.Vector3(1.05,1.05,1.05),Attribute.Float3),this.declareAttribute(3,"blinkFrequency",0,Attribute.Real)},__classvars__:{TypeId:108,TypeName:"StencilGlow"}}),EC_StencilGlow_ThreeJs=EC_StencilGlow.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.glowObject=null,this.glowMaterial=null,this.onUpdateSubscription=null,Tundra.scene.onAttributeChanged(this,function(a,b,c,d,e){a.id==this.parentEntity.id&&20==b.typeId&&2==c&&null!=this.glowObject&&e&&(this.glowObject.visible=this.enabled)})},createMaterial:function(){var a=this.color.toString(!0)+"_"+this.blinkFrequency.toFixed(4)+"_"+MathUtils.roundVector3(this.scale,4).toString(),b=EC_StencilGlow_ThreeJs.MaterialCache[a];void 0===b?(this.glowMaterial=new THREE.ShaderMaterial({uniforms:{c:{type:"f",value:.6},p:{type:"f",value:6},scale:{type:"v3",value:this.scale.clone()},cameraDirection:{type:"v3",value:new THREE.Vector3},glowColor:{type:"v4",value:this.color.toVector4()},time:{type:"f",value:0},blinkFrequency:{type:"f",value:this.blinkFrequency}},vertexShader:EC_StencilGlow_ThreeJs.vertexShader,fragmentShader:EC_StencilGlow_ThreeJs.fragmentShader,side:THREE.FrontSide,blending:THREE.CustomBlending,blendSrc:THREE.SrcAlphaFactor,blendDst:THREE.OneMinusSrcAlphaFactor,transparent:!0}),EC_StencilGlow_ThreeJs.MaterialCache[a]=this.glowMaterial):this.glowMaterial=b},updateMaterial:function(){this.createMaterial();for(var a=0;a<this.glowObject.children.length;++a)this.glowObject.children[a].material=this.glowMaterial},computeSmoothNormals:function(a){if(void 0===a.attributes.normal||void 0===a.attributes.position)return void this.log.error("Geometry needs to have positions and normals.");for(var b=[],c=a.attributes.position,d=a.attributes.normal,e=function(a){for(var d=0;d<b.length;++d)for(var e=b[d],f=0;f<e.length;++f){var g=3*e[f],h=new THREE.Vector3(c.array[g+0],c.array[g+1],c.array[g+2]);if(h.equals(a))return d}return-1},f=c.array.length/c.itemSize,g=(d.array.length/d.itemSize,0),h=0;f>h;++h){var i=new THREE.Vector3(c.array[g+0],c.array[g+1],c.array[g+2]),j=e(i);if(0>j){var k=[h];b.push(k)}else b[j].push(h);g+=3}for(var h=0;h<b.length;++h){for(var l=new THREE.Vector3(0,0,0),m=0;m<b[h].length;++m){var n=b[h][m];l.x+=d.array[3*n+0],l.y+=d.array[3*n+1],l.z+=d.array[3*n+2]}l.x=l.x/b[h].length,l.y=l.y/b[h].length,l.z=l.z/b[h].length,l.normalize();for(var m=0;m<b[h].length;++m){var n=b[h][m];a.attributes.normal.array[3*n+0]=l.x,a.attributes.normal.array[3*n+1]=l.y,a.attributes.normal.array[3*n+2]=l.z}}},create:function(){if(null!=this.glowObject)return void this.log.warn("Already created");if(null==this.parentEntity)return void this.log.error("Parent entity not set!");if(null==this.parentEntity.placeable||null==this.parentEntity.mesh)return void this.log.error("Both Placeable and Mesh components are necessary to be created before this component is added!");if(""==this.parentEntity.mesh.meshRef)return void this.log.error("meshRef attribute of Mesh is empty!");var a=Tundra.asset.requestAsset(this.parentEntity.mesh.meshRef);return null==a?void this.log.error("Error while making an asset transfer to the meshRef!"):void a.onCompleted(this,function(a){if(a.numSubmeshes()<1)return void this.log.error("Mesh asset does not contain any submeshes!");this.glowObject=new THREE.Object3D,this.createMaterial();var b=a.originalName(),c=EC_StencilGlow_ThreeJs.GeometryCache[b];if(void 0===c){c=[];for(var d=0;d<a.numSubmeshes();++d){var e=a.cloneGeometry(a.getSubmesh(d).geometry);this.computeSmoothNormals(e),c.push(e)}EC_StencilGlow_ThreeJs.GeometryCache[b]=c}for(var d=0;d<c.length;++d){var e=c[d],f=new THREE.Mesh(e,this.glowMaterial);this.glowObject.add(f)}this.parentEntity.placeable.sceneNode.add(this.glowObject),this.glowObject.position.copy(this.parentEntity.mesh.nodeTransformation.pos),this.glowObject.rotation.copy(this.parentEntity.mesh.nodeTransformation.euler()),this.glowObject.scale.copy(this.parentEntity.mesh.nodeTransformation.scale),this.onUpdateSubscription=Tundra.frame.onUpdate(this,this.onUpdate),this.parentEntity.mesh.onAttributeChanged(this,function(a,b,c,d,e){0===c&&(this.glowObject.position.copy(this.parentEntity.mesh.nodeTransformation.pos),this.glowObject.rotation.copy(this.parentEntity.mesh.nodeTransformation.euler()),this.glowObject.scale.copy(this.parentEntity.mesh.nodeTransformation.scale))})})},reset:function(){Tundra.events.unsubscribe(this.onUpdateSubscription),Tundra.renderer.scene.remove(this.glowObject),delete this.glowObject,this.glowObject=null},update:function(){this.create()},onUpdate:function(a){if(this.enabled&&null!=this.glowObject)for(var b=0;b<this.glowObject.children.length;++b)this.glowObject.children[b].material.uniforms.time.value+=a},attributeChanged:function(a,b,c){if(null!=this.glowObject)if(0!==a&&this.updateMaterial(),0===a)this.glowObject.visible=c;else if(1===a)for(var d=0;d<this.glowObject.children.length;++d)this.glowObject.children[d].material.uniforms.glowColor.value=this.color.toVector4();else if(2===a)for(var d=0;d<this.glowObject.children.length;++d)this.glowObject.children[d].material.uniforms.scale.value.copy(c);else if(3===a)for(var d=0;d<this.glowObject.children.length;++d)this.glowObject.children[d].material.uniforms.blinkFrequency.value=c;else this.log.error("Invalid index:",a)},__classvars__:{GeometryCache:{},MaterialCache:{},vertexShader:["uniform vec3 cameraDirection;","uniform float c;","uniform float p;","uniform vec3 scale;","void main()","{","float xScale = clamp(scale.x - 1.0, 0.0, 2.0);","float yScale = clamp(scale.y - 1.0, 0.0, 2.0);","float zScale = clamp(scale.z - 1.0, 0.0, 2.0);","gl_Position = projectionMatrix * modelViewMatrix * vec4(position + (normalize(normal) * vec3(xScale, yScale, zScale)), 1.0);","}"].join("\n"),fragmentShader:["uniform vec4 glowColor;","uniform float time;","uniform float blinkFrequency;","void main()","{","float blink = clamp((-cos((5.0 * time * blinkFrequency) - 3.14159265358979) + 1.0), 0.0, 1.0);","gl_FragColor = vec4(glowColor.rgb, glowColor.a * blink);","}"].join("\n")}}),ThreeJsRenderer=IRenderSystem.$extend({__init__:function(){this.$super("three.js"),this.log=TundraLogging.getLogger("ThreeJsRenderer")},__classvars__:{getDefaultOptions:function(){return{antialias:!Tundra.browser.isMobile(),precision:Tundra.browser.isMobile()?"mediump":"highp",logarithmicDepthBuffer:CoreStringUtils.queryValueBool("logdepth"),sortObjects:!0,physicallyBasedShading:!0,devicePixelRatio:1}}},load:function(a){this.options=$.extend(ThreeJsRenderer.getDefaultOptions(),a),this.windowSize={width:Tundra.client.container.width(),height:Tundra.client.container.height()};try{this.renderer=new THREE.WebGLRenderer(this.options),this.renderer.setSize(this.windowSize.width,this.windowSize.height),this.renderer.sortObjects=this.options.sortObjects,this.renderer.physicallyBasedShading=this.options.physicallyBasedShading}catch(b){return this.renderer=null,void this.log.error("Failed to initialize WebGL rendering, aborting startup:",b)}this.setupShadows({enabled:!0,softShadows:!0,drawDebug:!1,clip:{near:50,far:1e3},textureSize:{width:2048,height:2048},bounds:{right:30,left:-30,top:20,bottom:-20}}),this.cssRenderer=null,this.cssRendererScene=null,this.scene=null,this.activeCameraComponent=null,this.camera=null,this.projector=new THREE.Projector,this.raycaster=new THREE.Raycaster,this.raycastResult=new RaycastResult,this.raycastResult._raycastVector=new THREE.Vector3(0,0,0),this.raycastResult._raycastDir=new THREE.Vector3(0,0,0),this.raycastResult._raycastTemp=new THREE.Vector3(0,0,0),this.raycastFromResult=new RaycastResult,this.meshes=[],this.axisX=new THREE.Vector3(1,0,0),this.axisY=new THREE.Vector3(0,1,0),this.axisZ=new THREE.Vector3(0,0,1),$(this.renderer.domElement).attr("id","threejs-webgl-canvas").css("pointer-events","auto"),$(this.renderer.domElement).css({position:"absolute",top:0,left:0}),Tundra.client.container.append(this.renderer.domElement),this.onWindowResize(),window.addEventListener("resize",this.onWindowResize.bind(this),!1),this.materialWhite=new THREE.MeshPhongMaterial({color:this.convertColor("rgb(240,240,240)"),wireframe:!1}),this.materialWhite.name="tundra.MaterialLibrary.SolidWhite",this.materialLoadError=new THREE.MeshPhongMaterial({color:this.convertColor("rgb(240,50,50)"),wireframe:!1}),this.materialLoadError.name="tundra.MaterialLibrary.LoadError",this.registerComponents()},postInitialize:function(){this._sceneObjects={},this._meshLoadedSubs={},this._trackingKey="",Tundra.client.onConnected(this,this.onConnected),Tundra.client.onDisconnected(this,this.onDisconnected),this.onSceneReset(),Tundra.scene.onReset(this,this.onSceneReset)},onConnected:function(){EC_Placeable_ThreeJs.TransformInterpolator=new TransformInterpolator},onDisconnected:function(){EC_Placeable_ThreeJs.TransformInterpolator=void 0},unload:function(){},onSceneReset:function(){Tundra.scene.onComponentCreated(this,this.onSceneComponentCreated),Tundra.scene.onComponentRemoved(this,this.onSceneComponentRemoved)},onSceneComponentCreated:function(a,b){17===b.typeId&&(this._trackingKey=a.id+"."+b.id,this._meshLoadedSubs[this._trackingKey]=b.onMeshLoaded(this,this.onSceneMeshLoaded))},onSceneComponentRemoved:function(a,b){(17===b.typeId||509===b.typeId)&&this.onSceneMeshUnloaded(a,b)},onSceneMeshLoaded:function(a,b,c){this._trackingKey=a.id+"."+b.id,void 0!==this._sceneObjects[this._trackingKey]&&delete this._sceneObjects[this._trackingKey],Array.isArray(this._sceneObjects[this._trackingKey])||(this._sceneObjects[this._trackingKey]=[]);for(var d=0,e=c.numSubmeshes();e>d;++d)this._sceneObjects[this._trackingKey].push(c.getSubmesh(d))},onSceneMeshCreated:function(a,b,c){if(this._trackingKey=a.id+"."+b.id,Array.isArray(this._sceneObjects[this._trackingKey])||(this._sceneObjects[this._trackingKey]=[]),Array.isArray(c))for(var d=0;d<c.length;d++)this._sceneObjects[this._trackingKey].push(c[d]);else this._sceneObjects[this._trackingKey].push(c)},onSceneMeshUnloaded:function(a,b){var c=a.id+"."+b.id;void 0!==this._sceneObjects[c]&&delete this._sceneObjects[c]},_getAllObjects:function(){var a=[];for(var b in this._sceneObjects)a=a.concat(this._sceneObjects[b]);return a},registerComponents:function(){Scene.registerComponent(EC_EnvironmentLight_ThreeJs),Scene.registerComponent(EC_Fog_ThreeJs),Scene.registerComponent(EC_Light_ThreeJs),Scene.registerComponent(EC_Sky_ThreeJs),Scene.registerComponent(EC_SkyX_ThreeJs),Scene.registerComponent(EC_WaterPlane_ThreeJs),Scene.registerComponent(EC_Hydrax_ThreeJs),Scene.registerComponent(EC_AnimationController_ThreeJs),Scene.registerComponent(EC_Camera_ThreeJs),Scene.registerComponent(EC_Mesh_ThreeJs),Scene.registerComponent(EC_Placeable_ThreeJs),Scene.registerComponent(EC_ParticleSystem_ThreeJs),Scene.registerComponent(EC_Billboard_ThreeJs),Scene.registerComponent(EC_HtmlBillboard_ThreeJs),Scene.registerComponent(EC_StencilGlow_ThreeJs)},getCssRenderer:function(){if(null==this.cssRenderer){this.cssRenderer=new THREE.CSS3DRenderer,this.cssRenderer.setSize(this.windowSize.width,this.windowSize.height);var a=$(this.cssRenderer.domElement),b=$(this.renderer.domElement);a.children().first().attr("id","css-renderer-camera").css("pointer-events","none"),a.attr("id","css-renderer-container"),a.css({"pointer-events":"none","background-color":"transparent",position:"absolute",top:0,margin:0,padding:0,"z-index":1}),b.css({"pointer-events":"auto","background-color":"transparent",position:"absolute",top:0,margin:0,padding:0,"z-index":-1}),Tundra.client.container.append(a),a.append(b)}return this.cssRenderer},setDevicePixelRatio:function(a){this.renderer&&"number"==typeof a&&(a=Math.max(.1,a),this.renderer.devicePixelRatio=a,this.onWindowResize())},devicePixelRatio:function(){return this.renderer?this.renderer.devicePixelRatio:ThreeJsRenderer.getDefaultOptions().devicePixelRatio},getCssRendererScene:function(){return null==this.cssRenderer&&this.getCssRenderer(),null==this.cssRendererScene&&(this.cssRendererScene=new THREE.Scene),this.cssRendererScene},addCssObject:function(a){this.getCssRendererScene().add(a),void 0!==a.element&&$(a.element).css({"pointer-events":"auto",visibility:"",display:"","user-select":"","-webkit-user-select":"","-moz-user-select":"","-ms-user-select":""})},removeCssObject:function(a){this.getCssRendererScene().remove(a),void 0!==a.element&&$(a.element).css({"pointer-events":"none",visibility:"hidden",display:"none","user-select":"none","-webkit-user-select":"none","-moz-user-select":"none","-ms-user-select":"none"})},onWindowResize:function(){this.windowSize={width:Tundra.client.container.width(),height:Tundra.client.container.height()},this.renderer.setSize(this.windowSize.width,this.windowSize.height),null!=this.cssRenderer&&this.cssRenderer.setSize(this.windowSize.width,this.windowSize.height),void 0!==this.camera&&null!==this.camera&&(this.camera.aspect=this.windowSize.width/this.windowSize.height,this.camera.updateProjectionMatrix()),(0===this.windowSize.width||0===this.windowSize.height)&&setTimeout(this.onWindowResize.bind(this),100)},reset:function(){if(null!=this.scene){for(var a=function(a,b){b=Array.isArray(b)?b:[b];for(var c=0;c<b.length;c++){var d=b[c];a&&a[d]&&("function"==typeof a[d].dispose?(a[d].dispose(),a[d]=void 0):"object"==typeof a[d].value&&"function"==typeof a[d].value.dispose&&(a[d].value.dispose(),a[d].value=void 0))}};this.scene.children.length>0;){var b=this.scene.children[0];try{b instanceof THREE.Mesh&&(b&&b.material&&(b.material instanceof THREE.ShaderMaterial?"object"==typeof b.material.uniforms&&a(b.material.uniforms,["map","tCube","normalMap"]):a(b.material,["map","lightMap","specularMap","envMap"])),a(b,["material","geometry"]))}catch(c){this.log.error("Exception while removing child from renderer scene:",b,c.stack||c)}this.scene.remove(b),b=null}delete this.scene,this.scene=null}this.scene=new THREE.Scene,this.ambientLight=this.createLight("ambient"),this.ambientLight.color=this.defaultSceneAmbientLightColor().toThreeColor(),this.scene.add(this.ambientLight)},setupShadows:function(a){null!=this.renderer&&void 0!==a&&(void 0===this.shadowSettings&&(this.shadowSettings={},this.shadowSettings.shadowCastingLights=0),void 0!==a.enabled&&(this.shadowSettings.enabled=a.enabled),void 0!==a.softShadows&&(this.shadowSettings.softShadows=a.softShadows),void 0!==a.textureSize&&(this.shadowSettings.textureSize=a.textureSize),void 0!==a.clip&&(this.shadowSettings.clip=a.clip),void 0!==a.bounds&&(this.shadowSettings.bounds=a.bounds),void 0!==a.drawDebug&&(this.shadowSettings.drawDebug=a.drawDebug),Tundra.browser.isMobile()&&(this.shadowSettings.enabled=!1,this.shadowSettings.softShadows=!1,this.shadowSettings.drawDebug=!1),this.renderer.shadowMapEnabled=this.shadowSettings.enabled===!0&&this.shadowSettings.shadowCastingLights>0,this.renderer.shadowMapType=this.shadowSettings.softShadows===!0?THREE.PCFSoftShadowMap:THREE.PCFShadowMap,this.renderer.shadowMapDebug=this.shadowSettings.drawDebug,Tundra.events.send("ThreeJsRenderer.ShadowSettingsChanged",this.shadowSettings))},shadowCastingLightsChanged:function(){this.shadowSettings.shadowCastingLights=0;for(var a=0,b=this.scene.__lights.length;b>a;a++){var c=this.scene.__lights[a];c.castShadow&&(c instanceof THREE.SpotLight&&this.shadowSettings.shadowCastingLights++,c instanceof THREE.DirectionalLight&&!c.shadowCascade&&this.shadowSettings.shadowCastingLights++)}this.setupShadows({enabled:this.shadowSettings.enabled});for(var d=this._getAllObjects(),e=0,f=d.length;f>e;e++)null!=d[e]&&void 0!==d[e].material&&null!==d[e].material&&(d[e].material.needsUpdate=!0)},onShadowSettingsChanged:function(a,b){return Tundra.events.subscribe("ThreeJsRenderer.ShadowSettingsChanged",a,b)},defaultSceneAmbientLightColor:function(){return new Color(.364,.364,.364,1)},getAllMeshes:function(){if(0==this.meshes.length)for(var a=Tundra.client.scene.components("Mesh"),b=0;b<a.length;++b){var c=a[b];if(null!=c.meshAsset&&null!=c.meshAsset.mesh)for(var d=0;d<c.meshAsset.numSubmeshes();++d)this.meshes.push(c.meshAsset.getSubmesh(d))}return this.meshes},update:function(a,b){this.raycastResult.reset(),this.meshes.length>0&&(this.meshes=[]),TWEEN.update(),THREE.AnimationHandler.update(b),this.render()},render:function(){if(void 0!==this.scene&&null!==this.scene&&void 0!==this.camera&&null!==this.camera&&(this.renderer.render(this.scene,this.camera),null!=this.cssRenderer&&null!=this.cssRendererScene)){for(var a=Tundra.scene.components("WebBrowser"),b=0,c=a.length;c>b;b++)a[b].updateCssObjectTransform();this.cssRenderer.render(this.cssRendererScene,this.camera)}},raycastAllFrom:function(a,b,c,d,e,f){return this.raycastFrom(a,b,c,d,e,f,!0)},raycastFrom:function(a,b,c,d,e,f,g){if(c="number"==typeof c&&c>0?c:4294967295,e="boolean"==typeof e?e:!1,f="boolean"==typeof f?f:!1,g="boolean"==typeof g?g:!1,this.raycastFromResult.reset(),this.raycastFromResult.setExecutionInfo(-1,-1,c),void 0===this.raycastFromResult.origin&&(this.raycastFromResult.origin=new THREE.Vector3),this.raycastFromResult.origin.copy(a),void 0===this.raycastFromResult.direction&&(this.raycastFromResult.direction=new THREE.Vector3),this.raycastFromResult.direction.copy(b),void 0===d&&(d=this._getAllObjects()),0===d.length)return this.raycastFromResult;this.raycaster.set(a,b);var h=this.raycaster.intersectObjects(d,f);return this._raycastResults(this.raycaster,h,this.raycastFromResult,c,e,g)},raycastAll:function(a,b,c,d,e,f){return this.raycast(a,b,c,d,e,f,!0)},raycast:function(a,b,c,d,e,f,g){a="number"==typeof a?a:Tundra.input.mouse.x,b="number"==typeof b?b:Tundra.input.mouse.y,c="number"==typeof c&&c>0?c:4294967295,e="boolean"==typeof e?e:!1,f="boolean"==typeof f?f:!1,g="boolean"==typeof g?g:!1;var h=!1;if(void 0!==this.raycastResult._ignoreECModel&&this.raycastResult._ignoreECModel!==e?h=!0:void 0!==this.raycastResult._all&&this.raycastResult._all!==g&&(h=!0),!h&&void 0===d&&!this.raycastResult.hasError()&&this.raycastResult.executionMatches(a,b,c))return this.raycastResult;if(this.raycastResult.reset(),null===a||null===b)return this.raycastResult;if(void 0===this.camera||null===this.camera)return this.raycastResult.setError("No active rendering camera set"),this.raycastResult;if(a>this.windowSize.width||b>this.windowSize.height)return this.raycastResult.setError("x and/or y screen position out of bounds"),this.raycastResult;if(void 0===d&&(d=this._getAllObjects()),0===d.length)return this.raycastResult;if(this.raycastResult.setExecutionInfo(a,b,c),this.raycastResult._ignoreECModel=e,this.raycastResult._all=g,this.raycastResult._raycastVector.x=a/this.windowSize.width*2-1,this.raycastResult._raycastVector.y=2*-(b/this.windowSize.height)+1,this.raycastResult._raycastVector.z=0,this.camera instanceof THREE.PerspectiveCamera)this.raycastResult._raycastVector.z=.5,this.raycastResult._raycastVector.unproject(this.camera),this.activeCameraComponent.parentEntity.placeable.worldPosition(this.raycastResult._raycastTemp),this.raycaster.set(this.raycastResult._raycastTemp,this.raycastResult._raycastVector.sub(this.raycastResult._raycastTemp).normalize());else{if(!(this.camera instanceof THREE.OrthographicCamera))return Tundra.options.usingRequireJS()&&this.log.error("Only THREE.OrthographicCamera and THREE.PerspectiveCamera are supported atm!"),g?[raycastResult]:raycastResult;this.raycastResult._raycastVector.z=-1,this.raycastResult._raycastVector.unproject(this.camera),this.raycastResult._raycastDir.set(0,0,-1).transformDirection(this.camera.matrixWorld),this.raycaster.set(this.raycastResult._raycastVector,dir)}var i=this.raycaster.intersectObjects(d,f);return this._raycastResults(this.raycaster,i,this.raycastResult,c,e,g)},_raycastResults:function(a,b,c,d,e,f){for(var g=f?[]:void 0,h=0,i=b.length;i>h;++h){var j=b[h];if(j.object instanceof THREE.Mesh||j.object instanceof THREE.SkinnedMesh||j.object instanceof THREE.Sprite)if(e||null==j.object.parent||null==j.object.parent.tundraEntityId){if(e){if(c.object=j.object,c.pos.copy(j.point),c.distance=j.distance,c.indices=j.indices,c.face=j.face,c.ray.copy(a.ray),void 0===g)break;g.push(c.clone())}}else{var k=Tundra.scene.entityById(j.object.parent.tundraEntityId);if(null!=k){if(null!=k.placeable){if(!k.placeable.visible)continue;if(0===(k.placeable.selectionLayer&d))continue}if(c.object=j.object,c.pos.copy(j.point),c.distance=j.distance,c.indices=j.indices,c.face=j.face,c.ray.copy(a.ray),void 0!==j.object.tundraSubmeshIndex&&(c.submeshIndex=j.object.tundraSubmeshIndex),c.entity=k,c.component=k.mesh,c.selectionLayer=k.placeable.selectionLayer,void 0===g)break;g.push(c.clone())}}}return void 0!==g?g:c},createLight:function(a,b,c,d){void 0!==b&&(b=this.convertColor(b)),void 0===c&&(c=1),void 0===d&&(d=0);var e=null;return"point"==a?e=new THREE.PointLight(b,c,d):"directional"==a?e=new THREE.DirectionalLight(b,c,d):"spot"==a?e=new THREE.SpotLight(b,c,d,!0):"ambient"==a&&(e=new THREE.AmbientLight(b)),e},convertColor:function(a){if(void 0===a)return void 0;if("#"===a.substr(0,1))return a;var b=/(.*?)rgb\((\d+),(\d+),(\d+)\)/.exec(a),c=parseInt(b[2]),d=parseInt(b[3]),e=parseInt(b[4]);return e|d<<8|c<<16},onActiveCameraChanged:function(a,b){return Tundra.events.subscribe("ThreeJsRenderer.ActiveCameraChanged",a,b)},setActiveCamera:function(a){if(null===a)return void 0!==this.activeCameraComponent&&null!==this.activeCameraComponent&&(this.activeCameraComponent.active=!1),this.camera=null,this.activeCameraComponent=null,!0;if(!(a instanceof EC_Camera_ThreeJs))return this.log.error("[ThreeJsRenderer]: setActiveCamera called with non EC_Camera_ThreeJs component!",a),!1;var b;return this.activeCameraComponent&&(this.activeCameraComponent.active=!1,b=this.activeCameraComponent),this.camera=a.camera,this.activeCameraComponent=a,this.activeCameraComponent.active=!0,Tundra.events.send("ThreeJsRenderer.ActiveCameraChanged",this.activeCameraComponent,b),b=void 0,!0},activeCamera:function(){return this.activeCameraComponent},activeCameraEntity:function(){return null!=this.activeCameraComponent?this.activeCameraComponent.parentEntity:null},activeCameraWorldPosition:function(){var a=this.activeCameraEntity();return a&&a.placeable?a.placeable.worldPosition():void 0},activeCameraWorldFocusPosition:function(){return this.activeCameraComponent&&"function"==typeof this.activeCameraComponent.getWorldFocusPosition?this.activeCameraComponent.getWorldFocusPosition():void 0},createSceneNode:function(){var a=new THREE.Object3D;return a.matrixAutoUpdate=!1,a},updateSceneNode:function(a,b){null!=a&&(a.matrixAutoUpdate===!0&&(a.matrixAutoUpdate=!1),a.position.copy(b.pos),b.copyOrientationTo(a.quaternion),a.scale.copy(b.scale),(a.scale.x<1e-7||a.scale.y<1e-7||a.scale.z<1e-7)&&(0!==a.scale.x||0!==a.scale.y||0!==a.scale.z)&&(this.log.warn("Fixing negative/zero scale",a.scale.toString(),"for object",a.name),a.scale.x<1e-7&&(a.scale.x=1e-7),a.scale.y<1e-7&&(a.scale.y=1e-7),a.scale.z<1e-7&&(a.scale.z=1e-7)),a.updateMatrix(),a.updateMatrixWorld())}}),IInputPlugin=Class.$extend({__init__:function(a){void 0===a&&(console.error("[IInputPlugin]: Constructor called without a plugin name!"),a="Unknown"),this.name=a,this.running=!1,this._registeredInputEvents=[]},__classvars__:{register:function(){var a=new this;InputAPI.registerPlugin(a)}},_start:function(){this.start(),this.running=!0},start:function(){Tundra.client.logError("[IInputPlugin]: Plugin '"+name+"' has not implemented start()")},_stop:function(){this.stop(),this.unregisterEvents(!0),this.running=!1},stop:function(){Tundra.client.logError("[IInputPlugin]: Plugin '"+name+"' has not implemented stop()")},_reset:function(){this.reset(),this.unregisterEvents(!1)},reset:function(){},registerEvent:function(a,b){var c=Tundra.input.registerPluginEvent(a,b);return c===!0&&this._registeredInputEvents.push(b),c},unregisterEvents:function(a){for(var b=0;b<this._registeredInputEvents.length;b++){var c=this._registeredInputEvents[b];"string"==typeof c&&Tundra.events.remove(c)}a===!0&&(this._registeredInputEvents=[])}}),InputEventTouch=IInputEvent.$extend({__init__:function(){this.$super("InputEventTouch"),Object.defineProperties(this,{isMultiTouch:{get:function(){return this.pointers.length>1}}}),this.isFirst=!1,this.isFinal=!1,this.pointers=[],this.changedPointers=[],this.pointerType="",this.event="",this.eventId=0,this.deltaX=0,this.deltaY=0,this.deltaTime=0,this.distance=0,this.angle=0,this.velocityX=0,this.velocityY=0,this.velocity=0,this.direction=0,this.offsetDirection=0,this.scale=1,this.relativeScale=0,this.rotation=0,this.relativeRotation=0,this.center={x:0,y:0},this._start=!1,this._cache={scale:{},rotation:{}},this._clearCache()},__classvars__:{Type:{tap:1,doubletap:2,pan:3,swipe:4,press:5,pinch:6,rotate:7},Event:{Start:1,Move:2,End:4,Cancel:8},Direction:{None:1,Left:2,Right:4,Up:8,Down:16,Horizontal:6,Vertical:24,All:30},CommonHammerProperties:["isFirst","isFinal","pointers","changedPointers","deltaX","deltaY","deltaTime","distance","angle","velocityX","velocityY","velocity","direction","offsetDirection","pointerType"]},clear:function(){this._start=!0},toString:function(){var a=this.name+"{ "+this.basePropertiesToString();return a+"\n    "+this.propertiesToString()+" }"},propertiesToString:function(){return"eventId:"+this.eventId+" event:"+this.event+" first:"+this.isFirst+" last:"+this.isFinal+" pointers:"+this.changedPointers.length+"/"+this.pointers.length+" "+this.pointerType+" delta:("+this.deltaX+","+this.deltaY+") deltaTime:"+this.deltaTime+" distance:"+this.distance+" angle:"+this.angle+" velocity:("+this.velocityX+","+this.velocityY+") direction:"+this.direction+" scale:"+this.scale+" relativeScale:"+this.relativeScale+" rotation:"+this.rotation+" relativeRotation:"+this.relativeRotation},_copyProperties:function(a,b){for(var c=0;c<b.length;c++){var d=b[c];this[d]=a[d]}},_clearCache:function(a){if("string"!=typeof a)for(var b=Object.keys(InputEventTouch.Type),c=0;c<b.length;c++){var a=b[c];this._cache.scale[a]=1,this._cache.rotation[a]=0}else this._cache.scale[a]=1,this._cache.rotation[a]=0},setOriginalEvent:function(a){this.$super(a.srcEvent),this._copyProperties(a,InputEventTouch.CommonHammerProperties),this._preventDefaultFunction=a.preventDefault,this.setType(a.type),this.setEvent(a.eventType),this._start===!0&&(this.clearPosition(),this.clearScaleAndRotation(),this.isFirst=!0,this._start=!1),this.setPosition(a.center.x,a.center.y),this.center.x=a.center.x,this.center.y=a.center.y,this.setScale(a),this.setRotation(a),(this.eventId===Hammer.INPUT_END||this.eventId===Hammer.INPUT_CANCEL)&&(this.clearRelativePosition(),this.clearRelativeScaleAndRotation())},setType:function(a){"pan2"===a&&(a="pan"),this.type=a,this.typeId="number"==typeof InputEventTouch.Type[a]?InputEventTouch.Type[a]:IInputEvent.Type.Unknown},setEvent:function(a){switch(a){case Hammer.INPUT_START:this.event="start",this._start=!0;break;case Hammer.INPUT_MOVE:this.event="move";break;case Hammer.INPUT_END:this.event="end",this.isFinal=!0;break;case Hammer.INPUT_CANCEL:this.event="cancel",this.isFinal=!0;break;default:return this.log.error("setEvent: Invalid event id:",a),this.event="",this.eventId=-1,this.clearPosition(),void this.clearRelativeScaleAndRotation()}this.eventId=a},setPosition:function(a,b){var c=null===this.x,d=null===this.y;this.$super(a,b),c&&(this.relativeX=0),d&&(this.relativeY=0)},clearScaleAndRotation:function(){this.scale=1,this.rotation=0,this._clearCache(this.type)},clearRelativeScaleAndRotation:function(){this.relativeScale=0,this.relativeRotation=0},setScale:function(a){var b=this._cache.scale[a.type];a.pointers.length>1&&"number"==typeof b?this.relativeScale=a.scale-b:this.relativeScale=0,this._cache.scale[a.type]=this.scale=a.scale},setRotation:function(a){var b=this._cache.rotation[a.type];a.pointers.length>1&&"number"==typeof b?this.relativeRotation=a.rotation-b:this.relativeRotation=0,this._cache.rotation[a.type]=this.rotation=a.rotation}}),InputTouchPlugin=IInputPlugin.$extend({__init__:function(a){this.$super("Touch"),this.suppressing={pan:!1},this.hammers=[]},__classvars__:{SimulateWithMouse:Tundra.browser.isMobile(),SuppressMasecPanAfterMultiPan:200},start:function(){this.touch=new InputEventTouch,this.registerTouchEvents(Tundra.client.container),this.registerEvent("TouchEvent","InputTouchPlugin.TouchEvent"),this.registerEvent("TouchPan","InputTouchPlugin.TouchPan"),this.registerEvent("TouchSwipe","InputTouchPlugin.TouchSwipe"),this.registerEvent("TouchPinch","InputTouchPlugin.TouchPinch"),this.registerEvent("TouchRotate","InputTouchPlugin.TouchRotate"),this.registerEvent("TouchPress","InputTouchPlugin.TouchPress"),this.registerEvent("TouchTap","InputTouchPlugin.TouchTap"),this.registerEvent("TouchDoubleTap","InputTouchPlugin.TouchDoubleTap")},stop:function(){for(var a=0;a<this.hammers.length;a++)this.hammers[a].stop(!0),this.hammers[a].destroy();this.hammers=[]},registerTouchEvents:function(a){var b=new Hammer($(a).get(0)),c=new Hammer.Rotate,d=new Hammer.Pinch,e=new Hammer.Pan({event:"pan2",threshold:10,pointers:2,direction:Hammer.DIRECTION_ALL});d.recognizeWith(c),e.recognizeWith([c,d]),b.add([e,d,c]),b.get("pan").set({direction:Hammer.DIRECTION_ALL}),b.get("tap").set({threshold:10}),b.get("doubletap").set({threshold:10,posThreshold:20}),b.on("pan",this._onPanInternal.bind(this)),b.on("pan2",this._onPanInternal.bind(this)),b.on("swipe",this._onSwipeInternal.bind(this)),b.on("pinch",this._onPinchInternal.bind(this)),b.on("rotate",this._onRotateInternal.bind(this)),b.on("press",this._onPressInternal.bind(this)),b.on("tap",this._onTapInternal.bind(this)),b.on("doubletap",this._onDoubleTapInternal.bind(this)),b.on("hammer.input",function(a){a.eventType===Hammer.INPUT_START&&this.touch.clear()}.bind(this)),this.hammers.push(b)},_onPanInternal:function(a){if(this.readTouchEvent(a)){var b=this.touch.isMultiTouch;if(this.touch.eventId===InputEventTouch.Event.End&&b&&!this.suppressing.pan)"number"==typeof InputTouchPlugin.SuppressMasecPanAfterMultiPan&&InputTouchPlugin.SuppressMasecPanAfterMultiPan>0&&(setTimeout(function(){this.suppressing.pan=!1}.bind(this),InputTouchPlugin.SuppressMasecPanAfterMultiPan),this.suppressing.pan=!0);else if(!b&&this.suppressing.pan)return;Tundra.events.send("InputTouchPlugin.TouchPan",this.touch)!==!0&&Tundra.events.send("InputTouchPlugin.TouchEvent",this.touch)}},_onSwipeInternal:function(a){this.readTouchEvent(a)&&Tundra.events.send("InputTouchPlugin.TouchSwipe",this.touch)!==!0&&Tundra.events.send("InputTouchPlugin.TouchEvent",this.touch)},_onPinchInternal:function(a){this.readTouchEvent(a)&&Tundra.events.send("InputTouchPlugin.TouchPinch",this.touch)!==!0&&Tundra.events.send("InputTouchPlugin.TouchEvent",this.touch)},_onRotateInternal:function(a){
this.readTouchEvent(a)&&Tundra.events.send("InputTouchPlugin.TouchRotate",this.touch)!==!0&&Tundra.events.send("InputTouchPlugin.TouchEvent",this.touch)},_onPressInternal:function(a){this.readTouchEvent(a)&&Tundra.events.send("InputTouchPlugin.TouchPress",this.touch)!==!0&&Tundra.events.send("InputTouchPlugin.TouchEvent",this.touch)},_onTapInternal:function(a){this.readTouchEvent(a)&&Tundra.events.send("InputTouchPlugin.TouchTap",this.touch)!==!0&&Tundra.events.send("InputTouchPlugin.TouchEvent",this.touch)},_onDoubleTapInternal:function(a){this.readTouchEvent(a)&&Tundra.events.send("InputTouchPlugin.TouchDoubleTap",this.touch)!==!0&&Tundra.events.send("InputTouchPlugin.TouchEvent",this.touch)},readTouchEvent:function(a){return InputTouchPlugin.SimulateWithMouse===!1&&("mouse"===a.pointerType||a.srcEvent instanceof MouseEvent)?!1:(this.touch.setOriginalEvent(a),!0)},onTouchEvent:function(a,b){return Tundra.events.subscribe("InputTouchPlugin.TouchEvent",a,b)},onTouchPan:function(a,b){return Tundra.events.subscribe("InputTouchPlugin.TouchPan",a,b)}});InputTouchPlugin.register();var ITundraPlugin=Class.$extend({__init__:function(a,b){("string"!=typeof a||""===a)&&console.error("ITundraPlugin constructor must be called with name that is a non-empty string!"),this.framework=null,this.name=a,this.nameAliases="string"==typeof b?[b]:Array.isArray(b)?[].concat(b):[],this.loaded=!1,this.log=TundraLogging.getLogger(this.name)},_setFramework:function(a){this.framework=a},_initialize:function(a){return this.loaded===!0?void this.log("Already loaded!"):(this.initialize(a),void(this.loaded=!0))},pluginPropertyName:function(){return this.name},initialize:function(a){},_postInitialize:function(){this.postInitialize()},postInitialize:function(){},_uninitialize:function(){this.uninitialize(),this.framework=null,this.loaded=!1},uninitialize:function(){}}),OgreShader=Class.$extend({__init__:function(a,b,c){this.type=a,this.blockId=this.type===OgreShader.Type.Vertex?"vertex_program_ref":"fragment_program_ref",this.name="",this.data="",this.params={},this.logging=c||!1,void 0!==b&&"string"==typeof b&&this.deserializeFromData(b)},__classvars__:{Type:{Vertex:0,Fragment:1}},deserializeFromData:function(a){var b=a.indexOf(this.blockId+" ");if(-1!==b){var c=b+this.blockId.length+1;this.name=CoreStringUtils.readLine(a.substring(c),null,!0,!0);var d=a.indexOf("{",c),e=a.indexOf("}",c);-1!==d&&-1!==e&&(this.data=a.substring(d+1,e-1))}this.logging&&""!==this.name&&console.log("  >>",this.blockId+(this.type===OgreShader.Type.Vertex?"  ":""),"'"+this.name+"'")},isValid:function(){return""!==this.name},nameContains:function(a){return""!==this.name&&-1!==this.name.indexOf(a)},nameMatches:function(a){return this.name===a},readNamedParameters:function(a){if(""!==this.data)for(var b in a){var c=a[b];this.namedParameter(b,c)}},namedParameter:function(a,b){if(""===this.data)return void 0;if(void 0!==this.params[a])return this.params[a];var c="param_named "+a;""!==b&&(c+=" "+b),c+=" ";var d=this.data.indexOf(c);if(-1!==d){var e=CoreStringUtils.readLine(this.data.substring(d+c.length),null,!0,!0).split(" "),f={id:a,type:b,value:e};return this.params[a]=f,this.logging&&console.log("     --",a,b,e.join(" ")),f}return void 0},getNamedParameter:function(a,b){var c=this.params[a];if(null!=c&&c.id===a){if("string"==typeof b){if("float2"===b)return c.value.length<2?(console.error("OgreShader: Named parameter value "+a+" does not have enough indexes. Requested "+b+" actual value is",c.value),null):new THREE.Vector2(parseFloat(c.value[0]),parseFloat(c.value[1]));if("float4"===b)return c.value.length<4?(console.error("OgreShader: Named parameter value "+a+" does not have enough indexes. Requested "+b+" actual value is",c.value),null):new THREE.Vector4(parseFloat(c.value[0]),parseFloat(c.value[1]),parseFloat(c.value[2]),parseFloat(c.value[3]));if("float"===b)return c.value.length<1?(console.error("OgreShader: Named parameter value "+a+" does not have enough indexes. Requested "+b+" actual value is",c.value),null):parseFloat(c.value[0]);if("floatarray"==b){for(var d=[],e=0;e<c.value.length;e++){var f=parseFloat(c.value[e]);isNaN(f)?(console.warn("OgreShader: Failed to parse float for floatarray type from",f),d.push(0)):d.push(f)}return d}if("float4array"==b){for(var d=[],e=0;e<c.value.length;e++){var f=parseFloat(c.value[e]);isNaN(f)?(console.warn("OgreShader: Failed to parse float for floatarray type from",f),d.push(0)):d.push(f)}if(d.length<=0)return null;for(var g=[],e=0;e<d.length;e+=4){var f=new THREE.Vector4(0,0,0,0);d.length>=e+1&&(f.x=d[e]),d.length>=e+2&&(f.y=d[e+1]),d.length>=e+3&&(f.z=d[e+2]),d.length>=e+4&&(f.w=d[e+3]),g.push(f)}return g}}return c.value}return null}}),OgreTextureUnit=Class.$extend({__init__:function(a,b,c,d){this.index=a,this.name=b,this.textureRef="",this.logging=d||!1,void 0!==c&&"string"==typeof c&&this.deserializeFromData(c)},deserializeFromData:function(a){this.logging&&(console.log("  >> texture_unit",this.index),""!==this.name&&console.log("     --",this._logPadding("name"),"'"+this.name+"'")),this.data=a,this.texture=this.textureRef=this.readFirstString("texture"),this.addressMode=this.readFirstString("tex_address_mode"),this.alias=this.readString("texture_alias",!0),this.coordSet=this.readInt("tex_coord_set",-1),this.scale=this.readFloat2("scale",1,new THREE.Vector2(1,1)),this.logging===!1&&(this.data=void 0)},_logPadding:function(a){return a},readFirstString:function(a){var b=this.readString(a);return-1!==b.indexOf(" ")&&(b=b.substring(0,b.indexOf(" "))),this.logging&&""!==b&&console.log("     --",this._logPadding(a),"'"+b+"'"),b},readString:function(a,b){a+=" ";var c=this.data.indexOf(a),d=-1!==c?CoreStringUtils.readLine(this.data.substring(c+a.length),null,!0,!0):"";return this.logging&&b===!0&&""!==d&&console.log("     --",this._logPadding(a)+"'"+d+"'"),d},readInt:function(a,b){var c=this.readString(a);return""===c?b:(this.logging&&console.log("     --",this._logPadding(a),parseInt(c)),parseInt(c))},readFloat2:function(a,b,c){void 0===b&&(b=1),void 0===c&&(c=new THREE.Vector2);var d=this.readString(a);if(""===d)return c;var e=d.split(" ");return e.length>=2&&(c.x=Math.min(parseFloat(e[0]),b),c.y=Math.min(parseFloat(e[1]),b),this.logging&&console.log("     --",this._logPadding(a),c.x,c.y)),c}});window=this,"undefined"==typeof console&&(console={log:function(){},error:function(){}});var WebGLTextureUtil=function(){"use strict";function a(a){return a.charCodeAt(0)+(a.charCodeAt(1)<<8)+(a.charCodeAt(2)<<16)+(a.charCodeAt(3)<<24)}function b(a){return String.fromCharCode(255&a,a>>8&255,a>>16&255,a>>24&255)}function c(a,b,c){switch(a){case i:case l:case N:return(b+3>>2)*(c+3>>2)*8;case j:case k:case m:case n:return(b+3>>2)*(c+3>>2)*16;case J:case L:return Math.floor((Math.max(b,8)*Math.max(c,8)*4+7)/8);case K:case M:return Math.floor((Math.max(b,16)*Math.max(c,8)*2+7)/8);default:return 0}}function d(a,b,c,d){console.error(b),a.bindTexture(a.TEXTURE_2D,c),a.texImage2D(a.TEXTURE_2D,0,a.RGB,1,1,0,a.RGB,a.UNSIGNED_BYTE,new Uint8Array([0,0,0])),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),d&&d(c,b,null)}function e(a){return 0===(a&a-1)}function f(a,b){var c=["","WEBKIT_"];"WEBGL_compressed_texture_pvrtc"!==b&&"WEBGL_compressed_texture_atc"!==b&&c.push("MOZ_");var d=null;for(var e in c)if(d=a.getExtension(c[e]+b))break;return d}function g(a,c,d){if(c&&d){var e=new Int32Array(a,0,r);if(e[s]!=o)return d("Invalid magic number in DDS header"),0;if(!e[y]&q)return d("Unsupported format, must contain a FourCC code"),0;var f,g=e[z];switch(g){case A:f=i;break;case B:f=j;break;case C:f=k;break;case D:f=N;break;case E:f=l;break;case F:f=m;break;case G:f=n;break;default:return void d("Unsupported FourCC code: "+b(g))}var h=1;e[u]&p&&(h=Math.max(1,e[x]));var H=e[w],I=e[v],J=e[t]+4,K=new Uint8Array(a,J);c(K,H,I,h,f)}}function h(a,b,c){if(b&&c){var d=new Int32Array(a,0,W);if(d[Y]!=X)return c("Invalid magic number in PVR header"),0;var e,f=d[Z];switch(f){case O:e=K;break;case P:e=M;break;case Q:e=J;break;case R:e=L;break;case S:e=N;break;case T:e=i;break;case U:e=j;break;case V:e=k;break;default:return void c("Unsupported PVR format: "+f)}var g=d[_],h=d[$],l=d[aa],m=d[ba]+52,n=new Uint8Array(a,m);b(n,g,h,l,e)}}var i=33776,j=33778,k=33779,l=35986,m=35987,n=34798,o=542327876,p=131072,q=4,r=31,s=0,t=1,u=2,v=3,w=4,x=7,y=20,z=21,A=a("DXT1"),B=a("DXT3"),C=a("DXT5"),D=a("ETC1"),E=a("ATC "),F=a("ATCA"),G=a("ATCI"),H={cCRNFmtInvalid:-1,cCRNFmtDXT1:0,cCRNFmtDXT3:1,cCRNFmtDXT5:2},I={};I[H.cCRNFmtDXT1]=i,I[H.cCRNFmtDXT3]=j,I[H.cCRNFmtDXT5]=k;var J=35840,K=35841,L=35842,M=35843,N=36196,O=0,P=1,Q=2,R=3,S=6,T=7,U=9,V=5,W=13,X=55727696,Y=0,Z=2,$=6,_=7,aa=11,ba=12,ca=function(){function a(a,b,c,d){var e,f=c/4,g=d%4,h=new Uint32Array(a.buffer,0,(d-g)/4),i=new Uint32Array(b.buffer);for(e=0;e<h.length;e++)i[f+e]=h[e];for(e=d-g;d>e;e++)b[c+e]=a[e]}var b=null,d=null,e=0,f=null;return function(g,h,i){if(h&&i){f||(f=LoadCrunchDecoder());var j=g.byteLength,k=new Uint8Array(g),l=f._malloc(j);a(k,f.HEAPU8,l,j);var m=f._crn_get_dxt_format(l,j);if(!I[m])return void i("Unsupported DXT format");var n,o=f._crn_get_levels(l,j),p=f._crn_get_width(l,j),q=f._crn_get_height(l,j),r=0;for(n=0;o>n;++n)r+=c(I[m],p>>n,q>>n);r>e&&(b&&f._free(b),b=f._malloc(r),d=new Uint8Array(f.HEAPU8.buffer,b,r),e=r),f._crn_decompress(l,j,b,r,0,o),f._free(l),h(d,p,q,o,I[m])}}}(),da=function(){function a(a){var b;h.length?(b=h.shift(),a.loadTexture(b.gl,b.src,b.texture,b.callback)):c[f++]=a}var b=16,c=new Array(b),f=0,g=b,h=[],i=function(a){var b=this;new Uint8Array([0,0,0]);this.gl=null,this.texture=null,this.callback=null,this.image=new Image,this.image.addEventListener("load",function(){var c=b.gl;c.bindTexture(c.TEXTURE_2D,b.texture);var d=Date.now();c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,b.image),e(b.image.width)&&e(b.image.height)?(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR_MIPMAP_NEAREST),c.generateMipmap(c.TEXTURE_2D)):(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR));var f=Date.now()-d;if(b.callback){var g={width:b.image.width,height:b.image.height,internalFormat:c.RGBA,levelZeroSize:b.image.width*b.image.height*4,uploadTime:f};b.callback(b.texture,null,g)}a(b)},!1),this.image.addEventListener("error",function(c){d(b.gl,"Image could not be loaded",b.texture,b.callback),a(b)},!1)};i.prototype.loadTexture=function(a,b,c,d){this.gl=a,this.texture=c,this.callback=d,this.image.src=b};var j=function(a,b,c,d){this.gl=a,this.src=b,this.texture=c,this.callback=d};return function(b,d,e,k){var l;return f?(l=c[--f],l.loadTexture(b,d,e,k)):g?(l=new i(a),l.loadTexture(b,d,e,k),--g):h.push(new j(b,d,e,k)),e}}();if(void 0!==window.document){var ea=0,fa=function(a,b){this.id=ea++,this.texture=a,this.callback=b},ga=!1,ha=function(a){if(this.gl=a,this.worker=null,this.dxtExt=f(a,"WEBGL_compressed_texture_s3tc"),this.pvrtcExt=f(a,"WEBGL_compressed_texture_pvrtc"),this.atcExt=f(a,"WEBGL_compressed_texture_atc"),this.etc1Ext=f(a,"WEBGL_compressed_texture_etc1"),ga&&this.supportsDXT()){var b=this;this.pendingTextures={},this.worker=new Worker("js/webgl-texture-util.js"),this.worker.onmessage=function(a){var c=a.data.id,e=b.pendingTextures[c];return e?(delete b.pendingTextures[c],a.data.error?void d(b.gl,a.data.error,e.texture,e.callback):b._formatSupported(a.data.internalFormat)?void b._uploadCompressedData(new Uint8Array(a.data.dxtData),a.data.width,a.data.height,a.data.levels,a.data.internalFormat,e.texture,e.callback):void d(b.gl,"Texture format not supported",e.texture,e.callback)):void 0}}};return ha.prototype._formatSupported=function(a){switch(a){case i:case j:case k:return!!this.dxtExt;case J:case L:case K:case M:return!!this.pvrtcExt;case l:case m:case n:return!!this.atcExt;case N:return!!this.etc1Ext;default:return!1}},ha.prototype._uploadCompressedData=function(a,b,d,e,f,g,h){var i=this.gl;i.bindTexture(i.TEXTURE_2D,g);for(var j=0,k={width:b,height:d,internalFormat:f,levelZeroSize:c(f,b,d),uploadTime:0},l=Date.now(),m=0;e>m;++m){var n=c(f,b,d),o=new Uint8Array(a.buffer,a.byteOffset+j,n);i.compressedTexImage2D(i.TEXTURE_2D,m,f,b,d,0,o),b>>=1,d>>=1,j+=n}k.uploadTime=Date.now()-l,e>1?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR_MIPMAP_NEAREST)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR)),h&&h(g,null,k)},ha.prototype.supportsDXT=function(){return!!this.dxtExt},ha.prototype.supportsPVRTC=function(){return!!this.pvrtcExt},ha.prototype.supportsATC=function(){return!!this.atcExt},ha.prototype.supportsETC1=function(){return!!this.etc1Ext},ha.prototype.loadIMG=function(a,b,c){return b||(b=this.gl.createTexture()),da(gl,a,b,c),b},ha.prototype.loadDDS=function(a,b,c){var e=this;b||(b=this.gl.createTexture());var f=new XMLHttpRequest;return f.addEventListener("load",function(a){200==f.status?g(f.response,function(a,f,g,h,i){return e._formatSupported(i)?void e._uploadCompressedData(a,f,g,h,i,b,c):void d(e.gl,"Texture format not supported",b,c)},function(a){d(e.gl,a,b,c)}):d(e.gl,f.statusText,b,c)},!1),f.open("GET",a,!0),f.responseType="arraybuffer",f.send(null),b},ha.prototype.parseDDS=g,ha.prototype.isPowerOfTwo=e,ha.prototype.loadCRN=function(a,b,c){var e=this;if(b||(b=this.gl.createTexture()),!this.supportsDXT())return d(this.gl,"Texture format not supported",b,c),b;if(this.worker){var f=new fa(b,c);this.pendingTextures[f.id]=f,this.worker.postMessage({id:f.id,src:a})}else{var g=new XMLHttpRequest;g.addEventListener("load",function(a){200==g.status?ca(g.response,function(a,f,g,h,i){return e._formatSupported(i)?void e._uploadCompressedData(a,f,g,h,i,b,c):void d(e.gl,"Texture format not supported",b,c)},function(a){d(e.gl,a,b,c)}):d(e.gl,g.statusText,b,c)},!1),g.open("GET",a,!0),g.responseType="arraybuffer",g.send(null)}return b},ha.prototype.decompressCRN=ca,ha.prototype.loadPVR=function(a,b,c){var e=this;b||(b=this.gl.createTexture());var f=new XMLHttpRequest;return f.addEventListener("load",function(a){200==f.status?h(f.response,function(a,f,g,h,i){return e._formatSupported(i)?void e._uploadCompressedData(a,f,g,h,i,b,c):void d(e.gl,"Texture format not supported",b,c)},function(a){d(e.gl,a,b,c)}):d(e.gl,f.statusText,b,c)},!1),f.open("GET",a,!0),f.responseType="arraybuffer",f.send(null),b},ha.prototype.loadTexture=function(a,b,c){var d=/(?:\.([^.]+))?$/,e=d.exec(a)[1]||"";switch(e=e.toLowerCase()){case"crn":return this.loadCRN(a,b,c);case"dds":return this.loadDDS(a,b,c);case"pvr":return this.loadPVR(a,b,c);default:return this.loadIMG(a,b,c)}},ha.prototype.makeSolidColor=function(a,b,c,d,e){var f=this.gl,g=new Uint8Array([a,b,c,d]);return e||(e=f.createTexture()),f.bindTexture(f.TEXTURE_2D,e),f.texImage2D(f.TEXTURE_2D,0,f.RGBA,1,1,0,f.RGBA,f.UNSIGNED_BYTE,g),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST),e},ha}onmessage=function(a){function b(a,b,c,d,f){postMessage({id:e,dxtData:a,width:b,height:c,levels:d,internalFormat:f})}function c(a){postMessage({id:e,error:a})}var d=a.data.src,e=a.data.id,f=new XMLHttpRequest;f.addEventListener("load",function(a){200==f.status?ca(f.response,b,c):c(f.statusText)},!1),f.open("GET","../"+d,!0),f.responseType="arraybuffer",f.send(null)}}(),TextureAsset=IAsset.$extend({__init__:function(a){this.$super(a,"TextureAsset"),this.texture=null,this.cubeTexture=null,this._instances=[],this.instanceUsed=!1},__classvars__:{__init__:function(a){TextureAsset.WebGLTextureLoader=new WebGLTextureUtil(a.renderer.renderer.getContext());var b=a.renderer.renderer.supportsCompressedTextureS3TC();null!==b&&void 0!==b&&b!==!1||TextureAsset.WebGLTextureLoader.supportsDXT()===!0||(TextureAsset.SupportsDXT=!1),TextureAsset.SupportsETC1=TextureAsset.WebGLTextureLoader.supportsETC1(),TextureAsset.SupportsPVR=TextureAsset.WebGLTextureLoader.supportsPVRTC(),Tundra.browser.isMobile()&&(TextureAsset.EnabledFormat=TextureAsset.SupportsETC1?"etc1":TextureAsset.SupportsPVR?"pvr":""),console.log("[TextureAsset]: Compression support DXT:"+TextureAsset.SupportsDXT,"ETC1:"+TextureAsset.SupportsETC1,"PVR:"+TextureAsset.SupportsPVR,"Enabled format:'"+TextureAsset.EnabledFormat+"'")},SupportsDXT:!0,SupportsETC1:!1,SupportsPVR:!1,EnabledFormat:"",Format:{COMPRESSED_RGB_S3TC_DXT1_EXT:33776,COMPRESSED_RGBA_S3TC_DXT1_EXT:33777,COMPRESSED_RGBA_S3TC_DXT3_EXT:33778,COMPRESSED_RGBA_S3TC_DXT5_EXT:33779,COMPRESSED_RGB_ETC1_WEBGL:36196,COMPRESSED_RGB_PVRTC_4BPPV1_IMG:35840,COMPRESSED_RGB_PVRTC_2BPPV1_IMG:35841,COMPRESSED_RGBA_PVRTC_4BPPV1_IMG:35842,COMPRESSED_RGBA_PVRTC_2BPPV1_IMG:35843,COMPRESSED_RGB_ATC_WEBGL:35986,COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL:35987,COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL:34798},DDSLoader:new THREE.DDSLoader,WebGLTextureLoader:null,DIFFUSE:0,SPECULAR:1,NORMAL:2,LIGHT:3,REFLECTION:4,SHADOW:5,DIFFUSE2:6,MESHMOON_TEXTURE:7,MAX_TEXTURE_TYPE:8,typeToString:function(a){return a===TextureAsset.DIFFUSE?"DIFFUSE":a===TextureAsset.DIFFUSE2?"DIFFUSE2":a===TextureAsset.SPECULAR?"SPECULAR":a===TextureAsset.NORMAL?"NORMAL":a===TextureAsset.LIGHT?"LIGHT":a===TextureAsset.REFLECTION?"REFLECTION":a===TextureAsset.SHADOW?"SHADOW":"Unkown texture type "+a.toString()},typeFromString:function(a){return"DIFFUSE"===a?TextureAsset.DIFFUSE:"DIFFUSE2"===a?TextureAsset.DIFFUSE2:"SPECULAR"===a?TextureAsset.SPECULAR:"NORMAL"===a?TextureAsset.NORMAL:"LIGHT"===a?TextureAsset.LIGHT:"REFLECTION"===a?TextureAsset.REFLECTION:"SHADOW"===a?TextureAsset.SHADOW:-1},formatToString:function(a){if("number"==typeof a){if(a===THREE.AlphaFormat)return"Alpha";if(a===THREE.RGBFormat)return"RGB";if(a===THREE.LuminanceFormat)return"Luminance";if(a===THREE.LuminanceAlphaFormat)return"LuminanceAlpha";if(a===THREE.RGB_S3TC_DXT1_Format)return"RGB_S3TC_DXT1";if(a===THREE.RGBA_S3TC_DXT1_Format)return"RGBA_S3TC_DXT1";if(a===THREE.RGBA_S3TC_DXT3_Format)return"RGBA_S3TC_DXT3";if(a===THREE.RGBA_S3TC_DXT5_Format)return"RGBA_S3TC_DXT5"}return"INVALID_TEXTURE_FORMAT"},filterToString:function(a){if("number"==typeof a){if(a===THREE.NearestFilter)return"Nearest";if(a===THREE.NearestMipMapNearestFilter)return"NearestMipMapNearest";if(a===THREE.NearestMipMapLinearFilter)return"NearestMipMapLinear";if(a===THREE.LinearFilter)return"Linear";if(a===THREE.LinearMipMapNearestFilter)return"LinearMipMapNearest";if(a===THREE.LinearMipMapLinearFilter)return"LinearMipMapLinear"}return"INVALID_TEXTURE_FILTER"},addressModeFromString:function(a){return"wrap"===a||""===a?THREE.RepeatWrapping:"clamp"===a?THREE.ClampToEdgeWrapping:"mirror"===a?THREE.MirroredRepeatWrapping:THREE.RepeatWrapping}},isLoaded:function(){return null!==this.texture&&void 0!==this.texture.mipmaps&&null!==this.texture.mipmaps},unload:function(){null!=this.texture&&this.texture.dispose(),this.texture=null,null!=this.cubeTexture&&this.cubeTexture.dispose(),this.cubeTexture=null},height:function(){return this.isLoaded()&&null!=this.texture&&null!=this.texture.image?this.texture.image.height:-1},width:function(){return this.isLoaded()&&null!=this.texture&&null!=this.texture.image?this.texture.image.width:-1},numMipmaps:function(){return this.isLoaded()&&null!=this.texture&&null!=this.texture.mipmaps?this.texture.mipmaps.length:-1},getOrCreateInstance:function(a){if(void 0===this.texture||null===this.texture)return null;if(a.type===TextureAsset.REFLECTION){if(null===this.cubeTexture){if(this.texture.image.width!==this.texture.image.height)return this.log.warn("Cannot create reflection cube map from texture with width != height:",this.texture.image.width,"x",this.texture.image.height,"in",this.name),null;this.cubeTexture=new THREE.CompressedTexture,this.cubeTexture.name=this.texture.name,this.cubeTexture.wrapS=this.texture.wrapS,this.cubeTexture.wrapT=this.texture.wrapT,this.cubeTexture.magFilter=this.texture.magFilter,this.cubeTexture.minFilter=this.texture.minFilter,this.cubeTexture.format=this.texture.format,this.cubeTexture.anisotropy=this.texture.anisotropy,this.cubeTexture.needsUpdate=!0,this.cubeTexture.image=[];for(var b=0;6>b;++b)this.cubeTexture.image.push(this.texture)}return this.cubeTexture}var c={repeat:a.scale,addressModeString:a.addressMode,addressMode:TextureAsset.addressModeFromString(a.addressMode),matches:function(a){var b=a.texture;return this.repeat.x===b.repeat.x&&this.repeat.y===b.repeat.y&&this.addressMode===b.wrapS&&this.addressMode===b.wrapT?!0:!1},clone:function(a){var b=a.clone();return this.apply(b),b},apply:function(a){a.texture.repeat=this.repeat.clone(),a.texture.wrapS=this.addressMode,a.texture.wrapT=this.addressMode,a.texture.needsUpdate=!0,a.instanceUsed=!0},toString:function(){return"repeat = "+this.repeat.x+","+this.repeat.y+" addressMode = "+this.addressModeString},textureId:function(a){return a.name.substring(a.name.lastIndexOf("/")+1)}};if(!c.matches(this)){if(!this.instanceUsed)return this.logging&&this.log.info("Modifying base instance with",c.toString(),c.textureId(this)),c.apply(this),this.texture;for(var b=0,d=this.numClones();d>b;++b){var e=Tundra.asset.getAsset(this.cloneName(b));if(null!=e&&null!=e.texture&&c.matches(e))return this.logging&&this.log.info("Found existing instance",c.toString(),c.textureId(e)),e.texture}var f=c.clone(this);return this._instances.push(f.texture),this.logging&&this.log.info("Cloned instance",c.toString(),c.textureId(f)),f.texture}return this.logging&&this.log.info("Returning base instance",c.toString(),c.textureId(this)),this.instanceUsed=!0,this.texture},_cloneImpl:function(a){var b=new TextureAsset(a);return b.texture=this.texture.clone(),b.texture.name=a,b.texture.needsUpdate=!0,b},deserializeFromData:function(a,b,c){if(null!=this.texture)return this.log.warn("Texture already loaded: "+this.name),!1;if(".png"===c.proxyMetadata.type)return THREE.ImageUtils.crossOrigin="anonymous",THREE.ImageUtils.loadTexture(c.proxyRef,void 0,function(a){this.texture=a,this.texture.width=a.image.width,this.texture.height=a.image.height,this.texture.flipY=!1,this._emitLoaded()}.bind(this),function(a){this._emitFailed("Failed to load png via <img>")}.bind(this)),!0;if(TextureAsset.SupportsDXT===!1||""!==TextureAsset.EnabledFormat&&"dxt"!==TextureAsset.EnabledFormat)return TextureAsset.SupportsETC1===!0&&"etc1"===TextureAsset.EnabledFormat?(TextureAsset.WebGLTextureLoader.parseDDS(a,function(a,b,c,d,e){if(e!==TextureAsset.Format.COMPRESSED_RGB_ETC1_WEBGL)return void this.log.error("Decoded compression format",e,"is not ETC1 and cannot be loaded.");this.texture=new THREE.CompressedTexture,this.texture.name=this.name,this.texture.mipmaps=[];for(var f=0;f<d.length;f++)this.texture.mipmaps.push({fake:"is_fake"});this.texture.image.width=b,this.texture.image.height=c,this.texture.generateMipmaps=!1,this.texture.wrapS=THREE.RepeatWrapping,this.texture.wrapT=THREE.RepeatWrapping,this.texture.magFilter=THREE.LinearFilter,this.texture.minFilter=THREE.LinearFilter,this.texture.anisotropy=4,Tundra.renderer.renderer.info.memory.textures++,this.texture.needsUpdate=!1,this.texture.__webglInit=!0,this.texture.__webglTexture=TextureAsset.WebGLTextureLoader.gl.createTexture(),TextureAsset.WebGLTextureLoader._uploadCompressedData(a,b,c,d,e,this.texture.__webglTexture,function(a,b,c){var d=TextureAsset.WebGLTextureLoader.gl;d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,this.flipY),d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),d.pixelStorei(d.UNPACK_ALIGNMENT,this.unpackAlignment);var e=TextureAsset.WebGLTextureLoader.isPowerOfTwo(c.width)&&TextureAsset.WebGLTextureLoader.isPowerOfTwo(c.height);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,e?d.NEAREST:d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,e?d.NEAREST_MIPMAP_NEAREST:d.LINEAR)}.bind(this.texture))}.bind(this),function(a){this.log.error("Failed to load ETC1 texture:",a)}.bind(this)),this.isLoaded()):(this.log.error("Cannot load texture: Enabled profile '"+TextureAsset.EnabledFormat+"' asset ref:",this.name),!1);var d=TextureAsset.DDSLoader.parse(a,!0);return null==d||null==d.format?!1:(this.texture=new THREE.CompressedTexture,this.texture.name=this.name,this.texture.wrapS=THREE.RepeatWrapping,this.texture.wrapT=THREE.RepeatWrapping,this.texture.magFilter=THREE.LinearFilter,this.texture.minFilter=THREE.LinearFilter,this.texture.format=d.format,this.texture.mipmaps=d.mipmaps,this.texture.width=this.texture.image.width=d.width,this.texture.height=this.texture.image.height=d.height,this.texture.anisotropy=4,this.texture.generateMipmaps=!1,this.texture.needsUpdate=!0,void 0!==this.texture.mipmaps&&null!==this.texture.mipmaps?this.texture.mipmaps.length>1&&(this.texture.magFilter=THREE.NearestFilter,this.texture.minFilter=THREE.NearestMipMapNearestFilter):this.log.error("Mipmaps null after loading for "+this.name,!0),this.logging&&this.dumpDebugInfo(),this.texture.addEventListener("dispose",this._onTextureDispose.bind(this)),delete d,d=null,!0)},dumpDebugInfo:function(){this.log.debug(this.name),this.log.debug("  -- loaded  "+this.isLoaded()),this.log.debug("  -- format  "+TextureAsset.formatToString(this.isLoaded()?this.texture.format:void 0)),this.log.debug("  -- filters min = "+TextureAsset.filterToString(this.isLoaded()?this.texture.minFilter:void 0)+" mag = "+TextureAsset.filterToString(this.isLoaded()?this.texture.magFilter:void 0)),this.log.debug("  -- size    "+this.width()+" x "+this.height()),this.log.debug("  -- mipmaps "+this.numMipmaps()),this.log.debug("")},_onTextureDispose:function(a){if(null!=this.texture||null!=this.cubeTexture){for(var b=[null!=this.texture?this.texture.uuid:this.cubeTexture.uuid],c=0;c<this._instances.length;c++)b.push(this._instances[c].uuid),this._instances[c].dispose();for(var d=function(a){for(var c=0,d=b.length;d>c;++c)if(b[c]===a)return!0;return!1},e=0,f=Tundra.renderer.getAllMeshes(),g=0,h=f.length;h>g;g++){var i=f[g].material;if(null!=f[g].material){var j=e;i instanceof THREE.ShaderMaterial?null!=i.uniforms&&(null!=i.uniforms.map1&&null!=i.uniforms.map1.value&&d(i.uniforms.map1.value.uuid)&&(this.logging&&console.log("  uniform map1"),e++,i.uniforms.map1.value=null),null!=i.uniforms.map2&&null!=i.uniforms.map2.value&&d(i.uniforms.map2.value.uuid)&&(this.logging&&console.log("  uniform map2"),e++,i.uniforms.map2.value=null),null!=i.uniforms.tCube&&null!=i.uniforms.tCube.value&&d(i.uniforms.tCube.value.uuid)&&(this.logging&&console.log("  uniform tCube"),e++,i.uniforms.tCube.value=null),null!=i.uniforms.map&&null!=i.uniforms.map.value&&d(i.uniforms.map.value.uuid)&&(this.logging&&console.log("  uniform map"),e++,i.uniforms.map.value=null),null!=i.uniforms.normalMap&&null!=i.uniforms.normalMap.value&&d(i.uniforms.normalMap.value.uuid)&&(this.logging&&console.log("  uniform normalMap"),e++,i.uniforms.normalMap.value=null)):i instanceof THREE.Material&&(null!=i.map&&d(i.map.uuid)&&(this.logging&&console.log("  map"),e++,i.map=null),null!=i.lightMap&&d(i.lightMap.uuid)&&(this.logging&&console.log("  lightMap"),e++,i.lightMap=null),null!=i.specularMap&&d(i.specularMap.uuid)&&(this.logging&&console.log("  specularMap"),e++,i.specularMap=null),null!=i.normalMap&&d(i.normalMap.uuid)&&(this.logging&&console.log("  normalMap"),e++,i.normalMap=null),null!=i.envMap&&d(i.envMap.uuid)&&(this.logging&&console.log("  envMap"),e++,i.envMap=null)),j!=e&&(i.needsUpdate=!0)}}this._instances=[],null!=this.texture&&(this.texture.mipmaps=[]),this.texture=null,null!=this.cubeTexture&&(this.cubeTexture.mipmaps=[]),this.cubeTexture=null}}}),MeshmoonBaseShader={"meshmoon/VertexShader":[THREE.ShaderChunk.logdepthbuf_pars_vertex,"attribute vec3 tangent;","varying vec3 onormal;","#ifdef NORMAL_MAPPING","varying vec3 otangent;","#endif","varying vec3 oworldPosition;","#ifdef SHADOW_MAPPING","varying vec4 oshadowLightspacePos;","#endif","#if defined(WEIGHTED_DIFFUSE) || defined(DIFFUSE_MAPPING) || defined(NORMAL_MAPPING)","varying vec3 otexCoord0;","#endif","#ifdef LIGHT_MAPPING","varying vec2 otexCoord1;","#endif","void main()","{","    gl_Position = ((projectionMatrix * modelViewMatrix) * vec4(position, 1));","    onormal = normalize((modelMatrix * vec4(normal, 0)).xyz);","    vec4 worldPosition = (modelMatrix * vec4(position, 1));","    oworldPosition = worldPosition.xyz;","#ifdef NORMAL_MAPPING","    otangent = normalize((modelMatrix * vec4(tangent, 0)).xyz);","#endif","#ifdef SHADOW_MAPPING","    CALCULATE_SHADOW_COORDINATES","#endif","#if defined(WEIGHTED_DIFFUSE) || defined(DIFFUSE_MAPPING) || defined(NORMAL_MAPPING)","    otexCoord0.xy = uv;","#endif","#ifdef LIGHT_MAPPING","    otexCoord1 = uv2;","#endif",THREE.ShaderChunk.logdepthbuf_vertex,"}"].join("\n"),"meshmoon/FragmentShader":["#extension GL_OES_standard_derivatives : enable",THREE.ShaderChunk.logdepthbuf_pars_fragment,"#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightDirection[MAX_DIR_LIGHTS];","uniform vec3 directionalLightColor[MAX_DIR_LIGHTS];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightPosition[MAX_POINT_LIGHTS];","uniform vec3 pointLightColor[MAX_POINT_LIGHTS];","uniform float pointLightDistance[MAX_POINT_LIGHTS];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[MAX_SPOT_LIGHTS];","uniform vec3 spotLightPosition[MAX_SPOT_LIGHTS];","uniform vec3 spotLightDirection[MAX_SPOT_LIGHTS];","uniform float spotLightDistance[MAX_SPOT_LIGHTS];","uniform float spotLightAngleCos[MAX_SPOT_LIGHTS];","uniform float spotLightExponent[MAX_SPOT_LIGHTS];","#endif","uniform vec3 ambientLightColor;","uniform vec4 mainColor;","// Weighted diffuse mapping","#ifdef WEIGHTED_DIFFUSE","uniform vec2 weightMapTiling;","uniform vec4 diffuseMapTilings[2];","uniform sampler2D weightMap;","uniform sampler2D diffuseMap1;","uniform sampler2D diffuseMap2;","uniform sampler2D diffuseMap3;","uniform sampler2D diffuseMap4;","#endif","// Diffuse mapping","#ifdef DIFFUSE_MAPPING","uniform vec2 diffuseMapTiling;","uniform sampler2D diffuseMap;","#endif","#ifdef MULTI_DIFFUSE","uniform vec2 diffuseMap2Tiling;","uniform sampler2D diffuseMap2;","#endif","#ifdef NORMAL_MAPPING","uniform vec2 normalMapTiling;","uniform sampler2D normalMap;","#endif","#ifdef SPECULAR_MAPPING","uniform vec2 specularMapTiling;","uniform sampler2D specularMap;","#endif","#ifdef LIGHT_MAPPING","uniform vec2 lightMapTiling;","uniform float lightMapPower;","uniform sampler2D lightMap;","#endif","//#define DEBUG_CSM","#ifdef SHADOW_MAPPING","#ifdef CSM_SHADOWS","#endif","#endif","#ifdef DIFFUSE_LIGHTING","// Light parameters","#endif","#ifdef SPOTLIGHTS_ENABLED","// Spot lights","uniform vec4 spotLightDirections[MAX_LIGHT_COUNT];","uniform vec4 spotLightParams[MAX_LIGHT_COUNT];","#endif","#ifdef SPECULAR_LIGHTING","// Specular parameters","uniform float specularPower;","uniform float specularHardness;","uniform vec4 specularColor;","#endif","#ifdef WEIGHTED_DIFFUSE","vec4 SampleWeightMap(vec2 texCoord)","{","    return texture2D(weightMap, texCoord);","}","vec4 SampleDiffuseMap1(vec2 texCoord)","{","    return texture2D(diffuseMap1, texCoord);","}","vec4 SampleDiffuseMap2(vec2 texCoord)","{","    return texture2D(diffuseMap2, texCoord);","}","vec4 SampleDiffuseMap3(vec2 texCoord)","{","    return texture2D(diffuseMap3, texCoord);","}","vec4 SampleDiffuseMap4(vec2 texCoord)","{","    return texture2D(diffuseMap4, texCoord);","}","#endif","#ifdef DIFFUSE_MAPPING","vec4 SampleDiffuseMap(vec2 texCoord)","{","    return texture2D(diffuseMap, texCoord);","}","#ifdef MULTI_DIFFUSE","vec4 SampleDiffuseMap2(vec2 texCoord)","{","    return texture2D(diffuseMap2, texCoord);","}","#endif","#endif","#ifdef NORMAL_MAPPING","vec3 SampleNormalMap(vec2 texCoord)","{","#ifdef UNITY","    vec4 normal = texture2D(normalMap, texCoord);","    normal.xy = normal.wy * 2 - 1;","    normal.z = sqrt(1 - clamp(dot(normal.xy, normal.xy), 0.0, 1.0));","    normal.y *= -1;","    return normalize(normal.xyz);","#else","    vec3 normal = texture2D(normalMap, texCoord).xyz;","    normal = 2.0 * normal - 1.0;","    return normalize(normal);","#endif","}","#endif","#ifdef NORMAL_MAPPING","#ifdef WEBGL","mat3 transpose(mat3 m)","{","  mat3 r;","  r[0][0] = m[0][0];","  r[1][0] = m[0][1];","  r[2][0] = m[0][2];","  r[0][1] = m[1][0];","  r[1][1] = m[1][1];","  r[2][1] = m[1][2];","  r[0][2] = m[2][0];","  r[1][2] = m[2][1];","  r[2][2] = m[2][2];","  return r;","}","#endif","mat3 TangentToWorldSpace(vec3 normal, vec3 tangent)","{","    vec3 biTangent = normalize(cross(normal, tangent));","    return transpose(mat3(tangent, biTangent, normal));","}","#endif","#ifdef SPECULAR_MAPPING","float SampleSpecularMap(vec2 texCoord)","{","    return texture2D(specularMap, texCoord).r;","}","#endif","#ifdef LIGHT_MAPPING","vec4 SampleLightMap(vec2 texCoord)","{","    return texture2D(lightMap, texCoord);","}","#endif","#ifdef DIFFUSE_LIGHTING","float ComputeLightAttenuation(float lightDistance, float range, float intensity)","{","    // Range                                = lightAttenuation.x","    // Constant attenuation/intensity       = lightAttenuation.y","    // Linear attenuation                   = lightAttenuation.z","    // Quadratic attenuation                = lightAttenuation.w","    // Unity's light attenuation model with a little tweak to ensure that it falls to zero.","    float normalizedDistance = max(0.0, lightDistance / range);","    return max(0.0, 1.0 / (0.65 + 8.5 * normalizedDistance + 3.5 * (normalizedDistance * normalizedDistance)) - 0.08) * intensity;","}","#endif","#ifdef SPECULAR_LIGHTING","float ComputeLightBlinnPhongSpecularFactor(vec3 normal, vec3 lightDir, vec3 viewDir, float NdotL)","{","    // Half vector","    vec3 H = normalize(lightDir + viewDir);","    //Intensity of the specular light","    float NdotH = clamp(dot(normal, H), 0.0, 1.0);","    //Sum up the specular light factoring","    return pow(NdotH, specularHardness) * clamp(NdotL * 4.0, 0.0, 1.0);","}","#endif","#ifdef SHADOW_MAPPING","SHADOW_MAPPING_INCLUDES","#endif","varying vec3 onormal;","#ifdef NORMAL_MAPPING","varying vec3 otangent;","#endif","varying vec3 oworldPosition;","#ifdef SHADOW_MAPPING","varying vec4 oshadowLightspacePos;","#endif","#if defined(WEIGHTED_DIFFUSE) || defined(DIFFUSE_MAPPING) || defined(NORMAL_MAPPING)","varying vec3 otexCoord0;","#endif","#ifdef LIGHT_MAPPING","varying vec2 otexCoord1;","#endif","void main()","{","#ifdef WEIGHTED_DIFFUSE","    vec4 weights = SampleWeightMap(otexCoord0.xy * weightMapTiling);","    vec4 diffuseColor;","    diffuseColor += weights.x * SampleDiffuseMap1(otexCoord0.xy * diffuseMapTilings[0].xy);","    diffuseColor += weights.y * SampleDiffuseMap2(otexCoord0.xy * diffuseMapTilings[0].zw);","    diffuseColor += weights.z * SampleDiffuseMap3(otexCoord0.xy * diffuseMapTilings[1].xy);","    diffuseColor += weights.w * SampleDiffuseMap4(otexCoord0.xy * diffuseMapTilings[1].zw);","    //diffuseColor = weights;","#endif","#ifdef DIFFUSE_MAPPING","    vec4 diffuseColor = SampleDiffuseMap(otexCoord0.xy * diffuseMapTiling);","#ifdef MULTI_DIFFUSE","    diffuseColor *= SampleDiffuseMap2(otexCoord0.xy * diffuseMap2Tiling);","#endif","#else","#ifndef WEIGHTED_DIFFUSE","    vec4 diffuseColor = vec4(1, 1, 1, 1);","#endif","#endif","#ifdef SOLID_COLOR","    diffuseColor = mainColor;","#else","    diffuseColor = mainColor * diffuseColor;","#endif","#ifdef ALPHATEST","    if (diffuseColor.a < ALPHATEST) discard;","#endif","#ifdef NORMAL_MAPPING","    mat3 transformNormal = TangentToWorldSpace(onormal, otangent);","    vec3 normal = normalize((transformNormal * SampleNormalMap(otexCoord0.xy * normalMapTiling)));","    //vec3 normal = onormal;","#else","    vec3 normal = onormal;","#endif","#ifdef SPECULAR_LIGHTING","#ifdef SPECULAR_MAPPING","    float shininess = SampleSpecularMap(otexCoord0.xy * specularMapTiling);","#else","    float shininess = 1.0;","#endif","#endif","#ifdef LIGHT_MAPPING","    vec3 diffuseLight = SampleLightMap(otexCoord1 * lightMapTiling).xyz * lightMapPower;","#else","    vec3 diffuseLight = ambientLightColor.xyz;","#endif","    vec3 specularLight = vec3(0, 0, 0);","#ifdef DEBUG_CSM","    vec4 lightness = vec4(1.0, 1.0, 1.0, 1.0);","#else","    float lightness = 1.0;","#endif","#ifdef SHADOW_MAPPING","    SAMPLE_SHADOW_MAP","#endif","#ifdef DIFFUSE_LIGHTING","#ifdef SPECULAR_LIGHTING","    vec3 viewDirection = normalize(cameraPosition.xyz - oworldPosition.xyz);","#endif","#if MAX_DIR_LIGHTS > 0","    // Directional lights","    for(int i = 0; i < MAX_DIR_LIGHTS; ++i)","    {","        vec3 lightDir = directionalLightDirection[i];","        float NDotL = dot(normal, lightDir);","        diffuseLight += (lightness * directionalLightColor[i]) * clamp(NDotL, 0.0, 1.0);","#ifdef SPECULAR_LIGHTING","        float specularIntensity = ComputeLightBlinnPhongSpecularFactor(normal, lightDir, viewDirection, NDotL);","        vec3 specColor = directionalLightColor[i] * vec3(0.25, 0.25, 0.25);","        specularLight += lightness * specColor * specularIntensity * shininess * specularPower;","#endif","    }","#endif","#if MAX_POINT_LIGHTS > 0","    // Point lights","    for(int i = 0; i < MAX_POINT_LIGHTS; ++i)","    {","        vec3 lightDir = pointLightPosition[i].xyz - oworldPosition.xyz;","        float  lightDistance = length(lightDir);","        lightDir = normalize(lightDir);","        float attenuation = ComputeLightAttenuation(lightDistance, pointLightDistance[i], 1.0) * 2.0;","        float NDotL = dot(normal, lightDir);","        float lightPower = clamp(NDotL, 0.0, 1.0) * attenuation;","        diffuseLight += lightness * pointLightColor[i] * lightPower;","#ifdef SPECULAR_LIGHTING","        float specularIntensity = ComputeLightBlinnPhongSpecularFactor(normal, lightDir, viewDirection, NDotL);","        vec3 specColor = pointLightColor[i] * vec3(0.25, 0.25, 0.25);","        specularLight += lightness * specColor * specularIntensity * shininess * specularPower * clamp((1.0 - (lightDistance / pointLightDistance[i])) * 3.0, 0.0, 1.0);","#endif","    }","#endif","#if MAX_SPOT_LIGHTS > 0","    // Spot lights","    for(int i = 0; i < MAX_SPOT_LIGHTS; ++i)","    {","        vec3 lightDir = spotLightPosition[i].xyz - oworldPosition.xyz;","        float  lightDistance = length(lightDir);","        lightDir = normalize(lightDir);","        // factor in spotlight angle","        float rho = clamp(dot(spotLightDirection[i], lightDir), 0.0, 1.0);","        // factor = (rho - cos(outer / 2) / cos(inner / 2) - cos(outer / 2)) ^ falloff","        float spotLightFactor = pow(clamp(rho - spotLightExponent[i], 0.0, 1.0) / (spotLightAngleCos[i] - spotLightExponent[i]), 1.0);","        //loat spotEffect = dot(spotLightDirection[i], lightDir);","        //if (spotEffect > spotLightAngleCos[i])","        //{","            //spotEffect = max(pow(spotEffect, spotLightExponent[i]), 0.0);","            float attenuation = ComputeLightAttenuation(lightDistance, spotLightDistance[i], 1.0) * 2.0;","            float NDotL = dot(normal, lightDir);","            float lightPower = clamp(NDotL, 0.0, 1.0) * attenuation;","            diffuseLight += lightness * spotLightColor[i] * lightPower * spotLightFactor;","#ifdef SPECULAR_LIGHTING","            float specularIntensity = ComputeLightBlinnPhongSpecularFactor(normal, lightDir, viewDirection, NDotL);","            vec3 specColor = spotLightColor[i] * vec3(0.25, 0.25, 0.25);","            specularLight += lightness * specColor * specularIntensity * shininess * specularPower * clamp((1.0 - (lightDistance / spotLightDistance[i])) * 3.0, 0.0, 1.0) * spotLightFactor;","#endif","        //}","    }","#endif","#endif","    gl_FragColor = diffuseColor * vec4(diffuseLight + specularLight, 1);",THREE.ShaderChunk.logdepthbuf_fragment,"}"].join("\n")
},MeshmoonShaderLibrary={"meshmoon/Diffuse":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseMulti":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMap2:{type:"t",value:null},diffuseMap2Tiling:{type:"v2",value:new THREE.Vector2(1,1)},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","diffuseMap2"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseNormalMap":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},normalMap:{type:"t",value:null},normalMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","normalMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define NORMAL_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define NORMAL_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseSpecularMap":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularMap:{type:"t",value:null},specularMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","specularMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define SPECULAR_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define SPECULAR_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseLightMap":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},lightMap:{type:"t",value:null},lightMapPower:{type:"f",value:1},lightMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","lightMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseShadow":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseMultiNormalMap":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMap2:{type:"t",value:null},diffuseMap2Tiling:{type:"v2",value:new THREE.Vector2(1,1)},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},normalMap:{type:"t",value:null},normalMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","diffuseMap2","normalMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define NORMAL_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define NORMAL_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseMultiSpecularMap":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMap2:{type:"t",value:null},diffuseMap2Tiling:{type:"v2",value:new THREE.Vector2(1,1)},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularMap:{type:"t",value:null},specularMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","diffuseMap2","specularMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define SPECULAR_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define SPECULAR_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseMultiLightMap":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMap2:{type:"t",value:null},diffuseMap2Tiling:{type:"v2",value:new THREE.Vector2(1,1)},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},lightMap:{type:"t",value:null},lightMapPower:{type:"f",value:1},lightMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","diffuseMap2","lightMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseMultiShadow":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMap2:{type:"t",value:null},diffuseMap2Tiling:{type:"v2",value:new THREE.Vector2(1,1)},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","diffuseMap2"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseNormalMapSpecularMap":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},normalMap:{type:"t",value:null},normalMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularMap:{type:"t",value:null},specularMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","normalMap","specularMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define NORMAL_MAPPING","#define SPECULAR_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define NORMAL_MAPPING","#define SPECULAR_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseNormalMapLightMap":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},lightMap:{type:"t",value:null},lightMapPower:{type:"f",value:1},lightMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},normalMap:{type:"t",value:null},normalMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","normalMap","lightMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define NORMAL_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define NORMAL_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseNormalMapShadow":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},normalMap:{type:"t",value:null},normalMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","normalMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define NORMAL_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define NORMAL_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseSpecularMapLightMap":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},lightMap:{type:"t",value:null},lightMapPower:{type:"f",value:1},lightMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularMap:{type:"t",value:null},specularMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","specularMap","lightMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define SPECULAR_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define SPECULAR_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseSpecularMapShadow":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularMap:{type:"t",value:null},specularMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","specularMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define SPECULAR_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define SPECULAR_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseLightMapShadow":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},lightMap:{type:"t",value:null},lightMapPower:{type:"f",value:1},lightMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","lightMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseMultiNormalMapSpecularMap":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMap2:{type:"t",value:null},diffuseMap2Tiling:{type:"v2",value:new THREE.Vector2(1,1)},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},normalMap:{type:"t",value:null},normalMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularMap:{type:"t",value:null},specularMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","diffuseMap2","normalMap","specularMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define NORMAL_MAPPING","#define SPECULAR_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define NORMAL_MAPPING","#define SPECULAR_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseMultiNormalMapLightMap":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMap2:{type:"t",value:null},diffuseMap2Tiling:{type:"v2",value:new THREE.Vector2(1,1)},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},lightMap:{type:"t",value:null},lightMapPower:{type:"f",value:1},lightMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},normalMap:{type:"t",value:null},normalMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","diffuseMap2","normalMap","lightMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define NORMAL_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define NORMAL_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseMultiNormalMapShadow":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMap2:{type:"t",value:null},diffuseMap2Tiling:{type:"v2",value:new THREE.Vector2(1,1)},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},normalMap:{type:"t",value:null},normalMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","diffuseMap2","normalMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define NORMAL_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define NORMAL_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseMultiSpecularMapLightMap":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMap2:{type:"t",value:null},diffuseMap2Tiling:{type:"v2",value:new THREE.Vector2(1,1)},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},lightMap:{type:"t",value:null},lightMapPower:{type:"f",value:1},lightMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularMap:{type:"t",value:null},specularMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","diffuseMap2","specularMap","lightMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define SPECULAR_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define SPECULAR_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseMultiSpecularMapShadow":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMap2:{type:"t",value:null},diffuseMap2Tiling:{type:"v2",value:new THREE.Vector2(1,1)},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularMap:{type:"t",value:null},specularMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","diffuseMap2","specularMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define SPECULAR_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define SPECULAR_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseMultiLightMapShadow":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMap2:{type:"t",value:null},diffuseMap2Tiling:{type:"v2",value:new THREE.Vector2(1,1)},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},lightMap:{type:"t",value:null},lightMapPower:{type:"f",value:1},lightMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","diffuseMap2","lightMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseNormalMapSpecularMapLightMap":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},lightMap:{type:"t",value:null},lightMapPower:{type:"f",value:1},lightMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},normalMap:{type:"t",value:null},normalMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularMap:{type:"t",value:null},specularMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","normalMap","specularMap","lightMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define NORMAL_MAPPING","#define SPECULAR_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define NORMAL_MAPPING","#define SPECULAR_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseNormalMapSpecularMapShadow":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},normalMap:{type:"t",value:null},normalMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularMap:{type:"t",value:null},specularMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","normalMap","specularMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define NORMAL_MAPPING","#define SPECULAR_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define NORMAL_MAPPING","#define SPECULAR_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseNormalMapLightMapShadow":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},lightMap:{type:"t",value:null},lightMapPower:{type:"f",value:1},lightMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},normalMap:{type:"t",value:null},normalMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","normalMap","lightMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define NORMAL_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define NORMAL_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseSpecularMapLightMapShadow":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},lightMap:{type:"t",value:null},lightMapPower:{type:"f",value:1},lightMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularMap:{type:"t",value:null},specularMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","specularMap","lightMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define SPECULAR_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define SPECULAR_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseMultiNormalMapSpecularMapLightMap":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMap2:{type:"t",value:null},diffuseMap2Tiling:{type:"v2",value:new THREE.Vector2(1,1)},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},lightMap:{type:"t",value:null},lightMapPower:{type:"f",value:1},lightMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},normalMap:{type:"t",value:null},normalMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularMap:{type:"t",value:null},specularMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","diffuseMap2","normalMap","specularMap","lightMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define NORMAL_MAPPING","#define SPECULAR_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define NORMAL_MAPPING","#define SPECULAR_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseMultiNormalMapSpecularMapShadow":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMap2:{type:"t",value:null},diffuseMap2Tiling:{type:"v2",value:new THREE.Vector2(1,1)},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},normalMap:{type:"t",value:null},normalMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularMap:{type:"t",value:null},specularMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","diffuseMap2","normalMap","specularMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define NORMAL_MAPPING","#define SPECULAR_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),
fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define NORMAL_MAPPING","#define SPECULAR_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseMultiNormalMapLightMapShadow":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMap2:{type:"t",value:null},diffuseMap2Tiling:{type:"v2",value:new THREE.Vector2(1,1)},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},lightMap:{type:"t",value:null},lightMapPower:{type:"f",value:1},lightMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},normalMap:{type:"t",value:null},normalMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","diffuseMap2","normalMap","lightMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define NORMAL_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define NORMAL_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseMultiSpecularMapLightMapShadow":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMap2:{type:"t",value:null},diffuseMap2Tiling:{type:"v2",value:new THREE.Vector2(1,1)},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},lightMap:{type:"t",value:null},lightMapPower:{type:"f",value:1},lightMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularMap:{type:"t",value:null},specularMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","diffuseMap2","specularMap","lightMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define SPECULAR_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define SPECULAR_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseNormalMapSpecularMapLightMapShadow":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},lightMap:{type:"t",value:null},lightMapPower:{type:"f",value:1},lightMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},normalMap:{type:"t",value:null},normalMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularMap:{type:"t",value:null},specularMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","normalMap","specularMap","lightMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define NORMAL_MAPPING","#define SPECULAR_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define NORMAL_MAPPING","#define SPECULAR_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/DiffuseMultiNormalMapSpecularMapLightMapShadow":{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},diffuseMap2:{type:"t",value:null},diffuseMap2Tiling:{type:"v2",value:new THREE.Vector2(1,1)},diffuseMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},lightMap:{type:"t",value:null},lightMapPower:{type:"f",value:1},lightMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},normalMap:{type:"t",value:null},normalMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularMap:{type:"t",value:null},specularMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["diffuseMap","diffuseMap2","normalMap","specularMap","lightMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define NORMAL_MAPPING","#define SPECULAR_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define DIFFUSE_MAPPING","#define MULTI_DIFFUSE","#define NORMAL_MAPPING","#define SPECULAR_MAPPING","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/WeightedDiffuse":{uniforms:THREE.UniformsUtils.merge([{diffuseMap1:{type:"t",value:null},diffuseMap2:{type:"t",value:null},diffuseMap3:{type:"t",value:null},diffuseMap4:{type:"t",value:null},diffuseMapTilings:{type:"v4v",value:[new THREE.Vector4(1,1,1,1),new THREE.Vector4(1,1,1,1)]},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},weightMap:{type:"t",value:null},weightMapTiling:{type:"v2",value:new THREE.Vector2(1,1)}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["weightMap","diffuseMap1","diffuseMap2","diffuseMap3","diffuseMap4"],vertexShader:["#define DIFFUSE_LIGHTING","#define WEIGHTED_DIFFUSE","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define WEIGHTED_DIFFUSE","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/WeightedDiffuseLightMap":{uniforms:THREE.UniformsUtils.merge([{diffuseMap1:{type:"t",value:null},diffuseMap2:{type:"t",value:null},diffuseMap3:{type:"t",value:null},diffuseMap4:{type:"t",value:null},diffuseMapTilings:{type:"v4v",value:[new THREE.Vector4(1,1,1,1),new THREE.Vector4(1,1,1,1)]},lightMap:{type:"t",value:null},lightMapPower:{type:"f",value:1},lightMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},weightMap:{type:"t",value:null},weightMapTiling:{type:"v2",value:new THREE.Vector2(1,1)}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["weightMap","diffuseMap1","diffuseMap2","diffuseMap3","diffuseMap4","lightMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define WEIGHTED_DIFFUSE","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define WEIGHTED_DIFFUSE","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/WeightedDiffuseShadow":{uniforms:THREE.UniformsUtils.merge([{diffuseMap1:{type:"t",value:null},diffuseMap2:{type:"t",value:null},diffuseMap3:{type:"t",value:null},diffuseMap4:{type:"t",value:null},diffuseMapTilings:{type:"v4v",value:[new THREE.Vector4(1,1,1,1),new THREE.Vector4(1,1,1,1)]},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},weightMap:{type:"t",value:null},weightMapTiling:{type:"v2",value:new THREE.Vector2(1,1)}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["weightMap","diffuseMap1","diffuseMap2","diffuseMap3","diffuseMap4"],vertexShader:["#define DIFFUSE_LIGHTING","#define WEIGHTED_DIFFUSE","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define WEIGHTED_DIFFUSE","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/WeightedDiffuseLightMapShadow":{uniforms:THREE.UniformsUtils.merge([{diffuseMap1:{type:"t",value:null},diffuseMap2:{type:"t",value:null},diffuseMap3:{type:"t",value:null},diffuseMap4:{type:"t",value:null},diffuseMapTilings:{type:"v4v",value:[new THREE.Vector4(1,1,1,1),new THREE.Vector4(1,1,1,1)]},lightMap:{type:"t",value:null},lightMapPower:{type:"f",value:1},lightMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},weightMap:{type:"t",value:null},weightMapTiling:{type:"v2",value:new THREE.Vector2(1,1)}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["weightMap","diffuseMap1","diffuseMap2","diffuseMap3","diffuseMap4","lightMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define WEIGHTED_DIFFUSE","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define WEIGHTED_DIFFUSE","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/SolidColor":{uniforms:THREE.UniformsUtils.merge([{mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:[],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define SOLID_COLOR","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define SOLID_COLOR","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/SolidColorShadow":{uniforms:THREE.UniformsUtils.merge([{mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:[],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define SOLID_COLOR","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define SOLID_COLOR","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/SolidColorLightMap":{uniforms:THREE.UniformsUtils.merge([{lightMap:{type:"t",value:null},lightMapPower:{type:"f",value:1},lightMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["lightMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define SOLID_COLOR","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define SOLID_COLOR","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")},"meshmoon/SolidColorLightMapShadow":{uniforms:THREE.UniformsUtils.merge([{lightMap:{type:"t",value:null},lightMapPower:{type:"f",value:1},lightMapTiling:{type:"v2",value:new THREE.Vector2(1,1)},mainColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},specularHardness:{type:"f",value:20},specularPower:{type:"f",value:1}},THREE.UniformsLib.lights]),lights:!0,perPixel:!0,textureIndexes:["lightMap"],vertexShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define SOLID_COLOR","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/VertexShader"]].join("\n"),fragmentShader:["#define DIFFUSE_LIGHTING","#define SPECULAR_LIGHTING","#define SOLID_COLOR","#define LIGHT_MAPPING","#define DEFAULT","#define WEBGL","#define MAX_LIGHT_COUNT 1",MeshmoonBaseShader["meshmoon/FragmentShader"]].join("\n")}},OgreMaterial=Class.$extend({__init__:function(a,b,c){this.name=a,this.logging=c||!1,void 0!==b&&"string"==typeof b&&this.deserializeFromData(b)},__classvars__:{IgnoredTextureUnitTypes:{},Color:{Ambient:0,Diffuse:1,Specular:2,Emissive:3},ignoreTextureUnit:function(a){for(var b=Array.isArray(a)?a:[a],c=0;c<b.length;c++){var d=b[c];"string"==typeof d&&(d=TextureAsset.typeFromString(d)),"number"!=typeof d||0>d||d>TextureAsset.MAX_TEXTURE_TYPE||(OgreMaterial.IgnoredTextureUnitTypes[d]=!0)}},typeFromString:function(a){return"ambient"===a?OgreMaterial.Color.Ambient:"diffuse"===a?OgreMaterial.Color.Diffuse:"specular"===a?OgreMaterial.Color.Specular:"emissive"===a?OgreMaterial.Color.Emissive:void 0},typeToString:function(a){return a===OgreMaterial.Color.Ambient?"ambient":a===OgreMaterial.Color.Diffuse?"diffuse":a===OgreMaterial.Color.Specular?"specular":a===OgreMaterial.Color.Emissive?"emissive":"Unkown color type"},defaultMaterialColor:function(a){if("string"==typeof a&&(a=OgreMaterial.typeFromString(a)),void 0===a)return null;var b=new Color;return a===OgreMaterial.Color.Ambient?b.setRGBA(.8,.8,.8):a===OgreMaterial.Color.Diffuse?b.setRGBA(1,1,1):a===OgreMaterial.Color.Specular?b.setRGBA(.067,.067,.067):a===OgreMaterial.Color.Emissive&&b.setRGBA(.5,.5,.5),b},clampColor:function(a,b,c,d){(b.r>c||b.g>c||b.b>c)&&(b.r>c&&(b.r=c),b.g>c&&(b.g=c),b.b>c&&(b.b=c),d&&("string"==typeof a&&(a=OgreMaterial.typeFromString(a)),console.log("  -- Clamped",OgreMaterial.typeToString(a),"to",c)))},_passRegexp:/\spass/g,_texUnitRegexp:/\stexture_unit/g},deserializeFromData:function(a){if(this.data=CoreStringUtils.removeComments(a),this.logging&&console.log("Parsing '"+this.name+"'"),this.passes={},this.passes.count=this.readCount("pass",OgreMaterial._passRegexp),this.passes.count>1){console.warn("OgreMaterial: Parser detected",this.passes.count,"passes. Only single pass fixed pipeline materials are supported '"+this.name+"'. Continuing parsing witht the first pass.");var b=this.readBlock("pass",0,!1);this.data=b.data}this.logging&&this.readCount("texture_unit",OgreMaterial._texUnitRegexp),this.shaders={},this.shaders.vertex=new OgreShader(OgreShader.Type.Vertex,this.data,this.logging),this.shaders.fragment=new OgreShader(OgreShader.Type.Fragment,this.data,this.logging),this.shaders.isMeshmoonShader=function(){if(0===this.vertex.name.indexOf("meshmoon/")&&0===this.fragment.name.indexOf("meshmoon/")){var a=this.meshmoonShaderName();if("object"==typeof MeshmoonShaderLibrary[a]&&null!=MeshmoonShaderLibrary[a].uniforms)return!0}return!1},this.shaders.hasShadowShaders=function(){return this.vertex.nameContains("Shadow")||this.fragment.nameContains("Shadow")},this.shaders.meshmoonShaderName=function(){return this.vertex.name.substring(0,this.vertex.name.length-2)},this.shaders.isMeshmoonShader()?this.shaders.fragment.readNamedParameters({diffuseMapTiling:"float4",diffuseMap2Tiling:"float4",normalMapTiling:"float4",specularMapTiling:"float4",lightMapTiling:"float4",weightMapTiling:"float4",diffuseMapTilings:"float8",lightMapPower:"float",specularHardness:"float4",specularPower:"float4",mainColor:"float4",specularColor:"float4"}):this.shaders.fragment.readNamedParameters({opacity:"float4",specularPower:"float4"}),this.attributes={},this.attributes.scene_blend=this.readString("scene_blend",!0),this.attributes.scene_blend_op=this.readString("scene_blend_op",!0),this.attributes.colour_op_ex=this.readAttributeList("colour_op_ex"),this.attributes.alpha_op_ex=this.readAttributeList("alpha_op_ex"),this.attributes.alpha_rejection=this.readAttributeList("alpha_rejection"),this.attributes.fog_override=this.readAttributeList("fog_override"),this.ambient=this.readColor(OgreMaterial.Color.Ambient),this.diffuse=this.readColor(OgreMaterial.Color.Diffuse),this.specular=this.readColor(OgreMaterial.Color.Specular),this.emissive=this.readColor(OgreMaterial.Color.Emissive),this.opacity=this.readOpacity(),this.depthWrite=-1===this.data.indexOf("depth_write off"),this.lighting=-1===this.data.indexOf("lighting off"),this.logging&&!this.depthWrite&&console.log("  -- depth_write off"),this.logging&&!this.lighting&&console.log("  -- lighting off"),this.textureUnits=[];for(var c=0,d=0;-1!==d;++c){var b=this.readBlock("texture_unit",d,!1);if(void 0===b)break;d=b.indexEnd;var e=new OgreTextureUnit(c,b.name,b.data,this.logging);if(e.type=this.resolveTextureType(e),void 0!==e.type){if(e.type!==TextureAsset.SHADOW){var f=OgreMaterial.IgnoredTextureUnitTypes[e.type];void 0===f||f!==!0?this.isTextureTypeReserved(e.type)?this.logging&&console.log("     Ignoring "+TextureAsset.typeToString(e.type)+" as its already set once!"):this.textureUnits.push(e):this.logging&&console.log("     Ignoring "+TextureAsset.typeToString(e.type)+" as instructed by 3rd party code.")}}else console.warn("Failed to resolve texture type","index =",e.index,"name =",e.name,"coord set =",e.coordSet,"fragment shader =",this.shaders.fragment.name)}this.logging===!1&&(this.data=void 0)},readString:function(a,b){a+=" ";var c=this.data.indexOf(a),d=-1!==c?CoreStringUtils.readLine(this.data.substring(c+a.length),null,!0,!0):"";return this.logging&&b===!0&&""!==d&&console.log("  --",a+"'"+d+"'"),d},readList:function(a,b){var c=this.data.indexOf(a);if(-1===c)return[];var d=CoreStringUtils.trim(this.readLine(this.data.substring(c+a.length)));return""!==d?d.split("string"==typeof b?b:" "):[]},readColor:function(a){var b=null,c=this.readList(OgreMaterial.typeToString(a)+" ");if(c.length>=3?(b=new Color,b.r=Math.min(parseFloat(c[0]),1),b.g=Math.min(parseFloat(c[1]),1),b.b=Math.min(parseFloat(c[2]),1)):b=OgreMaterial.defaultMaterialColor(a),this.logging){for(var d="";OgreMaterial.typeToString(a).length+d.length<8;)d+=" ";console.log("  --",OgreMaterial.typeToString(a)+d,b.r,b.g,b.b,c.length<3?"[default]":"")}return b},readOpacity:function(){var a=void 0,b=this.shaders.fragment.namedParameter("opacity","float4");if(void 0!==b&&b.value.length>0){var c=Math.min(parseFloat(b.value[0]),1);isNaN(c)||(a=c)}if(void 0===a&&Array.isArray(this.attributes.alpha_op_ex)&&this.attributes.alpha_op_ex.length>=4&&(a=Math.min(parseFloat(this.attributes.alpha_op_ex[3]),1)),void 0===a){var d=this.readList("diffuse ");a=d.length>=4?Math.min(parseFloat(d[3]),1):1}return this.logging&&1!==a&&console.log("  -- opacity ",a),a},readAttributeList:function(a){var b=this.readList(a+" ");return this.logging&&b.length>0&&console.log("  --",a,b.join(" ")),b},readBlock:function(a,b,c){void 0===b&&(b=0);var d=this.data.indexOf(a,b);if(-1===d)return void 0;var e={indexEnd:-1,id:a,name:"",data:""},f=d+a.length,g=this.data.indexOf("{",f),h=this.data.indexOf("}",f);if(-1===g||-1===h)return console.error("Failed to read block { } data content starting from index",d),console.error("in",this.name),void console.error(this.data.substring(d));for(var i=this.data.indexOf("{",g+1);i>=0&&h>i;){if(innerClose=this.data.indexOf("}",i+1),-1===innerClose||i>=h)return console.error("Syntax error in material file in {} scope at index",g,"in material:",this.name),void console.log(this.data);h=this.data.indexOf("}",innerClose+1),i=this.data.indexOf("{",i+1)}return e.name=CoreStringUtils.trim(this.readLine(this.data.substring(f))),e.data=this.data.substring(g+1,h-1),e.indexEnd=h+1,this.logging&&c===!0&&console.log("  >>",e.id,""!==e.name?"'"+e.name+"'":""),e},readCount:function(a,b,c){var d=this.data.match(b),e=null!=d?d.length:0;return this.logging&&console.log("  --",a,"count",e),e},readLine:function(a,b){var c=null,d=a.indexOf("\n"),e=a.indexOf("\r\n"),f=a.indexOf("	"),g=void 0!==b?a.indexOf(b):-1;return(null==c||-1!==d&&c>d)&&(c=d),(null==c||-1!==e&&c>e)&&(c=e),(null==c||-1!==f&&c>f)&&(c=f),(null==c||-1!==g&&c>g)&&(c=g),-1!==c?a.substring(0,c):""},numTextures:function(){return this.textureUnits.length},isTextureTypeReserved:function(a){if(a===TextureAsset.MESHMOON_TEXTURE)return!1;for(var b=0;b<this.textureUnits.length;++b)if(this.textureUnits[b].type===a)return!0;return!1},isTextureCoordReserver:function(a){for(var b=0;b<this.textureUnits.length;++b)if(this.textureUnits[b].coordSet===a)return!0;return!1},resolveTextureType:function(a){var b=void 0;if(this.shaders.isMeshmoonShader())return"Ogre"===a.textureRef||-1!==a.textureRef.indexOf("KernelRotation.png")?TextureAsset.SHADOW:TextureAsset.MESHMOON_TEXTURE;if("baseMap"===a.name||"diffuseMap"===a.name)b=TextureAsset.DIFFUSE;else if("specularMap"===a.name)b=TextureAsset.SPECULAR;else if("lightMap"===a.name)b=TextureAsset.LIGHT;else if("normalMap"===a.name)b=TextureAsset.NORMAL;else if("reflectionMap"===a.name)b=TextureAsset.REFLECTION;else if(CoreStringUtils.startsWith(a.name,"shadowMap"))return this.logging&&console.log("     --",TextureAsset.typeToString(TextureAsset.SHADOW)),TextureAsset.SHADOW;return void 0===b&&a.coordSet>-1&&(0===a.coordSet?b=this.isTextureTypeReserved(TextureAsset.DIFFUSE)?TextureAsset.SPECULAR:TextureAsset.DIFFUSE:1===a.coordSet&&(b=TextureAsset.LIGHT)),void 0===b&&(this.shaders.fragment.isValid()?this.shaders.fragment.nameContains("/Diff")&&0===a.index&&(b=TextureAsset.DIFFUSE):0===a.index?b=TextureAsset.DIFFUSE:1===a.index&&(b=this.isTextureTypeReserved(TextureAsset.LIGHT)?TextureAsset.DIFFUSE:TextureAsset.LIGHT)),this.shaders.fragment.nameContains("meshmoon/MultiDiff")?b=0===a.index?TextureAsset.DIFFUSE:1===a.index?TextureAsset.DIFFUSE2:void 0:this.shaders.fragment.nameContains("DiffSpecmapNormalShadowLightmap"),this.logging&&void 0!==b&&console.log("     --",TextureAsset.typeToString(b)),b}});!function(){var a=function(a,b,c){return"string"==typeof b&&"string"==typeof c&&-1!==a.indexOf(b)?a.replace(b,c):a},b="0.8",c="0.8",d={lights_phong_fragment:["totalDiffuse += dirDiffuse;","totalDiffuse += (dirDiffuse * "+b+");","totalSpecular += dirSpecular;","totalSpecular += (dirSpecular * "+c+");"]};for(var e in d)for(var f=d[e],g=0;g<f.length;g+=2){var h=f[g],i=f[g+1];THREE.ShaderChunk[e]=a(THREE.ShaderChunk[e],h,i)}var j={phong:["totalDiffuse += dirDiffuse;","totalDiffuse += (dirDiffuse * "+b+");","totalSpecular += dirSpecular;","totalSpecular += (dirSpecular * "+c+");"]};for(var e in j)for(var f=j[e],g=0;g<f.length;g+=2){var h=f[g],i=f[g+1];THREE.ShaderLib[e].fragmentShader=a(THREE.ShaderLib[e].fragmentShader,h,i)}}();var RocketShaderLibrary={textureCache:{},heightMapData:{size:100,normalSize:102,xOffset:1,yOffset:1,vertexSize:3,pixelSize:4},createHeightMapDataView:function(){(void 0===this.heightMapData.pixelData||void 0===this.heightMapData.pixelView)&&(this.heightMapData.pixelData=new Uint8Array(this.heightMapData.size*this.heightMapData.size*this.heightMapData.pixelSize),this.heightMapData.pixelView=new DataView(this.heightMapData.pixelData.buffer))},getMeshIndex:function(a,b){return 3*(this.heightMapData.yOffset+(this.heightMapData.size-b)+(this.heightMapData.xOffset+a)*this.heightMapData.normalSize)},getPixelIndex:function(a,b){return(b*this.heightMapData.size+a)*this.heightMapData.pixelSize},encodeHeight:{bitShift:new THREE.Vector4(16777216,65536,256,1),bitMask:new THREE.Vector4(0,1/256,1/256,1/256),encoded:new THREE.Vector4},fraction:function(a){a.x=a.x%1,a.y=a.y%1,a.z=a.z%1,a.w=a.w%1},encodeFloatRGBA:function(a){this.encodeHeight.encoded.set(a*this.encodeHeight.bitShift.x,a*this.encodeHeight.bitShift.z,a*this.encodeHeight.bitShift.y,a*this.encodeHeight.bitShift.w),this.encodeHeight.encoded.x=this.encodeHeight.encoded.x%1,this.encodeHeight.encoded.y=this.encodeHeight.encoded.y%1,this.encodeHeight.encoded.z=this.encodeHeight.encoded.z%1,this.encodeHeight.encoded.w=this.encodeHeight.encoded.w%1;var b=this.encodeHeight.encoded.x,c=this.encodeHeight.encoded.y,d=this.encodeHeight.encoded.z;return this.encodeHeight.encoded.x-=b*this.encodeHeight.bitMask.x,this.encodeHeight.encoded.y-=b*this.encodeHeight.bitMask.y,this.encodeHeight.encoded.z-=c*this.encodeHeight.bitMask.z,this.encodeHeight.encoded.w-=d*this.encodeHeight.bitMask.w,this.encodeHeight.encoded.x=Math.floor(255*this.encodeHeight.encoded.x),this.encodeHeight.encoded.y=Math.floor(255*this.encodeHeight.encoded.y),this.encodeHeight.encoded.z=Math.floor(255*this.encodeHeight.encoded.z),this.encodeHeight.encoded.w=Math.floor(255*this.encodeHeight.encoded.w),this.encodeHeight.encoded},createTerrainHeightMap:function(a,b){b="boolean"==typeof b?b:!1;var c=Tundra.renderer.renderer.context;if(null===c||void 0===c)return null;if(a instanceof THREE.BufferGeometry==!1)return null;var d=1e5,e=-1e5,f=a.attributes.position;if(void 0===f)return null;for(var g=0;g<f.array.length;g+=3){var h=f.array[g+1];d>h&&(d=h),h>e&&(e=h)}if(this.createHeightMapDataView(),b===!0){var i=new Uint8Array(size*size*pixelSize),j=new DataView(i.buffer),k=document.createElement("canvas");k.width=size,k.height=size,k.style.zIndex="500",k.style.position="absolute";var l=k.getContext("2d")}for(var m=e-d,n=0,o=this.heightMapData.size;o>n;++n)for(var p=0;o>p;++p){var q=this.getMeshIndex(n,p),h=f.array[q+1],r=this.getPixelIndex(n,p),s=(h-d)/m,t=this.encodeFloatRGBA(s);if(b===!0){var u=Math.floor(255*s);l.fillStyle="rgb("+u+","+u+","+u+")",l.fillRect(n,p,1,1),j.setUint8(r+0,u),j.setUint8(r+1,u),j.setUint8(r+2,u),j.setUint8(r+3,u)}this.heightMapData.pixelView.setUint8(r+0,t.x),this.heightMapData.pixelView.setUint8(r+1,t.y),this.heightMapData.pixelView.setUint8(r+2,t.z),this.heightMapData.pixelView.setUint8(r+3,t.w)}b===!0&&(document.body.appendChild(k),setTimeout(function(){document.body.removeChild(k)}.bind(this),5e3));try{var v=null;if(b===!0){v=new THREE.Texture({width:size,height:size}),v.name="RocketShaderLibrary.heightmap."+a.uuid,v.needsUpdate=!1,v.flipY=!1,v.unpackAlignment=1,v.__webglTexture=c.createTexture(),c.bindTexture(c.TEXTURE_2D,v.__webglTexture),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,v.flipY),c.pixelStorei(c.UNPACK_ALIGNMENT,v.unpackAlignment),c.pixelStorei(c.PACK_ALIGNMENT,v.unpackAlignment);var w=c.UNSIGNED_BYTE;c.texImage2D(c.TEXTURE_2D,0,c.RGBA,this.heightMapData.size,this.heightMapData.size,0,c.RGBA,w,i),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),c.bindTexture(c.TEXTURE_2D,null)}var x=new THREE.Texture({width:this.heightMapData.size,height:this.heightMapData.size});return x.name="RocketShaderLibrary.heightmap."+a.uuid,x.needsUpdate=!1,x.flipY=!1,x.unpackAlignment=1,x.__webglTexture=c.createTexture(),c.bindTexture(c.TEXTURE_2D,x.__webglTexture),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,x.flipY),c.pixelStorei(c.UNPACK_ALIGNMENT,x.unpackAlignment),c.pixelStorei(c.PACK_ALIGNMENT,x.unpackAlignment),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,this.heightMapData.size,this.heightMapData.size,0,c.RGBA,c.UNSIGNED_BYTE,this.heightMapData.pixelData),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),c.bindTexture(c.TEXTURE_2D,null),b===!0&&(console.log("Lowest:",d),console.log("Highest:",e)),{texture:x,lowest:d,highest:e,debugTexture:v}}catch(y){return console.log(y),null}},createRandomTexture:function(a,b,c,d){var e=Tundra.renderer.renderer.context;if(null===e||void 0===e)return null;for(var f=new Uint8Array(a*b*4),g=new DataView(f.buffer),h=0,i=0;a>i;++i)for(var j=0;b>j;++j){var k=Math.random(),l=MathUtils.lerp(c.r,d.r,k),m=MathUtils.lerp(c.g,d.g,k),n=MathUtils.lerp(c.b,d.b,k),o=MathUtils.lerp(c.a,d.a,k);l=Math.floor(255*l),m=Math.floor(255*m),n=Math.floor(255*n),o=Math.floor(255*o),g.setUint8(h+0,l),g.setUint8(h+1,m),g.setUint8(h+2,n),g.setUint8(h+3,o),h+=4}try{var p=new THREE.Texture({width:a,height:b});return p.needsUpdate=!1,p.flipY=!1,p.unpackAlignment=1,p.__webglTexture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,p.__webglTexture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,p.flipY),e.pixelStorei(e.UNPACK_ALIGNMENT,p.unpackAlignment),e.pixelStorei(e.PACK_ALIGNMENT,p.unpackAlignment),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,a,b,0,e.RGBA,e.UNSIGNED_BYTE,f),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),p}catch(q){return console.log(q),null}},getSolidColorTexture:function(a,b,c,d){if(d="number"==typeof d?d:255,"number"!=typeof a)return void console.error("getSolidColorTexture: 'r' not a number");if("number"!=typeof b)return void console.error("getSolidColorTexture: 'g' not a number");if("number"!=typeof c)return void console.error("getSolidColorTexture: 'b' not a number");if("number"!=typeof d)return void console.error("getSolidColorTexture: 'a' not a number");a=MathUtils.clamp(a,0,255),b=MathUtils.clamp(b,0,255),c=MathUtils.clamp(c,0,255),d=MathUtils.clamp(d,0,255);var e=[a.toString(),b.toString(),c.toString(),d.toString()].join(",");if(void 0!==this.textureCache[e])return this.textureCache[e];if(null==Tundra.renderer&&null==Tundra.renderer.renderer)return null;var f=Tundra.renderer.renderer.context;if(null===f||void 0===f)return null;try{var g=new THREE.Texture({width:1,height:1});g.name="RocketShaderLibrary.SolidColor."+e,g.needsUpdate=!1,g.__webglTexture=f.createTexture(),f.bindTexture(f.TEXTURE_2D,g.__webglTexture);var h=new Uint8Array([a,b,c,d]);return f.texImage2D(f.TEXTURE_2D,0,f.RGBA,1,1,0,f.RGBA,f.UNSIGNED_BYTE,h),f.bindTexture(f.TEXTURE_2D,null),this.textureCache[e]=g,g}catch(i){return null}},getDefaultTexture:function(){return this.getSolidColorTexture(0,0,0,255)},createMaterial:function(a,b){if(void 0===RocketShaderLibrary[a])return TundraLogging.getLogger("RocketShaderLibrary").error("createMaterial(): Library does not contain shader:",a),null;var c=RocketShaderLibrary[a],d=THREE.UniformsUtils.clone(c.uniforms),e=new THREE.ShaderMaterial({fragmentShader:c.fragmentShader,vertexShader:c.vertexShader,uniforms:d});return e.meshmoonShaderName=a,void 0!==c.defines&&(e.defines=c.defines),c.lights===!0&&(e.lights=!0),c.perPixel===!0&&(e.perPixel=!0),b&&console.log("  -- THREE.ShaderMaterial",e.meshmoonShaderName),e},createMeshmoonMaterial:function(a,b,c){var d=MeshmoonShaderLibrary[a];if(void 0===d)return console.error("Failed to find '"+a+"' from MeshmoonShaderLibrary"),null;var e=THREE.UniformsUtils.clone(d.uniforms),f=new THREE.ShaderMaterial({fragmentShader:d.fragmentShader,vertexShader:d.vertexShader,uniforms:e});return f.name="RocketShaderLibrary."+("string"==typeof b&&""!==b?b:"Unnamed"),
f.meshmoonShaderName=a,void 0!==d.defines&&(f.defines=d.defines),this.initializeMeshmoonTextureUniforms(f),d.lights===!0&&(f.lights=!0),d.perPixel===!0&&(f.perPixel=!0),c===!0&&console.log("  -- THREE.ShaderMaterial",f.meshmoonShaderName),f},instantiateMeshmoonMaterial:function(a,b){var c=a.shaders.meshmoonShaderName();if(void 0===MeshmoonShaderLibrary[c])return TundraLogging.getLogger("RocketShaderLibrary").error("createMaterial(): Library does not contain shader:",c),null;var d=MeshmoonShaderLibrary[c],e=THREE.UniformsUtils.clone(d.uniforms),f=new THREE.ShaderMaterial({fragmentShader:d.fragmentShader,vertexShader:d.vertexShader,uniforms:e});return f.meshmoonShaderName=c,void 0!==d.defines&&(f.defines=d.defines),this.initializeMeshmoonTextureUniforms(f),this.setMeshmoonShaderUniforms(f,a,{lightMapPower:"float",specularPower:"float",specularHardness:"float",diffuseMapTiling:"float2",diffuseMap2Tiling:"float2",normalMapTiling:"float2",specularMapTiling:"float2",lightMapTiling:"float2",weightMapTiling:"float2",diffuseMapTilings:"float4array",mainColor:"float4",specularColor:"float4"}),d.lights===!0&&(f.lights=!0),d.perPixel===!0&&(f.perPixel=!0),b===!0&&console.log("  -- THREE.ShaderMaterial",f.meshmoonShaderName),f},initializeMeshmoonTextureUniforms:function(a){for(var b=Object.keys(a.uniforms),c=0;c<b.length;c++){var d=a.uniforms[b[c]];null!=d&&"t"===d.type&&null===d.value&&(d.value=this.getDefaultTexture())}},setMeshmoonShaderUniforms:function(a,b,c){for(var d in c){var e=b.shaders.fragment.getNamedParameter(d,c[d]);if(null!=e){var f=a.uniforms[d];if(void 0===f)continue;f.value=e}}},updateUniforms:function(a,b){var c="string"==typeof a.meshmoonShaderName?RocketShaderLibrary[a.meshmoonShaderName]:void 0;if(c=void 0==c?MeshmoonShaderLibrary[a.meshmoonShaderName]:c,void 0===c)return void TundraLogging.getLogger("RocketShaderLibrary").error("updateUniforms(): Given material is not part of the library:",a.meshmoonShaderName);b&&console.log(a.meshmoonShaderName);for(var d in a.uniforms){var e=a.uniforms[d];"c"===e.type&&a[d]instanceof THREE.Color&&(e.value=a[d],b&&console.log("  updated color '"+d+"'",e.value.r,e.value.g,e.value.b))}},diffuse_lightmap_uv0:{uniforms:THREE.UniformsUtils.merge([{diffuse:{type:"c",value:OgreMaterial.defaultMaterialColor(OgreMaterial.Color.Diffuse)},opacity:{type:"f",value:1},map:{type:"t",value:null},offsetRepeat:{type:"v4",value:new THREE.Vector4(0,0,1,1)},lightMap:{type:"t",value:null}},THREE.UniformsLib.fog,THREE.UniformsLib.lights,THREE.UniformsLib.shadowmap,{ambient:{type:"c",value:OgreMaterial.defaultMaterialColor(OgreMaterial.Color.Ambient)},emissive:{type:"c",value:OgreMaterial.defaultMaterialColor(OgreMaterial.Color.Emissive)},specular:{type:"c",value:OgreMaterial.defaultMaterialColor(OgreMaterial.Color.Specular)},shininess:{type:"f",value:30}}]),lights:!0,perPixel:!0,vertexShader:["#define PHONG","varying vec3 vViewPosition;","varying vec3 vNormal;","varying vec2 vUvDiffuse;","varying vec2 vUvLightmap;","uniform vec4 offsetRepeat;",THREE.ShaderChunk.lights_phong_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {","vUvDiffuse = uv * offsetRepeat.zw + offsetRepeat.xy;","vUvLightmap = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );",THREE.ShaderChunk.defaultnormal_vertex,"vNormal = normalize( transformedNormal );",THREE.ShaderChunk.default_vertex,"vViewPosition = -mvPosition.xyz;",THREE.ShaderChunk.worldpos_vertex,THREE.ShaderChunk.lights_phong_vertex,THREE.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform float opacity;","uniform vec3 ambient;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","varying vec2 vUvDiffuse;","varying vec2 vUvLightmap;","uniform sampler2D map;","uniform sampler2D lightMap;",THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.lights_phong_pars_fragment,THREE.ShaderChunk.shadowmap_pars_fragment,"void main() {","gl_FragColor = vec4( diffuse, opacity );","vec4 texelColor = texture2D( map, vUvDiffuse );","gl_FragColor = gl_FragColor * texelColor;","gl_FragColor = gl_FragColor * texture2D( lightMap, vUvLightmap );","float specularStrength = 1.0;",THREE.ShaderChunk.lights_phong_fragment,THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.fog_fragment,"}"].join("\n")},multi_diffuse_shadow:{uniforms:THREE.UniformsUtils.merge([{diffuse:{type:"c",value:OgreMaterial.defaultMaterialColor(OgreMaterial.Color.Diffuse)},opacity:{type:"f",value:1},map1:{type:"t",value:null},map2:{type:"t",value:null},offsetRepeat1:{type:"v4",value:new THREE.Vector4(0,0,1,1)},offsetRepeat2:{type:"v4",value:new THREE.Vector4(0,0,1,1)},useOffsetRepeat2:{type:"i",value:0}},THREE.UniformsLib.fog,THREE.UniformsLib.lights,THREE.UniformsLib.shadowmap,{ambient:{type:"c",value:OgreMaterial.defaultMaterialColor(OgreMaterial.Color.Ambient)},emissive:{type:"c",value:OgreMaterial.defaultMaterialColor(OgreMaterial.Color.Emissive)},specular:{type:"c",value:OgreMaterial.defaultMaterialColor(OgreMaterial.Color.Specular)},shininess:{type:"f",value:30}}]),lights:!0,perPixel:!0,vertexShader:["#define PHONG","varying vec3 vViewPosition;","varying vec3 vNormal;","varying vec2 vUvDiffuse1;","varying vec2 vUvDiffuse2;","uniform vec4 offsetRepeat1;","uniform vec4 offsetRepeat2;","uniform int useOffsetRepeat2;",THREE.ShaderChunk.lights_phong_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {","vUvDiffuse1 = uv * offsetRepeat1.zw + offsetRepeat1.xy;","if (useOffsetRepeat2 == 0)","vUvDiffuse2 = uv2 * offsetRepeat1.zw + offsetRepeat1.xy;","else","vUvDiffuse2 = uv2 * offsetRepeat2.zw + offsetRepeat2.xy;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );",THREE.ShaderChunk.defaultnormal_vertex,"vNormal = normalize( transformedNormal );",THREE.ShaderChunk.default_vertex,"vViewPosition = -mvPosition.xyz;",THREE.ShaderChunk.worldpos_vertex,THREE.ShaderChunk.lights_phong_vertex,THREE.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform float opacity;","uniform vec3 ambient;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","varying vec2 vUvDiffuse1;","varying vec2 vUvDiffuse2;","uniform sampler2D map1;","uniform sampler2D map2;",THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.lights_phong_pars_fragment,THREE.ShaderChunk.shadowmap_pars_fragment,"void main() {","gl_FragColor = vec4( diffuse, opacity );","vec4 texelColor = texture2D( map1, vUvDiffuse1 ) * texture2D( map2, vUvDiffuse2 );","gl_FragColor = gl_FragColor * texelColor;","float specularStrength = 1.0;",THREE.ShaderChunk.lights_phong_fragment,THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.fog_fragment,"}"].join("\n")}},MeshmoonAssetReloadMessage=INetworkMessage.$extend({__init__:function(){this.$super(MeshmoonAssetReloadMessage.id,"MeshmoonAssetReload"),this.assetReferences=[]},__classvars__:{id:400,name:"MeshmoonAssetReload"},deserialize:function(a){for(var b=a.readU8(),c=0;b>c;c++)this.assetReferences.push(a.readStringU16());delete a}}),MeshmoonCommon={PermissionLevel:{Basic:0,Elevated:1,Admin:2,SuperAdmin:3,PermissionLevelOutOfRange:4},permissionLevelToString:function(a){switch(a){case MeshmoonCommon.PermissionLevel.Basic:return"Basic";case MeshmoonCommon.PermissionLevel.Elevated:return"Elevated";case MeshmoonCommon.PermissionLevel.Admin:return"Admin";case MeshmoonCommon.PermissionLevel.SuperAdmin:return"SuperAdmin";default:return"Unknown"}},DenyReason:{None:0,NoPermissionCreate:1,NoPermissionModify:2,AuthNotFound:3},denyReasonMessage:function(a){switch(a){case MeshmoonCommon.DenyReason.None:return"Permission denied with unknown reason";case MeshmoonCommon.DenyReason.NoPermissionCreate:return"Permission denied to create entity";case MeshmoonCommon.DenyReason.NoPermissionModify:return"Permission denied to modify entity";case MeshmoonCommon.DenyReason.AuthNotFound:return"Not authenticated, permission denied to modify";default:return"Permission denied with unknown reason"}}},MeshmoonUserPermissionsMessage=INetworkMessage.$extend({__init__:function(){this.$super(MeshmoonUserPermissionsMessage.id,"MeshmoonUserPermissions"),this.connectionId=-1,this.permissionLevelId=MeshmoonCommon.PermissionLevel.Basic,this.permissionLevel=MeshmoonCommon.permissionLevelToString(this.permissionLevelId)},__classvars__:{id:401,name:"MeshmoonUserPermissions"},deserialize:function(a){this.connectionId=a.readU32(),this.permissionLevelId=a.readU32(),this.permissionLevel=MeshmoonCommon.permissionLevelToString(this.permissionLevelId),delete a}}),MeshmoonLayerUpdateMessage=INetworkMessage.$extend({__init__:function(){this.$super(MeshmoonLayerUpdateMessage.id,"MeshmoonLayerUpdate"),this.exists=!1,this.visible=!1,this.layerId=0,this.layerName="",this.iconUrl=""},__classvars__:{id:402,name:"MeshmoonLayerUpdate"},deserialize:function(a){this.exists=a.readBoolean(),this.visible=a.readBoolean(),this.layerId=a.readU32(),this.layerName=a.readStringU16(),this.iconUrl=a.readStringU16(),delete a},serialize:function(a){this.$super(12),this.ds.writeU16(this.id),this.ds.writeBoolean(a.exists),this.ds.writeBoolean(a.visible),this.ds.writeU32(a.id),this.ds.writeStringU16(""),this.ds.writeStringU16("")}}),MeshmoonPermissionDeniedMessage=INetworkMessage.$extend({__init__:function(){this.$super(MeshmoonPermissionDeniedMessage.id,"MeshmoonPermissionDenied"),this.entityId=void 0,this.reasonId=MeshmoonCommon.DenyReason.None,this.reason=MeshmoonCommon.denyReasonMessage(this.reasonId)},__classvars__:{id:403,name:"MeshmoonPermissionDenied"},deserialize:function(a){this.entityId=a.readU32(),this.reasonId=a.readU8(),this.reason=MeshmoonCommon.denyReasonMessage(this.reasonId),delete a}}),MeshmoonStorageInformationMessage=INetworkMessage.$extend({__init__:function(){this.$super(MeshmoonStorageInformationMessage.id,"MeshmoonStorageInformation"),this.txmlUrl="",this.storageUrl=""},__classvars__:{id:404,name:"MeshmoonStorageInformation"},deserialize:function(a){this.txmlUrl=a.readStringU16(),this.storageUrl=a.readStringU16(),delete a}}),MeshmoonMessageHandler=INetworkMessageHandler.$extend({__init__:function(){this.$super("MeshmoonMessageHandler"),this.log=TundraLogging.getLogger(this.name)},canHandle:function(a){return a>=400&&404>=a},handle:function(a,b){var c=null;return a===MeshmoonAssetReloadMessage.id?(c=new MeshmoonAssetReloadMessage,c.deserialize(b),this.log.debug("Server is requesting us to reload",c.assetReferences.length,"asset refs. Implement this!")):a===MeshmoonUserPermissionsMessage.id?(c=new MeshmoonUserPermissionsMessage,c.deserialize(b),this.log.debug("Received user permission level",c.permissionLevel,"("+c.permissionLevelId+")"),Tundra.plugins.rocket&&Tundra.plugins.rocket.permissions.reset({levelId:c.permissionLevelId,level:c.permissionLevel})):a===MeshmoonLayerUpdateMessage.id?(c=new MeshmoonLayerUpdateMessage,c.deserialize(b),Tundra.plugin("RocketPlugin").layers.updateLayer(c)):a===MeshmoonPermissionDeniedMessage.id?(c=new MeshmoonPermissionDeniedMessage,c.deserialize(b)):a===MeshmoonStorageInformationMessage.id?(c=new MeshmoonStorageInformationMessage,c.deserialize(b),this.log.debug("Received storage information")):(c=new INetworkMessage(a),this.log.warn("Unhandled Meshmoon message",c.id,c.name)),c}}),IHttpProxyResolver=Class.$extend({__init__:function(a,b,c){this.log=TundraLogging.getLogger(a),this.name=a,this.proxyUrl=void 0,this.localhost="boolean"==typeof c?c:!1,this.setProxy(b)},setProxy:function(a){""===a&&(a=void 0),this.proxyUrl=a,"string"==typeof this.proxyUrl&&""!==this.proxyUrl&&(CoreStringUtils.startsWith(this.proxyUrl,"http",!0)||(this.proxyUrl="http://"+this.proxyUrl),CoreStringUtils.endsWith(this.proxyUrl,"/")||(this.proxyUrl+="/"))},resolve:function(a,b,c,d){return void Tundra.client.logError("[IHttpProxyResolver]: resolve() function not overridden by implementation "+this.name)},resolveRequestMetadata:function(a,b){return void Tundra.client.logError("[IHttpProxyResolver]: resolveRequestMetadata() function not overridden by implementation "+this.name)}}),MeshmoonProxyResolver=IHttpProxyResolver.$extend({__init__:function(a,b,c){this.$super("MeshmoonProxyResolver",a,c),Tundra.asset.maxActiveTransfersPerType.Texture=4,this.capabilities=b||{},this.hasCapability("Asset")&&(this.log.debug("Using",this.proxyUrl),this.log.debug("Capabilities:",this.capabilities),Tundra.browser.isMobile()&&this.hasCapability("Asset","profile","mobile")&&(console.debug("[MeshmoonProxyResolver]: Enabling detected capabilities.Asset.Query.profile.mobile for textures"),MeshmoonProxyResolver.TextureProfile="mobile"))},__classvars__:{UrlPathAssets:"assets",TextureMaxSize:2048,TextureProfile:""},hasCapability:function(a,b,c){if("object"!=typeof this.capabilities)return!1;if(void 0!==this.capabilities[a]&&"string"==typeof this.capabilities[a].Path){if("string"==typeof b){if("object"!=typeof this.capabilities[a].Query||"object"!=typeof this.capabilities[a].Query[b])return!1;if("string"==typeof c){var d=this.capabilities[a].Query[b].Accepted;if(Array.isArray(d))for(var e=0;e<d.length;e++)if(d[e]===c)return!0;return!1}}return!0}return!1},setProxy:function(a){this.hasCapability("Asset")?this.log.warn("Ignoring new proxy URL. Capabilities have already been resolved."):this.$super(a)},skipProxyContains:["storage.googleapis.com/meshmoon/"],ignoreErrors:["storage.googleapis.com/meshmoon/gis/"],resolve:function(a,b,c,d){if(Tundra.asset.isLocalhostRef(b)&&this.localhost===!1)return void 0;for(var e=0;e<this.skipProxyContains.length;e++)if(-1!==b.indexOf(this.skipProxyContains[e]))return void 0;var f=this.createBaseUrl();return f+=this.getQueryRef(a,b),f+=this.getQueryType(a,b,c,d),f+=this.getQueryOptions(a,b,c,d)},resolveRequestMetadata:function(a,b){if("string"!=typeof b||""===b){for(var c=0;c<this.ignoreErrors.length;c++)if(-1!==a.ref.indexOf(this.ignoreErrors[c])){a.silent=!0;break}return void 0}var d={timeout:1e4,dataType:void 0};return"OgreMesh"===a.type||"OgreSkeleton"===a.type||"Texture"===a.type||"MeshmoonMesh"===a.type?d.dataType="arraybuffer":"ObjMesh"===a.type||"OgreMaterial"===a.type||"Script"===a.type?d.dataType="text":"RealXtendAvatarDescription"===a.type&&(d.dataType="xml"),"Text"===a.type&&".xml"===a.suffix&&(d.dataType="xml"),-1!==b.indexOf("&type=.mesh.xml")||-1!==b.indexOf("&type=.skeleton.xml")?(d.dataType="xml",d.timeout=3e4):-1!==b.indexOf("&type=.dds")||CoreStringUtils.endsWith(a.ref,".dds",!0)?d.timeout=12e4:-1!==b.indexOf("gis.meshmoon.com")&&(d.timeout=12e4),d},createBaseUrl:function(){return CoreStringUtils.endsWith(this.proxyUrl,MeshmoonProxyResolver.UrlPathAssets,!0)?this.proxyUrl:this.proxyUrl+MeshmoonProxyResolver.UrlPathAssets},getQueryRef:function(a,b){return a.ref=encodeURIComponent(b),"?ref="+a.ref},getQueryType:function(a,b,c,d){"Texture"===c?(a.type=".dds","."!==d[0]||CoreStringUtils.endsWith(b,d,!0)||(a.suffix=d)):"MeshmoonMesh"===c?(a.type=".binary",a.suffix=".mme"):"OgreMaterial"===c?".material"!==d&&(a.suffix=".material"):"Text"===c?".json"===d&&-1===b.indexOf(d)&&(a.suffix=d):"Binary"===c&&(a.suffix="string"==typeof d&&""!==d?d:".binary");var e="";return"string"==typeof a.type&&(e+="&type="+a.type),"string"==typeof a.suffix&&(e+="&suffix="+a.suffix),e},_maxAgeWeekContains:["api.tiles.mapbox.com","vector.mapzen.com"],_maxAgeDayContains:["maps.googleapis.com/maps/api/place","gis.meshmoon.com"],getQueryOptions:function(a,b,c,d){"Texture"===c&&(""===MeshmoonProxyResolver.TextureProfile||"string"!=typeof MeshmoonProxyResolver.TextureProfile?a.maxsize=MeshmoonProxyResolver.TextureMaxSize:(a.profile=MeshmoonProxyResolver.TextureProfile,""!==TextureAsset.EnabledFormat&&(a.format=TextureAsset.EnabledFormat)));for(var e=!1,f=0;f<this._maxAgeWeekContains.length;f++)if(-1!==b.indexOf(this._maxAgeWeekContains[f])){a.maxage=604800,e=!0;break}if(!e)for(var f=0;f<this._maxAgeDayContains.length;f++)if(-1!==b.indexOf(this._maxAgeDayContains[f])){a.maxage=86400,e=!0;break}var g="";return("string"==typeof a.maxsize||"number"==typeof a.maxsize)&&(g+="&maxsize="+a.maxsize),"string"==typeof a.profile&&(g+="&profile="+a.profile),"string"==typeof a.format&&(g+="&format="+a.format),("string"==typeof a.maxage||"number"==typeof a.maxage)&&(g+="&maxage="+a.maxage),g}}),MeshmoonAssetPrioritizer=Class.$extend({__init__:function(a){this.framework=a,this.log=TundraLogging.getLogger("MeshmoonAssetPrioritizer"),this.cameraUpdater={t:10,interval:.2},this.currentCameraPos=new THREE.Vector3(0,0,0),this.currentCameraPosSimple={x:0,y:0,z:0},this.intervalT=10,this.cacheExpirationT=10,this.putOnHoldThisFrame=0,this.onHoldTransfers=[],this.prioritized=[],this.prioritizedTransfers=[],this.priorityCache={},this.onAssetAboutToBeRequested=null,this.onAssetAboutToBeUnloaded=null,this._enabled=!1,this.interval=.1,this.cacheExpiration=5,this.prioritizedAssetRefs=[],this.holdOnAssetRefs=[],this._interestSetup={maxItems:1e5,radius:150,customObserverPosition:null,drawDebug:!1,debugSphere:null},this._insideRangeStates=[],this._outsideRangeStates=[],Object.defineProperties(this,{enabled:{get:function(){return this._enabled},set:function(a){this.setEnabled(a)}}}),this.framework.console.registerCommand("analyzeAssets","Meshmoon Rocket: Analyze scene assets",null,this,this._analyzeSceneAssets),this.onSceneReset(),this.framework.scene.onReset(this,this.onSceneReset),this.framework.renderer.onActiveCameraChanged(this,this.onActiveCameraChanged)},setEnabled:function(a){if("boolean"==typeof a&&this._enabled!==a){if(this._enabled=a,this.log.debug("Enabled:",this._enabled),this._enabled&&void 0===this.worker){var b=URL.createObjectURL(new Blob(["(",MeshmoonAssetPrioritizer.WorkerSource,")()"],{type:"application/javascript"}));this.worker=new Worker(b),this.worker.onmessage=this.onWorkerMessage.bind(this),URL.revokeObjectURL(b),this.postWorkerMessage({id:MeshmoonAssetPrioritizer.WorkerProtocol.Id.ProtocolDeclaration,protocol:MeshmoonAssetPrioritizer.WorkerProtocol}),this.postWorkerMessage({id:MeshmoonAssetPrioritizer.WorkerProtocol.Id.InterestSetup,setup:this._interestSetup})}this.framework.asset.autoProcessTransfers=!this._enabled,this._enabled||this.executeAllPendingTransfers()}},setInterestSetup:function(a,b){void 0!==a&&"number"==typeof a&&(this._interestSetup.radius=a),void 0!==b&&"number"==typeof b&&(this._interestSetup.maxItems=b),this.postWorkerMessage({id:MeshmoonAssetPrioritizer.WorkerProtocol.Id.InterestSetup,setup:this._interestSetup})},onActiveCameraChanged:function(a,b){this._enabled&&(this.cameraUpdater.t=2*this.cameraUpdater.interval)},onSceneReset:function(){this.framework.scene.onEntityCreated(this,this.onSceneEntityCreated),this.framework.scene.onComponentCreated(this,this.onSceneComponentCreated),this.framework.scene.onEntityRemoved(this,this.onSceneEntityRemoved)},onSceneEntityCreated:function(a,b){a.local!==!0&&(this.postWorkerMessage({id:MeshmoonAssetPrioritizer.WorkerProtocol.Id.EntityUpdate,entityId:a.id}),null!=a.mesh?this.onSceneComponentCreated(a,a.mesh):null!=a.placeable&&this.onSceneComponentCreated(a,a.placeable))},onSceneComponentCreated:function(a,b){if(a.local!==!0)if(17===b.typeId){for(var c=[b.attributes.meshRef.getClone()],d=b.attributes.materialRefs.get(),e=0;e<d.length;e++)c.push(d[e]);this.postWorkerMessage({id:MeshmoonAssetPrioritizer.WorkerProtocol.Id.RefsUpdate,entityId:a.id,refs:c})}else if(20===b.typeId){var f=b.worldPosition();f={x:f.x,y:f.y,z:f.z},this.postWorkerMessage({id:MeshmoonAssetPrioritizer.WorkerProtocol.Id.PosUpdate,entityId:a.id,pos:f})}},onSceneEntityRemoved:function(a){this.postWorkerMessage({id:MeshmoonAssetPrioritizer.WorkerProtocol.Id.EntityReset,entityId:a.id})},__classvars__:{WorkerSource:function(){importScripts("http://meshmoon.data.s3.amazonaws.com/app/oulu3d/occlusion-manager/lib/kdTree.js");var a=void 0,b={camera:{pos:null},entities:{},currentEntityStates:[],tree:null,treeSetup:null,_distance:function(a,b){return Math.pow(a.x-b.x,2)+ +Math.pow(a.z-b.z,2)},float3ToString:function(a){return a.x+" "+a.y+" "+a.z},verifyEntity:function(a){void 0===this.entities[a]&&(this.entities[a]={id:a,pos:{x:0,y:0,z:0},refs:[]})}},c=!1;onmessage=function(d){var e=d.data;return 0===e.id?(a=e.protocol,void(c&&console.log("  - Protocol received"))):void(e.id===a.Id.InterestSetup?(b.treeSetup=e.setup,c&&console.log("  - Radius: "+b.treeSetup.radius+" Max items: "+b.treeSetup.maxItems)):e.id===a.Id.StateReset?(b.camera.pos=null,b.entities={},c&&console.log("Protocol.Id.StateReset")):e.id===a.Id.CameraUpdate?b.camera.pos=e.pos:e.id===a.Id.EntityUpdate?void 0===b.entities[e.entityId]&&b.verifyEntity(e.entityId):e.id===a.Id.EntityReset?void 0!==b.entities[e.entityId]&&delete b.entities[e.entityId]:e.id===a.Id.RefsUpdate?(b.verifyEntity(e.entityId),b.entities[e.entityId].refs=e.refs):e.id===a.Id.PosUpdate?(b.verifyEntity(e.entityId),b.entities[e.entityId].pos=e.pos,b.entities[e.entityId].pos.index=e.entityId,null==b.tree?b.tree=new kdTree([b.entities[e.entityId].pos],b._distance,["x","z"]):b.tree.insert(b.entities[e.entityId].pos)):console.warn("Received unknown message "+e.id))};var d=function(){if(null!==b.tree&&null!==b.treeSetup&&null!==b.camera.pos){for(var c=b.tree.nearest({x:b.camera.pos.x,z:b.camera.pos.z},b.treeSetup.maxItems,Math.pow(b.treeSetup.radius,2)),d=!1,e=!1,f=[],g=[],h=0,i=c.length;i>h;++h){for(var j=!1,k=c[h],l=k[0].index,m=0;m<b.currentEntityStates.length;++m)if(null!=b.currentEntityStates[m]&&b.currentEntityStates[m].id===l){j=!0;break}j||(d=!0,b.currentEntityStates.push(b.entities[l])),f.push(l)}for(var m=0;m<b.currentEntityStates.length;++m)(null==b.currentEntityStates[m]||-1===f.indexOf(b.currentEntityStates[m].id))&&(e=!0,null!=b.currentEntityStates[m]&&g.push(b.currentEntityStates[m]),b.currentEntityStates.splice(m,1),m--);e&&postMessage({id:a.Id.OutsideRangeUpdate,states:g}),d&&postMessage({id:a.Id.InsideRangeUpdate,states:b.currentEntityStates})}};setInterval(d,1e3);c&&console.log("WebWorker reporting to duty")}.toString(),WorkerProtocol:{Id:{ProtocolDeclaration:0,InterestSetup:1,StateReset:2,CameraUpdate:3,EntityUpdate:4,EntityReset:5,RefsUpdate:6,PosUpdate:7,InsideRangeUpdate:8,OutsideRangeUpdate:9}}},onWorkerMessage:function(a){var b=a.data;b.id===MeshmoonAssetPrioritizer.WorkerProtocol.Id.InsideRangeUpdate?(this._insideRangeStates=b.states,this._enabled&&this._executeLoad()):b.id===MeshmoonAssetPrioritizer.WorkerProtocol.Id.OutsideRangeUpdate&&(this._outsideRangeStates=b.states)},postWorkerMessage:function(a){null!=this.worker&&this.worker.postMessage(a)},addPrioritizedAssetRefs:function(a){a="string"==typeof a?[a]:a;for(var b=a.length-1;b>=0;b--){for(var c=!1,d=this.prioritizedAssetRefs.length-1;d>=0;d--)if(this.prioritizedAssetRefs[d]===a[b]){c=!0;break}c||this.prioritizedAssetRefs.push(a[b])}},executeAllPendingTransfers:function(){for(var a=0,b=this.onHoldTransfers.length;b>a;a++)this.framework.asset.transfers.push(this.onHoldTransfers[a]);this.onHoldTransfers=[]},executePendingTransfer:function(a){for(var b=0,c=this.onHoldTransfers.length;c>b;b++){var d=this.onHoldTransfers[b];if(null!=d&&d.ref===a)return this.onHoldTransfers.splice(b,1),void this.framework.asset.transfers.push(d)}},_executeLoad:function(){if(this._enabled){for(var a=0;a<this.onHoldTransfers.length;++a){var b=this.onHoldTransfers[a];if(null!=b&&null!=b.ref)for(var c=!1,d=0,e=this._insideRangeStates.length;e>d;++d){for(var f=this._insideRangeStates[d],g=0,h=f.refs.length;h>g;++g)if(f.refs[g]===b.ref){this.onHoldTransfers.splice(a,1),this.framework.asset.transfers.push(b),a--,c=!0;break}if(c)break}}for(var d=0,e=this._insideRangeStates.length;e>d;++d){var f=this._insideRangeStates[d],i=this.framework.scene.entityById(f.id);null!=i&&null!=i.mesh&&(i.mesh.meshRequested&&i.mesh.materialsRequested||i.mesh.update())}}},_executeUnload:function(){if(this._enabled){for(var a=[],b=0,c=this._outsideRangeStates.length;c>b;++b){for(var d=!0,e=this._outsideRangeStates[b],f=0,g=e.refs.length;g>f;++f){if(null==this.onAssetAboutToBeUnloaded||this.onAssetAboutToBeUnloaded(e.refs[f],e.id)){for(var h=0,i=this.prioritizedAssetRefs.length;i>h;++h)if(e.refs[f]===this.prioritizedAssetRefs[h]){d=!1;break}}else d=!1;if(!d)break}d&&a.push(e.id)}for(var j=0;j<a.length;j++){var k=this.framework.scene.entityById(a[j]);null!=k&&null!=k.mesh&&(k.mesh.resetMesh(),this.framework.renderer.onSceneMeshUnloaded(k,k.mesh))}for(var j=0;j<a.length;j++){var k=this.framework.scene.entityById(a[j]);null!=k&&null!=k.mesh&&k.mesh.resetMaterials()}}},_update:function(a){if(this._enabled&&(this._updateCameraPosition(a),this.intervalT+=a,!(this.intervalT<this.interval))){this.intervalT=0,this.putOnHoldThisFrame=0;var b=this.framework.asset.transfers.length;if(0===b)return void(Object.keys(this.priorityCache).length>0&&(this.priorityCache={}));if(b===this.prioritizedTransfers.length)return void Tundra.asset.processTransfers();this.cacheExpirationT+=this.interval,this.cacheExpirationT>=this.cacheExpiration&&(this.priorityCache={},this.cacheExpirationT=0);var c=this.framework.scene.entitiesWithComponent("Mesh");if(0!==c.length){var d=this.framework.renderer.activeCameraEntity();if(null!=d&&null!=d.placeable){this.prioritized=[],this.prioritizedTransfers=[];for(var e=this.framework.asset.transfers,f=0,g=e.length;g>f;++f){var h=e[f],i=h.type,j=h.ref;if(h.active||h.loading)this._prioritize(0,h);else{var k=this.priorityCache[j];if(void 0===k){var l=!1;if("Script"===i&&(this._prioritize(0,h),l=!0),!l&&this.prioritizedAssetRefs.length>0)for(var m=0,n=this.prioritizedAssetRefs.length;n>m;++m)if(-1!==j.indexOf(this.prioritizedAssetRefs[m])){this._prioritize(0,h),l=!0;break}if(!l){var o="Texture"===i;if(!o)for(var p=0,q=this._insideRangeStates.length;q>p;++p){for(var r=this._insideRangeStates[p],s=0,t=r.refs.length;t>s;++s)if(r.refs[s]===j){o=!0;break}if(o)break}if(o){var u=void 0;"OgreMesh"==i||"ObjMesh"==i?u=this._findMesh(c,j,d):"OgreMaterial"===i?u=this._findMaterial(c,j,d):"Texture"===i&&(u=this._findTexture(c,j,d)),this._prioritize(u,h)}else this.putOnHoldThisFrame++,this.onHoldTransfers.push(h)}}else this._prioritize(k,h)}}var v=this.prioritized.length>0?"number"==typeof this.prioritized[0]:!1;v&&b===this.prioritizedTransfers.length+this.putOnHoldThisFrame&&(this.framework.asset.transfers=[].concat(this.prioritizedTransfers)),Tundra.asset.transfers.length>0&&Tundra.asset.processTransfers()}}}},setInterestObserverPosition:function(a){this._interestSetup.customObserverPosition=a},_updateCameraPosition:function(a){if(this.cameraUpdater.t+=a,!(this.cameraUpdater.t<this.cameraUpdater.interval)){if(this.cameraUpdater.t=0,null==this._interestSetup.customObserverPosition){var b=this.framework.renderer.activeCameraEntity();if(null==b||null==b.placeable)return;this.currentCameraPos.copy(b.placeable.worldPosition())}else this.currentCameraPos.copy(this._interestSetup.customObserverPosition);var c=this._roundFloat(this.currentCameraPos.x,2),d=this._roundFloat(this.currentCameraPos.y,2),e=this._roundFloat(this.currentCameraPos.z,2),f=!1;this.currentCameraPosSimple.x!==c&&(f=!0,this.currentCameraPosSimple.x=c),this.currentCameraPosSimple.y!==d&&(f=!0,this.currentCameraPosSimple.y=d),this.currentCameraPosSimple.z!==e&&(f=!0,this.currentCameraPosSimple.z=e),f&&(this.postWorkerMessage({id:MeshmoonAssetPrioritizer.WorkerProtocol.Id.CameraUpdate,pos:this.currentCameraPosSimple}),this._interestSetup.drawDebug&&(null==this._interestSetup.debugSphere&&(this._interestSetup.debugSphere=new THREE.Mesh(new THREE.SphereGeometry(this._interestSetup.radius,12,12),new THREE.MeshBasicMaterial({color:"rgb(255,0,0)",wireframe:!0})),this.framework.renderer.scene.add(this._interestSetup.debugSphere)),this._interestSetup.debugSphere.position.copy(this.currentCameraPos)))}},_roundFloat:function(a,b){var c=Math.round(a*Math.pow(10,b))/Math.pow(10,b);return c},_findMesh:function(a,b,c){for(var d=0,e=a.length;e>d;++d)if(a[d].mesh.attributes.meshRef.value===b)return Math.abs(c.placeable.distanceTo(a[d].placeable));return void 0},_findMaterial:function(a,b,c){for(var d=0,e=a.length;e>d;++d)for(var f=a[d].mesh.attributes.materialRefs.value,g=0,h=f.length;h>g;++g)if(f[g]===b)return Math.abs(c.placeable.distanceTo(a[d].placeable));return void 0},_findTexture:function(a,b,c){for(var d=0,e=a.length;e>d;++d)for(var f=a[d].mesh.attributes.materialRefs.value,g=0,h=f.length;h>g;++g){var i=f[g];if(""!==i){var j=this.framework.asset.getAsset(i);if(null!=j)for(var k=j.pendingDependencies(),l=0,m=k.length;m>l;++l)if(k[l]===b)return Math.abs(c.placeable.distanceTo(a[d].placeable))}}return void 0},_prioritize:function(a,b){if(void 0!==a&&"number"==typeof a)for(var c=b.type,d=0,e=this.prioritized.length;e>d;d++)if(void 0===this.prioritized[d]||"number"==typeof this.prioritized[d]&&a<this.prioritized[d]){var f=void 0!==this.prioritized[d]?this.prioritizedTransfers[d].type:"";if(("OgreMesh"===f||"ObjMesh"===f)&&"OgreMesh"!==c&&"ObjMesh"!==c)continue;return this._shouldExecute(a,b)?(this.prioritized.splice(d,0,a),this.prioritizedTransfers.splice(d,0,b)):(this.putOnHoldThisFrame++,this.onHoldTransfers.push(b)),void(this.priorityCache[b.ref]=a)}this._shouldExecute(a,b)?(this.prioritized.push(a),this.prioritizedTransfers.push(b)):(this.putOnHoldThisFrame++,this.onHoldTransfers.push(b)),void 0!==a&&"number"==typeof a&&(this.priorityCache[b.ref]=a)},_shouldExecute:function(a,b){return null==this.onAssetAboutToBeRequested||null!=this.onAssetAboutToBeRequested&&this.onAssetAboutToBeRequested(a,b)!==!1?!0:!1},_analyzeSceneAssets:function(){for(var a={mesh:{},material:{},texture:{},getOrCreate:function(a,b){return void 0===this[a][b]&&(this[a][b]={useCount:0}),this[a][b]},uniquePrefixes:function(a){var b={};for(var c in this[a]){var d=-1!==c.indexOf("/")?c.substring(0,c.lastIndexOf("/")+1):"";-1!==c.indexOf(".zip#")&&(d=c.substring(0,c.lastIndexOf(".zip#")+5)),""!=d&&(b[d]=!0)}var e=[];for(var d in b)e.push(d);return e}},b=0;b<this.framework.scene.entities.length;b++){var c=this.framework.scene.entities[b];if(null!=c.mesh){if(null!=c.mesh.meshAsset&&c.mesh.meshAsset instanceof OgreMeshAsset){var d=a.getOrCreate("mesh",c.mesh.meshAsset.name);d.useCount++}for(var e=0;e<c.mesh.ogreMaterialAssets.length;e++)if(null!=c.mesh.ogreMaterialAssets[e]&&c.mesh.ogreMaterialAssets[e]instanceof OgreMaterialAsset){var d=a.getOrCreate("material",c.mesh.ogreMaterialAssets[e].name);d.useCount++;for(var f=c.mesh.ogreMaterialAssets[e].textureRefs(),g=0;g<f.length;g++){var h=this.framework.asset.cache.get(f[g]);if(null!=h){var d=a.getOrCreate("texture",h.name);d.useCount++}}}}}for(var i in a)if("function"!=typeof a[i]){console.log("****",i.toUpperCase(),"count",Object.keys(a[i]).length,"*************************************");for(var j=a.uniquePrefixes(i),k=[],l=0;l<j.length;l++){var m=j[l].toLowerCase();console.log(m);for(var n in a[i])if(0===n.toLowerCase().indexOf(m)){k.push(n);var o=this.framework.asset.getAsset(n),p=null==o||o.isLoaded()!==!0?"error":-1===n.indexOf("_clone_")?"log":"warn";console[p]("  ",n.substring(m.length),a[i][n].useCount)}}for(var l=0;l<k.length;l++)delete a[i][k[l]];console.log(" ")}for(var q=this.framework.asset.cache.getAssets(),r=!1,l=0;l<q.length;l++)null==q[l]||q[l].isLoaded()||(r||(console.error("**** Failed assets"),r=!0),console.error("  ",o.name))}}),MeshmoonMeshAsset=IAsset.$extend({__init__:function(a){this.$super(a,"MeshmoonMeshAsset"),this.requiresCloning=!0,this.mesh=Tundra.renderer.createSceneNode(),this.mesh.name=this.name},__classvars__:{SupportedVersion:{major:0,minor:2},VertexElement:{Type:{Float:0,Int:1},Usage:{Position:0,Normal:1,UV:2,Custom:3}}},isLoaded:function(){return void 0!==this.mesh&&this.mesh.children.length>0},getSubmesh:function(a){return this.isLoaded()?this.mesh.children[a]:null},numSubmeshes:function(){return this.isLoaded()?this.mesh.children.length:0},resetMaterials:function(){for(var a=0,b=this.numSubmeshes();b>a;a++){var c=this.getSubmesh(a);null!=c&&(c.material=Tundra.renderer.materialWhite,c.material.needsUpdate=!0)}},unload:function(){if(!this.requiresCloning||!this.isCloneSource){var a=this.numSubmeshes();
this.logging&&null!=this.mesh&&a>0&&console.log("OgreMeshAsset unload",this.name),null!=this.mesh&&null!=this.mesh.parent&&this.mesh.parent.remove(this.mesh);for(var b=0;a>b;++b){var c=this.getSubmesh(b);if(null!=c&&null!=c.material&&(c.material=Tundra.renderer.materialWhite),c.geometry&&"function"==typeof c.geometry.dispose&&c.geometry.dispose(),void 0!==c.geometry.attributes){for(var d in c.geometry.attributes){var e=c.geometry.attributes[d];void 0!==e.array&&(delete e.array,e.array=[]),void 0!==e.buffer&&(delete e.buffer,e.buffer=[])}delete c.geometry.attributes}c.geometry=null}this.mesh=void 0}},isGeometryInUse:function(a){if(void 0===a.uuid)return!1;var b=!1;return Tundra.renderer.scene.traverse(function(c){b!==!0&&null!=c&&void 0!==c.geometry&&(c.geometry instanceof THREE.BufferGeometry||c.geometry instanceof THREE.Geometry)&&c.geometry.uuid===a.uuid&&(b=!0)}),b},getSceneNode:function(){return this.isLoaded()?this.mesh:null},_cloneImpl:function(a){var b=new MeshmoonMeshAsset(a);return b.cloneFrom(this,!1),b},cloneFrom:function(a,b){if(!(a instanceof MeshmoonMeshAsset))return void consoloe.log("ERROR: MeshmoonMeshAsset.cloneFrom can only clone from another MeshmoonMeshAsset instance.");b!==!1&&this.unload();for(var c=0,d=a.numSubmeshes();d>c;++c){var e=a.getSubmesh(c);if(e instanceof THREE.Mesh||e instanceof THREE.SkinnedMesh){var f=null;f=e instanceof THREE.SkinnedMesh?new THREE.SkinnedMesh(e.geometry,Tundra.renderer.materialWhite,!1):new THREE.Mesh(e.geometry,Tundra.renderer.materialWhite),f.name=this.name+"_submesh_"+c,f.tundraSubmeshIndex=e.tundraSubmeshIndex,this.mesh.add(f)}}},cloneGeometry:function(a){return a instanceof THREE.Geometry||a instanceof THREE.BufferGeometry?a.clone():(Tundra.client.logError("[MeshmoonMeshAsset]: cloneGeometry() called with incorrect 'src', must be THREE.Geometry|THREE.BufferGeometry."),null)},deserializeFromData:function(a,b,c){var d=!1;return d="arraybuffer"===b?this.deserializeFromBinary(a):this.deserializeFromXML(a)},getAttributeName:function(a){return a==MeshmoonMeshAsset.VertexElement.Usage.Position?"position":a==MeshmoonMeshAsset.VertexElement.Usage.Normal?"normal":a==MeshmoonMeshAsset.VertexElement.Usage.UV?"uv":void 0},isVersion:function(a,b){return a="number"==typeof a?a:0,b="number"==typeof b?b:0,this.version&&this.version.major>=a&&this.version.minor>=b},isVersionBelow:function(a,b){return a="number"==typeof a?a:0,b="number"==typeof b?b:0,this.version&&this.version.major<=a&&this.version.minor<=b},isSupportedVersion:function(){return this.isVersionBelow(MeshmoonMeshAsset.SupportedVersion.major,MeshmoonMeshAsset.SupportedVersion.minor)},versionString:function(a){return a&&"number"==typeof a.major&&"number"===a.minor?a.major+"."+a.minor:this.version?this.version.major+"."+this.version.minor:""},deserializeFromBinary:function(a){var b=new DataDeserializer(a),c=b.readString(3,!1);if("MME"!=c)return console.error("[MeshmoonMeshAsset]: Invalid format."),!1;if(this.version={major:b.readU8(),minor:b.readU8()},!this.isSupportedVersion())return Tundra.client.logError("[MeshmoonMeshAsset] Assets version "+this.versionString()+" is not implemented. Supported up to "+this.versionString(MeshmoonMeshAsset.SupportedVersion)),!1;this.isPointCloud=this.isVersion(0,2)?b.readBoolean():!1,this.isPointCloud&&(this.pointCloudSpacing=b.readFloat32()),this.vertexCount=b.readU32(),this.indexCount=b.readU32(),this.has32BitIndices=this.isVersion(0,2)?b.readBoolean():!0;var d=b.readU8();this.logging&&this.log.debug(this.name,"vertices:",this.vertexCount,"indices:",this.indexCount,"vertex elements:",d);for(var e=[],f=0;d>f;++f)e.push({size:b.readU8(),type:b.readU8(),usage:b.readU8()});for(var g=new THREE.BufferGeometry,h=0,i=e.length;i>h;h++){var j=e[h],k=void 0;if(j.type==MeshmoonMeshAsset.VertexElement.Type.Int){k=new Int32Array(this.vertexCount*j.size);for(var l=0,m=this.vertexCount*j.size;m>l;l++)k[l]=b.readS32()}else if(j.type==MeshmoonMeshAsset.VertexElement.Type.Float){k=new Float32Array(this.vertexCount*j.size);for(var l=0,m=this.vertexCount*j.size;m>l;l++)k[l]=b.readFloat32()}if(k){var n=this.getAttributeName(j.usage);g.addAttribute(n,new THREE.BufferAttribute(k,j.size))}else this.log.error("Invalid vertex element:",j)}if(!this.isPointCloud){for(var o=this.has32BitIndices?new Uint32Array(this.indexCount):new Uint16Array(this.indexCount),f=0,p=this.indexCount;p>f;++f)o[f]=this.has32BitIndices?b.readU32():b.readU16();g.addAttribute("index",new THREE.BufferAttribute(o,1)),g.addDrawCall(0,this.indexCount)}if(g.computeBoundingBox(),g.computeBoundingSphere(),this.isPointCloud){var q=new THREE.PointCloud(g,Tundra.renderer.materialWhite);this.mesh.add(q)}else{var r=new THREE.Mesh(g,Tundra.renderer.materialWhite);r.tundraSubmeshIndex=this.numSubmeshes(),this.mesh.add(r)}return Tundra.renderer.renderer.info.memory.geometries++,!0}}),ObjMeshAsset=IAsset.$extend({__init__:function(a){this.$super(a,"ObjMeshAsset"),this.requiresCloning=!0,this.mesh=void 0},__classvars__:{Loader:new THREE.OBJLoader},isLoaded:function(){return void 0!==this.mesh&&this.mesh.children.length>0},unload:function(){if(!this.requiresCloning||!this.isCloneSource){var a=this.numSubmeshes();this.logging&&null!=this.mesh&&a>0&&console.log("ObjMeshAsset unload",this.name),null!=this.mesh&&null!=this.mesh.parent&&this.mesh.parent.remove(this.mesh);for(var b=0;a>b;b++){this.logging&&console.log("  submesh "+b);var c=this.getSubmesh(b);null!=c.geometry&&(this.logging&&console.log("    geometry"),this.isGeometryInUse(c.geometry)===!1?c.geometry.dispose():this.logging&&console.log("      Still in use, not unloading"),c.geometry=null),c.material=null,c=null}null!=this.mesh&&(this.mesh.children=[]),this.mesh=void 0}},isGeometryInUse:function(a){if(void 0===a.uuid)return!1;var b=!1;return Tundra.renderer.scene.traverse(function(c){b!==!0&&null!=c&&void 0!==c.geometry&&(c.geometry instanceof THREE.BufferGeometry||c.geometry instanceof THREE.Geometry)&&c.geometry.uuid===a.uuid&&(b=!0)}),b},_cloneImpl:function(a){var b=new ObjMeshAsset(a);b.mesh=Tundra.renderer.createSceneNode();for(var c=0,d=this.numSubmeshes();d>c;++c){var e=this.getSubmesh(c),f=null;f=e instanceof THREE.SkinnedMesh?new THREE.SkinnedMesh(e.geometry,Tundra.renderer.materialWhite,!1):new THREE.Mesh(e.geometry,Tundra.renderer.materialWhite),f.name=b.name+"_submesh_"+c,f.tundraSubmeshIndex=e.tundraSubmeshIndex,b.mesh.add(f)}return b},getSceneNode:function(){return this.isLoaded()?this.mesh:null},getSubmesh:function(a){return this.isLoaded()?this.mesh.children[a]:null},numSubmeshes:function(){return this.isLoaded()?this.mesh.children.length:0},deserializeFromData:function(a,b,c){try{this.mesh=ObjMeshAsset.Loader.parse(a)}catch(d){this.log.error("Failed to load OBJ mesh",this.name,d.toString()),this.mesh=void 0}(void 0===this.mesh||null===this.mesh)&&(this.mesh=Tundra.renderer.createSceneNode()),this.mesh.name=this.name,this.mesh.matrixAutoUpdate=!1;for(var e=0;e<this.mesh.children.length;e++)this.mesh.children[e].tundraSubmeshIndex=e,this.mesh.children[e].name=this.name+"_submesh_"+e;return this.isLoaded()}}),OgreDefines={RenderOperation:{POINT_LIST:1,LINE_LIST:2,LINE_STRIP:3,TRIANGLE_LIST:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6}},OgreVertexElement=Class.$extend({__init__:function(a,b,c,d,e){this.source=a,this.type=b,this.semantic=c,this.offset=d,this.index=e,this.typeName=OgreVertexElement.getTypeName(this.type),this.size=OgreVertexElement.getTypeSize(this.type),this.itemCount=OgreVertexElement.getTypeItemCount(this.type)},__classvars__:{type:{FLOAT1:0,FLOAT2:1,FLOAT3:2,FLOAT4:3,COLOUR:4,SHORT1:5,SHORT2:6,SHORT3:7,SHORT4:8,UBYTE4:9,COLOUR_ARGB:10,COLOUR_ABGR:11,DOUBLE1:12,DOUBLE2:13,DOUBLE3:14,DOUBLE4:15,USHORT1:16,USHORT2:17,USHORT3:18,USHORT4:19,INT1:20,INT2:21,INT3:22,INT4:23,UINT1:24,UINT2:25,UINT3:26,UINT4:27},semantic:{POSITION:1,BLEND_WEIGHTS:2,BLEND_INDICES:3,NORMAL:4,DIFFUSE:5,SPECULAR:6,TEXTURE_COORDINATES:7,BINORMAL:8,TANGENT:9,COUNT:9},getTypeName:function(a){switch(a){case OgreVertexElement.type.COLOUR:return"COLOUR";case OgreVertexElement.type.COLOUR_ABGR:return"COLOUR_ABGR";case OgreVertexElement.type.COLOUR_ARGB:return"COLOUR_ARGB";case OgreVertexElement.type.FLOAT1:return"FLOAT1";case OgreVertexElement.type.FLOAT2:return"FLOAT2";case OgreVertexElement.type.FLOAT3:return"FLOAT3";case OgreVertexElement.type.FLOAT4:return"FLOAT4";case OgreVertexElement.type.DOUBLE1:return"DOUBLE1";case OgreVertexElement.type.DOUBLE2:return"DOUBLE2";case OgreVertexElement.type.DOUBLE3:return"DOUBLE3";case OgreVertexElement.type.DOUBLE4:return"DOUBLE4";case OgreVertexElement.type.SHORT1:return"SHORT1";case OgreVertexElement.type.SHORT2:return"SHORT2";case OgreVertexElement.type.SHORT3:return"SHORT3";case OgreVertexElement.type.SHORT4:return"SHORT4";case OgreVertexElement.type.USHORT1:return"USHORT1";case OgreVertexElement.type.USHORT2:return"USHORT2";case OgreVertexElement.type.USHORT3:return"USHORT3";case OgreVertexElement.type.USHORT4:return"USHORT4";case OgreVertexElement.type.INT1:return"INT1";case OgreVertexElement.type.INT2:return"INT2";case OgreVertexElement.type.INT3:return"INT3";case OgreVertexElement.type.INT4:return"INT4";case OgreVertexElement.type.UINT1:return"UINT1";case OgreVertexElement.type.UINT2:return"UINT2";case OgreVertexElement.type.UINT3:return"UINT3";case OgreVertexElement.type.UINT4:return"UINT4";case OgreVertexElement.type.UBYTE4:return"UBYTE4"}return"Unknown"},getTypeSize:function(a){switch(a){case OgreVertexElement.type.COLOUR:case OgreVertexElement.type.COLOUR_ABGR:case OgreVertexElement.type.COLOUR_ARGB:return 4;case OgreVertexElement.type.FLOAT1:return 4;case OgreVertexElement.type.FLOAT2:return 8;case OgreVertexElement.type.FLOAT3:return 12;case OgreVertexElement.type.FLOAT4:return 16;case OgreVertexElement.type.DOUBLE1:return 8;case OgreVertexElement.type.DOUBLE2:return 16;case OgreVertexElement.type.DOUBLE3:return 24;case OgreVertexElement.type.DOUBLE4:return 32;case OgreVertexElement.type.SHORT1:return 2;case OgreVertexElement.type.SHORT2:return 4;case OgreVertexElement.type.SHORT3:return 6;case OgreVertexElement.type.SHORT4:return 8;case OgreVertexElement.type.USHORT1:return 2;case OgreVertexElement.type.USHORT2:return 4;case OgreVertexElement.type.USHORT3:return 6;case OgreVertexElement.type.USHORT4:return 8;case OgreVertexElement.type.INT1:return 4;case OgreVertexElement.type.INT2:return 8;case OgreVertexElement.type.INT3:return 12;case OgreVertexElement.type.INT4:return 16;case OgreVertexElement.type.UINT1:return 4;case OgreVertexElement.type.UINT2:return 8;case OgreVertexElement.type.UINT3:return 12;case OgreVertexElement.type.UINT4:return 16;case OgreVertexElement.type.UBYTE4:return 4}return void 0},getTypeItemCount:function(a){switch(a){case OgreVertexElement.type.COLOUR:case OgreVertexElement.type.COLOUR_ABGR:case OgreVertexElement.type.COLOUR_ARGB:return 4;case OgreVertexElement.type.FLOAT1:case OgreVertexElement.type.DOUBLE1:case OgreVertexElement.type.SHORT1:case OgreVertexElement.type.USHORT1:case OgreVertexElement.type.INT1:case OgreVertexElement.type.UINT1:return 1;case OgreVertexElement.type.FLOAT2:case OgreVertexElement.type.DOUBLE2:case OgreVertexElement.type.SHORT2:case OgreVertexElement.type.USHORT2:case OgreVertexElement.type.INT2:case OgreVertexElement.type.UINT2:return 2;case OgreVertexElement.type.FLOAT3:case OgreVertexElement.type.DOUBLE3:case OgreVertexElement.type.SHORT3:case OgreVertexElement.type.USHORT3:case OgreVertexElement.type.INT3:case OgreVertexElement.type.UINT3:return 3;case OgreVertexElement.type.FLOAT4:case OgreVertexElement.type.DOUBLE4:case OgreVertexElement.type.SHORT4:case OgreVertexElement.type.USHORT4:case OgreVertexElement.type.INT4:case OgreVertexElement.type.UINT4:return 4;case OgreVertexElement.type.UBYTE4:return 4}return void 0}},getTypeName:function(){return this.typeName},getSize:function(){return this.size},getItemCount:function(){return this.itemCount}}),OgreVertexDeclaration=Class.$extend({__init__:function(){this.elements=[]},addElement:function(a){a instanceof OgreVertexElement?this.elements.push(a):Tundra.client.logError("[OgreVertexDeclaration]: addElement() called with non OgreVertexElement parameter")},getElement:function(a,b){for(var c=0;c<this.elements.length;c++){var d=this.elements[c];if(d.semantic===a){if(void 0===b)return d;if(d.index===b)return d}}return null},getElementsInOffsetOrder:function(a){if(0===this.elements.length)return[];for(var b=[],c=null,d=!1,e=0;e<this.elements.length;++e)if(c=this.elements[e],c.source===a){d=!1;for(var f=0;f<b.length;++f)if(c.offset<b[f].offset){b.splice(f,1,c),d=!0;break}d||b.push(c)}return b},getVertexSize:function(a){for(var b=0,c=this.elements.length,d=0;c>d;d++){var e=this.elements[d];e.source===a&&(b+=e.getSize())}return b}}),OgreVertexBufferBinding=Class.$extend({__init__:function(){this.bindings={}},numBindings:function(){return Object.keys(this.bindings).length},setBinding:function(a,b){this.bindings[a]=b},getBinding:function(a){return this.bindings[a]}}),OgreVertexData=Class.$extend({__init__:function(){this.vertexStart=0,this.vertexCount=void 0,this.vertexDeclaration=new OgreVertexDeclaration,this.vertexBufferBinding=new OgreVertexBufferBinding},getElementItemCount:function(a,b){var c=this.vertexDeclaration.getElement(a,b);return null!=c?c.getItemCount():-1},getElementSize:function(a,b){var c=this.vertexDeclaration.getElement(a,b);return null!=c?c.getSize():-1},getUVType:function(a){var b=this.vertexDeclaration.getElement(OgreVertexElement.semantic.TEXTURE_COORDINATES,a);return null!=b?b.type:void 0},getUvSize:function(a){var b=this.vertexDeclaration.getElement(OgreVertexElement.semantic.TEXTURE_COORDINATES,a);return null!=b?b.getSize():void 0},getVertexDataArrays:function(a,b){void 0===a&&(a=Number.MAX_VALUE),void 0===b&&(b=!1);for(var c={vertices:[],normals:[],uvs:[[]],hasUvLayer:function(a){return void 0!==this.uvs[a]&&this.uvs[a].length>0},getUvLayer:function(a){return this.uvs[a]},getUvCoord:function(a,b){return void 0!==this.uvs[a]?this.uvs[a][b]:void 0},wrapUvRange:function(a){return 0>a?(console.log("Correction",a,"->",1-Math.abs(a)%1),1-Math.abs(a)%1):a>1?(console.log("Correction",a,"->",a-1),a-1):a}},d=0;d<this.vertexBufferBinding.numBindings();++d){var e=this.vertexBufferBinding.getBinding(d),f=(this.vertexDeclaration.getVertexSize(d),this.vertexDeclaration.getElementsInOffsetOrder(d));b&&(console.log("Iterating vertex buffer at binding index",d),console.log(f));for(var g=new DataDeserializer(e.buffer,e.byteOffset,e.length),h=0;h<this.vertexCount;++h)for(var i=0;i<f.length;++i){var j=!1,k=f[i];switch(k.semantic){case OgreVertexElement.semantic.POSITION:j=this._readElement(g,k.type,c.vertices);break;case OgreVertexElement.semantic.NORMAL:j=this._readElement(g,k.type,c.normals);break;case OgreVertexElement.semantic.TEXTURE_COORDINATES:if(k.index>=a)break;void 0===c.uvs[k.index]&&(c.uvs[k.index]=[]),j=this._readElement(g,k.type,c.uvs[k.index])}j||g.skipBytes(k.getSize())}}return c},_readElement:function(a,b,c){if(b===OgreVertexElement.type.SHORT1||b===OgreVertexElement.type.USHORT1)c.push([a.readU16()]);else if(b===OgreVertexElement.type.SHORT2||b===OgreVertexElement.type.USHORT2)c.push([a.readU16(),a.readU16()]);else if(b===OgreVertexElement.type.SHORT3||b===OgreVertexElement.type.USHORT3)c.push([a.readU16(),a.readU16(),a.readU16()]);else if(b===OgreVertexElement.type.SHORT4||b===OgreVertexElement.type.USHORT4)c.push([a.readU16(),a.readU16(),a.readU16(),a.readU16()]);else if(b===OgreVertexElement.type.INT1||b===OgreVertexElement.type.UINT1)c.push([a.readU32()]);else if(b===OgreVertexElement.type.INT2||b===OgreVertexElement.type.UINT2)c.push([a.readU32(),a.readU32()]);else if(b===OgreVertexElement.type.INT3||b===OgreVertexElement.type.UINT3)c.push([a.readU32(),a.readU32(),a.readU32()]);else if(b===OgreVertexElement.type.INT4||b===OgreVertexElement.type.UINT4)c.push([a.readU32(),a.readU32(),a.readU32(),a.readU32()]);else if(b===OgreVertexElement.type.FLOAT1)c.push([a.readFloat32()]);else if(b===OgreVertexElement.type.FLOAT2)c.push([a.readFloat32(),a.readFloat32()]);else if(b===OgreVertexElement.type.FLOAT3)c.push([a.readFloat32(),a.readFloat32(),a.readFloat32()]);else if(b===OgreVertexElement.type.FLOAT4)c.push([a.readFloat32(),a.readFloat32(),a.readFloat32(),a.readFloat32()]);else if(b===OgreVertexElement.type.DOUBLE1)c.push([a.readFloat64()]);else if(b===OgreVertexElement.type.DOUBLE2)c.push([a.readFloat64(),a.readFloat64()]);else if(b===OgreVertexElement.type.DOUBLE3)c.push([a.readFloat64(),a.readFloat64(),a.readFloat64()]);else if(b===OgreVertexElement.type.DOUBLE4)c.push([a.readFloat64(),a.readFloat64(),a.readFloat64(),a.readFloat64()]);else{if(b!==OgreVertexElement.type.UBYTE4)return Tundra.client.logWarning("[OgreVertexData]: Reading element data of type "+b+" not supported!",!0),!1;c.push([a.readU8(),a.readU8(),a.readU8(),a.readU8()])}return!0},getVertices:function(){var a=this.vertexDeclaration.getElement(OgreVertexElement.semantic.POSITION);return null!=a?this.getElementList(a):null},getNormals:function(){var a=this.vertexDeclaration.getElement(OgreVertexElement.semantic.NORMAL);return null!=a?this.getElementList(a):null},getElementList:function(a){for(var b=a.offset,c=this.vertexDeclaration.getVertexSize(0)-(b+a.getSize()),d=this.vertexDeclaration.vertexBuffer,e=new DataDeserializer(d.buffer,d.byteOffset,d.length),f=[];e.bytesLeft()>0;)a.type===OgreVertexElement.type.FLOAT3&&(e.skipBytes(b),f.push([e.readFloat32(),e.readFloat32(),e.readFloat32()]),e.skipBytes(c));return f}}),OgreMesh=Class.$extend({__init__:function(){this.submeshes=[],this.sharedVertexData=null,this.skeletonName="",this.boneAssignments={},this.AABB={min:{x:0,y:0,z:0},max:{x:0,y:0,z:0}},this.radius=0},numSubmeshes:function(){return this.submeshes.length},getSubmesh:function(a){return this.numSubmeshes()>a?this.submeshes[a]:null},addSubmesh:function(a){this.submeshes.push(a)},addBoneAssignment:function(a){this.boneAssignments[a.vertexIndex]=a},numBoneAssignments:function(){return Object.keys(this.boneAssignments).length}}),OgreSkeleton=Class.$extend({__init__:function(a){this.name=a,this.bones={},this.bonesFlat=[],this.animations={},this.animationsFlat=[]},__classvars__:{MAX_NUM_BONES:256,BlendMode:{AVERAGE:0,CUMULATIVE:1}},getBone:function(a){if("number"==typeof a)return this.bones[a];if("string"==typeof a)for(var b in this.bones)if(this.bones[b].name===a)return this.bones[b];return null},addBone:function(a){this.bones[a.id]=a,this.bonesFlat.push(a)},parentBone:function(a,b){this.bones[a].parentId=b,this.bones[a].parent=this.getBone(b)},addAnimation:function(a){this.animations[a.name]=a,this.animationsFlat.push(a)}}),OgreAnimation=Class.$extend({__init__:function(a,b){this.name=a,this.length=b,this.tracks=[]},addTrack:function(a){this.tracks.push(a)}}),OgreThreeJsUtils={MAX_UV_SETS:2,WRITTEN_INDEXES:{},OLD_TO_NEW_INDEXES:{},logError:function(a){return Tundra.client.logError("[OgreThreeJsUtils]: "+a,!0),!1},logWarning:function(a){return Tundra.client.logWarning("[OgreThreeJsUtils]: "+a,!0),!1},convertOgreMesh:function(a,b,c){if((void 0===c||"boolean"!=typeof c)&&(c=!1),!(a instanceof OgreMesh))return this.logError("convertOgreMesh() 'ogreMesh' parameter is not of type OgreMesh");if(!(b instanceof THREE.Object3D))return this.logError("convertOgreMesh() 'parentThreeJsObject' parameter is not of type THREE.Object3D");try{for(var d=null!==a.sharedVertexData?a.sharedVertexData.getVertexDataArrays(this.MAX_UV_SETS,c):null,e=a.numSubmeshes(),f=0;e>f;++f){var g=a.getSubmesh(f);if(null==g)return this.logError("Failed to get submesh index "+f);if(g.operationType!==OgreDefines.RenderOperation.TRIANGLE_LIST)return this.logError("Submesh operation type is not TRIANGLE_LIST.");var h=new THREE.BufferGeometry;if(g.useSharedVertices){if(!this._convertGeometry(a,g,h,g.indexData,a.sharedVertexData,d))return!1}else{var i=g.vertexData.getVertexDataArrays(this.MAX_UV_SETS,c);if(!this._convertGeometry(a,g,h,g.indexData,g.vertexData,i))return!1}h.computeBoundingBox(),h.computeBoundingSphere(),void 0===h.attributes.normal&&h.computeVertexNormals(),void 0===h.attributes.tangent&&void 0!==h.attributes.index&&void 0!==h.attributes.position&&void 0!==h.attributes.normal&&void 0!==h.attributes.uv&&h.computeTangents();var j=null;j=void 0!==h.attributes.skinIndex&&void 0!==h.attributes.skinWeight?new THREE.SkinnedMesh(h,Tundra.renderer.materialWhite,!1):new THREE.Mesh(h,Tundra.renderer.materialWhite),j.name=b.name+"_submesh_"+g.index,j.tundraSubmeshIndex=g.index,b.add(j),delete g,delete h,delete j,g=void 0,h=void 0,j=void 0}return!0}catch(k){return void 0!==k.stack?console.error(k.stack):console.error(k),!1}},_convertGeometry:function(a,b,c,d,e,f){var g=new DataDeserializer(d.indexBuffer.buffer,d.indexBuffer.byteOffset,d.indexBuffer.length),h=d.is32bit,i=[],j=-1;for(this.OLD_TO_NEW_INDEXES={};g.bytesLeft()>0;){var k={a:h?g.readU32():g.readU16(),b:h?g.readU32():g.readU16(),c:h?g.readU32():g.readU16()},l={a:k.a,b:k.b,c:k.c},m=this.OLD_TO_NEW_INDEXES[k.a];void 0===m?(this.OLD_TO_NEW_INDEXES[k.a]=++j,k.a=j):k.a=m,m=this.OLD_TO_NEW_INDEXES[k.b],void 0===m?(this.OLD_TO_NEW_INDEXES[k.b]=++j,k.b=j):k.b=m,m=this.OLD_TO_NEW_INDEXES[k.c],void 0===m?(this.OLD_TO_NEW_INDEXES[k.c]=++j,k.c=j):k.c=m,i.push({assigned:k,read:l})}var n=Object.keys(this.OLD_TO_NEW_INDEXES).length,o=3*i.length,p=e.getElementItemCount(OgreVertexElement.semantic.POSITION),q=e.getElementItemCount(OgreVertexElement.semantic.NORMAL),r=e.getElementItemCount(OgreVertexElement.semantic.TEXTURE_COORDINATES,0),s=e.getElementItemCount(OgreVertexElement.semantic.TEXTURE_COORDINATES,1);r>2&&(r=2),s>2&&(s=2);var t=new DataSerializer(o,h===!0?DataSerializer.ArrayType.Uint32:DataSerializer.ArrayType.Uint16),u=f.vertices.length>0?new DataSerializer(n*p,DataSerializer.ArrayType.Float32):null,v=f.normals.length>0?new DataSerializer(n*q,DataSerializer.ArrayType.Float32):null,w=f.hasUvLayer(0)===!0?new DataSerializer(n*r,DataSerializer.ArrayType.Float32):null,x=f.hasUvLayer(1)===!0?new DataSerializer(n*s,DataSerializer.ArrayType.Float32):null,y=b.numBoneAssignments()>0?new DataSerializer(4*n,DataSerializer.ArrayType.Float32):null,z=b.numBoneAssignments()>0?new DataSerializer(4*n,DataSerializer.ArrayType.Float32):null;this.WRITTEN_INDEXES={};for(var A=0;A<i.length;++A)this._writeIndexToVertexBuffer(f,i[A],t,u,v,w,x);if(b.numBoneAssignments()>0)for(var B=0;n>B;++B){var C=this.OLD_TO_NEW_INDEXES[B],D=16*C,E=b.getBoneAssignmentsForVertexIndex(C);if(E.length>4)for(var F=0;F<E.length&&!(0==E[F].weight&&(E.splice(F,1),E.length<=4));F++);for(var G=0;4>G&&E.length>G;++G)y.data.setFloat32(D+4*G,E[G].boneIndex,!0),z.data.setFloat32(D+4*G,E[G].weight,!0);y.bytePos=D+16}return c.addDrawCall(0,o),null!=t&&(c.addAttribute("index",new THREE.BufferAttribute(t.array,1)),c.attributes.index.is32bit=h),null!=u&&c.addAttribute("position",new THREE.BufferAttribute(u.array,3)),null!=v&&c.addAttribute("normal",new THREE.BufferAttribute(v.array,3)),null!=w&&c.addAttribute("uv",new THREE.BufferAttribute(w.array,r)),null!=x&&c.addAttribute("uv2",new THREE.BufferAttribute(x.array,s)),null!=z&&c.addAttribute("skinWeight",new THREE.BufferAttribute(z.array,4)),null!=y&&c.addAttribute("skinIndex",new THREE.BufferAttribute(y.array,4)),Tundra.renderer.renderer.info.memory.geometries++,this.WRITTEN_INDEXES={},this.OLD_TO_NEW_INDEXES={},delete i,i=void 0,!0},_writeIndexToVertexBuffer:function(a,b,c,d,e,f,g){var h=null,i=null,j=null,k=null;c.type===DataSerializer.ArrayType.Uint16?(c.writeU16(b.assigned.a),c.writeU16(b.assigned.b),c.writeU16(b.assigned.c)):(c.writeU32(b.assigned.a),c.writeU32(b.assigned.b),c.writeU32(b.assigned.c));for(var l=void 0!==b.read?b.read:b.assigned,m=0;3>m;++m)h=0===m?l.a:1===m?l.b:l.c,void 0===this.WRITTEN_INDEXES[h]&&(this.WRITTEN_INDEXES[h]=!0,null!=d&&(i=a.vertices[h],d.writeFloat32(i[0]),d.writeFloat32(i[1]),d.writeFloat32(i[2])),null!=e&&(j=a.normals[h],e.writeFloat32(j[0]),e.writeFloat32(j[1]),e.writeFloat32(j[2])),null!=f&&(k=a.getUvCoord(0,h),f.writeFloat32(k[0]),f.writeFloat32(k[1])),null!=g&&(k=a.getUvCoord(1,h),g.writeFloat32(k[0]),g.writeFloat32(k[1])))},convertOgreAnimation:function(a,b,c,d){if((void 0===d||"boolean"!=typeof d)&&(d=!1),!(a instanceof OgreSkeleton))return this.logError("convertOgreAnimation() 'ogreSkeleton' parameter is not of type OgreSkeleton");if(void 0===a.name)return this.logError("convertOgreAnimation() 'ogreSkeleton' parameter needs to have a unique 'name' property!");if(!(b instanceof OgreAnimation))return this.logError("convertOgreAnimation() 'ogreAnimation' parameter is not of type OgreAnimation");if("object"!=typeof c)return this.logError("convertOgreAnimation() 'animation' parameter is not of type 'object'");c.originalName=b.name,c.name=a.name+"_"+b.name,c.length=b.length,c.fps=24,c.initialized=!1,c.hierarchy=[],c.bonesFlat=this.convertOgreBones(a),c.bones=this.createThreeJsBoneHierarchy(c.bonesFlat),d&&console.log(c.originalName),d&&console.log("  >> Tracks: "+b.tracks.length);for(var e=0;e<c.bonesFlat.length;e++){for(var f=!1,g=0;g<b.tracks.length;g++)if(c.bonesFlat[e].name===b.tracks[g].bone.name){var h=c.bonesFlat[e];h.keys=[],d&&console.log("    >> "+h.name);var i=b.tracks[g];d&&console.log("      >> Keyframes: "+i.keyFrames.length);for(var j=0;j<i.keyFrames.length;j++){var k=i.keyFrames[j],l={time:k.time,pos:k.toArray("position",!0),rot:this.quaternionFromObject(k.quaternion),scl:k.toArray("scale")};l.rot.multiplyQuaternions(this.quaternionFromObject(k.bone.quaternion),l.rot),h.keys.push(l)}c.hierarchy.push(h),f=!0}if(!f){d&&console.log(">>",e,c.bonesFlat[e].name,"[SIMULATED]");var h=c.bonesFlat[e];h.keys=[],h.keys.push({time:0,pos:[h.position.x,h.position.y,h.position.z],rot:h.quaternion.clone(),scl:[1,1,1],interpolate:function(){},apply:function(){},hasTarget:function(){return!0}},{time:c.length,pos:[h.position.x,h.position.y,h.position.z],rot:h.quaternion.clone(),scl:[1,1,1],interpolate:function(){},apply:function(){},hasTarget:function(){return!0}}),c.hierarchy.push(h)}}return!0},convertOgreBones:function(a){for(var b=[],c=0;c<a.bonesFlat.length;c++){var d=a.bonesFlat[c],e=new THREE.Bone;e.name=d.name,e.sourceBoneId=d.id,e.parentName=null!=d.parent?d.parent.name:"",this.copyObjectToVector3(e.position,d.position),this.copyObjectToQuaternion(e.quaternion,d.quaternion),e.originalPosition=e.position.clone(),e.originalQuaternion=e.quaternion.clone(),b.push(e)}return b},createThreeJsBoneHierarchy:function(a){for(var b=[],c=function(a,b){for(var d=null,e=0;e<b.length&&(b[e].name===a?d=b[e]:null!=b[e].children&&b[e].children.length>0&&(d=c(a,b[e].children)),null==d);e++);return d},d=function(b){for(var d=null,e=0;e<a.length&&(a[e].name===b?d=a[e]:null!=a[e].children&&a[e].children.length>0&&(d=c(b,a[e].children)),null==d);e++);return d},e=0;e<a.length;e++){var f=a[e],g=d(f.parentName);null!=f&&null!=g?g.add(f):b.push(f)}return b},copyObjectToVector3:function(a,b){a.set(b.x,b.y,b.z)},copyObjectToQuaternion:function(a,b){a.set(b.x,b.y,b.z,b.w)},quaternionFromObject:function(a){return new THREE.Quaternion(a.x,a.y,a.z,a.w)},loadOgreAnimations:function(a,b){for(var c={},d=0;d<a.animationsFlat.length;d++){var e={};if(!OgreThreeJsUtils.convertOgreAnimation(a,a.animationsFlat[d],e,b))return[];c[e.originalName]=e}return c}},OgreIndexData=Class.$extend({__init__:function(){this.indexStart=0,this.indexCount=0,this.is32bit=!1,this.indexBuffer=null},readIndexBuffer:function(a){this.indexBuffer=a.readUint8Array(this.indexCount*(this.is32bit?4:2))}}),OgreSubMesh=Class.$extend({__init__:function(){this.name="",this.index=void 0,this.materialName="",this.useSharedVertices=!1,this.indexData=new OgreIndexData,this.vertexData=null,this.operationType=void 0,this.boneAssignments={}},addBoneAssignment:function(a){void 0===this.boneAssignments[a.vertexIndex]&&(this.boneAssignments[a.vertexIndex]=[]),this.boneAssignments[a.vertexIndex].push(a)},getBoneAssignmentsForVertexIndex:function(a){return void 0===this.boneAssignments[a]&&(this.boneAssignments[a]=[]),this.boneAssignments[a]},numBoneAssignments:function(){return Object.keys(this.boneAssignments).length}}),OgreVertexBoneAssignment=Class.$extend({__init__:function(a,b,c){this.vertexIndex=a,this.boneIndex=b,this.weight=c}}),OgreMeshSerializer=Class.$extend({__init__:function(a){void 0===a&&(a={}),this.logging=void 0===a.logging?!1:a.logging,this.reset()},__classvars__:{supportedVersions:["[MeshSerializer_v1.8]","[MeshSerializer_v1.41]"],isSupportedVersion:function(a){for(var b=0;b<OgreMeshSerializer.supportedVersions.length;b++)if(OgreMeshSerializer.supportedVersions[b]===a)return!0;return!1},chunk:{HEADER:4096,HEADER_ENDIAN_FLIP:16,MESH:12288,SUBMESH:16384,SUBMESH_OPERATION:16400,SUBMESH_BONE_ASSIGNMENT:16640,SUBMESH_TEXTURE_ALIAS:16896,GEOMETRY:20480,GEOMETRY_VERTEX_DECLARATION:20736,GEOMETRY_VERTEX_ELEMENT:20752,GEOMETRY_VERTEX_BUFFER:20992,GEOMETRY_VERTEX_BUFFER_DATA:21008,MESH_SKELETON_LINK:24576,MESH_BONE_ASSIGNMENT:28672,MESH_LOD:32768,MESH_LOD_USAGE:33024,MESH_LOD_MANUAL:33040,MESH_LOD_GENERATED:33056,MESH_BOUNDS:36864,SUBMESH_NAME_TABLE:40960,SUBMESH_NAME_TABLE_ELEMENT:41216,EDGE_LISTS:45056,EDGE_LIST_LOD:45312,EDGE_GROUP:45328},chunkIdToString:function(a){switch(a){case this.chunk.HEADER:return"HEADER";case this.chunk.HEADER_ENDIAN_FLIP:return"HEADER_ENDIAN_FLIP";case this.chunk.MESH:return"MESH";case this.chunk.SUBMESH:return"SUBMESH";case this.chunk.SUBMESH_OPERATION:return"SUBMESH_OPERATION";case this.chunk.SUBMESH_BONE_ASSIGNMENT:return"SUBMESH_BONE_ASSIGNMENT";case this.chunk.SUBMESH_TEXTURE_ALIAS:return"SUBMESH_TEXTURE_ALIAS";case this.chunk.GEOMETRY:return"GEOMETRY";case this.chunk.GEOMETRY_VERTEX_DECLARATION:return"GEOMETRY_VERTEX_DECLARATION";case this.chunk.GEOMETRY_VERTEX_ELEMENT:return"GEOMETRY_VERTEX_ELEMENT";case this.chunk.GEOMETRY_VERTEX_BUFFER:return"GEOMETRY_VERTEX_BUFFER";case this.chunk.GEOMETRY_VERTEX_BUFFER_DATA:return"GEOMETRY_VERTEX_BUFFER_DATA";case this.chunk.MESH_SKELETON_LINK:return"MESH_SKELETON_LINK";case this.chunk.MESH_BONE_ASSIGNMENT:return"MESH_BONE_ASSIGNMENT";case this.chunk.MESH_LOD:return"MESH_MESH_LOD";case this.chunk.MESH_LOD_USAGE:return"MESH_LOD_USAGE";case this.chunk.MESH_LOD_MANUAL:return"MESH_LOD_MANUAL";case this.chunk.MESH_LOD_GENERATED:return"MESH_LOD_GENERATED";case this.chunk.MESH_BOUNDS:return"MESH_BOUNDS";case this.chunk.SUBMESH_NAME_TABLE:return"SUBMESH_NAME_TABLE";case this.chunk.SUBMESH_NAME_TABLE_ELEMENT:return"SUBMESH_NAME_TABLE_ELEMENT";case this.chunk.EDGE_LISTS:return"EDGE_LISTS";case this.chunk.EDGE_LIST_LOD:return"EDGE_LIST_LOD";case this.chunk.EDGE_GROUP:return"EDGE_GROUP"}return"Unknown_Chunk_ID_"+a}},reset:function(){this.ds=null,this.version="",this.ogreMesh=null,this.chunk={id:void 0,len:void 0,lenLeft:void 0,size:6},this.logging&&(this.time=new Date)},logError:function(a){return Tundra.client.logError("[OgreMeshSerializer]: "+a,!0),!1},logWarning:function(a){},logChunk:function(){console.log(OgreMeshSerializer.chunkIdToString(this.chunk.id)+" len = "+this.chunk.lenLeft+" bytesLeft = "+this.ds.bytesLeft())},importMesh:function(a,b){if(!(b instanceof OgreMesh))return this.logError("importMesh(): 'ogreMesh' parameter is no of type OgreMesh");try{return this.ds=new DataDeserializer(a),this.readHeader()?(this.ogreMesh=b,this.readMesh()?(this.logging&&console.log("  >> Mesh imported in "+(new Date-this.time)+" msec"),!0):!1):!1}catch(c){return void 0!==c.stack?console.error(c.stack):console.error(c),!1}},readChunk:function(){return this.ds.bytesLeft()<this.chunk.size?this.logError("readChunk(): Not enough data to read next chunks metadata"):(this.chunk.id=this.ds.readU16(),this.chunk.len=this.ds.readU32(),this.chunk.lenLeft=this.chunk.len-this.chunk.size,this.logging&&this.chunk.id!==OgreMeshSerializer.chunk.SUBMESH_BONE_ASSIGNMENT&&this.logChunk(),!0)},rewindChunk:function(){this.logging&&console.log("    -- Rewinding chunk"),this.ds.skipBytes(-this.chunk.size)},readHeader:function(){return this.ds.readU16()!==OgreMeshSerializer.chunk.HEADER?this.logError("readHeader(): First data chunk is not HEADER"):(this.version=this.ds.readStringUntil("\x00",10),
OgreMeshSerializer.isSupportedVersion(this.version)?!0:this.logError("Unsupported mesh version "+this.version))},readMesh:function(){if(!this.readChunk())return!1;if(this.chunk.id!==OgreMeshSerializer.chunk.MESH)return this.logError("readMesh(): MESH chunk cound not be found, instead found "+OgreMeshSerializer.chunkIdToString(this.chunk.id));var a=this.ds.readBoolean();for(this.logging&&console.log("    -- Skeletal animated:",a);this.ds.bytesLeft()>0;){if(!this.readChunk())return!1;switch(this.chunk.id){case OgreMeshSerializer.chunk.GEOMETRY:if(this.ogreMesh.sharedVertexData=new OgreVertexData,!this.readGeometry(this.ogreMesh.sharedVertexData))return!1;break;case OgreMeshSerializer.chunk.SUBMESH:if(!this.readSubmesh())return!1;break;case OgreMeshSerializer.chunk.MESH_BOUNDS:if(!this.readBoundsInfo())return!1;break;case OgreMeshSerializer.chunk.SUBMESH_NAME_TABLE:if(!this.readSubMeshNameTable())return!1;break;case OgreMeshSerializer.chunk.MESH_SKELETON_LINK:if(!this.readSkeletonLink())return!1;break;case OgreMeshSerializer.chunk.MESH_BONE_ASSIGNMENT:if(!this.readBoneAssignment(this.ogreMesh))return!1;break;default:this.ds.skipBytes(this.chunk.lenLeft)}}return!0},readGeometry:function(a){for(a.vertexCount=this.ds.readU32(),this.logging&&console.log("    -- Vertex count:",a.vertexCount);this.ds.bytesLeft()>0;){if(!this.readChunk())return!1;if(this.chunk.id===OgreMeshSerializer.chunk.GEOMETRY_VERTEX_DECLARATION){if(!this.readGeometryVertexDeclaration(a))return!1}else{if(this.chunk.id!==OgreMeshSerializer.chunk.GEOMETRY_VERTEX_BUFFER){this.rewindChunk();break}if(!this.readGeometryVertexBuffer(a))return!1}}return!0},readGeometryVertexDeclaration:function(a){for(;this.ds.bytesLeft()>0;){if(!this.readChunk())return!1;if(this.chunk.id!==OgreMeshSerializer.chunk.GEOMETRY_VERTEX_ELEMENT){this.rewindChunk();break}if(!this.readGeometryVertexElement(a))return!1}return!0},readGeometryVertexElement:function(a){var b=new OgreVertexElement(this.ds.readU16(),this.ds.readU16(),this.ds.readU16(),this.ds.readU16(),this.ds.readU16());return a.vertexDeclaration.addElement(b),this.logging&&console.log("    --",b),!0},readGeometryVertexBuffer:function(a){var b={bindIndex:this.ds.readU16(),vertexSize:this.ds.readU16()};return this.logging&&console.log("    --",b),this.readChunk()?this.chunk.id!==OgreMeshSerializer.chunk.GEOMETRY_VERTEX_BUFFER_DATA?this.logError("Failed to find vertex buffer data area GEOMETRY_VERTEX_BUFFER_DATA"):a.vertexDeclaration.getVertexSize(b.bindIndex)!==b.vertexSize?this.logError("Buffer vertex size does not agree with vertex declaration: Vertex declaration "+a.vertexDeclaration.getVertexSize(b.bindIndex)+" Vertex buffer metadata "+b.vertexSize):(a.vertexBufferBinding.setBinding(b.bindIndex,this.ds.readUint8Array(a.vertexCount*b.vertexSize)),!0):!1},readSubmesh:function(){var a=new OgreSubMesh;if(a.index=this.ogreMesh.numSubmeshes(),a.materialName=this.ds.readStringUntil("\x00",10),a.useSharedVertices=this.ds.readBoolean(),a.indexData.indexCount=this.ds.readU32(),a.indexData.is32bit=this.ds.readBoolean(),a.indexData.indexCount>0&&a.indexData.readIndexBuffer(this.ds),!a.useSharedVertices){if(!this.readChunk())return!1;if(this.chunk.id!==OgreMeshSerializer.chunk.GEOMETRY)return this.logError("Missing geometry chunk for OgreSubmesh");if(a.vertexData=new OgreVertexData,!this.readGeometry(a.vertexData))return!1}for(;this.ds.bytesLeft()>0;){if(!this.readChunk())return!1;if(this.chunk.id===OgreMeshSerializer.chunk.SUBMESH_OPERATION)a.operationType=this.ds.readU16();else if(this.chunk.id===OgreMeshSerializer.chunk.SUBMESH_BONE_ASSIGNMENT){if(!this.readBoneAssignment(a))return!1}else{if(this.chunk.id!==OgreMeshSerializer.chunk.SUBMESH_TEXTURE_ALIAS){this.rewindChunk();break}this.ds.skipBytes(this.chunk.lenLeft)}}return this.ogreMesh.addSubmesh(a),!0},readBoundsInfo:function(){return this.ogreMesh.AABB.min.x=this.ds.readFloat32(),this.ogreMesh.AABB.min.y=this.ds.readFloat32(),this.ogreMesh.AABB.min.z=this.ds.readFloat32(),this.ogreMesh.AABB.max.x=this.ds.readFloat32(),this.ogreMesh.AABB.max.y=this.ds.readFloat32(),this.ogreMesh.AABB.max.z=this.ds.readFloat32(),this.ogreMesh.radius=this.ds.readFloat32(),!0},readSubMeshNameTable:function(){for(;this.ds.bytesLeft()>0;){if(!this.readChunk())return!1;if(this.chunk.id!==OgreMeshSerializer.chunk.SUBMESH_NAME_TABLE_ELEMENT){this.rewindChunk();break}var a=this.ds.readU16(),b=this.ds.readStringUntil("\x00",10),c=this.ogreMesh.getSubmesh(a);null!=c?c.name=b:this.logWarning("Submesh name table had submesh index "+a+" that does not exist")}return!0},readSkeletonLink:function(){var a=this.ds.bytesLeft();return this.ogreMesh.skeletonName=this.ds.readStringUntil("\x00",10),this.logging&&console.log("    -- Skeleton name:",this.ogreMesh.skeletonName,"read",a-this.ds.bytesLeft()),!0},readBoneAssignment:function(a){return a.addBoneAssignment(new OgreVertexBoneAssignment(this.ds.readU32(),this.ds.readU16(),this.ds.readFloat32())),!0}}),OgreMeshAsset=IAsset.$extend({__init__:function(a){this.$super(a,"OgreMeshAsset"),this.requiresCloning=!0,this.mesh=Tundra.renderer.createSceneNode(),this.mesh.name=this.name},isLoaded:function(){return void 0!==this.mesh&&this.mesh.children.length>0},resetMaterials:function(){for(var a=0,b=this.numSubmeshes();b>a;a++){var c=this.getSubmesh(a);null!=c&&(c.material=Tundra.renderer.materialWhite,c.material.needsUpdate=!0)}},unload:function(){if(!this.requiresCloning||!this.isCloneSource){var a=this.numSubmeshes();this.logging&&null!=this.mesh&&a>0&&console.log("OgreMeshAsset unload",this.name);for(var b=0;a>b;++b){var c=this.getSubmesh(b);null!=c&&null!=c.material&&(c.material=Tundra.renderer.materialWhite)}return void(null!=this.mesh&&null!=this.mesh.parent&&this.mesh.parent.remove(this.mesh));var b,c}},isGeometryInUse:function(a){if(void 0===a.uuid)return!1;var b=!1;return Tundra.renderer.scene.traverse(function(c){b!==!0&&null!=c&&void 0!==c.geometry&&(c.geometry instanceof THREE.BufferGeometry||c.geometry instanceof THREE.Geometry)&&c.geometry.uuid===a.uuid&&(b=!0)}),b},getSceneNode:function(){return this.isLoaded()?this.mesh:null},getSubmesh:function(a){return this.isLoaded()?this.mesh.children[a]:null},numSubmeshes:function(){return this.isLoaded()?this.mesh.children.length:0},canAttachSkeleton:function(){if(0===this.numSubmeshes())return!1;for(var a=0,b=this.numSubmeshes();b>a;++a)if(!(this.getSubmesh(a)instanceof THREE.SkinnedMesh))return!1;return!0},_cloneImpl:function(a){for(var b=new OgreMeshAsset(a),c=0,d=this.numSubmeshes();d>c;++c){var e=this.getSubmesh(c);if(e instanceof THREE.Mesh||e instanceof THREE.SkinnedMesh){var f=null;f=e instanceof THREE.SkinnedMesh?new THREE.SkinnedMesh(e.geometry,Tundra.renderer.materialWhite,!1):new THREE.Mesh(e.geometry,Tundra.renderer.materialWhite),f.name=b.name+"_submesh_"+c,f.tundraSubmeshIndex=e.tundraSubmeshIndex,b.mesh.add(f)}}return b},cloneFrom:function(a){if(!(a instanceof OgreMeshAsset))return void consoloe.log("ERROR: OgreMeshAsset.clone can only clone from another OgreMeshAsset instance.");this.unload(),this.type=a.type,this.requiresCloning=a.requiresCloning,this.mesh=Tundra.renderer.createSceneNode(),this.mesh.name=a.name;for(var b=a.numSubmeshes(),c=0;b>c;++c){var d=a.getSubmesh(c);if(d instanceof THREE.Mesh||d instanceof THREE.SkinnedMesh){var e=null;e=d instanceof THREE.SkinnedMesh?new THREE.SkinnedMesh(this.cloneGeometry(d.geometry),Tundra.renderer.materialWhite,!1):new THREE.Mesh(this.cloneGeometry(d.geometry),Tundra.renderer.materialWhite),e.name=this.mesh.name+"_submesh_"+c,e.tundraSubmeshIndex=d.tundraSubmeshIndex,this.mesh.add(e)}}},cloneGeometry:function(a){if(!(a instanceof THREE.Geometry||a instanceof THREE.BufferGeometry))return Tundra.client.logError("[OgreMeshAsset]: cloneGeometry() called with incorrect 'src', must be THREE.Geometry|THREE.BufferGeometry."),null;var b=a.clone();if(a instanceof THREE.Geometry){var c=0;if(a.faceVertexUvs.length>1){b.faceVertexUvs[1]=[];var d=a.faceVertexUvs[1],e=[],f=[];for(c=0,il=d.length;c<il;c++){e=d[c],f=[];for(var g=0,h=e.length;h>g;g++)f.push(new THREE.Vector2(e[g].x,e[g].y));b.faceVertexUvs[1].push(f)}}if(a.skinWeights.length>0)for(c=0;c<a.skinWeights.length;c++)b.skinWeights.push(a.skinWeights[c].clone());if(a.skinIndices.length>0)for(c=0;c<a.skinIndices.length;c++)b.skinIndices.push(a.skinIndices[c].clone())}return b},deserializeFromData:function(a,b,c){var d=!1;return d="arraybuffer"===b?this.deserializeFromBinary(a):this.deserializeFromXML(a)},deserializeFromBinary:function(a){var b=new OgreMesh,c=new OgreMeshSerializer({logging:this.logging}),d=c.importMesh(a,b);return c.reset(),delete c,c=void 0,d===!0&&(d=OgreThreeJsUtils.convertOgreMesh(b,this.mesh,this.logging)),delete b,b=void 0,d},deserializeFromXML:function(a){this.logging&&console.log(this.name);var b=this,c=this.logging?Date.now():null,d=this.logging?Date.now():null,e={positions:!1,normals:!1,textureCoords:!1,textureCoordCount:0,textureCoordsTypes:[],vextexCount:0},f=$(a),g=f.find("sharedgeometry");if(null==g||g.length<=0){if(g=f.find("geometry"),null==g||g.length<=0)return Tundra.client.logError("[OgreMeshAsset]: Failed to find <sharedgeometry> or <geometry> from mesh data",!0),!1;g.length>1&&null!=console.warn&&console.warn("OgreMeshAsset: Support incomplete for non sharedgeometry multi-submesh meshes. Only first submesh will be parsed correctly!")}e.vertexCount=parseInt(g.attr("vertexcount")),(null==e.vertexCount||isNaN(e.vertexCount))&&(e.vertexCount=0),this.logging&&console.log("  >> XML reported vertex count: "+(e.vertexCount>0?e.vertexCount:"undefined"));var h=new Array(e.vertexCount),i=new Array(e.vertexCount),j=[[]],k=0,l=0,m=g.find("vertexbuffer");m.each(function(){var a={positions:!1,normals:!1,textureCoords:!1},b=$(this),c=b.attr("texture_coords");if(a.positions="true"===b.attr("positions")?!0:!1,a.normals="true"===b.attr("normals")?!0:!1,a.textureCoords=null!=c&&"undefined"!=typeof c&&c!==!1,a.positions&&!e.positions&&(e.positions=!0),a.normals&&!e.normals&&(e.normals=!0),a.textureCoords)if(e.textureCoords)e.textureCoordCount!=parseInt(c)&&null!=console.warn&&console.warn("Found different amount of texture coords in multiple vertex buffers!");else for(e.textureCoords=!0,e.textureCoordCount=parseInt(c),isNaN(e.textureCoordCount)&&(e.textureCoordCount=0),l=0;l<e.textureCoordCount;++l)e.textureCoordsTypes.push(b.attr("texture_coord_dimensions_"+l)),j[l]=[];k=0;var d=b.find("vertex");d.each(function(){var b=$(this);if(a.positions){var c=b.find("position");h[k]=new THREE.Vector3(parseFloat(c.attr("x")),parseFloat(c.attr("y")),parseFloat(c.attr("z")))}if(a.normals){var c=b.find("normal");i[k]=new THREE.Vector3(parseFloat(c.attr("x")),parseFloat(c.attr("y")),parseFloat(c.attr("z")))}if(a.textureCoords){var d=0,e=b.find("texcoord");e.each(function(){var a=$(this);j[d][k]=new THREE.Vector2(parseFloat(a.attr("u")),parseFloat(a.attr("v"))),d++})}k++}),a=null,b=null,c=null,d=null}),this.logging&&(console.log("    >> Vertex buffers read"),console.log("    >> Normals: "+i.length+" Vertices: "+h.length+" UVs: "+e.textureCoordCount),console.log("    >> "+(Date.now()-c)+" msec"),c=Date.now());var n=f.find("submeshes");return n.find("submesh").each(function(){var a=$(this),f=new THREE.Geometry;for(s=0;s<e.textureCoordCount;++s)f.faceVertexUvs[s]=[];var g=[],l=a.find("boneassignments");if(null!=l||l.length>0){var m=l.find("vertexboneassignment");m.each(function(){g.push({vertexIndex:parseInt($(this).attr("vertexindex")),boneIndex:parseInt($(this).attr("boneindex")),weight:parseFloat($(this).attr("weight"))})}),m=null}l=null;var n=a.find("faces");b.logging&&(console.log("  >> SUBMESH"),console.log("    >> Face count: "+parseInt(n.attr("count"))),console.log("    >> "+(Date.now()-c)+" msec"),c=Date.now());var o={};if(k=-1,n.each(function(){var a=$(this).find("face");a.each(function(){var a=$(this),g=new THREE.Face3(parseInt(a.attr("v1")),parseInt(a.attr("v2")),parseInt(a.attr("v3"))),l=f.faces.length;if(e.normals){var m=i[g.a],n=i[g.b],p=i[g.c];g.vertexNormals.push(m),g.vertexNormals.push(n),g.vertexNormals.push(p),g.normal.x=(m.x+n.x+p.x)/3,g.normal.y=(m.y+n.y+p.y)/3,g.normal.z=(m.z+n.z+p.z)/3}if(e.textureCoordCount>0)for(var q=0;q<e.textureCoordCount;++q)f.faceVertexUvs[q][l]=[j[q][g.a],j[q][g.b],j[q][g.c]];if(e.positions){var r=o[g.a];null==r?(f.vertices[++k]=h[g.a],o[g.a]=k,g.a=k):g.a=r,r=o[g.b],null==r?(f.vertices[++k]=h[g.b],o[g.b]=k,g.b=k):g.b=r,r=o[g.c],null==r?(f.vertices[++k]=h[g.c],o[g.c]=k,g.c=k):g.c=r}if(f.faces[l]=g,b.logging&&l>0&&l%1e4===0){var s=Date.now();console.log("    >> Vertexes processed: "+l+" in "+(s-c)+" msec     - total "+(s-d)+" msec"),c=Date.now()}}),a=null}),n=null,b.logging&&console.log("    >> Vertex count: "+f.vertices.length),g.length>0){for(b.logging&&console.log("    >> Total bone assignments: "+g.length),f.skinWeights=new Array(f.vertices.length),f.skinIndices=new Array(f.vertices.length),s=0;s<f.vertices.length;++s)f.skinWeights[s]=null,f.skinIndices[s]=null;var p=0;for(s=0;s<g.length;++s){var q=g[s],r=o[q.vertexIndex];null!=r?(p++,null==f.skinWeights[r]?(f.skinWeights[r]=new THREE.Vector4(q.weight,0,0,0),f.skinWeights[r].y=null):null==f.skinWeights[r].y&&(f.skinWeights[r].y=q.weight),null==f.skinIndices[r]?(f.skinIndices[r]=new THREE.Vector4(q.boneIndex,0,0,0),f.skinIndices[r].y=null):null==f.skinIndices[r].y&&(f.skinIndices[r].y=q.boneIndex)):(f.skinWeights[r]=null,f.skinIndices[r]=null)}b.logging&&console.log("    >> Bone assignments assigned: "+p);for(var s=0;s<f.vertices.length;++s)null==f.skinWeights[s]?f.skinWeights[s]=new THREE.Vector4(0,0,0,0):null==f.skinWeights[s].y&&(f.skinWeights[s].y=0),null==f.skinIndices[s]?f.skinIndices[s]=new THREE.Vector4(0,0,0,0):null==f.skinIndices[s].y&&(f.skinIndices[s].y=0)}f.uvsNeedUpdate=!0,f.verticesNeedUpdate=!0,f.elementsNeedUpdate=!0;var t=null;t=0==g.length?new THREE.Mesh(f,Tundra.renderer.materialWhite):new THREE.SkinnedMesh(f,Tundra.renderer.materialWhite,!1),t.name=b.mesh.name+"_submesh_"+b.numSubmeshes(),t.tundraSubmeshIndex=b.numSubmeshes(),b.mesh.add(t),f=null,t=null,a=null,g=null,o=null,n=null}),h=null,i=null,j=null,e=null,f=null,g=null,m=null,n=null,k=null,this.logging&&(console.log("OgreMeshAssset loaded with",this.numSubmeshes(),"submeshes"),console.log("")),!0}}),OgreMaterialAsset=IAsset.$extend({__init__:function(a){this.$super(a,"OgreMaterialAsset"),this.material=null,this.ogreMaterial=null,this.textureRequests=[]},__classvars__:{DebugMaterial:new THREE.MeshBasicMaterial({color:(new THREE.Color).setRGB(.2,.2,.2)}),sceneBlendFactorFromString:function(a){return"one"===a?THREE.OneFactor:"zero"===a?THREE.ZeroFactor:"dest_colour"===a?THREE.DstColorFactor:"src_colour"===a?THREE.SrcColorFactor:"one_minus_dest_colour"===a?THREE.OneMinusDstColorFactor:"one_minus_src_colour"===a?THREE.OneMinusSrcColorFactor:"dest_alpha"===a?THREE.DstAlphaFactor:"src_alpha"===a?THREE.SrcAlphaFactor:"one_minus_dest_alpha"===a?THREE.OneMinusDstAlphaFactor:"one_minus_src_alpha"===a?THREE.OneMinusSrcAlphaFactor:void 0},ignoreTextureUnit:function(a){OgreMaterial.ignoreTextureUnit(a)}},isLoaded:function(){return null!==this.material&&0===this.numPendingDependencies()},_unloadTexture:function(a){if(null!=a){for(var b=a.uuid,c=!1,d=Tundra.renderer.getAllMeshes(),e=0,f=d.length;f>e;e++){var g=d[e].material;if(null!=d[e].material&&(g instanceof THREE.ShaderMaterial?null!=g.uniforms&&(null!=g.uniforms.map1&&null!=g.uniforms.map1.value&&g.uniforms.map1.value.uuid===b?c=!0:null!=g.uniforms.map2&&null!=g.uniforms.map2.value&&g.uniforms.map2.value.uuid===b?c=!0:null!=g.uniforms.tCube&&null!=g.uniforms.tCube.value&&g.uniforms.tCube.value.uuid===b?c=!0:null!=g.uniforms.map&&null!=g.uniforms.map.value&&g.uniforms.map.value.uuid===b?c=!0:null!=g.uniforms.normalMap&&null!=g.uniforms.normalMap.value&&g.uniforms.normalMap.value.uuid===b&&(c=!0)):g instanceof THREE.Material&&(null!=g.map&&g.map.uuid===b?c=!0:null!=g.lightMap&&g.lightMap.uuid===b?c=!0:null!=g.specularMap&&g.specularMap.uuid===b?c=!0:null!=g.normalMap&&g.normalMap.uuid===b?c=!0:null!=g.envMap&&g.envMap.uuid===b&&(c=!0)),c))break}c||a.dispose()}},isMaterialInUse:function(a){if(void 0===a.uuid)return!1;var b=!1;return Tundra.renderer.scene.traverse(function(c){b!==!0&&null!=c&&null!=c.material&&c.material.uuid===a.uuid&&(b=!0)}),b},unload:function(){null!=this.material&&(this.isMaterialInUse(this.material)||(this.logging&&console.log("OgreMaterialAsset unload",this.name),this.material instanceof THREE.ShaderMaterial?null!=this.material.uniforms&&(null!=this.material.uniforms.map1&&null!=this.material.uniforms.map1.value&&(this.logging&&console.log("  uniform map1"),this._unloadTexture(this.material.uniforms.map1.value),this.material.uniforms.map1.value=null),null!=this.material.uniforms.map2&&null!=this.material.uniforms.map2.value&&(this.logging&&console.log("  uniform map2"),this._unloadTexture(this.material.uniforms.map2.value),this.material.uniforms.map2.value=null),null!=this.material.uniforms.tCube&&null!=this.material.uniforms.tCube.value&&(this.logging&&console.log("  uniform tCube"),this._unloadTexture(this.material.uniforms.tCube.value),this.material.uniforms.tCube.value=null),null!=this.material.uniforms.map&&null!=this.material.uniforms.map.value&&(this.logging&&console.log("  uniform map"),this._unloadTexture(this.material.uniforms.map.value),this.material.uniforms.map.value=null),null!=this.material.uniforms.normalMap&&null!=this.material.uniforms.normalMap.value&&(this.logging&&console.log("  uniform normalMap"),this._unloadTexture(this.material.uniforms.normalMap.value),this.material.uniforms.normalMap.value=null)):this.material instanceof THREE.Material&&(null!=this.material.map&&(this.logging&&console.log("  map"),this._unloadTexture(this.material.map),this.material.map=null),null!=this.material.lightMap&&(this.logging&&console.log("  lightMap"),this._unloadTexture(this.material.lightMap),this.material.lightMap=null),null!=this.material.specularMap&&(this.logging&&console.log("  specularMap"),this._unloadTexture(this.material.specularMap),this.material.specularMap=null),null!=this.material.normalMap&&(this.logging&&console.log("  normalMap"),this._unloadTexture(this.material.normalMap),this.material.normalMap=null),null!=this.material.envMap&&(this.logging&&console.log("  envMap"),this._unloadTexture(this.material.envMap),this.material.envMap=null)),this.material.dispose(),null!=this.material&&this.log.error("Material non null after release")))},_onMaterialDisposed:function(){if(null!=this.material){for(var a=0,b=Tundra.renderer.getAllMeshes(),c=0,d=b.length;d>c;c++)null!=b[c].material&&b[c].material.uuid===this.material.uuid&&(b[c].material=Tundra.renderer.materialWhite,b[c].material.needsUpdate=!0,a++);this.material._listeners=[],this.material=null}},textureRefs:function(){var a=[];return null==this.material?a:(null!=this.material.map&&a.push(this.material.map.name),null!=this.material.lightMap&&a.push(this.material.lightMap.name),null!=this.material.specularMap&&a.push(this.material.specularMap.name),null!=this.material.normalMap&&a.push(this.material.normalMap.name),null!=this.material.envMap&&a.push(this.material.envMap.name),a)},deserializeFromData:function(a,b,c){if(this.ogreMaterial=new OgreMaterial(this.name,a,this.logging),this.logging&&console.log("Converting to THREE.Material"),this.ogreMaterial.shaders.isMeshmoonShader()?this.material=RocketShaderLibrary.instantiateMeshmoonMaterial(this.ogreMaterial,this.logging):!this.ogreMaterial.shaders.fragment.isValid()&&this.ogreMaterial.numTextures()>=2&&!this.ogreMaterial.isTextureCoordReserver(1)?this.material=RocketShaderLibrary.createMaterial("diffuse_lightmap_uv0",this.logging):!this.ogreMaterial.shaders.fragment.isValid()&&this.ogreMaterial.numTextures()>=2&&this.ogreMaterial.isTextureCoordReserver(1)?this.material=RocketShaderLibrary.createMaterial("multi_diffuse_shadow",this.logging):this.ogreMaterial.shaders.fragment.nameContains("meshmoon/MultiDiffShadow")?this.material=RocketShaderLibrary.createMaterial("multi_diffuse_shadow",this.logging):this.ogreMaterial.lighting&&this.ogreMaterial.depthWrite!==!1?(this.logging&&console.log("  -- THREE.MeshPhongMaterial"),this.material=new THREE.MeshPhongMaterial):(this.logging&&console.log("  -- THREE.MeshBasicMaterial [lighting off]"),this.material=new THREE.MeshBasicMaterial),!this.ogreMaterial.shaders.isMeshmoonShader()){var d=this.ogreMaterial.attributes.fog_override;if(Array.isArray(d)&&d.length>0)if(1===d.length){var e="string"==typeof d[0]?d[0].toLowerCase():d[0];"true"===e?this.material.fog=!1:"false"===e?this.material.fog=!0:this.log.warn("Unsupported fog_override:",e,". Supported 'fog_override {true|false}', will turn off/on fog for this material.")}else this.log.warn("Unsupported fog_override:",d,". Supported 'fog_override {true|false}', will turn off/on fog for this material.");else this.material.fog=!0}this.material.name=this.name,this.material.hasTundraShadowShader=this.ogreMaterial.shaders.hasShadowShaders(),this.material.ambient=this.ogreMaterial.ambient.toThreeColor(),this.material.color=this.material.diffuse=this.ogreMaterial.diffuse.toThreeColor(),this.material.specular=this.ogreMaterial.specular.toThreeColor(),this.material.emissive=this.ogreMaterial.emissive.toThreeColor(),this.material.opacity=this.ogreMaterial.opacity,OgreMaterial.clampColor(OgreMaterial.Color.Emissive,this.material.emissive,.5,this.logging),"multi_diffuse_shadow"===this.material.meshmoonShaderName||"diffuse_lightmap_uv0"===this.material.meshmoonShaderName?OgreMaterial.clampColor(OgreMaterial.Color.Specular,this.material.specular,.1,this.logging):!this.ogreMaterial.shaders.fragment.isValid()&&this.material instanceof THREE.MeshPhongMaterial&&this.ogreMaterial.numTextures()<=1&&OgreMaterial.clampColor(OgreMaterial.Color.Specular,this.material.specular,.1,this.logging),this.ogreMaterial.depthWrite===!1&&(this.material.transparent=!0,this.material.depthWrite=!1,this.material.color.setRGB(1,1,1),this.material.diffuse.setRGB(1,1,1));var f=this.ogreMaterial.shaders.fragment.namedParameter("specularPower","float4");if(void 0!==f&&f.value.length>0){var g=parseFloat(f.value[0]);isNaN(g)||(this.material.shininess=g,this.logging&&console.log("  -- specularPower -> shininess",this.material.shininess))}var h=30;"number"==typeof this.material.shininess&&this.material.shininess>h&&(this.material.shininess=h);var i=this.ogreMaterial.attributes.scene_blend_op;"string"==typeof i&&""!==i&&"add"!==i&&("subtract"==i?(this.material.blending=THREE.CustomBlending,this.material.blendEquation=THREE.SubtractEquation):"reverse_subtract"==i?(this.material.blending=THREE.CustomBlending,this.material.blendEquation=THREE.ReverseSubtractEquation):this.log.warn("Unsupported scene_blend_op '"+i+"'"));var j=this.ogreMaterial.attributes.colour_op_ex;Array.isArray(j)&&j.length>=6&&(this.material.color.r=Math.min(parseFloat(j[3]),1),this.material.color.g=Math.min(parseFloat(j[4]),1),this.material.color.b=Math.min(parseFloat(j[5]),1),this.material.diffuse=this.material.color);var k=this.ogreMaterial.attributes.alpha_rejection;if(Array.isArray(k)&&k.length>=2){var l=k[0].toLowerCase();if("greater_equal"===l||"greater"===l){var m=parseInt(k[1]);null!=m&&m>0&&(m>255&&(m=255),this.material.alphaTest=m/255,this.logging&&console.log("  -- alpha_rejection -> alphaTest",this.material.alphaTest))}else"always_fail"===l?this.material.opacity=0:"always_pass"!==l&&this.log.warn("Unsupported alpha_rejection function '"+l+"' Supported: 'always_fail', greater_equal' and 'greater'")}var n=this.ogreMaterial.attributes.scene_blend;if("string"==typeof n&&""!==n)if(this.material.blending=THREE.CustomBlending,-1===n.indexOf(" "))"add"==n?this.material.blending=THREE.AdditiveBlending:"modulate"==n?this.material.blending=THREE.MultiplyBlending:"colour_blend"==n?(this.material.blendSrc=THREE.OneFactor,this.material.blendDst=THREE.OneMinusSrcColorFactor):"alpha_blend"==n?(this.material.blendSrc=THREE.SrcAlphaFactor,this.material.blendDst=THREE.OneMinusSrcAlphaFactor):(this.log.warn("Unsupported scene_blend '"+n+"'"),this.material.blending=THREE.NormalBlending);else{var o=n.split(" "),p=OgreMaterialAsset.sceneBlendFactorFromString(o[0]),q=OgreMaterialAsset.sceneBlendFactorFromString(o[1]);void 0!==p&&void 0!==q?(this.material.blendSrc=p,this.material.blendDst=q):(this.log.warn("Unsupported parts in scene_blend '"+n+"'"),this.material.blending=THREE.NormalBlending)}for(var r=0,s=this.ogreMaterial.numTextures();s>r;++r){var t=this.ogreMaterial.textureUnits[r];if(""!==t.texture){var u=this.logging?t.scale.clone():void 0;(1!==t.scale.x||1!==t.scale.y)&&(t.scale.x=1/t.scale.x,t.scale.y=1/t.scale.y,this.logging&&console.log("  -- scale",u.x,u.y,"-> repeat",t.scale.x,t.scale.y)),CoreStringUtils.startsWith(t.texture,"http",!0)||(t.textureRef=this.baseRef+t.texture);var c=Tundra.asset.requestDependencyAsset(this,t.textureRef,"Texture");null!=c&&(c.onCompleted(this,this._textureLoaded,t),c.onFailed(this,this._textureFailed),this.textureRequests.push(t))}else this.logging&&console.warn("  -- Ignoring texture_unit "+r+": Does not have a texture.")}this.material instanceof THREE.ShaderMaterial&&RocketShaderLibrary.updateUniforms(this.material,this.logging),this.numPendingDependencies()>0&&this.logging&&console.log("  -- Waiting for",this.numPendingDependencies(),"dependency textures"),this.logging&&console.log(""),this.material.addEventListener("dispose",this._onMaterialDisposed.bind(this))},numPendingDependencies:function(){return this.textureRequests.length},pendingDependencies:function(){for(var a=[],b=0;b<this.textureRequests.length;++b)a.push(this.textureRequests[b].textureRef);return a},_removeTextureDependency:function(a,b){for(var c=0;c<this.textureRequests.length;++c)this.textureRequests[c].textureRef===a&&this.textureRequests[c].index===b&&(this.textureRequests.splice(c,1),c--)},_textureLoaded:function(a,b){if(null!==this.material){if(void 0===a&&null===a)return this.log.error("Texture 'completed' but asset is not valid:",a),this._emitDependencyFailed(b.textureRef),void this.unload();var c=a.getOrCreateInstance(b);if(this.material instanceof THREE.ShaderMaterial)if(this.ogreMaterial.shaders.isMeshmoonShader()){var d=MeshmoonShaderLibrary[this.material.meshmoonShaderName].textureIndexes[b.index];void 0!==d?this.material.uniforms[d].value=c:this.log.warn("Found invalid textureunit for ",this.material.meshmoonShaderName,b)}else"diffuse_lightmap_uv0"===this.material.meshmoonShaderName?(this.logging&&(this.log.debug("Applying texture to diffuse_lightmap_uv0"),this.log.debug(b),this.log.debug(c),this.log.debug(" ")),b.type===TextureAsset.DIFFUSE?(this.material.uniforms.map.value=c,this.material.uniforms.offsetRepeat.value.set(c.offset.x,c.offset.y,c.repeat.x,c.repeat.y)):(b.type===TextureAsset.LIGHT||b.type===TextureAsset.SPECULAR)&&(this.material.uniforms.lightMap.value=c)):"multi_diffuse_shadow"===this.material.meshmoonShaderName&&(this.logging&&(this.log.debug("Applying texture to multi_diffuse_shadow"),this.log.debug(b),this.log.debug(c),this.log.debug(" ")),b.type===TextureAsset.DIFFUSE?(this.material.uniforms.map1.value=c,this.material.uniforms.offsetRepeat1.value.set(c.offset.x,c.offset.y,c.repeat.x,c.repeat.y)):(b.type===TextureAsset.DIFFUSE2||1===b.coordSet)&&(this.material.uniforms.map2.value=c,b.type===TextureAsset.LIGHT&&(this.material.uniforms.offsetRepeat2.value.set(c.offset.x,c.offset.y,c.repeat.x,c.repeat.y),this.material.uniforms.useOffsetRepeat2.value=1)));else b.type===TextureAsset.DIFFUSE?this.material.map=c:b.type===TextureAsset.SPECULAR?void 0!==this.material.specularMap?this.material.specularMap=c:this.logging&&this.log.warn("Cannot set specular map to this type of material",this.material):b.type===TextureAsset.LIGHT||b.type===TextureAsset.DIFFUSE2?void 0!==this.material.lightMap?this.material.lightMap=c:this.logging&&this.log.warn("Cannot set light map to this type of material",this.material):b.type===TextureAsset.NORMAL?void 0!==this.material.normalMap?this.material.normalMap=c:this.logging&&this.log.warn("Cannot set normal map to this type of material",this.material):b.type===TextureAsset.REFLECTION?void 0!==this.material.envMap?this.material.envMap=c:this.logging&&this.log.warn("Cannot set reflection map to this type of material",this.material):this.log.error("Unknown texture loaded with type "+TextureAsset.typeToString(b.type));this.material.needsUpdate=!0,this._removeTextureDependency(b.textureRef,b.index),0===this.numPendingDependencies()&&(this.logging&&console.log("All dependencies loaded for",this.name),this._emitLoaded())}},_textureFailed:function(a,b,c){this._emitDependencyFailed(a.ref),this.unload()}}),OgreBone=Class.$extend({__init__:function(a,b,c,d,e){this.name=a,this.id=b,this.position=c,this.quaternion=d,this.scale=e}}),OgreAnimationTrack=Class.$extend({__init__:function(a){this.bone=a,this.keyFrames=[]},addKeyFrame:function(a){a.bone=this.bone,this.keyFrames.push(a)}}),OgreTransformKeyFrame=Class.$extend({__init__:function(a,b,c,d){this.time=a,this.quaternion=b,this.translate=c,this.scale=d},positionFromParent:function(){var a={x:this.translate.x,y:this.translate.y,z:this.translate.z};return null!=this.bone&&(a.x+=this.bone.position.x,a.y+=this.bone.position.y,a.z+=this.bone.position.z),a},toArray:function(a,b){var c=[];if("translate"===a||"position"===a)if(b===!0){var d=this.positionFromParent();c=[d.x,d.y,d.z]}else c=[this.translate.x,this.translate.y,this.translate.z];else c="scale"===a?[this.scale.x,this.scale.y,this.scale.z]:null;return c}}),OgreSkeletonSerializer=Class.$extend({__init__:function(a){void 0===a&&(a={}),this.logging=void 0===a.logging?!1:a.logging,this.reset()},__classvars__:{supportedVersions:["[Serializer_v1.10]","[Serializer_v1.80]"],isSupportedVersion:function(a){for(var b=0;b<OgreSkeletonSerializer.supportedVersions.length;b++)if(OgreSkeletonSerializer.supportedVersions[b]===a)return!0;return!1},chunk:{HEADER:4096,HEADER_ENDIAN_FLIP:16,BLENDMODE:4112,BONE:8192,BONE_PARENT:12288,ANIMATION:16384,ANIMATION_BASEINFO:16400,ANIMATION_TRACK:16640,ANIMATION_TRACK_KEYFRAME:16656,ANIMATION_LINK:20480},chunkIdToString:function(a){switch(a){case this.chunk.HEADER:return"HEADER";case this.chunk.HEADER_ENDIAN_FLIP:return"HEADER_ENDIAN_FLIP";case this.chunk.BLENDMODE:return"BLENDMODE";case this.chunk.BONE:return"BONE";case this.chunk.BONE_PARENT:return"BONE_PARENT";case this.chunk.ANIMATION:return"ANIMATION";case this.chunk.ANIMATION_BASEINFO:return"ANIMATION_BASEINFO";case this.chunk.ANIMATION_TRACK:return"ANIMATION_TRACK";case this.chunk.ANIMATION_TRACK_KEYFRAME:return"ANIMATION_TRACK_KEYFRAME";case this.chunk.ANIMATION_LINK:return"ANIMATION_LINK"}return"Unknown_Chunk_ID_"+a},boneSizeWithoutScale:30,keyFrameSizeWithoutScale:32},reset:function(){this.ds=null,this.version="",this.ogreSkeleton=null,this.chunk={id:void 0,len:void 0,lenLeft:void 0,size:6},this.logging&&(this.time=new Date)},logError:function(a){return Tundra.client.logError("[OgreSkeletonSerializer]: "+a,!0),!1},logWarning:function(a){},logChunk:function(){console.log(OgreSkeletonSerializer.chunkIdToString(this.chunk.id)+" len = "+this.chunk.lenLeft+" bytesLeft = "+this.ds.bytesLeft())},importSkeleton:function(a,b){if(!(b instanceof OgreSkeleton))return this.logError("importMesh(): 'ogreSkeleton' parameter is no of type OgreSkeleton");try{return this.ds=new DataDeserializer(a),this.readHeader()?(this.ogreSkeleton=b,this.readSkeleton()?(this.logging&&console.log("  >> Skeleton imported in "+(new Date-this.time)+" msec"),!0):!1):!1}catch(c){return void 0!==c.stack?console.error(c.stack):console.error(c),!1}},readChunk:function(){return this.ds.bytesLeft()<this.chunk.size?this.logError("readChunk(): Not enough data to read next chunks metadata"):(this.chunk.id=this.ds.readU16(),this.chunk.len=this.ds.readU32(),this.chunk.lenLeft=this.chunk.len-this.chunk.size,this.logging&&this.chunk.id!==OgreSkeletonSerializer.chunk.ANIMATION_TRACK_KEYFRAME&&this.logChunk(),!0)},rewindChunk:function(){this.logging&&console.log("    -- Rewinding chunk"),
this.ds.skipBytes(-this.chunk.size)},readHeader:function(){return this.ds.readU16()!==OgreSkeletonSerializer.chunk.HEADER?this.logError("readHeader(): First data chunk is not HEADER"):(this.version=this.ds.readStringUntil("\x00",10),OgreSkeletonSerializer.isSupportedVersion(this.version)?!0:this.logError("Unsupported mesh version "+this.version))},readSkeleton:function(){for(;this.ds.bytesLeft()>0;){if(!this.readChunk())return!1;switch(this.chunk.id){case OgreSkeletonSerializer.chunk.BONE:if(!this.readBone())return!1;break;case OgreSkeletonSerializer.chunk.BONE_PARENT:if(!this.readBoneParent())return!1;break;case OgreSkeletonSerializer.chunk.ANIMATION:if(!this.readAnimation())return!1;break;default:this.ds.skipBytes(this.chunk.lenLeft)}}return!0},readBone:function(){var a=new OgreBone(this.ds.readStringUntil("\x00",10),this.ds.readU16(),this.ds.readFloat32Vector3(),this.ds.readFloat32Vector4(),{x:1,y:1,z:1});return this.chunk.lenLeft>OgreSkeletonSerializer.boneSizeWithoutScale&&(a.scale=this.ds.readFloat32Vector3()),this.ogreSkeleton.addBone(a),!0},readBoneParent:function(){return this.ogreSkeleton.parentBone(this.ds.readU16(),this.ds.readU16()),!0},readAnimation:function(){var a=new OgreAnimation(this.ds.readStringUntil("\x00",10),this.ds.readFloat32());if(!this.readChunk())return!1;for(this.chunk.id===OgreSkeletonSerializer.chunk.ANIMATION_BASEINFO?a.baseKeyFrame={name:this.ds.readString(),time:this.ds.readFloat32()}:this.rewindChunk();this.ds.bytesLeft()>0;){if(!this.readChunk())return!1;if(this.chunk.id!==OgreSkeletonSerializer.chunk.ANIMATION_TRACK){this.rewindChunk();break}if(!this.readAnimationTrack(a))return!1}return this.ogreSkeleton.addAnimation(a),!0},readAnimationTrack:function(a){for(var b=new OgreAnimationTrack(this.ogreSkeleton.getBone(this.ds.readU16()));this.ds.bytesLeft()>0;){if(!this.readChunk())return!1;if(this.chunk.id!==OgreSkeletonSerializer.chunk.ANIMATION_TRACK_KEYFRAME){this.rewindChunk();break}if(!this.readKeyFrame(b))return!1}return a.addTrack(b),!0},readKeyFrame:function(a){var b=new OgreTransformKeyFrame(this.ds.readFloat32(),this.ds.readFloat32Vector4(),this.ds.readFloat32Vector3(),{x:1,y:1,z:1});return this.chunk.lenLeft>OgreSkeletonSerializer.keyFrameSizeWithoutScale&&(b.scale=this.ds.readFloat32Vector3()),a.addKeyFrame(b),!0}}),OgreSkeletonAsset=IAsset.$extend({__init__:function(a){this.$super(a,"OgreSkeletonAsset"),this.requiresCloning=!0,this.skin=null,this.skeleton=null,this.bones=[],this.bonesFlat=[],this.animationHierarchy={},this.animationCache={},this.currentAnimation=null},isLoaded:function(){return Object.keys(this.animationHierarchy).length>0},unload:function(){if(!this.requiresCloning||!this.isCloneSource){null!=this.currentAnimation&&this.currentAnimation.stop();for(var a=0;a<this.bones.length;a++){var b=this.bones[a].parent;null!=b&&b.remove(this.bones[a])}this.skin=null,this.skeleton=null,this.bones=[],this.bonesFlat=[],this.animationHierarchy={},this.animationCache={}}},_cloneImpl:function(a){var b=new OgreSkeletonAsset(a);return b.cloneFrom(this),b},cloneFrom:function(a){return a instanceof OgreSkeletonAsset?(this.unload(),this.type=a.type,this.requiresCloning=a.requiresCloning,this.loaded=a.isLoaded(),this.bonesFlat=a.cloneBones(),this.bones=this.createHierarchy(this.bonesFlat),void(this.animationHierarchy=this.cloneAnimationHierarchy(a.animationHierarchy))):void this.log.error("OgreSkeletonAsset.cloneFrom can only clone from another OgreSkeletonAsset instance.")},getAvailableAnimations:function(){return Object.keys(this.animationHierarchy)},hasAnimation:function(a){return void 0!==this.animationHierarchy[a]},isAttached:function(){return null!=this.skin},getSkeletonParent:function(){return this.isAttached()?this.skin.mesh:null},getBoneParent:function(){return this.isAttached()?this.skin.getSubmesh(0):null},getAnimation:function(a){if(!this.isAttached())return this.log.error("Cannot get animation, skeleton",this.name,"not attached."),null;var b=this.name+"_"+a,c=this.animationCache[b];if(void 0===c){var d=this.animationHierarchy[a];if(void 0===d)return this.log.error("Could not find animation",a,"for playback in",this.name,". See getAvailableAnimations() for available animation names."),null;c=new THREE.Animation(this.getBoneParent(),d),c.name=a,this.animationCache[b]=c}return c},getBone:function(a){for(var b=null,c=0;c<this.bones.length&&(this.bones[c].name===a?b=this.bones[c]:null!=this.bones[c].children&&this.bones[c].children.length>0&&(b=this._getBone(a,this.bones[c].children)),null==b);c++);return b},_getBone:function(a,b){for(var c=null,d=0;d<b.length&&(b[d].name===a?c=b[d]:null!=b[d].children&&b[d].children.length>0&&(c=this._getBone(a,b[d].children)),null==c);d++);return c},cloneBones:function(){for(var a=[],b=0;b<this.bonesFlat.length;b++){var c=this.bonesFlat[b],d=new THREE.Bone;d.sourceBoneId=c.sourceBoneId,d.name=c.name,d.parentName=null!=c.parent?c.parent.name:"",d.position.copy(c.originalPosition),d.quaternion.copy(c.originalQuaternion),d.originalPosition=c.originalPosition.clone(),d.originalQuaternion=c.originalQuaternion.clone(),a.push(d)}return a},cloneAnimationHierarchy:function(a){for(var b={},c=Object.keys(a),d=0;d<c.length;d++){var e=a[c[d]],f={};f.originalName=e.originalName,f.name=this.name+"_"+e.originalName,f.length=e.length,f.fps=24,f.initialized=!1,f.hierarchy=e.hierarchy,f.bonesFlat=this.bonesFlat,f.bones=this.bones,b[f.originalName]=f}return b},createHierarchy:function(a){for(var b=[],c=function(a,b){for(var d=null,e=0;e<b.length&&(b[e].name===a?d=b[e]:null!=b[e].children&&b[e].children.length>0&&(d=c(a,b[e].children)),null==d);e++);return d},d=function(b){for(var d=null,e=0;e<a.length&&(a[e].name===b?d=a[e]:null!=a[e].children&&a[e].children.length>0&&(d=c(b,a[e].children)),null==d);e++);return d},e=0;e<a.length;e++){var f=a[e],g=d(f.parentName);null!=f&&null!=g?g.add(f):b.push(f)}return b},attach:function(a){if(this.isAttached())return this.skin.name!==a.name&&this.log.warn("Skeleton already attached to",this.skin.name),!1;if(!a.isLoaded())return this.log.error("Target mesh",a.name,"is not loaded"),!1;if(!a.canAttachSkeleton())return this.log.error("Target mesh",a.name,"does not have skeleton support"),!1;this.skin=a;for(var b=this.getSkeletonParent(),c=0;c<this.bones.length;c++){var d=this.bones[c];b.add(d),d.updateMatrix(),d.updateMatrixWorld(!0)}return this.skeleton=new THREE.Skeleton(this.bonesFlat,void 0,!1),this.link(this.skin)},link:function(a){if(!this.isAttached())return this.log.warn("link: Called before attach()",this.name),!1;if(null==this.skeleton)return this.log.warn("link: Skeleton not ready",this.name),!1;if(a.linkedSkeleton===this.name)return!0;for(var b=0,c=a.numSubmeshes();c>b;++b){var d=a.getSubmesh(b);d instanceof THREE.SkinnedMesh&&(null!=d.material?(d.needsUpdate=!0,-1===d.material.name.indexOf("tundra.MaterialLibrary")&&(d.material.skinning=!0,d.material.needsUpdate=!0),d.bind(this.skeleton)):this.log.warn("link: Submesh",b,b.name,"does not have material set"))}return this.skeleton.pose(),a.linkedSkeleton=this.name,!0},toThreeJsAnimationData:function(a){var b={};b.originalName=a.name,b.name=this.name+"_"+a.name,b.length=a.length,b.fps=24,b.initialized=!1,b.hierarchy=[],b.bonesFlat=this.cloneBones(),b.bones=this.createHierarchy(b.bonesFlat),this.logging&&console.log("  >> Tracks: "+a.tracks.length);for(var c=0;c<b.bonesFlat.length;c++){for(var d=!1,e=0;e<a.tracks.length;e++)if(b.bonesFlat[c].name===a.tracks[e].bone.name){var f=b.bonesFlat[c];f.keys=[],this.logging&&console.log("    >> "+f.name);var g=a.tracks[e];this.logging&&console.log("      >> Keyframes: "+g.keyframes.length);for(var h=0;h<g.keyframes.length;h++){var i=g.keyframes[h];f.keys.push({time:i.time,pos:i.pos,rot:i.rot,scl:i.scl})}b.hierarchy.push(f),d=!0}if(!d){this.logging&&console.log(">>",c,b.bonesFlat[c].name,"[SIMULATED]");var f=b.bonesFlat[c];f.keys=[],f.keys.push({time:0,pos:[0,0,0],rot:new THREE.Quaternion(0,0,0,1),scl:[1,1,1],interpolate:function(a,b){},apply:function(a){},hasTarget:function(a){return!0}},{time:b.length,pos:[0,0,0],rot:new THREE.Quaternion(0,0,0,1),scl:[1,1,1],interpolate:function(a,b){},apply:function(a){},hasTarget:function(a){return!0}}),b.hierarchy.push(f)}}return b},deserializeFromData:function(a,b,c){var d=!1;return d="arraybuffer"===b?this.deserializeFromBinary(a):this.deserializeFromXML(a)},deserializeFromBinary:function(a){var b=new OgreSkeleton(this.name),c=new OgreSkeletonSerializer,d=c.importSkeleton(a,b);return c.reset(),delete c,c=void 0,d===!0&&(this.animationHierarchy=OgreThreeJsUtils.loadOgreAnimations(b,this.logging),Object.keys(this.animationHierarchy).length>0?(this.bonesFlat=OgreThreeJsUtils.convertOgreBones(b),this.bones=this.createHierarchy(this.bonesFlat)):d=!1),delete b,b=void 0,d},deserializeFromXML:function(a){return this.log.error("Loading OgreSkeletonAsset from .mesh.xml is no longer supported. Use a binary skeleton instead."),!1},parseAnimation:function(a,b,c){var d=this,e={};e.name=b.attr("name"),e.length=parseFloat(b.attr("length")),e.tracks=[],e.parseTracks=function(a,b,c){var f={};f.bone=d.getBone(b.attr("bone")),f.keyframes=[],f.parseKeyframe=function(a,b,c){var d={};d.time=parseFloat(b.attr("time"));var e=b.find("translate");d.pos=[parseFloat(e.attr("x"))+this.bone.position.x,parseFloat(e.attr("y"))+this.bone.position.y,parseFloat(e.attr("z"))+this.bone.position.z];var f=b.find("rotate"),g=f.find("axis");d.rot=new THREE.Quaternion,d.rot.setFromAxisAngle(new THREE.Vector3(parseFloat(g.attr("x")),parseFloat(g.attr("y")),parseFloat(g.attr("z"))),parseFloat(f.attr("angle"))),d.rot.multiplyQuaternions(this.bone.quaternion,d.rot),d.scl=[1,1,1],this.keyframes.push(d)};var g=(b.find("keyframes"),b.find("keyframe"));g.each(function(a,b){f.parseKeyframe(a,$(this),b)}),e.tracks.push(f)};var f=(b.find("tracks"),b.find("track"));f.each(function(a,b){e.parseTracks(a,$(this),b)}),this.ogreAnimations.push(e)},parseBone:function(a,b,c){var d=new THREE.Bone(null);d.id=parseInt(b.attr("id")),d.name=b.attr("name");var e=b.find("position");d.position.x=parseFloat(e.attr("x")),d.position.y=parseFloat(e.attr("y")),d.position.z=parseFloat(e.attr("z"));var f=b.find("rotation"),g=f.find("axis");d.quaternion.setFromAxisAngle(new THREE.Vector3(parseFloat(g.attr("x")),parseFloat(g.attr("y")),parseFloat(g.attr("z"))),parseFloat(f.attr("angle"))),d.originalPosition=d.position.clone(),d.originalQuaternion=d.quaternion.clone(),this.bones.push(d),this.bonesFlat.push(d)},parseBoneHierarchy:function(a,b,c){var d=b.attr("bone"),e=b.attr("parent"),f=this.getBone(d),g=this.getBone(e);if(null==f||null==g)return void(null!=console.warn&&console.warn("Bone",d,"or its parent",e,"cannot be found!"));null!=f.parent&&null!=console.warn&&console.warn("Bone",f.name,"already has parent!"),g.add(f);for(var h=0;h<this.bones.length;h++)if(this.bones[h].name===d){this.bones.splice(h,1);break}}}),OgreScriptUtils={readBlock:function(a,b,c,d){void 0===c&&(c=0);var e=a.indexOf(b,c);if(-1===e)return null;var f={id:b,name:"",data:"",indexEnd:-1},g=e+b.length,h=a.indexOf("{",g),i=a.indexOf("}",g);return-1===h||-1===i?(console.error("Failed to read block { } data content starting from index",e),null):(f.name=this.readLine(a.substring(g)).trim(),f.data=a.substring(h+1,i-1),f.indexEnd=i+1,d===!0&&console.log("  >>",f.id,""!==f.name?"'"+f.name+"'":""),f)},readLine:function(a,b){var c=-1,d=a.indexOf("\n"),e=a.indexOf("\r\n"),f=a.indexOf("	"),g=void 0!==b?a.indexOf(b):-1;return(-1===c||-1!==d&&c>d)&&(c=d),(-1===c||-1!==e&&c>e)&&(c=e),(-1===c||-1!==f&&c>f)&&(c=f),(-1===c||-1!==g&&c>g)&&(c=g),-1!==c?a.substring(0,c):""},readString:function(a,b,c){b+=" ";var d=a.indexOf(b),e=-1!==d?CoreStringUtils.readLine(a.substring(d+b.length),null,!0,!0):"";return c===!0&&""!==e&&console.log("  --",b+"'"+e+"'"),e},readVector3:function(a,b,c,d){var e=this.readString(a,b,d);return e.length>0?THREE.Vector3.fromString(e):c},readColor:function(a,b,c,d){var e=this.readString(a,b,d);return e.length>0?Color.fromString(e):c},readFloat:function(a,b,c,d){var e=Number.parseFloat(this.readString(a,b,d));return MathUtils.isNumber(e)?e:c},readInt:function(a,b,c,d){var e=Number.parseInt(this.readString(a,b,d));return MathUtils.isNumber(e)?e:c}},OgreParticle={};OgreParticle.System=Class.$extend({__init__:function(a){this.origin=a||"",this.particleSystem=null,this.material=null,this.geometry=null,this.emitters=[],this.affectors=[],this.time=0,this.particlePool=[],this.activeParticles=[],this.freeParticles=[],this.numCreated=0,this.emitting=!0,this.quota=OgreParticle.System.defaultValue("quota"),this.particleWidth=OgreParticle.System.defaultValue("particle_width"),this.particleHeight=OgreParticle.System.defaultValue("particle_height"),this.cullEach=OgreParticle.System.defaultValue("cull_each"),this.sorted=OgreParticle.System.defaultValue("sorted"),this.iterationInterval=OgreParticle.System.defaultValue("iteration_interval"),this.nonvisibleUpdateTimeout=OgreParticle.System.defaultValue("nonvisible_update_timeout"),this.renderer=OgreParticle.System.defaultValue("renderer"),this.billboardType=OgreParticle.System.defaultValue("billboard_type"),this.billboardOrigin=OgreParticle.System.defaultValue("billboard_origin"),this.billboardRotationType=OgreParticle.System.defaultValue("billboard_rotation_type"),this.commonDirection=OgreParticle.System.defaultValue("common_direction"),this.commonUpVector=OgreParticle.System.defaultValue("common_up_vector"),this.localSpace=OgreParticle.System.defaultValue("local_space"),this.pointRendering=OgreParticle.System.defaultValue("point_rendering"),this.accurateFacing=OgreParticle.System.defaultValue("accurate_facing")},dispose:function(){this.particleSystem&&(Tundra.renderer.scene.remove(this.particleSystem),this.particleSystem.geometry&&this.particleSystem.geometry.dispose(),this.particleSystem.geometry=null),this.particleSystem=null},deserialize:function(a){this.quota=OgreScriptUtils.readInt(a,"quota",OgreParticle.System.defaultValue("quota")),this.particleWidth=OgreScriptUtils.readFloat(a,"particle_width",OgreParticle.System.defaultValue("particle_width")),this.particleHeight=OgreScriptUtils.readFloat(a,"particle_height",OgreParticle.System.defaultValue("particle_height")),this.cullEach=OgreScriptUtils.readFloat(a,"cull_each",OgreParticle.System.defaultValue("cull_each")),this.billboardType=OgreScriptUtils.readFloat(a,"billboard_type",OgreParticle.System.defaultValue("billboard_type")),this.billboardOrigin=OgreScriptUtils.readFloat(a,"billboard_origin",OgreParticle.System.defaultValue("billboard_origin")),this.billboardRotationType=OgreScriptUtils.readFloat(a,"billboard_rotation_type",OgreParticle.System.defaultValue("billboard_rotation_type")),this.commonDirection=OgreScriptUtils.readFloat(a,"common_direction",OgreParticle.System.defaultValue("common_direction")),this.commonUpVector=OgreScriptUtils.readFloat(a,"common_up_vector",OgreParticle.System.defaultValue("common_up_vector")),this.renderer=OgreScriptUtils.readFloat(a,"renderer",OgreParticle.System.defaultValue("renderer")),this.sorted=OgreScriptUtils.readFloat(a,"sorted",OgreParticle.System.defaultValue("sorted")),this.localSpace=OgreScriptUtils.readFloat(a,"local_space",OgreParticle.System.defaultValue("local_space")),this.pointRendering=OgreScriptUtils.readFloat(a,"point_rendering",OgreParticle.System.defaultValue("point_rendering")),this.accurateFacing=OgreScriptUtils.readFloat(a,"accurate_facing",OgreParticle.System.defaultValue("accurate_facing")),this.iterationInterval=OgreScriptUtils.readFloat(a,"iteration_interval",OgreParticle.System.defaultValue("iteration_interval")),this.nonvisibleUpdateTimeout=OgreScriptUtils.readFloat(a,"nonvisible_update_timeout",OgreParticle.System.defaultValue("nonvisible_update_timeout"))},initialize:function(a){if(void 0===a)return!1;if(void 0===a.map||null===a.map||"object"!=typeof a.map)return!1;this.geometry=new THREE.Geometry;for(var b=0;b<this.quota;++b){var c=new THREE.Vector3;c.idx=b;for(var d=0;d<this.emitters.length;++d)this.emitters[d].initParticle(c);this.geometry.vertices.push(c)}this.particlePool=this.geometry.vertices,this.freeParticles=this.particlePool.slice(0);var e=["attribute float size;","attribute vec4 clr;","attribute float rot;","varying vec4 vColor;","varying float vRot;","","void main()","{","   vColor = clr;","   vRot = rot;","   vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);","   gl_PointSize = size * (300.0 / length(mvPosition.xyz));","   gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),f=["uniform sampler2D uTexture;","varying vec4 vColor;","varying float vRot;","","void main()","{","   float rot = radians(vRot);","   vec2 rotCoords = gl_PointCoord;","   rotCoords -= vec2(0.5, 0.5);","   rotCoords *= mat2(cos(rot), -sin(rot), sin(rot), cos(rot));","   rotCoords += vec2(0.5, 0.5);","   gl_FragColor = vColor * texture2D(uTexture, rotCoords);","}"].join("\n");this.shaderAttributes={size:{type:"f",value:[]},clr:{type:"v4",value:[]},rot:{type:"f",value:[]}};var g={uTexture:{type:"t",value:a.map}};a.uniforms=g,a.attributes=this.shaderAttributes,a.vertexShader=e,a.fragmentShader=f,this.material=new THREE.ShaderMaterial(a);for(var h=this.geometry.vertices,i=this.shaderAttributes.size.value,j=this.shaderAttributes.clr.value,k=this.shaderAttributes.rot.value,l=0;l<h.length;l++)k[l]=h[l].rotation,i[l]=0,j[l]=h[l].color.toVector4();this.particleSystem=new THREE.PointCloud(this.geometry,this.material),this.particleSystem.sortParticles=!0;for(var m=0;m<this.affectors.length;++m)this.affectors[m].system=this,this.affectors[m].particleSystem=this.particleSystem;return!0},particleSize:function(){return Math.max(this.particleWidth,this.particleHeight)},__classvars__:{BillboardType:{point:0,oriented_common:1,oriented_self:2,perpendicular_common:3,perpendicular_self:4},BillboardOrigin:{top_left:0,top_center:1,top_right:2,center_left:3,center:4,center_right:5,bottom_left:6,bottom_center:7,bottom_right:8},BillboardRotationType:{texcoord:0,vertex:1},defaultValue:function(a){switch(a){case"quota":return 10;case"material":return"";case"particle_width":return 100;case"particle_height":return 100;case"cull_each":return!1;case"sorted":return!1;case"local_space":return!1;case"point_rendering":return!1;case"iteration_interval":return 0;case"nonvisible_update_timeout":return 0;case"renderer":return"billboard";case"billboard_type":return 0;case"billboard_origin":return 4;case"billboard_rotation_type":return 0;case"common_direction":return new THREE.Vector3(0,0,1);case"common_up_vector":return new THREE.Vector3(0,1,0);case"accurate_facing":return!1;default:return void console.error("OgreParticle.System: unknown key '"+a+"'.")}}},localToWorldDir:function(a){return a=a.clone(),transformDirection(a,this.particleSystem.matrixWorld),a},worldToLocalDir:function(a){return a=a.clone(),transformDirection(a,(new THREE.Matrix4).getInverse(this.particleSystem.matrixWorld)),a},update:function(a){if(this.particleSystem){this.time+=a;for(var b,c,d=0,e=this.activeParticles.length;e--;)if(c=this.activeParticles[e],c.age<c.ttl){c.age+=a;for(var f=0;f<this.affectors.length;++f)this.affectors[f].affectParticles(c,a);c.add(c.direction.clone().normalize().multiplyScalar(a)),this.shaderAttributes.clr.value[c.idx]=c.color.toVector4(),this.shaderAttributes.rot.value[c.idx]=c.rotation,this.shaderAttributes.size.value[c.idx]=c.size,++d}else this.shaderAttributes.size.value[c.idx]=0,this.shaderAttributes.clr.value[c.idx].set(0,0,0,0),this.activeParticles.splice(e,1),this.freeParticles.push(c);if(this.emitting){var g=0;for(b=0;b<this.emitters.length;++b)g+=this.emitters[b].emissionCount(a);for(var h=this.particleSize();g&&(c=this.freeParticles.shift());){for(b=0;b<this.emitters.length;++b)this.emitters[b].initParticle(c);for(b=0;b<this.affectors.length;++b)this.affectors[b].initParticle(c);this.activeParticles.push(c),c.size=h,this.shaderAttributes.size.value[c.idx]=h,--g}}this.particleSystem.geometry.__dirtyVertices=d>0}}}),OgreParticle.Emitter=Class.$extend({__init__:function(a){this.type=a,OgreParticle.Emitter.isSupportedType(a)||console.warn("OgreParticle.Emitter: Unsupported emitter type "+OgreParticle.Emitter.typeToString(a)+" ("+a+")."),this.leftover=0,this.enabled=!0,this.repeatDelayRemain=0,this._up=OgreParticle.Emitter.defaultValue("up"),this._angle=OgreParticle.Emitter.defaultValue("angle"),this._colorRangeStart=OgreParticle.Emitter.defaultValue("colour_range_start"),this._colorRangeEnd=OgreParticle.Emitter.defaultValue("colour_range_end"),this._direction=OgreParticle.Emitter.defaultValue("direction"),this._emissionRate=OgreParticle.Emitter.defaultValue("emission_rate"),this._position=OgreParticle.Emitter.defaultValue("position"),this._velocityMin=OgreParticle.Emitter.defaultValue("velocity_min"),this._velocityMax=OgreParticle.Emitter.defaultValue("velocity_max"),this._timeToLiveMin=OgreParticle.Emitter.defaultValue("time_to_live_min"),this._timeToLiveMax=OgreParticle.Emitter.defaultValue("time_to_live_max"),this._durationMin=OgreParticle.Emitter.defaultValue("duration_min"),this._durationMax=OgreParticle.Emitter.defaultValue("duration_max"),this._repeatDelayMin=OgreParticle.Emitter.defaultValue("repeat_delay_min"),this._repeatDelayMax=OgreParticle.Emitter.defaultValue("repeat_delay_max")},emissionRate:function(a){return void 0===a?this._emissionRate:void(this._emissionRate=a)},up:function(a){return void 0===a?this._up.clone():void this._up.copy(a)},angle:function(a){return void 0===a?this._angle:void(this._angle=a)},direction:function(a){return void 0===a?this._direction.clone():(this._direction.copy(a),this._direction.normalize(),this._up=this._direction.clone().cross(new THREE.Vector3(1,0,0)),this._up.lengthSq()<1e-12&&(this._up=this._direction.clone().cross(new THREE.Vector3(0,1,0))),void this._up.normalize())},colorRange:function(a,b){return void 0===a&&void 0===b?{min:this.colorRangeStart(),max:this.colorRangeEnd()}:(this._colorRangeStart.copy(a),void this._colorRangeEnd.copy(b))},colorRangeStart:function(a){return void 0===a?this._colorRangeStart.clone():void this._colorRangeStart.copy(a)},colorRangeEnd:function(a){return void 0===a?this._colorRangeEnd.clone():void this._colorRangeEnd.copy(a)},position:function(a){return void 0===a?this._position.clone():void this._position.copy(a)},velocity:function(a,b){return void 0===a&&void 0===b?{min:this.velocityMin(),max:this.velocityMax()}:(this._velocityMin=a,void(this._velocityMax=b))},velocityMin:function(a){return void 0===a?this._velocityMin:void(this._velocityMin=a)},velocityMax:function(a){return void 0===a?this._velocityMax:void(velocity_max=a)},timeToLive:function(a,b){return void 0===a&&void 0===b?{min:this.timeToLiveMin(),max:this.timeToLiveMax()}:(this._timeToLiveMin=a,void(this._timeToLiveMax=b))},timeToLiveMin:function(a){return void 0===a?this._timeToLiveMin:void(this._timeToLiveMin=a)},timeToLiveMax:function(a){return void 0===a?this._timeToLiveMax:void(this._timeToLiveMax=a)},duration:function(a,b){return void 0===a&&void 0===b?{min:this.durationMin(),max:this.durationMax()}:(this._durationMin=a,this._durationMax=b,void this.initDurationRepeat())},durationMin:function(a){return void 0===a?this._durationMin:void(this._durationMin=a)},durationMax:function(a){return void 0===a?this._durationMax:void(this._durationMax=a)},repeatDelay:function(a,b){return void 0===a&&void 0===b?{min:this.repeatDelayMin(),max:this.repeatDelayMax()}:(this._repeatDelayMin=a,this._repeatDelayMax=b,void this.initDurationRepeat())},repeatDelayMin:function(a){return void 0===a?this._repeatDelayMin:(this._repeatDelayMin=a,void this.initDurationRepeat())},repeatDelayMax:function(a){return void 0===a?this._repeatDelayMax:(this._repeatDelayMax=a,void this.initDurationRepeat())},initParticle:function(a){a.direction=this.randDirection(),a.velocity=this.randVelocity(),a.direction.multiplyScalar(a.velocity),a.ttl=this.randTimeToLive(),a.color=this.randColor(),a.rotation=0,a.rotationSpeed=0,a.age=0},deserialize:function(a){this.up(OgreScriptUtils.readVector3(a,"up",OgreParticle.Emitter.defaultValue("up"))),this.angle(OgreScriptUtils.readFloat(a,"angle",OgreParticle.Emitter.defaultValue("angle")));var b,c,d;b=OgreScriptUtils.readColor(a,"colour",void 0),c=OgreScriptUtils.readColor(a,"colour_range_start",void 0),d=OgreScriptUtils.readColor(a,"colour_range_end",void 0),void 0!==b&&this.colorRange(b,b),void 0!==c&&void 0!==d&&this.colorRange(c,d),this.direction(OgreScriptUtils.readVector3(a,"direction",OgreParticle.Emitter.defaultValue("direction"))),this.emissionRate(OgreScriptUtils.readInt(a,"emission_rate",OgreParticle.Emitter.defaultValue("emission_rate"))),this.position(OgreScriptUtils.readVector3(a,"position",OgreParticle.Emitter.defaultValue("position"))),b=OgreScriptUtils.readFloat(a,"velocity",void 0),c=OgreScriptUtils.readFloat(a,"velocity_min",void 0),d=OgreScriptUtils.readFloat(a,"velocity_max",void 0),void 0!==b&&this.velocity(b,b),void 0!==c&&void 0!==d&&this.velocity(c,d),b=OgreScriptUtils.readFloat(a,"time_to_live",void 0),c=OgreScriptUtils.readFloat(a,"time_to_live_min",void 0),d=OgreScriptUtils.readFloat(a,"time_to_live_max",void 0),void 0!==b&&this.timeToLive(b,b),void 0!==c&&void 0!==d&&this.timeToLive(c,d),b=OgreScriptUtils.readFloat(a,"duration",void 0),c=OgreScriptUtils.readFloat(a,"duration_min",void 0),d=OgreScriptUtils.readFloat(a,"duration_max",void 0),void 0!==b&&this.duration(b,b),void 0!==c&&void 0!==d&&this.duration(c,d),b=OgreScriptUtils.readFloat(a,"repeat_delay",void 0),c=OgreScriptUtils.readFloat(a,"repeat_delay_min",void 0),d=OgreScriptUtils.readFloat(a,"repeat_delay_max",void 0),void 0!==b&&this.repeatDelay(b,b),void 0!==c&&void 0!==d&&this.repeatDelay(c,d)},setEnabled:function(a){this.enabled=a,this.initDurationRepeat()},initDurationRepeat:function(){this.enabled?this._durationMin==this._durationMax?this.durationRemain=this._durationMin:this.durationRemain=this.randDuration():this._repeatDelayMin==this._repeatDelayMax?this.repeatDelayRemain=this._repeatDelayMin:this.repeatDelayRemain=this.randRepeatDelay()},emissionCount:function(a){if(this.enabled){var b=a*this._emissionRate+this.leftover,c=Math.floor(b);return this.leftover=b-c,this._durationMax&&(this.durationRemain-=a,this.durationRemain<=0&&this.setEnabled(!1)),c}return this._repeatDelayMax&&(this.repeatDelayRemain-=a,this.repeatDelayRemain<=0&&this.setEnabled(!0)),0},__classvars__:{Type:{Point:0,Box:1,Cylinder:2,Ellipsoid:3,HollowEllipsoid:4,Ring:5,NumTypes:6},typeToString:function(a){return CoreStringUtils.enumToString(this.Type,a,"Unknown")},stringToType:function(a){return CoreStringUtils.stringToEnum(this.Type,a,-1,!0)},isSupportedType:function(a){return a==this.Type.Point||a==this.Type.Box},defaultValue:function(a){switch(a){case"angle":return 0;case"colour":case"color":case"colour_range_start":case"color_range_start":case"colour_range_end":case"color_range_end":return Color.white();case"direction":return new THREE.Vector3(1,0,0);case"emission_rate":return 10;case"position":return new THREE.Vector3(0,0,0);case"velocity":case"velocity_min":case"velocity_max":return 1;case"time_to_live":case"time_to_live_min":case"time_to_live_max":return 5;case"duration":case"duration_min":case"duration_max":return 0;case"repeat_delay":case"repeat_delay_min":case"repeat_delay_max":return 0;case"up":return new THREE.Vector3(0,1,0);default:return void console.error("OgreParticle.Emitter: unknown key '"+a+"'.")}}},randVelocity:function(){return randomizeValue(this._velocityMin,this._velocityMax,this._velocityMin)},randTimeToLive:function(){return randomizeValue(this._timeToLiveMin,this._timeToLiveMax,this._timeToLiveMin)},randDuration:function(){return randomizeValue(this._durationMin,this._durationMax,this._durationMin)},randRepeatDelay:function(){return randomizeValue(this._repeatDelayMin,this._repeatDelayMax,this._repeatDelayMin)},randDirection:function(){var a=this.direction();return 0===this._angle?a:randomDeviant(a,MathUtils.degToRad(this._angle),new THREE.Vector3(0,1,0))},randColor:function(){if(this._colorRangeStart.equals(this._colorRangeEnd))return this._colorRangeStart.clone();var a=this._colorRangeStart,b=this._colorRangeEnd;return new Color(a.r+Math.random()*(b.r-a.r),a.g+Math.random()*(b.g-a.g),a.b+Math.random()*(b.b-a.b),a.a+Math.random()*(b.a-a.a))}}),OgreParticle.PointEmitter=OgreParticle.Emitter.$extend({__init__:function(){this.$super(OgreParticle.Emitter.Type.Point)},initParticle:function(a){this.$super(a),a.copy(this._position.clone()),a.rotation=0,a.rotationSpeed=0,a.age=0}}),OgreParticle.AreaEmitter=OgreParticle.Emitter.$extend({__init__:function(a){this.$super(a),this._xRange=new THREE.Vector3,this._yRange=new THREE.Vector3,this._zRange=new THREE.Vector3,this._size=new THREE.Vector3(OgreParticle.BoxEmitter.defaultValue("width"),OgreParticle.BoxEmitter.defaultValue("height"),OgreParticle.BoxEmitter.defaultValue("depth"))},xRange:function(a){return void 0===a?this._xRange.clone():void this._xRange.copy(a)},yRange:function(a){return void 0===a?this._yRange.clone():void this._yRange.copy(a)},zRange:function(a){return void 0===a?this._zRange.clone():void this._zRange.copy(a)},size:function(a){return void 0===a?this._size.clone():(this._size.copy(a),void this.generateRange())},width:function(a){return void 0===a?this._size.x:(this._size.x=a,void this.generateRange())},height:function(a){return void 0===a?this._size.y:(this._size.y=a,void this.generateRange())},depth:function(a){return void 0===a?this._size.z:(this._size.z=a,void this.generateRange())},direction:function(a){var b=this.$super(a);return void 0===b&&this.generateRange(),b},generateRange:function(){var a=this.up().cross(this._direction);this.xRange(a.multiplyScalar(.5*this._size.x)),this.yRange(this.up().multiplyScalar(.5*this._size.y)),this.zRange(this._direction.clone().multiplyScalar(.5*this._size.z))},__classvars__:{defaultValue:function(a){switch(a){case"width":case"height":case"depth":return 100;default:return void console.error("OgreParticle.AreaEmitter: unknown key '"+a+"'.")}}},deserialize:function(a){this.$super(a),this.size(new THREE.Vector3(OgreScriptUtils.readFloat(a,"width",OgreParticle.BoxEmitter.defaultValue("width")),OgreScriptUtils.readFloat(a,"height",OgreParticle.BoxEmitter.defaultValue("height")),OgreScriptUtils.readFloat(a,"depth",OgreParticle.BoxEmitter.defaultValue("depth"))))}}),OgreParticle.BoxEmitter=OgreParticle.AreaEmitter.$extend({__init__:function(){this.$super(OgreParticle.Emitter.Type.Box)},deserialize:function(a){this.$super(a)},initParticle:function(a){this.$super(a);var b=new THREE.Vector3(0,0,0);b.add(this.xRange().multiplyScalar(MathUtils.symmetricRandom())),b.add(this.yRange().multiplyScalar(MathUtils.symmetricRandom())),b.add(this.zRange().multiplyScalar(MathUtils.symmetricRandom()));var c=this.position();c.add(b),a.copy(c)}}),OgreParticle.Affector=Class.$extend({__init__:function(a){this.type=a,OgreParticle.Affector.isSupportedType(a)||console.warn("OgreParticle.Affector: Unsupported affector type "+OgreParticle.Affector.typeToString(a)+" ("+a+").")},initParticle:function(){},affectParticles:function(){},deserialize:function(){},__classvars__:{Type:{LinearForce:0,ColourFader:1,ColourFader2:2,Scaler:3,Rotator:4,ColourInterpolator:5,ColourImage:6,DeflectorPlane:7,DirectionRandomiser:8,NumTypes:9},typeToString:function(a){return CoreStringUtils.enumToString(this.Type,a,"Unknown")},stringToType:function(a){return CoreStringUtils.stringToEnum(this.Type,a,-1,!0)},isSupportedType:function(a){return a>=this.Type.LinearForce&&a<this.Type.NumTypes&&a!==this.Type.ColourImage&&a!==this.Type.DirectionRandomiser}}}),OgreParticle.LinearForce=OgreParticle.Affector.$extend({__init__:function(){this.$super(OgreParticle.Affector.Type.LinearForce),this.forceVector=OgreParticle.LinearForce.defaultValue("force_vector"),this.forceApplication=OgreParticle.LinearForce.defaultValue("force_application")},__classvars__:{ForceType:{Average:"average",Add:"add"},defaultValue:function(a){switch(a){case"force_vector":return new THREE.Vector3(0,-100,0);
case"force_application":return"add";default:return void console.error("OgreParticle.LinearForce: unknown key '"+a+"'.")}}},deserialize:function(a){this.forceVector=OgreScriptUtils.readVector3(a,"force_vector",OgreParticle.LinearForce.defaultValue("force_vector")),this.forceApplication=OgreScriptUtils.readString(a,"force_application",OgreParticle.LinearForce.defaultValue("force_application"))},affectParticles:function(a,b){"add"==this.forceApplication?a.direction.add(this.forceVector.clone().multiplyScalar(b)):a.direction.add(this.forceVector).multiplyScalar(.5)}}),OgreParticle.ColourFader=OgreParticle.Affector.$extend({__init__:function(){this.$super(OgreParticle.Affector.Type.ColourFader),this._color=new Color(OgreParticle.ColourFader.defaultValue("red"),OgreParticle.ColourFader.defaultValue("green"),OgreParticle.ColourFader.defaultValue("blue"),OgreParticle.ColourFader.defaultValue("alpha"))},__classvars__:{defaultValue:function(a){switch(a){case"red":case"green":case"blue":case"alpha":return 0;default:return void console.error("OgreParticle.ColourFader: unknown key '"+a+"'.")}}},deserialize:function(a){this._color.set(OgreScriptUtils.readFloat(a,"red",OgreParticle.ColourFader.defaultValue("red")),OgreScriptUtils.readFloat(a,"green",OgreParticle.ColourFader.defaultValue("green")),OgreScriptUtils.readFloat(a,"blue",OgreParticle.ColourFader.defaultValue("blue")),OgreScriptUtils.readFloat(a,"alpha",OgreParticle.ColourFader.defaultValue("alpha")))},affectParticles:function(a,b){a.color.r+=this._color.r*b,a.color.g+=this._color.g*b,a.color.b+=this._color.b*b,a.color.a+=this._color.a*b,a.color.clamp01()}}),OgreParticle.ColourFader2=OgreParticle.Affector.$extend({__init__:function(){this.$super(OgreParticle.Affector.Type.ColourFader2),this.color1=new Color(OgreParticle.ColourFader2.defaultValue("red1"),OgreParticle.ColourFader2.defaultValue("green1"),OgreParticle.ColourFader2.defaultValue("blue1"),OgreParticle.ColourFader2.defaultValue("alpha1")),this.color2=new Color(OgreParticle.ColourFader2.defaultValue("red2"),OgreParticle.ColourFader2.defaultValue("green2"),OgreParticle.ColourFader2.defaultValue("blue2"),OgreParticle.ColourFader2.defaultValue("alpha2")),this.stateChange=OgreParticle.ColourFader2.defaultValue("state_change")},__classvars__:{defaultValue:function(a){switch(a){case"red1":case"green1":case"blue1":case"alpha1":case"red2":case"green2":case"blue2":case"alpha2":return 0;case"state_change":return 1;default:return void console.error("OgreParticle.ColourFader2: unknown key '"+a+"'.")}}},deserialize:function(a){this.color1.set(OgreScriptUtils.readFloat(a,"red1",OgreParticle.ColourFader2.defaultValue("red1")),OgreScriptUtils.readFloat(a,"green1",OgreParticle.ColourFader2.defaultValue("green1")),OgreScriptUtils.readFloat(a,"blue1",OgreParticle.ColourFader2.defaultValue("blue1")),OgreScriptUtils.readFloat(a,"alpha1",OgreParticle.ColourFader2.defaultValue("alpha1"))),this.color2.set(OgreScriptUtils.readFloat(a,"red2",OgreParticle.ColourFader2.defaultValue("red2")),OgreScriptUtils.readFloat(a,"green2",OgreParticle.ColourFader2.defaultValue("green2")),OgreScriptUtils.readFloat(a,"blue2",OgreParticle.ColourFader2.defaultValue("blue2")),OgreScriptUtils.readFloat(a,"alpha2",OgreParticle.ColourFader2.defaultValue("alpha2"))),this.stateChange=OgreScriptUtils.readFloat(a,"state_change",OgreParticle.ColourFader2.defaultValue("state_change"))},affectParticles:function(a,b){var c=a.age<this.stateChange?this.color1:this.color2;a.color.r+=c.r*b,a.color.g+=c.g*b,a.color.b+=c.b*b,a.color.a+=c.a*b,a.color.clamp01()}}),OgreParticle.Scaler=OgreParticle.Affector.$extend({__init__:function(){this.$super(OgreParticle.Affector.Type.Scaler),this.rate=OgreParticle.Scaler.defaultValue("rate")},__classvars__:{defaultValue:function(a){switch(a){case"rate":return 0;default:return void console.error("OgreParticle.Scaler: unknown key '"+a+"'.")}}},deserialize:function(a){this.rate=OgreScriptUtils.readFloat(a,"rate",OgreParticle.Scaler.defaultValue("rate"))},affectParticles:function(a,b){a.size+=this.rate*b*a.size}}),OgreParticle.Rotator=OgreParticle.Affector.$extend({__init__:function(){this.$super(OgreParticle.Affector.Type.Rotator),this.rotSpeedRangeStart=OgreParticle.Rotator.defaultValue("rotation_speed_range_start"),this.rotSpeedRangeEnd=OgreParticle.Rotator.defaultValue("rotation_speed_range_end"),this.rotRangeStart=OgreParticle.Rotator.defaultValue("rotation_range_start"),this.rotRangeEnd=OgreParticle.Rotator.defaultValue("rotation_range_end")},__classvars__:{defaultValue:function(a){switch(a){case"rotation_speed_range_start":case"rotation_speed_range_end":case"rotation_range_start":case"rotation_range_end":return 0;default:return void console.error("OgreParticle.Rotator: unknown key '"+a+"'.")}}},deserialize:function(a){this.rotSpeedRangeStart=OgreScriptUtils.readFloat(a,"rotation_speed_range_start",OgreParticle.Rotator.defaultValue("rotation_speed_range_start")),this.rotSpeedRangeEnd=OgreScriptUtils.readFloat(a,"rotation_speed_range_end",OgreParticle.Rotator.defaultValue("rotation_speed_range_end")),this.rotRangeStart=OgreScriptUtils.readFloat(a,"rotation_range_start",OgreParticle.Rotator.defaultValue("rotation_range_start")),this.rotRangeEnd=OgreScriptUtils.readFloat(a,"rotation_range_end",OgreParticle.Rotator.defaultValue("rotation_range_end"))},initParticle:function(a){a.rotation=this.rotRangeStart+Math.random()*(this.rotRangeEnd-this.rotRangeStart),a.rotationSpeed=this.rotSpeedRangeStart+Math.random()*(this.rotSpeedRangeEnd-this.rotSpeedRangeStart)},affectParticles:function(a,b){a.rotation+=b*a.rotationSpeed}}),OgreParticle.ColourInterpolator=OgreParticle.Affector.$extend({__init__:function(){this.$super(OgreParticle.Affector.Type.ColourInterpolator),this.stages=[];for(var a=0;a<OgreParticle.ColourInterpolator.MaxStages;++a)this.stages.push({time:1,color:new Color(.5,.5,.5,0)})},__classvars__:{MaxStages:6,defaultValue:function(a){switch(a){case"time":return 1;case"colour":case"color":return new Color(.5,.5,.5,0);default:return void console.error("OgreParticle.ColourInterpolator: unknown key '"+a+"'.")}}},deserialize:function(a){for(var b=0;b<OgreParticle.ColourInterpolator.MaxStages;++b){var c=b.toString();if(0===OgreScriptUtils.readString(a,"time"+c).length)break;this.stages[b].time=OgreScriptUtils.readFloat(a,"time"+c,OgreParticle.ColourInterpolator.defaultValue("time")),this.stages[b].color=OgreScriptUtils.readColor(a,"colour"+c,OgreParticle.ColourInterpolator.defaultValue("colour"))}},affectParticles:function(a){var b=OgreParticle.ColourInterpolator.MaxStages,c=a.age/a.ttl;if(c<=this.stages[0].time)a.color.copy(this.stages[0].color);else if(c>=this.stages[b-1].time)a.color.copy(this.stages[b-1].color);else for(var d=0;b>d;++d)if(c>=this.stages[d].time&&c<this.stages[d+1].time){c-=this.stages[d].time,c/=this.stages[d+1].time-this.stages[d].time,a.color.r=this.stages[d+1].color.r*c+this.stages[d].color.r*(1-c),a.color.g=this.stages[d+1].color.g*c+this.stages[d].color.g*(1-c),a.color.b=this.stages[d+1].color.b*c+this.stages[d].color.b*(1-c),a.color.a=this.stages[d+1].color.a*c+this.stages[d].color.a*(1-c);break}}}),OgreParticle.ColourImage=OgreParticle.Affector.$extend({__init__:function(){this.$super(OgreParticle.Affector.Type.ColourImage)},__classvars__:{defaultValue:function(a){switch(a){case"image":return"";default:return void console.error("OgreParticle.ColourImage: unknown key '"+a+"'.")}}}}),OgreParticle.DeflectorPlane=OgreParticle.Affector.$extend({__init__:function(){this.$super(OgreParticle.Affector.Type.DeflectorPlane)},__classvars__:{defaultValue:function(a){switch(a){case"plane_point":return new THREE.Vector3(0,0,0);case"plane_normal":return new THREE.Vector3(0,1,0);case"bounce":return 1;default:return void console.error("OgreParticle.DeflectorPlane: unknown key '"+a+"'.")}}},affectParticles:function(a,b){var c=a.direction.clone(),d=this.system.localToWorldDir(c);c.multiplyScalar(b);var e=this.particleSystem.localToWorld(a.clone().add(c)),f=this.plane.normal,g=this.plane.distanceToPoint(e);if(0>=g){var h=this.particleSystem.localToWorld(a.clone()),i=this.plane.distanceToPoint(h);if(i>0){var j=d.clone();d.sub(f.clone().multiplyScalar(2*j.dot(f))),d.multiplyScalar(this.bounce),a.direction=this.system.worldToLocalDir(d)}}}}),OgreParticle.DirectionRandomiser=OgreParticle.Affector.$extend({__init__:function(){this.$super(OgreParticle.Affector.Type.DirectionRandomiser)},__classvars__:{defaultValue:function(a){switch(a){case"randomness":return 1;case"scope":return 1;case"keep_velocity":return!1;default:return void console.error("OgreParticle.DirectionRandomiser: unknown key '"+a+"'.")}}}}),OgreParticle.Particle=Class.$extend({__classvars__:{Type:{Visual:0,Emitter:1}},__init__:function(a){this.idx=a,this.position=new THREE.Vector3,this.size=0,this.direction=new THREE.Vector3,this.velocity=0,this.rotation=0,this.rotationSpeed=0,this.age=0,this.ttl=0,this.color=new Color}});var OgreParticleAsset=IAsset.$extend({__init__:function(a){this.$super(a,"OgreParticleAsset"),this.material=null,this.system=null},isLoaded:function(){return null!==this.material},deserializeFromData:function(a,b,c){a=CoreStringUtils.removeComments(a);var d=OgreScriptUtils.readString(a,"material");if(0===d.length)return this.log.error("Material reference not found."),!1;var c=Tundra.asset.requestDependencyAsset(this,d,"OgreMaterial");c&&(c.onCompleted(this,this.onMaterialLoaded),c.onFailed(this,this.onMaterialFailed)),this.system=new OgreParticle.System(this.name),this.system.deserialize(a);for(var e,f=0;null!==(e=OgreScriptUtils.readBlock(a,"emitter",f));){var g;switch(e.name){case"Point":g=new OgreParticle.PointEmitter;break;case"Box":g=new OgreParticle.BoxEmitter;break;default:this.log.warn("Emitter type "+e.name+" not supported at the moment.")}g&&(g.deserialize(a),g.initDurationRepeat(),this.system.emitters.push(g)),f=e.indexEnd}if(0===this.system.emitters.length)return this.log.error(this.name+": no (supported) 'emitter' block(s) found."),!1;for(f=0;null!==(e=OgreScriptUtils.readBlock(a,"affector",f));){var h=null;switch(e.name){case"Scaler":h=new OgreParticle.Scaler;break;case"LinearForce":h=new OgreParticle.LinearForce;break;case"ColourFader":h=new OgreParticle.ColourFader;break;case"ColourFader2":h=new OgreParticle.ColourFader2;break;case"Rotator":h=new OgreParticle.Rotator;break;case"ColourInterpolator":h=new OgreParticle.ColourInterpolator;break;case"DeflectorPlane":var i=new OgreParticle.DeflectorPlane;h=i,i.plane_point=OgreScriptUtils.readVector3(e.data,"plane_point",OgreParticle.DeflectorPlane.defaultValue("plane_point")),i.plane_normal=OgreScriptUtils.readVector3(e.data,"plane_normal",OgreParticle.DeflectorPlane.defaultValue("plane_normal")),i.bounce=OgreScriptUtils.readFloat(e.data,"bounce",OgreParticle.DeflectorPlane.defaultValue("bounce")),i.plane_normal.normalize(),-1!==this.name.indexOf("heat2.particle")&&i.plane_point.add(new THREE.Vector3(0,0,15)),Tundra.scene.entityByName("OuluOcclusionManager")&&(console.log("Applying layer offset -327.10, -8.29, -543.40 for particle deflector plane."),i.plane_point.add(new THREE.Vector3(-327.1,-8.29,-543.4))),i.plane=(new THREE.Plane).setFromNormalAndCoplanarPoint(i.plane_normal.clone(),i.plane_point.clone()),this.system.affectors.push(i);break;default:this.log.warn("Unsupported affector type "+e.name)}h&&(h.deserialize(e.data),this.system.affectors.push(h)),f=e.indexEnd}},onMaterialLoaded:function(a){this.material=a.material,this._emitLoaded()},onMaterialFailed:function(a){this.material=null,this._emitDependencyFailed(a.ref)}}),ScriptInstance=Class.$extend({__init__:function(a,b){this.entityId=a.id,this.componentId=b.id,this.application=null,this.startupApplication=!1},setApplication:function(a){this.application=a,this.startupApplication=a.startupApplication,Tundra.events.send("ScriptInstance."+this.entityId+"."+this.componentId+".ScriptStarted",this,this.application)},isRunning:function(){return null!=this.application},isStartupApplication:function(){return this.startupApplication},stop:function(){if(!this.isRunning()||this.isStartupApplication())return!1;if(Tundra.events.remove("ScriptInstance."+this.entityId+"."+this.componentId+".ScriptStarted",this,this.application),"function"==typeof this.application._onScriptDestroyed)try{this.application._onScriptDestroyed()}catch(a){console.error("ScriptInstance.onScriptDestroyed threw exception:",a.stack||a)}return delete this.application,this.application=null,!0},onApplicationStarted:function(a,b){return Tundra.events.subscribe("ScriptInstance."+this.entityId+"."+this.componentId+".ScriptStarted",a,b)}}),ScriptAsset=IAsset.$extend({__init__:function(a){this.$super(a,"ScriptAsset"),this.script=null,this.instances=[]},_getInstance:function(a,b){if(null==a||null==b)return null;for(var c=0;c<this.instances.length;c++)if(this.instances[c].entityId===a.id&&this.instances[c].componentId===b.id)return this.instances[c];return null},_stopAndRemoveInstance:function(a,b){if(null!=a&&null!=b)for(var c=0;c<this.instances.length;c++)if(this.instances[c].entityId===a.id&&this.instances[c].componentId===b.id)return this.instances[c].stop()&&this.log.debug("Stopped instance of "+this.name+" (Entity: "+a.toString()+", Component: "+b.toString()+")"),void(this.instances[c].isStartupApplication()||this.instances.splice(c,1))},_getOrCreateInstance:function(a,b){var c=this._getInstance(a,b);return null==c&&(this.log.debug("Creating instance of "+this.name+" (Entity: "+a.toString()+", Component: "+b.toString()+")"),c=new ScriptInstance(a,b),this.instances.push(c)),c},_setApplication:function(a){var b=this._getInstance(a.entity,a.component);null==b||Tundra.usingRequireJS()||setTimeout(function(){b.setApplication(a)},10)},requireJsModuleName:function(){return"lib/require.webrocketjs.loader!"+this.name},isLoaded:function(){return null!==this.script},isRunning:function(a,b){var c=this._getInstance(a,b);return null!=c&&null!=c.application},deserializeFromData:function(a,b,c){this.script=a},unload:function(){this.script=null,this.stop()},run:function(a,b,c){var d=null;if(!this.isLoaded())return d;if(this.isRunning(a,b))return d;if(void 0===a||null===a)return this.log.error("Tried to run script "+this.name+" with null parent Entity"),d;if(void 0===b||null===b)return this.log.error("Tried to run script "+this.name+" with null parent EC_Script"),d;if((void 0===c||null===c)&&(c=!1),Tundra.usingRequireJS()&&-1!==this.script.indexOf("define(")){d=this._getOrCreateInstance(a,b);var e=this;require([this.requireJsModuleName()],function(f){IApplication._setupStatic(a,b,e.name,c);try{d.setApplication(new f)}catch(g){e.log.error(e.name+" instance requirejs execution failed: "+g),void 0!==g.stack&&console.error(g.stack),e.script=null,e._stopAndRemoveInstance(a,b)}IApplication._resetStatic()})}else{d=this._getOrCreateInstance(a,b),IApplication._setupStatic(a,b,this.name,c,this);try{$.globalEval(this.script)}catch(f){this.log.error(this.name+" instance eval execution failed: "+f),void 0!==f.stack&&console.error(f.stack),this.script=null,this._stopAndRemoveInstance(a,b)}IApplication._resetStatic()}return d},stop:function(a,b){if(void 0!==a&&void 0!==b)this._stopAndRemoveInstance(a,b);else{for(var c=!1,d=0;d<this.instances.length;d++)this.instances[d].stop()&&(c=!0),this.instances[d].isStartupApplication()||(this.instances.splice(d,1),d--);c&&0===this.instances.length&&this.log.debug("Stopped all running instances of "+this.name),0===this.instances.length&&Tundra.usingRequireJS()&&requirejs.undef(this.requireJsModuleName())}}}),AvatarAttachement=Class.$extend({__init__:function(a){this.parentRef="string"==typeof a?a:"",this.baseRef=0!=this.parentRef.indexOf("/")?this.parentRef.substring(0,this.parentRef.lastIndexOf("/")+1):"",-1!=this.parentRef.indexOf(".zip#")&&(this.baseRef=this.parentRef.substring(0,this.parentRef.lastIndexOf(".zip#")+5)),this.name="",this.category="",this.assets={mesh:"",materials:[]},this.transform=new Transform,this.boneName="",this.linkSkeleton=!1,this.verticesToHide=[],this._completed={all:!1,failed:!1,mesh:void 0,meshAsset:void 0,materials:[],materialAssets:[]},this._assetsRequested=!1,this._cbContext=null,this._cbFunc=null,a instanceof AvatarAttachement&&this.cloneFrom(a)},clone:function(){return new AvatarAttachement(this)},cloneFrom:function(a){this.parentRef=a.parentRef,this.baseRef=a.baseRef,this.name=a.name,this.category=this.category,this.assets.mesh=a.assets.mesh,this.assets.materials=[].concat(a.assets.materials),this.transform=a.transform.clone(),this.boneName=a.boneName,this.linkSkeleton=a.linkSkeleton,this.verticesToHide=[].concat(a.verticesToHide)},validate:function(){"none"===this.boneName.toLowerCase()&&(this.boneName=""),""===this.assets.mesh||CoreStringUtils.startsWith(this.assets.mesh,"http",!0)||(this.assets.mesh=this.baseRef+this.assets.mesh);for(var a=0;a<this.assets.materials.length;a++){var b=this.assets.materials[a];""===b||CoreStringUtils.startsWith(b,"http",!0)||(this.assets.materials[a]=this.baseRef+b)}},isCompleted:function(){return this._completed.all},isLoaded:function(){return this.isCompleted()&&this._completed.failed===!1},onCompleted:function(a,b){(null!=a||null!=b)&&(this._cbContext=null!==a&&void 0!==a?a:null,this._cbFunc="function"==typeof a&&"function"!=typeof b?a:b,this._completed.all===!0&&"function"==typeof this._cbFunc&&this._cbFunc.call(void 0!==this._cbContext&&null!==this._cbContext?this._cbContext:this,this._completed.failed,this))},requestAssets:function(a,b){if(this.onCompleted(a,b),!this._assetsRequested){if(this._assetsRequested=!0,""!==this.assets.mesh){var c=Tundra.asset.requestAsset(this.assets.mesh);null!=c&&(c.onCompleted(this,this._onTransferCompleted),c.onFailed(this,this._onTransferFailed))}for(var d=0;d<this.assets.materials.length;d++){var e=this.assets.materials[d];if(""!==e){var c=Tundra.asset.requestAsset(e);null!=c&&(c.onCompleted(this,this._onTransferCompleted),c.onFailed(this,this._onTransferFailed))}}}},markAssetCompleted:function(a,b){var c=!0,d="string"!=typeof a?a:null;null!=d&&(a=d.originalName()),this.assets.mesh===a?(this._completed.meshAsset=d,b===!1&&(this._completed.failed=!0)):void 0===this._completed.meshAsset&&(c=!1);for(var e=0;e<this.assets.materials.length;e++){var f=this.assets.materials[e];f===a?(this._completed.materialAssets[e]=d,b===!1&&(this._completed.failed=!0)):""!==f&&void 0===this._completed.materialAssets[e]&&(c=!1)}c&&(this._completed.all=!0,"function"==typeof this._cbFunc&&this._cbFunc.call(void 0!==this._cbContext&&null!==this._cbContext?this._cbContext:this,this._completed.failed,this))},_onTransferCompleted:function(a){this.markAssetCompleted(a,!0)},_onTransferFailed:function(a){this.markAssetCompleted(a.ref,!1)},findMeshParentObject:function(a,b){return""===this.boneName?null!=a?a.mesh:null:null!=b?b.getBone(this.boneName):null},attach:function(a,b){var c=!1;if(null==a&&null==b)return c;if(!this.isCompleted())return console.error("AvatarAttachement.attach: Transfer not completed yet",this.baseRef),c;if(!this.isLoaded())return c;var d=""!==this.assets.mesh?this._completed.meshAsset:null;if(null!=d&&null!=d.mesh&&null!=a){d.isAttachement=!0,d.mesh.isAttachement=!0;for(var e=0,f=d.numSubmeshes();f>e;++e){var g=d.getSubmesh(e);null!=g&&(g.isAttachement=!0)}if(null!=a&&a.isLoaded()){var h=this.findMeshParentObject(a,b);null!=h?(null==d.parent?(h.add(d.mesh),this.transform.apply(d.mesh)):d.parent.name!==h.name&&(d.parent.remove(d.mesh),h.add(d.mesh),this.transform.apply(d.mesh)),c=!0):console.error("AvatarAttachement.attach: Failed to find parent object with bone='"+this.boneName+"'"(null!=a?" from "+a.name:""))}else console.error("AvatarAttachement.attach: Parent Mesh asset not loaded",this.baseRef);for(var e=0,f=d.numSubmeshes();f>e;++e){var i=this.assets.materials[e];if("string"==typeof i&&""!==i){var g=d.getSubmesh(e);if(null!=g){var j=this._completed.materialAssets[e];null!=j&&null!=j.material&&g.material.uuid!==j.material.uuid&&(g.material=j.material)}}}this.linkSkeleton===!0&&(null!=b&&b.isLoaded()?b.link(d):console.error("AvatarAttachement.attach: Linking to avatar skeleton is enabled but skeleton asset is not ready",null!=b?b.name:""))}return c},detach:function(){var a=""!==this.assets.mesh?this._completed.meshAsset:null;null!=a&&null!=a.mesh&&null!=a.mesh.parent&&a.mesh.parent.remove(a.mesh)}}),AvatarDescAsset=IAsset.$extend({__init__:function(a){this.$super(a,"AvatarDescAsset"),this.reset()},reset:function(){this.assets={mesh:"",skeleton:"",materials:[]},this.attachements=[],this.transform=new Transform},cloneInstance:function(){for(var a={assets:{mesh:this.assets.mesh,skeleton:this.assets.skeleton,materials:[].concat(this.assets.materials)},attachements:[],transform:this.transform.clone()},b=0;b<this.attachements.length;b++)a.attachements.push(this.attachements[b].clone());return a},cloneAttachements:function(){for(var a=[],b=0;b<this.attachements.length;b++)a.push(this.attachements[b].clone());return a},isLoaded:function(){return""!==this.assets.mesh},deserializeFromData:function(a,b,c){this.reset();var d=this,e=$(a).find("avatar");if(this.assets.mesh=this._readStringAttr(e.children("base"),"mesh"),""===this.assets.mesh){var f=e.children("property");f.each(function(){if(""===d.assets.mesh){var a=d._readStringAttr($(this),"name");"basemesh"===a&&(d.assets.mesh=d._readStringAttr($(this),"value"))}})}this.assets.skeleton=this._readStringAttr(e.children("skeleton"),"name"),this.assets.materials=this._readEach(e.children("material"),"name"),this.assets.mesh=this._validateAssetRef(this.assets.mesh,"mesh"),this.assets.skeleton=this._validateAssetRef(this.assets.skeleton,"skeleton"),this.assets.materials=this._validateAssetRefList(this.assets.materials,"material",!0),this._readTransformAttrs(e.children("transformation"),"position","rotation","scale",this.transform);var g=e.children("attachment");return g.each(function(){d.attachements.push(d._readAttachement($(this)))}),this.isLoaded()},_validateAssetRef:function(a,b){if(""!==a){if(!CoreStringUtils.startsWith(a,"http",!0))return this.baseRef+a}else this.log.warn("Failed to parse",b,"ref from",this.name);return a},_validateAssetRefList:function(a,b,c){if(0===a.length)return this.log.warn("No",b,"assets declared in",this.name),a;c="boolean"==typeof c?c:!0;for(var d=0;d<a.length;d++){var e=a[d];""!==e?CoreStringUtils.startsWith(e,"http",!0)||(a[d]=this.baseRef+e):c||this.log.warn("Empty",b,"found at index",d,"from",this.name)}return a},_readEach:function(a,b,c){var d=this,e=[];return a.each(function(){var a=d._readStringAttr($(this),b);"boolean"===c||"bool"===c?a="1"===a||"true"===a||"on"===a:"int"===c?a=parseInt(a):"float"===c&&(a=parseFloat(a)),e.push(a)}),e},_readAttachement:function(a){var b=a.children("avatar").children("bone").first(),c=new AvatarAttachement(this.name);return c.name=this._readStringAttr(a.children("name"),"value"),c.category=this._readStringAttr(a.children("category"),"name"),c.boneName=this._readStringAttr(b,"name"),c.linkSkeleton=this._readBoolAttr(a.children("mesh"),"linkskeleton"),c.assets.mesh=this._readStringAttr(a.children("mesh"),"name"),c.assets.materials=this._readEach(a.children("material"),"name"),c.verticesToHide=this._readEach(a.children("avatar").children("avatar_polygon"),"idx","int"),this._readTransformAttrs(b,"offset","rotation","scale",c.transform),c.validate(),c},_readStringAttr:function(a,b){var c=a.attr(b);return"string"==typeof c?c:""},_readBoolAttr:function(a,b,c){var d=this._readStringAttr(a,b).toLowerCase();return""===d?"boolean"==typeof c?c:!1:"1"===d||"true"===d||"on"===d},_readTransformAttrs:function(a,b,c,d,e){this._readTransformComponentAttr(a,b,e.pos),this._readTransformComponentAttr(a,c,e),this._readTransformComponentAttr(a,d,e.scale)},_readTransformComponentAttr:function(a,b,c){var d=a.attr(b);if("string"==typeof d){var e=d.split(" ");if("rotation"!==b)e.length>=3?(c.x=parseFloat(e[0]),c.y=parseFloat(e[1]),c.z=parseFloat(e[2])):this.log.warn("Transform component '"+b+"' does not have enough data:",d,e);else if(e.length>=4){var f=new THREE.Quaternion;f.w=parseFloat(e[0]),f.x=parseFloat(e[1]),f.y=parseFloat(e[2]),f.z=parseFloat(e[3]),c.setRotation(f)}else this.log.warn("Transform component '"+b+"' does not have enough data:",d,e)}},unload:function(){this.reset()}}),MeshmoonLayer=Class.$extend({__init__:function(a,b,c,d,e){this.id=a,this.name=b,this.iconUrl=c,this.visible=d,this.exists=e},__classvars__:{fromMeshmoonLayerUpdateMessage:function(a){return new MeshmoonLayer(a.layerId,a.layerName,a.iconUrl,a.visible,a.exists)}},update:function(a,b){var c=this.visible!==a.visible;if(this.visible=a.visible,c&&!b){Tundra.plugin("RocketPlugin");if(Tundra.client.isConnected()){var d=new MeshmoonLayerUpdateMessage;d.serialize(this),Tundra.network.send(d)}else console.error("No active network connection to send MeshmoonLayerUpdateMessage")}},clone:function(){return new MeshmoonLayer(this.id,this.name,this.iconUrl,this.visible,this.exists)},toString:function(){return"MeshmoonLayer "+this.id+" '"+this.name+"' visible="+this.visible.toString()}}),RocketLayerManager=Class.$extend({__init__:function(){this.log=TundraLogging.getLogger("RocketLayerManager"),this.layers=[]},layerById:function(a,b){(void 0==b||"boolean"!=typeof b)&&(b=!0);for(var c=0;c<this.layers.length;c++)if(this.layers[c].id===a)return b?this.layers[c].clone():this.layers[c];return null},layerByName:function(a,b,c){(void 0==b||"boolean"!=typeof b)&&(b=!1),(void 0===c||"boolean"!=typeof c)&&(c=!0),b||(a=a.toLowerCase());for(var d=0;d<this.layers.length;d++){var e=b?this.layers[d].name:this.layers[d].name.toLowerCase();if(e===a)return c?this.layers[d].clone():this.layers[d]}return null},setLayerVisibility:function(a,b){if("boolean"!=typeof b)return this.log.error("setLayerVisibility: param 'visible' not a boolean!"),!1;var c="string"==typeof a?this.layerByName(a):this.layerById(a);return null==c?(this.log.error("setLayerVisibility: Failed to find layer with indentifier",a,"(typeof",typeof indentifier+")"),!1):(c.visible!==b&&(c.visible=b,this.updateLayer(c)),!0)},updateLayer:function(a){var b=!1;a instanceof MeshmoonLayerUpdateMessage&&(b=!0,a=MeshmoonLayer.fromMeshmoonLayerUpdateMessage(a));var c=this.layerById(a.id,!1);return null!=c?(c.update(a,b),void(b&&this.log.debug("Layer updated:",c.toString()))):(this.layers.push(a),void this.log.debug("Layer created:",a.toString(),"from network="+b))}}),EC_RigidBody=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.interpolateLinearVelocity=!1,this.declareAttribute(0,"mass",0,Attribute.Real),this.declareAttribute(1,"shapeType",EC_RigidBody.Type.Box,Attribute.Int),this.declareAttribute(2,"size",new THREE.Vector3(1,1,1),Attribute.Float3),this.declareAttribute(3,"collisionMeshRef","",Attribute.AssetReference),this.declareAttribute(4,"friction",.5,Attribute.Real),this.declareAttribute(5,"restitution",0,Attribute.Real),this.declareAttribute(6,"linearDamping",0,Attribute.Real),this.declareAttribute(7,"angularDamping",0,Attribute.Real),this.declareAttribute(8,"linearFactor",new THREE.Vector3(1,1,1),Attribute.Float3),this.declareAttribute(9,"angularFactor",new THREE.Vector3(1,1,1),Attribute.Float3),this.declareAttribute(10,"kinematic",!1,Attribute.Bool),this.declareAttribute(11,"phantom",!1,Attribute.Bool),this.declareAttribute(12,"drawDebug",!1,Attribute.Bool),this.declareAttribute(13,"linearVelocity",new THREE.Vector3(0,0,0),Attribute.Float3),this.declareAttribute(14,"angularVelocity",new THREE.Vector3(0,0,0),Attribute.Float3)},__classvars__:{TypeId:23,TypeName:"RigidBody",Implementation:"Meshmoon",Type:{Box:0,Sphere:1,Cylinder:2,Capsule:3,TriMesh:4,HeightField:5,ConvexHull:6,Cone:7},typeToString:function(a){return CoreStringUtils.enumToString(EC_RigidBody.Type,a,void 0)}},setInterpolate:function(a){this.interpolateLinearVelocity=a,a&&Tundra.frame.onUpdate(this,this.onFrameUpdate)},onFrameUpdate:function(a){if(this.interpolateLinearVelocity!==!1&&null!=this.parentEntity&&null!=this.parentEntity.placeable&&!(Math.abs(this.linearVelocity.x)<.01&&Math.abs(this.linearVelocity.y)<.01&&Math.abs(this.linearVelocity.z)<.01)){var b=this.linearVelocity.clone();Math.abs(b.y)<.1&&(b.y=0);var c=this.parentEntity.placeable.transform;c.pos.lerp(c.pos.clone().add(b),a),this.parentEntity.placeable.setPosition(c.pos)}}}),TELEPORT_ACTION="EC_MeshmoonTeleport_Teleport",TELEPORT_EXECUTED_ACTION="EC_MeshmoonTeleport_Executed",EC_MeshmoonTeleport=IComponent.$extend({__classvars__:{TypeId:503,TypeName:"MeshmoonTeleport",Implementation:"Meshmoon"},__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"triggerEntity","",Attribute.EntityReference),this.declareAttribute(1,"destinationScene","",Attribute.String),this.declareAttribute(2,"destinationPos",new THREE.Vector3(0,0,0),Attribute.Float3),this.declareAttribute(3,"destinationRot",new THREE.Vector3(0,0,0),Attribute.Float3),this.declareAttribute(4,"destinationName","",Attribute.String),this.declareAttribute(5,"confirmTeleport",!0,Attribute.Bool),this.declareAttribute(6,"teleportOnLeftClick",!1,Attribute.Bool),this.declareAttribute(7,"teleportOnProximity",!1,Attribute.Bool),this.declareAttribute(8,"teleportProximity",5,Attribute.UInt),this.proximityDelta=0,this.ui={},this.ui.confirmationText=$("<span style='float:left; margin:0 7px 20px 0;'></span>",{id:"confirmTextDialog"}),this.ui.confirmationText.html("Do you want to launch teleport?"),this.ui.dialog=$("<div/>",{id:"confirmTeleportDialog"}),this.ui.dialog.width(400),this.ui.dialog.height(200),this.ui.dialog.append($("<p></p>").append(this.ui.confirmationText)),this.ui.dialog.dialog({autoOpen:!1,width:"400px",modal:!1,resizable:!1,position:{my:"center top",at:"center top",of:Tundra.client.container},buttons:{Yes:this.teleportNow.bind(this),No:function(){this.preventDialogSpam=!0,this.ui.dialog.dialog("close")}.bind(this)}}),this.preventDialogSpam=!1,this.subscriptions=[Tundra.input.onMousePress(this,this.onMousePress),Tundra.frame.onUpdate(this,this.onUpdate)]},reset:function(){for(var a=0;a<this.subscriptions.length;a++)Tundra.events.unsubscribe(this.subscriptions[a]);this.subscriptions=[]},update:function(){this.updateConfirmText()},attributeChanged:function(a,b,c){4===a&&this.updateConfirmText()},onMousePress:function(a){if(this.teleportOnLeftClick&&a.leftDown){var b=Tundra.renderer.raycast();null!=b.entity&&b.entity.id==this.triggerEntityPtr().id&&(this.preventDialogSpam=!1,this.execTeleport())}},onUpdate:function(a){if(this.proximityDelta+=a,!(this.proximityDelta<.5||(this.proximityDelta=0,this.teleportProximity<=1e-4||!this.teleportOnProximity))){var b=this.triggerEntityPtr(),c=this.targetEntity();if(null!=b&&null!=b.placeable&&null!=c&&null!=c.placeable){var d=Math.floor(c.placeable.distanceTo(b.placeable));d<=this.teleportProximity?this.execTeleport():this.preventDialogSpam=!1}}},entityByRef:function(a){var b=this.parentScene.entityByName(a);if(null==b){var c=parseInt(a);c!=a||isNaN(c)||(b=this.parentScene.entityById(c))}return b},triggerEntityPtr:function(){if(""===this.triggerEntity)return this.parentEntity;var a=this.entityByRef(this.triggerEntity);return null==a?this.parentEntity:a},targetEntity:function(){var a=Tundra.renderer.activeCameraEntity();if(null==a)return null;var b=a.placeable;if(null==b)return null;var c=b.parentRef;if(""==c)return a;var d=this.entityByRef(c);if(null==d)return a;for(;;){var e=d.placeable;if(null==e)return d;var f=e.parentRef;if(""==f)return d;var g=this.entityByRef(f);if(null==g)break;d=g}return d},execTeleport:function(){this.confirmTeleport?this.teleportWithConfirmation():this.teleportNow()},teleportNow:function(){var a=this.targetEntity();if(null!=a){this.ui.dialog.dialog("isOpen")&&this.ui.dialog.dialog("close");var b=this.destinationPos,c=this.destinationRot;if(a.replicated)this.parentEntity.exec(EntityAction.Server,TELEPORT_ACTION,[a.id,b.x+":"+b.y+":"+b.z,c.x+":"+c.y+":"+c.z]);else{var d=a.placeable.worldTransform();d.pos=b,d.rot=c,a.placeable.setWorldTransform(d),a.exec(EntityAction.Local,TELEPORT_EXECUTED_ACTION,[this.parentEntity.id,this.id,a.id,b.x+":"+b.y+":"+b.z,c.x+":"+c.y+":"+c.z]);
}}},teleportWithConfirmation:function(){this.ui.dialog.dialog("isOpen")||this.preventDialogSpam||this.ui.dialog.dialog("open")},updateConfirmText:function(){this.ui.confirmationText.html(""==this.destinationName?"Do you want to launch teleport?":"Do you want to launch teleport to "+this.destinationName+"?")}}),EC_MeshmoonWater=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"simulationModel",EC_MeshmoonWater.SimulationModel.Tessendorf,Attribute.UInt),this.declareAttribute(1,"beaufortScale",4,Attribute.UInt),this.declareAttribute(2,"waterColor",new Color(0,.2,.3),Attribute.Color),this.declareAttribute(3,"sprayEnabled",!1,Attribute.Bool),this.declareAttribute(4,"drawDebug",!1,Attribute.Bool),this.declareAttribute(5,"enableHeightQueries",!1,Attribute.Bool),this.declareAttribute(6,"waveChoppiness",2,Attribute.Real),this.declareAttribute(7,"seaLevel",0,Attribute.Real),this.declareAttribute(8,"reflectionIntensity",.6,Attribute.Real),this.declareAttribute(9,"visible",!0,Attribute.Bool),this.declareAttribute(10,"reflectionsEnabled",!1,Attribute.Bool),this.waterMesh=null,this.waterMaterial=null,this.waterLoaded=!1,this.skipLoading=!1,this.forwardMovement=!0,this.forwardPosition=!0,this.xSize=5e3,this.ySize=5e3,this.xSegments=10,this.ySegments=10},__classvars__:{TypeId:506,TypeName:"MeshmoonWater",Implementation:"Meshmoon",SimulationModel:{Tessendorf:0,PiersonMoskowitz:1,Jonswap:2}},reset:function(){EC_WaterPlane_ThreeJs.resetWater(this)},update:function(){EC_WaterPlane_ThreeJs.createWater(this),EC_WaterPlane_ThreeJs.updateWater(this),null!=this.waterMesh&&(this.waterMesh.visible=this.attributes.visible.get())},attributeChanged:function(a,b,c){9===a?null!=this.waterMesh&&(this.waterMesh.visible=c):7===a&&EC_WaterPlane_ThreeJs.updateWaterPosition(this)}}),EC_MeshmoonSky=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"cloudCoverage",EC_MeshmoonSky.CloudCoverage.UseExternalCloudLayer,Attribute.UInt),this.declareAttribute(1,"timeZone",EC_MeshmoonSky.TimeZone.UseLongitude,Attribute.UInt),this.declareAttribute(2,"timeMode",EC_MeshmoonSky.TimeMode.RealTime,Attribute.UInt),this.declareAttribute(3,"longitude",0,Attribute.Real),this.declareAttribute(4,"latitude",0,Attribute.Real),this.declareAttribute(5,"godRayIntensity",.7,Attribute.Real),this.declareAttribute(6,"lightSourceBrightness",.5,Attribute.Real),this.declareAttribute(7,"gamma",1.8,Attribute.Real),this.declareAttribute(8,"windDirection",0,Attribute.Real),this.declareAttribute(9,"windSpeed",0,Attribute.Real),this.declareAttribute(10,"lensFlare",!1,Attribute.Bool),this.declareAttribute(11,"time",14,Attribute.Real),this.declareAttribute(12,"timeMultiplier",1,Attribute.Real),this.declareAttribute(13,"date","",Attribute.String),this.initialized=!1,this.dayDuration=86400,this.initializeSky()},__classvars__:{TypeId:507,TypeName:"MeshmoonSky",Implementation:"Meshmoon",CloudCoverage:{UseExternalCloudLayer:0,NoClouds:1,Fair:2,PartlyCloudy:3,MostlyCloudy:4,Overcast:5,Storm:6},TimeZone:{GMT:0,CET:1,EET:2,BT:3,GET:4,PKT:5,BST:6,THA:7,CCT:8,JST:9,GST:10,SBT:11,IDLE:12,WAT:13,AT:14,BRT:15,AST:16,EST:17,CST:18,MST:19,PST:20,YST:21,AHST:22,NT:23,IDLW:24,UseLongitude:25},TimeMode:{RealTime:0,SimulatedTime:1}},initializeSky:function(){if(!this.checkExistingSky()){var a=Tundra.renderer.scene;this.lastTimeMsec=null,this.sunAngle=-0.5*Math.PI*2;var b=Tundra.asset.requestAsset("webrocket://media/textures/galaxy_starfield.dds");b.onCompleted(this,function(b){var c=0;c=Tundra.renderer.activeCamera()?Tundra.renderer.activeCamera().farPlane:Tundra.browser.isMobile()?3e3:5e3,c=c/2+500,2e3>c&&(c=2e3),THREEx.DayNight.domeRadius=c,this.starField=new THREEx.DayNight.StarField(b.texture),a.add(this.starField.object3d),this.sunSphere=new THREEx.DayNight.SunSphere,a.add(this.sunSphere.object3d),this.sunLight=new THREEx.DayNight.SunLight,this.sunLight.setIntensity(this.lightSourceBrightness),a.add(this.sunLight.object3d),this.skydom=new THREEx.DayNight.Skydom,a.add(this.skydom.object3d),this.initialized=!0,void 0===this.frameUpdateSubscription&&(this.frameUpdateSubscription=Tundra.frame.onUpdate(this,this.onUpdate)),this.update()})}},update:function(){var a=0;if(this.timeMode==EC_MeshmoonSky.TimeMode.RealTime){a=this.timeZone==EC_MeshmoonSky.TimeZone.UseLongitude?Math.round(24*this.longitude/360):this.timeZone>12?this.timeZone-12:-1*this.timeZone;var b=new Date,c=b.getUTCHours();c+=.0166667*b.getUTCMinutes(),c+=277778e-9*b.getUTCSeconds(),c+=-1*a,c>24&&(c-=24),this.setAngleFromTime(c)}else this.timeMode==EC_MeshmoonSky.TimeMode.SimulatedTime&&this.setAngleFromTime(this.time)},onUpdate:function(a){this.initialized&&this.updateAll(a)},updateAll:function(a){if(this.initialized){var b=Tundra.renderer.activeCamera(),c=null!=b?b.getWorldFocusPosition():null;if(null!=c){c.y=0,void 0===this._distComparePos&&(this._distComparePos=new THREE.Vector3(0,0,0)),void 0===this._maxSquared&&(this._maxSquared=1e7);var d=c.distanceToSquared(this._distComparePos);d<this._maxSquared&&(null!=this.skydom.object3d&&(this.skydom.object3d.position.x=c.x,this.skydom.object3d.position.z=c.z),null!=this.starField.object3d&&(this.starField.object3d.position.x=c.x,this.starField.object3d.position.z=c.z))}var e=this.timeMode==EC_MeshmoonSky.TimeMode.RealTime?1:this.timeMultiplier;1>e&&(e=0),this.sunAngle+=e*(a/this.dayDuration)*Math.PI*2,this.starField.update(this.sunAngle),this.sunSphere.update(this.sunAngle),this.sunLight.update(this.sunAngle),this.skydom.update(this.sunAngle)}},reset:function(){this.initialized=!1,void 0!==this.frameUpdateSubscription&&(Tundra.events.unsubscribe(this.frameUpdateSubscription),this.frameUpdateSubscription=void 0);var a=Tundra.renderer.scene;this.starField&&this.starField.object3d&&a.remove(this.starField.object3d),this.sunSphere&&this.sunSphere.object3d&&a.remove(this.sunSphere.object3d),this.sunLight&&this.sunLight.object3d&&a.remove(this.sunLight.object3d),this.skydom&&this.skydom.object3d&&a.remove(this.skydom.object3d)},setAngleFromTime:function(a){this.sunAngle=a*(Math.PI/12)-7/12*Math.PI,this.updateAll(0)},checkExistingSky:function(){if(null==this.parentEntity||null==this.parentEntity.parentScene)return!1;for(var a=this.parentEntity.parentScene.components("Sky"),b=0;b<a.length;b++)if(a[b].skyLoaded===!0)return!0;a=this.parentEntity.parentScene.components("SkyX");for(var b=0;b<a.length;b++)if(a[b].skyLoaded===!0)return!0;a=this.parentEntity.parentScene.components("MeshmoonSky");for(var b=0;b<a.length;b++)if(a[b].skyLoaded===!0)return!0;return!1},attributeChanged:function(a,b,c){a>=1&&3>=a?this.update():11===a?this.timeMode==EC_MeshmoonSky.TimeMode.SimulatedTime&&this.setAngleFromTime(c):6===a&&null!=this.sunLight&&this.sunLight.setIntensity(c)}}),EC_WebBrowser=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"enabled",!0,Attribute.Bool),this.declareAttribute(1,"url",!0,Attribute.String),this.declareAttribute(2,"size",new THREE.Vector2(1024,1024),Attribute.QPoint),this.declareAttribute(3,"renderTarget","",Attribute.EntityReference),this.declareAttribute(4,"renderSubmeshIndex",0,Attribute.UInt),this.declareAttribute(5,"illuminating",!0,Attribute.Bool),this.declareAttribute(6,"mouseInput",!0,Attribute.Bool),this.declareAttribute(7,"keyboardInput",!0,Attribute.Bool),this.declareAttribute(8,"synchronizedClient",-1,Attribute.Int),this.started=!1,this.planes=null,this.element=null,this.errorElement=null,this.cssObject=null,this.meshLoadHooked=!1,this.eventSubscriptions=[],this.transform=new Transform,this.magicCssScale=new THREE.Vector3(1,1,1),EC_WebBrowser.browserSupported()||this.log.warn("Your browser does not support everything this component needs correctly:",navigator.userAgent)},__classvars__:{TypeId:501,TypeName:"WebBrowser",Implementation:"Meshmoon",canDetectUrlEmbeddableInIFrame:function(){return null!=Tundra.asset&&null!=Tundra.asset.getHttpProxyResolver()},isUrlEmbeddableInIFrame:function(a,b,c){if(void 0!==a&&void 0!==c&&("function"==typeof b||"function"==typeof c)){var d=function(a){"function"!=typeof b?c.call(b,a):b(a)},e=Tundra.asset.getHttpProxyResolver();void 0!==e&&null!==e?$.ajax({type:"GET",timeout:5e3,url:e.proxyUrl+"utils/embeddable?url="+encodeURIComponent(a)}).done(function(a,b,c){d(200===c.status)}).fail(function(a,b,c){d(!1)}):(this.log.error("isUrlEmbeddableInIFrame() cannot function without a Meshmoon proxy resolver set. Cannot detect for url: "+a),d(!1))}},browserSupported:function(){return!Tundra.browser.isOpera}},reset:function(){this.started=!1,null!=this.cssObject&&null!=this.cssObject.parent&&Tundra.renderer.removeCssObject(this.cssObject),this.cssObject=null,null!=this.element&&this.element.remove(),this.element=null,null!=this.errorElement&&this.errorElement.remove(),this.errorElement=null;var a=null!=this.planes&&this.planes.length>0?this.planes[0]:null;null!=a&&(null!=a.parent&&a.parent.remove(a),a.geometry.dispose()),this.planes=null;for(var b=0;b<this.eventSubscriptions.length;b++)Tundra.events.unsubscribe(this.eventSubscriptions[b]);this.eventSubscriptions=[]},start:function(){this.started!==!0&&(this.started=!0,this.update())},stop:function(){this.reset()},_onParentPlaceableVisibleChanged:function(a){if(Array.isArray(this.planes))for(var b=0;b<this.planes.length;b++)this.planes[b].visible=a;null!=this.cssObject&&(a?Tundra.renderer.addCssObject(this.cssObject):a||void 0===this.cssObject.parent||Tundra.renderer.removeCssObject(this.cssObject))},updateCssObjectTransform:function(){if(this.started===!0&&null!=this.cssObject){var a=null!=this.planes&&this.planes.length>0?this.planes[0]:null;if(null!=a&&a.visible){this.magicCssScale.x=a.geometry.parameters.width/this.attributes.size.get().x,this.magicCssScale.y=a.geometry.parameters.height/this.attributes.size.get().y,this.magicCssScale.z=1;var b=a.matrixWorld,c=a.matrix;b.decompose(this.cssObject.position,this.cssObject.quaternion,this.transform.scale),this.transform.scale.setFromMatrixScale(c).multiply(this.magicCssScale);for(var d=a.parent;null!=d&&d instanceof THREE.Object3D;)this.transform.scale.multiply(d.scale),d=d.parent;this.cssObject.scale.copy(this.transform.scale)}}},onTargetMeshLoaded:function(){this.update()},update:function(){if(this.started===!0&&EC_WebBrowser.browserSupported())try{if(""==this.attributes.url.get())return void this.reset();if(null==this.element){if(null==this.parentEntity)return;var a=this.parentEntity.getComponent("Placeable"),b=this.parentEntity.getComponent("Mesh");if(null==a||null==b)return;if(null==b.meshAsset)return void(this.meshLoadHooked||(this.meshLoadHooked=!0,b.onMeshLoaded(this,this.onTargetMeshLoaded)));var c=b.meshAsset.getSubmesh(this.attributes.renderSubmeshIndex.get());if(void 0===c||null===c)return void this.log.error("The target submesh "+this.attributes.renderSubmeshIndex.get()+" does not exist.",!0);c.geometry.computeBoundingBox();for(var d=c.geometry.boundingBox.clone(),e=(d.max.y+d.min.y)/2,f=d.size(),g=0;g<b.meshAsset.numSubmeshes();g++){var h=b.meshAsset.getSubmesh(g);h.geometry.computeBoundingBox();var i=h.geometry.boundingBox.clone(),j=i.size();f.z<j.z&&(f.z=j.z)}var k=new THREE.MeshBasicMaterial({color:new THREE.Color("black"),blending:THREE.NoBlending,side:THREE.DoubleSide,opacity:0});this.planes=[];for(var l=0;1>l;l++){var m=new Transform;if(0==l){m.scale.x=f.x,m.scale.y=f.y,m.pos.x=0,m.pos.y=e,m.pos.z=f.z/2;var n=.001*m.pos.z;.005>n&&(n=.005),m.pos.z+=n}var o=new THREE.Mesh(new THREE.PlaneGeometry(m.scale.x,m.scale.y),k);o.name="Entity_"+this.parentEntity.id+"_EC_WebBrowser_"+this.id+"_"+l,o.tundraEntityId=this.parentEntity.id,o.geometry.computeTangents(),m.setScale(1,1,1),Tundra.renderer.updateSceneNode(o,m),o.matrixAutoUpdate=!1,a.addChild(o),this.planes.push(o);break}this.element=$('<iframe id="EC_WebBrowser_'+this.id+'" name="EC_WebBrowser_'+this.id+'"/>'),this.element.css({width:this.attributes.size.get().x,height:this.attributes.size.get().y,border:0}),null!=this.cssObject&&null!=this.cssObject.parent&&Tundra.renderer.removeCssObject(this.cssObject),this.cssObject=null,this.cssObject=new THREE.CSS3DObject(this.element.get(0)),this.cssObject.matrixAutoUpdate=!0,this._onParentPlaceableVisibleChanged(a.visible),this.eventSubscriptions.push(a.attributeById("visible").onChanged(this,this._onParentPlaceableVisibleChanged))}EC_WebBrowser.canDetectUrlEmbeddableInIFrame()?EC_WebBrowser.isUrlEmbeddableInIFrame(this.attributes.url.getClone(),this,this.onUrlEmbeddable):this.updateUrl()}catch(p){this.log.error("Update failed: ",p),void 0!==p.stack&&console.error(p.stack)}},updateUrl:function(){if(null!=this.element){null!=this.errorElement&&this.errorElement.remove();var a=jQuery.trim(this.attributes.url.getClone());""!==a&&(0!=a.indexOf("http")&&(a="http://"+a),this.element.attr("src",a))}},onUrlEmbeddable:function(a){return a?void this.updateUrl():void(null!=this.element&&null!=this.cssObject&&(null!=this.errorElement&&this.errorElement.remove(),this.log.error("The web page "+this.attributes.url.getClone()+" cannot be embedded to a 3D web browser. Denied <iframe> embedding with the 'X-Frame-Options' header."),this.errorElement=$("<div/>",{id:"EC_WebBrowser_"+this.id}),this.errorElement.css({width:this.attributes.size.get().x,height:this.attributes.size.get().y,border:0,color:"red","font-family":"Arial","font-size":"18pt"}),this.errorElement.html('<div style="width: 100%; height: 100px; text-align: center; position: absolute; top: '+(this.attributes.size.get().y/2-100)+'px;">The web page <b>'+this.attributes.url.getClone()+"</b> cannot be embedded to a 3D web browser</div>"),this.cssObject.element=this.errorElement.get(0),this.cssObject.element.style.position="absolute",this.cssObject.element.style.WebkitTransformStyle="preserve-3d",this.cssObject.element.style.MozTransformStyle="preserve-3d",this.cssObject.element.style.oTransformStyle="preserve-3d",this.cssObject.element.style.transformStyle="preserve-3d",this.element.remove(),this.element=null))},attributeChanged:function(a,b,c){1===a&&this.update()}}),EC_Meshmoon3DText=IComponent.$extend({__init__:function(a,b,c,d){this.$super(a,b,c,d),this.declareAttribute(0,"font","ubuntu",Attribute.String),this.declareAttribute(1,"pointSize",20,Attribute.UInt),this.declareAttribute(2,"style",EC_Meshmoon3DText.Style.Regular,Attribute.UInt),this.declareAttribute(3,"color",Color.white(),Attribute.Color),this.declareAttribute(4,"materialRef","",Attribute.AssetReference),this.declareAttribute(5,"text","",Attribute.String),this.declareAttribute(6,"fontRefs",[],Attribute.AssetReferenceList),this.declareAttribute(7,"webFontRefs",[EC_Meshmoon3DText.DefaultFontRef_Regular],Attribute.AssetReferenceList),this.timing=new AsyncHelper("EC_Meshmoon3DText",this),this.center=!0,this.lights=!0,this.textMesh=null,this.textGeom=null},__classvars__:{TypeId:509,TypeName:"Meshmoon3DText",Implementation:"Meshmoon",DefaultFontRef_Regular:"http://meshmoon.data.s3.amazonaws.com/app/ec_meshmoon3dtext/ubuntu_font/ubuntu_regular.typeface.js",Style:{Regular:0,Bold:1,Italic:2,BoldItalic:3},styleToStyleAndWeight:function(a){switch(a){case EC_Meshmoon3DText.Style.Bold:return{style:"normal",weight:"bold"};case EC_Meshmoon3DText.Style.Italic:return{style:"italic",weight:"normal"};case EC_Meshmoon3DText.Style.BoldItalic:return{style:"italic",weight:"bold"};case EC_Meshmoon3DText.Style.Regular:default:return{style:"normal",weight:"normal"}}},FontPromises:{},LoadedFonts:{},isFontLoaded:function(a){return"boolean"==typeof this.LoadedFonts[a]},loadFont:function(a){var b=this.FontPromises[a];if(void 0!==b)return b;var c=this.LoadedFonts[a];if("boolean"==typeof c)return $.Deferred(function(a){c?a.resolve():a.reject()}).promise();var d=Tundra.asset.loadScript(a).done(function(){this.LoadedFonts[a]=!0}.bind(this)).fail(function(){this.LoadedFonts[a]=!1,console.error("[Meshmoon3DText]: Failed to load font '"+a+"'. Meshes using this font wont be rendered.")}.bind(this)).always(function(){this.FontPromises[a]=void 0}.bind(this));return this.FontPromises[a]=d,d}},reset:function(){this.destroyTextGeometry(),this.destroyMaterial(),this._componentAddedSub&&(Tundra.events.unsubscribe(this._componentAddedSub),this._componentAddedSub=null)},loadFont:function(a){EC_Meshmoon3DText.isFontLoaded(a)?this.update():EC_Meshmoon3DText.loadFont(a).done(this.update.bind(this))},attributeChanged:function(a){switch(a){case this.attributes.webFontRefs.index:for(var b=0;b<this.webFontRefs.length;++b)this.loadFont(this.webFontRefs[b]);break;default:this.timing.async("lazy.update",this.update,10)}},update:function(){if("string"==typeof this.text&&""!==this.text.trim()){for(var a=!1,b=0;b<this.webFontRefs.length;++b){var c=this.webFontRefs[b];EC_Meshmoon3DText.isFontLoaded(c)||(a=!0,this.loadFont(c))}a||(this.updateMaterial(),this.updateTextGeometry(),this.textMesh&&!this.textMesh.parent&&(this.parentEntity.placeable?this._onParentEntityComponentCreated(this.parentEntity,this.parentEntity.placeable):this._componentAddedSub=this.parentEntity.onComponentCreated(this,this._onParentEntityComponentCreated)))}},destroyMaterial:function(){this.material&&this.material.dispose(),this.material=null,this._lastIntColor=void 0},updateMaterial:function(){void 0===this.material&&(this.lights?this.material=RocketShaderLibrary.createMeshmoonMaterial("meshmoon/Diffuse","EC_Meshmoon3DText_"+this.parentEntity.id+"_"+this.id):(this.material=new THREE.MeshBasicMaterial,this.material.lights=!1));var a=this.color.toRgb(!0);(void 0===this._lastIntColor||this._lastIntColor.r!==a.r||this._lastIntColor.g!==a.g||this._lastIntColor.b!==a.b)&&(this.lights?this.material.uniforms.diffuseMap.value=RocketShaderLibrary.getSolidColorTexture(a.r,a.g,a.b):(this.material.map=RocketShaderLibrary.getSolidColorTexture(a.r,a.g,a.b),this.material.needsUpdate=!0),this._lastIntColor=a)},destroyTextGeometry:function(){this.textMesh&&(this.textMesh.parent&&this.textMesh.parent.remove(this.textMesh),this.textMesh=null),this.textGeom&&(this.textGeom.dispose(),this.textGeom=null)},updateTextGeometry:function(){if((!this.textGeom||"string"!=typeof this.textGeom.lastText||"string"!=typeof this.textGeom.lastFont||this.textGeom.lastText!==this.text||this.textGeom.lastFont!==this.font.toLowerCase())&&(this.destroyTextGeometry(),"string"==typeof this.text&&""!==this.text.trim())){var a=EC_Meshmoon3DText.styleToStyleAndWeight(this.style),b={size:this.pointSize,height:this.pointSize/4,font:this.font.toLowerCase(),style:a.style,weight:a.weight,curveSegments:2};try{this.textGeom=new THREE.TextGeometry(this.text,b),this.textMesh=new THREE.Mesh(this.textGeom,this.material),this.textGeom.computeBoundingBox(),this.textGeom.lastText=this.text,this.textGeom.lastFont=this.font.toLowerCase(),this.textGeom.textWidth=this.textGeom.boundingBox.max.x-this.textGeom.boundingBox.min.x,this.center&&this.parentEntity&&this.parentEntity.placeable&&(this.textMesh.position.x-=this.textGeom.textWidth/2),Tundra.renderer.onSceneMeshCreated(this.parentEntity,this,this.textMesh)}catch(c){return void this.log.error(c.message)}}},_onParentEntityComponentCreated:function(a,b){"Placeable"===b.typeName&&(this._componentAddedSub&&(Tundra.events.unsubscribe(this._componentAddedSub),this._componentAddedSub=void 0),b.addChild(this.textMesh))}}),MeshmoonPermissions=Class.$extend({__init__:function(a){this.reset("object"==typeof a?a:void 0),this._timing=new AsyncHelper("MeshmoonPermissions",this)},reset:function(a){this.levelId=a&&"number"==typeof a.levelId?a.levelId:void 0,this.level=a&&"string"==typeof a.level?a.level.trim():"",this.isValid()&&this._timing.deferImmediate("permissions.set",!0,this)},resetEvents:function(){this._timing.cancel("permissions.set")},isValid:function(){return"number"==typeof this.levelId&&"string"==typeof this.level&&""!==this.level},clone:function(){return new MeshmoonPermissions(this)},onResolved:function(){return this.isValid()?this._timing.deferImmediate("permissions.set",!0,this):this._timing.defer("permissions.set")},isAdmin:function(){return"number"!=typeof this.levelId?!1:this.levelId>=MeshmoonCommon.PermissionLevel.Admin&&this.levelId<MeshmoonCommon.PermissionLevel.PermissionLevelOutOfRange},isElevated:function(){return"number"!=typeof this.levelId?!1:this.levelId>=MeshmoonCommon.PermissionLevel.Elevated&&this.levelId<MeshmoonCommon.PermissionLevel.PermissionLevelOutOfRange}}),MeshmoonAccount=Class.$extend({__init__:function(a){this.reset("object"==typeof a&&a instanceof MeshmoonAccount?a:void 0)},reset:function(a){this.id=a?a.id:"",this.name=a?a.name:"",this.picture=a?a.picture:""},isValid:function(){return"string"==typeof this.name&&""!==this.name},clone:function(){return new MeshmoonAccount(this)},readFromLaunchpadSpace:function(a){return"object"!=typeof a?void console.error("[MeshmoonAccount]: readFromLaunchpadSpace invalid param:",a):"string"!=typeof a.CompanyName?void console.error("[MeshmoonAccount]: readFromLaunchpadSpace invalid param, 'CompanyName' property missing:",a):(this.id="string"==typeof a.CompanyId?a.CompanyId:"",this.name="string"==typeof a.CompanyName?a.CompanyName:"",void(this.picture="string"==typeof a.CompanyImageUrl?a.CompanyImageUrl:""))}}),MeshmoonMEP=Class.$extend({__init__:function(a){this.reset("object"==typeof a&&a instanceof MeshmoonMEP?a:void 0)},reset:function(a){this.id=a?a.id:"",this.name=a?a.name:""},isValid:function(){return"string"==typeof this.id&&""!==this.id},clone:function(){return new MeshmoonMEP(this)},readFromLaunchpadSpace:function(a){return"object"!=typeof a?void console.error("[MeshmoonMEP]: readFromLaunchpadSpace invalid param:",a):"object"!=typeof a.Mep?void console.error("[MeshmoonMEP]: readFromLaunchpadSpace invalid param, 'Mep' property missing:",a):(this.id="string"==typeof a.Mep.Id?a.Mep.Id:"",void(this.name="string"==typeof a.Mep.Name?a.Mep.Name:""))}}),MeshmoonSpace=Class.$extend({__init__:function(a){this.reset("object"==typeof a&&a instanceof MeshmoonSpace?a:void 0)},reset:function(a){this.id=a?a.id:"",this.name=a?a.name:"",this.picture=a?a.picture:"",this.txmlURL=a?a.txmlURL:"",this["public"]=a?a["public"]:!1,this.maintenance=a?a.maintenance:!1,this.category=a?a.category:"",this.tags=a?[].concat(a.tags):[],this.account=new MeshmoonAccount(a?a.account:void 0),this.mep=new MeshmoonMEP(a?a.account:void 0)},isValid:function(){return"string"==typeof this.id&&""!==this.id},clone:function(){return new MeshmoonSpace(this)},readFromLaunchpadSpace:function(a){return"object"!=typeof a?void console.error("[MeshmoonSpace]: readFromLaunchpadSpace invalid param:",a):"string"!=typeof a.TxmlId||""===a.TxmlId?void console.error("[MeshmoonSpace]: readFromLaunchpadSpace invalid param, 'TxmlId' property missing:",a):($.extend(this,{id:"string"==typeof a.TxmlId?a.TxmlId:"",name:"string"==typeof a.TxmlName?a.TxmlName:"",picture:"string"==typeof a.TxmlImageUrl?a.TxmlImageUrl:"",txmlURL:"string"==typeof a.TxmlUrl?a.TxmlUrl:"","public":"boolean"==typeof a.Public?a.Public:!1,maintenance:"boolean"==typeof a.Maintenance?a.Maintenance:!1,category:"string"==typeof a.Category?a.Category:"",tags:Array.isArray(a.Tags)?[].concat(a.Tags):[]}),this.account.readFromLaunchpadSpace(a),void this.mep.readFromLaunchpadSpace(a))},getPicture:function(){return"string"==typeof this.picture&&""!==this.picture?this.picture:this.account&&"string"==typeof this.account.picture&&""!==this.account.picture?this.account.picture:""}}),MeshmoonUsers=Class.$extend({__init__:function(a){this.log=TundraLogging.getLogger("MeshmoonUsers"),this.users=[]},reset:function(a){this.users=[]},resetEvents:function(){Tundra.events.remove("Rocket.MeshmoonUsers.onUserAdded"),Tundra.events.remove("Rocket.MeshmoonUsers.onUserUpdated"),Tundra.events.remove("Rocket.MeshmoonUsers.onUserRemoved")},each:function(a){if("function"!=typeof a)return void this.log.error("each 'fn' is not a function");for(var b=0;b<this.users.length;b++)a($.extend(!0,{},this.users[b]))},_cleanObject:function(a){for(var b=$.extend(!0,{},a),c=Object.keys(b),d=c.length-1;d>=0;d--){var e=b[c[d]];"function"==typeof e&&delete b[c[d]]}return b.me=b.connId===Tundra.client.connectionId,b.me&&(b.anonymous=this.meAnonymous(),b.usernameDefined=this.meNameDefined()),b},_meUpdated:function(a,b,c){var d={};a.name!==b.name&&"string"==typeof b.name&&(d.Name=b.name,this.meAnonymous()&&"boolean"==typeof Tundra.client.loginProperties.lpusernamedefined&&(Tundra.client.loginProperties.lpusernamedefined=!0),Tundra.client.loginProperties.username=b.name),a.picture!==b.picture&&"string"==typeof b.picture&&(d.PictureUrl=b.picture,Tundra.client.loginProperties.profilepicture=b.picture),Object.keys(d).length>0&&this.meAnonymous()&&"object"==typeof MeshmoonLaunchpad&&"function"==typeof MeshmoonLaunchpad.updateAnonymousUser&&MeshmoonLaunchpad.updateAnonymousUser($.extend({},MeshmoonLaunchpad.user,d))},meAnonymous:function(){return"object"==typeof MeshmoonLaunchpad&&"object"==typeof MeshmoonLaunchpad.user&&Tundra.client.loginProperties.anonymous===!0},meNameDefined:function(){if(this.meAnonymous())return Tundra.client.loginProperties.lpusernamedefined===!0;var a=this.getMe();return"string"==typeof a.name&&""!==a.name},getMe:function(){for(var a=0;a<this.users.length;a++)if(this.users[a].me===!0)return $.extend(!0,{},this.users[a]);for(var a=0;a<this.users.length;a++)if(this.users[a].connId===Tundra.client.connectionId)return $.extend(!0,{},this.users[a]);return Tundra.client.isConnected()?{connId:Tundra.client.connectionId,id:Tundra.client.loginProperties.userid,name:Tundra.client.loginProperties.username,picture:Tundra.client.loginProperties.profilepicture}:void 0},getUser:function(a){if("number"==typeof a){for(var b=0;b<this.users.length;b++)if(this.users[b].connId===a)return $.extend(!0,{},this.users[b])}else if("string"==typeof a){for(var b=0;b<this.users.length;b++)if(this.users[b].id===a)return $.extend(!0,{},this.users[b])}else this.log.error("getUser called with invalid 'id':",typeof a,a);return void 0},addUser:function(a,b){if("number"!=typeof a.connId)return this.log.error("addUser called with user object that does not have 'connId' Tundra connection id:",a),!1;var c=this.getUser(a.connId);if(void 0===c){var d=this._cleanObject(a);this.users.push(d),Tundra.events.send("Rocket.MeshmoonUsers.onUserAdded",d,b)}else this.updateUser(a,b);return!0},onUserAdded:function(a,b){return Tundra.events.subscribe("Rocket.MeshmoonUsers.onUserAdded",a,b)},updateUser:function(a,b){if("number"!=typeof a.connId)return this.log.error("updateUser called with user object that does not have 'connId' Tundra connection id:",a),!1;var c=this.getUser(a.connId);if(void 0!==c){c.me&&this._meUpdated(c,a,b);var d=$.extend(!0,{},c,this._cleanObject(a));if("string"==typeof d.name&&c.name!==d.name){var e=Tundra.scene.entityByName("Avatar"+d.connId);e&&(e.description=d.name),e=Tundra.scene.entityByName("UserPresence"+d.connId),e&&(e.description=d.name)}for(var f=this.users.length-1;f>=0;f--)this.users[f].connId===d.connId&&(this.users[f]=d);Tundra.events.send("Rocket.MeshmoonUsers.onUserUpdated",d,b)}else this.addUser(a,b);return!0},onUserUpdated:function(a,b){return Tundra.events.subscribe("Rocket.MeshmoonUsers.onUserUpdated",a,b)},removeUser:function(a,b){var c=a;if("number"!=typeof c){if("number"!=typeof a.connId)return this.log.error("removeUser must be called with a Tundra connection id or a user object with .connId property:",typeof a,a),!1;c=a.connId}for(var d=!1,e=this.users.length-1;e>=0;e--){var f=this.users[e];f.connId===c&&(d=!0,this.users.splice(e,1),Tundra.events.send("Rocket.MeshmoonUsers.onUserRemoved",f,b))}return d||this.log.error("removeUser failed to find user to remove with connection id:",c),d},onUserRemoved:function(a,b){return Tundra.events.subscribe("Rocket.MeshmoonUsers.onUserRemoved",a,b)}}),JqueryDialog=Class.$extend({__init__:function(a){if(this._p=$("<div/>",{id:a.id}),null!=a.css&&this._p.css(a.css),this._p.dialog(a),null!=a.bodyElements)for(var b=0;b<a.bodyElements.length;++b)"string"==typeof a.bodyElements[b]?this._p.append(a.bodyElements[b]+"<br /><br />"):this._p.append(a.bodyElements[b])},open:function(){this._p.dialog("open")},close:function(){this._p.dialog("close")},isOpen:function(){return this._p.dialog("isOpen")},option:function(a,b){return void 0==b?this._p.dialog("option",a):void this._p.dialog("option",a,b)}}),BootstrapDialog=Class.$extend({__init__:function(a){this._p=$("<div class='modal fade'/>"),this.modalDialog=$("<div class='modal-dialog'/>");var b=$("<div class='modal-content'/>"),c=$("<div class='modal-header'/>"),d=$('<button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>'),e=$("<h4 class='modal-title'/>"),f=$("<div class='modal-body'/>"),g=$("<div class='modal-footer'/>");if(this._p.css("overflow","hidden"),c.append(d),e.html(a.title),c.append(e),null!=a.bodyElements)for(var h=0;h<a.bodyElements.length;++h)"string"==typeof a.bodyElements[h]?f.append("<p>"+a.bodyElements[h]+"</p>"):f.append(a.bodyElements[h]);for(var h in a.buttons){var i=$("<button type='button' class='btn btn-primary'>"+h+"</button>");i.click(a.buttons[h]),g.append(i)}b.append(c),b.append(f),b.append(g),this.modalDialog.append(b),this._p.append(this.modalDialog),this._p.modal({show:null!=a.autoOpen?a.autoOpen:!1,keyboard:null!=a.closeOnEscape?a.closeOnEscape:!0,backdrop:1==a.modal?"static":!0})},open:function(){this._p.modal("show")},close:function(){this._p.modal("hide")},isOpen:function(){return this._p.data("bs.modal").isShown},option:function(a,b){}}),MeshmoonDialog=Class.$extend({__classvars__:{create:function(a){return"undefined"==typeof $.fn.modal?new JqueryDialog(a):new BootstrapDialog(a)}}}),MeshmoonCRS=Class.$extend({__init__:function(a,b){this.grid=b,this.EARTH_DIAMETER=12756274,this.EARTH_CIRCUMFERENCE=this.EARTH_DIAMETER*Math.PI,this.tileSize="number"==typeof a?a:256,this.initialResolution=this.EARTH_CIRCUMFERENCE/this.tileSize,this.originShift=this.EARTH_CIRCUMFERENCE/2},latLonToMeters:function(a,b){var c=b*this.originShift/180,d=Math.log(Math.tan((90+a)*Math.PI/360))/(Math.PI/180);return d=d*this.originShift/180,{x:c,y:d}},originLatLon:function(){return $.extend({},this.grid.originLatLon)},metersToLatLon:function(a,b){var c=a/this.originShift*180,d=b/this.originShift*180;return d=180/Math.PI*(2*Math.atan(Math.exp(d*Math.PI/180))-Math.PI/2),{lat:0!==a?d:0,lon:0!==b?c:0}},worldPositionToMeters:function(a,b){return{x:a*this.grid.scale+this.grid.originMeters.x,y:-b*this.grid.scale+this.grid.originMeters.y}},metersToWorldPosition:function(a,b){return new THREE.Vector3((a-this.grid.originMeters.x)/this.grid.scale,0,-((b-this.grid.originMeters.y)/this.grid.scale))},worldPositionToLatLon:function(a,b){"object"==typeof a&&"number"==typeof a.x&&"number"==typeof a.z&&(b=a.z,a=a.x);var c=this.worldPositionToMeters(a,b);return this.metersToLatLon(c.x,c.y)},latLonToWorldPosition:function(a,b){if("object"==typeof a&&"number"==typeof a.lat&&"number"==typeof a.lon&&(b=a.lon,a=a.lat),"number"!=typeof a||"number"!=typeof b)return void console.error("CRS: lat/lon not a number:",a,b);var c=this.latLonToMeters(a,b);return this.metersToWorldPosition(c.x,c.y)},pixelsToMeters:function(a,b,c){var d=this.resolution(c),e=a*d-this.originShift,f=b*d-this.originShift;return{x:e,y:f}},metersToPixels:function(a,b,c){var d=this.resolution(c),e=(a+this.originShift)/d,f=(b+this.originShift)/d;return{x:e,y:f}},pixelsToTile:function(a,b){var c=Math.ceil(a/this.tileSize)-1,d=Math.ceil(b/this.tileSize)-1;return{x:c,y:d}},pixelsToRaster:function(a,b,c){var d=this.tileSize<<c;return{x:a,y:d-b}},metersToTile:function(a,b,c){var d=this.metersToPixels(a,b,c);return this.pixelsToTile(d.x,d.y)},tileBounds:function(a,b,c){var d=this.pixelsToMeters(a*this.tileSize,b*this.tileSize,c),e=this.pixelsToMeters((a+1)*this.tileSize,(b+1)*this.tileSize,c);return{min:{x:d.x,y:d.y},max:{x:e.x,y:e.y}}},tileLatLonBounds:function(a,b,c){var d=this.tileBounds(a,b,c),e=this.metersToLatLon(d.min.x,d.min.y),f=this.metersToLatLon(d.max.x,d.max.y);return{min:{lat:e.lat,lon:e.lon},max:{lat:f.lat,
lon:f.lon}}},tileCenterMeters:function(a,b,c){var d=this.tileBounds(a,b,c);return new THREE.Vector2(.5*(d.max.x+d.min.x),.5*(d.max.y+d.min.y))},tileSizeMeters:function(a){var b=this.tileBounds(1,1,a);return new THREE.Vector2(b.max.x-b.min.x,b.max.y-b.min.y)},resolution:function(a){return this.initialResolution/Math.pow(2,a)},googleTile:function(a,b,c){return{x:a,y:Math.pow(2,c)-1-b}}}),IMeshmoonGeoService=Class.$extend({__init__:function(a,b){("string"!=typeof a||""===a)&&console.error("IMeshmoonGeoService constructor called without valid 'name'"),this.plugin=Tundra.plugins.meshmoonGeo,this.uuid=THREE.Math.generateUUID(),this.name=a||"Unknown IMeshmoonGeoService",this.log=TundraLogging.getLogger("GeoService."+this.name),this.timing=new AsyncHelper(this.name,this),this.running=!1,this.pending=[],this.active=[],this.features={},this.supportedFeatures={},this.defaultMaxRequests=Tundra.asset.maxActiveTransfers,this.options=$.extend(!0,{maxRequests:this.defaultMaxRequests},b),this.options.maxRequests<=0&&(this.options.maxRequests=1),this.maxRequests=this.options.maxRequests},__classvars__:{Zoom:{Min:0,Max:21},Type:{Buildings2D:"Buildings2D",Buildings3D:"Buildings3D",Properties2D:"Properties2D",TileTexture:"TileTexture",Terrain:"Terrain",Vegetation:"Vegetation"},Types:function(){var a=[];for(var b in this.Type)a.push(this.Type[b]);return a},Feature:{TileTexture:{Steets:"TileTexture_Streets",Satellite:"TileTexture_Satellite",Guiding:"TileTexture_Guiding",Properties:"TileTexture_Properties"}}},setMaxRequests:function(a){"number"==typeof a&&(this.maxRequests=a),this.maxRequests<=0&&(this.maxRequests=1)},_start:function(){this.running=!0,this.supportedFeatures={},this.start()},start:function(){},_gridStarted:function(a){this.gridStarted(a)},gridStarted:function(a){},_stop:function(){this.running=!1;for(var a=0;a<this.pending.length;a++)this.timing.cancel(this.pending[a].promiseId);this.pending=[];for(var a=0;a<this.active.length;a++)this.timing.cancel(this.active[a].promiseId);this.active=[],this.stop()},stop:function(){},cancelAll:function(a){for(var b=[].concat(this.pending,this.active),c=0;c<b.length;c++)"string"==typeof a?b[c].type===a&&this._cancelRequest(b[c]):this._cancelRequest(b[c]);"string"!=typeof a&&(0!==this.pending.length&&this.log.error("cancelAll: Failed to cancel all 'pending' requests:",this.pending.length),0!==this.active.length&&this.log.error("cancelAll: Failed to cancel all 'active' requests",this.active.length))},requestForPromise:function(a){for(var b=0;b<this.pending.length;b++)if(this.pending[b].promiseId===a)return this.pending[b];for(var b=0;b<this.active.length;b++)if(this.active[b].promiseId===a)return this.active[b];return void 0},_request:function(a,b,c,d){if(!this.running)return{promise:void 0,request:void 0};"object"!=typeof b.geoServiceRequests&&(b.geoServiceRequests={}),"object"!=typeof b.geoServiceRequests[this.uuid]&&(b.geoServiceRequests[this.uuid]={});var e=a+"."+b.uuid,f=new MeshmoonGeoServiceRequest(this,a,b,d);return f.promiseId=e,c.apply(this,[f]),f.isValid()?f.canceled===!0?{suppressed:!0}:b.geoServiceRequests[this.uuid][a]instanceof MeshmoonGeoServiceRequest&&f.isIdentical(b.geoServiceRequests[this.uuid][a])&&this.timing.hasDefer(e)?(delete f,f=void 0,{promise:this.timing.defer(e),request:b.geoServiceRequests[this.uuid][a]}):(b.geoServiceRequests[this.uuid][a]=f,this._queueRequest(f),{promise:this.timing.defer(e),request:f}):(delete f,{suppressed:!0})},_queueRequest:function(a){0===this.pending.length&&(this.timing.data.start=performance.now(),this.timing.data.requestPeak=0),this.timing.async("execute.requests",this._executeRequests,64),this._cancelRequest(a,!1),this.plugin.tracker.track(a),this.pending.push(a),this.pending.length>this.timing.data.requestPeak&&(this.timing.data.requestPeak=this.pending.length)},_cancelRequest:function(a,b){b="boolean"==typeof b?b:!0;for(var c=!1,d=this.pending.length-1;d>=0;d--)this.pending[d].uuid===a.uuid&&(this.pending.splice(d,1),c=!0);for(var d=this.active.length-1;d>=0;d--)this.active[d].uuid===a.uuid&&(this.active.splice(d,1),c=!0);c&&(a.canceled=!0,this._completeLoading(a,!1)),0===this.active.length&&this.timing.async("execute.requests",this._executeRequests,64)},_completeRequest:function(a,b,c){if(this.running){for(var d=!1,e=0;e<this.active.length;e++)if(this.active[e].promiseId===a.promiseId){this.active.splice(e,1),d=!0;break}if(this.timing.async("execute.requests",this._executeRequests),d){this._clearTileState(a.type,a.tile,!1),a.tile.isDestroyed()&&(b=!1);var f=b?this.plugin.loaderForRequest(a):void 0;b&&f?f.process(this,a,a.tile,c):this._completeLoading(a,b,c),0===this.pending.length&&0===this.active.length&&this.log.debug("Completed",this.timing.data.requestPeak,"requests in",((performance.now()-this.timing.data.start)/1e3).toFixed(2),"sec")}}},_completeLoading:function(a,b,c,d){this.running&&(this.plugin.tracker.remove(a),this.timing.resolve(a.promiseId,b,a,c,d))},minStationary:.25,_executeRequests:function(){if(this.plugin.grid.cameraStationaryTime<this.minStationary)return this.maxRequests=1,void this.timing.async("execute.requests",this._executeRequests,1e3*(this.minStationary-this.plugin.grid.cameraStationaryTime));this.maxRequests<this.options.maxRequests&&this.maxRequests++;performance.now();if(this.running&&!(this.active.length>=this.maxRequests)&&0!==this.pending.length){if(this.pending.sort(this._transferDistanceSorter),"number"==typeof this.plugin.config.maxDistance&&this.plugin.config.maxDistance>0)for(var a=this.pending.length-1;a>=0;a--)"number"==typeof this.pending[a].distanceFromFocus&&(this.pending[a].waiting=this.pending[a].distanceFromFocus>this.plugin.config.maxDistance,this.pending[a].waiting&&this.pending[a].tile.quadSelf.merging===!0&&(this.pending[a].waiting=!1));for(var b=this.maxRequests-this.active.length,c=0,d=0;b>d&&!(c>=this.pending.length);d++)if(this.pending[c].waiting!==!0){var e=this.pending.splice(c,1)[0];this.active.push(e),e.execute()}else c++,d--;0===this.active.length&&this.pending.length>0&&this.timing.async("execute.requests",this._executeRequests,1e3)}},_transferDistanceSorter:function(a,b){var c=a._updateDistanceFromFocus(),d=b._updateDistanceFromFocus();if(a.waiting===!0||b.waiting===!0){if(a.waiting&&!b.waiting)return 1;if(!a.waiting&&b.waiting)return-1}return"number"==typeof c&&"number"==typeof d?d>c?-1:1:a.distanceFromOrigin<b.distanceFromOrigin?-1:1},_clearTileState:function(a,b,c){c="boolean"==typeof c?c:!0,"object"==typeof b.geoServiceRequests&&"object"==typeof b.geoServiceRequests[this.uuid]&&void 0!==b.geoServiceRequests[this.uuid][a]&&(c&&this._cancelRequest(b.geoServiceRequests[this.uuid][a]),delete b.geoServiceRequests[this.uuid][a])},tileAboutToBeDestroyed:function(a,b,c){this.supportsBuildings2D()&&this._clearTileState(IMeshmoonGeoService.Type.Buildings2D,a),this.supportsBuildings3D()&&this._clearTileState(IMeshmoonGeoService.Type.Buildings3D,a),this.supportsTileTextures()&&this._clearTileState(IMeshmoonGeoService.Type.TileTexture,a)},setFeatureEnabled:function(a,b){("boolean"!=typeof this.features[a]||this.features[a]!==b)&&(this.features[a]=b,this.featureToggled(a,b))},isFeatureEnabled:function(a){var b=this.features[a];return"boolean"==typeof b&&b===!0},onSupportedFeaturesChanged:function(a,b,c){return Tundra.events.subscribe("Supported.Features.Changed."+this.name,a,b,c)},setFeatureSupported:function(a,b,c){a=Array.isArray(a)?a:[a],"boolean"!=typeof b&&this.log.error("setFeatureSupported:",a,"not a boolean",b);for(var d=0;d<a.length;d++)this.supportedFeatures[a[d]]=b;c!==!1&&(this.log.debug("Features",a,"supported:",b),Tundra.events.send("Supported.Features.Changed."+this.name,$.extend({},this.supportedFeatures)))},isFeatureSupported:function(a){var b=this.supportedFeatures[a];return"boolean"==typeof b&&b===!0},featureToggled:function(a,b){},shouldRequest:function(a,b){var c=b.zoomLevel.zoom;if("number"!=typeof c)return this.log.error("shouldRequest: Invalid tile 'zoomLevel', must be a number:",b.uuid,c),!1;var d=this.plugin.config,e=this.plugin.grid;if(a===IMeshmoonGeoService.Type.Buildings2D){if("boolean"==typeof d.buildings&&d.buildings===!1)return!1;for(var f=0;f<e.zoomLevels.length;f++)if(e.zoomLevels[f].zoom===c)return"boolean"!=typeof e.zoomLevels[f].buildings||e.zoomLevels[f].buildings===!0;return!1}return!0},request:function(a,b){return this.shouldRequest(a,b)?a===IMeshmoonGeoService.Type.Buildings2D?this.fetchBuildings2D(b):a===IMeshmoonGeoService.Type.Buildings3D?this.fetchBuildings3D(b):a===IMeshmoonGeoService.Type.Properties2D?this.fetchProperties2D(b):a===IMeshmoonGeoService.Type.TileTexture?this.fetchTileTexture(b):a===IMeshmoonGeoService.Type.Terrain?this.fetchTerrain(b):a===IMeshmoonGeoService.Type.Vegetation?this.fetchVegetation(b):(this.log.error("request: Unknown asset type:",a),{suppressed:!0}):{suppressed:!0}},requestLayer:function(a,b){return this._request(a.Id,b,this.constructLayerURL,a)},constructLayerURL:function(a){},supports:function(a){return a===IMeshmoonGeoService.Type.Buildings2D?this.supportsBuildings2D():a===IMeshmoonGeoService.Type.Buildings3D?this.supportsBuildings3D():a===IMeshmoonGeoService.Type.Properties2D?this.supportsProperties2D():a===IMeshmoonGeoService.Type.TileTexture?this.supportsTileTextures():a===IMeshmoonGeoService.Type.Terrain?this.supportsTerrain():a===IMeshmoonGeoService.Type.Vegetation?this.supportsVegetation():(this.log.error("supports: Unknown asset type:",a),!1)},fetchBuildings2D:function(a){return this._request(IMeshmoonGeoService.Type.Buildings2D,a,this.constructBuildings2DURL)},supportsBuildings2D:function(){return!1},constructProperties2DURL:function(a){},fetchProperties2D:function(a){return this._request(IMeshmoonGeoService.Type.Properties2D,a,this.constructProperties2DURL)},supportsProperties2D:function(){return!1},constructBuildings2DURL:function(a){},fetchBuildings3D:function(a){return this._request(IMeshmoonGeoService.Type.Buildings3D,a,this.constructBuildings3DURL)},supportsBuildings3D:function(){return!1},constructBuildings3DURL:function(a){},fetchTileTexture:function(a){return this._request(IMeshmoonGeoService.Type.TileTexture,a,this.constructTileTextureURL)},supportsTileTextures:function(){return!1},maximumTileTextureZoomLevel:function(){return void 0},constructTileTextureURL:function(a){},fetchTerrain:function(a){return this._request(IMeshmoonGeoService.Type.Terrain,a,this.constructTerrainURL)},fetchVegetation:function(a){return this._request(IMeshmoonGeoService.Type.Vegetation,a,this.constructVegetationURL)},supportsTerrain:function(){return!1},supportsVegetation:function(){return!1},constructTerrainURL:function(a){},constructVegetationURL:function(a){}}),MeshmoonGeoServiceRequest=Class.$extend({__init__:function(a,b,c,d){this.log=TundraLogging.getLogger(a.log.name+".Request"),this.id=MeshmoonGeoServiceRequest.RequestId(b),this.uuid=THREE.Math.generateUUID(),this.type=b,this.service=a,this.error=void 0,this.canceled=!1,this.waiting=!1,this.tile=c,this.bbox=c.getBoundingBoxLatLon(),this.bboxArray=c.getBoundingBoxLatLonArray(),this.distanceFromOrigin=c.getDistanceFromOrigin(),this.distanceFromFocus=c.getDistanceFromFocus(),this.data=d,this.url=void 0,this.assetType=void 0},__classvars__:{Ids:{},RequestId:function(a){return"number"!=typeof this.Ids[a]&&(this.Ids[a]=0),++this.Ids[a]}},_updateDistanceFromFocus:function(){var a=this.tile.getDistanceFromFocus();return"number"==typeof a&&(this.distanceFromFocus=a),this.distanceFromFocus},isValid:function(){return"string"==typeof this.url&&""!==this.url},isIdentical:function(a){return this.service.uuid===a.service.uuid&&this.tile.uuid===a.tile.uuid&&this.type===a.type&&this.url===a.url&&this.assetType===a.assetType},uniqueLayerId:function(){return"object"==typeof this.data&&"string"==typeof this.data.Endpoint?this.tile.id+"_"+this.data.Endpoint+"_"+this.data.Id:void 0},execute:function(){return this.isValid()?(this.transfer=Tundra.asset.requestAsset(this.url,this.assetType),void(this.transfer?(this.transfer.onCompleted(this,this.onTransferCompleted),this.transfer.onFailed(this,this.onTransferFailed)):AsyncHelper.async(this.onTransferFailed.bind(this)))):(this.log.error("'url' is not defined",this),void AsyncHelper.async(this.onTransferFailed.bind(this)))},cancel:function(){this.canceled=!0,this.service._cancelRequest(this),void 0!==this.transfer&&"function"==typeof this.transfer.abort&&this.transfer.abort(),this.transfer=void 0},onTransferCompleted:function(a){this.service._completeRequest(this,!0,a),this.canceled&&a&&"function"==typeof a.unload&&a.unload(),this.transfer=void 0},onTransferFailed:function(){this.service._completeRequest(this,!1),this.transfer=void 0}}),MeshmoonGeoShaders={DefaultFogColor:new THREE.Color(247/255,245/255,242/255),Sky:{uniforms:THREE.UniformsUtils.merge([{cubeMap:{type:"t",value:null},horizonColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)}}]),perPixel:!0,textureIndexes:["cubeMap"],vertexShader:[THREE.ShaderChunk.logdepthbuf_pars_vertex,"varying vec3 oCubeUv;","varying float oYCoord;","void main()","{","   gl_Position = (modelMatrix * vec4(position, 1));","   oYCoord = position.y;","   oCubeUv = normalize(position);",THREE.ShaderChunk.logdepthbuf_vertex,"}"].join("\n"),fragmentShader:[THREE.ShaderChunk.logdepthbuf_pars_fragment,"uniform samplerCube cubeMap;","uniform vec4 horizonColor;","varying vec3 oCubeUv;","varying float oYCoord;","void main()","{","   float fade = clamp(oYCoord, 0.0, 3.0) / 3.0;","   gl_FragColor = mix(horizonColor, textureCube(cubeMap, oCubeUv), fade);",THREE.ShaderChunk.logdepthbuf_fragment,"}"].join("\n")},Tile:{uniforms:THREE.UniformsUtils.merge([{diffuseMap:{type:"t",value:null},fogColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},lightDirection:{type:"v3",value:new THREE.Vector3(1,1,0)},lightColor:{type:"v4",value:new THREE.Vector4(1,1,1,1)},layerMap0:{type:"t",value:null},layerMap1:{type:"t",value:null},layerMap2:{type:"t",value:null},layerMap3:{type:"t",value:null},layerOpacity:{type:"v4",value:new THREE.Vector4(0,0,0,0)}}]),defines:{LAYER_0:0,LAYER_1:0,LAYER_2:0,LAYER_3:0},perPixel:!0,textureIndexes:["diffuseMap"],vertexShader:[THREE.ShaderChunk.logdepthbuf_pars_vertex,"varying vec2 oTexCoord0;","varying vec3 oWorldPosition;","varying vec3 oNormal;","void main()","{","   gl_Position = ((projectionMatrix * modelViewMatrix) * vec4(position, 1));","   oWorldPosition = (modelMatrix * vec4(position, 1)).xyz;","   oNormal = normalize((modelMatrix * vec4(normal, 0)).xyz);","   oTexCoord0.xy = uv;",THREE.ShaderChunk.logdepthbuf_vertex,"}"].join("\n"),fragmentShader:[THREE.ShaderChunk.logdepthbuf_pars_fragment,"uniform sampler2D diffuseMap;","uniform vec4 fogColor;","","uniform vec3 cameraFocusPosition;","uniform vec3 cameraForward;","","uniform float fogStartDistance;","uniform float fogEndDistance;","","uniform vec3 lightDirection;","uniform vec4 lightColor;","","varying vec2 oTexCoord0;","varying vec3 oWorldPosition;","varying vec3 oNormal;","","#if LAYER_0","uniform sampler2D layerMap0;","#endif","#if LAYER_1","uniform sampler2D layerMap1;","#endif","#if LAYER_2","uniform sampler2D layerMap2;","#endif","#if LAYER_3","uniform sampler2D layerMap3;","#endif","uniform vec4 layerOpacity;","","float ComputeLightBlinnPhongSpecularFactor(vec3 normal, vec3 lightDir, vec3 viewDir, float NdotL)","{","    // Half vector","    vec3 H = normalize(lightDir + viewDir);","","    //Intensity of the specular light","    float NdotH = clamp(dot(normal, H), 0.0, 1.0);","","    //Sum up the specular light factoring","    return pow(NdotH, 20.0) * clamp(NdotL * 4.0, 0.0, 1.0);","}","","void main()","{","   float distance = length(oWorldPosition - cameraFocusPosition.xyz);","   float fog = 1.0 - clamp((distance - fogStartDistance) / (fogEndDistance - fogStartDistance), 0.0, 1.0);","","   float nDotL = clamp(dot(oNormal, vec3(-1.0, 0.0, 0.0)), 0.0, 1.0);","   vec4 diffuseColor = texture2D(diffuseMap, oTexCoord0);","","#if LAYER_0","   diffuseColor *= mix(vec4(1,1,1,1), texture2D(layerMap0, oTexCoord0), clamp(layerOpacity.x, 0.0, 1.0));","#endif","","#if LAYER_1","   diffuseColor *= mix(vec4(1,1,1,1), texture2D(layerMap1, oTexCoord0), clamp(layerOpacity.y, 0.0, 1.0));","#endif","","#if LAYER_2","   diffuseColor *= mix(vec4(1,1,1,1), texture2D(layerMap2, oTexCoord0), clamp(layerOpacity.z, 0.0, 1.0));","#endif","","#if LAYER_3","   diffuseColor *= mix(vec4(1,1,1,1), texture2D(layerMap3, oTexCoord0), clamp(layerOpacity.w, 0.0, 1.0));","#endif","","   diffuseColor = mix(fogColor, diffuseColor * (vec4(0.9, 0.9, 0.9, 1) * (1.0 - nDotL)), fog);","","   vec3 viewDirection = normalize(cameraPosition.xyz - oWorldPosition.xyz);","","   vec3 specularDirection = normalize(reflect(cameraForward, vec3(0, 1, 0)));","","   float vDotL = clamp(dot(specularDirection, vec3(0, 1, 0)), 0.0, 1.0);","   float specular = ComputeLightBlinnPhongSpecularFactor(oNormal, specularDirection, viewDirection, 1.0);","","   float spec = clamp(1.0 - nDotL, 0.0, 0.21);","   vec4 specularColor = (specular * vec4(spec, spec, spec, 1) * 0.5);","   gl_FragColor = diffuseColor + (specularColor * fog);","",THREE.ShaderChunk.logdepthbuf_fragment,"}"].join("\n")},Buildings:{uniforms:{heightMap:{type:"t",value:null},bounds:{type:"v4",value:new THREE.Vector4(0,0,0,0)},heightLimits:{type:"v2",value:new THREE.Vector2(0,0)},mouseposition:{type:"v3",value:new THREE.Vector3(0,0,0)},ambientColor:{type:"c",value:new THREE.Color(0,0,0)},animScaleUp:{type:"f",value:0},animScaleBlast:{type:"f",value:0},radiusMultiplier:{type:"f",value:1}},vertexShader:[THREE.ShaderChunk.logdepthbuf_pars_vertex,"varying vec3 vNormal;","","uniform sampler2D heightMap;","uniform vec4 bounds;","uniform vec2 heightLimits;","","uniform vec3 mouseposition;","uniform float animScaleUp;","uniform float animScaleBlast;","","//Effect radius (1.0 / x meters)","uniform float radiusMultiplier;","varying vec2 texCoord;","varying float buildingHeight;","","vec2 WorldPositionToTexCoord(float worldX, float worldZ)","{","   vec2 pos = vec2(worldX, worldZ) - bounds.xy;","   return vec2(","       pos.x / bounds.z,","       pos.y / bounds.w","   );","}","","float DecodeRGBA(vec4 value)","{","   return dot(value, vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0));","}","","void main()","{","   vec3 lpos = position;","   vec4 worldPosition = modelMatrix * vec4(position, 1.0);","   texCoord = WorldPositionToTexCoord(worldPosition.x, worldPosition.z);","   float height = DecodeRGBA(texture2D(heightMap, texCoord));","   buildingHeight = height;","","   //element pivot point stored in UV-coordinates (u = x,v = z)","   vec4 pivot = modelMatrix * vec4(uv.x, 0.0, uv.y, 1.0);","   float dstpivot = distance(pivot.xyz, mouseposition.xyz) * radiusMultiplier;","   float blast = distance(worldPosition.xyz, mouseposition.xyz) * animScaleBlast;","   float thickness = 0.035;","   float offset = 0.030;","   float blastmaskout = smoothstep(0.15, 0.79, blast - offset);","   float blastmaskin = smoothstep(0.79 + thickness, 0.8 + thickness, blast - offset);","   float fmask = blastmaskout-blastmaskin;","   float mask = smoothstep(animScaleUp * 0.6, animScaleUp * 0.95, dstpivot);","","   lpos.y = lpos.y + mix(heightLimits.x, heightLimits.y, height);// + (position.y + position.y * clamp(fmask, 0.0, 1.0) * 4.0);","   float buildingmask = clamp((1.0 - dstpivot - 0.25) * 6.0, 0.0, 1.0);","","   gl_Position = projectionMatrix * modelViewMatrix * vec4(lpos, 1.0);","","   vNormal = normal;",THREE.ShaderChunk.logdepthbuf_vertex,"}"].join("\n"),fragmentShader:[THREE.ShaderChunk.logdepthbuf_pars_fragment,"varying vec3 vNormal;","varying vec3 vGradientCol;","varying vec4 worldpos;","varying float vMask; //building pivot mask","varying vec2 texCoord;","varying float buildingHeight;","","uniform vec3 mouseposition;","uniform vec3 ambientColor;","uniform vec3 litColor;","uniform vec3 shadowColor;","uniform float radiusMultiplier;","","void main()","{","   //Replace this with proper THREE.js lighting shader code","   vec3 lightDir = normalize(vec3(1.0, 0.5, 0.25));","   float lDotN = clamp(dot(lightDir, vNormal), 0.0, 1.0);","","   gl_FragColor = vec4(ambientColor + lDotN * 0.25, 1.0);",THREE.ShaderChunk.logdepthbuf_fragment,"}"].join("\n")},Vegetation:{uniforms:{diffuseMap:{type:"t",value:null},bounds:{type:"v4",value:new THREE.Vector4(0,0,0,0)},spacing:{type:"f",value:2.5},screenHeight:{type:"f",value:0},fov:{type:"f",value:0},geoOpacity:{type:"f",value:.5}},vertexShader:[THREE.ShaderChunk.logdepthbuf_pars_vertex,"uniform vec4 bounds;","uniform float spacing;","uniform float screenHeight;","uniform float fov;","varying vec2 uvCoord;","","vec2 WorldPositionToTexCoord(float worldX, float worldZ)","{","   vec2 pos = vec2(worldX, worldZ) - bounds.xy;","   return vec2(","       pos.x / bounds.z,","       pos.y / bounds.w","   );","}","","void main()","{","   vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","   gl_Position = projectionMatrix * mvPosition;","","   vec4 worldPosition = modelMatrix * vec4(position, 1.0);","   uvCoord = WorldPositionToTexCoord(worldPosition.x, worldPosition.z);","","   float radius = spacing * 1.5;","   gl_PointSize = (1.0 / tan(fov/2.0)) * radius / (-mvPosition.z);","   gl_PointSize = gl_PointSize * screenHeight / 2.0;",THREE.ShaderChunk.logdepthbuf_vertex,"}"].join("\n"),fragmentShader:[THREE.ShaderChunk.logdepthbuf_pars_fragment,"uniform sampler2D diffuseMap;","uniform float geoOpacity;","varying vec2 uvCoord;","","void main()","{","   float a = pow(2.0 * (gl_PointCoord.x - 0.5), 2.0);","   float b = pow(2.0 * (gl_PointCoord.y - 0.5), 2.0);","   float c = 1.0 - (a + b);","   if (c < 0.0) {","       discard;","   }","   gl_FragColor = texture2D(diffuseMap, uvCoord);","   gl_FragColor.a = geoOpacity;",THREE.ShaderChunk.logdepthbuf_fragment,"}"].join("\n")},LayerFeature:{uniforms:{heightMap:{type:"t",value:null},bounds:{type:"v4",value:new THREE.Vector4(0,0,0,0)},heightLimits:{type:"v2",value:new THREE.Vector2(0,0)},ambientColor:{type:"c",value:new THREE.Color(0,0,0)},geoOpacity:{type:"f",value:.5}},vertexShader:[THREE.ShaderChunk.logdepthbuf_pars_vertex,"varying vec3 vNormal;","varying vec2 texCoord;","","uniform sampler2D heightMap;","uniform vec4 bounds;","uniform vec2 heightLimits;","","vec2 WorldPositionToTexCoord(float worldX, float worldZ)","{","   vec2 pos = vec2(worldX, worldZ) - bounds.xy;","   return vec2(","       pos.x / bounds.z,","       pos.y / bounds.w","   );","}","","float DecodeRGBA(vec4 value)","{","   return dot(value, vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0));","}","","void main()","{","   vec3 lpos = position;","   vec4 worldPosition = modelMatrix * vec4(position, 1.0);","   texCoord = WorldPositionToTexCoord(worldPosition.x, worldPosition.z);","   float height = DecodeRGBA(texture2D(heightMap, texCoord));","","   lpos.y = lpos.y + mix(heightLimits.x, heightLimits.y, height);","   gl_Position = projectionMatrix * modelViewMatrix * vec4(lpos, 1.0);","","   vNormal = normal;",THREE.ShaderChunk.logdepthbuf_vertex,"}"].join("\n"),fragmentShader:[THREE.ShaderChunk.logdepthbuf_pars_fragment,"varying vec3 vNormal;","varying vec2 texCoord;","","uniform vec3 ambientColor;","uniform float geoOpacity;","","void main()","{","   // Replace this with proper THREE.js lighting shader code","   vec3 lightDir = normalize(vec3(1.0, 0.5, 0.25));","   float lDotN = clamp(dot(lightDir, vNormal), 0.0, 1.0);","","   gl_FragColor = vec4(ambientColor + lDotN * 0.25, 1.0);","   gl_FragColor.a = geoOpacity;",THREE.ShaderChunk.logdepthbuf_fragment,"}"].join("\n")}},MeshmoonGeoTile=Class.$extend({__init__:function(a,b,c,d){this.id="MeshmoonGeoTile."+b+"."+c+"."+d.zoom,this.uuid=THREE.Math.generateUUID(),this.grid=a,this.quadSelf=void 0,this.quad=void 0,this.focus=!1,this.loadingAssets=!1,this.x=b,this.y=c,this.visible=!0,this.zoomLevel=d,this.center=this.grid.crs.tileCenterMeters(this.x,this.y,this.zoomLevel.zoom),this.centerLatLon=this.grid.crs.metersToLatLon(this.center.x,this.center.y),this.bounds=this.grid.crs.tileBounds(this.x,this.y,this.zoomLevel.zoom),this.boundsLatLon=this.grid.crs.tileLatLonBounds(this.x,this.y,this.zoomLevel.zoom);var e=this.grid.crs.latLonToWorldPosition(this.boundsLatLon.min.lat,this.boundsLatLon.min.lon),f=this.grid.crs.latLonToWorldPosition(this.boundsLatLon.max.lat,this.boundsLatLon.max.lon);this.boundsWorld={min:{x:e.x,z:e.z},max:{x:f.x,z:f.z}},this.googleTile=this.grid.crs.googleTile(this.x,this.y,this.zoomLevel.zoom),this.tileSize=this.grid.crs.tileSizeMeters(this.zoomLevel.zoom),this.scale={},this.scale.x=this.tileSize.x/this.grid.scale,this.scale.z=this.tileSize.y/this.grid.scale,this.relativePosition={x:(this.bounds.min.x-this.grid.originMeters.x)/this.grid.scale,y:0,z:-(this.bounds.min.y-this.grid.originMeters.y+this.tileSize.y)/this.grid.scale},this.relativeCenter={x:(this.center.x-this.grid.originMeters.x)/this.grid.scale,y:0,z:-((this.center.y-this.grid.originMeters.y)/this.grid.scale)}},__classvars__:{SHADOWS:!1,PHONG:!1,Spent:{heightmaps:0}},setDebugEnabled:function(a){a.debug===!0?(this.createDebugMesh(),this.debugCube&&(this.debugCube.visible=this.visible),this.buildings&&this.buildings.material&&this.buildings.material.uniforms.ambientColor&&this.buildings.material.uniforms.ambientColor.value.setStyle(this.grid.getDebugMaterialColor(this.zoomLevel.zoom,!1))):this._destroyDebugging()},setFocus:function(a){this.grid&&(this.focus=a===!0,void 0!==this.debugCube&&(this.grid.plugin.config.debugVolume===!0?this.debugCube.scale.z=this.debugCube.scale.x=a?.25*this.scale.x:this.scale.x:this.debugCube.visible=!a))},contains:function(a){return a.x<this.boundsWorld.min.x||a.x>this.boundsWorld.max.x||a.z>this.boundsWorld.min.z||a.z<this.boundsWorld.max.z?!1:!0},createDebugMesh:function(){if(void 0===this.debugCube&&this.grid){var a=this.grid.plugin.config.debugVolume===!0;this.grid.createDebugGeometries(),this.debugCube=new THREE.Mesh(this.grid.debugCubeGeometry,this.grid.getDebugMaterial(this.zoomLevel.zoom,!0)),this.debugCube.renderDepth=10*this.zoomLevel.zoom;({x:(this.center.x-this.grid.originMeters.x)/this.grid.scale,y:(this.center.y-this.grid.originMeters.y)/this.grid.scale});this.debugCube.position.x=this.relativeCenter.x,this.debugCube.position.z=this.relativeCenter.z,this.debugCube.scale.x=this.scale.x,this.debugCube.scale.z=this.scale.z,a&&(this.debugCube.position.y=this.scale.x/2,this.debugCube.scale.y=this.scale.x),this.debugBoxHelper=new THREE.BoxHelper(this.debugCube),this.debugBoxHelper.renderDepth=this.debugCube.renderDepth,this.debugBoxHelper.material.color=this.debugCube.material.color,this.debugBoxHelper.material.depthTest=!1,Tundra.renderer.scene.add(this.debugCube),Tundra.renderer.scene.add(this.debugBoxHelper),this.setFocus(this.focus)}},destroy:function(){this.setVisible(!1),Tundra.plugins.meshmoonGeo.tileAboutToBeDestroyed(this),this._destroyMeshTerrain(),this._destroyMeshTerrainMaterial(),this._destroyVegetation(),this._destroyPlaneTerrain(),this._destroyPlaneTerrainMaterial(),this._destroyBuildings(),this._destroyLayerFeatures(),this._destroyProperties(),this._destroyDebugging(),this.grid=void 0},isDestroyed:function(){return void 0===this.grid},_created:function(a){a&&a.geometry&&"string"==typeof a.uuid&&Tundra.renderer.onSceneMeshCreated({id:this.uuid},{id:a.uuid},a)},_dispose:function(a,b){if(a){b=$.extend({unparent:!0,geometry:!0,textures:!0,assetapi:!0},b);try{if(b.unparent&&a.parent&&("function"==typeof a.parent.remove?a.parent.remove(a):Tundra.renderer.scene.remove(this.buildings)),a.geometry&&"string"==typeof a.uuid)Tundra.renderer.onSceneMeshUnloaded({id:this.uuid},{id:a.uuid},a);else if(Array.isArray(a.children))for(var c=0;c<a.children.length;c++){var d=a.children[c];d&&d.geometry&&"string"==typeof d.uuid&&Tundra.renderer.onSceneMeshUnloaded({id:this.uuid},{id:d.uuid},d)}"function"==typeof a.dispose&&a.dispose(),b.geometry&&a.geometry&&"function"==typeof a.geometry.dispose&&a.geometry.dispose(),b.textures&&a.map&&"function"==typeof a.map.dispose&&a.map.dispose(),b.assetapi&&a instanceof IAsset&&Tundra.asset.forgetAsset(a)}catch(e){console.error("_dispose:",e)}}},_destroyBuildings:function(){void 0!==this.buildings&&(this.grid&&this.buildings.material&&this.grid.buildingShader.removeMaterial(this.buildings.material),this.buildings.material&&"function"==typeof this.buildings.material.dispose&&this.buildings.material.dispose(),this.buildings.material=void 0,this._clearBuildingTracking({properties:!1}),this._dispose(this.buildings),delete this.buildings,this.buildings=void 0,Tundra.plugins.meshmoonGeo.metadata.remove(this,IMeshmoonGeoService.Type.Buildings2D))},_destroyLayerFeatures:function(a){if("object"==typeof this.layerFeatures)if("string"==typeof a){var b=this.layerFeatures[a];b&&b.asset&&this._dispose(b.asset),b&&b.layer&&Tundra.plugins.meshmoonGeo.metadata.remove(this,b.layer.Id),delete this.layerFeatures[a]}else{for(var c=Object.keys(this.layerFeatures),d=0;d<c.length;d++){var b=this.layerFeatures[c[d]];b&&b.asset&&this._dispose(b.asset),b&&b.layer&&Tundra.plugins.meshmoonGeo.metadata.remove(this,b.layer.Id),delete this.layerFeatures[c[d]]}this.layerFeatures=void 0}},_destroyProperties:function(){void 0!==this.properties&&(this._clearBuildingTracking({buildings:!1}),this._dispose(this.properties),delete this.properties,this.properties=void 0)},_clearBuildingTracking:function(a){this.grid&&(a=$.extend({},{buildings:!0,properties:!0}),this.buildings&&"string"==typeof this.buildings.buildingsId&&this.grid.plugin.tracker.removeBuildings(this.buildings.buildingsId),this.properties&&"string"==typeof this.properties.propertiesId&&this.grid.plugin.tracker.removeBuildings(this.properties.propertiesId))},_destroyMeshTerrain:function(){if(this.terrainMesh&&(this._dispose(this.terrainMesh,{geometry:!1}),this.terrainMesh=void 0),this.terrainMME&&(this.terrainMME.canReuse=!0,this.terrainMME=void 0),this.terrainHeightMapData){this._dispose(this.terrainHeightMapData.texture);try{this.buildings&&this.buildings.material&&(this.buildings.material.uniforms.heightMap.value=null)}catch(a){console.error(a)}this.terrainHeightMapData=void 0}},_destroyVegetation:function(){this.vegetationPointCloud&&(this._dispose(this.vegetationPointCloud,{geometry:!1}),this.vegetationPointCloud=void 0),this.vegetationMME&&(this.vegetationMME.canReuse=!0,this.vegetationMME=void 0)},_destroyVegetationMaterial:function(){void 0!==this.vegetationMaterial&&(this._dispose(this.vegetationMaterial),delete this.vegetationMaterial,this.vegetationMaterial=void 0)},_destroyMeshTerrainMaterial:function(){void 0!==this.terrainMaterial&&(this._dispose(this.terrainMaterial),delete this.terrainMaterial,this.terrainMaterial=void 0)},_destroyPlaneTerrain:function(){void 0!==this.tilePlane&&(this._dispose(this.tilePlane,{geometry:!1}),delete this.tilePlane,this.tilePlane=void 0)},_destroyPlaneTerrainMaterial:function(){void 0!==this.tileMaterial&&(this._dispose(this.tileMaterial),delete this.tileMaterial,this.tileMaterial=void 0)},_destroyDebugging:function(){this.debugBoxHelper&&(this._dispose(this.debugBoxHelper),delete this.debugBoxHelper,this.debugBoxHelper=void 0),this.debugCube&&(this._dispose(this.debugCube,{geometry:!1}),delete this.debugCube,this.debugCube=void 0),this.buildings&&this.buildings.material&&this.buildings.material.uniforms.ambientColor&&this.buildings.material.uniforms.ambientColor.value.copy(this.grid.buildingShader.ambientColorDefault)},getCenterLatLon:function(){return this.grid?this.grid.crs.metersToLatLon(this.center.x,this.center.y):void 0},getCenterWorldPosition:function(){if(!this.grid)return void 0;var a=this.getCenterLatLon();return this.grid.crs.latLonToWorldPosition(a.lat,a.lon)},getBoundingBoxWorld:function(){return $.extend(!0,{},this["this"].boundsWorld)},getBoundingBoxLatLon:function(){return $.extend(!0,{},this.boundsLatLon)},getBoundingBoxLatLonArray:function(){return[this.boundsLatLon.min.lat,this.boundsLatLon.min.lon,this.boundsLatLon.max.lat,this.boundsLatLon.max.lon]},getDistanceFromOrigin:function(){
return this.grid?this.center.distanceTo(this.grid.originMeters):void 0},getDistanceFromFocus:function(){return this.grid&&this.grid.focusedTile?this.center.distanceTo(this.grid.focusedTile.center):void 0},visibleParentTile:function(a){return a="boolean"==typeof a?a:!0,this.tile?!a&&this.tile&&this.tile.visible===!0?this:this.quad&&this.quad.tile&&this.quad.tile.uuid!==this.uuid?this.quad.tile.visibleParentTile(!1):void 0:void 0},parentTileWithZoomLevel:function(a,b){return b="boolean"==typeof b?b:!0,a>this.zoomLevel.zoom?void console.error("parentTileWithZoomLevel: Cannot find parent tile with bigger zoom from this level",this.zoomLevel.zoom):b||this.zoomLevel.zoom!==a?this.quad&&this.quad.tile&&this.quad.tile.uuid!==this.uuid?this.quad.tile.parentTileWithZoomLevel(a,!1):void 0:this},parentTileWithBuildings:function(a){return a="boolean"==typeof a?a:!0,!a&&this.isBuildingsMeshVisible()?this:this.quad&&this.quad.tile&&this.quad.tile.uuid!==this.uuid?this.quad.tile.parentTileWithBuildings(!1):void 0},show:function(){this.setVisible(!0)},hide:function(){this.setVisible(!1)},setVisible:function(a){this.grid&&(this.visible=a===!0,this.grid.debug&&this.visible&&!this.debugCube&&this.createDebugMesh(),this.debugCube&&(this.debugCube.visible=this.visible),this.buildings&&(this.buildings.visible=this.visible),this.tilePlane&&(this.tilePlane.visible=this.visible),this.properties&&(this.properties.visible=this.visible),this.updateTileTerrainVisibility(),this.updateVegetationVisibility(),this.visible||this.setFocus(!1))},isAtMaxZoom:function(){return"boolean"==typeof this._visibilityWithZoomConstraint&&this._visibilityWithZoomConstraint===!0?!0:"number"==typeof this.quadSelf.maxZoomValue&&this.zoomLevel.zoom>this.quadSelf.maxZoomValue},isTileMeshVisible:function(){return this.tilePlane?this.tilePlane.visible:!1},isBuildingsMeshVisible:function(){return this.buildings?this.buildings.visible:!1},isTerrainMeshVisible:function(){return this.terrainMesh?this.terrainMesh.visible:!1},isVegerationMeshVisible:function(){return this.vegetationPointCloud?this.vegetationPointCloud.visible:!1},prepareUniforms:function(a,b){var c=THREE.UniformsUtils.clone(a.uniforms);return c.cameraFocusPosition=this.grid.cameraFocusPositionUniform,c.cameraForward=this.grid.cameraForwardUniform,c.fogStartDistance=this.grid.fogStartDistanceUniform,c.fogEndDistance=this.grid.fogEndDistanceUniform,b&&c.diffuseMap&&(c.diffuseMap.value=b),c.fogColor&&c.fogColor.value.set(MeshmoonGeoShaders.DefaultFogColor.r,MeshmoonGeoShaders.DefaultFogColor.g,MeshmoonGeoShaders.DefaultFogColor.b,1),c},numLoadedTextures:function(){var a=0;return this.tileMaterial&&this.tileMaterial.hasDiffuse()&&a++,a+this.numValidLayerTextures()},numValidLayerTextures:function(){if(!Array.isArray(this.layerTextures))return 0;for(var a=0,b=0;b<this.layerTextures.length;b++){var c=this.layerTextures[b];c&&c.asset&&c.asset.isLoaded()&&a++}return a},updateUniforms:function(a,b){var c=a.uniforms;if(c){if(b=$.extend({textures:!0,opacity:!0},b),b.textures){for(var d=this.numValidLayerTextures(),e=!1,f=0;4>f;f++){var g="LAYER_"+f,h=d>f?1:0;"number"==typeof a.defines[g]?(e||a.defines[g]===h||(e=!0),a.defines[g]=h):console.error("Failed to find define for",g)}if(!a.needsUpdate&&e&&(a.needsUpdate=e),Array.isArray(this.layerTextures))for(var f=0;f<this.layerTextures.length;f++){var i=this.layerTextures[f];if(i&&i.asset&&i.asset.isLoaded()){var g="layerMap"+f,j=c[g]?c[g].value:void 0;!c[g]||j&&j.uuid===i.asset.texture.uuid||(c[g].value=i.asset.texture)}}}if(b.opacity&&c.layerOpacity){if(void 0===this._opacityVec4&&(this._opacityVec4=new THREE.Vector4),this._opacityVec4.set(0,0,0,0),Array.isArray(this.layerTextures))for(var f=0;f<this.layerTextures.length;f++){var i=this.layerTextures[f];i&&i.layer&&"number"==typeof i.layer.geoMapLayerOpacity&&(0===f?this._opacityVec4.x=i.layer.geoMapLayerOpacity/100:1===f?this._opacityVec4.y=i.layer.geoMapLayerOpacity/100:2===f?this._opacityVec4.z=i.layer.geoMapLayerOpacity/100:3===f&&(this._opacityVec4.w=i.layer.geoMapLayerOpacity/100))}c.layerOpacity.value.copy(this._opacityVec4)}}},updateTileMaterialLayers:function(a){void 0!==this.tileMaterial&&this.updateUniforms(this.tileMaterial,a),void 0!==this.terrainMaterial&&this.updateUniforms(this.terrainMaterial,a)},updateTileMaterial:function(a){if(!a||a.wrapS===THREE.ClampToEdgeWrapping&&a.wrapT===THREE.ClampToEdgeWrapping||(a.wrapS=THREE.ClampToEdgeWrapping,a.wrapT=THREE.ClampToEdgeWrapping,a.needsUpdate=!0),void 0===this.tileMaterial){var b=MeshmoonGeoShaders.Tile,c=this.prepareUniforms(b,RocketShaderLibrary.getSolidColorTexture(247,245,242,255));this.tileMaterial=new THREE.ShaderMaterial({fragmentShader:b.fragmentShader,vertexShader:b.vertexShader,defines:$.extend({},b.defines),uniforms:c,depthTest:!1})}if(void 0===this.terrainMaterial){var b=MeshmoonGeoShaders.Tile,c=this.prepareUniforms(b,RocketShaderLibrary.getSolidColorTexture(247,245,242,255));this.terrainMaterial=new THREE.ShaderMaterial({fragmentShader:b.fragmentShader,vertexShader:b.vertexShader,defines:$.extend({},b.defines),uniforms:c})}if("function"!=typeof this.tileMaterial.hasDiffuse||"function"!=typeof this.terrainMaterial.hasDiffuse){var d=function(){return this.uniforms&&this.uniforms.diffuseMap&&this.uniforms.diffuseMap.value&&0!==this.uniforms.diffuseMap.value.name.indexOf("RocketShaderLibrary.")};this.tileMaterial.hasDiffuse=d.bind(this.tileMaterial),this.terrainMaterial.hasDiffuse=d.bind(this.terrainMaterial)}if(a){var e=function(b){if(b instanceof THREE.ShaderMaterial){var c=b.uniforms.diffuseMap;c?c.value&&c.value.uuid===a.uuid||(c.value&&"function"==typeof c.value.dispose&&(c.value.dispose(),c.value=null),c.value=a,b.needsUpdate=!0):console.error("updateTileMaterial: ShaderMaterial does not have 'diffuseMap' uniform:",b)}else b instanceof THREE.MeshPhongMaterial&&(b.map&&b.map.uuid===a.uuid||(b.map&&"function"==typeof b.map.dispose&&(b.map.dispose(),b.map=null),b.map=a,b.needsUpdate=!0))};e(this.tileMaterial),e(this.terrainMaterial),this.updateTileMaterialLayers(),this.updateVegetationTexture(a)}},updateVegetationTexture:function(a){this.vegetationMaterial&&(this.vegetationMaterial.uniforms.diffuseMap.value=this.satelliteEnabled?a:this.grid.vegetationDefaultTexture)},_isTerrainMeshTextureLoaded:function(){return this.terrainMaterial&&this.terrainMaterial.uniforms&&this.terrainMaterial.uniforms.diffuseMap&&this.terrainMaterial.uniforms.diffuseMap.value&&0!==this.terrainMaterial.uniforms.diffuseMap.value.name.indexOf("RocketShaderLibrary.")},updateTilePlane:function(){void 0===this.tilePlane&&(void 0===this.tileMaterial&&this.updateTileMaterial(),this.tilePlane=new THREE.Mesh(this.grid.tileGeometry,this.tileMaterial),this._created(this.tilePlane),MeshmoonGeoTile.SHADOWS&&(this.tilePlane.receiveShadow=!0),this.visible&&this.grid.debug&&this.createDebugMesh()),this.tilePlane.position.x=this.relativePosition.x,this.tilePlane.position.z=this.relativePosition.z,this.tilePlane.scale.x=this.scale.x,this.tilePlane.scale.z=this.scale.z,this.tilePlane.visible=this.visible,this.tilePlane.renderDepth=-1e4+10*this.zoomLevel.zoom,void 0===this.tilePlane.parent&&Tundra.renderer.scene.add(this.tilePlane)},updateTileTerrain:function(a){if(a&&this.tilePlane&&(this.tilePlane.visible=!1),a){this._destroyMeshTerrain(),this.terrainMME=a,this.terrainMesh=a.mesh;var b=new Transform;b.pos.x=this.relativePosition.x,b.pos.z=this.relativePosition.z,b.scale.set(1/this.grid.scale,1/this.grid.scale,1/this.grid.scale),Tundra.renderer.updateSceneNode(this.terrainMesh,b),this.terrainMesh.visible=!1;var c=-1e4+10*this.zoomLevel.zoom;this.traverseTileTerrain(function(a){a.renderDepth=c,MeshmoonGeoTile.SHADOWS&&(a.receiveShadow=!0)}.bind(this)),void 0===this.terrainMesh.parent&&Tundra.renderer.scene.add(this.terrainMesh),this.traverseTileTerrain(function(a){a.geometry&&this._created(a)}.bind(this)),this.computeTerrainHeightMap()}this.terrainMaterial&&(this.terrainHeightMapData&&this.terrainHeightMapData.debugTexture&&(this.terrainMaterial.uniforms.diffuseMap.value=this.terrainHeightMapData.debugTexture),this.traverseTileTerrain(function(a){a.material=this.terrainMaterial}.bind(this))),this.terrainMesh&&this.updateTileTerrainVisibility()},updateVegetation:function(a){if(a){this._destroyVegetation(),this.vegetationMME=a,this.vegetationPointCloud=a.mesh,this.vegetationSpacing=a.pointCloudSpacing;var b=new Transform;b.pos.x=this.relativePosition.x,b.pos.z=this.relativePosition.z,b.scale.set(1/this.grid.scale,1/this.grid.scale,1/this.grid.scale),Tundra.renderer.updateSceneNode(this.vegetationPointCloud,b),this.vegetationPointCloud.visible=this.visible,void 0===this.vegetationPointCloud.parent&&Tundra.renderer.scene.add(this.vegetationPointCloud);var c=MeshmoonGeoShaders.Vegetation,d=THREE.UniformsUtils.clone(c.uniforms);this.vegetationMaterial=new THREE.ShaderMaterial({fragmentShader:c.fragmentShader,vertexShader:c.vertexShader,uniforms:d,transparent:!0}),d.bounds.value.set(this.boundsWorld.min.x,this.boundsWorld.max.z,this.scale.x,this.scale.z),d.spacing.value=this.vegetationSpacing,d.diffuseMap.value=this.grid.vegetationDefaultTexture,d.geoOpacity.value=Tundra.plugins.meshmoonGeo.mapLayers.getVegetationOpacity()/100;var e=Tundra.renderer.activeCameraEntity(),f=e?e.camera.camera:void 0;f&&(d.fov.value=MathUtils.degToRad(f.fov),d.screenHeight.value=window.innerHeight),this.traverseVegetation(function(a){a.material=this.vegetationMaterial}.bind(this))}if(this.tileMaterial&&this.satelliteEnabled){var g=this.tileMaterial.uniforms.diffuseMap.value;g&&(this.vegetationMaterial.uniforms.diffuseMap.value=g)}},updateTileTerrainVisibility:function(){var a=this.visible&&this._isTerrainMeshTextureLoaded();this.terrainMesh?(this.terrainMesh.visible=a,this.tilePlane&&(this.tilePlane.visible=!a)):this.tilePlane&&(this.tilePlane.visible=this.visible),this.visible&&this.updateBuildingHeightMap()},updateVegetationVisibility:function(){this.vegetationPointCloud&&(this.vegetationPointCloud.visible=this.visible&&Tundra.plugins.meshmoonGeo.mapLayers.vegetation)},updateVegetationOpacity:function(a){this.traverseVegetation(function(b){b.material&&b.material.uniforms&&b.material.uniforms.geoOpacity&&(b.material.uniforms.geoOpacity.value=a/100)}.bind(this))},traverseTileTerrain:function(a){this.terrainMesh&&"function"==typeof this.terrainMesh.traverse&&this.terrainMesh.traverse(a)},traverseVegetation:function(a){this.vegetationPointCloud&&"function"==typeof this.vegetationPointCloud.traverse&&this.vegetationPointCloud.traverse(a)},onTileTexture:function(a,b){if(this.grid){try{this.satelliteEnabled=a.service.isFeatureEnabled(IMeshmoonGeoService.Feature.TileTexture.Satellite)}catch(c){this.satelliteEnabled=!1,console.error(c)}this.updateTileMaterial(b.texture),this.updateTilePlane(),this.updateTileTerrain()}},findTileLayerData:function(a){for(var b="string"==typeof a?a:a.Id,c=0;c<this.layerTextures.length;c++)if(this.layerTextures[c]&&this.layerTextures[c].layer.Id===b)return this.layerTextures[c];return void 0},onTileLayersChanged:function(a){if(Array.isArray(this.layerTextures)){for(var b=[],c=0;c<a.length;c++)"wms"===a[c].Type&&b.push(this.findTileLayerData(a[c]));this.layerTextures=b,this.updateTileMaterialLayers()}if(void 0!==this.layerFeatures)for(var d=Object.keys(this.layerFeatures),e=0;e<d.length;e++){var f=this.layerFeatures[d[e]],g=!1;if(f&&f.layer)for(var h=0;h<a.length&&!(g="wfs"===a[h].Type&&a[h].Id===f.layer.Id);h++);g||this._destroyLayerFeatures(d[e])}},onTileLayersOpacityChanged:function(a,b){"wms"===a.Type&&this.updateTileMaterialLayers({textures:!1})},onTileLayerTexture:function(a,b){if(this.grid){var c=a.data;if(void 0!==Tundra.plugins.meshmoonGeo.mapLayers.getLayer(c)){var d=c?c.geoMapLayerIndex:void 0;"object"==typeof c&&"number"==typeof d&&(void 0===this.layerTextures&&(this.layerTextures=[]),this.layerTextures[d]={layer:c,asset:b},this.updateTileMaterialLayers())}}},onTileLayerFeature:function(a,b){if(this.grid){void 0===this.layerFeatures&&(this.layerFeatures={});var c=a.data;if(void 0!==Tundra.plugins.meshmoonGeo.mapLayers.getLayer(c)){var d=a.uniqueLayerId();this._destroyLayerFeatures(d);var e=Tundra.plugins.meshmoonGeo.visuals.layerMaterial(c),f=new THREE.Mesh(b,e);f.name=d,f.scale.y=20,MeshmoonGeoTile.SHADOWS&&(f.castShadow=!0),Tundra.renderer.scene.add(f),this._created(f),this.layerFeatures[d]={layer:c,asset:f}}}},onBuildings2D:function(a,b,c){this.grid&&(b.tile=this,this._destroyBuildings(),this.buildings=new THREE.Mesh(b,this.grid.buildingShader.createMaterial()),this.grid.debug&&this.buildings.material.uniforms.ambientColor.value.setStyle(this.grid.getDebugMaterialColor(this.zoomLevel.zoom,!1)),this.buildings.scale.y=1/this.grid.scale,this.buildings.visible=this.visible,this.buildings.buildingsId=c,MeshmoonGeoTile.SHADOWS&&(this.buildings.castShadow=!0),this.buildings.material.uniforms.bounds.value.set(this.boundsWorld.min.x,this.boundsWorld.max.z,this.scale.x,this.scale.z),Tundra.renderer.scene.add(this.buildings),this._created(this.buildings))},onProperties2D:function(a,b,c){this.grid&&(this.properties=new THREE.Mesh(b,this.grid.getDebugMaterial(this.zoomLevel.zoom,!0,.25)),this.properties.propertiesId=c,this.properties.scale.y=10,MeshmoonGeoTile.SHADOWS&&(this.properties.castShadow=!0),Tundra.renderer.scene.add(this.properties),this._created(this.properties))},onTerrain:function(a,b){this.grid&&this.updateTileTerrain(b)},onVegetation:function(a,b){this.grid&&this.updateVegetation(b)},updateBuildingHeightMap:function(){this.buildings&&this.terrainMesh&&this.terrainHeightMapData&&this.terrainHeightMapData.texture&&(this.buildings.material.uniforms.heightMap.value=this.terrainHeightMapData.texture,this.buildings.material.uniforms.heightLimits.value.set(this.terrainHeightMapData.lowest,this.terrainHeightMapData.highest))},computeTerrainHeightMap:function(){this.terrainMesh&&!this.terrainHeightMapData&&(this.terrainHeightMapData=RocketShaderLibrary.createTerrainHeightMap(this.terrainMesh.children[0].geometry,!1))}}),MeshmoonGeoQuadTree=Class.$extend({__init__:function(a,b,c){this.uuid=THREE.Math.generateUUID(),this._timing=new AsyncHelper("MeshmoonGeoQuadTree."+this.uuid,this),this.parent=c,this.maxZoomValue=void 0,this.dividing=!1,this.quads=[],this.grid=a,this.tile=b,this.tile.quadSelf=this,this.tile.quad=this},destroy:function(){this.cancelTileAssets();for(var a=0;a<this.quads.length;++a)this.quads[a].destroy();this.quads=[],this.tile&&this.tile.destroy()},setDebugEnabled:function(a){for(var b=0;b<this.quads.length;++b)this.quads[b].setDebugEnabled(a);this.tile&&this.tile.setDebugEnabled(a)},isInside:function(a,b){var c=this.tile.bounds;return a<c.max.x&&a>c.min.x&&b<c.max.y&&b>c.min.y?!0:!1},lerp:function(a,b,c){return{x:(1-c)*a.x+c*b.x,y:(1-c)*a.y+c*b.y}},length:function(a){return Math.sqrt(a.x*a.x+a.y*a.y)},isInRadius:function(a,b,c){var d=this.tile.bounds,e=this.tile.center,f=new THREE.Vector2(d.min.x-a,d.min.y-b).length(),g=new THREE.Vector2(d.min.x-a,d.max.y-b).length(),h=new THREE.Vector2(d.max.x-a,d.min.y-b).length(),i=new THREE.Vector2(d.max.x-a,d.max.y-b).length(),j=new THREE.Vector2(e.x-a,e.y-b).length(),k=this.length({x:e.x-a,y:e.y-b}),l=!1;if(k>c){var m=this.lerp({x:a,y:b},e,c/k);l=this.isInside(m.x,m.y)}return c>f||c>g||c>h||c>i||c>j||this.isInside(a,b)||l},queryTiles:function(a,b,c,d){if(this.isInRadius(a,b,c)){if(this.quads.length>0){for(var e=[],f=0;f<this.quads.length;++f)for(var g=this.quads[f].queryTiles(a,b,c,d),h=0;h<g.length;++h)e.push(g[h]);return e}return void 0===d?[this]:this.tile.zoomLevel.zoom<d.zoom?[this]:[]}return[]},extractData:function(a){if(this.quads.length>0)for(var b=0;b<this.quads.length;++b)this.quads[b].extractData(a);this.tile&&this.tile.visible&&((void 0===a.min||this.tile.scale.x<a.min)&&(a.min=this.tile.scale.x),(void 0===a.max||this.tile.scale.x>a.max)&&(a.max=this.tile.scale.x))},getTiles:function(a,b){if(b="boolean"==typeof b?b:!0,this.quads.length>0)for(var c=0;c<this.quads.length;++c)this.quads[c].getTiles(a,b);!this.tile||b&&!this.tile.visible||a.push(this.tile)},splitToZoom:function(a){0===this.quads.length&&this.tile.zoomLevel.zoom<a&&this.split()},divideToZoom:function(a,b){return 0===this.quads.length&&this.tile.zoomLevel.zoom<a?(this.split({autoHide:!1,autoShow:!1,autoAssetLoad:!1}),b===!0?this.divide():!0):!1},splitToNext:function(a){var b=!1;return 0===this.quads.length&&(b=this.split({autoHide:!1,autoShow:!1,autoAssetLoad:!1})),a===!0&&this.divide(),b},split:function(a){if(this.quads.length>0)return!1;if(a=$.extend({autoHide:!0,autoShow:!1,autoAssetLoad:!1},a),"number"==typeof this.maxZoomValue&&this.tile.zoomLevel.zoom>=this.maxZoomValue)return[];var b=this.tile.zoomLevel.zoom+1;if(b>this.grid.zoomLevelBounds.min)return!1;var c=this.grid.crs.tileSizeMeters(b),d=this.grid.getZoomLevelConfig(b);"object"!=typeof d&&(d={size:0,zoom:b});var e=this.tile.center.x+.5*c.x,f=this.tile.center.y+.5*c.y,g=this.grid.crs.metersToTile(e,f,b),h=new MeshmoonGeoQuadTree(this.grid,new MeshmoonGeoTile(this.grid,g.x,g.y,d),this),i=new MeshmoonGeoQuadTree(this.grid,new MeshmoonGeoTile(this.grid,g.x-1,g.y,d),this),j=new MeshmoonGeoQuadTree(this.grid,new MeshmoonGeoTile(this.grid,g.x,g.y-1,d),this),k=new MeshmoonGeoQuadTree(this.grid,new MeshmoonGeoTile(this.grid,g.x-1,g.y-1,d),this);this.quads=[h,i,j,k];for(var l=0;l<this.quads.length;l++)this.quads[l].tile.quad=this,this.quads[l].maxZoomValue=this.maxZoomValue;a.autoHide&&!a.autoAssetLoad&&this.tile.hide();for(var l=0;l<this.quads.length;l++)a.autoShow&&!a.autoAssetLoad?this.quads[l].tile.show():this.quads[l].tile.hide();return a.autoAssetLoad&&this.divide(),!0},divide:function(a){if(this.dividing===!0)return!1;if(0===this.quads.length)return!1;if("number"==typeof this.maxZoomValue&&this.tile.zoomLevel.zoom>=this.maxZoomValue)return!1;this.dividing=!0,this.tile._clearBuildingTracking();for(var b=[],c=0;c<this.quads.length;c++)this.quads[c].loadTileAssets(!0),b.push(this.quads[c].tile);if(0===b.length)return this.dividing=!1,!1;var d=this.grid.plugin.tracker.on(b);return d?d.done(function(){if(this.dividing){this.dividing=!1;for(var a=0;a<b.length;a++)b[a].show();this.tile.destroy()}}.bind(this)):(console.warn("Tile children have no asset transfers!"),this.tile.destroy(!1,!0)),!0},getQuads:function(){if(this.quads.length>0){for(var a=[],b=0;b<this.quads.length;b++)for(var c=this.quads[b].getQuads(),d=0;d<c.length;++d)a.push(c[d]);return a}return[this]},getChildrenUnderZoomLevel:function(a){if(this.tile.zoomLevel>a)return this.getChildren();for(var b=[],c=0;c<this.quads.length;++c)for(var d=this.quads[c].getChildrenUnderZoomLevel(a),e=0;e<d.length;++e)b.push(d[e]);return b},distance:function(a,b){var c=a.x-b.x,d=a.y-b.y;return Math.sqrt(c*c+d*d)},tilesToMerge:function(a,b,c,d){if(this.root===!0)return[];if(!(this.tile.zoomLevel.zoom>=a)){for(var e=[],f=0;f<this.quads.length;++f)for(var g=this.quads[f].tilesToMerge(a,b,c,d),h=0;h<g.length;++h)e.push(g[h]);return e}var i=this.distance(c,this.tile.center);return i>d||b>d?[{quad:this,zoom:a}]:[]},mergeIf:function(a,b,c,d){if(this.isParentChainMerging())return!1;if(this.tile.zoomLevel.zoom>=a){var e=this.distance(c,this.tile.center);if(e>d||b>d)return this.cancelDivide(),this.merge(),!0}else for(var f=0;f<this.quads.length;++f)this.quads[f].mergeIf(a,b,c,d);return!1},isParentChainMerging:function(){return this.merging===!0?!0:this.parent?this.parent.isParentChainMerging():!1},cancelDivide:function(){if(this.dividing){this.dividing=!1;for(var a=0;a<this.quads.length;++a)this.quads[a].destroy()}},merge:function(){if(0===this.quads.length)return!1;if(this.dividing===!0||this.merging===!0)return!1;this.merging=!0;for(var a=0;a<this.quads.length;++a)this.quads[a].cancelTileAssets(!0);this.tile.grid=this.grid,this.loadTileAssets(!0);var b=function(){this.that.merging=!1;for(var a=0;a<this.quadsToHide.length;a++)this.quadsToHide[a].destroy();this.that.tile.show()}.bind({that:this,quadsToHide:[].concat(this.quads)});this.quads=[];var c=this.grid.plugin.tracker.on(this.tile);return c?c.done(b):b(),!0},onActiveLayersChanged:function(a){if(this.quads.length>0)for(var b=0;b<this.quads.length;++b)this.quads[b].onActiveLayersChanged(a);this.tile&&(this._timing.async("load.tile.layer.assets",function(){this.loadTileAssets(!1,"TILES_TILES_TEMP")},100),this.tile.onTileLayersChanged(a))},onLayerOpacityChanged:function(a,b){if(this.quads.length>0)for(var c=0;c<this.quads.length;++c)this.quads[c].onLayerOpacityChanged(a,b);this.tile&&this.tile.onTileLayersOpacityChanged(a,b)},onVegetationEnabledChanged:function(a){if(this.quads.length>0)for(var b=0;b<this.quads.length;++b)this.quads[b].onVegetationEnabledChanged(a);this.tile&&this.tile.updateVegetationVisibility()},onVegetationOpacityChanged:function(a){if(this.quads.length>0)for(var b=0;b<this.quads.length;++b)this.quads[b].onVegetationOpacityChanged(a);this.tile&&this.tile.updateVegetationOpacity(a)},setFeatureEnabled:function(a,b){if(this.quads.length>0)for(var c=0;c<this.quads.length;++c)this.quads[c].setFeatureEnabled(a,b);this.tile&&this._timing.async("load.tile.assets",function(){this.loadTileAssets(!1,a)},100)},loadAssets:function(a){if(this.quads.length>0)for(var b=0;b<this.quads.length;++b)this.quads[b].loadAssets(a);null!=this.tile&&this.tile.zoomLevel.zoom===a.zoom&&this.loadTileAssets()},loadTileAssets:function(a,b){if(this.tile){a="boolean"==typeof a?a:!1,b=b||"","Properties2D"===b&&this.tile._destroyProperties();var c=this.tile.visible;a&&!c&&(this.tile.visible=!0),this.tile._clearBuildingTracking();var d={};"string"==typeof b&&""!==b&&(d={tileTexture:0===b.indexOf(IMeshmoonGeoService.Type.TileTexture),tileLayers:"TILES_TILES_TEMP"===b,buildings:b===IMeshmoonGeoService.Type.Buildings2D,properties:b===IMeshmoonGeoService.Type.Properties2D,terrain:b===IMeshmoonGeoService.Type.Terrain,vegetation:b===IMeshmoonGeoService.Type.vegetation}),this.grid.plugin.chainer.load(this.tile,d),a&&!c&&(this.tile.visible=!1)}},cancelTileAssets:function(a){if(this.tile&&(this.tile._clearBuildingTracking(),this.grid.plugin.chainer.cancel(this.tile,!0,!0)),a===!0)for(var b=0;b<this.quads.length;b++)this.quads[b].cancelTileAssets(a)},visibleChildTiles:function(a){a="boolean"==typeof a?a:!0;var b=[];if(this.quads.length>0)for(var c=0;c<this.quads.length;++c)for(var d=this.quads[c].visibleChildTiles(!1),e=0;e<d.length;++e)b.push(d[e]);return 0===b.length&&!a&&this.tile&&this.tile.visible&&b.push(this.tile),b},tilesWithZoomLevel:function(a,b){var c=[];if(this.tile&&this.tile.zoomLevel&&this.tile.zoomLevel.zoom===a&&(!b||b&&this.tile.visible)&&c.push(this.tile),this.quads.length>0){for(var d=[],e=0;e<this.quads.length;++e)for(var c=this.quads[e].tilesWithZoomLevel(a,b),f=0;f<c.length;++f)d.push(c[f]);return d}return c},buildings:function(){if(this.quads.length>0){for(var a=[],b=0;b<this.quads.length;++b)for(var c=this.quads[b].buildings(),d=0;d<c.length;++d)a.push(c[d]);return a}return this.tile&&this.tile.buildings?[this.tile.buildings]:[]},mapTiles:function(){if(this.quads.length>0){for(var a=[],b=0;b<this.quads.length;++b)for(var c=this.quads[b].mapTiles(),d=0;d<c.length;++d)a.push(c[d]);return a}return this.tile&&this.tile.tilePlane?[this.tile.tilePlane]:[]}}),MeshmoonGeoBuildingShader=function(a,b){this.materials=[],this.scale=a||1,this.debug="boolean"==typeof b?b:!1,this.clock=new THREE.Clock,this.targetRadius=1500/this.scale,this.radius=1500/this.scale,this.radiusSphere=new THREE.Sphere,this.speed=1.5,this.delay=.35,this.animRadius=0,this.animScale=0,this.animBlast=0,this.animCost=0,this.animDir=1,this.animate=!1,this.showHeatmap=!1,this.enableHeatmap=!1,this.mousePos=new THREE.Vector3(0,0,0),this.prevMousePos=new THREE.Vector3(0,0,0),this.running=!1,this.stopping=!1,this.litColorDefault=new THREE.Color("rgb(234,230,221)"),this.shadowColorDefault=new THREE.Color("rgb(172,202,217)"),this.ambientColorDefault=new THREE.Color("rgb(149,158,163)"),this.gradientColor1Default=new THREE.Vector4(1,1,1,0),this.gradientColor2Default=new THREE.Vector4(1,1,1,.5),this.gradientColor3Default=new THREE.Vector4(1,1,1,1),this.litColorCost=new THREE.Color("rgb(255,255,255)"),this.shadowColorCost=new THREE.Color("rgb(222,222,244)"),this.ambientColorCost=new THREE.Color("rgb(122,122,144)");var c=1.25;this.gradientColor1Cost=new THREE.Vector4(.4*c,.4*c,.4*c,0),this.gradientColor2Cost=new THREE.Vector4(.498*c,.835*c,.192*c,.05),this.gradientColor3Cost=new THREE.Vector4(.91*c,.286*c,.067*c,1),this.debug&&(this.debugMesh=new THREE.Mesh(new THREE.SphereGeometry(1,15,15,Math.PI,Math.PI,3*Math.PI/2),new THREE.MeshBasicMaterial({color:"rgb(100,100,100)",wireframe:!0})),Tundra.renderer.scene.add(this.debugMesh))};MeshmoonGeoBuildingShader.prototype={createMaterial:function(){var a=MeshmoonGeoShaders.Buildings,b=new THREE.ShaderMaterial({uniforms:THREE.UniformsUtils.clone(a.uniforms),vertexShader:a.vertexShader,fragmentShader:a.fragmentShader});return b.uniforms.ambientColor.value.copy(this.ambientColorDefault),this.materials.push(b),b},removeMaterial:function(a){if(void 0!==a)for(var b=0;b<this.materials.length;++b)if(this.materials[b].uuid===a.uuid)return void this.materials.splice(b,1)},destroy:function(){this.debugMesh&&(this.debugMesh.geometry&&this.debugMesh.geometry.dispose(),delete this.debugMesh,this.debugMesh=void 0)},RadiusContains:function(a){return this.running?this.radiusSphere.containsPoint(a):!1},PositionChanged:function(a){this.radiusSphere.center.copy(a),this.debugMesh&&this.debugMesh.position.copy(a)},RadiusChanged:function(a){0>a&&(a=0),this.radiusSphere.radius=a,this.debugMesh&&(this.debugMesh.scale.set(a,a,a),this.debugMesh.visible=!this.debugMesh.scale.isZero())},ClearPosition:function(){this.stopping!==!0&&this.running!==!1&&(this.stopping=!0,this.prevMousePos=this.mousePos,this.ResetAnimated())},IsAnimating:function(){return this.running&&this.animate},Reset:function(){this.animRadius=0,this.animScale=0,this.animBlast=0,this.animCost=0},ResetAnimated:function(){this.animDir=-1;for(var a=0;a<this.materials.length;++a)this.materials[a].uniforms.mouseposition.value=this.prevMousePos;this.animate=!0,this.animCost=Math.max(0,Math.min(1,this.animCost)),this.prevMousePos=this.mousePos,this.PositionChanged(this.prevMousePos)},Update:function(a){if(this.running){var b=a,c=this.animDir<0?b*this.speed*2*this.animDir:b*this.speed*this.animDir;if(this.animate){this.animRadius=Math.max(0,Math.min(1,this.animRadius+c));for(var d=this.animRadius<.5?2*this.animRadius*this.animRadius:-1+(4-2*this.animRadius)*this.animRadius,e=1/(this.radius*d),f=0;f<this.materials.length;++f)this.materials[f].uniforms.radiusMultiplier.value=e;this.animScale=this.animScale+c;for(var g=Math.max(0,Math.min(1,this.animScale-this.delay)),h=.5>g?2*g*g:-1+(4-2*g)*g,f=0;f<this.materials.length;++f)this.materials[f].uniforms.animScaleUp.value=h;if(this.animScale>=1&&this.animRadius>=1){for(var f=0;f<this.materials.length;++f)this.materials[f].uniforms.mouseposition.value=this.mousePos;this.animate=!1,this.PositionChanged(this.mousePos),this.RadiusChanged(this.radius)}else if(this.animScale<=0&&this.animRadius<=0){this.radius=this.targetRadius,this.showHeatmap=this.enableHeatmap,this.animBlast=0,this.animDir=1,this.prevMousePos=this.mousePos;for(var f=0;f<this.materials.length;++f)this.materials[f].uniforms.mouseposition.value=this.mousePos;if(this.PositionChanged(this.mousePos),this.RadiusChanged(0),this.stopping){this.running=!1,this.stopping=!1;for(var f=0;f<this.materials.length;++f)this.materials[f].uniforms.animScaleUp.value=0,this.materials[f].uniforms.animScaleBlast.value=0,this.materials[f].uniforms.radiusMultiplier.value=1;return}}else this.RadiusChanged(this.radius*d)}(this.showHeatmap===!0&&this.animDir>0||this.animDir<=0)&&this.AnimateCostGradient(c),this.animBlast=this.animBlast+b*this.speed*1;for(var f=0;f<this.materials.length;++f)this.materials[f].uniforms.animScaleBlast.value=1/((1150+1e3*this.animBlast)*this.animBlast)}},AnimateRadius:function(a){var b=this.targetRadius-this.radius;b>3||-3>b?(this.radius+=b*a,this.animate=!0):this.radius=this.targetRadius},AnimateCostGradient:function(a){if(this.animCost=Math.max(0,this.animCost+a*this.speed),this.animCost<1){var b=this.animCost,b=b*b*b;b=Math.max(0,Math.min(1,b));var c=this.ambientColorDefault.clone();c.lerp(this.ambientColorCost,b);for(var d=0;d<this.materials.length;++d)this.materials[d].uniforms.ambientColor.value=c}},SetRadius:function(a){this.targetRadius=a},EnableHeatmap:function(a){this.enableHeatmap=a},SetPosition:function(a){this.running=!0,this.prevMousePos=this.mousePos,this.ResetAnimated(),this.mousePos=a}};var MeshmoonGeoTileGrid=Class.$extend({__init__:function(a,b){this.plugin=a,this.setConfig(b),this.log=TundraLogging.getLogger("MeshmoonGeoTileGrid"),this._mergeLimiter=new FrameLimiter(1),this.tileSizes={min:void 0,max:void 0},this.zoomLevelBounds={min:void 0,max:void 0},this.distanceZoomLevels=[],this.cameraStationaryTime=0,this.focusedTile=void 0,this.assets={},this.cameraFocusPositionUniform={type:"v3",value:new THREE.Vector3(0,0,0)},this.fogStartDistanceUniform={type:"f",value:.8*this.plugin.config.maxDistance},this.fogEndDistanceUniform={type:"f",value:.9*this.plugin.config.maxDistance},this.cameraForwardUniform={type:"v3",value:new THREE.Vector3(0,0,0)}},destroy:function(){if(Array.isArray(this.quadTrees)&&this.quadTrees.length>0){for(var a=0;a<this.quadTrees.length;++a)this.quadTrees[a].destroy();this.quadTrees=[]}if(this.tileGeometry&&(this.tileGeometry.dispose(),delete this.tileGeometry,this.tileGeometry=void 0),this.buildingShader&&(this.buildingShader.destroy(),delete this.buildingShader,this.buildingShader=void 0),Array.isArray(this.debugHoleMeshes)&&this.debugHoleMeshes.length>0){for(var a=0;a<this.debugHoleMeshes.length;a++)this.debugHoleMeshes[a].geometry&&this.debugHoleMeshes[a].geometry.dispose(),Tundra.renderer.scene.remove(this.debugHoleMeshes[a]);this.debugHoleMeshes=[]}void 0!==this.preRenderSubscription&&(Tundra.events.unsubscribe(this.preRenderSubscription),this.preRenderSubscription=void 0)},zoomLevelCompare:function(a,b){return a.zoom<b.zoom?1:a.zoom>b.zoom?-1:0},setFeatureEnabled:function(a,b){for(var c=0;c<this.quadTrees.length;++c)this.quadTrees[c].setFeatureEnabled(a,b)},hasZoomLevel:function(a){if("number"!=typeof a)return console.error("MeshmoonGeoTileGrid.hasZoomLevel: 'zoom' is not a number:",a),!1;for(var b=0;b<this.quadTrees.length;++b)if(this.quadTrees[b].tile&&this.quadTrees[b].tile.zoomLevel.zoom===a)return!0;return!1},setConfig:function(a){this.debug="boolean"==typeof a.debug?a.debug:!1,this.fetchBuildingsMaster="boolean"==typeof a.buildings?a.buildings:!0,this.scale="number"==typeof a.scale?a.scale:1,this.tileSize="number"==typeof a.tileSize?a.tileSize:256,this.holes="object"==typeof a.holes?a.holes:{},this.zoomLevels=a.zoomLevels||[],this.zoomLevels.sort(this.zoomLevelCompare),this.crs=new MeshmoonCRS(this.tileSize,this)},setDebugEnabled:function(a){this.debug=a.debug;for(var b=0;b<this.quadTrees.length;b++)this.quadTrees[b].setDebugEnabled(a)},tilesWithZoomLevel:function(a,b){b="boolean"==typeof b?b:!1;var c=[];if("number"!=typeof a)return console.error("tilesWithZoomLevel invalid 'level', must be a number:",typeof a,a),c;if(!Array.isArray(this.quadTrees)||0===this.quadTrees.length)return c;for(var d=0;d<this.quadTrees.length;++d)c=c.concat(this.quadTrees[d].tilesWithZoomLevel(a,b));return c},buildings:function(){var a=[];if(!Array.isArray(this.quadTrees)||0===this.quadTrees.length)return a;for(var b=0;b<this.quadTrees.length;++b)a=a.concat(this.quadTrees[b].buildings());return a},mapTiles:function(){var a=[];if(!Array.isArray(this.quadTrees)||0===this.quadTrees.length)return a;for(var b=0;b<this.quadTrees.length;++b)a=a.concat(this.quadTrees[b].mapTiles());return a},getDynamicZoomLevels:function(a){for(var b=[],c=0;c<this.distanceZoomLevels.length;++c)this.distanceZoomLevels[c].distance>a&&b.push(this.distanceZoomLevels[c]);return b},valueChanged:function(a,b,c){return Math.abs(a-b)<c?!1:!0},processCameraMovementTimer:function(a,b,c){
if(void 0===this.cameraStationaryTime&&(this.cameraStationaryTime=0),void 0===this.lastCameraDistToFocus&&(this.lastCameraDistToFocus=0),void 0===this.lastCameraPosition&&(this.lastCameraPosition=new THREE.Vector3),void 0===c)return void(this.cameraStationaryTime=0);var d=!this.lastCameraPosition.equals(c,5);if(!d){var e=b.distanceTo(c);d=!MathUtils.equal(e,this.lastCameraDistToFocus,50),d&&(this.lastCameraDistToFocus=e,this.canMerge=!0)}d?this.cameraStationaryTime=0:this.cameraStationaryTime+=a,this.mergeFinished?(this.mergeFinished=!1,this.canMerge=!1):this.lastCameraPosition.distanceTo(c)>200&&(this.canMerge=!0),this.lastCameraPosition.copy(c)},hasQuad:function(a,b){for(var c=0;c<this.quadTrees.length;++c){var d=this.quadTrees[c];if(null!=d.tile&&d.tile.x===a&&d.tile.y===b)return!0}return!1},onPreRender:function(){var a=Tundra.renderer.activeCameraEntity(),b=a?a.camera.camera:void 0;if(b){var c=b.parent.quaternion.clone();this.cameraForwardUniform.value.set(0,0,-1),this.cameraForwardUniform.value.applyQuaternion(c)}},onUpdate:function(a,b,c){if(this.buildingShader&&this.buildingShader.Update(a),this.processCameraMovementTimer(a,b,c),this.cameraFocusPositionUniform.value.copy(c),b&&c){var d=this._updateVisibleFocusTile(c),e=c.clone();e.y=0;var f=b.distanceTo(e);this.focusedTile&&(this.focusedTile.distanceToCamera=f);var g=this.crs.worldPositionToMeters(c.x,c.z);if(d&&Tundra.events.send("MeshmoonGeoPlugin.ActiveTileChanged",this.focusedTile),!this.canMerge&&this._mergeLimiter.shouldUpdate(a)&&(this.canMerge=!0),this.canMerge){for(var h=0;h<this.quadTrees.length;++h)for(var i=0;i<this.distanceZoomLevels.length;++i){var j=this.distanceZoomLevels[i];this.quadTrees[h].mergeIf(j.zoom,f,g,1.05*j.radius)}this.mergeFinished=!0}this.expandArea(g),this.cameraStationaryTime>.2&&this.splitDynamicTiles(g,f,e)}},_hasBiggerTile:function(a,b){for(var c=b;void 0!==c.parent;){for(var d=0;d<a.length;++d)if(a[d].quad.uuid===c.parent.uuid)return!0;c=c.parent}return!1},biggestTilesToMerge:function(a){for(var b=[],c=0;c<a.length;++c)a[c].quad.isParentChainMerging()||b.push(a[c]);return b},splitDynamicTiles:function(a,b,c){for(var d=this.getDynamicZoomLevels(b),e=0;e<d.length;e++)for(var f=d[e],g=0;g<this.quadTrees.length;++g){var h=this.quadTrees[g],i=h.queryTiles(a.x,a.y,f.radius,f);if(0!=i.length)for(var j=0;j<i.length;++j)i[j].divideToZoom(f.zoom,!0)}},expandArea:function(a){for(var b=this.crs.metersToTile(a.x,a.y,this.maxZoom.zoom),c=b.x-this.expandRadius;c<b.x+2*this.expandRadius;c++)for(var d=b.y-this.expandRadius;d<b.y+2*this.expandRadius;d++)if(!this.hasQuad(c,d)){var e=new MeshmoonGeoTile(this,c,d,this.maxZoom),f=new MeshmoonGeoQuadTree(this,e);this.quadTrees.push(f),e.show(),f.loadAssets(this.maxZoom)}for(var g=this.expandRadius*this.crs.tileSizeMeters(this.maxZoom.zoom).x,h=0;h<this.quadTrees.length;++h){var f=this.quadTrees[h],i=new THREE.Vector2(a.x-f.tile.center.x,a.y-f.tile.center.y).length();i>4*g&&(this.quadTrees.splice(h,1),f.destroy(),--h)}},lerp:function(a,b,c){return{x:(1-c)*a.x+c*b.x,y:(1-c)*a.y+c*b.y}},length:function(a){return Math.sqrt(a.x*a.x+a.y*a.y)},_updateVisibleFocusTile:function(a){return this.focusedTile&&!this.focusedTile.visible&&(this.focusedTile=void 0),void 0===this.focusedTile||null===this.focusedTile?(this.focusedTile=this.visibleTileAt(a),this.focusedTile?(this.focusedTile.setFocus(!0),!0):!1):this.focusedTile.contains(a)?!1:(this.focusedTile.setFocus(!1),this.focusedTile=this.visibleTileAt(a),this.focusedTile?(this.focusedTile.setFocus(!0),!0):!1)},tiles:function(){if(!Array.isArray(this.quadTrees)||0===this.quadTrees.length)return[];for(var a=[],b=0;b<this.quadTrees.length;++b)this.quadTrees[b].getTiles(a,!1);return a},visibleTiles:function(){if(!Array.isArray(this.quadTrees)||0===this.quadTrees.length)return[];for(var a=[],b=0;b<this.quadTrees.length;++b)this.quadTrees[b].getTiles(a,!0);return a},tileAt:function(a){for(var b=void 0,c=this.tiles(),d=c.length-1;d>=0;d--)c[d].contains(a)&&(void 0===b||b.zoomLevel.zoom<c[d].zoomLevel.zoom)&&(b=c[d]);return b},visibleTileAt:function(a){for(var b=this.visibleTiles(),c=b.length-1;c>=0;c--)if(b[c].contains(a))return b[c];return void 0},getDebugMaterialColor:function(a,b,c){void 0===this.debugMaterials&&(this.debugMaterials={solid:{},tiles:{}},this.debugColors=["red","blue","green"]);var d=this.zoomLevels[this.zoomLevels.length-1].zoom,e=a-d,e=e-3*Math.floor(e/3);return this.debugColors[e]},getDebugMaterial:function(a,b,c){void 0===this.debugMaterials&&(this.debugMaterials={solid:{},tiles:{}},this.debugColors=["red","blue","green"]);var d=b?this.debugMaterials.tiles:this.debugMaterials.solid;if(void 0!==d[a])return d[a];var e=this.zoomLevels[this.zoomLevels.length-1].zoom,f=a-e,f=f-3*Math.floor(f/3),g=void 0;return b?(g=new THREE.MeshBasicMaterial({color:this.debugColors[f]}),g.transparent=!0,void 0===c?(g.opacity=.1,g.side=THREE.BackSide):g.opacity=c,g.depthTest=!1,g.depthWrite=!1):g=new THREE.MeshPhongMaterial({color:this.debugColors[f]}),d[a]=g,g},createDebugGeometries:function(){void 0===this.debugCubeGeometry&&(this.debugCubeGeometry=new THREE.BoxGeometry(1,1,1)),void 0===this.debugSphereGeometry&&(this.debugSphereGeometry=new THREE.SphereGeometry(.5,32,32)),void 0===this.debugSphereMaterial&&(this.debugSphereMaterial=new THREE.MeshBasicMaterial({color:"green",wireframe:!0}))},initializeAssets:function(){if(void 0===this.tileGeometry){this.debug&&this.createDebugGeometries(),this.tileGeometry=new THREE.BufferGeometry;for(var a=[0,0,0,1,0,1,1,0,0,0,0,0,0,0,1,1,0,1],b=new Float32Array(a.length),c=0;c<b.length;c++)b[c]=a[c];for(var d=[0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0],e=new Float32Array(d.length),c=0;c<e.length;c++)e[c]=d[c];for(var f=[0,0,1,1,1,0,0,0,0,1,1,1],g=new Float32Array(f.length),c=0;c<f.length;c++)g[c]=f[c];this.tileGeometry.addAttribute("position",new THREE.BufferAttribute(b,3)),this.tileGeometry.addAttribute("normal",new THREE.BufferAttribute(e,3)),this.tileGeometry.addAttribute("uv",new THREE.BufferAttribute(g,2)),this.tileGeometry.computeBoundingBox(),this.tileGeometry.computeBoundingSphere()}if(void 0===this.buildingShader&&(this.buildingShader=new MeshmoonGeoBuildingShader(this.scale,this.debug)),void 0===this.vegetationDefaultTexture){var h=new THREE.Color("#8fae63"),i=new THREE.Color("#334736");this.vegetationDefaultTexture=RocketShaderLibrary.createRandomTexture(256,256,h,i)}},getZoomLevelConfig:function(a){for(var b=0;b<this.zoomLevels.length;++b)if(this.zoomLevels[b].zoom==a)return this.zoomLevels[b];return void 0},createGrid:function(a,b){this.fogStartDistanceUniform.value=.55*this.plugin.config.maxDistance,this.fogEndDistanceUniform.value=.65*this.plugin.config.maxDistance,this.initializeAssets(),void 0===this.layersSubbed&&(this.layersSubbed=!0,this.plugin.mapLayers.onActiveLayersChanged(function(a){for(var b=0;b<this.quadTrees.length;++b)this.quadTrees[b].onActiveLayersChanged(a)}.bind(this)),this.plugin.mapLayers.onLayerOpacityChanged(function(a,b){for(var c=0;c<this.quadTrees.length;++c)this.quadTrees[c].onLayerOpacityChanged(a,b)}.bind(this)),this.plugin.mapLayers.onVegetationEnabledChanged(function(a){for(var b=0;b<this.quadTrees.length;++b)this.quadTrees[b].onVegetationEnabledChanged(a)}.bind(this)),this.plugin.mapLayers.onVegetationOpacityChanged(function(a){for(var b=0;b<this.quadTrees.length;++b)this.quadTrees[b].onVegetationOpacityChanged(a)}.bind(this))),this.quadTrees=[],this.originLatLon={lat:b,lon:a},this.originMeters=this.crs.latLonToMeters(b,a),this.boundingBoxLatLon={min:{lat:void 0,lon:void 0},max:{lat:void 0,lon:void 0}},this.boundingBoxMeters={min:{x:void 0,y:void 0},max:{x:void 0,y:void 0}},this.debug||this.createDebugHoles(),this.createBaseLevel(this.zoomLevels[this.zoomLevels.length-1]);for(var c=0;c<this.quadTrees.length;++c)if(this.quadTrees[c].tile){var d=this.quadTrees[c].tile.boundsLatLon;(void 0===this.boundingBoxLatLon.min.lat||d.min.lat<this.boundingBoxLatLon.min.lat)&&(this.boundingBoxLatLon.min.lat=d.min.lat),(void 0===this.boundingBoxLatLon.min.lon||d.min.lon<this.boundingBoxLatLon.min.lon)&&(this.boundingBoxLatLon.min.lon=d.min.lon),(void 0===this.boundingBoxLatLon.max.lat||d.max.lat>this.boundingBoxLatLon.max.lat)&&(this.boundingBoxLatLon.max.lat=d.max.lat),(void 0===this.boundingBoxLatLon.max.lon||d.max.lon>this.boundingBoxLatLon.max.lon)&&(this.boundingBoxLatLon.max.lon=d.max.lon);var e=this.quadTrees[c].tile.bounds;(void 0===this.boundingBoxMeters.min.x||e.min.x<this.boundingBoxMeters.min.x)&&(this.boundingBoxMeters.min.x=e.min.x),(void 0===this.boundingBoxMeters.min.y||e.min.y<this.boundingBoxMeters.min.y)&&(this.boundingBoxMeters.min.y=e.min.y),(void 0===this.boundingBoxMeters.max.x||e.max.x>this.boundingBoxMeters.max.x)&&(this.boundingBoxMeters.max.x=e.max.x),(void 0===this.boundingBoxMeters.max.y||e.max.y>this.boundingBoxMeters.max.y)&&(this.boundingBoxMeters.max.y=e.max.y)}for(var f=this.visibleTiles(),g=f.length-1;g>=0;g--)f[g].show();for(var c=0;c<this.quadTrees.length;++c)this.quadTrees[c].extractData(this.tileSizes);var h=this.zoomLevels[0],i=this.zoomLevels[this.zoomLevels.length-1];this.zoomLevelBounds.min=h.zoom,this.zoomLevelBounds.max=i.zoom,this.maxZoom=i,this.expandRadius=Math.floor(this.plugin.config.maxDistance/this.crs.tileSizeMeters(this.maxZoom.zoom).x);for(var g=h.zoom;g>=i.zoom;--g){this.distanceZoomLevels.push({width:this.crs.tileSizeMeters(g).x,distance:2.5*this.crs.tileSizeMeters(g).x,radius:1.5*this.crs.tileSizeMeters(g).x,zoom:g});var j=this.getZoomLevelConfig(g);"object"!=typeof j&&(j={size:0,zoom:g});for(var c=0;c<this.quadTrees.length;++c)this.quadTrees[c].loadAssets(j)}this.log.isDebug()&&(this.log.debug("Origin:",this.originLatLon,this.originMeters),this.log.debug("Bounds:",this.boundingBoxLatLon,this.boundingBoxMeters),this.log.debug("Tiles",f.length,"World coord sizes:",this.tileSizes),this.log.debug("Zoom levels",this.zoomLevels.length,this.zoomLevelBounds)),void 0===this.preRenderSubscription&&(this.preRenderSubscription=Tundra.frame.onPreRender(this,this.onPreRender))},createDebugHoles:function(){if(this.debug&&"object"==typeof this.holes&&Array.isArray(this.holes.polygons)&&0!==this.holes.polygons.length)for(var a=0;a<this.holes.polygons.length;++a){var b=this.holes.polygons[a],c=[];if("coordinates"===b.type)for(var d=0;d<b.points.length;++d){var e=b.points[d],f=this.crs.latLonToWorldPosition(e.lat,e.lon);c.push(f)}else"local"===b.type&&(c=b.points);if(!(c.length<2)){for(var g=new Float32Array(6*c.length),h=new Uint32Array(6*c.length),i=0,d=0;d<c.length;++d){var j=c[d];g[i+0]=j.x,g[i+1]=0,g[i+2]=j.z,g[i+3]=j.x,g[i+4]=50,g[i+5]=j.z,i+=6}i=0;for(var d=0;d<c.length;++d){var k=2*d,l=k+1,m=k+2,n=k+3;d==c.length-1&&(m=0,n=1),h[i+0]=k,h[i+1]=l,h[i+2]=m,h[i+3]=l,h[i+4]=m,h[i+5]=n,i+=6}var o=new THREE.BufferGeometry;o.addAttribute("position",new THREE.BufferAttribute(g,3)),o.addAttribute("index",new THREE.BufferAttribute(h,1));var p=new THREE.Mesh(o,new THREE.MeshBasicMaterial({color:new THREE.Color(1,1,0),transparent:!0,opacity:.5,side:THREE.DoubleSide}));void 0===this.debugHoleMeshes&&(this.debugHoleMeshes=[]),this.debugHoleMeshes.push(p),Tundra.renderer.scene.add(p)}}},getDistance:function(a){for(var b=this.crs.tileSizeMeters(a.zoom),c=b.x*a.size,d=0;d<this.zoomLevels.length;++d)this.zoomLevels[d].zoom>a.zoom&&(b=this.crs.tileSizeMeters(this.zoomLevels[d].zoom),c+=b.x*this.zoomLevels[d].size);return c},processZoomLevel:function(a){for(var b=this.getDistance(a),c=0;c<this.quadTrees.length;++c)for(var d=this.quadTrees[c],e=[],f=0;5>f&&(e=d.queryTiles(this.originMeters.x,this.originMeters.y,b,a),0!=e.length);++f)for(var g=0;g<e.length;++g)e[g].splitToZoom(a.zoom)},createBaseLevel:function(a){var b=this.crs.metersToTile(this.originMeters.x,this.originMeters.y,a.zoom),c=this.crs.tileBounds(b.x,b.y,a.zoom),d=this.crs.tileSizeMeters(a.zoom),e={x:this.originMeters.x-c.min.x,y:this.originMeters.y-c.min.y},f=this.getDistance(a),g=Math.floor(f/d.x),h=0;e.x<d.x/2&&(h=-1);var i=0;e.y<d.y/2&&(i=-1);for(var j=1;g>=j;++j){for(var k=2*j,l=0;k>l;++l){var m=k/2-1,n=k/2-1,o=b.x-n+l+h,p=b.y-m+i,q=new MeshmoonGeoTile(this,o,p,a);p=b.y+k/2+i;var r=new MeshmoonGeoTile(this,o,p,a),s=new MeshmoonGeoQuadTree(this,q),t=new MeshmoonGeoQuadTree(this,r);this.quadTrees.push(s),this.quadTrees.push(t)}for(var l=0;k-2>l;++l){var n=k/2-1,m=k/2-2,o=b.x-n+h,p=b.y-m+l+i,u=new MeshmoonGeoTile(this,o,p,a);o=b.x+k/2+h;var v=new MeshmoonGeoTile(this,o,p,a),w=new MeshmoonGeoQuadTree(this,u),x=new MeshmoonGeoQuadTree(this,v);this.quadTrees.push(w),this.quadTrees.push(x)}}}}),MeshmoonGeoLocation=Class.$extend({__init__:function(a){this.plugin=a,this.config={address:{enabled:!0,updated:performance.now(),zoom:15}},this._timing=new AsyncHelper("MeshmoonGeoLocation",this),this._cache={addressUpdated:0}},onUpdate:function(a,b,c){this.config.address.enabled===!0&&this.updateLocation(b,c,!1)},move:function(a){var b=Tundra.renderer.activeCameraEntity();if(b&&b.placeable)return"object"==typeof a&&"number"==typeof a.lon&&"number"==typeof a.lat&&(a=this.plugin.coordinates.latLonToWorldPosition(a)),a instanceof THREE.Vector3?void("MeshmoonRtsCamera"===b.name?b.exec(1,"AnimateFocusPosition",a):console.warn("MeshmoonGeoLocation.move: Currently only 'MeshmoonRtsCamera' is supported. Active camera:",b.name)):(console.error("MeshmoonGeoLocation.move: Invalid destination:",a),!1)},updateLocation:function(a,b,c){if(this.plugin.grid.buildingShader&&!this.plugin.grid.buildingShader.IsAnimating()&&Tundra.plugins.meshmoonGeo.grid.focusedTile&&(c="boolean"==typeof c?c:!1,!(Tundra.plugins.meshmoonGeo.grid.cameraStationaryTime<.25))){var d=performance.now(),e=d-this._cache.addressUpdated;if(!(1e3>e)){this._cache.addressUpdated=d,a||(a=Tundra.renderer.activeCameraWorldPosition()),b||(b=Tundra.renderer.activeCameraWorldFocusPosition());var f=this.plugin.coordinates.worldPositionToLatLon(b);if(null!=f&&"number"==typeof f.lat&&"number"==typeof f.lon){c||void 0!==this._cache.addressLastTile&&this._cache.addressLastTile===Tundra.plugins.meshmoonGeo.grid.focusedTile.uuid||(c=!0,this._cache.addressLastTile=Tundra.plugins.meshmoonGeo.grid.focusedTile.uuid);var g=.0025;if(!(!c&&void 0!==this._cache.addressCoords&&Math.abs(this._cache.addressCoords.lat-f.lat)<g&&Math.abs(this._cache.addressCoords.lon-f.lon)<g)){this._cache.addressCoords=f;var h=a.distanceTo(b),i=11;2e4>h?i=15:25e3>h&&(i=14),void 0===this._cache.addressWorldPosition&&(this._cache.addressWorldPosition=new THREE.Vector3),this._cache.addressWorldPosition.copy(b),$.getJSON("http://nominatim.openstreetmap.org/reverse?format=json&zoom="+i+"&addressdetails=1&lat="+f.lat+"&lon="+f.lon,this._addressInformationReply.bind(this))}}}}},getLocationForTile:function(a){if(!a||!a.grid||!a.zoomLevel)return this._timing.deferImmediate("getLocationForTile",!1,"Invalid tile object");if(void 0!==a.locationInfo)return this._timing.deferImmediate("getLocationForTile",!0,a.locationInfo);var b=a.getCenterLatLon(),c=this.getLocation(b.lat,b.lon,a.zoomLevel.zoom);return c.done(function(b){a.locationInfo=b}.bind(a)),c},getLocation:function(a,b,c){return $.getJSON("http://nominatim.openstreetmap.org/reverse?format=json&zoom="+c+"&addressdetails=1&lat="+a+"&lon="+b)},_addressInformationReply:function(a){if(a&&a.address){!a.address.city&&a.address.town&&(a.address.city=a.address.town),!a.address.city&&a.address.village&&(a.address.city=a.address.village);var b=!1;!a.address.suburb||this._cache.addressData&&this._cache.addressData.address.suburb===a.address.suburb||(Tundra.events.send("MeshmoonGeoLocation.SuburbChanged",$.extend(!0,{},a)),b=!0),!a.address.city||this._cache.addressData&&this._cache.addressData.address.city===a.address.city||(Tundra.events.send("MeshmoonGeoLocation.CityChanged",$.extend(!0,{},a)),b=!0),!a.address.country||this._cache.addressData&&this._cache.addressData.address.country===a.address.country||(Tundra.events.send("MeshmoonGeoLocation.CountryChanged",$.extend(!0,{},a)),b=!0),this._cache.addressData=a,this._cache.addressData.geo_display_name=this.getDislayName(this._cache.addressData),Tundra.events.send("MeshmoonGeoLocation.LocationChanged",$.extend(!0,{},this._cache.addressData))}},getDislayName:function(a){if(!this._cache||!this._cache.addressData||!this._cache.addressData.address)return"";var b=this._cache.addressData.address,c=[];return"string"==typeof b.suburb&&""!==b.suburb&&(a&&(a.geo_display_main=b.suburb),c.push(b.suburb)),"string"==typeof b.city&&""!==b.city&&(a&&!a.geo_display_main?a.geo_display_main=b.city:a&&(a.geo_display_second=b.city),c.push(b.city)),0===c.length&&("string"==typeof b.county&&""!==b.county?(a&&!a.geo_display_main?a.geo_display_main=b.county:a&&(a.geo_display_second=b.county),c.push(b.county)):"string"==typeof b.state&&""!==b.state&&(a&&!a.geo_display_main?a.geo_display_main=b.state:a&&(a.geo_display_second=b.state),c.push(b.state))),c.length<=1&&"string"==typeof b.country&&""!==b.country&&(a&&!a.geo_display_main?a.geo_display_main=b.country:a&&(a.geo_display_second=b.country),c.push(b.country)),0===c.length?"":c.join(", ")},onLocationChanged:function(a,b){return Tundra.events.subscribe("MeshmoonGeoLocation.LocationChanged",a,b)},onCityChanged:function(a,b){return Tundra.events.subscribe("MeshmoonGeoLocation.CityChanged",a,b)},onSuburbChanged:function(a,b){return Tundra.events.subscribe("MeshmoonGeoLocation.SuburbChanged",a,b)}}),MeshmoonGeoMapLayers=Class.$extend({__init__:function(a){this.plugin=a,this.log=TundraLogging.getLogger("MeshmoonGeoMapLayers"),this.timing=new AsyncHelper("MeshmoonGeoMapLayers",this),this.layers=[],this.vegetation=!1},__classvars__:{MaxLayers:{wms:4,wfs:4},DefaultOpacity:{wms:50,wfs:50}},start:function(){if(!this.app){Tundra.asset.loadDependencies(void 0,"webrocket://elements/meshmoon-geo-map-layers.html").done(function(){this.app=document.createElement("meshmoon-geo-map-layers"),this.app.parent=this,this.app.layers=this.layers,this.app.vegetation=this.vegetation,this.onActiveLayersChanged(function(a){this.app.layers=a,this.uiLabel&&(this.uiLabel.text(a.length.toString()),0===a.length?this.uiLabel.hide():this.uiLabel.show())}.bind(this)),this.app.addEventListener("layer-opacity-change",function(a){var b=this.getLayer(a.detail.id);b&&(b.geoMapLayerOpacity=a.detail.value,b.material&&b.material.uniforms&&b.material.uniforms.geoOpacity&&"number"==typeof b.material.uniforms.geoOpacity.value&&(b.material.uniforms.geoOpacity.value=b.geoMapLayerOpacity/100),Tundra.events.send("MeshmoonGeoMapLayers.Layer.Opacity.Changed",b,b.geoMapLayerOpacity))}.bind(this)),this.app.addEventListener("vegetation-opacity-change",function(a){Tundra.events.send("MeshmoonGeoMapLayers.Vegeration.Opacity.Changed",a.detail.value)}.bind(this)),this.timing.resolve("MeshmoonGeoMapLayers.ui.ready",!0,this.app)}.bind(this));var a=Tundra.config.readSection("MeshmoonGeoPlugin");a&&a.visibility&&"boolean"==typeof a.visibility.vegetation&&this.setVegetationEnabled(a.visibility.vegetation)}},stop:function(){this.layers=[]},getUi:function(){return void 0!==this.app?this.timing.deferImmediate("MeshmoonGeoMapLayers.ui.ready",!0,this.app):this.timing.defer("MeshmoonGeoMapLayers.ui.ready")},setUiAction:function(a){this.uiAction=a,this.uiAction&&"string"==typeof this.uiAction.nodeName&&"paper-icon-button"===this.uiAction.nodeName.toLowerCase()&&this.uiAction.shadowRoot&&(this.uiLabel=$(Tundra.ui.createLayout(Tundra.ui.$class.Layout.Horizontal,Tundra.ui.$class.Align.Center)).css({"pointer-events":"none",position:"absolute",top:-2,right:-2,"border-radius":"50%","background-color":"steelblue","font-size":"11px","font-weight":500,display:"flex",color:"white",width:18,height:18,"z-index":101}).text(this.layers.length.toString()),0===this.layers.length&&this.uiLabel.hide(),$(this.uiAction.shadowRoot).append(this.uiLabel))},onLayerChanged:function(a,b,c){return Tundra.events.subscribe("MeshmoonGeoMapLayers.Layer.Changed",a,b,c)},onActiveLayersChanged:function(a,b,c){return Tundra.events.subscribe("MeshmoonGeoMapLayers.Active.Layers.Changed",a,b,c)},onLayerOpacityChanged:function(a,b,c){return Tundra.events.subscribe("MeshmoonGeoMapLayers.Layer.Opacity.Changed",a,b,c)},onVegetationEnabledChanged:function(a,b,c){return Tundra.events.subscribe("MeshmoonGeoMapLayers.Vegetation.Enabled",a,b,c)},onVegetationOpacityChanged:function(a,b,c){return Tundra.events.subscribe("MeshmoonGeoMapLayers.Vegeration.Opacity.Changed",a,b,c)},getDefaultOpacity:function(a){return this.isValidLayer(a,!1)&&"number"==typeof MeshmoonGeoMapLayers.DefaultOpacity[a.Type]?Math.min(100,Math.max(0,MeshmoonGeoMapLayers.DefaultOpacity[a.Type])):Math.min(100,Math.max(0,this.app?this.app.defaultOpacity:50))},getVegetationOpacity:function(){return this.app?Math.min(100,Math.max(0,this.app.vegetationOpacity)):this.getDefaultOpacity()},toggleVegetation:function(){this.setVegetationEnabled(!this.vegetation)},setVegetationEnabled:function(a){if(this.vegetation!==a){this.vegetation=a;var b=Tundra.config.readSection("MeshmoonGeoPlugin");$.extend(b,{visibility:{vegetation:this.vegetation}}),Tundra.config.writeSection("MeshmoonGeoPlugin",b),this.app&&(this.app.vegetation=a),Tundra.events.send("MeshmoonGeoMapLayers.Vegetation.Enabled",a)}},getLayer:function(a){if("object"==typeof a&&"string"==typeof a.Id&&(a=a.Id),"string"!=typeof a)return void 0;for(var b=0;b<this.layers.length;b++)if(this.layers[b].Id===a)return this.layers[b];return void 0},_removeLayer:function(a){if("object"==typeof a&&"string"==typeof a.Id&&(a=a.Id),"string"!=typeof a)return!1;for(var b=0;b<this.layers.length;b++)if(this.layers[b].Id===a)return this.layers[b].geoMapLayerIndex=void 0,this.layers[b].geoMapLayerOpacity=void 0,this.layers.splice(b,1),!0;return!1},isValidLayer:function(a,b){return"object"!=typeof a?(b===!0&&this.log.error("isValidLayer: Not an object:",a),!1):"string"!=typeof a.Id?(b===!0&&this.log.error("isValidLayer: Missing 'Id' string property:",a),!1):"string"!=typeof a.Type?(b===!0&&this.log.error("isValidLayer: Missing 'Type' string property:",a),!1):"string"!=typeof a.Endpoint?(b===!0&&this.log.error("isValidLayer: Missing 'Endpoint' string property:",a),!1):!0},isLayerEnabled:function(a){return this.isValidLayer(a,!0)?void 0!==this.getLayer(a):!1},numLayers:function(a){for(var b=0,c=0;c<this.layers.length;c++)this.layers[c].Type===a.Type&&b++;return b},enable:function(a){if(!this.isValidLayer(a,!0))return!1;if(void 0!==this.getLayer(a))return!0;var b=this.numLayers(a);return void 0===MeshmoonGeoMapLayers.MaxLayers[a.Type]||b>=MeshmoonGeoMapLayers.MaxLayers[a.Type]?(this.log.warn("Layer",a.Id,"canno be enabled, all layer slots are already in use (max for "+a.Type+" is "+MeshmoonGeoMapLayers.MaxLayers[a.Type]+")"),!1):(a.geoMapLayerIndex=b,a.geoMapLayerOpacity=this.getDefaultOpacity(a),this.layers.push(a),Tundra.events.send("MeshmoonGeoMapLayers.Layer.Changed",a,!0),Tundra.events.send("MeshmoonGeoMapLayers.Active.Layers.Changed",this.layers),this.log.info(a.Type,this.numLayers(a),"layers active"),!0)},disable:function(a){return"string"==typeof a&&(a=this.getLayer(a)),this.isValidLayer(a,!0)?(this._removeLayer(a)&&(Tundra.events.send("MeshmoonGeoMapLayers.Layer.Changed",a,!1),Tundra.events.send("MeshmoonGeoMapLayers.Active.Layers.Changed",this.layers),this.log.info(a.Type,this.numLayers(a),"layers active")),!0):!1},moveDown:function(a){var b=this.getLayer(a);if(!b)return!1;for(var c=0;c<this.layers.length;c++)if(this.layers[c].Id===b.Id){if(c===this.layers.length-1)return!1;this.layers.splice(c,1),this.layers.splice(c+1,0,b);break}return Tundra.events.send("MeshmoonGeoMapLayers.Active.Layers.Changed",this.layers),!0},moveUp:function(a){var b=this.getLayer(a);if(!b)return!1;for(var c=0;c<this.layers.length;c++)if(this.layers[c].Id===b.Id){if(0===c)return!1;this.layers.splice(c,1),this.layers.splice(c-1,0,b);break}return Tundra.events.send("MeshmoonGeoMapLayers.Active.Layers.Changed",this.layers),!0}}),MeshmoonGeoVisuals=Class.$extend({__init__:function(a){this.plugin=a,this.log=TundraLogging.getLogger("MeshmoonGeoVisuals"),this.animator=new PlaceableUtils.Animator,this.materials={}},__classvars__:{GeoJSON:{Type:{Feature:"Feature",Geometry:{Point:"Point"}}}},layerMaterial:function(a){if(!this.plugin.mapLayers.isValidLayer(a))return void 0;var b=a.Endpoint+"_"+a.Id;if(void 0!==this.materials[b])return this.materials[b];var c=MeshmoonGeoShaders.LayerFeature,d=new THREE.ShaderMaterial({uniforms:THREE.UniformsUtils.clone(c.uniforms),vertexShader:c.vertexShader,fragmentShader:c.fragmentShader});d.transparent=!0;var e=new THREE.Color(16777215*Math.random());return d.uniforms.ambientColor.value.copy(e),d.uniforms.geoOpacity.value=("number"==typeof a.geoMapLayerOpacity?a.geoMapLayerOpacity:this.plugin.mapLayers.getDefaultOpacity(a))/100,a.material=d,this.materials[b]=d,d},geojsonBillboards:function(a,b){var c={created:[],updated:[]};if(!a||!Array.isArray(a.features))return this.log.error("geojsonBillboards: Invalid GeoJSON:",a),c;b=$.extend({prefix:"",autoHideDistanceFurtherThan:-1,autoHideDistanceFurtherThanFromCamera:-1,autoScaleDistanceCloserThan:-1,autoScaleDistanceFurtherThan:-1,autoScaleLimits:void 0,hide:!1,height:0,duration:-1,animDistanceLimit:-1},b),""!==b.prefix&&(b.prefix+=".");for(var d=0;d<a.features.length;d++){var e=a.features[d];if(e.type===MeshmoonGeoVisuals.GeoJSON.Type.Feature){if("object"==typeof e.geometry)if(e.geometry.type===MeshmoonGeoVisuals.GeoJSON.Type.Geometry.Point)if(!Array.isArray(e.geometry.coordinates)||e.geometry.coordinates.length<2)this.log.warn("geojsonBillboards: Invlaid feature Point coordinates:",e.geometry.coordinates);else{var f={lat:e.geometry.coordinates[1],lon:e.geometry.coordinates[0]};f.worldPosition=this.plugin.coordinates.latLonToWorldPosition(f),"object"!=typeof e.properties&&(e.properties={});var g=b.prefix+(e.properties.id||e.properties.name||"");if(g!==b.prefix){var h=Tundra.scene.entityByName(g),i=null===h||void 0===h;if(i?(h=Tundra.scene.createLocalEntity(["Placeable","Billboard"]),h.name=g):(h.placeable||h.getOrCreateLocalComponent("Placeable"),h.billboard||h.getOrCreateLocalComponent("Billboard")),i||b.duration<0){var j=h.placeable.transform;j.setPosition(f.worldPosition.x,b.height,f.worldPosition.z),h.placeable.transform=j,b.hide===!1?h.billboard.show():h.placeable.visible=!1}else{var k="number"==typeof b.animDistanceLimit&&b.animDistanceLimit>0,l=!0;if(k){var m=h.placeable.worldPosition();m.y=0;var n=m.distanceTo(f.worldPosition);l=n<b.animDistanceLimit}if(l&&!h.placeable.visible&&(l=!1),l&&b.hide===!1)h.billboard.animation=this.animator.position(h.placeable,{to:new THREE.Vector3(f.worldPosition.x,b.height,f.worldPosition.z),duration:b.duration,easing:b.easing});else{var j=h.placeable.transform;j.setPosition(f.worldPosition.x,b.height,f.worldPosition.z),h.placeable.transform=j,l&&b.hide===!1?h.billboard.show():h.billboard.animation&&h.billboard.animation.stop()}}b.hide&&(h.billboard.hide(),h.placeable.visible=!1),h.billboard.depthTest=!1,h.billboard.autoHideDistanceFurtherThan=b.autoHideDistanceFurtherThan,h.billboard.autoHideDistanceFurtherThanFromCamera=b.autoHideDistanceFurtherThanFromCamera,h.billboard.autoScaleDistanceCloserThan=b.autoScaleDistanceCloserThan,h.billboard.autoScaleDistanceFurtherThan=b.autoScaleDistanceFurtherThan,b.autoScaleLimits instanceof THREE.Vector2&&h.billboard.autoScaleLimits.copy(b.autoScaleLimits),h.billboard.isNew=i,h.billboard.feature=e,h.billboard.coordinate=f,i?c.created.push(h.billboard):c.updated.push(h.billboard)}else this.log.warn("geojsonBillboards: Failed to resolve unique name from properties:",e.properties)}else this.log.warn("geojsonBillboards: Feature geometry type is not '"+MeshmoonGeoVisuals.GeoJSON.Type.Geometry.Point+"':",e.geometry)}else this.log.warn("geojsonBillboards: Feature type is not '"+MeshmoonGeoVisuals.GeoJSON.Type.Feature+"':",e)}return c}}),MeshmoonGeoServiceChainer=Class.$extend({__init__:function(a){this.log=TundraLogging.getLogger("MeshmoonGeoServiceChainer"),this.plugin=a,this.chains={}},start:function(){this.chains={}},stop:function(){this.chains={}},load:function(a,b){if(a.visible===!0){b=$.extend({tileTexture:!0,tileLayers:!0,buildings:!0,properties:!0,terrain:!0,vegetation:!0},b);var c=this.chains[a.uuid];void 0===c&&(c=new MeshmoonGeoTileServiceChain(a),this.chains[a.uuid]=c);var d=[];b.tileTexture&&d.push(IMeshmoonGeoService.Type.TileTexture),b.terrain&&d.push(IMeshmoonGeoService.Type.Terrain),b.vegetation&&d.push(IMeshmoonGeoService.Type.Vegetation),b.buildings&&d.push(IMeshmoonGeoService.Type.Buildings2D),b.properties&&d.push(IMeshmoonGeoService.Type.Properties2D),b.tileLayers&&(d=d.concat(this.plugin.mapLayers.layers)),c.execute(d,this.findParentChain(a))}},cancel:function(a,b,c){var d=this.chains[a.uuid];if(void 0!==d){var e=[];b&&e.push(IMeshmoonGeoService.Type.Buildings2D),c&&(e.push(IMeshmoonGeoService.Type.Vegetation),e.push(IMeshmoonGeoService.Type.Terrain),e.push(IMeshmoonGeoService.Type.TileTexture)),d.cancel(e)}},findParentChain:function(a){for(var b=a.quad;b&&b.tile;){var c=this.chains[b.tile.uuid];if(void 0!==c)return c;if(b.root||b.tile.root||!b.tile.quad||!b.tile.quad.tile)break;if(b.tile.quad.uuid===b.uuid||b.tile.quad.tile.uuid===b.tile.uuid)break;b=b.tile.quad}return void 0}}),MeshmoonGeoTileServiceChain=Class.$extend({__init__:function(a){this.log=TundraLogging.getLogger("ServiceChain."+a.uuid),this.plugin=Tundra.plugins.meshmoonGeo,this.tile=a,this.requests=[],this.types={}},reset:function(a){for(var b=this._isLayer(a)?a.Id:a,c=this.requests.length-1;c>=0;c--)this.requests[c].type===b&&(b===IMeshmoonGeoService.Type.Buildings2D&&this.plugin.tracker.removeBuildings(this.requests[c].uuid),this.requests[c].cancel(),this.requests.splice(c,1));var d=this.types[b];d?this.types[b]=$.extend({},{noContent:d.noContent,suppressed:d.suppressed}):this.types[b]={}},forgetRequest:function(a){for(var b=this.requests.length-1;b>=0;b--)this.requests[b].uuid===a.uuid&&this.requests.splice(b,1)},_isLayer:function(a){return"object"==typeof a&&"string"==typeof a.Endpoint&&"string"==typeof a.Id},execute:function(a,b){for(var c=0;c<a.length;c++){var d=a[c];if("string"==typeof d){if(this.reset(d),this.types[d]={index:0,services:Tundra.plugins.meshmoonGeo.servicesForType(d),request:void 0,suppressed:!1,noContent:{}},b&&"object"==typeof b){var e=b.types[d];if(e&&e.noContent&&"object"==typeof e.noContent&&Object.keys(e.noContent).length>0)for(var f=this.types[d].services.length-1;f>=0;f--){var g=e.noContent[this.types[d].services[f].uuid];g===!0&&this.types[d].services.splice(f,1)}}this.executeNext(d)}else this._isLayer(d)?(this.reset(d.Id),this.types[d.Id]={index:0,services:[Tundra.plugins.meshmoonGeo.service("MeshmoonGis")],layer:d,request:void 0,suppressed:!1,noContent:{}},this.executeNext(d.Id)):this.log.error("Invalid asset type",d)}},cancel:function(a){for(var b=0;b<a.length;b++){var c=a[b];"string"==typeof c?this.reset(c):this.log.error("Invalid asset type",c)}},executeNext:function(a){var b=this.types[a];if(b&&b.suppressed!==!0&&Array.isArray(b.services)){var c=b.services[b.index];if(c){b.index++;var d=void 0===b.layer?c.request(a,this.tile):c.requestLayer(b.layer,this.tile);if(d&&d.suppressed)return void this.executeNext(a);d&&d.promise?(this.requests.push(d.request),d.promise.always(this.forgetRequest.bind(this)).done(this.onSucceeded.bind(this)).fail(this.onFailed.bind(this)),b.request=d.request):this.log.error("Failed to get promise from",a,"service:",d)}else b.request=void 0,b.suppressed=!0}},onSucceeded:function(a,b,c){var d=this.types[a.type];if(d.request&&d.request.uuid!==a.uuid)return void(a.canceled||this.log.warn("Received",a.type,"response which is stale, ignoring."));d.request=void 0;var e=this._isLayer(a.data)?"wms"===a.data.Type?this.tile.onTileLayerTexture:this.tile.onTileLayerFeature:this.tile["on"+a.type];"function"==typeof e?e.apply(this.tile,[a,b,c]):this.log.error("Tile is missing handler function 'on"+a.type+"'")},onFailed:function(a,b){if(a.transfer&&204===a.transfer.httpStatusCode){var c=this.types[a.type];c&&(c.noContent[a.service.uuid]=!0)}this.executeNext(a.type);
}}),MeshmoonGisService=IMeshmoonGeoService.$extend({__init__:function(){this.$super("MeshmoonGis"),this.MeshmoonFeatures={},this.MeshmoonFeatures[IMeshmoonGeoService.Type.Buildings2D]=["kanta:rakennus"],this.MeshmoonFeatures[IMeshmoonGeoService.Type.Terrain]=[IMeshmoonGeoService.Type.Terrain],this.MeshmoonFeatures[IMeshmoonGeoService.Type.Vegetation]=[IMeshmoonGeoService.Type.Vegetation],this.MeshmoonFeatures[IMeshmoonGeoService.Type.Properties2D]=["kanta:kiinteisto"],this.MeshmoonFeatures[IMeshmoonGeoService.Feature.TileTexture.Satellite]=["ortokartta"],this.MeshmoonFeatures[IMeshmoonGeoService.Feature.TileTexture.Guiding]=["opaskartta"],this.MeshmoonFeatures[IMeshmoonGeoService.Feature.TileTexture.Properties]=["karttayhdistelma"],this.data={},Tundra.usingRequireJS()&&this.discoverLocalhost()},__classvars__:{URL:"http://gis.meshmoon.com",Service:{WMS:"wms",WFS:"wfs",Terrain:"terrain",Entity:"entity",IsValid:function(a){return a===this.WMS||a===this.WFS||a===this.Terrain&&a===this.Entity}},GoogleCloud:{BaseURL:"http://storage.googleapis.com/meshmoon/gis",Terrain:{Max:16,Min:9,isAvailable:function(a){return a>=this.Min&&a<=this.Max}},Vegetation:{Max:16,Min:9,isAvailable:function(a){return a>=this.Min&&a<=this.Max}}},CreateURL:function(a,b,c){if(!this.Service.IsValid(a))return void console.error("MeshmoonGisService.CreateURL: Invalid service type: '"+a+"'");var d=MeshmoonGisService.URL+"/"+a;return"string"==typeof b&&""!==b&&(d+="/"+b),"object"==typeof c&&Object.keys(c).length>0&&(d+=CoreStringUtils.createQueryString(c)),d},QueryOperation:function(a){return a===this.Service.WMS?"layers":a===this.Service.WFS?"features":a===this.Service.Terrain?"tile":(a===this.Service.Entity,void 0)}},discoverLocalhost:function(){try{var a="http://"+("string"==typeof Tundra.DeveloperServerHost?Tundra.DeveloperServerHost:"127.0.0.1")+":8085";$.ajax(a+"/ping").done(function(){MeshmoonGisService.URL=a,this.log.debug("Using",MeshmoonGisService.URL)}.bind(this))}catch(b){this.log.error("discoverLocalhost: Exception while detecting localhost proxy:",b),b.stack&&console.error(b.stack)}},queryEndpoints:function(a){var b=this.queryURL(a,"endpoints");if(!b)return void 0;var c=this.data[b];return void 0!==c&&"object"==typeof c?this.timing.deferImmediate(b,!0,c):this.timing.defer(b,function(){$.getJSON(b).done(function(c){if(Array.isArray(c))for(var d=0;d<c.length;d++)c[d].serviceType=a;this.data[b]=c,this.timing.resolve(b,!0,c)}.bind(this)).fail(function(){this.timing.resolve(b,!1)}.bind(this))}.bind(this))},queryURL:function(a,b,c){return MeshmoonGisService.CreateURL(a,b,c)},queryJSON:function(a,b){var c=this.queryURL(a,MeshmoonGisService.QueryOperation(a),b);return c?this.timing.defer(c,function(){$.getJSON(c).done(function(a){this.timing.resolve(c,!0,a)}.bind(this)).fail(function(){this.timing.resolve(c,!1)}.bind(this))}.bind(this)):void 0},start:function(){this.setMaxRequests(1),this.setFeatureSupported(Object.keys(this.MeshmoonFeatures),!0,!1)},gridStarted:function(a){this._verifyDataAvailable(a)},_verifyDataAvailable:function(a){this.timing.when("data.availability."+IMeshmoonGeoService.Type.Buildings2D,"data.availability."+IMeshmoonGeoService.Type.Properties2D,"data.availability."+IMeshmoonGeoService.Feature.TileTexture.Satellite,"data.availability."+IMeshmoonGeoService.Feature.TileTexture.Guiding,"data.availability."+IMeshmoonGeoService.Feature.TileTexture.Properties).done(function(a,b,c,d,e){var f=[],g=[];a===!0?f.push(IMeshmoonGeoService.Type.Buildings2D):g.push(IMeshmoonGeoService.Type.Buildings2D),b===!0?f.push(IMeshmoonGeoService.Type.Properties2D):g.push(IMeshmoonGeoService.Type.Properties2D),c===!0?f.push(IMeshmoonGeoService.Feature.TileTexture.Satellite):g.push(IMeshmoonGeoService.Feature.TileTexture.Satellite),d===!0?f.push(IMeshmoonGeoService.Feature.TileTexture.Guiding):g.push(IMeshmoonGeoService.Feature.TileTexture.Guiding),e===!0?f.push(IMeshmoonGeoService.Feature.TileTexture.Properties):g.push(IMeshmoonGeoService.Feature.TileTexture.Properties),f.length>0&&this.setFeatureSupported(f,!0),g.length>0&&this.setFeatureSupported(g,!1);for(var h=0;h<g.length;h++)this.cancelAll(g[h]);f.length>0&&this.setMaxRequests(this.defaultMaxRequests)}.bind(this));for(var b=function(b,c){var d={bbox:this.roundedGridBoundingBox(a),type:this.MeshmoonFeatures[b].join(",")};this.log.debug("Checking data availability for",b);var e=Tundra.asset.requestAsset(MeshmoonGisService.URL+"/"+c+"/availability"+CoreStringUtils.createQueryString(d),"Binary");e?(e.onCompleted(this,function(){this.timing.resolve("data.availability."+b,!0,!0)}),e.onFailed(this,function(){this.timing.resolve("data.availability."+b,!0,!1)})):this.timing.resolve("data.availability."+b,!0,!1)}.bind(this),c=[IMeshmoonGeoService.Type.Buildings2D,IMeshmoonGeoService.Type.Properties2D,IMeshmoonGeoService.Feature.TileTexture.Satellite,IMeshmoonGeoService.Feature.TileTexture.Guiding,IMeshmoonGeoService.Feature.TileTexture.Properties],d=1,e=0;e<c.length;e++)b(c[e],d>=e?"wfs":"wms")},supportsBuildings2D:function(){return this.isFeatureSupported(IMeshmoonGeoService.Type.Buildings2D)},supportsProperties2D:function(){return this.isFeatureSupported(IMeshmoonGeoService.Type.Properties2D)&&this.isFeatureEnabled(IMeshmoonGeoService.Type.Properties2D)},supportsTileTextures:function(){return this.isFeatureEnabled(IMeshmoonGeoService.Feature.TileTexture.Satellite)&&this.isFeatureSupported(IMeshmoonGeoService.Feature.TileTexture.Satellite)?!0:this.isFeatureEnabled(IMeshmoonGeoService.Feature.TileTexture.Guiding)&&this.isFeatureSupported(IMeshmoonGeoService.Feature.TileTexture.Guiding)?!0:this.isFeatureEnabled(IMeshmoonGeoService.Feature.TileTexture.Properties)&&this.isFeatureSupported(IMeshmoonGeoService.Feature.TileTexture.Properties)?!0:!1},constructBuildings2DURL:function(a){var b={type:this.MeshmoonFeatures[IMeshmoonGeoService.Type.Buildings2D].join(","),bbox:this.roundedBoundingBox(a,8)};a.url=MeshmoonGisService.URL+"/wfs/features"+CoreStringUtils.createQueryString(b),a.assetType=".json"},constructProperties2DURL:function(a){var b={type:this.MeshmoonFeatures[IMeshmoonGeoService.Type.Properties2D].join(","),bbox:this.roundedBoundingBox(a,8)};a.url=MeshmoonGisService.URL+"/wfs/features"+CoreStringUtils.createQueryString(b),a.assetType=".json"},constructTileTextureURL:function(a){var b={type:"",bbox:this.roundedBoundingBox(a,8),size:256};if(this.isFeatureEnabled(IMeshmoonGeoService.Feature.TileTexture.Satellite))b.type=this.MeshmoonFeatures[IMeshmoonGeoService.Feature.TileTexture.Satellite];else if(this.isFeatureEnabled(IMeshmoonGeoService.Feature.TileTexture.Guiding))b.type=this.MeshmoonFeatures[IMeshmoonGeoService.Feature.TileTexture.Guiding];else{if(!this.isFeatureEnabled(IMeshmoonGeoService.Feature.TileTexture.Properties))return void console.error("No valid feature type is enabled. Should have never passed 'supportsTileTextures'");b.type=this.MeshmoonFeatures[IMeshmoonGeoService.Feature.TileTexture.Properties]}a.url=MeshmoonGisService.URL+"/wms/layers"+CoreStringUtils.createQueryString(b),a.assetType=".png"},constructLayerURL:function(a){if(a.data&&a.data.Endpoint&&a.data.Id){var b={endpoint:a.data.Endpoint,id:a.data.Id,bbox:this.roundedBoundingBox(a,8)};a.data.Type===MeshmoonGisService.Service.WMS?(b.size=256,a.assetType=".png"):a.assetType=".json",a.url=this.queryURL(a.data.Type,MeshmoonGisService.QueryOperation(a.data.Type),b)}},supportsTerrain:function(){return!0},supportsVegetation:function(){return!0},constructTerrainURL:function(a){MeshmoonGisService.GoogleCloud.Terrain.isAvailable(a.tile.zoomLevel.zoom)&&(a.url=MeshmoonGisService.GoogleCloud.BaseURL+"/terrain/"+a.tile.zoomLevel.zoom+"/"+a.tile.googleTile.x+"/"+a.tile.googleTile.y+".mme")},constructVegetationURL:function(a){MeshmoonGisService.GoogleCloud.Vegetation.isAvailable(a.tile.zoomLevel.zoom)&&(a.url=MeshmoonGisService.GoogleCloud.BaseURL+"/vegetation/"+a.tile.zoomLevel.zoom+"/"+a.tile.googleTile.x+"/"+a.tile.googleTile.y+".mme")},roundedGridBoundingBox:function(a,b){return"number"!=typeof b&&(b=8),a.boundingBoxLatLon.min.lat.toFixed(b)+","+a.boundingBoxLatLon.min.lon.toFixed(b)+","+a.boundingBoxLatLon.max.lat.toFixed(b)+","+a.boundingBoxLatLon.max.lon.toFixed(b)},roundedBoundingBox:function(a,b){return"number"!=typeof b&&(b=8),a.bboxArray[0].toFixed(b)+","+a.bboxArray[1].toFixed(b)+","+a.bboxArray[2].toFixed(b)+","+a.bboxArray[3].toFixed(b)}}),MapZenService=IMeshmoonGeoService.$extend({__init__:function(){this.$super("MapZen")},supportsBuildings2D:function(){return!0},constructBuildings2DURL:function(a){a.url="http://vector.mapzen.com/osm/buildings/"+a.tile.zoomLevel.zoom+"/"+a.tile.googleTile.x+"/"+a.tile.googleTile.y+".json"}}),MapBoxService=IMeshmoonGeoService.$extend({__init__:function(){this.$super("MapBox")},__classvars__:{Base:"https://api.tiles.mapbox.com/v4/",Styles:{simplified:"meshmoon.62e31b00",satellite:"meshmoon.51cb3c14"},Style:"meshmoon.62e31b00",Format:".png",g12e3f512a338:function(){var a="JhIjoiRkhnWWwzYyJ9.nZxC0tt",b="_WTcFfMdJqxAdPQ",c="pk.eyJ1IjoibWVzaG1vb24iLC";return c+a+b}()},tileURL:function(a,b){return"object"!=typeof b||"number"!=typeof b.x||"number"!=typeof b.y?(this.log.error("tileURL: Invalid tile object, must have x and y properties:",b),""):MapBoxService.Base+MapBoxService.Style+"/"+a+"/"+b.x+"/"+b.y+MapBoxService.Format+"?access_token="+MapBoxService.g12e3f512a338},featureToggled:function(a,b){a===IMeshmoonGeoService.Feature.TileTexture.Satellite&&(MapBoxService.Style=b?MapBoxService.Styles.satellite:MapBoxService.Styles.simplified)},supportsTileTextures:function(){return!0},constructTileTextureURL:function(a){a.url=this.tileURL(a.tile.zoomLevel.zoom,a.tile.googleTile)}}),IMeshmoonGeoLoader=Class.$extend({__init__:function(a,b){("string"!=typeof a||""===a)&&console.error("IMeshmoonGeoLoader constructor called without valid 'name'"),this.plugin=Tundra.plugins.meshmoonGeo,this.uuid=THREE.Math.generateUUID(),this.name=a||"Unknown IMeshmoonGeoLoader",this.log=TundraLogging.getLogger("GeoLoader."+this.name),this.timing=new AsyncHelper(this.name,this),this.types=b.types||[],this.running=!1},supports:function(a){if(this.name===a)return!0;if(Array.isArray(this.types))for(var b=0;b<this.types.length;b++)if(this.types[b]===a)return!0;return!1},supportsLayer:function(a){return!1},_start:function(){this.running=!0,this.start()},start:function(){},_gridStarted:function(a){this.gridStarted(a)},gridStarted:function(a){},_stop:function(){this.running=!1,this.stop()},stop:function(){},_process:function(a,b,c){this.running&&this.process(a,b,c)},process:function(a,b,c){this.log.error("process function not implemented!")}}),MeshmoonWebWorkerManager=Class.$extend({__init__:function(a,b){("string"!=typeof a||""===a)&&console.error("MeshmoonWebWorkerManager 'name' must be defined in the constructor"),this.name=a||"Unknown",this.log=TundraLogging.getLogger("WebWorkerManager."+a),this.timing=new AsyncHelper(this.name,this),this.timing.data.index=0,this.workers=[],this.workerConfiguration=void 0,this.stats={time:{total:0,workers:{}},jobs:{total:0,workers:{}},reset:function(){this.time.total=0,this.time.workers={},this.jobs.total=0,this.jobs.workers={}},add:function(a,b){var c=a.uuid;return"string"!=typeof c||""===c?void console.warn("Invalid stats.add worker:",a):"number"!=typeof b||0>=b?void console.warn("Invalid stats.add duration:",a):(void 0===this.time.workers[c]&&(this.time.workers[c]=0),void 0===this.jobs.workers[c]&&(this.jobs.workers[c]=0),this.time.total+=b,this.time.workers[c]+=b,this.jobs.total++,void this.jobs.workers[c]++)}},this.options=$.extend({lazyLoad:!0,numWorkers:1,terminateTimeout:5,workResultCallback:void 0,messageCallback:void 0,script:"",dependencies:[]},b),this.options.numWorkers<1&&(this.options.numWorkers=1),this.options.terminateTimeout<1&&(this.options.terminateTimeout=1),"string"==typeof this.options.script&&""!==this.options.script?(this.options.script=Tundra.asset.resolveAssetRef("",this.options.script),Tundra.asset.requestAsset(this.options.script,"Binary").onCompleted(this,function(a){this.workerBlob=new Blob([a.data],{type:"text/javascript"}),this.workerBlobObject=window.URL.createObjectURL(this.workerBlob),this._executePendingWork()})):this.log.error("'script' must be defined in the constructor options");for(var c=0;c<this.options.dependencies.length;c++)this.options.dependencies[c]=Tundra.asset.resolveAssetRef("",this.options.dependencies[c]);if(!this.options.lazyLoad)for(var c=0;c<this.options.numWorkers;c++)this._startWorker()},__classvars__:{Protocol:{Initialize:"MeshmoonWebWorkerManager.Initialize",LoadDependencies:"MeshmoonWebWorkerManager.LoadDependencies",Configuration:"MeshmoonWebWorkerManager.Configuration",WorkOrder:"MeshmoonWebWorkerManager.WorkOrder",WorkResult:"MeshmoonWebWorkerManager.WorkResult"}},dumpStats:function(){this.log.info("Lazy load:",this.options.lazyLoad,"Current workers:",this.workers.length+"/"+this.options.numWorkers,"Working right now:",this.numWorking()),this.log.info("Total completed jobs:",this.stats.jobs.total,"time spent:",(this.stats.time.total/1e3).toFixed(2),"sec");for(var a=Object.keys(this.stats.jobs.workers),b=0;b<a.length;b++)this.log.info("WebWorker",a[b],"jobs:",this.stats.jobs.workers[a[b]],"time spent:",(this.stats.time.workers[a[b]]/1e3).toFixed(2),"sec")},stop:function(){if(this.isRunning()){for(this.log.debug("Terminating",this.workers.length,"workers");this.workers.length>0;){try{this.workers[0].terminate()}catch(a){this.log.error("Failed to terminate a WebWorker")}this.workers.splice(0,1)}this.stats.reset()}},isRunning:function(){return this.numWorkers()>0},numWorkers:function(){return this.workers.length},numWorking:function(){for(var a=0,b=0;b<this.workers.length;b++)this.workers[b].working===!0&&a++;return a},postWork:function(a,b){var c={uuid:THREE.Math.generateUUID(),payload:a,metadata:b};this.timing.cancel("workers.terminate");var d=this._nextWorker();d?(d.starting(),this._postControl(d,MeshmoonWebWorkerManager.Protocol.WorkOrder,c)):void 0===this.workerBlobObject?(Array.isArray(this.pendingWork)||(this.pendingWork=[]),this.pendingWork.push({payload:a,metadata:b})):this.log.error("Fatal: No free worker for payload:",a)},_executePendingWork:function(){if(void 0!==this.workerBlobObject&&Array.isArray(this.pendingWork)&&0!==this.pendingWork.length){for(var a=0;a<this.pendingWork.length;a++)this.postWork(this.pendingWork[a].payload,this.pendingWork[a].metadata);console.warn("send",this.pendingWork.length,"work"),this.pendingWork=[]}},_nextWorker:function(){if(void 0===this.workerBlobObject)return void 0;for(var a=void 0,b=0;b<this.workers.length;b++)if(this.workers[b].working===!1){a=this.workers[b];break}return void 0===a&&(a=this._startWorker()),void 0===a&&(a=this.workers[this.timing.data.index],this.timing.data.index++,this.timing.data.index>=this.workers.length&&(this.timing.data.index=0)),a},_startWorker:function(){if(void 0===this.workerBlobObject)return void 0;if(this.workers.length>=this.options.numWorkers)return void 0;var a=new Worker(this.workerBlobObject);return a.uuid=THREE.Math.generateUUID(),a.index=this.workers.length+1,a.working=!1,a.canTerminate=this.options.lazyLoad,a.onmessage=this._onWorkerMessage.bind(this),a.onerror=this._onWorkerError.bind(this),a.starting=function(){this.working=!0,this.rStarted=performance.now()},a.completed=function(){this.working=!1},a.durationSinceStarted=function(){return 0!==this.rStarted?performance.now()-this.rStarted:0},this._postControl(a,MeshmoonWebWorkerManager.Protocol.Initialize,{name:this.name,index:a.index,protocol:MeshmoonWebWorkerManager.Protocol,debug:this.log.isDebug()}),this.options.dependencies.length>0&&this._postControl(a,MeshmoonWebWorkerManager.Protocol.LoadDependencies,{scripts:this.options.dependencies}),("object"==typeof this.workerConfiguration||Array.isArray(this.workerConfiguration))&&this._postControl(a,MeshmoonWebWorkerManager.Protocol.Configuration,this.workerConfiguration),this.workers.push(a),this.log.debug("Started worker #",this.workers.length,a.uuid),a},_stopWorker:function(a){if(a.working===!0)return void this.log.warn("Tried to stop a currently working worker, not allowing it");for(var b=!1,c=0;c<this.workers.length;c++)if(this.workers[c].uuid===a.uuid){this.workers.splice(c,1),b=!0;break}b||this.log.error("Failed to find terminating worker",a.uuid,"from internal state");try{a.terminate()}catch(d){this.log.error("Failed to terminate a WebWorker")}},_terminateTimeout:function(){if(!(this.numWorking()>0)){this.log.isDebug()&&(this.dumpStats(),this.log.info("Terminating",this.numWorkers(),"workers due to",this.options.terminateTimeout,"second inactivity"));for(var a=[].concat(this.workers),b=0;b<a.length;b++)this._stopWorker(a[b]);this.stats.reset()}},_onWorkerMessage:function(a){var b=a.data;return b?void(b.id===MeshmoonWebWorkerManager.Protocol.WorkResult?this._onWorkerResult(a,b):"function"==typeof this.options.messageCallback?this.options.messageCallback(b):this.log.warn("Received a work result, but 'messageCallback' is not defined:",b)):void this.log.error("Received bogus message from worker:",b)},_onWorkerResult:function(a,b){var c=a.target||a.currentTarget||a.srcElement;c&&c.uuid?(c.completed(),this.stats.add(c,b.duration)):this.log.error("Failed to get sender worker for work result, This will break internal logic:",a),"function"==typeof this.options.workResultCallback?this.options.workResultCallback(b.error,b.payload,b.metadata):this.log.warn("Received a work result, but 'workResultCallback' is not defined:",b.metadata),this.options.lazyLoad===!0&&0===this.numWorking()&&this.timing.async("workers.terminate",this._terminateTimeout,1e3*this.options.terminateTimeout)},_onWorkerError:function(a){a&&a.filename&&a.message?this.log.error(a.filename,a.message):this.log.error(a)},_postControl:function(a,b,c){c.id=b,this._post(a,c)},_post:function(a,b){if(a){if(null===b||void 0===b)return this.log.error("Trying to send null/undefined as message"),!1;arguments.length>2&&this.log.warn("Trying to send",arguments.length,"arguments to worker. If you want more than one parameter, use a single Array or Object!"),a.postMessage(b)}else this.log.warn("post: Destination worker in not valid:",a)}}),MeshmoonGeoBuildings2DLoader=IMeshmoonGeoLoader.$extend({__init__:function(){this.$super("Buildings2D",{types:["Buildings2D","Properties2D"]}),this.plugin=Tundra.plugins.meshmoonGeo,this.active={},this.workerManager=new MeshmoonWebWorkerManager("Buildings2D",{script:"webrocket://web-workers/MeshmoonGeoBuildings2DLoaderWorker.js",dependencies:["http://meshmoon.s3.amazonaws.com/releases/webrocket/stable/lib/three.js"],workResultCallback:this._onWebWorkerResult.bind(this),lazyLoad:!0,numWorkers:2,terminateTimeout:20})},supportsLayer:function(a){return"wfs"===a.Type},start:function(){this.workerManager.workerConfiguration={holes:Tundra.plugins.meshmoonGeo.config.holes}},process:function(a,b,c,d){this.active[b.uuid]={service:a,request:b},void 0!==d.data.features?this.processGeoJSONWebWorker(b,c,d.data):d.data.Metadata&&Array.isArray(d.data.Results)&&this.processMeshmoonGeoJSON(b,c,d.data)},_onWebWorkerResult:function(a,b,c){if(a)this.plugin.tracker.removeBuildings(c.requestuuid),0!==a.toLowerCase().indexOf("No geometry in")&&this.log.error("WebWorker reported error '"+a+"':",c),this._completeLoading(c.requestuuid,!1);else{for(var d=new THREE.BufferGeometry,e=0;e<b.length;e+=2){var f=b[e],g=new THREE.BufferAttribute(b[e+1],this._getBufferAttributeItemSize(f));d.addAttribute(f,g)}d.computeBoundingBox(),d.computeBoundingSphere(),this._completeLoading(c.requestuuid,!0,d,c.requestuuid)}},_getBufferAttributeItemSize:function(a){return"index"===a||"position"===a||"normal"===a||"color"===a?3:"uv"===a||"uv2"===a?2:"buildingIndex"===a?1:(this.log.error("getBufferAttributeItemSize: Unknown attribute '"+a+"'"),0)},_completeLoading:function(a,b,c,d){var e=this.active[a];delete this.active[a],e&&e.service&&e.request&&e.service._completeLoading(e.request,b,c,d)},composeFeatureMetadata:function(a){var b=$.extend(!0,{},a);return delete b.geometry,delete b.type,b},processGeoJSONWebWorker:function(a,b,c){for(var d=(c.features.length,c.features.length-1);d>=0;d--){var e=c.features[d],f=e.id||e.Id;void 0===f&&"object"==typeof e.properties&&(f=e.properties.id),"number"==typeof f&&(f=f.toString()),"string"!=typeof f&&this.plugin.mapLayers.isValidLayer(a.data)&&(f=a.uniqueLayerId()),"string"==typeof f?this.plugin.tracker.hasBuilding(f,b)&&c.features.splice(d,1):(this.log.error("GeoJSON feature does not have id:",c.features[d]),c.features.splice(d,1))}if(0===c.features.length)return void this._completeLoading(a.uuid,!1);for(var g={array:[],data:a.data},h=this.plugin.mapLayers.isValidLayer(a.data)?a.data.Id:IMeshmoonGeoService.Type.Buildings2D,d=0;d<c.features.length;++d)g.array[d]=this.composeFeatureMetadata(c.features[d]);this.plugin.metadata.set(b,h,g),this.plugin.tracker.trackBuildings(a.uuid,b,c.features),this.workerManager.postWork(c,{type:"geojson",requestuuid:a.uuid,origin:$.extend({},b.grid.originMeters),scale:b.grid.scale})},processMeshmoonGeoJSON:function(a,b,c){for(var d={features:[]},e=0;e<c.Results.length;e++){var f=c.Results[e];f&&Array.isArray(f.features)&&f.features.length>0&&(d.features=d.features.concat(f.features))}this.processGeoJSONWebWorker(a,b,d)}}),MeshmoonGeoTileAssetState=Class.$extend({__init__:function(a){this.tile=a,this.requests=[]},is:function(a){return this.tile.uuid===a.uuid},pendingData:function(a){a=a||{};for(var b=this.requests.length-1;b>=0;b--)this.requests[b].waiting||(void 0===a[this.requests[b].type]?a[this.requests[b].type]=1:a[this.requests[b].type]++);return a},num:function(){return this.requests.length},numPending:function(){for(var a=0,b=this.requests.length-1;b>=0;b--)this.requests[b].waiting||a++;return a},numWaiting:function(){for(var a=0,b=this.requests.length-1;b>=0;b--)this.requests[b].waiting===!0&&a++;return a},hasRequest:function(a){for(var b=this.requests.length-1;b>=0;b--)if(this.requests[b].uuid===a.uuid)return!0;return!1},track:function(a){return this.hasRequest(a)?(console.warn("track: Tile",this.tile.uuid,"already tracking",a.uuid),this):(this.requests.push(a),this)},remove:function(a){for(var b=this.requests.length-1;b>=0;b--)if(this.requests[b].uuid===a.uuid)return this.requests.splice(b,1),this;return console.warn("remove: Tile",this.tile.uuid,"is not tracking",a.uuid),this}}),MeshmoonGeoTileCompletedState=Class.$extend({__init__:function(a){this.tile=a,this.t=0},__classvars__:{Timeout:.25},onUpdate:function(a){return this.t+=a,this.t>=MeshmoonGeoTileCompletedState.Timeout},isParentQuadDone:function(a){for(var b=!0,c=this.tile.quad.quads.length-1;c>=0&&(b=a.isCompleted(this.tile.quad.quads[c].tile),b);c--);return b}}),MeshmoonGeoBuildingState=Class.$extend({__init__:function(a,b){this.id=a,this.tile=b,this.features=[]},contains:function(a,b){if(b.zoomLevel.zoom>this.tile.zoomLevel.zoom)return!1;for(var c=this.features.length-1;c>=0;c--)if(this.features[c]===a)return!0;return!1}}),MeshmoonGeoGridAssetTracker=Class.$extend({__init__:function(a){this.plugin=a,this.log=TundraLogging.getLogger("GeoGridAssetTracker"),this.timing=new AsyncHelper("GeoGridAssetTracker",this),this.state={},this.completed=[],this.buildings=[]},on:function(){var a=arguments;1===a.length&&Array.isArray(a[0])&&(a=[].concat(a[0]));for(var b=[],c=0;c<a.length;c++){var d=a[c];d instanceof MeshmoonGeoTile?this.isCompleted(d)||b.push(this.timing.defer("tile."+d.uuid)):d instanceof MeshmoonGeoQuadTree&&b.push(this.timing.defer("quad."+d.uuid))}return b.length>0?$.when.apply($,b):void 0},_get:function(a){if(void 0===this.state[a.uuid]){for(var b=this.completed.length-1;b>=0;b--)if(this.completed[b].tile.uuid===a.uuid){this.completed.splice(b,1);break}this.state[a.uuid]=new MeshmoonGeoTileAssetState(a)}return this.state[a.uuid]},_getBuildings:function(a,b){for(var c=this.buildings.length-1;c>=0;c--)if(this.buildings[c].id===a)return this.buildings[c].tile.uuid!==b.uuid&&console.warn("_getBuildings: Different tile for transfer id"),this.buildings[c];var d=new MeshmoonGeoBuildingState(a,b);return this.buildings.push(d),d},_set:function(a,b){b&&b.num()>0?this.state[a.uuid]=b:this._setCompleted(a)},_setCompleted:function(a){delete this.state[a.uuid];for(var b=this.completed.length-1;b>=0;b--)if(this.completed[b].tile.uuid===a.uuid)return;this.completed.push(new MeshmoonGeoTileCompletedState(a)),this.plugin.grid.canMerge=!0},_emitCompleted:function(a){this.timing.resolve("tile."+a.tile.uuid,!0),a.isParentQuadDone(this)&&this.timing.resolve("quad."+a.tile.quad.uuid,!0)},_dumpState:function(){return},isCompleted:function(a){if(void 0!==this.state[a.uuid])return!1;for(var b=this.completed.length-1;b>=0;b--)if(this.completed[b].tile.uuid===a.uuid)return!1;return!0},pendingData:function(){for(var a={},b=Object.keys(this.state),c=b.length-1;c>=0;c--)this.state[b[c]].pendingData(a);return a},num:function(){return Object.keys(this.state).length},numRequests:function(){for(var a=0,b=Object.keys(this.state),c=b.length-1;c>=0;c--)a+=this.state[b[c]].num();return a},numRequestsWaiting:function(){for(var a=0,b=Object.keys(this.state),c=b.length-1;c>=0;c--)a+=this.state[b[c]].numWaiting();return a},onUpdate:function(a){for(var b=this.completed.length-1;b>=0;b--)if(this.completed[b].onUpdate(a)){var c=this.completed.splice(b,1)[0];this._emitCompleted(c)}},track:function(a){var b=a.tile;if(!b)return void this.log.error("Received request with empty tile",a.uuid);var c=this._get(b).track(a);this._set(b,c),this._dumpState()},remove:function(a){var b=a.tile;if(!b)return void this.log.error("Received request with empty tile",a.uuid);var c=this._get(b).remove(a);this._set(b,c),this._dumpState()},trackBuildings:function(a,b,c){for(var d=this._getBuildings(a,b),e=c.length-1;e>=0;e--){var a=c[e].id||c[e].Id;"string"==typeof a&&d.features.push(a)}},hasBuilding:function(a,b){for(var c=this.buildings.length-1;c>=0;c--)if(this.buildings[c].contains(a,b))return!0;return!1},removeBuildings:function(a){for(var b=this.buildings.length-1;b>=0;b--)if(this.buildings[b].id===a)return void this.buildings.splice(b,1)}}),MeshmoonGeoEnvironment=ITundraPlugin.$extend({__init__:function(a){this.geoPlugin=a,this.log=this.geoPlugin.log,this.skyBoxTextures=[],this.skyBoxMesh=null,this.skyBoxMaterial=null,this.skyBoxTexturesLoaded=!1},createSkyBox:function(a){if(!a||6!=a.length)return this.log.error("createSkyBox: Skybox needs 6 textures."),!1;this.skyBoxTextures=[],this.skyBoxTexturesLoaded=!1;for(var b=function(a){a&&a.parentEntity&&a.parentEntity.removeComponent(a.id)},c=Tundra.scene.components("Sky"),d=0;d<c.length;d++)b(c[d]);c=Tundra.scene.components("SkyX");for(var d=0;d<c.length;d++)b(c[d]);c=Tundra.scene.components("MeshmoonSky");for(var d=0;d<c.length;d++)b(c[d]);for(var d=0;d<a.length;++d){Tundra.asset.forgetAsset(a[d],!0);var e=Tundra.asset.requestAsset(a[d]);this.changeProxyRef(e),null!=e&&e.onCompleted(this,this.onSkyTextureLoaded,d)}},changeProxyRef:function(a){a.proxyRef=a.proxyRef.replace("type=.dds","type=.png"),a.proxyMetadata.type=".png"},updateSkyBox:function(){if(6==this.skyBoxTextures.length){for(var a=[],b=0;6>b;++b)a.push(this.skyBoxTextures[b].texture.image);var c=new THREE.CubeTexture(a);c.flipY=!1,c.needsUpdate=!0,null!=this.skyBoxMesh&&(Tundra.renderer.scene.remove(this.skyBoxMesh),this.skyBoxMesh=null,this.skyBoxMaterial=null);var d=MeshmoonGeoShaders.Sky,e=THREE.UniformsUtils.clone(d.uniforms);this.skyBoxMaterial=new THREE.ShaderMaterial({fragmentShader:d.fragmentShader,vertexShader:d.vertexShader,uniforms:e,depthTest:!1,depthWrite:!1,side:THREE.BackSide}),this.skyBoxMaterial.uniforms.cubeMap.value=c,this.skyBoxMaterial.uniforms.horizonColor.value.set(247/255,245/255,242/255),this.skyBoxMesh=new THREE.Mesh(new THREE.BoxGeometry(500,500,500,1,1,1),this.skyBoxMaterial),this.skyBoxMesh.renderDepth=-1e6,this.skyBoxMesh.matrixAutoUpdate=!1,this.skyBoxMesh.frustumCulled=!1,this.skyBoxMesh.matrixWorld.identity(),Tundra.renderer.scene.add(this.skyBoxMesh),void 0===this.frameUpdateSubscription&&(this.frameUpdateSubscription=Tundra.frame.onPreRender(this,this.onPreRender))}},onSkyTextureLoaded:function(a,b){this.skyBoxTextures[b]=a;for(var c=0;6>c;c++)if(void 0===this.skyBoxTextures[c]||null===this.skyBoxTextures[c])return;this.skyBoxTexturesLoaded=!0,this.updateSkyBox()},onPreRender:function(){if(null!=this.skyBoxMesh){var a=Tundra.renderer.activeCameraEntity(),b=a?a.camera.camera:void 0;if(b){var c=b.projectionMatrix;void 0===this.viewMatrix&&(this.viewMatrix=new THREE.Matrix4);var d=b.parent.quaternion.clone().inverse();this.viewMatrix.makeRotationFromQuaternion(d),this.skyBoxMesh.matrixWorld.multiplyMatrices(c,this.viewMatrix)}}}}),MeshmoonGeoMetaData=Class.$extend({__init__:function(a){this.plugin=a,this.metadata={}},set:function(a,b,c){var d=a.uuid+("string"==typeof b&&""!==b?"_"+b:"");this.metadata[d]=c},get:function(a,b){if(!a.object||!a.object.geometry||!a.object.geometry.tile)return void 0;var c=a.indices[0],d=a.object.geometry.attributes.buildingIndex.array[c],e=a.object.geometry.tile.uuid+("string"==typeof b&&""!==b?"_"+b:""),f=this.metadata[e];return f&&Array.isArray(f.array)?f.array[d]:void 0},remove:function(a,b){var c=a.uuid+("string"==typeof b&&""!==b?"_"+b:"");void 0!==this.metadata[c]&&delete this.metadata[c]}}),MeshmoonGeoPlugin=ITundraPlugin.$extend({__init__:function(){this.$super("MeshmoonGeoPlugin"),this.config={debug:!1,debugVolume:!1,tileSize:256,scale:1,maxDistance:3e5,zoomLevels:[{size:4,zoom:16},{size:2,zoom:15},{size:2,zoom:14},{size:2,zoom:13,buildings:!1},{size:1,zoom:12,buildings:!1},{size:1,zoom:11,buildings:!1},{size:1,zoom:10,buildings:!1},{size:4,zoom:9,buildings:!1}]},this.Classes={IMeshmoonGeoService:IMeshmoonGeoService,IMeshmoonGeoLoader:IMeshmoonGeoLoader},this.running=!1,this.services=[],this.loaders=[],this.visuals=new MeshmoonGeoVisuals(this),this.metadata=new MeshmoonGeoMetaData(this),this.chainer=new MeshmoonGeoServiceChainer(this),this.tracker=new MeshmoonGeoGridAssetTracker(this),this.location=new MeshmoonGeoLocation(this),this.mapLayers=new MeshmoonGeoMapLayers(this),this.grid=new MeshmoonGeoTileGrid(this,this.config),this.env=new MeshmoonGeoEnvironment(this),Object.defineProperties(this,{coordinates:{get:function(){return this.grid.crs}}}),this._animations={}},pluginPropertyName:function(){return"meshmoonGeo"},postInitialize:function(){Tundra.client.onDisconnected(this,this.stop),this.registerLoader(new MeshmoonGeoBuildings2DLoader),this.registerService(new MeshmoonGisService),this.registerService(new MapZenService),this.registerService(new MapBoxService),this.onActiveTileChanged(this,function(){this.location.updateLocation(void 0,void 0,!0)})},registerLoader:function(a){return a instanceof IMeshmoonGeoLoader?void 0!==this.loader(a.name)?(this.log.error("registerLoader: Loader with name '"+a.name+"' already registered"),!1):(this.loaders.push(a),this.log.debug("Registered loader",a.name),!0):(this.log.error("registerLoader: Given loader is not an instance of IMeshmoonGeoLoader"),!1)},loader:function(a){if("string"!=typeof a||""===a)return void 0;for(var b=0;b<this.loaders.length;b++)if(this.loaders[b].supports(a))return this.loaders[b];return void 0},loaderForRequest:function(a){if("object"!=typeof a)return void 0;if(!this.mapLayers.isValidLayer(a.data))return this.loader(a.type);for(var b=0;b<this.loaders.length;b++)if(this.loaders[b].supportsLayer(a.data))return this.loaders[b];return void 0},registerService:function(a){return a instanceof IMeshmoonGeoService?void 0!==this.service(a.name)?(this.log.error("registerService: Service with name '"+a.name+"' already registered"),!1):(this.services.push(a),this.log.debug("Registered service",a.name),!0):(this.log.error("registerService: Given service is not an instance of IMeshmoonGeoService"),!1)},service:function(a){for(var b=0;b<this.services.length;b++)if(this.services[b].name===a)return this.services[b];return void 0},servicesForType:function(a){for(var b=[],c=0;c<this.services.length;c++)this.services[c].supports(a)&&b.push(this.services[c]);
return b},tileAboutToBeDestroyed:function(a){try{for(var b=0;b<this.services.length;b++)this.services[b].tileAboutToBeDestroyed(a)}catch(c){console.error("tileAboutToBeDestroyed:",c)}},onStarted:function(a,b,c){return Tundra.events.subscribe("MeshmoonGeoPlugin.Started",a,b,c)},onStopped:function(a,b,c){return Tundra.events.subscribe("MeshmoonGeoPlugin.Stopped",a,b,c)},setupEnvironment:function(){var a="http://meshmoon.data.s3.amazonaws.com/asset-library/skybox/default/rex_sky_",b=[a+"right.dds",a+"left.dds",a+"top.dds",a+"bot.dds",a+"front.dds",a+"back.dds"];this.env.createSkyBox(b)},toggleDebugging:function(){this.setDebugEnabled(!this.config.debug)},setDebugEnabled:function(a,b){a="boolean"==typeof a?a:this.config.debug,b="boolean"==typeof b?b:this.config.debugVolume,(this.config.debug!==a||this.config.debugVolume!==b)&&(this.config.debug=a,this.config.debugVolume=b,this.running&&(this.grid.setDebugEnabled($.extend(!0,{},this.config)),this.config.debug&&this.setStatsWidgetVisible(!0)))},toggleStatsWidget:function(){this.appStats?this.setStatsWidgetVisible("boolean"==typeof this.appStats.hidden?this.appStats.hidden:!0):this.setStatsWidgetVisible(!0)},setStatsWidgetVisible:function(a){this._createStatsWidget(),this.appStats&&(this.appStats.hidden=!a)},_createStatsWidget:function(){Tundra.usingPolymer()&&void 0===this.appStats&&Tundra.asset.loadDependencies(void 0,"webrocket://elements/meshmoon-geo-stats.html").done(function(){this.appStats=document.createElement("meshmoon-geo-stats"),Tundra.ui.addToCorner(this.appStats,Tundra.ui.$class.Corner.TopRight,Tundra.ui.$class.Position.End)}.bind(this))},start:function(a,b){if(this.running)return void this.log.error("start called when already running");this.running=!0,void 0===b&&"object"==typeof a&&"number"==typeof a.lon&&"number"==typeof a.lat&&(b=a.lat,a=a.lon);var c=performance.now();this.log.debug("starting",a,b),this.chainer.start(),this.mapLayers.start();for(var d=0;d<this.services.length;d++)this.services[d]._start();for(var d=0;d<this.loaders.length;d++)this.loaders[d]._start();this.grid.setConfig(this.config),this.grid.createGrid(a,b);for(var d=0;d<this.services.length;d++)this.services[d]._gridStarted(this.grid);for(var d=0;d<this.loaders.length;d++)this.loaders[d]._gridStarted(this.grid);this.frameSub&&this.frameSub.isActive()||(this.frameSub=Tundra.frame.onUpdate(function(a){if(this.running){var b=Tundra.renderer.activeCameraWorldPosition(),c=Tundra.renderer.activeCameraWorldFocusPosition();this.location.onUpdate(a,b,c),this.grid.onUpdate(a,b,c),this.tracker.onUpdate(a)}}.bind(this))),this.config.debug&&this.setStatsWidgetVisible(!0),this.log.debug("start done",(performance.now()-c).toFixed(2),"msec"),Tundra.events.send("MeshmoonGeoPlugin.Started",$.extend({},this.grid.originLatLon),$.extend(!0,{},this.config))},stop:function(){if(this.running){this.running=!1;var a=performance.now();this.log.debug("stopping"),this._animations&&this._animations.buildings&&this._animations.buildings.isPlaying()&&(this._animations.buildings.stop(),this._animations.buildings=void 0),this.frameSub&&(this.frameSub.reset(),this.frameSub=void 0),this.mapLayers.stop(),this.chainer.stop();for(var b=0;b<this.services.length;b++)this.services[b]._stop();for(var b=0;b<this.loaders.length;b++)this.loaders[b]._stop();this.grid.destroy(),this.log.debug("stop done",(performance.now()-a).toFixed(2),"msec"),Tundra.events.send("MeshmoonGeoPlugin.Stopped"),this.appStats&&($(this.appStats).remove(),this.appStats=void 0)}},getOriginCoordinates:function(){return this.running?$.extend({},this.grid.originLatLon):{lon:0,lat:0}},setBuildingsVisible:function(a,b){if(this.running){b="boolean"==typeof b?b:!1,this.clearFocus();var c=this.grid.buildings();if(b){this._animations&&this._animations.buildings&&this._animations.buildings.isPlaying()&&(this._animations.buildings.stop(),this._animations.buildings=void 0);for(var d=0,e=0;e<c.length;e++)c[e].geometry&&c[e].geometry.boundingBox&&(d=Math.max(d,c[e].geometry.boundingBox.size().y));var f=1e-6;if(a)for(var e=0;e<c.length;e++)c[e].scale.y=f,c[e].visible=!0;this._animations.buildings=new TWEEN.Tween({y:a?f:1}).easing(TWEEN.Easing.Cubic.InOut).to({y:a?1:f},1e3).onUpdate(function(){for(var a=0;a<c.length;a++)c[a].scale.y=this.y}).onComplete(function(b){if(!a)for(var d=0;d<c.length;d++)c[d].visible=!1}),this._animations.buildings.start()}else for(var e=0;e<c.length;e++)c[e].visible=a}},setFeatureEnabled:function(a,b){if("string"!=typeof a)return void this.log.error("setFeatureEnabled: Invalid feature type:",a,b);if("boolean"!=typeof b)return this.log.error("setFeatureEnabled: Invalid enabled type:",a,b),!1;for(var c=0;c<this.services.length;c++)this.services[c].setFeatureEnabled(a,b);return this.grid.setFeatureEnabled(a,b),!0},setFocus:function(a){this.running&&this.grid&&this.grid.buildingShader&&this.grid.buildingShader.SetPosition(a)},clearFocus:function(){this.running&&this.grid&&this.grid.buildingShader&&this.grid.buildingShader.ClearPosition()},focusAreaContains:function(a){return this.running&&this.grid&&this.grid.buildingShader?this.grid.buildingShader.RadiusContains(a):!1},focusAreaAnimating:function(){return this.running&&this.grid&&this.grid.buildingShader?this.grid.buildingShader.IsAnimating():!1},onActiveTileChanged:function(a,b,c){return Tundra.events.subscribe("MeshmoonGeoPlugin.ActiveTileChanged",a,b,c)}});Tundra.registerPlugin(new MeshmoonGeoPlugin);var GoogleMapsPlugin=ITundraPlugin.$extend({__init__:function(){this.$super("GoogleMapsPlugin"),this._timing=new AsyncHelper("GoogleMaps",this),this.geocoding.log=TundraLogging.getLogger("GoogleMapsPlugin.Geocoding"),this.librariesLoaded=!1},__classvars__:{API_KEY:"AIzaSyDM0JrFR5rOV1Ig5ibM7ESj5fYaw-apqJc",API_KEY_SERVER:"AIzaSyBS5dY0_yyy4D7nObyerrtTLdcShw7I5rg",Geocoding:{Type:{POI:"point_of_interest",POI_Airport:"airport",POI_Park:"park",POI_Route:"route",POI_Intersection:"intersection",StreetAddress:"street_address",Neighborhood:"neighborhood",PostalCode:"postal_code",AdministrativeAreaLevel_1:"administrative_area_level_1",AdministrativeAreaLevel_2:"administrative_area_level_2",AdministrativeAreaLevel_3:"administrative_area_level_3",AdministrativeAreaLevel_4:"administrative_area_level_4",AdministrativeAreaLevel_5:"administrative_area_level_5",Country:"country"},Status:{OK:"OK",ZeroResults:"ZERO_RESULTS",OverQueryLimit:"OVER_QUERY_LIMIT",RequestDenied:"REQUEST_DENIED",InvalidRequest:"INVALID_REQUEST",UnknownError:"UNKNOWN_ERROR"}}},pluginPropertyName:function(){return"googleMaps"},postInitialize:function(){window.GoogleMapsPluginDependenciesLoaded=this._onLibraryLoaded.bind(this);var a="https://maps.googleapis.com/maps/api/js?key="+GoogleMapsPlugin.API_KEY+"&libraries=places&callback=GoogleMapsPluginDependenciesLoaded";Tundra.asset.loadScript(a).fail(function(){this.log.error("Failed to load Google Maps library dependency. Functionality will be limited.")}.bind(this))},_onLibraryLoaded:function(){this.librariesLoaded=!0},placesNearBy:function(a,b){if("number"!=typeof a.lat||"number"!=typeof a.lon)return void this.log.error("places: Invalid coordinates:",a);if("number"!=typeof b)return void this.log.error("places: Invalid radiusMeters:",b);var c={key:GoogleMapsPlugin.API_KEY_SERVER,location:a.lat.toString()+","+a.lon,radius:b.toString()},d="https://maps.googleapis.com/maps/api/place/nearbysearch/json"+CoreStringUtils.createQueryString(c,!1);return this._timing.defer(d,function(){var a=Tundra.asset.requestAsset(d,".json");a.onCompleted(this,function(a){this._timing.resolve(d,!0,a.data)}),a.onFailed(this,function(){this._timing.resolve(d,!1)})}.bind(this))},placeDetails:function(a){if("string"!=typeof a)return void this.log.error("places: Invalid placeId:",a);var b={key:GoogleMapsPlugin.API_KEY_SERVER,placeid:a},c="https://maps.googleapis.com/maps/api/place/details/json"+CoreStringUtils.createQueryString(b,!1);return this._timing.defer(c,function(){var a=Tundra.asset.requestAsset(c,".json");a.onCompleted(this,function(a){this._timing.resolve(c,!0,a.data)}),a.onFailed(this,function(){this._timing.resolve(c,!1)})}.bind(this))},geocoding:{reverse:function(a,b){if("number"!=typeof a.lat||"number"!=typeof a.lon)return void this.log.error("reverse: Invalid coordinates:",a);var c={key:GoogleMapsPlugin.API_KEY,latlng:a.lat.toString()+","+a.lon};return"string"==typeof b&&(c.result_type=b),$.getJSON("https://maps.googleapis.com/maps/api/geocode/json",c)},reverseInside:function(a,b,c){if("number"!=typeof a.lat||"number"!=typeof a.lon)return void this.log.error("reverseInside: Invalid southwest coordinates:",a);if("number"!=typeof b.lat||"number"!=typeof b.lon)return void this.log.error("reverseInside: Invalid southwest coordinates:",b);if("string"!=typeof c&&!Array.isArray(c))return void this.log.error("reverseInside: Invalid southwest coordinates:",b);var d={key:GoogleMapsPlugin.API_KEY,latlng:a.lat.toString()+","+a.lon+"|"+b.lat.toString()+","+b.lon,components:Array.isArray(c)?c.join("|"):c};return $.getJSON("https://maps.googleapis.com/maps/api/geocode/json",d)},findResults:function(a,b){a=Array.isArray(a)?a:[a];for(var c=[],d=0;d<a.length;d++)for(var e=a[d],f=0;f<e.types.length;f++)"type"===e.types[f]&&c.push(e);return c},findAddressComponent:function(a,b){a=Array.isArray(a)?a:[a];for(var c=0;c<a.length;c++){var d=a[c].address_components;if(Array.isArray(d)){for(var e=0;e<d.length;e++)for(var f=d[e].types,g=0;g<f.length;g++)if(f[g]===b)return"string"==typeof d[e].long_name&&""!==d[e].long_name?d[e].long_name:"string"==typeof d[e].short_name&&""!==d[e].short_name?d[e].short_name:void this.log.warn("Failed to find long_name or short_name from address component:",d[e])}else this.log.error("findAddressComponent: 'result' at index",c,"does not have 'address_components'")}return void 0}}});Tundra.registerPlugin(new GoogleMapsPlugin);var RocketPlugin=ITundraPlugin.$extend({__init__:function(){this.$super("RocketPlugin",["Rocket"])},pluginPropertyName:function(){return"rocket"},initialize:function(a){this.options=$.extend({proxyURL:"proxy.meshmoon.com"},a),this.permissions=new MeshmoonPermissions,this.users=new MeshmoonUsers,this.space=new MeshmoonSpace,this.layers=new RocketLayerManager,this.prioritizer=new MeshmoonAssetPrioritizer(this.framework),this.proxyResolver=new MeshmoonProxyResolver(this.options.proxyURL),this.framework.asset.setHttpProxyResolver(this.proxyResolver),this.framework.asset.registerAssetFactory(new AssetFactory("ObjMesh",ObjMeshAsset,{".obj":"text"})),this.framework.asset.registerAssetFactory(new AssetFactory("OgreMesh",OgreMeshAsset,{".mesh":"arraybuffer",".mesh.xml":"xml"})),this.framework.asset.registerAssetFactory(new AssetFactory("MeshmoonMesh",MeshmoonMeshAsset,{".mme":"arraybuffer"})),this.framework.asset.registerAssetFactory(new AssetFactory("OgreSkeleton",OgreSkeletonAsset,{".skeleton":"arraybuffer",".skeleton.xml":"xml"})),this.framework.asset.registerAssetFactory(new AssetFactory("OgreMaterial",OgreMaterialAsset,{".material":"text"})),this.framework.asset.registerAssetFactory(new AssetFactory("OgreParticle",OgreParticleAsset,{".particle":"text"})),this.framework.asset.registerAssetFactory(new AssetFactory("Texture",TextureAsset,{".dds":void 0,".crn":void 0,".png":void 0,".jpg":void 0,".jpeg":void 0,".bmp":void 0,".gif":void 0},"arraybuffer")),this.framework.asset.registerAssetFactory(new AssetFactory("Script",ScriptAsset,{".js":void 0,".webrocketjs":void 0},"text")),this.framework.asset.registerAssetFactory(new AssetFactory("RealXtendAvatarDescription",AvatarDescAsset,{".avatar":"xml"})),Tundra.asset.maxActiveTransfers=32,this.framework.network.registerMessageHandler(new MeshmoonMessageHandler),Scene.registerComponent(EC_RigidBody),Scene.registerComponent(EC_WebBrowser),Scene.registerComponent(EC_MeshmoonTeleport),Scene.registerComponent(EC_MeshmoonWater),Scene.registerComponent(EC_MeshmoonSky),Scene.registerComponent(EC_Meshmoon3DText),this.loadMeshmoonAssets(),this.framework.client.onConnected(this,function(){this.frameUpdateSub&&this.frameUpdateSub.reset(),this.frameUpdateSub=this.framework.frame.onUpdate(this,this.onUpdate)}),this.framework.client.onDisconnected(this,function(){this.permissions.reset(),this.permissions.resetEvents(),this.users.reset(),this.users.resetEvents()})},postInitialize:function(){void 0!==TextureAsset.__init__&&TextureAsset.__init__(this.framework),this.framework.client.domIntegration&&(this.framework.client.domIntegration.enabled=!1),Tundra.usingRequireJS()?this.tryEnableLocalhostProxy():this.tryEnableProxy(this.options.proxyURL)},tryEnableLocalhostProxy:function(){try{var a=!1,b="string"==typeof Tundra.DeveloperServerHost?Tundra.DeveloperServerHost:"127.0.0.1";this.tryEnableProxy(b+(a?"":":81"),a,!0).fail(function(){this.tryEnableProxy(this.options.proxyURL)}.bind(this))}catch(c){this.log.error("tryEnableLocalhostProxy: Exception while detecting localhost proxy:",c)}return void 0},tryEnableProxy:function(a,b,c){return b!==!0||CoreStringUtils.startsWith(a,"https://",!0)||(a="https://"+a),CoreStringUtils.startsWith(a,"http",!0)||(a="http://"+a),CoreStringUtils.endsWith(a,"/")||(a+="/"),$.getJSON(a+"capabilities").done(function(b){this.proxyResolver=new MeshmoonProxyResolver(a,b,c),this.framework.asset.setHttpProxyResolver(this.proxyResolver),this.loadMeshmoonAssets()}.bind(this))},loadMeshmoonAssets:function(){if(null==this.framework.renderer.materialWhite||"RocketShaderLibrary.DefaultWhite"!==this.framework.renderer.materialWhite.name){var a=RocketShaderLibrary.createMeshmoonMaterial("meshmoon/Diffuse","DefaultWhite");null!=a&&(a.uniforms.diffuseMap.value=RocketShaderLibrary.getSolidColorTexture(241,241,241),this.framework.renderer.materialWhite=a)}if(null==this.framework.renderer.materialLoadError||"RocketShaderLibrary.LoadError"!==this.framework.renderer.materialLoadError.name){var b=Tundra.asset.requestAsset("webrocket://media/textures/MeshmoonErrorTexture.dds");null!=b&&b.onCompleted(this,function(a){var b=RocketShaderLibrary.createMeshmoonMaterial("meshmoon/Diffuse","LoadError");null!=b&&(a.texture.magFilter=THREE.NearestFilter,a.texture.minFilter=THREE.NearestFilter,b.uniforms.diffuseMap.value=a.texture,b.uniforms.diffuseMapTiling.value.set(5,5),this.framework.renderer.materialLoadError=b)})}},onUpdate:function(a){this.prioritizer._update(a)}});Tundra.registerPlugin(new RocketPlugin);var LoginScreenPlugin=ITundraPlugin.$extend({__init__:function(){this.$super("LoginScreenPlugin"),this.loginProperties={},this.ui={},this.loadingScreen=null,this.transfersPeak=0,this.transfersProgress=-1},__classvars__:{LoginControlsEnabled:!1,LoadingScreenEnabled:!1,LoadingScreenBackgroundTransparent:!1,LoadingScreenAutoUpdateAssetProgress:!0,LoadingScreenConnectingText:"Loading Scene",LoadingScreenHeaderText:"realXtend WebTundra",LoadingScreenHeaderLinkUrl:"https://github.com/realXtend/WebTundra"},initialize:function(a){"boolean"==typeof a.loginControlsEnabled&&(LoginScreenPlugin.LoginControlsEnabled=a.loginControlsEnabled),"boolean"==typeof a.loadingScreenEnabled&&(LoginScreenPlugin.LoadingScreenEnabled=a.loadingScreenEnabled),"boolean"==typeof a.transparentBackground&&(LoginScreenPlugin.LoadingScreenBackgroundTransparent=a.transparentBackground),"boolean"==typeof a.updateAssetProgress&&(LoginScreenPlugin.LoadingScreenAutoUpdateAssetProgress=a.updateAssetProgress),"string"==typeof a.connectingText&&(LoginScreenPlugin.LoadingScreenConnectingText=a.connectingText),"string"==typeof a.headerText&&(LoginScreenPlugin.LoadingScreenHeaderText=a.headerText),"string"==typeof a.headerLinkUrl&&(LoginScreenPlugin.LoadingScreenHeaderLinkUrl=a.headerLinkUrl),this.framework.client.onConnectionError(this,this.onConnectionError),this.framework.client.onConnected(this,this.onConnectedToServer),this.framework.client.onDisconnected(this,this.onDisconnectedFromServer),this.framework.asset.onActiveAssetTransferCountChanged(this,this.onActiveAssetTransferCountChanged),Tundra.usingPolymer()||this.framework.ui.onWindowResize(this,this.onWindowResized),this.createLoginControls(),this.showLoadingScreen(),setTimeout(this.onWindowResized.bind(this),100)},hide:function(){this.hideLoginControls(),this.hideLoadingScreen(!0)},createLoginControls:function(){if(LoginScreenPlugin.LoginControlsEnabled){if(Tundra.usingPolymer()){this.polymer={},this.polymer.controls=$("<div/>",{id:"webtundra-login-controls"}).attr({layout:"",vertical:"",center:"","start-justified":"",fit:""}),this.polymer.controls.css({"pointer-events":"none","font-weight":300,"z-index":Tundra.ui.topZIndex()+1,"margin-top":160}),this.polymer.inputs=$("<div/>").attr({layout:"",horizontal:"",center:"","center-justified":""}),this.polymer.inputs.css({"pointer-events":"auto"});var a=function(a,b,c){var d=document.createElement("paper-input-decorator");d.label=b;var e=document.createElement("input");return e.id=a,e.value=c,d.style.fontSize="20px",d.style.padding="0.75em 1em",d.appendChild(e),d};return this.polymer.inputHost=a("login-host","Host",("string"==typeof Tundra.DeveloperServerHost?Tundra.DeveloperServerHost:"127.0.0.1")+":2345"),this.polymer.inputUsername=a("login-username","Username",CoreStringUtils.queryValue("username")||"Meshmoon Developer"),this.polymer.buttonLogin=document.createElement("paper-button"),this.polymer.buttonLogin.raised=!0,this.polymer.buttonLogin.innerText="Login",$(this.polymer.buttonLogin).css({"background-color":"steelblue",color:"white"}),this.ui.loginError=$("<div/>",{text:""}).css({color:"rgb(197, 54, 54)","font-size":20,"text-transform":"uppercase","font-weight":400,"margin-top":25}),this.polymer.inputs.append(this.polymer.inputHost,this.polymer.inputUsername,this.polymer.buttonLogin),this.polymer.controls.append(this.polymer.inputs,this.ui.loginError),Tundra.ui.add(this.polymer.controls),this.polymer.controls=this.polymer.controls.get(0),void this.polymer.buttonLogin.addEventListener("click",this.onToggleConnectionState.bind(this))}var b="string"==typeof Tundra.DeveloperServerHost?Tundra.DeveloperServerHost:"127.0.0.1",c=CoreStringUtils.queryValue("username")||"Meshmoon Developer";this.ui.loginControls=$("<div/>",{id:"login-controls"}),this.ui.loginHost=$("<input/>",{id:"login-host",type:"text",value:"ws://"+b+":2345"}),this.ui.loginUsername=$("<input/>",{id:"login-username",type:"text",value:c}),this.ui.loginError=$("<div/>",{id:"login-error",css:{padding:15,"font-size":16,color:"red"}}),this.ui.loginButton=$("<button/>",{id:"login-button",text:"CONNECT",css:{"font-size":12,"font-weight":"bold"}}).button(),this.ui.loginControls.css({position:"absolute",top:180,left:0,width:"100%",padding:10,border:0,"z-index":Tundra.ui.topZIndex()+1,"text-align":"center","font-family":"Arial","font-size":14,"font-weight":"bold","background-color":"transparent"});for(var d=[this.ui.loginHost,this.ui.loginUsername,this.ui.loginButton],e=0;e<d.length;e++)d[e].css({"min-width":100,"max-height":25,"margin-left":6,"margin-right":9,padding:d[e]===this.ui.loginButton?0:3,border:"1px solid lightgrey","border-radius":4});this.ui.loginControls.append(this.ui.loginHost),this.ui.loginControls.append(this.ui.loginUsername),this.ui.loginControls.append(this.ui.loginButton),this.ui.loginControls.append(this.ui.loginError),this.ui.loginControls.fadeIn(1e3),this.framework.ui.addWidgetToScene(this.ui.loginControls),this.ui.loginButton.click(this.onToggleConnectionState.bind(this))}},onToggleConnectionState:function(){this.ui.loginError.text(""),this.framework.client.isConnected()?this.framework.client.disconnect():(void 0===this.loginProperties&&(this.loginProperties={}),this.loginProperties.username=this.polymer?this.polymer.inputUsername.input.value:this.ui.loginUsername.val(),this.framework.client.connect(this.polymer?this.polymer.inputHost.input.value:this.ui.loginHost.val(),this.loginProperties))},onConnectionError:function(a){void 0!==this.ui.loginError&&this.ui.loginError.text("Failed to connect to "+a.target.url)},onConnectedToServer:function(){this.updateLoadingScreen(LoginScreenPlugin.LoadingScreenConnectingText,0),LoginScreenPlugin.LoginControlsEnabled&&(this.polymer?this.polymer.screen&&this.polymer.buttonHideScreen&&$(this.polymer.buttonHideScreen).show():(this.ui.loginHost.attr("disabled","disabled"),this.ui.loginUsername.attr("disabled","disabled"),this.ui.loginButton.button("option","label","Disconnect")),this.hideLoginControls(!1)),setTimeout(function(){this.isLoadingScreenVisible()&&this.framework.asset.allTransfersCompleted()&&(this.log.debug("Seems there are no pending asset transfers, hiding loading screen..."),this.hideLoadingScreen())}.bind(this),2500)},onDisconnectedFromServer:function(){this.showLoadingScreen(),LoginScreenPlugin.LoginControlsEnabled&&(this.polymer?this.polymer.screen&&this.polymer.buttonHideScreen&&$(this.polymer.buttonHideScreen).hide():(this.ui.loginHost.removeAttr("disabled"),this.ui.loginUsername.removeAttr("disabled"),this.ui.loginButton.button("option","label","Connect")),this.loginProperties={},this.showLoginControls())},showLoginControls:function(){return Tundra.usingPolymer()?void(this.polymer&&this.polymer.controls&&$(this.polymer.controls).fadeIn(1e3)):void(void 0!==this.ui.loginControls&&(this.ui.loginControls.fadeIn(1e3),this.onWindowResized()))},hideLoginControls:function(a){return Tundra.usingPolymer()?void(this.polymer&&this.polymer.controls&&$(this.polymer.controls).hide()):void(void 0!==this.ui.loginControls&&(void 0===a||a===!0?this.ui.loginControls.fadeOut(500):this.ui.loginControls.hide()))},isLoadingScreenVisible:function(){return null!=this.loadingScreen||this.polymer&&this.polymer.screen},showLoadingScreen:function(){if(Tundra.events.send("LoginScreenPlugin.Show"),LoginScreenPlugin.LoadingScreenEnabled){if(Tundra.usingPolymer()){if(this.polymer=this.polymer||{},this.polymer.screen)return;if(this.polymer.screen=$("<div/>",{id:"webtundra-login-screen"}).attr({layout:"",vertical:"",center:"","start-justified":"",fit:""}),this.polymer.screen.css({"pointer-events":"none","font-weight":300,"background-color":LoginScreenPlugin.LoadingScreenBackgroundTransparent?"transparent":"#F5F5F5","z-index":Tundra.ui.topZIndex()}),""!==LoginScreenPlugin.LoadingScreenHeaderText){var a=document.createElement("core-item");a.innerText=LoginScreenPlugin.LoadingScreenHeaderText,$(a).css({"pointer-events":"auto",color:"steelblue","font-size":56,"margin-top":70}).append($("<a/>",{href:LoginScreenPlugin.LoadingScreenHeaderLinkUrl,target:"_blank"})),this.polymer.screen.append(a)}this.polymer.progress=document.createElement("paper-progress"),this.polymer.progress.value=0,$(this.polymer.progress.$.activeProgress).css({"background-color":"orange"}),$(this.polymer.progress).css({width:300,"margin-top":15}).hide(),this.polymer.buttonHideScreen=document.createElement("paper-button"),this.polymer.buttonHideScreen.innerText="hide loading screen",$(this.polymer.buttonHideScreen).css({"pointer-events":"auto",position:"absolute",bottom:0,right:0}).click(function(){Tundra.client.isConnected()&&this.hideLoadingScreen()}.bind(this)).hide(),this.polymer.screen.append(this.polymer.text,this.polymer.progress,this.polymer.buttonHideScreen),Tundra.ui.add(this.polymer.screen)}else{if(null!=this.loadingScreen)return;if(this.loadingScreen={done:!1},this.transfersPeak=0,this.transfersProgress=-1,this.loadingScreen.screen=$("<div/>",{id:"webtundra-loading-screen"}),this.loadingScreen.screen.css({position:"absolute",width:"100%",height:"100%",top:0,left:0,"background-color":"rgb(248,248,248)","z-index":Tundra.ui.topZIndex()}),this.loadingScreen.screen.css("background-color",LoginScreenPlugin.LoadingScreenBackgroundTransparent?"transparent":"rgb(221,221,221)"),this.loadingScreen.text=$("<div/>",{id:"webtundra-loading-screen-label"}).css({color:"rgb(50,50,50)","text-align":"center","font-family":"Verdana","font-weight":"bold","font-size":36,"text-align":"center","vertical-align":"center","text-decoration":"none"}),""!==LoginScreenPlugin.LoadingScreenHeaderText){var b=$("<a/>",{text:LoginScreenPlugin.LoadingScreenHeaderText,href:LoginScreenPlugin.LoadingScreenHeaderLinkUrl,target:"_blank"});b.css({color:"rgb(50,50,50)","text-align":"center","font-family":"Verdana","font-weight":"bold","text-align":"center","vertical-align":"bottom","text-decoration":"none"}),this.loadingScreen.text.append(b)}this.loadingScreen.progress=$("<div/>",{id:"webtundra-loading-screen-progress"}),this.loadingScreen.progress.css({color:"rgba(50,50,50, 0.0)","text-align":"center","font-family":"Verdana","font-weight":"bold","font-size":"80pt","vertical-align":"center"}),this.loadingScreen.progress.hide(),this.loadingScreen.hideButton=$("<div/>",{id:"webtundra-loading-screen-hidebutton",html:"Hide Loading Screen"}),this.loadingScreen.hideButton.css({color:"rgba(50,50,50,0.6)","font-family":"Verdana","font-weight":"bold","font-size":"7pt",position:"absolute",cursor:"pointer",top:5,left:5}),this.loadingScreen.hideButton.click(function(a){""!=this.loadingScreen.progress.text()&&(this.hideLoadingScreen(),a.preventDefault(),a.stopPropagation())}.bind(this)),this.loadingScreen.screen.append(this.loadingScreen.hideButton),this.loadingScreen.screen.append(this.loadingScreen.text),this.loadingScreen.screen.append(this.loadingScreen.progress),this.framework.ui.addWidgetToScene(this.loadingScreen.screen),this.loadingScreen.text.hide(),this.loadingScreen.text.fadeIn(1e3),this.onWindowResized()}if(this.autoConnectedOnce!==!0){this.autoConnectedOnce=!0;var c=CoreStringUtils.queryValue("autoconnect");if(""!==c&&!isNaN(parseInt(c))){var d=parseInt(c);if(!(0>d)){var e=200>d?1e3*d:d,f=e/1e3;if(setTimeout(function(){Tundra.client.isConnected()||this.onToggleConnectionState()}.bind(this),e),f>=1){var g=$("<div/>",{html:"Auto connecting in <span style='color: steelblue;'>"+f+"</span>",css:{position:"absolute",top:"calc(100% - 100px)",left:0,width:"100%","text-align":"center","font-size":34,color:"#616161"}});this.polymer?(g.css("text-transform","uppercase"),this.polymer.screen.append(g)):this.loadingScreen.screen.prepend(g);var h=setInterval(function(){f--,g.html("Auto connecting in <span style='color: steelblue;'>"+f+"</span>"),0>=f&&(g.remove(),g=null,clearInterval(h))},1e3)}}}}}},updateLoadingScreen:function(a,b){if(Tundra.client.isConnected()&&(Tundra.events.send("LoginScreenPlugin.ProgressUpdate",b),LoginScreenPlugin.LoadingScreenEnabled))if(this.polymer)$(this.polymer.progress).is(":visible")||$(this.polymer.progress).fadeIn(),this.polymer.progress.value=b,b>=100&&$(this.polymer.progress).fadeOut();else{if(null==this.loadingScreen||this.loadingScreen.done)return;if(null!=a&&null!=this.loadingScreen.text&&this.loadingScreen.text.text(a),null!=b&&null!=this.loadingScreen.progress){if(void 0!==this.loadingScreen.completedOnce&&this.loadingScreen.completedOnce===!0)return;var c=this.loadingScreen.progress.is(":visible");if(100>b){var d=b/100;d>.9&&(d=.9),this.loadingScreen.progress.html(b+"<span style='font-size: 20pt;color:rgba(50,50,50,"+d+");'>%</span>"),this.loadingScreen.progress.css("color","rgba(242,154,41, "+d+")")}else this.loadingScreen.completedOnce=!0,this.loadingScreen.text.html("Loading completed<br><span style='color:rgba(50,50,50, 0.4);font-size: 28pt';>Please wait</span>"),this.loadingScreen.progress.text(""),this.loadingScreen.progress.hide(),this.onWindowResized();c||(this.loadingScreen.progress.show(),this.onWindowResized())}}},hideLoadingScreen:function(a){return this.transfersPeak=0,this.transfersProgress=-1,void 0===a&&(a=!1),a||Tundra.client.isConnected()?(Tundra.events.send("LoginScreenPlugin.Hide"),Tundra.usingPolymer()?void(this.polymer&&this.polymer.screen&&this.polymer.screen.fadeOut(500,function(){this.polymer.screen.remove(),this.polymer.screen=null}.bind(this))):void(null==this.loadingScreen||this.loadingScreen.done||(this.loadingScreen.done=!0,this.loadingScreen.hideButton.remove(),this.loadingScreen.screen.fadeOut(500,function(){this.loadingScreen.screen.remove(),this.loadingScreen.screen=null,this.loadingScreen=null,this.onWindowResized()}.bind(this))))):void 0},onWindowResized:function(a,b){Tundra.usingPolymer()||(b=b||Tundra.ui.height(),null==this.loadingScreen||this.loadingScreen.done||(this.loadingScreen.text.position({my:"left top",at:"left top+"+(b>500?100:50),of:this.loadingScreen.screen}),this.loadingScreen.progress.position({my:"left top",at:"left bottom+25",of:this.loadingScreen.text}),null!=this.ui.loginControls&&this.ui.loginControls.position({my:"left top",at:"left bottom",of:this.loadingScreen.text})))},onActiveAssetTransferCountChanged:function(a){if(LoginScreenPlugin.LoadingScreenEnabled){if(this.transfersPeak<a&&(this.transfersPeak=a),LoginScreenPlugin.LoadingScreenAutoUpdateAssetProgress&&this.transfersPeak>0){var b=Number(100-a/this.transfersPeak*100);b>this.transfersProgress&&(this.transfersProgress=b,this.updateLoadingScreen(null,b.toFixed(0)))}0===a&&setTimeout(function(){this.framework.asset.allTransfersCompleted()&&this.hideLoadingScreen()}.bind(this),200)}}});Tundra.registerPlugin(new LoginScreenPlugin);var GPickerPlugin=ITundraPlugin.$extend({__classvars__:{AllFiles:Math.pow(2,0),Images:Math.pow(2,1),ImageSearch:Math.pow(2,2),Documents:Math.pow(2,3),Drawings:Math.pow(2,4),Presentations:Math.pow(2,5),Spreadsheets:Math.pow(2,6),Forms:Math.pow(2,7),ImagesAndVideos:Math.pow(2,8),Videos:Math.pow(2,9),VideoSearch:Math.pow(2,10),YouTube:Math.pow(2,11),Folders:Math.pow(2,12),PDFs:Math.pow(2,13),RecentItems:Math.pow(2,14),Upload:Math.pow(2,15),FILE:{Folder:"application/vnd.google-apps.folder",Document:"application/vnd.google-apps.document",Drawing:"application/vnd.google-apps.drawing",Presentation:"application/vnd.google-apps.presentation",Spreadsheet:"application/vnd.google-apps.spreadsheet"}},__init__:function(){this.$super("GoogleDrive",["GooglePicker"]),this._timing=new AsyncHelper("GoogleDrive",this),this.type=0,this.pickerApiLoaded=!1,this.authApiLoaded=!1,this.driveApiLoaded=!1,this.recreatePicker=!1,this.pickerRequested=!1,this.oauthToken=null,this.picker=null,this.callbacks={},this.tokenInfoUrl="https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=",this.tokenRevokeUrl="https://accounts.google.com/o/oauth2/revoke?token=",this.developerKey="AIzaSyDM0JrFR5rOV1Ig5ibM7ESj5fYaw-apqJc",this.clientId="1005214998651-a9k1o2ubkk3tdca1j9etf6lqsfvcqv96.apps.googleusercontent.com",this.scopeDriveRW=["https://www.googleapis.com/auth/drive"],this.scopeDriveRO=[this.scopeDriveRW+".readonly"],this.scopeDriveBroad=["https://www.googleapis.com/auth/plus.me","https://www.googleapis.com/auth/drive","https://www.googleapis.com/auth/drive.readonly","https://www.googleapis.com/auth/drive.file","https://www.googleapis.com/auth/drive.metadata.readonly","https://www.googleapis.com/auth/drive.appfolder"].join(" "),this.workingFolderName="Meshmoon Project space"},pluginPropertyName:function(){return"googleDrive"},postInitialize:function(){this.polymer=Tundra.usingPolymer()?{}:void 0,this._loadDependencies()},_loadDependencies:function(){void 0===window.gapi||null===window.gapi?Tundra.asset.loadScript("https://apis.google.com/js/api.js").done(function(){this._gapiLoaded()}.bind(this)).fail(function(){this.log.error("Failed to load library dependency from https://apis.google.com/js/api.js. Cannot start application.")}.bind(this)):this._gapiLoaded()},_gapiLoaded:function(){void 0===gapi.client||null===gapi.client?Tundra.asset.loadScript("https://apis.google.com/js/client.js").done(function(){setTimeout(function(){this.dependenciesLoaded()}.bind(this),1e3)}.bind(this)).fail(function(){this.log.error("Failed to load library dependency from https://apis.google.com/js/client.js. Cannot start application.")}.bind(this)):this.dependenciesLoaded()},dependenciesLoaded:function(){gapi.load("auth",{callback:function(){this.authApiLoaded=!0}.bind(this)}),gapi.load("picker",{callback:function(){this.pickerApiLoaded=!0}.bind(this)}),gapi.load("drive-share",{callback:function(){this.driveShareApiLoaded=!0}.bind(this)}),gapi.client.load("drive","v2",function(){this.driveApiLoaded=!0}.bind(this)),gapi.client.load("plus","v1",function(){
this.plusApiLoaded=!0}.bind(this)),this.canAutoAuthorize().done(function(a){this._canAutoAuthorize=a}.bind(this))},openFilePickerDialog:function(a,b,c,d){if(!this.pickerRequested){if(this.pickerRequested=!0,b=$.extend({ownedByMe:!0},b),0>=a)return Tundra.client.logError("[GooglePicker]: Invalid type: "+a),void(this.pickerRequested=!1);if(this.type!==a&&(this.recreatePicker=!0,this.type=a),this.storeCallback("picker",c,d),this.type===GPickerPlugin.ImageSearch||this.type===GPickerPlugin.VideoSearch||this.type===(GPickerPlugin.ImageSearch|GPickerPlugin.VideoSearch))this._showPicker(this.type,!1,b),this.pickerRequested=!1;else{var e=!this.containsFlag(this.type,GPickerPlugin.Upload);this._validateToken(e,function(a){var c=function(c){var d={action:""};if(b.initialFolder=c||void 0,"tokenValid"===a)return this._showPicker(this.type,!0,b),void(this.pickerRequested=!1);if(a){if(!a.error)return this.setToken(a),this._showPicker(this.type,!0,b),void(this.pickerRequested=!1);d.action="autherror"}else d.action="authcancel";this.executeCallback("picker",d),this.pickerRequested=!1}.bind(this);"string"==typeof b.initialFolder&&""!==b.initialFolder?this._getOrCreateFolderByName(b.initialFolder,c):c()})}}},openSharingDialog:function(a){if(!this.driveShareApiLoaded)return!1;var b=new gapi.drive.share.ShareClient("1005214998651");return b.setItemIds(Array.isArray(a)?a:[a]),b.showSettingsDialog(),!0},getToken:function(){return gapi.auth.getToken()},setToken:function(a){this.oauthToken=a},showPicker:function(){null!=this.picker&&this.picker.setVisible(!0)},hidePicker:function(){null!=this.picker&&this.picker.setVisible(!1)},revokeToken:function(){var a=this.getToken();null!==a&&$.get(this.tokenRevokeUrl+a.access_token,function(a){})},createNewFile:function(a,b,c,d){if(this.driveApiLoaded){this.storeCallback("newFile",c,d);var e=this.callbacks.newFile.context,f=this.callbacks.newFile.callback;this._validateToken(!1,function(c){var d={action:""};if("tokenValid"===c)return void this._insertFileRequest(a,b,e,f);if(c){if(!c.error)return this.setToken(c),void this._insertFileRequest(a,b,e,f);d.action="autherror"}else d.action="authcancel";f.call(e,d)})}},getFileInfo:function(a,b,c){this.driveApiLoaded&&(this.storeCallback("getFile",b,c),this._validateToken(!1,function(b){var c={action:""};if("tokenValid"===b)return void this._getFileRequest(a);if(b){if(!b.error)return this.setToken(b),void this._getFileRequest(a);c.action="autherror"}else c.action="authcancel";this.executeCallback("getFile",c)}))},getFilesForFolder:function(a,b,c){this.driveApiLoaded&&(this.storeCallback("filesForFolder",b,c),this._validateToken(!0,function(b){var c={action:""};if("tokenValid"===b)return void this._getFilesForFolderByNameRequest(a);if(b){if(!b.error)return this.setToken(b),void this._getFilesForFolderByNameRequest(a);c.action="autherror"}else c.action="authcancel";this.executeCallback("filesForFolder",c)}))},getFilesForFolderById:function(a,b,c){if(this.driveApiLoaded){this.storeCallback("filesForFolder",b,c);var d=function(a){this.executeCallback("filesForFolder",{action:"filesforfolder",files:a})};this._validateToken(!0,function(b){var c={action:""};if("tokenValid"===b)return void this._getFilesForFolderRequest(a,d.bind(this));if(b){if(!b.error)return this.setToken(b),void this._getFilesForFolderRequest(a,d.bind(this));c.action="autherror"}else c.action="authcancel";this.executeCallback("filesForFolder",c)})}},_getFilesForFolderByNameRequest:function(a){this._getFolderByName(a,function(a){""!=a&&void 0!=a?this._getFilesForFolderRequest(a,function(a){this.executeCallback("filesForFolder",{action:"filesforfolder",files:a})}.bind(this)):this.executeCallback("filesForFolder",{action:"getfoldererror"})}.bind(this))},_getFilesForFolderRequest:function(a,b){var c=function(d,e){d.execute(function(f){e=e.concat(f.items);var g=f.nextPageToken;g?(d=gapi.client.drive.files.list({q:"'"+a+"' in parents",pageToken:g}),c(d,e)):b.call(null,e)})},d=gapi.client.drive.files.list({q:"'"+a+"' in parents"});c(d,[])},storeCallback:function(a,b,c){this.callbacks[a]={},this.callbacks[a].context=null,this.callbacks[a].callback=null,void 0!==c&&null!==c?(this.callbacks[a].context=b,this.callbacks[a].callback=c):"function"!=typeof b||void 0!==c&&null!==c||(this.callbacks[a].context=null,this.callbacks[a].callback=b)},executeCallback:function(a,b){var c=this.callbacks[a].context,d=this.callbacks[a].callback;null!==d&&d.call(c,b)},_insertFileRequest:function(a,b,c,d){this._getOrCreateFolderByName(this.workingFolderName,function(e){""!==e&&this._newFileRequest(a,b,e,c,d)}.bind(this))},_newFileRequest:function(a,b,c,d,e){(null===c||void 0===c)&&(c="root");var f={action:""},g=gapi.client.request({path:"/drive/v2/files",method:"POST",body:{mimeType:a,title:b,description:"Meshmoon WebRocket generated document",parents:[{id:c}]}});g.execute(function(b){if(b.error)f.action="postfileerror",e.call(d,f);else if(f.action="created",f.url=b.alternateLink,f.id=b.id,f.mimeType=b.mimeType,f.title=b.title,f.lastModifyingUserName=b.lastModifyingUserName,f.iconLink=b.iconLink,f.embedLink=b.embedLink,f.description=b.description,a!==GPickerPlugin.FILE.Folder){var c=gapi.client.drive.permissions.insert({fileId:b.id,resource:{type:"anyone",role:"writer",withLink:!0}});c.execute(function(a){a.error?(f={action:"permissionserror"},e.call(d,f)):e.call(d,f)})}else e.call(d,f)})},_getFileRequest:function(a){var b={action:""},c=gapi.client.drive.files.get({fileId:a}),d=this;c.execute(function(a){a.error?404===a.error.code?b.action="notfound":b.action="getfileerror":(b.action="fileinfo",b.url=a.alternateLink,b.embedLink=a.embedLink,b.createdDate=a.createdDate,b.fileExtension=a.fileExtension,b.downloadUrl=a.downloadUrl,b.fileSize=a.fileSize,b.iconLink=a.iconLink,b.id=a.id,b.lastModifyingUserName=a.lastModifyingUserName,b.mimeType=a.mimeType,b.lastViewedByMeDate=a.lastViewedByMeDate,b.modifiedDate=a.modifiedDate,b.originalFilename=a.originalFilename,b.shared=a.shared,b.thumbnailLink=a.thumbnailLink,b.title=a.title,b.webContentLink=a.webContentLink,b.writersCanShare=a.writersCanShare),d.executeCallback("getFile",b)})},_getOrCreateFolderByName:function(a,b){this._getFolderByName(a,function(c){void 0===c?(this.log.debug("Error while getting folderId. Will not try to create folder!"),b.call(null,"")):""===c?this._newFileRequest(GPickerPlugin.FILE.Folder,a,null,null,function(c){"created"===c.action?(this.log.debug("Created folder named",a),b.call(null,c.id)):(this.log.error("Error while creating a folder named "+a+":",c.action),b.call(null,""))}.bind(this)):b.call(null,c)}.bind(this))},_getFolderByName:function(a,b){var c=gapi.client.drive.files.list({maxResults:1,q:"title = '"+a+"' and mimeType = '"+GPickerPlugin.FILE.Folder+"'"}),d=this;c.execute(function(c){void 0===c.error?0==c.items.length?(d.log.warn("Folder named "+a+" not found."),b.call(null,"")):(d.log.debug("Found folder",c.items[0].id),b.call(null,c.items[0].id)):(d.log.error("Error while trying to get folder: ",c.message),b.call(null,void 0))})},_showPicker:function(a,b,c){if(b="boolean"==typeof b?b:!0,c=c||{},this.pickerApiLoaded){if(this.recreatePicker){var d=this.getToken(),e=(new google.picker.PickerBuilder).setDeveloperKey(this.developerKey).setCallback(this._onItemPicked.bind(this));b&&e.setOAuthToken(d.access_token);var f=function(b){return b?("string"==typeof c.initialFolder&&""!==c.initialFolder&&"function"==typeof b.setParent&&b.setParent(c.initialFolder),"boolean"==typeof c.ownedByMe&&"function"==typeof b.setOwnedByMe&&b.setOwnedByMe(!0),this.containsFlag(a,GPickerPlugin.Folders)||"function"!=typeof b.setSelectFolderEnabled||b.setSelectFolderEnabled(!1),b):b}.bind(this);if(this.containsFlag(a,GPickerPlugin.AllFiles)){var g=f(new google.picker.DocsView(google.picker.ViewId.DOCS));g.setIncludeFolders(!0),e.addView(g)}if(this.containsFlag(a,GPickerPlugin.Images)&&e.addView(google.picker.ViewId.DOCS_IMAGES),this.containsFlag(a,GPickerPlugin.ImageSearch)&&e.addView(google.picker.ViewId.IMAGE_SEARCH),this.containsFlag(a,GPickerPlugin.Documents)&&e.addView(google.picker.ViewId.DOCUMENTS),this.containsFlag(a,GPickerPlugin.Drawings)&&e.addView(google.picker.ViewId.DRAWINGS),this.containsFlag(a,GPickerPlugin.Presentations)&&e.addView(google.picker.ViewId.PRESENTATIONS),this.containsFlag(a,GPickerPlugin.Spreadsheets)&&e.addView(google.picker.ViewId.SPREADSHEETS),this.containsFlag(a,GPickerPlugin.Forms)&&e.addView(google.picker.ViewId.FORMS),this.containsFlag(a,GPickerPlugin.ImagesAndVideos)&&e.addView(google.picker.ViewId.DOCS_IMAGES_AND_VIDEOS),this.containsFlag(a,GPickerPlugin.Videos)&&e.addView(google.picker.ViewId.DOCS_VIDEOS),this.containsFlag(a,GPickerPlugin.VideoSearch)&&e.addView(google.picker.ViewId.VIDEO_SEARCH),this.containsFlag(a,GPickerPlugin.YouTube)&&e.addView(google.picker.ViewId.YOUTUBE),this.containsFlag(a,GPickerPlugin.Folders)&&e.addView(google.picker.ViewId.FOLDERS),this.containsFlag(a,GPickerPlugin.PDFs)&&e.addView(google.picker.ViewId.PDFS),this.containsFlag(a,GPickerPlugin.RecentItems)&&e.addView(google.picker.ViewId.RECENTLY_PICKED),this.containsFlag(a,GPickerPlugin.Upload)){var h=f(new google.picker.DocsUploadView);e.addView(h)}this.picker=e.build(),this.recreatePicker=!1}this.picker.setVisible(!0)}},_validateToken:function(a,b){var c=this.getToken(),d=null!==c&&"object"==typeof c&&"string"==typeof c.access_token&&""!==c.access_token?c.access_token:void 0;if(void 0===d){var e=Tundra.config.readSection("google");d="object"==typeof e&&"object"==typeof e.auth&&"string"==typeof e.auth.access_token&&""!==e.auth.access_token?e.auth.access_token:void 0}void 0!==d?$.getJSON(this.tokenInfoUrl+d,function(c){if(void 0!==c.error)return void this._requestAuthorization(a,b);var d=c.audience;if(void 0!==d&&d===this.clientId){for(var e=c.scope.split(" "),f=!1,g=!1,h=0;h<e.length;h++)e[h]===this.scopeDriveRW[0]&&(g=!0),e[h]===this.scopeDriveRO[0]&&(f=!0);return(g||f)&&(a||g)?void b.call(this,"tokenValid"):void this._requestAuthorization(a,b)}this._requestAuthorization(a,b)}.bind(this)).fail(function(){this._requestAuthorization(a,b)}.bind(this)):this._requestAuthorization(a,b)},_requestAuthorization:function(a,b){gapi.auth.authorize({client_id:this.clientId,scope:this.scopeDriveBroad,immediate:!1,include_granted_scopes:!0},function(a){if("object"==typeof a&&!a.error&&"string"==typeof a.access_token&&""!==a.access_token){var c=Tundra.config.readSection("google");c.auth=$.extend({},c.auth,{access_token:a.access_token}),Tundra.config.writeSection("google",c),this._timing.resolve("onAuthorized")}b.apply(this,arguments)}.bind(this))},_onItemPicked:function(a){var b=a[google.picker.Response.ACTION],c={action:b};if(b==google.picker.Action.PICKED){var d=a[google.picker.Response.DOCUMENTS][0];if(c.url=d[google.picker.Document.URL],c.description=d[google.picker.Document.DESCRIPTION],c.embedLink=d[google.picker.Document.EMBEDDABLE_URL],c.duration=d[google.picker.Document.DURATION],c.iconLink=d[google.picker.Document.ICON_URL],c.id=d[google.picker.Document.ID],c.lastEditedUTC=d[google.picker.Document.LAST_EDITED_UTC],c.mimeType=d[google.picker.Document.MIME_TYPE],c.name=d[google.picker.Document.NAME],c.type=d[google.picker.Document.TYPE],d[google.picker.Document.IS_NEW]){var e=gapi.client.drive.permissions.insert({fileId:c.id,resource:{type:"anyone",role:"writer",withLink:!0}});return void e.execute(function(a){a.error?this.executeCallback("picker",{action:"permissionserror"}):this.executeCallback("picker",c)}.bind(this))}}this.executeCallback("picker",c)},containsFlag:function(a,b){return(a&b)===b},getUserProfile:function(){if(this.plusApiLoaded!==!0)return this._timing.deferImmediate("getUserProfile",!1,"getUserProfile: Google+ plugin not yet loaded");if(!this.isAuthorized())return this._timing.deferImmediate("getUserProfile",!1,"getUserProfile: User not authorized. User authorize() and listen to the completion of authorization with onAuthorized()");var a=gapi.client.plus.people.get({userId:"me"});return a.execute(function(a){this._timing.resolve("getUserProfile",a&&!a.error,a)}.bind(this)),this._timing.defer("getUserProfile")},authorize:function(a){return a="boolean"==typeof a?a:!0,this.isAuthorized()?this._timing.deferImmediate("authorize",!0,$.extend({},this._authorizeResult)):$.Deferred(function(a){var b=function(b){if(this._authorizeResult={authorized:b&&!b.error,error:b.error,response:b},this._authorizeResult.authorized&&"string"==typeof b.access_token){var c=Tundra.config.readSection("google");c.auth=$.extend({},c.auth,{access_token:b.access_token}),Tundra.config.writeSection("google",c)}b.error?this.log.error("Authorization error",b):this.log.info("User authorized");try{this._authorizeResult.authorized?a.resolve($.extend({},this._authorizeResult)):a.reject($.extend({},this._authorizeResult))}catch(d){console.error(d.stack||d)}this._timing.resolve("onAuthorized")}.bind(this),c={client_id:this.clientId,scope:this.scopeDriveBroad,immediate:"boolean"==typeof this._canAutoAuthorize&&this._canAutoAuthorize===!0?!0:!1};gapi.auth.authorize(c,function(a){a&&!a.error?b(a):(c.immediate===!1&&this.log.warn("TODO: Auth with immediate false failed, trying again should be removed."),gapi.auth.authorize($.extend(c,{immediate:!1}),b))}.bind(this))}.bind(this)).promise()},isAuthorized:function(){return"object"==typeof this._authorizeResult&&this._authorizeResult.authorized===!0},onAuthorized:function(){return this.isAuthorized()?this._timing.deferImmediate("onAuthorized"):this._timing.defer("onAuthorized")},canAutoAuthorize:function(){var a=this.getToken(),b=null!==a&&"object"==typeof a&&"string"==typeof a.access_token&&""!==a.access_token?a.access_token:void 0;if(void 0===b){var c=Tundra.config.readSection("google");b="object"==typeof c&&"object"==typeof c.auth&&"string"==typeof c.auth.access_token&&""!==c.auth.access_token?c.auth.access_token:void 0}return void 0!==b?this._timing.hasDefer("canAutoAuthorize")?this._timing.defer("canAutoAuthorize"):this._timing.defer("canAutoAuthorize",function(){$.getJSON(this.tokenInfoUrl+b).done(function(a){this._timing.resolve("canAutoAuthorize",!0,void 0===a.error)}.bind(this)).fail(function(){this._timing.resolve("canAutoAuthorize",!0,!1)}.bind(this))}.bind(this)):this._timing.deferImmediate("canAutoAuthorize",!1,!1)},openUploadDialog:function(a,b,c,d){if(!this.polymer)return this.log.error("openUploadDialog: Only available with Polymer enabled Tundra."),null;if(this.polymer.dialog||this.polymer.uploader)return this.log.warn("openUploadDialog: dialog already open, try again once its closed."),null;("string"!=typeof a||""===a)&&(a=this.workingFolderName);var e=function(){this.polymer.dialog=document.createElement("webrocket-dialog"),this.polymer.dialog.heading="Upload",this.polymer.dialog.iconSrc="http://meshmoon.s3.amazonaws.com/releases/meshmoon-applications/nightly/meshmoon/meeting-tool/files/google-drive-icon-64x64.png",this.polymer.dialog.buttonLabelAccept="",this.polymer.dialog.buttonLabelDecline="cancel",this.polymer.uploader=document.createElement("webrocket-google-drive-uploader"),this.polymer.uploader.GoogleDrivePlugin=this,this.polymer.uploader.publiclyWritable="boolean"==typeof b?b:!1,this.polymer.uploader.publiclyReadable="boolean"==typeof c?c:!1,this.polymer.uploader.withLink="boolean"==typeof d?d:!0,this.polymer.dialog.appendChild(this.polymer.uploader),$("body").append(this.polymer.dialog),"string"==typeof a&&""!==a&&this._getOrCreateFolderByName(a,function(a){this.polymer.uploader&&"string"==typeof a&&""!==a&&(this.polymer.uploader.parentFolderId=a)}.bind(this)),this.polymer.dialog.addEventListener("closed",function(){this.polymer.dialog&&$(this.polymer.dialog).remove(),this.polymer.dialog=void 0,this.polymer.uploader=void 0,this._timing.hasDefer("upload.file")&&this._timing.resolve("upload.file",!1)}.bind(this)),this.polymer.uploader.addEventListener("upload-start",function(){this.log.debug("openUploadDialog: upload-start"),this.polymer.dialog.loading=!0}.bind(this)),this.polymer.uploader.addEventListener("upload-completed",function(a){this.log.debug("openUploadDialog: upload-completed",a.detail),this.polymer.dialog&&this.polymer.dialog.close(),this._timing.resolve("upload.file",!0,a.detail)}.bind(this)),this.polymer.uploader.addEventListener("upload-error",function(a){this.log.error("openUploadDialog: upload-error:",a),this.polymer.dialog&&this.polymer.dialog.close(),Tundra.ui.openModalDialog({text:null!=a?a.toString():"Upload failed"})}.bind(this)),this.polymer.uploader.addEventListener("upload-cancel",function(){this.log.debug("openUploadDialog: upload-cancel"),this.polymer.dialog.loading=!1,this.polymer.dialog&&this.polymer.dialog.close()}.bind(this)),this._timing.async("upload.dialog.open",function(){this.polymer.dialog.open()})}.bind(this);return Polymer.getRegisteredPrototype("webrocket-google-drive-uploader")?e():Tundra.asset.loadDependencies(void 0,"webrocket://elements/webrocket-google-drive-uploader.html").done(e),this._timing.defer("upload.file")},updatePublicPermissions:function(a,b,c,d){if(b="boolean"==typeof b?b:!1,c="boolean"==typeof c?c:!0,d="boolean"==typeof d?d:!0,!this.isAuthorized())return this._timing.deferImmediate("updatePublicPermissions",!1,"updatePublicPermissions: User not authorized. User authorize() and listen to the completion of authorization with onAuthorized()");if("string"!=typeof a||""===a)return this._timing.deferImmediate("updatePublicPermissions",!1,"updatePublicPermissions: 'fileId' is not a string or is empty");if(this._timing.hasDefer(a))return this._timing.deferImmediate("updatePublicPermissions",!1,"updatePublicPermissions: File "+a+" is alredy being operated on");var e=gapi.client.drive.permissions.list({fileId:a});return e.execute(function(e){if(!e||e.error)return this.log.error("updatePublicPermissions:"),this._timing.resolve(a,!1);for(var f=void 0,g=0;g<e.items.length;g++)if("anyone"===e.items[g].type&&(d===!0&&e.items[g].withLink===!0||d===!1&&(e.items[g].withLink===!1||void 0===e.items[g].withLink))){f=e.items[g];break}var h=function(b){b&&b.error&&this.log.error("updatePublicPermissions:",b),this._timing.resolve(a,b&&!b.error,a,b)}.bind(this);if(void 0!==f){var i=gapi.client.drive.permissions.get({fileId:a,permissionId:f.id});i.execute(function(e){var f=void 0;b||c?(e.role=b?"writer":"reader",e.withLink=d,f=gapi.client.drive.permissions.update({fileId:a,permissionId:e.id,resource:e})):f=gapi.client.drive.permissions["delete"]({fileId:a,permissionId:e.id}),f.execute(h)}.bind(this))}else if(b||c){var j=gapi.client.drive.permissions.insert({fileId:a,resource:{type:"anyone",role:b?"writer":"reader",withLink:d}});j.execute(h)}else this._timing.resolve(a,!0,a,{})}.bind(this)),this._timing.defer(a)}});Tundra.registerPlugin(new GPickerPlugin);var CommunicationPlugin=ITundraPlugin.$extend({__classvars__:{RESOLUTION:{res720p:"1280x720",res480p:"640x480",res240p:"320x240"},ROLE:{Subscriber:"subscriber",Publisher:"publisher",Moderator:"moderator"},STATE:{Disconnected:0,Connecting:1,Connected:2,ConnectedPrivate:3,IncomingCall:4,Calling:5},RESPONSE:{NoReply:0,Busy:1,Accept:2},EVENT:{IncomingCall:0,Cancelled:1,TimedOut:2,Calling:3,CallingCancelled:4,ResponseReceived:5}},__init__:function(){this.$super("Communications"),this.localDevMode=-1!=document.URL.indexOf("http://localhost"),this.apiKey="44864622",this.state=CommunicationPlugin.STATE.Disconnected,this.session=null,this.publisher=null,this.connections={},this.streams={},this.peer2peer=!1,this.timeConnected=null,this.videoSource=0,this.sendAudio=!1,this.sendVideo=!1,this.audioSources=[],this.videoSources=[],this.reconnectData=null,this.ui={},this.profilePictures={},this.containerName="opentok_streamelement",this.maxWidth=225,this.maxHeight=Math.floor(.75*this.maxWidth),this.preferredWidth=this.maxWidth,this.preferredHeight=this.maxHeight,this.leftOrBottomEdge=!0,this.isOpenTokLayoutFetched=!1,this.useOpenTokLayout=!0,this.incomingCallData=null,this.incomingCallTimeout=2e4,this.incomingCallTimeoutId=null,this.outgoingCallConnectionId=null},postInitialize:function(){Tundra.asset.loadScript("https://static.opentok.com/webrtc/v2.2/js/opentok.min.js").done(function(){this.onDependencyFetched()}.bind(this))},onDependencyFetched:function(){this.localDevMode?OT.setLogLevel(OT.LOG):OT.setLogLevel(OT.NONE),OT.getDevices(function(a,b){if(null==a)for(var c=0;c<b.length;c++)"videoInput"===b[c].kind?this.videoSources.push(b[c].deviceId):"audioInput"===b[c].kind&&this.audioSources.push(b[c].deviceId);else this.log.error("Error while getting devices:",a.message)}.bind(this)),OT.on("exception",this._onOTException.bind(this)),Tundra.client.onDisconnected(this,this.onDisconnected),this.initUi(),this.useOpenTokLayout&&Tundra.asset.loadScript("http://meshmoon.data.s3.amazonaws.com/app/comms/lib/opentok-layout.min.js").done(function(){this.isOpenTokLayoutFetched=!0}.bind(this))},initLayout:function(){if(this.isOpenTokLayoutFetched){this.ui.layout=TB.initLayoutContainer(document.getElementById(this.containerName),{maxRatio:.75,minRatio:.75,fixedRatio:!1,animate:!0,bigClass:"OT_big",bigPercentage:1,bigFixedRatio:!1,bigMaxRatio:.75,bigMinRatio:9/16,bigFirst:!1}).layout;var a=this;$(document).on("click","#"+this.containerName+">*",function(){$(this).hasClass("OT_big")?$(this).removeClass("OT_big"):(a.getBigStream()&&a.getBigStream().removeClass("OT_big"),$(this).addClass("OT_big")),a.onWindowResize()})}},initUi:function(){this.ui.container=$("<div/>",{id:this.containerName}),this.ui.container.css({position:"relative","background-color":"rgba(247, 247, 247, 0.8)",border:"1px solid grey","border-top-right-radius":3,"border-bottom-right-radius":3,width:this.streamWidth()+5,"min-height":1,"padding-top":5,"padding-bottom":5,overflow:"hidden"}),this.ui.container.height(0),this.ui.container.hide()},nextVideoSource:function(){this.videoSource+1>=this.videoSources.length?this.videoSource=0:this.videoSource++;var a=this.isAudioEnabled(),b=this.isVideoEnabled();this.publisher.off(),this.publisher.destroy(),this.publisher=null;var c=Tundra.client.loginProperties.username;this.log.debug("Video source:",this.videoSource),this._createPublisher(c,CommunicationPlugin.RESOLUTION.res720p,a,b,this.videoSources[this.videoSource])},getBigStream:function(){if(!this.isOpenTokLayoutFetched)return!1;for(var a=this.ui.container.children(),b=0;b<a.length;b++){var c=$(a[b]);if(c.hasClass("OT_big"))return c}return!1},updateLayout:function(){null!=this.ui.layout&&"function"==typeof this.ui.layout&&this.ui.layout()},onWindowResize:function(){if(null!=this.ui.container&&this.ui.container.is(":visible")){var a,b,c;this.leftOrBottomEdge?(a="left top",b="left top+42",c=Tundra.client.container):(a="center bottom",b="center top",c=null!==Tundra.ui.taskbar?Tundra.ui.taskbar:Tundra.client.container);var d=Tundra.client.container.width(),e=Tundra.client.container.height();if(null!=Tundra.ui.taskbar&&(e-=Tundra.ui.taskbar.height()),this.getBigStream())this.ui.container.height(e-55),this.ui.container.width(d-256);else{var f=this.ui.container.children().length;if(this.leftOrBottomEdge){var g=(e-205)/f;this.setPreferredHeight(g,!0),this.ui.container.width(this.streamWidth()+5),this.ui.container.height(this.streamHeight()*f)}else{var h=d/f;this.setPreferredWidth(h,!0),this.ui.container.width(this.streamWidth()*(0>=f?1:f)),this.ui.container.height(this.streamHeight())}}this.ui.container.position({my:a,at:b,of:c}),this.updateLayout()}},connect:function(a){if(0===OT.checkSystemRequirements())return void this.log.warn("The browser does not support WebRTC.");var b,c,d,e,f,g,h,i;return null!==a&&void 0!==a&&"object"==typeof a&&(b=a.sessionId,c=a.token,d=a.p2p,e=a.role,f=a.resolution,g=a.sendAudio,h=a.sendVideo,i=a.delay),void 0===d&&(d=!1),this.peer2peer=d,this.session||(void 0===b&&(b=this._getSession(d)),this._initSession(b),this.session)?this.isConnected()?!0:(void 0===e&&(e=CommunicationPlugin.ROLE.Publisher),e!==CommunicationPlugin.ROLE.Subscriber&&(void 0===f&&(f=CommunicationPlugin.RESOLUTION.res720p),void 0===g&&(g=!0),void 0===h&&(h=!1)),void 0===c&&(c=this._requestToken(d)),void 0===c||null===c||""===c?(this.log.warn("connect: VOIP token is not valid '"+c+"'. Cannot connect."),!1):(this.state=CommunicationPlugin.STATE.Connecting,void 0===i&&(i=!1),i?setTimeout(function(){this._connect(c,e,f,g,h,d)}.bind(this),1e3):this._connect(c,e,f,g,h,d),!0)):(this.log.warn("connect: VOIP session token is not valid. Cannot connect."),!1)},_connect:function(a,b,c,d,e,f){this.session.connect(a,function(a){if(a)this.state=CommunicationPlugin.STATE.Disconnected,Tundra.events.send("CommunicationPlugin.onVoipDisconnected",!0,a.message),this.log.debug("connect | Error on connect: ",a),1004==a.code?this.log.error("connect: Token error: ",a.message):1005===a.code?this.log.error("connect: Invalid session ID: ",a.message):1006===a.code?this.log.error("connect: Connection failed, make sure you are still connected to the internet.",a.message):this.log.error("connect: ",a.message);else{var g=Tundra.client.loginProperties.username;this.sendAudio=d,this.sendVideo=e,b!==CommunicationPlugin.ROLE.Subscriber&&this._createPublisher(g,c,d,e),Tundra.events.send("CommunicationPlugin.onVoipConnected",f,d,e),f?this.state=CommunicationPlugin.STATE.ConnectedPrivate:this.state=CommunicationPlugin.STATE.Connected,this.timeConnected=new Date}}.bind(this))},disconnect:function(){this.isConnected()&&this.session.disconnect()},isConnected:function(){return null!==this.session&&void 0!==this.session?void 0!==this.session.connection&&null!==this.session.connection:!1},toggleConnection:function(a,b){b?this.connect(a):this.disconnect()},isAudioEnabled:function(){return null===this.publisher?!1:null===this.publisher.stream||void 0===this.publisher.stream?this.sendAudio:this.publisher.stream.hasAudio},audioOn:function(){this.toggleAudio(!0)},audioOff:function(){this.toggleAudio(!1)},toggleAudio:function(a){this.publisher&&this.publisher.publishAudio(a)},isVideoEnabled:function(){return null===this.publisher?!1:null===this.publisher.stream||void 0===this.publisher.stream?this.sendVideo:this.publisher.stream.hasVideo},videoOn:function(){this.toggleVideo(!0)},videoOff:function(){this.toggleVideo(!1)},toggleVideo:function(a){this.publisher&&this.publisher.publishVideo(a)},toggleAudioForUser:function(a,b){if(this.session&&(this.state===CommunicationPlugin.STATE.Connected||this.state===CommunicationPlugin.STATE.ConnectedPrivate)){var c=this.connections[a];if(void 0!==c){var d=this.streams[c];if(void 0===d)return void this.log.error("toggleAudioForUser: User is not publishing anything, cannot mute");var e=this.session.getSubscribersForStream(d)[0];void 0!==e&&e.subscribeToAudio(b)}}},getPublisher:function(){return this.publisher},getSubscriber:function(a){var b=this.connections[a],c=void 0!==b?this.streams[b]:void 0;return void 0!==c?this.session.getSubscribersForStream(c)[0]:void 0},duration:function(){if(null===this.timeConnected||void 0===this.timeConnected)return 0;var a=new Date,b=a.getTime()-this.timeConnected.getTime();return Math.floor(.001*b)},durationFormatted:function(){var a=this.duration(),b=Math.floor(a/60),c=Math.floor(b/60);a-=60*b,b-=60*c;var d="";return c>0&&(d+=10>c?"0"+c:c,d+=":"),d+=10>b?"0"+b:b,d+=":",d+=10>a?"0"+a:a},streamWidth:function(){return this.preferredWidth},streamHeight:function(){return this.preferredHeight},setPreferredWidth:function(a,b){a>this.maxWidth&&(a=this.maxWidth);var c=Math.floor(a);c!==this.preferredWidth&&(this.preferredWidth=c,this.preferredHeight=Math.floor(.75*c),b===!0&&this.resizeElements())},setPreferredHeight:function(a,b){a>this.maxHeight&&(a=this.maxHeight);var c=Math.floor(a);c!==this.preferredHeight&&(this.preferredHeight=c,this.preferredWidth=Math.floor(1.33*c),b===!0&&this.resizeElements())},resizeElements:function(){for(var a=$("#"+this.containerName).children(),b=this.streamWidth(),c=this.streamHeight(),d=0;d<a.length;++d)a[d].style.width=b+"px",a[d].style.height=c+"px"},callUser:function(a,b){if(this.session){if(this.state===CommunicationPlugin.STATE.Calling||this.state===CommunicationPlugin.STATE.IncomingCall)return void this.log.error("callUser: Cannot call while calling another user, or an incoming call is in progress");var c=this._getStreamForConnection(a);return void 0===c?void this.log.error("callUser: No connection is available from the selected stream."):void this.session.signal({data:JSON.stringify({username:Tundra.client.loginProperties.username,connectionId:this.session.connection.connectionId,sessionId:this._getSession(!0),token:this._requestToken(!0)}),type:"call",to:c},function(d){d?this.log.error("callUser: Error calling client with connection ID ",a," :",d.message):(this.log.debug("callUser: Signal 'call' sent to ",c.connectionId),this.outgoingCallConnectionId=c.connectionId,this.state=CommunicationPlugin.STATE.Calling,Tundra.events.send("CommunicationPlugin.onPrivateCallEvent",CommunicationPlugin.EVENT.Calling,a,b))}.bind(this))}},cancelCall:function(){if(this.state===CommunicationPlugin.STATE.Calling){if(null===this.outgoingCallConnectionId)return void this.log.debug("cancelCall: Outgoing call connection ID is null!");var a=this._getStreamForConnection(this.outgoingCallConnectionId,!0);void 0!==a&&(this.session.signal({type:"cancelCall",to:a}),Tundra.events.send("CommunicationPlugin.onPrivateCallEvent",CommunicationPlugin.EVENT.CallingCancelled),this.state=CommunicationPlugin.STATE.Connected,this.outgoingCallConnectionId=null)}},sendResponse:function(a,b){if(a!==CommunicationPlugin.RESPONSE.NoReply&&a!==CommunicationPlugin.RESPONSE.Busy&&a!==CommunicationPlugin.RESPONSE.Accept)return void this.log.error("sendResponse: Invalid response type: ",a);if(void 0===b&&(b=this.incomingCallData),null===b)return void this.log.error("sendResponse: Incoming data is empty!");var c=this._getStreamForConnection(b.connectionId,!0);return void 0===c?void this.log.error("sendResponse: A connection object attached to that stream does not exist!"):(this.session.signal({data:JSON.stringify({response:a,username:Tundra.client.loginProperties.username,connectionId:this._connId()}),type:"callResponse",to:c}),this.log.debug("sendResponse: Response sent: ",a),clearTimeout(this.incomingCallTimeoutId),this.state=CommunicationPlugin.STATE.Connected,a===CommunicationPlugin.RESPONSE.Accept&&(this.log.info("sendResponse: Disconnecting from the public session"),this.reconnectData={p2p:!0,sessionId:b.sessionId,token:b.token,sendAudio:this.isAudioEnabled(),sendVideo:this.isVideoEnabled(),delay:!0},this.disconnect()),this.incomingCallData=null,void(this.incomingCallTimeoutId=null))},hangUp:function(a){this.state===CommunicationPlugin.STATE.ConnectedPrivate&&(void 0===a&&(a=!1),this.reconnectData={sendAudio:this.isAudioEnabled(),sendVideo:this.isVideoEnabled(),delay:a},this.disconnect())},onVoipConnected:function(a,b){return Tundra.events.subscribe("CommunicationPlugin.onVoipConnected",a,b)},onUserBroadcast:function(a,b){return Tundra.events.subscribe("CommunicationPlugin.onUserBroadcast",a,b)},onUserDisconnected:function(a,b){return Tundra.events.subscribe("CommunicationPlugin.onUserDisconnected",a,b)},onVoipDisconnected:function(a,b){return Tundra.events.subscribe("CommunicationPlugin.onVoipDisconnected",a,b)},onStreamCreated:function(a,b){return Tundra.events.subscribe("CommunicationPlugin.onStreamCreated",a,b)},onStreamSubscription:function(a,b){return Tundra.events.subscribe("CommunicationPlugin.onStreamSubscription",a,b)},onStreamPropertyChanged:function(a,b){return Tundra.events.subscribe("CommunicationPlugin.onStreamPropertyChanged",a,b)},onPrivateCallEvent:function(a,b){return Tundra.events.subscribe("CommunicationPlugin.onPrivateCallEvent",a,b)},_initSession:function(a){return void 0===a||null===a||""===a?void this.log.debug("_initSession: Session id is not valid '"+a+"'"):(this.session=OT.initSession(this.apiKey,a),void this.session.on({streamCreated:this._onSessionStreamCreated.bind(this),streamDestroyed:this._onSessionStreamDestroyed.bind(this),streamPropertyChanged:this._onSessionStreamPropertyChanged.bind(this),
connectionCreated:this._onSessionConnectionCreated.bind(this),connectionDestroyed:this._onSessionConnectionDestroyed.bind(this),sessionDisconnected:this._onSessionDisconnected.bind(this),exception:this._onSessionException.bind(this),"signal:userBroadcast":this._onSignalUserBroadcast.bind(this),"signal:call":this._onSignalCall.bind(this),"signal:cancelCall":this._onSignalCancelCall.bind(this),"signal:callResponse":this._onSignalCallResponse.bind(this)}))},_createPublisher:function(a,b,c,d,e){if(null===this.publisher){var f=document.createElement("div");$(f).css("display","inline-block").data("connId",this._connId()),this.publisher=OT.initPublisher(f,{name:a,width:this.preferredWidth,height:this.preferredHeight,resolution:b,publishAudio:c,publishVideo:d,videoSource:e,style:{backgroundImageURI:Tundra.client.loginProperties.profilepicture}},this._onPublisherInitComplete.bind(this)),this.publisher.setStyle("nameDisplayMode","on"),this.publisher.setStyle("buttonDisplayMode","off"),this.ui.container.append(f),this.updateLayout(),this.publisher.on({accessAllowed:this._onPublisherAccessAllowed.bind(this),accessDenied:this._onPublisherAccessDenied.bind(this),accessDialogOpened:this._onPublisherAccessDialogOpened.bind(this),accessDialogClosed:this._onPublisherAccessDialogClosed.bind(this),streamCreated:this._onPublisherStreamCreated.bind(this),streamDestroyed:this._onPublisherStreamDestroyed.bind(this),devicesDetected:this._onPublisherDevicesDetected.bind(this)}),this.publisher.detectDevices()}this.session.publish(this.publisher)},_requestToken:function(a){if((void 0===a||null===a)&&(a=!1),this.localDevMode)return a?"T1==cGFydG5lcl9pZD00NDg2NDYyMiZzaWc9MDM2NjE4YjFhZmQyNzYwMGRiZjhlOGI2YWE5NmU0ZjI5OWY2NzA0Nzpyb2xlPXB1Ymxpc2hlciZzZXNzaW9uX2lkPTJfTVg0ME5EZzJORFl5TW41LVJuSnBJRXAxYmlBeU1DQXdPVG94TmpveE9TQlFSRlFnTWpBeE5INHdMamcwTURrek1EWTBmbjQmY3JlYXRlX3RpbWU9MTQzMDkyMjcyNCZub25jZT0wLjY2MDQ3MDQ3MzI2NDI4NjUmZXhwaXJlX3RpbWU9MTQzMzUxNDY4NiZjb25uZWN0aW9uX2RhdGE9":"T1==cGFydG5lcl9pZD00NDg2NDYyMiZzaWc9ZGIxZTliZWFjZjJhNTY2YjlhZDVkMTkzNWNmNTViMmFkMzljZGI2MDpyb2xlPXB1Ymxpc2hlciZzZXNzaW9uX2lkPTJfTVg0ME5EZzJORFl5TW41LVJuSnBJRXAxYmlBeU1DQXdPVG94TlRvek15QlFSRlFnTWpBeE5INHdMall3TnpZNE5qQTBmbjQmY3JlYXRlX3RpbWU9MTQzMDkyMjcwMyZub25jZT0wLjgwNTg2Nzc4MjM4MzE4OTkmZXhwaXJlX3RpbWU9MTQzMzUxNDY4NiZjb25uZWN0aW9uX2RhdGE9";var b=Tundra.client.getAuthToken("tokbox");return void 0!==b&&"string"==typeof b.publictoken?a?b.p2ptoken:b.publictoken:void 0},_getSession:function(a){if((void 0===a||null===a)&&(a=!1),this.localDevMode)return a?"2_MX40NDg2NDYyMn5-RnJpIEp1biAyMCAwOToxNjoxOSBQRFQgMjAxNH4wLjg0MDkzMDY0fn4":"2_MX40NDg2NDYyMn5-RnJpIEp1biAyMCAwOToxNTozMyBQRFQgMjAxNH4wLjYwNzY4NjA0fn4";var b=Tundra.client.getAuthToken("tokbox");return void 0!==b&&"string"==typeof b.publicid?a?b.p2pid:b.publicid:void 0},_getStreamForConnection:function(a,b){void 0===b&&(b=!1);var c;if(c=b?a:this.connections[a],void 0===c)return void this.log.error("getStreamForConnection: No such connection ID: ",a);var d=this.streams[c];return void 0===d?void this.log.error("getStreamForConnection: No such stream. Is the other party allowed to publish?"):d.connection},_connId:function(){return Tundra.client.connectionId},_onSessionConnectionCreated:function(a){this.log.debug("_onSessionConnectionCreated",a),a.connection.connectionId!==this.session.connection.connectionId&&this.session.signal({data:JSON.stringify({tundraConnectionId:this._connId(),connectionId:this.session.connection.connectionId,hasVideo:this.isVideoEnabled(),hasAudio:this.isAudioEnabled(),profilePicture:Tundra.client.loginProperties.profilepicture}),type:"userBroadcast",to:a.connection})},_onSessionConnectionDestroyed:function(a){this.log.debug("_onSessionConnectionDestroyed",a);var b=a.connection.connectionId,c=this.connections[b];this.state===CommunicationPlugin.STATE.Calling?b===this.outgoingCallConnectionId&&Tundra.events.send("CommunicationPlugin.onPrivateCallEvent",CommunicationPlugin.EVENT.CallingCancelled):this.state===CommunicationPlugin.STATE.IncomingCall&&b===this.incomingCallData.connectionId&&Tundra.events.send("CommunicationPlugin.onPrivateCallEvent",CommunicationPlugin.EVENT.Cancelled),Tundra.events.send("CommunicationPlugin.onUserDisconnected",c),delete this.connections[b],delete this.connections[c],this.peer2peer&&this.hangUp(!0)},_onSessionDisconnected:function(a){this.log.debug("_onSessionDisconnected",a),Tundra.events.send("CommunicationPlugin.onVoipDisconnected",!1),this.timeConnected=null,null===this.reconnectData&&(this.publisher.off(),this.publisher=null),this.session.off(),this.session=null,this.connections={},this.streams={},this.state=CommunicationPlugin.STATE.Disconnected,null!==this.reconnectData&&(this.connect(this.reconnectData),this.reconnectData=null)},_onSessionStreamCreated:function(a){this.log.debug("_onSessionStreamCreated",a);var b=a.stream.connection.connectionId,c=this.connections[b],d=document.createElement("div");$(d).css("display","inline-block").data({connId:c,streamId:b});this.session.subscribe(a.stream,d,{width:this.preferredWidth,height:this.preferredHeight,style:{nameDisplayMode:"on",buttonDisplayMode:"off",backgroundImageURI:this.profilePictures[b]}},function(b){b?this.log.error("onSessionStreamCreated: Session.subscribe error:",b.message):this.log.info("onSessionStreamCreated: Subscribed to stream with ID ",a.stream.id)}.bind(this));this.ui.container.append(d),this.streams[b]=a.stream,this._sendStreamCreated(c,b),Tundra.events.send("CommunicationPlugin.onStreamSubscription",c)},_onSessionStreamDestroyed:function(a){this.log.debug("_onSessionStreamDestroyed",a);var b=a.stream.connection.connectionId;delete this.streams[b],delete this.profilePictures[b],this.log.debug("Stream destroyed: "),this.log.debug(this.streams)},_onSessionStreamPropertyChanged:function(a){var b=this.connections[a.stream.connection.connectionId];void 0===b&&(b=this._connId()),this.log.debug("_onSessionStreamPropertyChanged",b,a.changedProperty,a.newValue),Tundra.events.send("CommunicationPlugin.onStreamPropertyChanged",{connectionId:b,property:a.changedProperty,value:a.newValue})},_onSessionException:function(a){this.log.debug("_onSessionException",a)},_onSignalUserBroadcast:function(a){this.log.debug("_onSignalUserBroadcast",a);var b=JSON.parse(a.data);this.connections[b.connectionId]=b.tundraConnectionId,this.connections[b.tundraConnectionId]=b.connectionId,this.profilePictures[b.connectionId]=b.profilePicture,Tundra.events.send("CommunicationPlugin.onUserBroadcast",b,this.peer2peer),this._sendStreamCreated(b.tundraConnectionId,b.connectionId)},_onSignalCall:function(a){if(this.log.debug("_onSignalCall",a),callerData=JSON.parse(a.data),this.state===CommunicationPlugin.STATE.Calling||this.state===CommunicationPlugin.STATE.IncomingCall)return void this.sendResponse(CommunicationPlugin.RESPONSE.Busy,callerData);this.incomingCallData=callerData,this.state=CommunicationPlugin.STATE.IncomingCall;var b=this.connections[callerData.connectionId];return void 0===b?void this.log.error("onSignalCall: No such connection:",b):(Tundra.events.send("CommunicationPlugin.onPrivateCallEvent",CommunicationPlugin.EVENT.IncomingCall,b,callerData.username),void(this.incomingCallTimeoutId=setTimeout(function(){this.sendResponse(CommunicationPlugin.RESPONSE.NoReply,callerData),Tundra.events.send("CommunicationPlugin.onPrivateCallEvent",CommunicationPlugin.EVENT.TimedOut,b,callerData.username)}.bind(this),this.incomingCallTimeout)))},_onSignalCancelCall:function(a){this.state===CommunicationPlugin.STATE.IncomingCall&&(this.state=CommunicationPlugin.STATE.Connected,Tundra.events.send("CommunicationPlugin.onPrivateCallEvent",CommunicationPlugin.EVENT.Cancelled),clearTimeout(this.incomingCallTimeoutId),this.incomingCallData=null,this.incomingCallTimeoutId=null)},_onSignalCallResponse:function(a){if(this.log.debug("_onSignalCallResponse",a),this.state===CommunicationPlugin.STATE.Calling){this.state=CommunicationPlugin.STATE.Connected;var b=JSON.parse(a.data);Tundra.events.send("CommunicationPlugin.onPrivateCallEvent",CommunicationPlugin.EVENT.ResponseReceived,b.connectionId,b.username,b.response),b.response===CommunicationPlugin.RESPONSE.Accept&&(this.reconnectData={p2p:!0,sendAudio:this.isAudioEnabled(),sendVideo:this.isVideoEnabled()},this.disconnect(),this.outgoingCallConnectionId=null)}},_onPublisherInitComplete:function(a){this.log.debug("_onPublisherInitComplete"+(a?"":" | No errors")),this.log.debug("_onPublisherInitComplete: Publisher:",this.publisher),a&&(1004===a.code?this.log.error("onPublisherInitComplete: Authentication error:",a):1010===a.code?this.log.error("onPublisherInitComplete: Not connected to session",a):1500===a.code?this.log.error("onPublisherInitComplete: Unable to publish. Make sure your browser is not blocking camera and microphone access, or using a wrong video device",a):1601===a.code&&this.log.error("onPublisherInitComplete: WebRTC internal error. Try reconnecting.",a),this.disconnect())},onPublisherAccessDialogOpened:function(a,b){return Tundra.events.subscribe("CommunicationPlugin.onPublisherAccessDialogOpened",a,b)},_onPublisherAccessDialogOpened:function(a){this.log.debug("_onPublisherAccessDialogOpened",a),Tundra.events.send("CommunicationPlugin.onPublisherAccessDialogOpened",a)},onPublisherAccessDialogClosed:function(a,b){return Tundra.events.subscribe("CommunicationPlugin.onPublisherAccessDialogClosed",a,b)},_onPublisherAccessDialogClosed:function(a){this.log.debug("_onPublisherAccessDialogClosed",a),Tundra.events.send("CommunicationPlugin.onPublisherAccessDialogClosed",a)},onPublisherAccessAllowed:function(a,b){return Tundra.events.subscribe("CommunicationPlugin.onPublisherAccessAllowed",a,b)},_onPublisherAccessAllowed:function(a){this.log.debug("_onPublisherAccessAllowed",a),Tundra.events.send("CommunicationPlugin.onPublisherAccessAllowed",a)},onPublisherAccessDenied:function(a,b){return Tundra.events.subscribe("CommunicationPlugin.onPublisherAccessDenied",a,b)},_onPublisherAccessDenied:function(a){this.log.debug("_onPublisherAccessDenied",a),Tundra.events.send("CommunicationPlugin.onPublisherAccessDenied",a),a.preventDefault()},_onPublisherStreamCreated:function(a){this.log.debug("_onPublisherStreamCreated",a),this.updateLayout(),this._sendStreamCreated(this._connId())},_onPublisherStreamDestroyed:function(a){this.log.debug("_onPublisherStreamDestroyed",a),this.updateLayout(),a.preventDefault()},_onPublisherDevicesDetected:function(a){this.log.debug("_onPublisherDevicesDetected",a);a.cameras,a.microphones;a.cameras.length<1?this.log.debug("No camera connected."):a.microphone.length<1&&this.log.debug("No microphone connected."),a.cameras.length>0&&a.microphones.length>0&&this.log.debug("Selected camera: "+a.selectedCamera.name+"\nSelected microphone: "+a.selectedMicrophone.name)},_onOTException:function(a){this.log.debug("_onOTException",a),this.log.error("OT:Exception",a.title,a.message)},_findUserElement:function(a,b){if("number"!=typeof a)return void this.log.error("_findUserElement: Invalid connection id",typeof a,a);var c=void 0;return this.ui.container.children().each(function(){(void 0===c&&$(this).data("connId")===a||$(this).data("streamId")===b)&&(c=$(this))}),c},_sendStreamCreated:function(a,b){if(void 0!==a){if("string"==typeof a&&(a=parseInt(a),isNaN(a)||"number"!=typeof a||0>a))return void this.log.error("_sendStreamCreated: Invalid connection id",a);var c=this._findUserElement(a,b);void 0!==c&&($(c).data("connId")!==a&&$(c).data("connId",a),c.data("streamCreatedSent")!==!0&&(c.data("streamCreatedSent",!0),this.log.debug("Sending onStreamCreated for connection id",a),Tundra.events.send("CommunicationPlugin.onStreamCreated",a,c)))}},onDisconnected:function(){this.disconnect()}});Tundra.registerPlugin(new CommunicationPlugin),window.WebRocketVersion={version:"1.5.7",commit:"32ba53b",full:"1.5.7-0-32ba53b"};var meshmoon=meshmoon||{};meshmoon.createWebRocketClient=function(a){a=$.extend({TundraClient:{},AssetAPI:{},plugins:{}},a),a.TundraClient.applications||void 0===a.container||(a.TundraClient.container=a.container,delete a.container),!a.AssetAPI.storages&&a.asset&&a.asset.localStoragePath&&(CoreStringUtils.endsWith(a.asset.localStoragePath,"/")||(a.asset.localStoragePath+="/"),a.AssetAPI.storages={"webrocket://":a.asset.localStoragePath,"meshmoon-applications://":a.asset.localStoragePath+"application"},delete a.asset),a.TundraClient.applications||("object"==typeof a.applications?(a.TundraClient.applications=a.applications,delete a.applications):a.TundraClient.applications={Freecamera:"meshmoon-applications://freecamera.webrocketjs"}),a.TundraClient.renderer||(a.renderSystem?(a.TundraClient.renderer=a.renderSystem,delete a.renderSystem):a.TundraClient.renderer=ThreeJsRenderer),a.plugins.LoginScreenPlugin||(void 0===a.LoginScreenPlugin&&(a.LoginScreenPlugin={}),a.plugins.LoginScreenPlugin={loginControlsEnabled:"boolean"==typeof a.LoginScreenPlugin.LoginControlsEnabled?a.LoginScreenPlugin.LoginControlsEnabled:!1,loadingScreenEnabled:"boolean"==typeof a.LoginScreenPlugin.LoadingScreenEnabled?a.LoginScreenPlugin.LoadingScreenEnabled:!0,connectingText:"string"==typeof a.LoginScreenPlugin.LoadingScreenConnectingText?a.LoginScreenPlugin.LoadingScreenConnectingText:"Loading 3D Space",headerText:"string"==typeof a.LoginScreenPlugin.LoadingScreenHeaderText?a.LoginScreenPlugin.LoadingScreenHeaderText:"",headerLinkUrl:"string"==typeof a.LoginScreenPlugin.LoadingScreenHeaderLinkUrl?a.LoginScreenPlugin.LoadingScreenHeaderLinkUrl:"http://meshmoon.com"},delete a.LoginScreenPlugin),"undefined"==typeof RocketPlugin&&console.error("RocketPlugin is not loaded correctly to the application. Functionality will be limited!");var b=new TundraClient(a);return EC_Script.registerNativeScriptReplacement({"avatar-manager":"meshmoon-applications://avatar-manager.webrocketjs",communication:"meshmoon-applications://communication.webrocketjs","rts-camera":"meshmoon-applications://rts-camera.webrocketjs","rss-reader":"meshmoon-applications://rss-feed-reader.webrocketjs"}),b};